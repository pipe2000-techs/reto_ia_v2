{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-16T14:21:57.566Z","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093"}
{"type":"file-history-snapshot","messageId":"56c78ee0-d640-4f03-a413-8769e7822ca8","snapshot":{"messageId":"56c78ee0-d640-4f03-a413-8769e7822ca8","trackedFileBackups":{},"timestamp":"2026-01-16T14:21:57.643Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 513 to 524 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:\n public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        info($empresa_plan->fecha_vencimiento->diffInDays(now()));\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_vacantes) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"mira quirea cambiar la funcionalida de esta funcion  public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        info($empresa_plan->fecha_vencimiento->diffInDays(now()));\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_vacantes) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    } y quero que solo valide la fecha de vencimineto"}]},"uuid":"56c78ee0-d640-4f03-a413-8769e7822ca8","timestamp":"2026-01-16T14:21:57.641Z"}
{"parentUuid":"56c78ee0-d640-4f03-a413-8769e7822ca8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MLBRc27N5KK83LYhiYcuPu","type":"message","role":"assistant","content":[{"type":"text","text":"Entendido, quieres simplificar la función `verificarVigenciaPlanVacantes` para que solo valide la fecha de vencimiento, eliminando la lógica de cantidad de ofertas laborales.\n\nDéjame leer el archivo completo para hacer el cambio correctamente."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":25608,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25608,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXBCvDs4UnhyTMhnWo1yd","type":"assistant","uuid":"c2e54f67-80bb-4cb0-bf3e-90405260c681","timestamp":"2026-01-16T14:22:01.383Z"}
{"parentUuid":"c2e54f67-80bb-4cb0-bf3e-90405260c681","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MLBRc27N5KK83LYhiYcuPu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CvsMBvEttpGcFWFm3ViyZP","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","offset":510,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":25608,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25608,"ephemeral_1h_input_tokens":0},"output_tokens":190,"service_tier":"standard"}},"requestId":"req_011CXBCvDs4UnhyTMhnWo1yd","type":"assistant","uuid":"57f761c6-02c2-4568-8f50-5fe80c83bfb0","timestamp":"2026-01-16T14:22:02.266Z"}
{"parentUuid":"57f761c6-02c2-4568-8f50-5fe80c83bfb0","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CvsMBvEttpGcFWFm3ViyZP","type":"tool_result","content":"   510→     * @return bool\n   511→     * @author Andres Gonzalez\n   512→     */\n   513→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   514→        info($empresa_plan->fecha_vencimiento->diffInDays(now()));\n   515→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   516→            return true;\n   517→        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n   518→            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_vacantes) > 0) {\n   519→                return true;\n   520→            }\n   521→        }\n   522→\n   523→        return false;\n   524→    }\n   525→\n   526→    /**\n   527→     * Retornar true si la instancia de EmpresaPlan tiene vacantes disponibles, false en otro caso.\n   528→     *\n   529→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"103c52ea-5ad6-4397-ab33-5b3887e92371","timestamp":"2026-01-16T14:22:03.405Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","content":"     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        info($empresa_plan->fecha_vencimiento->diffInDays(now()));\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_vacantes) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene vacantes disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.","numLines":20,"startLine":510,"totalLines":598}},"sourceToolAssistantUUID":"57f761c6-02c2-4568-8f50-5fe80c83bfb0"}
{"parentUuid":"103c52ea-5ad6-4397-ab33-5b3887e92371","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","message":{"model":"claude-opus-4-5-20251101","id":"msg_011i34WC4kD9GRmjpSVT5gNS","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora hago el cambio para que solo valide la fecha de vencimiento:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":615,"cache_read_input_tokens":25608,"cache_creation":{"ephemeral_5m_input_tokens":615,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXBCvexvhyX2go7KyqHmV","type":"assistant","uuid":"4e163829-51ca-4709-bb1d-cb360103c013","timestamp":"2026-01-16T14:22:05.841Z"}
{"parentUuid":"4e163829-51ca-4709-bb1d-cb360103c013","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","message":{"model":"claude-opus-4-5-20251101","id":"msg_011i34WC4kD9GRmjpSVT5gNS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012vGthvKRfrX9iY9K6ANBz8","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        info($empresa_plan->fecha_vencimiento->diffInDays(now()));\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_vacantes) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }","new_string":"    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":615,"cache_read_input_tokens":25608,"cache_creation":{"ephemeral_5m_input_tokens":615,"ephemeral_1h_input_tokens":0},"output_tokens":408,"service_tier":"standard"}},"requestId":"req_011CXBCvexvhyX2go7KyqHmV","type":"assistant","uuid":"d4cb9579-8c22-4e4b-930c-209d9b50c362","timestamp":"2026-01-16T14:22:08.559Z"}
{"type":"file-history-snapshot","messageId":"d4cb9579-8c22-4e4b-930c-209d9b50c362","snapshot":{"messageId":"56c78ee0-d640-4f03-a413-8769e7822ca8","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v1","version":1,"backupTime":"2026-01-16T14:22:12.452Z"}},"timestamp":"2026-01-16T14:21:57.643Z"},"isSnapshotUpdate":true}
{"parentUuid":"d4cb9579-8c22-4e4b-930c-209d9b50c362","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012vGthvKRfrX9iY9K6ANBz8","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   509→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   510→     * @return bool\n   511→     * @author Andres Gonzalez\n   512→     */\n   513→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   514→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   515→            return true;\n   516→        }\n   517→\n   518→        return false;\n   519→    }\n   520→\n   521→    /**\n   522→     * Retornar true si la instancia de EmpresaPlan tiene vacantes disponibles, false en otro caso.\n   523→     *"}]},"uuid":"a45474f4-dc66-4e1f-b7c3-4ee8f52bdeb1","timestamp":"2026-01-16T14:22:12.485Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        info($empresa_plan->fecha_vencimiento->diffInDays(now()));\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_vacantes) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }","newString":"    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $plan                  = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo           = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia              = $plan->vigencia;\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        }\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia;\n                }\n            }\n\n            // Poner el nuevo plan como próximo\n            $request->merge(['estado_id' => 3]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => 1]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy          = now();\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses             = $vigencia / 30;\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia          = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio'      => $fecha_inicio->format('Y-m-d'),\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n        $this->generarDirectorios(\"app/{$ruta}\");\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo'    => 'App\\Models\\Empresas\\EmpresaPlan',\n            'modelo_id' => $id,\n            'nombre'    => 'factura',\n            'ruta'      => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo       = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     *\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan                = $this->plan_repositorio->getUno($request->plan_id);\n        $empresa             = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de vacantes disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        info($empresa_plan->fecha_vencimiento->diffInDays(now()));\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_vacantes) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene vacantes disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":511,"oldLines":13,"newStart":511,"newLines":8,"lines":["      * @author Andres Gonzalez","      */","     public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {","-        info($empresa_plan->fecha_vencimiento->diffInDays(now()));","-        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {","+        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {","             return true;","-        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {","-            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_vacantes) > 0) {","-                return true;","-            }","         }"," ","         return false;"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d4cb9579-8c22-4e4b-930c-209d9b50c362"}
{"parentUuid":"a45474f4-dc66-4e1f-b7c3-4ee8f52bdeb1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","message":{"model":"claude-opus-4-5-20251101","id":"msg_011H3RJXsBNLr989gAHWZEfX","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He simplificado la función `verificarVigenciaPlanVacantes`. Ahora solo valida la fecha de vencimiento:\n\n**Cambios realizados:**\n- Eliminé el `info()` de debug\n- Eliminé la validación de `cantidad_ofertas_laborales` y `consumos_vacantes`\n- Cambié la lógica de `diffInDays(now()) < 0` por `gte(now())` que es más clara: retorna `true` si la fecha de vencimiento es mayor o igual a la fecha actual (es decir, el plan aún está vigente)\n\n**Lógica actual:**\n- Retorna `true` si existe fecha de vencimiento Y la fecha es mayor o igual a hoy (plan vigente)\n- Retorna `false` en cualquier otro caso (sin fecha o fecha vencida)"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":699,"cache_read_input_tokens":26223,"cache_creation":{"ephemeral_5m_input_tokens":699,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXBCwS5ZEzj5hynpE66c8","type":"assistant","uuid":"97f37cf0-963f-4127-8684-ebc43ef462e6","timestamp":"2026-01-16T14:22:20.473Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-16T14:22:49.023Z","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093"}
{"type":"file-history-snapshot","messageId":"324e2297-d785-4f6b-8dbd-d6387a257a8b","snapshot":{"messageId":"324e2297-d785-4f6b-8dbd-d6387a257a8b","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v2","version":2,"backupTime":"2026-01-16T14:22:49.089Z"}},"timestamp":"2026-01-16T14:22:49.078Z"},"isSnapshotUpdate":false}
{"parentUuid":"97f37cf0-963f-4127-8684-ebc43ef462e6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"tambien ajusta la documetnacion"}]},"uuid":"324e2297-d785-4f6b-8dbd-d6387a257a8b","timestamp":"2026-01-16T14:22:49.076Z"}
{"parentUuid":"324e2297-d785-4f6b-8dbd-d6387a257a8b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EJcKvyu1ue5Tv15tVBLR4A","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0186w6qC4qPukALUEbPTnQiS","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","offset":500,"limit":25}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":288,"cache_read_input_tokens":26922,"cache_creation":{"ephemeral_5m_input_tokens":288,"ephemeral_1h_input_tokens":0},"output_tokens":119,"service_tier":"standard"}},"requestId":"req_011CXBCz1pdQ7LwCW2Rc6AvR","type":"assistant","uuid":"775f055c-42c7-4553-9d3c-945487811954","timestamp":"2026-01-16T14:22:51.984Z"}
{"parentUuid":"775f055c-42c7-4553-9d3c-945487811954","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0186w6qC4qPukALUEbPTnQiS","type":"tool_result","content":"   500→     * @author Fahibram Cárcamo\n   501→     */\n   502→    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   503→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n   504→    }\n   505→\n   506→    /**\n   507→     * Verificar que el plan tenga unidades de vacantes disponibles o que la fecha de vencimiento no haya pasado.\n   508→     *\n   509→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   510→     * @return bool\n   511→     * @author Andres Gonzalez\n   512→     */\n   513→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   514→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   515→            return true;\n   516→        }\n   517→\n   518→        return false;\n   519→    }\n   520→\n   521→    /**\n   522→     * Retornar true si la instancia de EmpresaPlan tiene vacantes disponibles, false en otro caso.\n   523→     *\n   524→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b0a54bc0-7e5b-4d53-8afb-7724070471df","timestamp":"2026-01-16T14:22:53.104Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","content":"     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de vacantes disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene vacantes disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.","numLines":25,"startLine":500,"totalLines":593}},"sourceToolAssistantUUID":"775f055c-42c7-4553-9d3c-945487811954"}
{"parentUuid":"b0a54bc0-7e5b-4d53-8afb-7724070471df","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Bx416B4LECzgr8WKj1ezyj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017oYfFa2g5viSNCxM1igcGx","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"    /**\n     * Verificar que el plan tenga unidades de vacantes disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {","new_string":"    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool True si el plan está vigente, false si está vencido o no tiene fecha.\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":590,"cache_read_input_tokens":27210,"cache_creation":{"ephemeral_5m_input_tokens":590,"ephemeral_1h_input_tokens":0},"output_tokens":337,"service_tier":"standard"}},"requestId":"req_011CXBCzK1V9MPKFhmcYe1Wa","type":"assistant","uuid":"461de53d-f4a5-4d72-bc55-72eeac1a338f","timestamp":"2026-01-16T14:22:58.218Z"}
{"parentUuid":"461de53d-f4a5-4d72-bc55-72eeac1a338f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017oYfFa2g5viSNCxM1igcGx","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   502→    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   503→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n   504→    }\n   505→\n   506→    /**\n   507→     * Verificar que la fecha de vencimiento del plan no haya pasado.\n   508→     *\n   509→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   510→     * @return bool True si el plan está vigente, false si está vencido o no tiene fecha.\n   511→     * @author Andres Gonzalez\n   512→     */\n   513→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   514→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   515→            return true;\n   516→        }\n   517→"}]},"uuid":"5a4a14b7-548f-4c55-9178-527ae258b79d","timestamp":"2026-01-16T14:23:02.117Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"    /**\n     * Verificar que el plan tenga unidades de vacantes disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {","newString":"    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool True si el plan está vigente, false si está vencido o no tiene fecha.\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $plan                  = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo           = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia              = $plan->vigencia;\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        }\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia;\n                }\n            }\n\n            // Poner el nuevo plan como próximo\n            $request->merge(['estado_id' => 3]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => 1]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy          = now();\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses             = $vigencia / 30;\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia          = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio'      => $fecha_inicio->format('Y-m-d'),\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n        $this->generarDirectorios(\"app/{$ruta}\");\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo'    => 'App\\Models\\Empresas\\EmpresaPlan',\n            'modelo_id' => $id,\n            'nombre'    => 'factura',\n            'ruta'      => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo       = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     *\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan                = $this->plan_repositorio->getUno($request->plan_id);\n        $empresa             = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de vacantes disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene vacantes disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":504,"oldLines":10,"newStart":504,"newLines":10,"lines":["     }"," ","     /**","-     * Verificar que el plan tenga unidades de vacantes disponibles o que la fecha de vencimiento no haya pasado.","+     * Verificar que la fecha de vencimiento del plan no haya pasado.","      *","      * @param EmpresaPlan $empresa_plan Plan de la empresa.","-     * @return bool","+     * @return bool True si el plan está vigente, false si está vencido o no tiene fecha.","      * @author Andres Gonzalez","      */","     public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"461de53d-f4a5-4d72-bc55-72eeac1a338f"}
{"parentUuid":"5a4a14b7-548f-4c55-9178-527ae258b79d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"12756fa4-adaf-48d8-a88e-2a0b5e1c1093","version":"2.1.7","gitBranch":"D26-260","slug":"purring-wiggling-kernighan","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vg7X7udGStR2ugM4QyP6Yk","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Actualicé la documentación:\n\n**Cambios en el PHPDoc:**\n- **Antes:** \"Verificar que el plan tenga unidades de vacantes disponibles o que la fecha de vencimiento no haya pasado.\"\n- **Ahora:** \"Verificar que la fecha de vencimiento del plan no haya pasado.\"\n\nTambién mejoré la descripción del `@return` para que sea más clara: \"True si el plan está vigente, false si está vencido o no tiene fecha.\""}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":697,"cache_read_input_tokens":27800,"cache_creation":{"ephemeral_5m_input_tokens":697,"ephemeral_1h_input_tokens":0},"output_tokens":127,"service_tier":"standard"}},"requestId":"req_011CXBD16XRsFFoKMEFpRaMx","type":"assistant","uuid":"147fe267-4e56-4d94-b5ff-49d3d178fa41","timestamp":"2026-01-16T14:23:07.753Z"}
{"type":"summary","summary":"API Error: 500 {\"type\":\"error\",\"error\":{\"type\":\"api_error\",\"message\":\"Internal server error\"},\"request_id\":\"req_011CXmQ9hkdTPH6UFNQPqaGs\"}","leafUuid":"147fe267-4e56-4d94-b5ff-49d3d178fa41"}

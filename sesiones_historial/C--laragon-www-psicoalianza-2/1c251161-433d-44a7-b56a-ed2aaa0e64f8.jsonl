{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-08T15:59:52.558Z","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8"}
{"type":"file-history-snapshot","messageId":"5d3f9fa4-de66-4e39-a42c-88756646ce20","snapshot":{"messageId":"5d3f9fa4-de66-4e39-a42c-88756646ce20","trackedFileBackups":{},"timestamp":"2026-01-08T15:59:52.612Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 543 to 543 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php:\n&& is_null($etapa_usuario->puntaje)\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"listo en esta funcion public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void { alk komneto d ehacer sta validacion && is_null($etapa_usuario->puntaje) quiero que esa validacion no se aplique si llega otro prameto como true y que por defecto se afalse para que aplique esa validacion"}]},"uuid":"5d3f9fa4-de66-4e39-a42c-88756646ce20","timestamp":"2026-01-08T15:59:52.609Z"}
{"parentUuid":"5d3f9fa4-de66-4e39-a42c-88756646ce20","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011Sxn7AN1pP8KJz2btzmRsz","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a modificar la función `guardarPuntajeAdecuacionReclutador` para agregar un parámetro que permita omitir la validación de `is_null($etapa_usuario->puntaje)`.\n\nPrimero, déjame leer el archivo completo para entender el contexto:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":24401,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24401,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWvBuyuztDKcqyyBb4PA6","type":"assistant","uuid":"fd594f62-cd99-4ca9-84b1-1c21b4962487","timestamp":"2026-01-08T15:59:59.192Z"}
{"parentUuid":"fd594f62-cd99-4ca9-84b1-1c21b4962487","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011Sxn7AN1pP8KJz2btzmRsz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VG8JtuyPgJE8wnKDcdLP5a","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":24401,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24401,"ephemeral_1h_input_tokens":0},"output_tokens":169,"service_tier":"standard"}},"requestId":"req_011CWvBuyuztDKcqyyBb4PA6","type":"assistant","uuid":"21d86faf-23dd-4adb-8432-cdabedf8fee7","timestamp":"2026-01-08T16:00:00.140Z"}
{"parentUuid":"21d86faf-23dd-4adb-8432-cdabedf8fee7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VG8JtuyPgJE8wnKDcdLP5a","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Vacantes;\n     4→\n     5→use App\\Traits\\IATrait;\n     6→use App\\Traits\\StringTrait;\n     7→use Illuminate\\Support\\Arr;\n     8→use App\\Traits\\ArchivoTrait;\n     9→use Illuminate\\Http\\Request;\n    10→use App\\Models\\Vacantes\\Vacante;\n    11→use App\\Http\\Services\\BaseService;\n    12→use App\\Models\\Agendas\\EstadoAgenda;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Illuminate\\Support\\Facades\\Mail;\n    15→use App\\Models\\Vacantes\\EtapaVacante;\n    16→use App\\Models\\Vacantes\\EstadoVacante;\n    17→use App\\Models\\Vacantes\\MovimientoVacante;\n    18→use App\\Mail\\NotificarFinalizacionEtapaMail;\n    19→use App\\Mail\\NotificarPostulanteVacanteMail;\n    20→use App\\Models\\Vacantes\\EtapaVacanteUsuario;\n    21→use Illuminate\\Http\\Client\\RequestException;\n    22→use App\\Http\\Services\\Vacantes\\VacanteService;\n    23→use App\\Models\\Configuraciones\\PlantillaCorreo;\n    24→use Illuminate\\Http\\Client\\ConnectionException;\n    25→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    26→use App\\Http\\Services\\Usuarios\\TokenAccesoService;\n    27→use App\\Http\\Repositories\\Agendas\\AgendaRepository;\n    28→use App\\Http\\Services\\Vacantes\\EtapaVacanteService;\n    29→use App\\Jobs\\Vacantes\\ProcesarVideoentrevistaIAJob;\n    30→use App\\Http\\Repositories\\Procesos\\ProcesoRepository;\n    31→use App\\Http\\Repositories\\Vacantes\\VacanteRepository;\n    32→use App\\Http\\Services\\Agendas\\ResultadoAgendaService;\n    33→use App\\Http\\Services\\Configuraciones\\ArchivoService;\n    34→use App\\Notifications\\NotificarAvanceProcesoNotification;\n    35→use App\\Http\\Repositories\\Vacantes\\EtapaVacanteRepository;\n    36→use App\\Http\\Repositories\\Vacantes\\TranscripcionRepository;\n    37→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    38→use App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    39→use App\\Http\\Repositories\\Vacantes\\AspectoPuntajeRepository;\n    40→use App\\Http\\Services\\Configuraciones\\PlantillaCorreoService;\n    41→use App\\Http\\Repositories\\Vacantes\\FormatoEntrevistaRepository;\n    42→use App\\Http\\Repositories\\Vacantes\\EtapaVacanteUsuarioRepository;\n    43→use App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\n    44→use App\\Http\\Repositories\\Vacantes\\EtapaMovimientoVacanteRepository;\n    45→use App\\Http\\Repositories\\OfertasLaborales\\PreguntaOfertaLaboralRepository;\n    46→use App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\n    47→use App\\Http\\Repositories\\OfertasLaborales\\PuntajePreguntaOfertaLaboralRepository;\n    48→\n    49→/**\n    50→ * @property EtapaVacanteUsuarioRepository $repositorio\n    51→ */\n    52→class EtapaVacanteUsuarioService extends BaseService\n    53→{\n    54→    use ArchivoTrait, IATrait, StringTrait;\n    55→\n    56→    /**\n    57→     * @var float|int $puntaje_total Puntaje total, utilizado para la adecuación de HV.\n    58→     */\n    59→    private $puntaje_total = 0;\n    60→\n    61→    /**\n    62→     * @var float $puntaje Puntaje de aspecto, utilizado para la adecuación de HV.\n    63→     */\n    64→    private $puntaje = 0;\n    65→\n    66→    /**\n    67→     * @var bool $cumple Indica si cumple con el aspecto, utilizada para la adecuación de HV.\n    68→     */\n    69→    private $cumple = false;\n    70→\n    71→    /**\n    72→     * Constructor.\n    73→     *\n    74→     * @param EtapaVacanteUsuarioRepository $repositorio Repositorio de etapas de vacantes de usuarios.\n    75→     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n    76→     * @param EtapaVacanteRepository $etapa_vacante_repositorio Repositorio de etapas de vacantes.\n    77→     * @param AspectoPuntajeRepository $aspecto_puntaje_repositorio Repositorio de puntajes de aspectos.\n    78→     * @param ArchivoService $archivo_servicio Servicio de archivos.\n    79→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    80→     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n    81→     * @param PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio Repositorio de preguntas de ofertas laborales.\n    82→     * @param PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio Repositorio de puntajes de preguntas de ofertas laborales.\n    83→     * @param EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio Repositorio de movimientos de etapas de vacantes.\n    84→     * @param ProcesoRepository $proceso_repositorio Repositorio de procesos.\n    85→     * @param TranscripcionRepository $transcripcion_repositorio Repositorio de transcripciones.\n    86→     * @param PlantillaCorreoService $plantilla_correo_servicio Servicio de plantillas de correo.\n    87→     * @param TokenAccesoService $token_acceso_servicio Servicio de tokens de acceso.\n    88→     * @param UserRepository $usuario_repositorio Servicio de usuarios.\n    89→     * @param VacanteRepository $vacante_repositorio Repositorio de vacantes.\n    90→     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n    91→     * @param ResultadoAgendaService $resultado_agenda_servicio Servicio de resultados de agendas.\n    92→     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n    93→     * @param FormatoEntrevistaRepository $formato_entrevista_repositorio Repositorio de formatos de entrevista.\n    94→     * @return void\n    95→     * @author Daniel Beltrán\n    96→     * @author Andres Gonzalez\n    97→     */\n    98→    public function __construct(\n    99→        EtapaVacanteUsuarioRepository $repositorio,\n   100→        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n   101→        protected EtapaVacanteRepository $etapa_vacante_repositorio,\n   102→        protected AspectoPuntajeRepository $aspecto_puntaje_repositorio,\n   103→        protected ArchivoService $archivo_servicio,\n   104→        protected ArchivoRepository $archivo_repositorio,\n   105→        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n   106→        protected PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio,\n   107→        protected PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio,\n   108→        protected EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio,\n   109→        protected ProcesoRepository $proceso_repositorio,\n   110→        protected TranscripcionRepository $transcripcion_repositorio,\n   111→        protected PlantillaCorreoService $plantilla_correo_servicio,\n   112→        protected TokenAccesoService $token_acceso_servicio,\n   113→        protected UserRepository $usuario_repositorio,\n   114→        protected VacanteRepository $vacante_repositorio,\n   115→        protected AgendaRepository $agenda_repositorio,\n   116→        protected ResultadoAgendaService $resultado_agenda_servicio,\n   117→        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n   118→        protected FormatoEntrevistaRepository $formato_entrevista_repositorio\n   119→    ) {\n   120→        parent::__construct($repositorio);\n   121→    }\n   122→\n   123→    /**\n   124→     * Guardar documento solicitado de una etapa de vacante de usuario.\n   125→     *\n   126→     * @param Request $request Contenido de la petición.\n   127→     * @return void\n   128→     * @author Andres Gonzalez\n   129→     */\n   130→    public function guardarDocumentoSolicitado(Request $request): void {\n   131→        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   132→\n   133→        if ($request->hasFile('archivo')) {\n   134→            $this->archivo_servicio->guardarVarios(EtapaVacanteUsuario::class, $request->etapa_vacante_usuario_id, [$request->nombre_documento => $request->file('archivo')], 'empresas/' . $empresa->id . '/documentos-solicitados', true);\n   135→        }\n   136→    }\n   137→\n   138→    /**\n   139→     * Establecer valores para puntaje y cumplimiento de un aspecto.\n   140→     *\n   141→     * @param float $puntaje Puntaje obtenido.\n   142→     * @param bool $cumple Indica si cumple.\n   143→     * @return void\n   144→     * @author Daniel Beltrán\n   145→     */\n   146→    private function establecerPuntajeCumplimiento(float $puntaje = 0, bool $cumple = false): void {\n   147→        $this->puntaje = $puntaje;\n   148→        $this->cumple  = $cumple;\n   149→    }\n   150→\n   151→    /**\n   152→     * Guardar puntaje de un aspecto evaluado.\n   153→     *\n   154→     * @param int $etapa_vacante_usuario_id ID de la etapa del usuario en la vacante.\n   155→     * @param string $categoria Categoría del aspecto.\n   156→     * @param string $aspecto Aspecto evaluado.\n   157→     * @return void\n   158→     * @author Daniel Beltrán\n   159→     */\n   160→    private function guardarAspectoPuntaje(int $etapa_vacante_usuario_id, string $categoria, string $aspecto): void {\n   161→        $this->aspecto_puntaje_repositorio->crearOActualizar([\n   162→            'etapa_vacante_usuario_id' => $etapa_vacante_usuario_id,\n   163→            'categoria'                => $categoria,\n   164→            'aspecto'                  => $aspecto\n   165→        ], [\n   166→            'puntaje'                  => $this->puntaje,\n   167→            'cumple'                   => $this->cumple\n   168→        ]);\n   169→\n   170→        $this->puntaje_total += $this->puntaje;\n   171→        $this->establecerPuntajeCumplimiento();\n   172→    }\n   173→\n   174→    /**\n   175→     * Generar adecuación de hoja de vida.\n   176→     *\n   177→     * @param int $id ID de la etapa del usuario en la vacante.\n   178→     * @return void\n   179→     * @author Daniel Beltrán\n   180→     */\n   181→    public function generarAdecuacionHV(int $id): void {\n   182→        $etapa_usuario = $this->repositorio->getUno($id);\n   183→\n   184→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   185→        if ($etapa_usuario->etapa->nombre === EtapaVacante::REVISION_HV_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n   186→            $perfil_laboral = $this->perfil_laboral_repositorio->getUnoAvanzado(new Request([\n   187→                'usuario_id'                     => $etapa_usuario->usuario_id,\n   188→                'incluir_experiencias_laborales' => true,\n   189→                'incluir_estudios'               => true,\n   190→                'incluir_idiomas'                => true,\n   191→                'incluir_usuario'                => true\n   192→            ]));\n   193→\n   194→            // Generar y guardar la adecuación del perfil de candidato (habilidades y herramientas tecnológicas)\n   195→            $categoria            = 'perfil';\n   196→            $puntaje_aspecto      = 100 / 2;\n   197→            $datos_vacante        = $etapa_usuario->vacante->datos;\n   198→            $habilidades_vacante  = $datos_vacante->where('llave', 'habilidades')->first();\n   199→            $herramientas_vacante = $datos_vacante->where('llave', 'herramientas_tecnologicas')->first();\n   200→\n   201→            // Validar coincidencia para las habilidades\n   202→            if (!is_null($habilidades_vacante->valor) && !empty($habilidades_vacante->valor)) {\n   203→                $habilidades_vacante        = array_map(fn($item) => trim($item), explode(',', $habilidades_vacante->valor));\n   204→                $habilidades_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->habilidades));\n   205→                $coincidencias              = count(array_uintersect($habilidades_vacante, $habilidades_perfil_laboral, 'strcasecmp'));\n   206→\n   207→                if ($coincidencias >= count($habilidades_vacante)) {\n   208→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   209→                }\n   210→            } else {\n   211→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   212→            }\n   213→\n   214→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'habilidades');\n   215→\n   216→            // Validar coincidencia para las herramientas tecnológicas\n   217→            if (!is_null($herramientas_vacante->valor) && !empty($herramientas_vacante->valor)) {\n   218→                $herramientas_vacante        = array_map(fn($item) => trim($item), explode(',', $herramientas_vacante->valor));\n   219→                $herramientas_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->herramientas_tecnologicas));\n   220→                $coincidencias               = count(array_uintersect($herramientas_vacante, $herramientas_perfil_laboral, 'strcasecmp'));\n   221→\n   222→                if ($coincidencias >= count($herramientas_vacante)) {\n   223→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   224→                }\n   225→            } else {\n   226→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   227→            }\n   228→\n   229→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'herramientas');\n   230→\n   231→            // Generar y guardar la adecuación de requisitos del candidato (género, edad, nivel educativo, modalidad de trabajo, salario, experiencia, idiomas, licencia de conducir)\n   232→            $categoria       = 'requisito';\n   233→            $puntaje_aspecto = 100 / 8;\n   234→\n   235→            // Validar coincidencia de género\n   236→            $genero_vacante = $datos_vacante->where('llave', 'genero')->first();\n   237→\n   238→            if (!is_null($genero_vacante) && !empty($genero_vacante)) {\n   239→                if ($genero_vacante->valor === mb_convert_case($perfil_laboral->usuario->genero->nombre, MB_CASE_LOWER)) {\n   240→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   241→                } elseif ($genero_vacante->valor === 'indiferente') {\n   242→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   243→                }\n   244→            } else {\n   245→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   246→            }\n   247→\n   248→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'genero');\n   249→\n   250→            // Validar coincidencia de edad\n   251→            $edad_minima_vacante = $datos_vacante->where('llave', 'edad_minima')->first();\n   252→            $edad_maxima_vacante = $datos_vacante->where('llave', 'edad_maxima')->first();\n   253→\n   254→            if (empty($edad_minima_vacante->valor) || empty($edad_maxima_vacante->valor)) {\n   255→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   256→            } elseif ($perfil_laboral->usuario->edad >= $edad_minima_vacante->valor && $perfil_laboral->usuario->edad <= $edad_maxima_vacante->valor) {\n   257→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   258→            }\n   259→\n   260→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'edad');\n   261→\n   262→            // Validar coincidencia de nivel educativo\n   263→            $nivel_educativo_vacante = $datos_vacante->where('llave', 'nivel_educativo')->first();\n   264→            $escala_estudios         = [\n   265→                'Preescolar'                      => 1,\n   266→                'Primaria'                        => 2,\n   267→                'Secundaria básica'               => 3,\n   268→                'Secundaria superior'             => 4,\n   269→                'Educación continua y permanente' => 5,\n   270→                'Técnico'                         => 6,\n   271→                'Tecnólogo'                       => 7,\n   272→                'Profesional'                     => 8,\n   273→                'Especialización (postgrado)'     => 9,\n   274→                'Maestría (postgrado)'            => 10,\n   275→                'Doctorado (postgrado)'           => 11\n   276→            ];\n   277→\n   278→            if (empty($nivel_educativo_vacante->valor) || $nivel_educativo_vacante->valor === 'indiferente') {\n   279→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   280→            } elseif (count($perfil_laboral->estudios) > 0) {\n   281→                $cumple_nivel_educativo = false;\n   282→\n   283→                foreach ($perfil_laboral->estudios as $estudio) {\n   284→                    if ($escala_estudios[$nivel_educativo_vacante->valor] <= $escala_estudios[$estudio->nivelEducativo->nombre]) {\n   285→                        $cumple_nivel_educativo = true;\n   286→                        break;\n   287→                    }\n   288→                }\n   289→\n   290→                if ($cumple_nivel_educativo) {\n   291→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   292→                }\n   293→            }\n   294→\n   295→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'estudios');\n   296→\n   297→            // Validar coincidencia de modalidad de trabajo\n   298→            if (!is_null($etapa_usuario->vacante->modalidad_trabajo_id)) {\n   299→                if ($etapa_usuario->vacante->modalidad_trabajo_id === $perfil_laboral->modalidad_trabajo_id) {\n   300→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   301→                }\n   302→            } else {\n   303→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   304→            }\n   305→\n   306→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'modalidad_trabajo');\n   307→\n   308→            // Validar coincidencia de salario\n   309→            if (is_null($etapa_usuario->vacante->salario)) {\n   310→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   311→            } elseif (!is_null($etapa_usuario->vacante->salario) && is_null($etapa_usuario->vacante->salario_maximo)) {\n   312→                // Salario fijo\n   313→                if (!is_null($perfil_laboral->salario_maximo)) {\n   314→                    // Validar cuando el salario de la vacante es fijo pero el del usuario es rango\n   315→                    if (($etapa_usuario->vacante->salario >= $perfil_laboral->salario && $etapa_usuario->vacante->salario <= $perfil_laboral->salario_maximo) || ($perfil_laboral->salario <= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario)) {\n   316→                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   317→                    }\n   318→                } elseif ($perfil_laboral->salario <= $etapa_usuario->vacante->salario) {\n   319→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   320→                }\n   321→            } elseif (!is_null($etapa_usuario->vacante->salario) && !is_null($etapa_usuario->vacante->salario_maximo)) {\n   322→                // Rango de salario\n   323→                if (!is_null($perfil_laboral->salario_maximo)) {\n   324→                    // Validar cuando el salario del usuario y de la vacante son rangos\n   325→                    if (($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) || ($perfil_laboral->salario_maximo >= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario_maximo)) {\n   326→                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   327→                    }\n   328→                } else {\n   329→                    if ($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) {\n   330→                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   331→                    }\n   332→                }\n   333→            }\n   334→\n   335→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'salario');\n   336→\n   337→            // Validar coincidencia de experiencia\n   338→            $experiencia_vacante   = $datos_vacante->where('llave', 'experiencia_laboral')->first();\n   339→            $experiencia_aplicante = $perfil_laboral->experienciasLaborales->sum('tiempo');\n   340→            $experiencias          = [\n   341→                '1 año'        => 1,\n   342→                '2 años'       => 2,\n   343→                '3 años'       => 3,\n   344→                '4 años'       => 4,\n   345→                '5 años o más' => 5\n   346→            ];\n   347→\n   348→            if (empty($experiencia_vacante->valor) || $experiencia_vacante->valor === 'Sin experiencia') {\n   349→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   350→            } elseif ($experiencia_vacante->valor === 'Menos de 1 año') {\n   351→                if ($experiencia_aplicante > 0 && $experiencia_aplicante < 365) {\n   352→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   353→                }\n   354→            } elseif (($experiencias[$experiencia_vacante->valor] * 365) <= $experiencia_aplicante) {\n   355→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   356→            }\n   357→\n   358→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'experiencia');\n   359→\n   360→            // Validar coincidencia de idiomas\n   361→            $idiomas_vacante = $etapa_usuario->vacante->idiomas;\n   362→            $escala_idiomas  = [\n   363→                'A1' => 1,\n   364→                'A2' => 2,\n   365→                'B1' => 3,\n   366→                'B2' => 4,\n   367→                'C1' => 5,\n   368→                'C2' => 6\n   369→            ];\n   370→\n   371→            if ($idiomas_vacante->count() > 0) {\n   372→                $coincidencias_idiomas = 0;\n   373→\n   374→                if ($perfil_laboral->idiomas->count() > 0) {\n   375→                    foreach ($idiomas_vacante as $idioma) {\n   376→                        foreach ($perfil_laboral->idiomas as $idioma_perfil) {\n   377→                            if ($idioma->idioma_id === $idioma_perfil->idioma_id && $escala_idiomas[$idioma->nivel] <= $escala_idiomas[$idioma_perfil->nivel]) {\n   378→                                $coincidencias_idiomas++;\n   379→                            }\n   380→                        }\n   381→                    }\n   382→                }\n   383→\n   384→                if ($coincidencias_idiomas >= $idiomas_vacante->count()) {\n   385→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   386→                }\n   387→            } else {\n   388→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   389→            }\n   390→\n   391→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'idiomas');\n   392→\n   393→            // Validar coincidencia de licencia de conducir\n   394→            $licencia_conducir_vacante = $datos_vacante->where('llave', 'licencia_conducir')->first();\n   395→            $escala_licencias          = [\n   396→                'A1' => 1,\n   397→                'A2' => 2,\n   398→                'B1' => 3,\n   399→                'B2' => 4,\n   400→                'B3' => 5,\n   401→                'C1' => 6,\n   402→                'C2' => 7,\n   403→                'C3' => 8\n   404→            ];\n   405→\n   406→            if (empty($licencia_conducir_vacante->valor)) {\n   407→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   408→            } elseif (is_null($perfil_laboral->licencia_conducir)) {\n   409→                if (empty($licencia_conducir_vacante->valor)) {\n   410→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   411→                }\n   412→            } elseif ($escala_licencias[$licencia_conducir_vacante->valor] <= $escala_licencias[$perfil_laboral->licencia_conducir]) {\n   413→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   414→            }\n   415→\n   416→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'licencia_conducir');\n   417→\n   418→            $puntaje_total = round($this->puntaje_total / 2); // Se divide entre las dos categorías existentes\n   419→            $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::REVISION_HV_ID, $puntaje_total, 'descartar_candidatos_adecuaciones_bajas_hv', 'descartar_candidatos_adecuaciones_medias_hv');\n   420→        }\n   421→    }\n   422→\n   423→    /**\n   424→     * Generar adecuación para preguntas prefiltro.\n   425→     *\n   426→     * Califica las respuestas del aplicante en cada una de las preguntas y calcula la adecuación en base a sus resultados.\n   427→     *\n   428→     * @param int $id ID de la etapa del usuario en la vacante.\n   429→     * @return void\n   430→     * @author Daniel Beltrán\n   431→     */\n   432→    public function generarAdecuacionPrefiltro(int $id): void {\n   433→        $etapa_usuario = $this->repositorio->getUno($id);\n   434→\n   435→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   436→        if ($etapa_usuario->etapa->nombre === EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n   437→            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n   438→                'etapa_vacante_id'   => $etapa_usuario->etapa_vacante_id,\n   439→                'usuario_id'         => $etapa_usuario->usuario_id,\n   440→                'incluir_respuestas' => true\n   441→            ]));\n   442→\n   443→            $porcentaje_pregunta  = 100 / $preguntas->count();\n   444→            $respuestas_correctas = 0;\n   445→\n   446→            foreach ($preguntas as $pregunta) {\n   447→                $puntaje    = null;\n   448→                $puntaje_ia = null;\n   449→\n   450→                if ($pregunta->es_abierta) {\n   451→                    $respuesta = $opcion_seleccionada = $pregunta->respuestas->first();\n   452→\n   453→                    if (!is_null($respuesta)) {\n   454→                        try {\n   455→                            $peticion_ia = $this->realizarPeticionIA(\n   456→                                ruta: 'calificar-pregunta-abierta',\n   457→                                parametros: [\n   458→                                    'pregunta'  => $pregunta->enunciado,\n   459→                                    'respuesta' => $respuesta->respuesta,\n   460→                                ],\n   461→                                contexto_tracking: [\n   462→                                    'vacante_id' => $etapa_usuario->etapa->vacante_id ?? null,\n   463→                                    'agenda_id' => null,\n   464→                                ]\n   465→                            );\n   466→\n   467→                            if (!is_null($peticion_ia) && $peticion_ia['status_code'] === 200) {\n   468→                                $puntaje_ia = $peticion_ia['calificacion'];\n   469→                            }\n   470→                        } catch (RequestException|ConnectionException $error) {}\n   471→                    }\n   472→                } else {\n   473→                    $opciones_correctas = $pregunta->opciones->where('es_correcta', true);\n   474→\n   475→                    // Selección única\n   476→                    if ($opciones_correctas->count() === 1) {\n   477→                        $opcion_correcta     = $opciones_correctas->first();\n   478→                        $opcion_seleccionada = $pregunta->respuestas->first();\n   479→                        $puntaje             = (int) (!is_null($opcion_seleccionada) && $opcion_correcta->id === $opcion_seleccionada->opcion_pregunta_id);\n   480→                    } else { // Selección múltiple\n   481→                        $opciones_correctas     = $opciones_correctas->pluck('id')->toArray();\n   482→                        $opciones_seleccionadas = $pregunta->respuestas->pluck('opcion_pregunta_id')->toArray();\n   483→                        $aciertos               = count(array_intersect($opciones_seleccionadas, $opciones_correctas));\n   484→                        $fallos                 = count(array_diff($opciones_seleccionadas, $opciones_correctas));\n   485→                        $puntaje                = (int) ($aciertos - $fallos === count($opciones_correctas));\n   486→                    }\n   487→                }\n   488→\n   489→                // Guardar el puntaje obtenido en cada pregunta\n   490→                $this->puntaje_pregunta_oferta_laboral_repositorio->crearSiNoExiste([\n   491→                    'pregunta_id' => $pregunta->id,\n   492→                    'usuario_id'  => $etapa_usuario->usuario_id\n   493→                ], [\n   494→                    'puntaje'     => $puntaje,\n   495→                    'puntaje_ia'  => $puntaje_ia\n   496→                ]);\n   497→\n   498→                // Sumar el puntaje total\n   499→                if (is_null($puntaje) && !is_null($puntaje_ia)) {\n   500→                    $respuestas_correctas += $puntaje_ia;\n   501→                } else {\n   502→                    $respuestas_correctas += $puntaje;\n   503→                }\n   504→            }\n   505→\n   506→            $puntaje_etapa = $respuestas_correctas * $porcentaje_pregunta;\n   507→\n   508→            if ($etapa_usuario->vacante->automatizar_etapas) {\n   509→                // Obtener el movimiento de la etapa con sus configuraciones\n   510→                $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n   511→                    'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n   512→                    'movimiento_vacante_id'   => MovimientoVacante::PREGUNTAS_PREFILTRO_ID,\n   513→                    'incluir_configuraciones' => true\n   514→                ]));\n   515→\n   516→                $configuracion_preguntas_correctas = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', 'descartar_candidatos_respondieron_menos_preguntas_prefiltro')->first();\n   517→\n   518→                // Avanzar al aplicante de etapa o descartarlo según la configuración de la etapa\n   519→                if (!is_null($configuracion_preguntas_correctas) && $configuracion_preguntas_correctas->valor <= $respuestas_correctas) {\n   520→                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa);\n   521→                } else {\n   522→                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa, descartar: true);\n   523→                }\n   524→            } else {\n   525→                $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_etapa]);\n   526→            }\n   527→        }\n   528→    }\n   529→\n   530→    /**\n   531→     * Guardar el puntaje de adecuación dado por el reclutador.\n   532→     *\n   533→     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n   534→     *\n   535→     * @param int $id ID de la etapa del usuario en la vacante.\n   536→     * @param int $puntaje Puntaje dado por el reclutador.\n   537→     * @return void\n   538→     * @author Daniel Beltrán\n   539→     */\n   540→    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n   541→        $etapa_usuario = $this->repositorio->getUno($id);\n   542→\n   543→        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n   544→            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n   545→                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n   546→            }\n   547→\n   548→            if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::VIDEO_ENTREVISTA_NOMBRE, EtapaVacante::ENTREVISTA_NOMBRE])) {\n   549→                if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE) {\n   550→                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID;\n   551→                    $llave_configuracion_formato             = 'solicitar_formato_videoentrevista';\n   552→                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_videoentrevista';\n   553→                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_videoentrevista';\n   554→                } else {\n   555→                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n   556→                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n   557→                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n   558→                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n   559→                }\n   560→\n   561→                if ($this->verificarFormatoEntrevista($etapa_usuario, $movimiento_vacante_id, $llave_configuracion_formato)) {\n   562→                    $this->gestionarContinuidadAplicante($etapa_usuario, $movimiento_vacante_id, $puntaje, $llave_configuracion_adecuaciones_bajas, $llave_configuracion_adecuaciones_medias);\n   563→                } else {\n   564→                    $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n   565→                }\n   566→\n   567→                // TODO: Invocar esta función al momento de completar el formato de entrevista\n   568→            }\n   569→        }\n   570→    }\n   571→\n   572→    /**\n   573→     * Generar adecuación para pruebas psicométricas.\n   574→     *\n   575→     * @param int $id ID de la etapa del usuario en la vacante.\n   576→     * @return void\n   577→     * @author Daniel Beltrán\n   578→     */\n   579→    public function generarAdecuacionPruebasPsicometricas(int $id): void {\n   580→        $etapa_usuario = $this->repositorio->getUno($id);\n   581→\n   582→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   583→        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n   584→            $indice_talento = $this->proceso_repositorio->obtenerIndiceTalento($etapa_usuario->vacante->proceso->id, $etapa_usuario->usuario_id)->indice_talento;\n   585→\n   586→            if ($indice_talento >= 0) {\n   587→                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBAS_PSICOMETRICAS_ID, $indice_talento, 'descartar_candidatos_puntuaciones_bajas', 'descartar_candidatos_puntuaciones_medias', true);\n   588→            }\n   589→        }\n   590→    }\n   591→\n   592→    /**\n   593→     * Generar adecuación para videoentrevista.\n   594→     *\n   595→     * @param int $id ID de la etapa del usuario en la vacante.\n   596→     * @return void\n   597→     * @author Daniel Beltrán\n   598→     * @author Andres Gonzalez\n   599→     */\n   600→    public function generarAdecuacionVideoentrevista(int $id): void {\n   601→        $etapa_usuario = $this->repositorio->getUno($id);\n   602→\n   603→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   604→        if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje_ia)) {\n   605→            ProcesarVideoentrevistaIAJob::dispatch($etapa_usuario);\n   606→        }\n   607→    }\n   608→\n   609→    /**\n   610→     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n   611→     *\n   612→     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n   613→     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n   614→     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n   615→     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n   616→     * @author Daniel Beltrán\n   617→     */\n   618→    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n   619→        $formato_diligenciado = false;\n   620→        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n   621→            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n   622→            'movimiento_vacante_id'   => $movimiento_vacante_id,\n   623→            'incluir_configuraciones' => true\n   624→        ]));\n   625→\n   626→        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n   627→\n   628→        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n   629→            $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n   630→        } else {\n   631→            $formato_diligenciado = true;\n   632→        }\n   633→\n   634→        return $formato_diligenciado;\n   635→    }\n   636→\n   637→    /**\n   638→     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n   639→     *\n   640→     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n   641→     * @param int $usuario_id ID del usuario (aplicante).\n   642→     * @return void\n   643→     * @author Daniel Beltrán\n   644→     */\n   645→    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n   646→        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n   647→            'etapa_vacante_id' => $etapa_vacante_id,\n   648→            'usuario_id'       => $usuario_id\n   649→        ]));\n   650→\n   651→        if ($etapa_usuario->activo) {\n   652→            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n   653→                'etapa_vacante_id' => $etapa_usuario->etapa_vacante_id,\n   654→                'usuario_id'       => $etapa_usuario->usuario_id,\n   655→                'incluir_puntajes' => true\n   656→            ]));\n   657→\n   658→            $puntaje            = 0;\n   659→            $puntaje_individual = 100 / $preguntas->count();\n   660→\n   661→            foreach ($preguntas as $pregunta) {\n   662→                if (is_null($pregunta->puntajes[0]->puntaje) && !is_null($pregunta->puntajes[0]->puntaje_ia)) {\n   663→                    $puntaje += $pregunta->puntajes[0]->puntaje_ia;\n   664→                } elseif (!is_null($pregunta->puntajes[0]->puntaje)) {\n   665→                    $puntaje += $pregunta->puntajes[0]->puntaje;\n   666→                }\n   667→            }\n   668→\n   669→            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_individual * $puntaje]);\n   670→        }\n   671→    }\n   672→\n   673→    /**\n   674→     * Guardar el puntaje de la etapa actual y gestionar la continuidad del aplicante en la vacante.\n   675→     *\n   676→     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n   677→     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n   678→     * @param int $puntaje Puntaje obtenido en la etapa actual.\n   679→     * @param string $llave_puntajes_bajos Llave de configuración para puntajes bajos.\n   680→     * @param string $llave_puntajes_medios Llave de configuración para puntajes medios.\n   681→     * @param bool $escala_pruebas_psicometricas Indica si debe utilizar la escala de puntajes de pruebas psicométricas.\n   682→     * @return void\n   683→     * @author Daniel Beltrán\n   684→     */\n   685→    public function gestionarContinuidadAplicante(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, int $puntaje, string $llave_puntajes_bajos, string $llave_puntajes_medios, bool $escala_pruebas_psicometricas = false) {\n   686→        if ($etapa_usuario->vacante->automatizar_etapas) {\n   687→            $calificacion_baja  = 40;\n   688→            $calificacion_media = 70;\n   689→\n   690→            if ($escala_pruebas_psicometricas) {\n   691→                $calificacion_baja  = 59;\n   692→                $calificacion_media = 75;\n   693→            }\n   694→\n   695→            // Obtener el movimiento de la etapa con sus configuraciones\n   696→            $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n   697→                'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n   698→                'movimiento_vacante_id'   => $movimiento_vacante_id,\n   699→                'incluir_configuraciones' => true\n   700→            ]));\n   701→\n   702→            $configuracion_adecuaciones_bajas  = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_bajos)->first();\n   703→            $configuracion_adecuaciones_medias = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_medios)->first();\n   704→\n   705→            if (!is_null($configuracion_adecuaciones_medias) && filter_var($configuracion_adecuaciones_medias->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_media) {\n   706→                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n   707→                return;\n   708→            } elseif (!is_null($configuracion_adecuaciones_bajas) && filter_var($configuracion_adecuaciones_bajas->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_baja) {\n   709→                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n   710→                return;\n   711→            }\n   712→\n   713→            $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje);\n   714→        } else {\n   715→            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n   716→        }\n   717→    }\n   718→\n   719→    /**\n   720→     * Guardar puntaje de la etapa actual y mover al aplicante a la siguiente etapa.\n   721→     *\n   722→     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n   723→     * @param ?int $puntaje Puntaje obtenido en la etapa actual.\n   724→     * @param ?int $puntaje_ia Puntaje obtenido por la IA en la etapa actual.\n   725→     * @param ?string $notas_ia Notas dadas por la IA para la etapa actual.\n   726→     * @param bool $descartar Indica si la etapa a la que se debe cambiar es 'descartados'.\n   727→     * @return void\n   728→     * @author Daniel Beltrán\n   729→     * @author Andres Gonzalez\n   730→     */\n   731→    public function guardarPuntajeYCambiarDeEtapa(EtapaVacanteUsuario $etapa_usuario, ?int $puntaje = null, ?int $puntaje_ia = null, ?string $notas_ia = null, bool $descartar = false): void {\n   732→        if ($descartar) {\n   733→            $etapa_siguiente = $this->etapa_vacante_repositorio->getUnoAvanzado(new Request(['vacante_id' => $etapa_usuario->vacante->id, 'nombre' => EtapaVacante::DESCARTADOS_NOMBRE]));\n   734→        } else {\n   735→            $etapa_siguiente = $this->etapa_vacante_repositorio->obtenerEtapaSiguiente($etapa_usuario->vacante->id, $etapa_usuario->etapa->orden);\n   736→        }\n   737→\n   738→        $etapa_actual_activa = true;\n   739→\n   740→        if ($etapa_siguiente->nombre !== EtapaVacante::CONTRATADOS_NOMBRE) {\n   741→            $etapa_actual_activa = false;\n   742→            $nueva_etapa_usuario = $this->repositorio->crear([\n   743→                'usuario_id'       => $etapa_usuario->usuario_id,\n   744→                'etapa_vacante_id' => $etapa_siguiente->id,\n   745→                'activo'           => true\n   746→            ]);\n   747→\n   748→            // Crear agendas de pruebas psicométricas si la etapa siguiente son pruebas psicométricas.\n   749→            app(VacanteService::class)->crearAgendasPruebasPsicometricas($etapa_usuario, $etapa_siguiente->id);\n   750→\n   751→            if ($nueva_etapa_usuario) {\n   752→                $this->notificarCambioEtapa($nueva_etapa_usuario);\n   753→            }\n   754→        }\n   755→\n   756→        $this->repositorio->actualizar($etapa_usuario->id, [\n   757→            'puntaje'    => $puntaje,\n   758→            'puntaje_ia' => $puntaje_ia,\n   759→            'notas_ia'   => $notas_ia,\n   760→            'activo'     => $etapa_actual_activa\n   761→        ]);\n   762→\n   763→        // Cuando la etapa es contratado, se valida si ya se han completado las vacantes requeridas para cerrar la vacante\n   764→        if ($etapa_siguiente->nombre === EtapaVacante::CONTRATADOS_NOMBRE) {\n   765→            if ($etapa_usuario->vacante->cantidad_vacantes === $this->repositorio->contarContratados($etapa_usuario->etapa->vacante_id)) {\n   766→                $this->vacante_repositorio->actualizar($etapa_usuario->etapa->vacante_id, ['estado_id' => EstadoVacante::COMPLETADA_ID]);\n   767→\n   768→                $aplicantes_activos_restantes_ids = $this->repositorio->getTodo(new Request([\n   769→                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n   770→                    'activo'                 => true,\n   771→                    'excluir_etapas'         => [EtapaVacante::DESCARTADOS_NOMBRE, EtapaVacante::CONTRATADOS_NOMBRE]\n   772→                ]))->pluck('id')->toArray();\n   773→\n   774→                // Descartar a los aplicantes que quedan activos en la vacante\n   775→                $this->descartarAplicantesManual($aplicantes_activos_restantes_ids);\n   776→\n   777→                $aplicantes_activos_sin_notificar = $this->repositorio->getTodo(new Request([\n   778→                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n   779→                    'activo'                 => true,\n   780→                    'sin_fecha_notificacion' => true\n   781→                ]));\n   782→\n   783→                foreach ($aplicantes_activos_sin_notificar as $aplicante) {\n   784→                    $this->notificarCambioEtapa($aplicante, false);\n   785→                }\n   786→            }\n   787→        }\n   788→    }\n   789→\n   790→    /**\n   791→     * Obtener la adecuación actual del usuario en la vacante.\n   792→     *\n   793→     * @param int $usuario_id ID del usuario.\n   794→     * @param int $vacante_id ID de la vacante.\n   795→     * @return ?int\n   796→     * @author Daniel Beltrán\n   797→     * @author Andres Gonzalez\n   798→     */\n   799→    public function obtenerAdecuacionUsuario(int $usuario_id, int $vacante_id): ?int {\n   800→        $etapas     = $this->repositorio->obtenerEtapasCompletadasUsuario($usuario_id, $vacante_id);\n   801→        $adecuacion = 0;\n   802→\n   803→        foreach ($etapas as $etapa) {\n   804→            if (!is_null($etapa->puntaje)) {\n   805→                $adecuacion += $etapa->puntaje;\n   806→            } elseif (is_null($etapa->puntaje) && !is_null($etapa->puntaje_ia)) {\n   807→                $adecuacion += $etapa->puntaje_ia;\n   808→            }\n   809→        }\n   810→\n   811→        return ($etapas->count() > 0) ? $adecuacion / $etapas->count() : null;\n   812→    }\n   813→\n   814→    /**\n   815→     * Verificar si una etapa ya ha sido completada por el aplicante.\n   816→     *\n   817→     * @param int $id ID de la etapa del usuario en la vacante (etapa_vacante_usuario_id).\n   818→     * @return bool\n   819→     * @author Daniel Beltrán\n   820→     * @author Andres Gonzalez\n   821→     */\n   822→    public function verificarEtapaCompletada(int $id): bool {\n   823→        $etapa_usuario    = $this->repositorio->getUno($id);\n   824→        $etapa_completada = false;\n   825→\n   826→        // Verificar si la etapa de revisión de hoja de vida ya fue completada\n   827→        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::REVISION_HV_NOMBRE, EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE]) && !is_null($etapa_usuario->puntaje) || !is_null($etapa_usuario->puntaje_ia)) {\n   828→            $etapa_completada = true;\n   829→        }\n   830→\n   831→        if ($etapa_usuario->etapa->nombre === EtapaVacante::ENTREVISTA_NOMBRE) {\n   832→            if ($this->configuracion_modelo_servicio->obtenerValorLlaveConfiguracion(app(VacanteService::class)->obtenerConfiguracionesEtapaAplicante($etapa_usuario->etapa_vacante_id), 'solicitar_formato_entrevista')) {\n   833→                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n   834→\n   835→                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n   836→                    $etapa_completada = true;\n   837→                }\n   838→            } else {\n   839→                $etapa_completada = true;\n   840→            }\n   841→        }\n   842→\n   843→        // Verificar si las etapas de preguntas prefiltro o videoentrevista ya han sido completadas\n   844→        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE])) {\n   845→            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n   846→                'etapa_vacante_id'                      => $etapa_usuario->etapa_vacante_id,\n   847→                'usuario_id'                            => $etapa_usuario->usuario_id,\n   848→                'incluir_cantidad_respuestas_aplicante' => true\n   849→            ]));\n   850→\n   851→            $preguntas_contestadas = 0;\n   852→\n   853→            foreach ($preguntas as $pregunta) {\n   854→                if ($pregunta['respuestas_count'] > 0) {\n   855→                    $preguntas_contestadas++;\n   856→                }\n   857→            }\n   858→\n   859→            // Validar que todas las preguntas hayan sido contestadas\n   860→            if (count($preguntas) === $preguntas_contestadas) {\n   861→                $etapa_completada = true;\n   862→            }\n   863→        }\n   864→\n   865→        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n   866→            if ((!is_null($etapa_usuario->pruebaTecnica?->enlace) && !empty($etapa_usuario->pruebaTecnica?->enlace) || $etapa_usuario->pruebaTecnica?->archivos->count() > 0) && $etapa_usuario->pruebaTecnica?->borrador == false) {\n   867→                $etapa_completada = true;\n   868→            }\n   869→        }\n   870→\n   871→        if ($etapa_usuario->etapa->nombre === EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE) {\n   872→            $documentos_contratacion = app(EtapaVacanteService::class)->obtenerDocumentosContratacion(\n   873→                $etapa_usuario->etapa_vacante_id,\n   874→                new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id])\n   875→            );\n   876→\n   877→            $documentos_solicitados     = collect($documentos_contratacion['documentos']);\n   878→            $archivos_guardados         = collect($documentos_contratacion['archivos_guardados']);\n   879→            $archivos_guardados_nombres = $archivos_guardados->pluck('nombre')->toArray();\n   880→\n   881→            $todos_cargados = true;\n   882→            foreach ($documentos_solicitados as $documento) {\n   883→                $nombre_normalizado = $this->normalizarNombreDocumento($documento['nombre']);\n   884→\n   885→                if (!in_array($nombre_normalizado, $archivos_guardados_nombres)) {\n   886→                    $todos_cargados = false;\n   887→                    break;\n   888→                }\n   889→            }\n   890→\n   891→            if ($todos_cargados && $documentos_solicitados->count() > 0) {\n   892→                $etapa_completada = true;\n   893→            }\n   894→        }\n   895→\n   896→        return $etapa_completada;\n   897→    }\n   898→\n   899→    /**\n   900→     * Notificar documentos solicitados.\n   901→     *\n   902→     * @param int $id ID de la etapa del usuario en la vacante.\n   903→     * @return void\n   904→     * @author Andres Gonzalez\n   905→     * @author Jair Carvajal\n   906→     * @author Daniel Beltrán\n   907→     */\n   908→    public function notificarDocumentosSolicitados(int $id): void {\n   909→        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n   910→\n   911→        if ($etapa_vacante_usuario) {\n   912→            $this->enviarCorreoFinalizacionEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->vacante);\n   913→        }\n   914→    }\n   915→\n   916→    /**\n   917→     * Descartar uno o varios aplicantes manualmente y moverlos a la etapa de descartados.\n   918→     *\n   919→     * @param array $ids IDs de las etapas de usuarios en la vacante.\n   920→     * @return void\n   921→     * @author Andres Gonzalez\n   922→     * @author Daniel Beltrán\n   923→     */\n   924→    public function descartarAplicantesManual(array $ids): void {\n   925→        foreach ($ids as $id) {\n   926→            $etapa_vacante_usuario = $this->repositorio->getUno($id);\n   927→\n   928→            if ($etapa_vacante_usuario) {\n   929→                $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n   930→            }\n   931→        }\n   932→    }\n   933→\n   934→    /**\n   935→     * Revertir descarte de aplicantes.\n   936→     *\n   937→     * @param array $ids IDs de las etapas de los usuarios descartados en la vacante.\n   938→     * @return void\n   939→     * @author Andres Gonzalez\n   940→     */\n   941→    public function revertirDescarteAplicantes(array $ids): void {\n   942→        foreach ($ids as $id) {\n   943→            $etapa_descartado = $this->repositorio->getUno($id);\n   944→\n   945→            if ($etapa_descartado && $etapa_descartado->etapa->nombre === EtapaVacante::DESCARTADOS_NOMBRE && $etapa_descartado->activo) {\n   946→                $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $etapa_descartado->vacante->id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n   947→                $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n   948→                $etapa_previa          = $this->repositorio->obtenerEtapaPrevia($etapa_descartado->usuario_id, $etapas_ids);\n   949→\n   950→                if ($etapa_previa) {\n   951→                    $this->repositorio->eliminar($etapa_descartado->id);\n   952→                    $this->repositorio->actualizar($etapa_previa->id, ['activo' => true]);\n   953→                }\n   954→            }\n   955→        }\n   956→    }\n   957→\n   958→    /**\n   959→     * Mover manualmente al aplicante a la siguiente etapa.\n   960→     *\n   961→     * @param int $id ID de la etapa del usuario en la vacante.\n   962→     * @return void\n   963→     * @author Andres Gonzalez\n   964→     * @author Daniel Beltrán\n   965→     */\n   966→    public function moverAplicanteEtapaManual(int $id): void {\n   967→        $etapa_usuario = $this->repositorio->getUno($id);\n   968→        $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $etapa_usuario->puntaje ?? 0);\n   969→    }\n   970→\n   971→    /**\n   972→     * Marcar la vacante como abandonada por el aplicante.\n   973→     *\n   974→     * @param Request $request Contenido de la petición.\n   975→     * @return void\n   976→     * @author Andres Gonzalez\n   977→     * @author Daniel Beltrán\n   978→     */\n   979→    public function abandonarVacante(Request $request): void {\n   980→        $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $request->vacante_id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n   981→        $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n   982→        $etapa_vacante_usuario = $this->repositorio->obtenerEtapaPrevia($request->usuario_id, $etapas_ids);\n   983→\n   984→        if ($etapa_vacante_usuario) {\n   985→            $this->repositorio->actualizar($etapa_vacante_usuario->id, ['motivo_abandono' => $request->motivo_abandono]);\n   986→            $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n   987→        }\n   988→    }\n   989→\n   990→    /**\n   991→     * Notificar al aplicante sobre el cambio de etapa.\n   992→     *\n   993→     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n   994→     * @param bool $aplicar_validacion_fin_proceso Indica si se debe aplicar la validación de fin de proceso.\n   995→     * @return void\n   996→     * @author Andres Gonzalez\n   997→     */\n   998→    public function notificarCambioEtapa(EtapaVacanteUsuario $etapa_usuario, bool $aplicar_validacion_fin_proceso = true): void {\n   999→        $etapa_usuario->load(['etapa', 'vacante', 'usuario']);\n  1000→        $etapa = $etapa_usuario->etapa;\n  1001→\n  1002→        $plantilla_correo_id = [\n  1003→            EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE     => PlantillaCorreo::PREGUNTAS_PRE_FILTRO_ID,\n  1004→            EtapaVacante::PRUEBA_TECNICA_NOMBRE          => PlantillaCorreo::ENVIO_PRUEBA_TECNICA_ID,\n  1005→            EtapaVacante::VIDEO_ENTREVISTA_NOMBRE        => PlantillaCorreo::SOLICITUD_VIDEOENTREVISTAS_ID,\n  1006→            EtapaVacante::ENTREVISTA_NOMBRE              => PlantillaCorreo::NOTIFICACION_ENTREVISTA_ID,\n  1007→            EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE => PlantillaCorreo::SOLICITUD_DOCUMENTOS_ID,\n  1008→            EtapaVacante::CONTRATADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_CONTRATADOS_ID,\n  1009→            EtapaVacante::DESCARTADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_DESCARTADOS_ID\n  1010→        ][$etapa->nombre] ?? null;\n  1011→\n  1012→        if (isset($plantilla_correo_id)) {\n  1013→            $plantilla_correo_etapa = $this->plantilla_correo_servicio->obtenerUno(new Request([\n  1014→                'plantilla_correo_id' => $plantilla_correo_id,\n  1015→                'empresa_id'          => $etapa_usuario->vacante->empresa_id\n  1016→            ]));\n  1017→\n  1018→            if (!is_null($plantilla_correo_etapa)) {\n  1019→                $es_etapa_fin_proceso = in_array($etapa->nombre, [\n  1020→                    EtapaVacante::CONTRATADOS_NOMBRE,\n  1021→                    EtapaVacante::DESCARTADOS_NOMBRE\n  1022→                ]);\n  1023→\n  1024→                // Si es etapa de fin de proceso y notificar_fin_proceso es true, no enviar notificación\n  1025→                if ($aplicar_validacion_fin_proceso && $es_etapa_fin_proceso && $plantilla_correo_etapa->notificar_fin_proceso) {\n  1026→                    return;\n  1027→                }\n  1028→\n  1029→                $usuario            = $etapa_usuario->usuario;\n  1030→                $vacante            = $etapa_usuario->vacante;\n  1031→                $token_acceso       = $this->token_acceso_servicio->generar($usuario->id);\n  1032→                $enlace             = request()->getSchemeAndHttpHost() . \"/control-acceso/{$token_acceso->token}?vacante_id={$vacante->id}\";\n  1033→                $usuario_informador = null;\n  1034→\n  1035→                Mail::to($usuario->email)->queue(new NotificarPostulanteVacanteMail(\n  1036→                    $usuario,\n  1037→                    $enlace,\n  1038→                    $vacante,\n  1039→                    $plantilla_correo_etapa->titulo,\n  1040→                    $plantilla_correo_etapa->contenido,\n  1041→                    $plantilla_correo_etapa->con_logo_empresa,\n  1042→                    $etapa->nombre,\n  1043→                    $usuario_informador\n  1044→                ));\n  1045→\n  1046→                // Enviar notificación de avance en el proceso\n  1047→                $usuario->notify(new NotificarAvanceProcesoNotification(\n  1048→                    $vacante->id,\n  1049→                    $vacante->nombre_vacante,\n  1050→                    $etapa->nombre,\n  1051→                    $vacante->empresa->nombre ?? 'la empresa'\n  1052→                ));\n  1053→\n  1054→                $this->repositorio->actualizar($etapa_usuario->id, ['fecha_notificacion' => now()]);\n  1055→            }\n  1056→        }\n  1057→    }\n  1058→\n  1059→    /**\n  1060→     * Enviar correo de notificación al finalizar una etapa.\n  1061→     *\n  1062→     * @param EtapaVacanteUsuario $etapa_vacante_usuario Etapa del usuario en la vacante.\n  1063→     * @param Vacante $vacante Vacante.\n  1064→     * @return void\n  1065→     * @author Jair Carvajal\n  1066→     */\n  1067→    private function enviarCorreoFinalizacionEtapa(EtapaVacanteUsuario $etapa_vacante_usuario, Vacante $vacante): void {\n  1068→        $usuario     = Auth::user();\n  1069→        $maneja_logo = file_exists(public_path('empresas-logo/' . $vacante->empresa->id)) ? '1' : null;\n  1070→\n  1071→        Mail::send(new NotificarFinalizacionEtapaMail(\n  1072→            $usuario,\n  1073→            $vacante,\n  1074→            $etapa_vacante_usuario->etapa,\n  1075→            $maneja_logo\n  1076→        ));\n  1077→    }\n  1078→\n  1079→    /**\n  1080→     * Obtener candidatos recomendados con IA.\n  1081→     *\n  1082→     * Obtiene los 3 mejores candidatos para la vacante, entre varios candidatos seleccionados por el reclutador.\n  1083→     *\n  1084→     * @param Request $request Contenido de la petición.\n  1085→     * @return void\n  1086→     * @author Daniel Beltrán\n  1087→     */\n  1088→    public function obtenerCandidatosRecomendadosIA(Request $request): array {\n  1089→        $vacante       = $this->vacante_repositorio->getUno($request->vacante_id);\n  1090→        $candidatos    = $this->usuario_repositorio->obtenerCandidatosSeleccionadosVacante($request->usuarios_ids, $request->vacante_id);\n  1091→        $candidatos_ia = [];\n  1092→        $vacante_ia    = [\n  1093→            ...Arr::only($vacante->toArray(), ['nombre_vacante', 'salario', 'salario_maximo']),\n  1094→            'habilidades'               => $vacante->datos->first(fn($item) => $item->llave === 'habilidades')->valor,\n  1095→            'herramientas_tecnologicas' => $vacante->datos->first(fn($item) => $item->llave === 'herramientas_tecnologicas')->valor,\n  1096→            'experiencia_laboral'       => $vacante->datos->first(fn($item) => $item->llave === 'experiencia_laboral')->valor,\n  1097→            'nivel_educativo'           => $vacante->datos->first(fn($item) => $item->llave === 'nivel_educativo')->valor\n  1098→        ];\n  1099→\n  1100→        if (!is_null($vacante->ciudad_id)) {\n  1101→            $direccion_trabajo = $vacante->datos->first(fn($item) => $item->llave === 'direccion_trabajo')->valor;\n  1102→            $ubicacion_empresa = \"{$vacante->ciudad->departamento->pais->nombre}, {$vacante->ciudad->departamento->nombre} - {$vacante->ciudad->nombre}, {$direccion_trabajo}\";\n  1103→        } elseif (!is_null($vacante->empresa->ciudad_id)) {\n  1104→            $ubicacion_empresa = \"{$vacante->empresa->ciudad->departamento->pais->nombre}, {$vacante->empresa->ciudad->departamento->nombre} - {$vacante->empresa->ciudad->nombre}, {$vacante->empresa->direccion}\";\n  1105→        }\n  1106→\n  1107→        if (isset($ubicacion_empresa)) {\n  1108→            $vacante_ia['ubicacion'] = $ubicacion_empresa;\n  1109→        }\n  1110→\n  1111→        foreach ($candidatos as $candidato) {\n  1112→            if (!is_null($candidato->ciudad_id) && !is_null($candidato->direccion)) {\n  1113→                $ubicacion = \"{$candidato->ciudad->departamento->pais->nombre}, {$candidato->ciudad->departamento->nombre} - {$candidato->ciudad->nombre}, {$candidato->direccion}\";\n  1114→            }\n  1115→\n  1116→            $usuario = [\n  1117→                ...Arr::only($candidato->toArray(), ['id', 'nombre_completo', 'email', 'telefono', 'edad']),\n  1118→                'adecuacion' => $this->obtenerAdecuacionUsuario($candidato->id, $request->vacante_id)\n  1119→            ];\n  1120→\n  1121→            if (isset($ubicacion)) {\n  1122→                $usuario['ubicacion'] = $ubicacion;\n  1123→            }\n  1124→\n  1125→            if (!is_null($candidato->perfilLaboral)) {\n  1126→                $usuario['salario']                   = $candidato->perfilLaboral->salario;\n  1127→                $usuario['salario_maximo']            = $candidato->perfilLaboral->salario_maximo;\n  1128→                $usuario['habilidades']               = $candidato->perfilLaboral->habilidades;\n  1129→                $usuario['herramientas_tecnologicas'] = $candidato->perfilLaboral->herramientas_tecnologicas;\n  1130→                $usuario['estudios']                  = [];\n  1131→                $usuario['experiencias_laborales']    = [];\n  1132→                $usuario['idiomas']                   = [];\n  1133→                $usuario['etapas']                    = [];\n  1134→\n  1135→                foreach ($candidato->perfilLaboral->estudios as $item) {\n  1136→                    array_push($usuario['estudios'], [\n  1137→                        ...Arr::only($item->toArray(), ['titulo', 'fecha_inicio', 'fecha_fin']),\n  1138→                        'nivel_educativo' => $item->nivelEducativo->nombre,\n  1139→                    ]);\n  1140→                }\n  1141→\n  1142→                foreach ($candidato->perfilLaboral->experienciasLaborales as $item) {\n  1143→                    array_push($usuario['experiencias_laborales'], [...Arr::only($item->toArray(), ['empresa', 'cargo', 'fecha_inicio', 'fecha_fin', 'tiempo'])]);\n  1144→                }\n  1145→\n  1146→                foreach ($candidato->perfilLaboral->idiomas as $item) {\n  1147→                    array_push($usuario['idiomas'], [\n  1148→                        'idioma' => $item->idioma->nombre,\n  1149→                        'nivel'  => $item->nivel\n  1150→                    ]);\n  1151→                }\n  1152→\n  1153→                foreach ($candidato->etapasUsuarios as $item) {\n  1154→                    $datos_etapas = [\n  1155→                        'nombre'      => $item->etapa->nombre,\n  1156→                        'puntaje'     => $item->puntaje,\n  1157→                        'puntaje_ia'  => $item->puntaje_ia,\n  1158→                        'comentarios' => $item->comentarios->pluck('comentario')->values()->toArray()\n  1159→                    ];\n  1160→\n  1161→                    if ($item->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE) {\n  1162→                        $agendas = $this->agenda_repositorio->getTodo(new Request([\n  1163→                            'proceso_id'         => $vacante->proceso->id,\n  1164→                            'evaluado_id'        => $item->usuario_id,\n  1165→                            'estado_id'          => EstadoAgenda::FINALIZADA_ID,\n  1166→                            'incluir_resultados' => true\n  1167→                        ]));\n  1168→\n  1169→                        $datos_etapas['pruebas_psicometricas'] = [];\n  1170→\n  1171→                        foreach ($agendas as $agenda) {\n  1172→                            array_push($datos_etapas['pruebas_psicometricas'], [\n  1173→                                'prueba'     => $agenda->prueba->nombre,\n  1174→                                'ajuste'     => $agenda->ajuste,\n  1175→                                'resultados' => $agenda->resultados->map(function ($resultado) {\n  1176→                                    return [\n  1177→                                        'dimension' => $resultado->dimension->nombre,\n  1178→                                        'puntaje'   => $resultado->puntaje_transformado\n  1179→                                    ];\n  1180→                                })->values()->toArray()\n  1181→                            ]);\n  1182→                        }\n  1183→\n  1184→                        if (count($datos_etapas['pruebas_psicometricas']) === 0) {\n  1185→                            unset($datos_etapas['pruebas_psicometricas']);\n  1186→                        }\n  1187→                    }\n  1188→\n  1189→                    array_push($usuario['etapas'], $datos_etapas);\n  1190→                }\n  1191→            }\n  1192→\n  1193→            array_push($candidatos_ia, $usuario);\n  1194→        }\n  1195→\n  1196→        return $this->realizarPeticionIA('obtener-candidatos-recomendados', [\n  1197→            'vacante_id' => $request->vacante_id,\n  1198→            'vacante'    => json_encode($vacante_ia, JSON_UNESCAPED_UNICODE),\n  1199→            'candidatos' => json_encode($candidatos_ia, JSON_UNESCAPED_UNICODE)\n  1200→        ]);\n  1201→    }\n  1202→\n  1203→    /**\n  1204→     * Obtener competencias por mejorar para usuario que será contratado.\n  1205→     * SOLO Buscar agendas de TenDisc Plus (12) y Potencial Comercial (7)\n  1206→     * @param int $id ID de la etapa del usuario en la vacante.\n  1207→     * @return array\n  1208→     * @author Sergio Vargas\n  1209→     */\n  1210→    public function obtenerCompetenciasPorMejorar(int $id): array {\n  1211→        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n  1212→        $usuario_id = $etapa_vacante_usuario->usuario_id;\n  1213→        $proceso = $etapa_vacante_usuario->vacante->proceso;\n  1214→\n  1215→        if (is_null($proceso)) {\n  1216→            return ['pruebas' => []];\n  1217→        }\n  1218→\n  1219→        $agendas = $this->agenda_repositorio->getTodo(new Request([\n  1220→            'proceso_id' => $proceso->id,\n  1221→            'evaluado_id' => $usuario_id,\n  1222→            'pruebas_ids' => [12, 7],\n  1223→            'estado_id' => 3,\n  1224→            'con_evaluado' => true\n  1225→        ]));\n  1226→\n  1227→        $resultado = ['pruebas' => []];\n  1228→\n  1229→        foreach ($agendas as $agenda) {\n  1230→            $competencias_bajas = $this->extraerCompetenciasBajas($agenda);\n  1231→\n  1232→            if (!empty($competencias_bajas)) {\n  1233→                $resultado['pruebas'][] = [\n  1234→                    'prueba_id' => $agenda->prueba_id,\n  1235→                    'nombre_prueba' => $agenda->prueba->nombre,\n  1236→                    'competencias' => $competencias_bajas\n  1237→                ];\n  1238→            }\n  1239→        }\n  1240→\n  1241→        return $resultado;\n  1242→    }\n  1243→\n  1244→    /**\n  1245→     * Extraer las 2 competencias más bajas de una agenda según su prueba.\n  1246→     *\n  1247→     * @param \\App\\Models\\Agendas\\Agenda $agenda Agenda finalizada.\n  1248→     * @return array\n  1249→     * @author Sergio Vargas\n  1250→     */\n  1251→    private function extraerCompetenciasBajas($agenda): array {\n  1252→        $resultados = $this->resultado_agenda_servicio->gestionarResultados($agenda);\n  1253→\n  1254→        if (empty($resultados)) {\n  1255→            return [];\n  1256→        }\n  1257→\n  1258→        $competencias_todas = [];\n  1259→\n  1260→        // TenDisc Plus (prueba_id = 12)\n  1261→        if ($agenda->prueba_id === 12) {\n  1262→            $factor_especificas = collect($resultados)->firstWhere('nombre', 'Competencias Específicas');\n  1263→            $factor_transversales = collect($resultados)->firstWhere('nombre', 'Competencias Transversales');\n  1264→\n  1265→            if ($factor_especificas) {\n  1266→                $competencias_todas = array_merge($competencias_todas, $factor_especificas['dimensiones']);\n  1267→            }\n  1268→            if ($factor_transversales) {\n  1269→                $competencias_todas = array_merge($competencias_todas, $factor_transversales['dimensiones']);\n  1270→            }\n  1271→        }\n  1272→\n  1273→        // Potencial Comercial (prueba_id = 7)\n  1274→        if ($agenda->prueba_id === 7) {\n  1275→            $factor_caracter = collect($resultados)->firstWhere('nombre', 'Carácter');\n  1276→            $factor_habilidades = collect($resultados)->firstWhere('nombre', 'Habilidades');\n  1277→\n  1278→            if ($factor_caracter) {\n  1279→                $competencias_todas = array_merge($competencias_todas, $factor_caracter['dimensiones']);\n  1280→            }\n  1281→            if ($factor_habilidades) {\n  1282→                $competencias_todas = array_merge($competencias_todas, $factor_habilidades['dimensiones']);\n  1283→            }\n  1284→        }\n  1285→\n  1286→        // Ordenar por puntaje ascendente y tomar las 2 más bajas\n  1287→        return collect($competencias_todas)\n  1288→            ->sortBy('puntaje_transformado')\n  1289→            ->take(2)\n  1290→            ->map(fn($c) => [\n  1291→                'nombre' => $c['nombre'],\n  1292→                'puntaje' => round($c['puntaje_transformado'], 0)\n  1293→            ])\n  1294→            ->values()\n  1295→            ->toArray();\n  1296→    }\n  1297→}\n  1298→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"be7c384f-3c97-4d51-aac3-01fdbd427864","timestamp":"2026-01-08T16:00:02.692Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Vacantes;\n\nuse App\\Traits\\IATrait;\nuse App\\Traits\\StringTrait;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Vacantes\\Vacante;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Agendas\\EstadoAgenda;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Support\\Facades\\Mail;\nuse App\\Models\\Vacantes\\EtapaVacante;\nuse App\\Models\\Vacantes\\EstadoVacante;\nuse App\\Models\\Vacantes\\MovimientoVacante;\nuse App\\Mail\\NotificarFinalizacionEtapaMail;\nuse App\\Mail\\NotificarPostulanteVacanteMail;\nuse App\\Models\\Vacantes\\EtapaVacanteUsuario;\nuse Illuminate\\Http\\Client\\RequestException;\nuse App\\Http\\Services\\Vacantes\\VacanteService;\nuse App\\Models\\Configuraciones\\PlantillaCorreo;\nuse Illuminate\\Http\\Client\\ConnectionException;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Services\\Usuarios\\TokenAccesoService;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Services\\Vacantes\\EtapaVacanteService;\nuse App\\Jobs\\Vacantes\\ProcesarVideoentrevistaIAJob;\nuse App\\Http\\Repositories\\Procesos\\ProcesoRepository;\nuse App\\Http\\Repositories\\Vacantes\\VacanteRepository;\nuse App\\Http\\Services\\Agendas\\ResultadoAgendaService;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse App\\Notifications\\NotificarAvanceProcesoNotification;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteRepository;\nuse App\\Http\\Repositories\\Vacantes\\TranscripcionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Vacantes\\AspectoPuntajeRepository;\nuse App\\Http\\Services\\Configuraciones\\PlantillaCorreoService;\nuse App\\Http\\Repositories\\Vacantes\\FormatoEntrevistaRepository;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteUsuarioRepository;\nuse App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\nuse App\\Http\\Repositories\\Vacantes\\EtapaMovimientoVacanteRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PreguntaOfertaLaboralRepository;\nuse App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PuntajePreguntaOfertaLaboralRepository;\n\n/**\n * @property EtapaVacanteUsuarioRepository $repositorio\n */\nclass EtapaVacanteUsuarioService extends BaseService\n{\n    use ArchivoTrait, IATrait, StringTrait;\n\n    /**\n     * @var float|int $puntaje_total Puntaje total, utilizado para la adecuación de HV.\n     */\n    private $puntaje_total = 0;\n\n    /**\n     * @var float $puntaje Puntaje de aspecto, utilizado para la adecuación de HV.\n     */\n    private $puntaje = 0;\n\n    /**\n     * @var bool $cumple Indica si cumple con el aspecto, utilizada para la adecuación de HV.\n     */\n    private $cumple = false;\n\n    /**\n     * Constructor.\n     *\n     * @param EtapaVacanteUsuarioRepository $repositorio Repositorio de etapas de vacantes de usuarios.\n     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n     * @param EtapaVacanteRepository $etapa_vacante_repositorio Repositorio de etapas de vacantes.\n     * @param AspectoPuntajeRepository $aspecto_puntaje_repositorio Repositorio de puntajes de aspectos.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio Repositorio de preguntas de ofertas laborales.\n     * @param PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio Repositorio de puntajes de preguntas de ofertas laborales.\n     * @param EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio Repositorio de movimientos de etapas de vacantes.\n     * @param ProcesoRepository $proceso_repositorio Repositorio de procesos.\n     * @param TranscripcionRepository $transcripcion_repositorio Repositorio de transcripciones.\n     * @param PlantillaCorreoService $plantilla_correo_servicio Servicio de plantillas de correo.\n     * @param TokenAccesoService $token_acceso_servicio Servicio de tokens de acceso.\n     * @param UserRepository $usuario_repositorio Servicio de usuarios.\n     * @param VacanteRepository $vacante_repositorio Repositorio de vacantes.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param ResultadoAgendaService $resultado_agenda_servicio Servicio de resultados de agendas.\n     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n     * @param FormatoEntrevistaRepository $formato_entrevista_repositorio Repositorio de formatos de entrevista.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function __construct(\n        EtapaVacanteUsuarioRepository $repositorio,\n        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n        protected EtapaVacanteRepository $etapa_vacante_repositorio,\n        protected AspectoPuntajeRepository $aspecto_puntaje_repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio,\n        protected PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio,\n        protected EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio,\n        protected ProcesoRepository $proceso_repositorio,\n        protected TranscripcionRepository $transcripcion_repositorio,\n        protected PlantillaCorreoService $plantilla_correo_servicio,\n        protected TokenAccesoService $token_acceso_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected VacanteRepository $vacante_repositorio,\n        protected AgendaRepository $agenda_repositorio,\n        protected ResultadoAgendaService $resultado_agenda_servicio,\n        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n        protected FormatoEntrevistaRepository $formato_entrevista_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar documento solicitado de una etapa de vacante de usuario.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function guardarDocumentoSolicitado(Request $request): void {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n        if ($request->hasFile('archivo')) {\n            $this->archivo_servicio->guardarVarios(EtapaVacanteUsuario::class, $request->etapa_vacante_usuario_id, [$request->nombre_documento => $request->file('archivo')], 'empresas/' . $empresa->id . '/documentos-solicitados', true);\n        }\n    }\n\n    /**\n     * Establecer valores para puntaje y cumplimiento de un aspecto.\n     *\n     * @param float $puntaje Puntaje obtenido.\n     * @param bool $cumple Indica si cumple.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function establecerPuntajeCumplimiento(float $puntaje = 0, bool $cumple = false): void {\n        $this->puntaje = $puntaje;\n        $this->cumple  = $cumple;\n    }\n\n    /**\n     * Guardar puntaje de un aspecto evaluado.\n     *\n     * @param int $etapa_vacante_usuario_id ID de la etapa del usuario en la vacante.\n     * @param string $categoria Categoría del aspecto.\n     * @param string $aspecto Aspecto evaluado.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function guardarAspectoPuntaje(int $etapa_vacante_usuario_id, string $categoria, string $aspecto): void {\n        $this->aspecto_puntaje_repositorio->crearOActualizar([\n            'etapa_vacante_usuario_id' => $etapa_vacante_usuario_id,\n            'categoria'                => $categoria,\n            'aspecto'                  => $aspecto\n        ], [\n            'puntaje'                  => $this->puntaje,\n            'cumple'                   => $this->cumple\n        ]);\n\n        $this->puntaje_total += $this->puntaje;\n        $this->establecerPuntajeCumplimiento();\n    }\n\n    /**\n     * Generar adecuación de hoja de vida.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionHV(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::REVISION_HV_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $perfil_laboral = $this->perfil_laboral_repositorio->getUnoAvanzado(new Request([\n                'usuario_id'                     => $etapa_usuario->usuario_id,\n                'incluir_experiencias_laborales' => true,\n                'incluir_estudios'               => true,\n                'incluir_idiomas'                => true,\n                'incluir_usuario'                => true\n            ]));\n\n            // Generar y guardar la adecuación del perfil de candidato (habilidades y herramientas tecnológicas)\n            $categoria            = 'perfil';\n            $puntaje_aspecto      = 100 / 2;\n            $datos_vacante        = $etapa_usuario->vacante->datos;\n            $habilidades_vacante  = $datos_vacante->where('llave', 'habilidades')->first();\n            $herramientas_vacante = $datos_vacante->where('llave', 'herramientas_tecnologicas')->first();\n\n            // Validar coincidencia para las habilidades\n            if (!is_null($habilidades_vacante->valor) && !empty($habilidades_vacante->valor)) {\n                $habilidades_vacante        = array_map(fn($item) => trim($item), explode(',', $habilidades_vacante->valor));\n                $habilidades_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->habilidades));\n                $coincidencias              = count(array_uintersect($habilidades_vacante, $habilidades_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($habilidades_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'habilidades');\n\n            // Validar coincidencia para las herramientas tecnológicas\n            if (!is_null($herramientas_vacante->valor) && !empty($herramientas_vacante->valor)) {\n                $herramientas_vacante        = array_map(fn($item) => trim($item), explode(',', $herramientas_vacante->valor));\n                $herramientas_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->herramientas_tecnologicas));\n                $coincidencias               = count(array_uintersect($herramientas_vacante, $herramientas_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($herramientas_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'herramientas');\n\n            // Generar y guardar la adecuación de requisitos del candidato (género, edad, nivel educativo, modalidad de trabajo, salario, experiencia, idiomas, licencia de conducir)\n            $categoria       = 'requisito';\n            $puntaje_aspecto = 100 / 8;\n\n            // Validar coincidencia de género\n            $genero_vacante = $datos_vacante->where('llave', 'genero')->first();\n\n            if (!is_null($genero_vacante) && !empty($genero_vacante)) {\n                if ($genero_vacante->valor === mb_convert_case($perfil_laboral->usuario->genero->nombre, MB_CASE_LOWER)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                } elseif ($genero_vacante->valor === 'indiferente') {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'genero');\n\n            // Validar coincidencia de edad\n            $edad_minima_vacante = $datos_vacante->where('llave', 'edad_minima')->first();\n            $edad_maxima_vacante = $datos_vacante->where('llave', 'edad_maxima')->first();\n\n            if (empty($edad_minima_vacante->valor) || empty($edad_maxima_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($perfil_laboral->usuario->edad >= $edad_minima_vacante->valor && $perfil_laboral->usuario->edad <= $edad_maxima_vacante->valor) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'edad');\n\n            // Validar coincidencia de nivel educativo\n            $nivel_educativo_vacante = $datos_vacante->where('llave', 'nivel_educativo')->first();\n            $escala_estudios         = [\n                'Preescolar'                      => 1,\n                'Primaria'                        => 2,\n                'Secundaria básica'               => 3,\n                'Secundaria superior'             => 4,\n                'Educación continua y permanente' => 5,\n                'Técnico'                         => 6,\n                'Tecnólogo'                       => 7,\n                'Profesional'                     => 8,\n                'Especialización (postgrado)'     => 9,\n                'Maestría (postgrado)'            => 10,\n                'Doctorado (postgrado)'           => 11\n            ];\n\n            if (empty($nivel_educativo_vacante->valor) || $nivel_educativo_vacante->valor === 'indiferente') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (count($perfil_laboral->estudios) > 0) {\n                $cumple_nivel_educativo = false;\n\n                foreach ($perfil_laboral->estudios as $estudio) {\n                    if ($escala_estudios[$nivel_educativo_vacante->valor] <= $escala_estudios[$estudio->nivelEducativo->nombre]) {\n                        $cumple_nivel_educativo = true;\n                        break;\n                    }\n                }\n\n                if ($cumple_nivel_educativo) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'estudios');\n\n            // Validar coincidencia de modalidad de trabajo\n            if (!is_null($etapa_usuario->vacante->modalidad_trabajo_id)) {\n                if ($etapa_usuario->vacante->modalidad_trabajo_id === $perfil_laboral->modalidad_trabajo_id) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'modalidad_trabajo');\n\n            // Validar coincidencia de salario\n            if (is_null($etapa_usuario->vacante->salario)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (!is_null($etapa_usuario->vacante->salario) && is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Salario fijo\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario de la vacante es fijo pero el del usuario es rango\n                    if (($etapa_usuario->vacante->salario >= $perfil_laboral->salario && $etapa_usuario->vacante->salario <= $perfil_laboral->salario_maximo) || ($perfil_laboral->salario <= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } elseif ($perfil_laboral->salario <= $etapa_usuario->vacante->salario) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (!is_null($etapa_usuario->vacante->salario) && !is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Rango de salario\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario del usuario y de la vacante son rangos\n                    if (($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) || ($perfil_laboral->salario_maximo >= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario_maximo)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } else {\n                    if ($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'salario');\n\n            // Validar coincidencia de experiencia\n            $experiencia_vacante   = $datos_vacante->where('llave', 'experiencia_laboral')->first();\n            $experiencia_aplicante = $perfil_laboral->experienciasLaborales->sum('tiempo');\n            $experiencias          = [\n                '1 año'        => 1,\n                '2 años'       => 2,\n                '3 años'       => 3,\n                '4 años'       => 4,\n                '5 años o más' => 5\n            ];\n\n            if (empty($experiencia_vacante->valor) || $experiencia_vacante->valor === 'Sin experiencia') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($experiencia_vacante->valor === 'Menos de 1 año') {\n                if ($experiencia_aplicante > 0 && $experiencia_aplicante < 365) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (($experiencias[$experiencia_vacante->valor] * 365) <= $experiencia_aplicante) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'experiencia');\n\n            // Validar coincidencia de idiomas\n            $idiomas_vacante = $etapa_usuario->vacante->idiomas;\n            $escala_idiomas  = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'C1' => 5,\n                'C2' => 6\n            ];\n\n            if ($idiomas_vacante->count() > 0) {\n                $coincidencias_idiomas = 0;\n\n                if ($perfil_laboral->idiomas->count() > 0) {\n                    foreach ($idiomas_vacante as $idioma) {\n                        foreach ($perfil_laboral->idiomas as $idioma_perfil) {\n                            if ($idioma->idioma_id === $idioma_perfil->idioma_id && $escala_idiomas[$idioma->nivel] <= $escala_idiomas[$idioma_perfil->nivel]) {\n                                $coincidencias_idiomas++;\n                            }\n                        }\n                    }\n                }\n\n                if ($coincidencias_idiomas >= $idiomas_vacante->count()) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'idiomas');\n\n            // Validar coincidencia de licencia de conducir\n            $licencia_conducir_vacante = $datos_vacante->where('llave', 'licencia_conducir')->first();\n            $escala_licencias          = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'B3' => 5,\n                'C1' => 6,\n                'C2' => 7,\n                'C3' => 8\n            ];\n\n            if (empty($licencia_conducir_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (is_null($perfil_laboral->licencia_conducir)) {\n                if (empty($licencia_conducir_vacante->valor)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif ($escala_licencias[$licencia_conducir_vacante->valor] <= $escala_licencias[$perfil_laboral->licencia_conducir]) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'licencia_conducir');\n\n            $puntaje_total = round($this->puntaje_total / 2); // Se divide entre las dos categorías existentes\n            $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::REVISION_HV_ID, $puntaje_total, 'descartar_candidatos_adecuaciones_bajas_hv', 'descartar_candidatos_adecuaciones_medias_hv');\n        }\n    }\n\n    /**\n     * Generar adecuación para preguntas prefiltro.\n     *\n     * Califica las respuestas del aplicante en cada una de las preguntas y calcula la adecuación en base a sus resultados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPrefiltro(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'   => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'         => $etapa_usuario->usuario_id,\n                'incluir_respuestas' => true\n            ]));\n\n            $porcentaje_pregunta  = 100 / $preguntas->count();\n            $respuestas_correctas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                $puntaje    = null;\n                $puntaje_ia = null;\n\n                if ($pregunta->es_abierta) {\n                    $respuesta = $opcion_seleccionada = $pregunta->respuestas->first();\n\n                    if (!is_null($respuesta)) {\n                        try {\n                            $peticion_ia = $this->realizarPeticionIA(\n                                ruta: 'calificar-pregunta-abierta',\n                                parametros: [\n                                    'pregunta'  => $pregunta->enunciado,\n                                    'respuesta' => $respuesta->respuesta,\n                                ],\n                                contexto_tracking: [\n                                    'vacante_id' => $etapa_usuario->etapa->vacante_id ?? null,\n                                    'agenda_id' => null,\n                                ]\n                            );\n\n                            if (!is_null($peticion_ia) && $peticion_ia['status_code'] === 200) {\n                                $puntaje_ia = $peticion_ia['calificacion'];\n                            }\n                        } catch (RequestException|ConnectionException $error) {}\n                    }\n                } else {\n                    $opciones_correctas = $pregunta->opciones->where('es_correcta', true);\n\n                    // Selección única\n                    if ($opciones_correctas->count() === 1) {\n                        $opcion_correcta     = $opciones_correctas->first();\n                        $opcion_seleccionada = $pregunta->respuestas->first();\n                        $puntaje             = (int) (!is_null($opcion_seleccionada) && $opcion_correcta->id === $opcion_seleccionada->opcion_pregunta_id);\n                    } else { // Selección múltiple\n                        $opciones_correctas     = $opciones_correctas->pluck('id')->toArray();\n                        $opciones_seleccionadas = $pregunta->respuestas->pluck('opcion_pregunta_id')->toArray();\n                        $aciertos               = count(array_intersect($opciones_seleccionadas, $opciones_correctas));\n                        $fallos                 = count(array_diff($opciones_seleccionadas, $opciones_correctas));\n                        $puntaje                = (int) ($aciertos - $fallos === count($opciones_correctas));\n                    }\n                }\n\n                // Guardar el puntaje obtenido en cada pregunta\n                $this->puntaje_pregunta_oferta_laboral_repositorio->crearSiNoExiste([\n                    'pregunta_id' => $pregunta->id,\n                    'usuario_id'  => $etapa_usuario->usuario_id\n                ], [\n                    'puntaje'     => $puntaje,\n                    'puntaje_ia'  => $puntaje_ia\n                ]);\n\n                // Sumar el puntaje total\n                if (is_null($puntaje) && !is_null($puntaje_ia)) {\n                    $respuestas_correctas += $puntaje_ia;\n                } else {\n                    $respuestas_correctas += $puntaje;\n                }\n            }\n\n            $puntaje_etapa = $respuestas_correctas * $porcentaje_pregunta;\n\n            if ($etapa_usuario->vacante->automatizar_etapas) {\n                // Obtener el movimiento de la etapa con sus configuraciones\n                $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                    'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                    'movimiento_vacante_id'   => MovimientoVacante::PREGUNTAS_PREFILTRO_ID,\n                    'incluir_configuraciones' => true\n                ]));\n\n                $configuracion_preguntas_correctas = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', 'descartar_candidatos_respondieron_menos_preguntas_prefiltro')->first();\n\n                // Avanzar al aplicante de etapa o descartarlo según la configuración de la etapa\n                if (!is_null($configuracion_preguntas_correctas) && $configuracion_preguntas_correctas->valor <= $respuestas_correctas) {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa);\n                } else {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa, descartar: true);\n                }\n            } else {\n                $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_etapa]);\n            }\n        }\n    }\n\n    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n            }\n\n            if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::VIDEO_ENTREVISTA_NOMBRE, EtapaVacante::ENTREVISTA_NOMBRE])) {\n                if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE) {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_videoentrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_videoentrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_videoentrevista';\n                } else {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n                }\n\n                if ($this->verificarFormatoEntrevista($etapa_usuario, $movimiento_vacante_id, $llave_configuracion_formato)) {\n                    $this->gestionarContinuidadAplicante($etapa_usuario, $movimiento_vacante_id, $puntaje, $llave_configuracion_adecuaciones_bajas, $llave_configuracion_adecuaciones_medias);\n                } else {\n                    $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n                }\n\n                // TODO: Invocar esta función al momento de completar el formato de entrevista\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para pruebas psicométricas.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPruebasPsicometricas(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $indice_talento = $this->proceso_repositorio->obtenerIndiceTalento($etapa_usuario->vacante->proceso->id, $etapa_usuario->usuario_id)->indice_talento;\n\n            if ($indice_talento >= 0) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBAS_PSICOMETRICAS_ID, $indice_talento, 'descartar_candidatos_puntuaciones_bajas', 'descartar_candidatos_puntuaciones_medias', true);\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para videoentrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function generarAdecuacionVideoentrevista(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje_ia)) {\n            ProcesarVideoentrevistaIAJob::dispatch($etapa_usuario);\n        }\n    }\n\n    /**\n     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n     * @author Daniel Beltrán\n     */\n    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n        $formato_diligenciado = false;\n        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n            'movimiento_vacante_id'   => $movimiento_vacante_id,\n            'incluir_configuraciones' => true\n        ]));\n\n        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n        } else {\n            $formato_diligenciado = true;\n        }\n\n        return $formato_diligenciado;\n    }\n\n    /**\n     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n     *\n     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n     * @param int $usuario_id ID del usuario (aplicante).\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id' => $etapa_vacante_id,\n            'usuario_id'       => $usuario_id\n        ]));\n\n        if ($etapa_usuario->activo) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id' => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'       => $etapa_usuario->usuario_id,\n                'incluir_puntajes' => true\n            ]));\n\n            $puntaje            = 0;\n            $puntaje_individual = 100 / $preguntas->count();\n\n            foreach ($preguntas as $pregunta) {\n                if (is_null($pregunta->puntajes[0]->puntaje) && !is_null($pregunta->puntajes[0]->puntaje_ia)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje_ia;\n                } elseif (!is_null($pregunta->puntajes[0]->puntaje)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje;\n                }\n            }\n\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_individual * $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar el puntaje de la etapa actual y gestionar la continuidad del aplicante en la vacante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param int $puntaje Puntaje obtenido en la etapa actual.\n     * @param string $llave_puntajes_bajos Llave de configuración para puntajes bajos.\n     * @param string $llave_puntajes_medios Llave de configuración para puntajes medios.\n     * @param bool $escala_pruebas_psicometricas Indica si debe utilizar la escala de puntajes de pruebas psicométricas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function gestionarContinuidadAplicante(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, int $puntaje, string $llave_puntajes_bajos, string $llave_puntajes_medios, bool $escala_pruebas_psicometricas = false) {\n        if ($etapa_usuario->vacante->automatizar_etapas) {\n            $calificacion_baja  = 40;\n            $calificacion_media = 70;\n\n            if ($escala_pruebas_psicometricas) {\n                $calificacion_baja  = 59;\n                $calificacion_media = 75;\n            }\n\n            // Obtener el movimiento de la etapa con sus configuraciones\n            $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                'movimiento_vacante_id'   => $movimiento_vacante_id,\n                'incluir_configuraciones' => true\n            ]));\n\n            $configuracion_adecuaciones_bajas  = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_bajos)->first();\n            $configuracion_adecuaciones_medias = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_medios)->first();\n\n            if (!is_null($configuracion_adecuaciones_medias) && filter_var($configuracion_adecuaciones_medias->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_media) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            } elseif (!is_null($configuracion_adecuaciones_bajas) && filter_var($configuracion_adecuaciones_bajas->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_baja) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            }\n\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje);\n        } else {\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar puntaje de la etapa actual y mover al aplicante a la siguiente etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param ?int $puntaje Puntaje obtenido en la etapa actual.\n     * @param ?int $puntaje_ia Puntaje obtenido por la IA en la etapa actual.\n     * @param ?string $notas_ia Notas dadas por la IA para la etapa actual.\n     * @param bool $descartar Indica si la etapa a la que se debe cambiar es 'descartados'.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function guardarPuntajeYCambiarDeEtapa(EtapaVacanteUsuario $etapa_usuario, ?int $puntaje = null, ?int $puntaje_ia = null, ?string $notas_ia = null, bool $descartar = false): void {\n        if ($descartar) {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->getUnoAvanzado(new Request(['vacante_id' => $etapa_usuario->vacante->id, 'nombre' => EtapaVacante::DESCARTADOS_NOMBRE]));\n        } else {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->obtenerEtapaSiguiente($etapa_usuario->vacante->id, $etapa_usuario->etapa->orden);\n        }\n\n        $etapa_actual_activa = true;\n\n        if ($etapa_siguiente->nombre !== EtapaVacante::CONTRATADOS_NOMBRE) {\n            $etapa_actual_activa = false;\n            $nueva_etapa_usuario = $this->repositorio->crear([\n                'usuario_id'       => $etapa_usuario->usuario_id,\n                'etapa_vacante_id' => $etapa_siguiente->id,\n                'activo'           => true\n            ]);\n\n            // Crear agendas de pruebas psicométricas si la etapa siguiente son pruebas psicométricas.\n            app(VacanteService::class)->crearAgendasPruebasPsicometricas($etapa_usuario, $etapa_siguiente->id);\n\n            if ($nueva_etapa_usuario) {\n                $this->notificarCambioEtapa($nueva_etapa_usuario);\n            }\n        }\n\n        $this->repositorio->actualizar($etapa_usuario->id, [\n            'puntaje'    => $puntaje,\n            'puntaje_ia' => $puntaje_ia,\n            'notas_ia'   => $notas_ia,\n            'activo'     => $etapa_actual_activa\n        ]);\n\n        // Cuando la etapa es contratado, se valida si ya se han completado las vacantes requeridas para cerrar la vacante\n        if ($etapa_siguiente->nombre === EtapaVacante::CONTRATADOS_NOMBRE) {\n            if ($etapa_usuario->vacante->cantidad_vacantes === $this->repositorio->contarContratados($etapa_usuario->etapa->vacante_id)) {\n                $this->vacante_repositorio->actualizar($etapa_usuario->etapa->vacante_id, ['estado_id' => EstadoVacante::COMPLETADA_ID]);\n\n                $aplicantes_activos_restantes_ids = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'excluir_etapas'         => [EtapaVacante::DESCARTADOS_NOMBRE, EtapaVacante::CONTRATADOS_NOMBRE]\n                ]))->pluck('id')->toArray();\n\n                // Descartar a los aplicantes que quedan activos en la vacante\n                $this->descartarAplicantesManual($aplicantes_activos_restantes_ids);\n\n                $aplicantes_activos_sin_notificar = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'sin_fecha_notificacion' => true\n                ]));\n\n                foreach ($aplicantes_activos_sin_notificar as $aplicante) {\n                    $this->notificarCambioEtapa($aplicante, false);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener la adecuación actual del usuario en la vacante.\n     *\n     * @param int $usuario_id ID del usuario.\n     * @param int $vacante_id ID de la vacante.\n     * @return ?int\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function obtenerAdecuacionUsuario(int $usuario_id, int $vacante_id): ?int {\n        $etapas     = $this->repositorio->obtenerEtapasCompletadasUsuario($usuario_id, $vacante_id);\n        $adecuacion = 0;\n\n        foreach ($etapas as $etapa) {\n            if (!is_null($etapa->puntaje)) {\n                $adecuacion += $etapa->puntaje;\n            } elseif (is_null($etapa->puntaje) && !is_null($etapa->puntaje_ia)) {\n                $adecuacion += $etapa->puntaje_ia;\n            }\n        }\n\n        return ($etapas->count() > 0) ? $adecuacion / $etapas->count() : null;\n    }\n\n    /**\n     * Verificar si una etapa ya ha sido completada por el aplicante.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante (etapa_vacante_usuario_id).\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function verificarEtapaCompletada(int $id): bool {\n        $etapa_usuario    = $this->repositorio->getUno($id);\n        $etapa_completada = false;\n\n        // Verificar si la etapa de revisión de hoja de vida ya fue completada\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::REVISION_HV_NOMBRE, EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE]) && !is_null($etapa_usuario->puntaje) || !is_null($etapa_usuario->puntaje_ia)) {\n            $etapa_completada = true;\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::ENTREVISTA_NOMBRE) {\n            if ($this->configuracion_modelo_servicio->obtenerValorLlaveConfiguracion(app(VacanteService::class)->obtenerConfiguracionesEtapaAplicante($etapa_usuario->etapa_vacante_id), 'solicitar_formato_entrevista')) {\n                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n\n                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n                    $etapa_completada = true;\n                }\n            } else {\n                $etapa_completada = true;\n            }\n        }\n\n        // Verificar si las etapas de preguntas prefiltro o videoentrevista ya han sido completadas\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE])) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'                      => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'                            => $etapa_usuario->usuario_id,\n                'incluir_cantidad_respuestas_aplicante' => true\n            ]));\n\n            $preguntas_contestadas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                if ($pregunta['respuestas_count'] > 0) {\n                    $preguntas_contestadas++;\n                }\n            }\n\n            // Validar que todas las preguntas hayan sido contestadas\n            if (count($preguntas) === $preguntas_contestadas) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n            if ((!is_null($etapa_usuario->pruebaTecnica?->enlace) && !empty($etapa_usuario->pruebaTecnica?->enlace) || $etapa_usuario->pruebaTecnica?->archivos->count() > 0) && $etapa_usuario->pruebaTecnica?->borrador == false) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE) {\n            $documentos_contratacion = app(EtapaVacanteService::class)->obtenerDocumentosContratacion(\n                $etapa_usuario->etapa_vacante_id,\n                new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id])\n            );\n\n            $documentos_solicitados     = collect($documentos_contratacion['documentos']);\n            $archivos_guardados         = collect($documentos_contratacion['archivos_guardados']);\n            $archivos_guardados_nombres = $archivos_guardados->pluck('nombre')->toArray();\n\n            $todos_cargados = true;\n            foreach ($documentos_solicitados as $documento) {\n                $nombre_normalizado = $this->normalizarNombreDocumento($documento['nombre']);\n\n                if (!in_array($nombre_normalizado, $archivos_guardados_nombres)) {\n                    $todos_cargados = false;\n                    break;\n                }\n            }\n\n            if ($todos_cargados && $documentos_solicitados->count() > 0) {\n                $etapa_completada = true;\n            }\n        }\n\n        return $etapa_completada;\n    }\n\n    /**\n     * Notificar documentos solicitados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function notificarDocumentosSolicitados(int $id): void {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_vacante_usuario) {\n            $this->enviarCorreoFinalizacionEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->vacante);\n        }\n    }\n\n    /**\n     * Descartar uno o varios aplicantes manualmente y moverlos a la etapa de descartados.\n     *\n     * @param array $ids IDs de las etapas de usuarios en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function descartarAplicantesManual(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n            if ($etapa_vacante_usuario) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n            }\n        }\n    }\n\n    /**\n     * Revertir descarte de aplicantes.\n     *\n     * @param array $ids IDs de las etapas de los usuarios descartados en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function revertirDescarteAplicantes(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_descartado = $this->repositorio->getUno($id);\n\n            if ($etapa_descartado && $etapa_descartado->etapa->nombre === EtapaVacante::DESCARTADOS_NOMBRE && $etapa_descartado->activo) {\n                $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $etapa_descartado->vacante->id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n                $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n                $etapa_previa          = $this->repositorio->obtenerEtapaPrevia($etapa_descartado->usuario_id, $etapas_ids);\n\n                if ($etapa_previa) {\n                    $this->repositorio->eliminar($etapa_descartado->id);\n                    $this->repositorio->actualizar($etapa_previa->id, ['activo' => true]);\n                }\n            }\n        }\n    }\n\n    /**\n     * Mover manualmente al aplicante a la siguiente etapa.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function moverAplicanteEtapaManual(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n        $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $etapa_usuario->puntaje ?? 0);\n    }\n\n    /**\n     * Marcar la vacante como abandonada por el aplicante.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function abandonarVacante(Request $request): void {\n        $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $request->vacante_id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n        $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n        $etapa_vacante_usuario = $this->repositorio->obtenerEtapaPrevia($request->usuario_id, $etapas_ids);\n\n        if ($etapa_vacante_usuario) {\n            $this->repositorio->actualizar($etapa_vacante_usuario->id, ['motivo_abandono' => $request->motivo_abandono]);\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n        }\n    }\n\n    /**\n     * Notificar al aplicante sobre el cambio de etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param bool $aplicar_validacion_fin_proceso Indica si se debe aplicar la validación de fin de proceso.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function notificarCambioEtapa(EtapaVacanteUsuario $etapa_usuario, bool $aplicar_validacion_fin_proceso = true): void {\n        $etapa_usuario->load(['etapa', 'vacante', 'usuario']);\n        $etapa = $etapa_usuario->etapa;\n\n        $plantilla_correo_id = [\n            EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE     => PlantillaCorreo::PREGUNTAS_PRE_FILTRO_ID,\n            EtapaVacante::PRUEBA_TECNICA_NOMBRE          => PlantillaCorreo::ENVIO_PRUEBA_TECNICA_ID,\n            EtapaVacante::VIDEO_ENTREVISTA_NOMBRE        => PlantillaCorreo::SOLICITUD_VIDEOENTREVISTAS_ID,\n            EtapaVacante::ENTREVISTA_NOMBRE              => PlantillaCorreo::NOTIFICACION_ENTREVISTA_ID,\n            EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE => PlantillaCorreo::SOLICITUD_DOCUMENTOS_ID,\n            EtapaVacante::CONTRATADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_CONTRATADOS_ID,\n            EtapaVacante::DESCARTADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_DESCARTADOS_ID\n        ][$etapa->nombre] ?? null;\n\n        if (isset($plantilla_correo_id)) {\n            $plantilla_correo_etapa = $this->plantilla_correo_servicio->obtenerUno(new Request([\n                'plantilla_correo_id' => $plantilla_correo_id,\n                'empresa_id'          => $etapa_usuario->vacante->empresa_id\n            ]));\n\n            if (!is_null($plantilla_correo_etapa)) {\n                $es_etapa_fin_proceso = in_array($etapa->nombre, [\n                    EtapaVacante::CONTRATADOS_NOMBRE,\n                    EtapaVacante::DESCARTADOS_NOMBRE\n                ]);\n\n                // Si es etapa de fin de proceso y notificar_fin_proceso es true, no enviar notificación\n                if ($aplicar_validacion_fin_proceso && $es_etapa_fin_proceso && $plantilla_correo_etapa->notificar_fin_proceso) {\n                    return;\n                }\n\n                $usuario            = $etapa_usuario->usuario;\n                $vacante            = $etapa_usuario->vacante;\n                $token_acceso       = $this->token_acceso_servicio->generar($usuario->id);\n                $enlace             = request()->getSchemeAndHttpHost() . \"/control-acceso/{$token_acceso->token}?vacante_id={$vacante->id}\";\n                $usuario_informador = null;\n\n                Mail::to($usuario->email)->queue(new NotificarPostulanteVacanteMail(\n                    $usuario,\n                    $enlace,\n                    $vacante,\n                    $plantilla_correo_etapa->titulo,\n                    $plantilla_correo_etapa->contenido,\n                    $plantilla_correo_etapa->con_logo_empresa,\n                    $etapa->nombre,\n                    $usuario_informador\n                ));\n\n                // Enviar notificación de avance en el proceso\n                $usuario->notify(new NotificarAvanceProcesoNotification(\n                    $vacante->id,\n                    $vacante->nombre_vacante,\n                    $etapa->nombre,\n                    $vacante->empresa->nombre ?? 'la empresa'\n                ));\n\n                $this->repositorio->actualizar($etapa_usuario->id, ['fecha_notificacion' => now()]);\n            }\n        }\n    }\n\n    /**\n     * Enviar correo de notificación al finalizar una etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_vacante_usuario Etapa del usuario en la vacante.\n     * @param Vacante $vacante Vacante.\n     * @return void\n     * @author Jair Carvajal\n     */\n    private function enviarCorreoFinalizacionEtapa(EtapaVacanteUsuario $etapa_vacante_usuario, Vacante $vacante): void {\n        $usuario     = Auth::user();\n        $maneja_logo = file_exists(public_path('empresas-logo/' . $vacante->empresa->id)) ? '1' : null;\n\n        Mail::send(new NotificarFinalizacionEtapaMail(\n            $usuario,\n            $vacante,\n            $etapa_vacante_usuario->etapa,\n            $maneja_logo\n        ));\n    }\n\n    /**\n     * Obtener candidatos recomendados con IA.\n     *\n     * Obtiene los 3 mejores candidatos para la vacante, entre varios candidatos seleccionados por el reclutador.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function obtenerCandidatosRecomendadosIA(Request $request): array {\n        $vacante       = $this->vacante_repositorio->getUno($request->vacante_id);\n        $candidatos    = $this->usuario_repositorio->obtenerCandidatosSeleccionadosVacante($request->usuarios_ids, $request->vacante_id);\n        $candidatos_ia = [];\n        $vacante_ia    = [\n            ...Arr::only($vacante->toArray(), ['nombre_vacante', 'salario', 'salario_maximo']),\n            'habilidades'               => $vacante->datos->first(fn($item) => $item->llave === 'habilidades')->valor,\n            'herramientas_tecnologicas' => $vacante->datos->first(fn($item) => $item->llave === 'herramientas_tecnologicas')->valor,\n            'experiencia_laboral'       => $vacante->datos->first(fn($item) => $item->llave === 'experiencia_laboral')->valor,\n            'nivel_educativo'           => $vacante->datos->first(fn($item) => $item->llave === 'nivel_educativo')->valor\n        ];\n\n        if (!is_null($vacante->ciudad_id)) {\n            $direccion_trabajo = $vacante->datos->first(fn($item) => $item->llave === 'direccion_trabajo')->valor;\n            $ubicacion_empresa = \"{$vacante->ciudad->departamento->pais->nombre}, {$vacante->ciudad->departamento->nombre} - {$vacante->ciudad->nombre}, {$direccion_trabajo}\";\n        } elseif (!is_null($vacante->empresa->ciudad_id)) {\n            $ubicacion_empresa = \"{$vacante->empresa->ciudad->departamento->pais->nombre}, {$vacante->empresa->ciudad->departamento->nombre} - {$vacante->empresa->ciudad->nombre}, {$vacante->empresa->direccion}\";\n        }\n\n        if (isset($ubicacion_empresa)) {\n            $vacante_ia['ubicacion'] = $ubicacion_empresa;\n        }\n\n        foreach ($candidatos as $candidato) {\n            if (!is_null($candidato->ciudad_id) && !is_null($candidato->direccion)) {\n                $ubicacion = \"{$candidato->ciudad->departamento->pais->nombre}, {$candidato->ciudad->departamento->nombre} - {$candidato->ciudad->nombre}, {$candidato->direccion}\";\n            }\n\n            $usuario = [\n                ...Arr::only($candidato->toArray(), ['id', 'nombre_completo', 'email', 'telefono', 'edad']),\n                'adecuacion' => $this->obtenerAdecuacionUsuario($candidato->id, $request->vacante_id)\n            ];\n\n            if (isset($ubicacion)) {\n                $usuario['ubicacion'] = $ubicacion;\n            }\n\n            if (!is_null($candidato->perfilLaboral)) {\n                $usuario['salario']                   = $candidato->perfilLaboral->salario;\n                $usuario['salario_maximo']            = $candidato->perfilLaboral->salario_maximo;\n                $usuario['habilidades']               = $candidato->perfilLaboral->habilidades;\n                $usuario['herramientas_tecnologicas'] = $candidato->perfilLaboral->herramientas_tecnologicas;\n                $usuario['estudios']                  = [];\n                $usuario['experiencias_laborales']    = [];\n                $usuario['idiomas']                   = [];\n                $usuario['etapas']                    = [];\n\n                foreach ($candidato->perfilLaboral->estudios as $item) {\n                    array_push($usuario['estudios'], [\n                        ...Arr::only($item->toArray(), ['titulo', 'fecha_inicio', 'fecha_fin']),\n                        'nivel_educativo' => $item->nivelEducativo->nombre,\n                    ]);\n                }\n\n                foreach ($candidato->perfilLaboral->experienciasLaborales as $item) {\n                    array_push($usuario['experiencias_laborales'], [...Arr::only($item->toArray(), ['empresa', 'cargo', 'fecha_inicio', 'fecha_fin', 'tiempo'])]);\n                }\n\n                foreach ($candidato->perfilLaboral->idiomas as $item) {\n                    array_push($usuario['idiomas'], [\n                        'idioma' => $item->idioma->nombre,\n                        'nivel'  => $item->nivel\n                    ]);\n                }\n\n                foreach ($candidato->etapasUsuarios as $item) {\n                    $datos_etapas = [\n                        'nombre'      => $item->etapa->nombre,\n                        'puntaje'     => $item->puntaje,\n                        'puntaje_ia'  => $item->puntaje_ia,\n                        'comentarios' => $item->comentarios->pluck('comentario')->values()->toArray()\n                    ];\n\n                    if ($item->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE) {\n                        $agendas = $this->agenda_repositorio->getTodo(new Request([\n                            'proceso_id'         => $vacante->proceso->id,\n                            'evaluado_id'        => $item->usuario_id,\n                            'estado_id'          => EstadoAgenda::FINALIZADA_ID,\n                            'incluir_resultados' => true\n                        ]));\n\n                        $datos_etapas['pruebas_psicometricas'] = [];\n\n                        foreach ($agendas as $agenda) {\n                            array_push($datos_etapas['pruebas_psicometricas'], [\n                                'prueba'     => $agenda->prueba->nombre,\n                                'ajuste'     => $agenda->ajuste,\n                                'resultados' => $agenda->resultados->map(function ($resultado) {\n                                    return [\n                                        'dimension' => $resultado->dimension->nombre,\n                                        'puntaje'   => $resultado->puntaje_transformado\n                                    ];\n                                })->values()->toArray()\n                            ]);\n                        }\n\n                        if (count($datos_etapas['pruebas_psicometricas']) === 0) {\n                            unset($datos_etapas['pruebas_psicometricas']);\n                        }\n                    }\n\n                    array_push($usuario['etapas'], $datos_etapas);\n                }\n            }\n\n            array_push($candidatos_ia, $usuario);\n        }\n\n        return $this->realizarPeticionIA('obtener-candidatos-recomendados', [\n            'vacante_id' => $request->vacante_id,\n            'vacante'    => json_encode($vacante_ia, JSON_UNESCAPED_UNICODE),\n            'candidatos' => json_encode($candidatos_ia, JSON_UNESCAPED_UNICODE)\n        ]);\n    }\n\n    /**\n     * Obtener competencias por mejorar para usuario que será contratado.\n     * SOLO Buscar agendas de TenDisc Plus (12) y Potencial Comercial (7)\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return array\n     * @author Sergio Vargas\n     */\n    public function obtenerCompetenciasPorMejorar(int $id): array {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n        $usuario_id = $etapa_vacante_usuario->usuario_id;\n        $proceso = $etapa_vacante_usuario->vacante->proceso;\n\n        if (is_null($proceso)) {\n            return ['pruebas' => []];\n        }\n\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id' => $proceso->id,\n            'evaluado_id' => $usuario_id,\n            'pruebas_ids' => [12, 7],\n            'estado_id' => 3,\n            'con_evaluado' => true\n        ]));\n\n        $resultado = ['pruebas' => []];\n\n        foreach ($agendas as $agenda) {\n            $competencias_bajas = $this->extraerCompetenciasBajas($agenda);\n\n            if (!empty($competencias_bajas)) {\n                $resultado['pruebas'][] = [\n                    'prueba_id' => $agenda->prueba_id,\n                    'nombre_prueba' => $agenda->prueba->nombre,\n                    'competencias' => $competencias_bajas\n                ];\n            }\n        }\n\n        return $resultado;\n    }\n\n    /**\n     * Extraer las 2 competencias más bajas de una agenda según su prueba.\n     *\n     * @param \\App\\Models\\Agendas\\Agenda $agenda Agenda finalizada.\n     * @return array\n     * @author Sergio Vargas\n     */\n    private function extraerCompetenciasBajas($agenda): array {\n        $resultados = $this->resultado_agenda_servicio->gestionarResultados($agenda);\n\n        if (empty($resultados)) {\n            return [];\n        }\n\n        $competencias_todas = [];\n\n        // TenDisc Plus (prueba_id = 12)\n        if ($agenda->prueba_id === 12) {\n            $factor_especificas = collect($resultados)->firstWhere('nombre', 'Competencias Específicas');\n            $factor_transversales = collect($resultados)->firstWhere('nombre', 'Competencias Transversales');\n\n            if ($factor_especificas) {\n                $competencias_todas = array_merge($competencias_todas, $factor_especificas['dimensiones']);\n            }\n            if ($factor_transversales) {\n                $competencias_todas = array_merge($competencias_todas, $factor_transversales['dimensiones']);\n            }\n        }\n\n        // Potencial Comercial (prueba_id = 7)\n        if ($agenda->prueba_id === 7) {\n            $factor_caracter = collect($resultados)->firstWhere('nombre', 'Carácter');\n            $factor_habilidades = collect($resultados)->firstWhere('nombre', 'Habilidades');\n\n            if ($factor_caracter) {\n                $competencias_todas = array_merge($competencias_todas, $factor_caracter['dimensiones']);\n            }\n            if ($factor_habilidades) {\n                $competencias_todas = array_merge($competencias_todas, $factor_habilidades['dimensiones']);\n            }\n        }\n\n        // Ordenar por puntaje ascendente y tomar las 2 más bajas\n        return collect($competencias_todas)\n            ->sortBy('puntaje_transformado')\n            ->take(2)\n            ->map(fn($c) => [\n                'nombre' => $c['nombre'],\n                'puntaje' => round($c['puntaje_transformado'], 0)\n            ])\n            ->values()\n            ->toArray();\n    }\n}\n","numLines":1298,"startLine":1,"totalLines":1298}}}
{"parentUuid":"be7c384f-3c97-4d51-aac3-01fdbd427864","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015wsGdYTdzQjj9cBZ9M3TVF","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a modificar la función `guardarPuntajeAdecuacionReclutador` para agregar un parámetro booleano que permita omitir la validación `is_null($etapa_usuario->puntaje)` cuando sea necesario."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":24611,"cache_read_input_tokens":24401,"cache_creation":{"ephemeral_5m_input_tokens":24611,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWvBvj6HwhWoXdHLH9hJL","type":"assistant","uuid":"642ab564-0c52-4400-b406-4e830fd65773","timestamp":"2026-01-08T16:00:07.969Z"}
{"parentUuid":"642ab564-0c52-4400-b406-4e830fd65773","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015wsGdYTdzQjj9cBZ9M3TVF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PSgK8NLLjC9xtMQz72hxxV","name":"Edit","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","old_string":"    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {","new_string":"    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @param bool $forzar_actualizacion Si es true, omite la validación de puntaje nulo.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":24611,"cache_read_input_tokens":24401,"cache_creation":{"ephemeral_5m_input_tokens":24611,"ephemeral_1h_input_tokens":0},"output_tokens":642,"service_tier":"standard"}},"requestId":"req_011CWvBvj6HwhWoXdHLH9hJL","type":"assistant","uuid":"5ca38643-1ecc-487f-b9e6-e19f1326db7b","timestamp":"2026-01-08T16:00:15.441Z"}
{"type":"file-history-snapshot","messageId":"5ca38643-1ecc-487f-b9e6-e19f1326db7b","snapshot":{"messageId":"5d3f9fa4-de66-4e39-a42c-88756646ce20","trackedFileBackups":{"app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php":{"backupFileName":"5419cff174eb966b@v1","version":1,"backupTime":"2026-01-08T16:01:40.611Z"}},"timestamp":"2026-01-08T15:59:52.612Z"},"isSnapshotUpdate":true}
{"parentUuid":"5ca38643-1ecc-487f-b9e6-e19f1326db7b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PSgK8NLLjC9xtMQz72hxxV","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   526→            }\n   527→        }\n   528→    }\n   529→\n   530→    /**\n   531→     * Guardar el puntaje de adecuación dado por el reclutador.\n   532→     *\n   533→     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n   534→     *\n   535→     * @param int $id ID de la etapa del usuario en la vacante.\n   536→     * @param int $puntaje Puntaje dado por el reclutador.\n   537→     * @param bool $forzar_actualizacion Si es true, omite la validación de puntaje nulo.\n   538→     * @return void\n   539→     * @author Daniel Beltrán\n   540→     */\n   541→    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {\n   542→        $etapa_usuario = $this->repositorio->getUno($id);\n   543→\n   544→        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {\n   545→            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n   546→                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n   547→            }\n   548→"}]},"uuid":"ac06d5b8-8ad1-455a-99c0-0112e1124481","timestamp":"2026-01-08T16:01:40.666Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","oldString":"    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {","newString":"    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @param bool $forzar_actualizacion Si es true, omite la validación de puntaje nulo.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Vacantes;\n\nuse App\\Traits\\IATrait;\nuse App\\Traits\\StringTrait;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Vacantes\\Vacante;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Agendas\\EstadoAgenda;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Support\\Facades\\Mail;\nuse App\\Models\\Vacantes\\EtapaVacante;\nuse App\\Models\\Vacantes\\EstadoVacante;\nuse App\\Models\\Vacantes\\MovimientoVacante;\nuse App\\Mail\\NotificarFinalizacionEtapaMail;\nuse App\\Mail\\NotificarPostulanteVacanteMail;\nuse App\\Models\\Vacantes\\EtapaVacanteUsuario;\nuse Illuminate\\Http\\Client\\RequestException;\nuse App\\Http\\Services\\Vacantes\\VacanteService;\nuse App\\Models\\Configuraciones\\PlantillaCorreo;\nuse Illuminate\\Http\\Client\\ConnectionException;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Services\\Usuarios\\TokenAccesoService;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Services\\Vacantes\\EtapaVacanteService;\nuse App\\Jobs\\Vacantes\\ProcesarVideoentrevistaIAJob;\nuse App\\Http\\Repositories\\Procesos\\ProcesoRepository;\nuse App\\Http\\Repositories\\Vacantes\\VacanteRepository;\nuse App\\Http\\Services\\Agendas\\ResultadoAgendaService;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse App\\Notifications\\NotificarAvanceProcesoNotification;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteRepository;\nuse App\\Http\\Repositories\\Vacantes\\TranscripcionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Vacantes\\AspectoPuntajeRepository;\nuse App\\Http\\Services\\Configuraciones\\PlantillaCorreoService;\nuse App\\Http\\Repositories\\Vacantes\\FormatoEntrevistaRepository;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteUsuarioRepository;\nuse App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\nuse App\\Http\\Repositories\\Vacantes\\EtapaMovimientoVacanteRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PreguntaOfertaLaboralRepository;\nuse App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PuntajePreguntaOfertaLaboralRepository;\n\n/**\n * @property EtapaVacanteUsuarioRepository $repositorio\n */\nclass EtapaVacanteUsuarioService extends BaseService\n{\n    use ArchivoTrait, IATrait, StringTrait;\n\n    /**\n     * @var float|int $puntaje_total Puntaje total, utilizado para la adecuación de HV.\n     */\n    private $puntaje_total = 0;\n\n    /**\n     * @var float $puntaje Puntaje de aspecto, utilizado para la adecuación de HV.\n     */\n    private $puntaje = 0;\n\n    /**\n     * @var bool $cumple Indica si cumple con el aspecto, utilizada para la adecuación de HV.\n     */\n    private $cumple = false;\n\n    /**\n     * Constructor.\n     *\n     * @param EtapaVacanteUsuarioRepository $repositorio Repositorio de etapas de vacantes de usuarios.\n     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n     * @param EtapaVacanteRepository $etapa_vacante_repositorio Repositorio de etapas de vacantes.\n     * @param AspectoPuntajeRepository $aspecto_puntaje_repositorio Repositorio de puntajes de aspectos.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio Repositorio de preguntas de ofertas laborales.\n     * @param PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio Repositorio de puntajes de preguntas de ofertas laborales.\n     * @param EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio Repositorio de movimientos de etapas de vacantes.\n     * @param ProcesoRepository $proceso_repositorio Repositorio de procesos.\n     * @param TranscripcionRepository $transcripcion_repositorio Repositorio de transcripciones.\n     * @param PlantillaCorreoService $plantilla_correo_servicio Servicio de plantillas de correo.\n     * @param TokenAccesoService $token_acceso_servicio Servicio de tokens de acceso.\n     * @param UserRepository $usuario_repositorio Servicio de usuarios.\n     * @param VacanteRepository $vacante_repositorio Repositorio de vacantes.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param ResultadoAgendaService $resultado_agenda_servicio Servicio de resultados de agendas.\n     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n     * @param FormatoEntrevistaRepository $formato_entrevista_repositorio Repositorio de formatos de entrevista.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function __construct(\n        EtapaVacanteUsuarioRepository $repositorio,\n        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n        protected EtapaVacanteRepository $etapa_vacante_repositorio,\n        protected AspectoPuntajeRepository $aspecto_puntaje_repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio,\n        protected PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio,\n        protected EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio,\n        protected ProcesoRepository $proceso_repositorio,\n        protected TranscripcionRepository $transcripcion_repositorio,\n        protected PlantillaCorreoService $plantilla_correo_servicio,\n        protected TokenAccesoService $token_acceso_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected VacanteRepository $vacante_repositorio,\n        protected AgendaRepository $agenda_repositorio,\n        protected ResultadoAgendaService $resultado_agenda_servicio,\n        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n        protected FormatoEntrevistaRepository $formato_entrevista_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar documento solicitado de una etapa de vacante de usuario.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function guardarDocumentoSolicitado(Request $request): void {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n        if ($request->hasFile('archivo')) {\n            $this->archivo_servicio->guardarVarios(EtapaVacanteUsuario::class, $request->etapa_vacante_usuario_id, [$request->nombre_documento => $request->file('archivo')], 'empresas/' . $empresa->id . '/documentos-solicitados', true);\n        }\n    }\n\n    /**\n     * Establecer valores para puntaje y cumplimiento de un aspecto.\n     *\n     * @param float $puntaje Puntaje obtenido.\n     * @param bool $cumple Indica si cumple.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function establecerPuntajeCumplimiento(float $puntaje = 0, bool $cumple = false): void {\n        $this->puntaje = $puntaje;\n        $this->cumple  = $cumple;\n    }\n\n    /**\n     * Guardar puntaje de un aspecto evaluado.\n     *\n     * @param int $etapa_vacante_usuario_id ID de la etapa del usuario en la vacante.\n     * @param string $categoria Categoría del aspecto.\n     * @param string $aspecto Aspecto evaluado.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function guardarAspectoPuntaje(int $etapa_vacante_usuario_id, string $categoria, string $aspecto): void {\n        $this->aspecto_puntaje_repositorio->crearOActualizar([\n            'etapa_vacante_usuario_id' => $etapa_vacante_usuario_id,\n            'categoria'                => $categoria,\n            'aspecto'                  => $aspecto\n        ], [\n            'puntaje'                  => $this->puntaje,\n            'cumple'                   => $this->cumple\n        ]);\n\n        $this->puntaje_total += $this->puntaje;\n        $this->establecerPuntajeCumplimiento();\n    }\n\n    /**\n     * Generar adecuación de hoja de vida.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionHV(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::REVISION_HV_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $perfil_laboral = $this->perfil_laboral_repositorio->getUnoAvanzado(new Request([\n                'usuario_id'                     => $etapa_usuario->usuario_id,\n                'incluir_experiencias_laborales' => true,\n                'incluir_estudios'               => true,\n                'incluir_idiomas'                => true,\n                'incluir_usuario'                => true\n            ]));\n\n            // Generar y guardar la adecuación del perfil de candidato (habilidades y herramientas tecnológicas)\n            $categoria            = 'perfil';\n            $puntaje_aspecto      = 100 / 2;\n            $datos_vacante        = $etapa_usuario->vacante->datos;\n            $habilidades_vacante  = $datos_vacante->where('llave', 'habilidades')->first();\n            $herramientas_vacante = $datos_vacante->where('llave', 'herramientas_tecnologicas')->first();\n\n            // Validar coincidencia para las habilidades\n            if (!is_null($habilidades_vacante->valor) && !empty($habilidades_vacante->valor)) {\n                $habilidades_vacante        = array_map(fn($item) => trim($item), explode(',', $habilidades_vacante->valor));\n                $habilidades_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->habilidades));\n                $coincidencias              = count(array_uintersect($habilidades_vacante, $habilidades_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($habilidades_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'habilidades');\n\n            // Validar coincidencia para las herramientas tecnológicas\n            if (!is_null($herramientas_vacante->valor) && !empty($herramientas_vacante->valor)) {\n                $herramientas_vacante        = array_map(fn($item) => trim($item), explode(',', $herramientas_vacante->valor));\n                $herramientas_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->herramientas_tecnologicas));\n                $coincidencias               = count(array_uintersect($herramientas_vacante, $herramientas_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($herramientas_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'herramientas');\n\n            // Generar y guardar la adecuación de requisitos del candidato (género, edad, nivel educativo, modalidad de trabajo, salario, experiencia, idiomas, licencia de conducir)\n            $categoria       = 'requisito';\n            $puntaje_aspecto = 100 / 8;\n\n            // Validar coincidencia de género\n            $genero_vacante = $datos_vacante->where('llave', 'genero')->first();\n\n            if (!is_null($genero_vacante) && !empty($genero_vacante)) {\n                if ($genero_vacante->valor === mb_convert_case($perfil_laboral->usuario->genero->nombre, MB_CASE_LOWER)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                } elseif ($genero_vacante->valor === 'indiferente') {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'genero');\n\n            // Validar coincidencia de edad\n            $edad_minima_vacante = $datos_vacante->where('llave', 'edad_minima')->first();\n            $edad_maxima_vacante = $datos_vacante->where('llave', 'edad_maxima')->first();\n\n            if (empty($edad_minima_vacante->valor) || empty($edad_maxima_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($perfil_laboral->usuario->edad >= $edad_minima_vacante->valor && $perfil_laboral->usuario->edad <= $edad_maxima_vacante->valor) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'edad');\n\n            // Validar coincidencia de nivel educativo\n            $nivel_educativo_vacante = $datos_vacante->where('llave', 'nivel_educativo')->first();\n            $escala_estudios         = [\n                'Preescolar'                      => 1,\n                'Primaria'                        => 2,\n                'Secundaria básica'               => 3,\n                'Secundaria superior'             => 4,\n                'Educación continua y permanente' => 5,\n                'Técnico'                         => 6,\n                'Tecnólogo'                       => 7,\n                'Profesional'                     => 8,\n                'Especialización (postgrado)'     => 9,\n                'Maestría (postgrado)'            => 10,\n                'Doctorado (postgrado)'           => 11\n            ];\n\n            if (empty($nivel_educativo_vacante->valor) || $nivel_educativo_vacante->valor === 'indiferente') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (count($perfil_laboral->estudios) > 0) {\n                $cumple_nivel_educativo = false;\n\n                foreach ($perfil_laboral->estudios as $estudio) {\n                    if ($escala_estudios[$nivel_educativo_vacante->valor] <= $escala_estudios[$estudio->nivelEducativo->nombre]) {\n                        $cumple_nivel_educativo = true;\n                        break;\n                    }\n                }\n\n                if ($cumple_nivel_educativo) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'estudios');\n\n            // Validar coincidencia de modalidad de trabajo\n            if (!is_null($etapa_usuario->vacante->modalidad_trabajo_id)) {\n                if ($etapa_usuario->vacante->modalidad_trabajo_id === $perfil_laboral->modalidad_trabajo_id) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'modalidad_trabajo');\n\n            // Validar coincidencia de salario\n            if (is_null($etapa_usuario->vacante->salario)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (!is_null($etapa_usuario->vacante->salario) && is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Salario fijo\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario de la vacante es fijo pero el del usuario es rango\n                    if (($etapa_usuario->vacante->salario >= $perfil_laboral->salario && $etapa_usuario->vacante->salario <= $perfil_laboral->salario_maximo) || ($perfil_laboral->salario <= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } elseif ($perfil_laboral->salario <= $etapa_usuario->vacante->salario) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (!is_null($etapa_usuario->vacante->salario) && !is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Rango de salario\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario del usuario y de la vacante son rangos\n                    if (($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) || ($perfil_laboral->salario_maximo >= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario_maximo)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } else {\n                    if ($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'salario');\n\n            // Validar coincidencia de experiencia\n            $experiencia_vacante   = $datos_vacante->where('llave', 'experiencia_laboral')->first();\n            $experiencia_aplicante = $perfil_laboral->experienciasLaborales->sum('tiempo');\n            $experiencias          = [\n                '1 año'        => 1,\n                '2 años'       => 2,\n                '3 años'       => 3,\n                '4 años'       => 4,\n                '5 años o más' => 5\n            ];\n\n            if (empty($experiencia_vacante->valor) || $experiencia_vacante->valor === 'Sin experiencia') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($experiencia_vacante->valor === 'Menos de 1 año') {\n                if ($experiencia_aplicante > 0 && $experiencia_aplicante < 365) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (($experiencias[$experiencia_vacante->valor] * 365) <= $experiencia_aplicante) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'experiencia');\n\n            // Validar coincidencia de idiomas\n            $idiomas_vacante = $etapa_usuario->vacante->idiomas;\n            $escala_idiomas  = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'C1' => 5,\n                'C2' => 6\n            ];\n\n            if ($idiomas_vacante->count() > 0) {\n                $coincidencias_idiomas = 0;\n\n                if ($perfil_laboral->idiomas->count() > 0) {\n                    foreach ($idiomas_vacante as $idioma) {\n                        foreach ($perfil_laboral->idiomas as $idioma_perfil) {\n                            if ($idioma->idioma_id === $idioma_perfil->idioma_id && $escala_idiomas[$idioma->nivel] <= $escala_idiomas[$idioma_perfil->nivel]) {\n                                $coincidencias_idiomas++;\n                            }\n                        }\n                    }\n                }\n\n                if ($coincidencias_idiomas >= $idiomas_vacante->count()) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'idiomas');\n\n            // Validar coincidencia de licencia de conducir\n            $licencia_conducir_vacante = $datos_vacante->where('llave', 'licencia_conducir')->first();\n            $escala_licencias          = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'B3' => 5,\n                'C1' => 6,\n                'C2' => 7,\n                'C3' => 8\n            ];\n\n            if (empty($licencia_conducir_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (is_null($perfil_laboral->licencia_conducir)) {\n                if (empty($licencia_conducir_vacante->valor)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif ($escala_licencias[$licencia_conducir_vacante->valor] <= $escala_licencias[$perfil_laboral->licencia_conducir]) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'licencia_conducir');\n\n            $puntaje_total = round($this->puntaje_total / 2); // Se divide entre las dos categorías existentes\n            $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::REVISION_HV_ID, $puntaje_total, 'descartar_candidatos_adecuaciones_bajas_hv', 'descartar_candidatos_adecuaciones_medias_hv');\n        }\n    }\n\n    /**\n     * Generar adecuación para preguntas prefiltro.\n     *\n     * Califica las respuestas del aplicante en cada una de las preguntas y calcula la adecuación en base a sus resultados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPrefiltro(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'   => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'         => $etapa_usuario->usuario_id,\n                'incluir_respuestas' => true\n            ]));\n\n            $porcentaje_pregunta  = 100 / $preguntas->count();\n            $respuestas_correctas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                $puntaje    = null;\n                $puntaje_ia = null;\n\n                if ($pregunta->es_abierta) {\n                    $respuesta = $opcion_seleccionada = $pregunta->respuestas->first();\n\n                    if (!is_null($respuesta)) {\n                        try {\n                            $peticion_ia = $this->realizarPeticionIA(\n                                ruta: 'calificar-pregunta-abierta',\n                                parametros: [\n                                    'pregunta'  => $pregunta->enunciado,\n                                    'respuesta' => $respuesta->respuesta,\n                                ],\n                                contexto_tracking: [\n                                    'vacante_id' => $etapa_usuario->etapa->vacante_id ?? null,\n                                    'agenda_id' => null,\n                                ]\n                            );\n\n                            if (!is_null($peticion_ia) && $peticion_ia['status_code'] === 200) {\n                                $puntaje_ia = $peticion_ia['calificacion'];\n                            }\n                        } catch (RequestException|ConnectionException $error) {}\n                    }\n                } else {\n                    $opciones_correctas = $pregunta->opciones->where('es_correcta', true);\n\n                    // Selección única\n                    if ($opciones_correctas->count() === 1) {\n                        $opcion_correcta     = $opciones_correctas->first();\n                        $opcion_seleccionada = $pregunta->respuestas->first();\n                        $puntaje             = (int) (!is_null($opcion_seleccionada) && $opcion_correcta->id === $opcion_seleccionada->opcion_pregunta_id);\n                    } else { // Selección múltiple\n                        $opciones_correctas     = $opciones_correctas->pluck('id')->toArray();\n                        $opciones_seleccionadas = $pregunta->respuestas->pluck('opcion_pregunta_id')->toArray();\n                        $aciertos               = count(array_intersect($opciones_seleccionadas, $opciones_correctas));\n                        $fallos                 = count(array_diff($opciones_seleccionadas, $opciones_correctas));\n                        $puntaje                = (int) ($aciertos - $fallos === count($opciones_correctas));\n                    }\n                }\n\n                // Guardar el puntaje obtenido en cada pregunta\n                $this->puntaje_pregunta_oferta_laboral_repositorio->crearSiNoExiste([\n                    'pregunta_id' => $pregunta->id,\n                    'usuario_id'  => $etapa_usuario->usuario_id\n                ], [\n                    'puntaje'     => $puntaje,\n                    'puntaje_ia'  => $puntaje_ia\n                ]);\n\n                // Sumar el puntaje total\n                if (is_null($puntaje) && !is_null($puntaje_ia)) {\n                    $respuestas_correctas += $puntaje_ia;\n                } else {\n                    $respuestas_correctas += $puntaje;\n                }\n            }\n\n            $puntaje_etapa = $respuestas_correctas * $porcentaje_pregunta;\n\n            if ($etapa_usuario->vacante->automatizar_etapas) {\n                // Obtener el movimiento de la etapa con sus configuraciones\n                $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                    'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                    'movimiento_vacante_id'   => MovimientoVacante::PREGUNTAS_PREFILTRO_ID,\n                    'incluir_configuraciones' => true\n                ]));\n\n                $configuracion_preguntas_correctas = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', 'descartar_candidatos_respondieron_menos_preguntas_prefiltro')->first();\n\n                // Avanzar al aplicante de etapa o descartarlo según la configuración de la etapa\n                if (!is_null($configuracion_preguntas_correctas) && $configuracion_preguntas_correctas->valor <= $respuestas_correctas) {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa);\n                } else {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa, descartar: true);\n                }\n            } else {\n                $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_etapa]);\n            }\n        }\n    }\n\n    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n            }\n\n            if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::VIDEO_ENTREVISTA_NOMBRE, EtapaVacante::ENTREVISTA_NOMBRE])) {\n                if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE) {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_videoentrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_videoentrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_videoentrevista';\n                } else {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n                }\n\n                if ($this->verificarFormatoEntrevista($etapa_usuario, $movimiento_vacante_id, $llave_configuracion_formato)) {\n                    $this->gestionarContinuidadAplicante($etapa_usuario, $movimiento_vacante_id, $puntaje, $llave_configuracion_adecuaciones_bajas, $llave_configuracion_adecuaciones_medias);\n                } else {\n                    $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n                }\n\n                // TODO: Invocar esta función al momento de completar el formato de entrevista\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para pruebas psicométricas.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPruebasPsicometricas(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $indice_talento = $this->proceso_repositorio->obtenerIndiceTalento($etapa_usuario->vacante->proceso->id, $etapa_usuario->usuario_id)->indice_talento;\n\n            if ($indice_talento >= 0) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBAS_PSICOMETRICAS_ID, $indice_talento, 'descartar_candidatos_puntuaciones_bajas', 'descartar_candidatos_puntuaciones_medias', true);\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para videoentrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function generarAdecuacionVideoentrevista(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje_ia)) {\n            ProcesarVideoentrevistaIAJob::dispatch($etapa_usuario);\n        }\n    }\n\n    /**\n     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n     * @author Daniel Beltrán\n     */\n    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n        $formato_diligenciado = false;\n        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n            'movimiento_vacante_id'   => $movimiento_vacante_id,\n            'incluir_configuraciones' => true\n        ]));\n\n        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n        } else {\n            $formato_diligenciado = true;\n        }\n\n        return $formato_diligenciado;\n    }\n\n    /**\n     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n     *\n     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n     * @param int $usuario_id ID del usuario (aplicante).\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id' => $etapa_vacante_id,\n            'usuario_id'       => $usuario_id\n        ]));\n\n        if ($etapa_usuario->activo) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id' => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'       => $etapa_usuario->usuario_id,\n                'incluir_puntajes' => true\n            ]));\n\n            $puntaje            = 0;\n            $puntaje_individual = 100 / $preguntas->count();\n\n            foreach ($preguntas as $pregunta) {\n                if (is_null($pregunta->puntajes[0]->puntaje) && !is_null($pregunta->puntajes[0]->puntaje_ia)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje_ia;\n                } elseif (!is_null($pregunta->puntajes[0]->puntaje)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje;\n                }\n            }\n\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_individual * $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar el puntaje de la etapa actual y gestionar la continuidad del aplicante en la vacante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param int $puntaje Puntaje obtenido en la etapa actual.\n     * @param string $llave_puntajes_bajos Llave de configuración para puntajes bajos.\n     * @param string $llave_puntajes_medios Llave de configuración para puntajes medios.\n     * @param bool $escala_pruebas_psicometricas Indica si debe utilizar la escala de puntajes de pruebas psicométricas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function gestionarContinuidadAplicante(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, int $puntaje, string $llave_puntajes_bajos, string $llave_puntajes_medios, bool $escala_pruebas_psicometricas = false) {\n        if ($etapa_usuario->vacante->automatizar_etapas) {\n            $calificacion_baja  = 40;\n            $calificacion_media = 70;\n\n            if ($escala_pruebas_psicometricas) {\n                $calificacion_baja  = 59;\n                $calificacion_media = 75;\n            }\n\n            // Obtener el movimiento de la etapa con sus configuraciones\n            $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                'movimiento_vacante_id'   => $movimiento_vacante_id,\n                'incluir_configuraciones' => true\n            ]));\n\n            $configuracion_adecuaciones_bajas  = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_bajos)->first();\n            $configuracion_adecuaciones_medias = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_medios)->first();\n\n            if (!is_null($configuracion_adecuaciones_medias) && filter_var($configuracion_adecuaciones_medias->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_media) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            } elseif (!is_null($configuracion_adecuaciones_bajas) && filter_var($configuracion_adecuaciones_bajas->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_baja) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            }\n\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje);\n        } else {\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar puntaje de la etapa actual y mover al aplicante a la siguiente etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param ?int $puntaje Puntaje obtenido en la etapa actual.\n     * @param ?int $puntaje_ia Puntaje obtenido por la IA en la etapa actual.\n     * @param ?string $notas_ia Notas dadas por la IA para la etapa actual.\n     * @param bool $descartar Indica si la etapa a la que se debe cambiar es 'descartados'.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function guardarPuntajeYCambiarDeEtapa(EtapaVacanteUsuario $etapa_usuario, ?int $puntaje = null, ?int $puntaje_ia = null, ?string $notas_ia = null, bool $descartar = false): void {\n        if ($descartar) {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->getUnoAvanzado(new Request(['vacante_id' => $etapa_usuario->vacante->id, 'nombre' => EtapaVacante::DESCARTADOS_NOMBRE]));\n        } else {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->obtenerEtapaSiguiente($etapa_usuario->vacante->id, $etapa_usuario->etapa->orden);\n        }\n\n        $etapa_actual_activa = true;\n\n        if ($etapa_siguiente->nombre !== EtapaVacante::CONTRATADOS_NOMBRE) {\n            $etapa_actual_activa = false;\n            $nueva_etapa_usuario = $this->repositorio->crear([\n                'usuario_id'       => $etapa_usuario->usuario_id,\n                'etapa_vacante_id' => $etapa_siguiente->id,\n                'activo'           => true\n            ]);\n\n            // Crear agendas de pruebas psicométricas si la etapa siguiente son pruebas psicométricas.\n            app(VacanteService::class)->crearAgendasPruebasPsicometricas($etapa_usuario, $etapa_siguiente->id);\n\n            if ($nueva_etapa_usuario) {\n                $this->notificarCambioEtapa($nueva_etapa_usuario);\n            }\n        }\n\n        $this->repositorio->actualizar($etapa_usuario->id, [\n            'puntaje'    => $puntaje,\n            'puntaje_ia' => $puntaje_ia,\n            'notas_ia'   => $notas_ia,\n            'activo'     => $etapa_actual_activa\n        ]);\n\n        // Cuando la etapa es contratado, se valida si ya se han completado las vacantes requeridas para cerrar la vacante\n        if ($etapa_siguiente->nombre === EtapaVacante::CONTRATADOS_NOMBRE) {\n            if ($etapa_usuario->vacante->cantidad_vacantes === $this->repositorio->contarContratados($etapa_usuario->etapa->vacante_id)) {\n                $this->vacante_repositorio->actualizar($etapa_usuario->etapa->vacante_id, ['estado_id' => EstadoVacante::COMPLETADA_ID]);\n\n                $aplicantes_activos_restantes_ids = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'excluir_etapas'         => [EtapaVacante::DESCARTADOS_NOMBRE, EtapaVacante::CONTRATADOS_NOMBRE]\n                ]))->pluck('id')->toArray();\n\n                // Descartar a los aplicantes que quedan activos en la vacante\n                $this->descartarAplicantesManual($aplicantes_activos_restantes_ids);\n\n                $aplicantes_activos_sin_notificar = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'sin_fecha_notificacion' => true\n                ]));\n\n                foreach ($aplicantes_activos_sin_notificar as $aplicante) {\n                    $this->notificarCambioEtapa($aplicante, false);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener la adecuación actual del usuario en la vacante.\n     *\n     * @param int $usuario_id ID del usuario.\n     * @param int $vacante_id ID de la vacante.\n     * @return ?int\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function obtenerAdecuacionUsuario(int $usuario_id, int $vacante_id): ?int {\n        $etapas     = $this->repositorio->obtenerEtapasCompletadasUsuario($usuario_id, $vacante_id);\n        $adecuacion = 0;\n\n        foreach ($etapas as $etapa) {\n            if (!is_null($etapa->puntaje)) {\n                $adecuacion += $etapa->puntaje;\n            } elseif (is_null($etapa->puntaje) && !is_null($etapa->puntaje_ia)) {\n                $adecuacion += $etapa->puntaje_ia;\n            }\n        }\n\n        return ($etapas->count() > 0) ? $adecuacion / $etapas->count() : null;\n    }\n\n    /**\n     * Verificar si una etapa ya ha sido completada por el aplicante.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante (etapa_vacante_usuario_id).\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function verificarEtapaCompletada(int $id): bool {\n        $etapa_usuario    = $this->repositorio->getUno($id);\n        $etapa_completada = false;\n\n        // Verificar si la etapa de revisión de hoja de vida ya fue completada\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::REVISION_HV_NOMBRE, EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE]) && !is_null($etapa_usuario->puntaje) || !is_null($etapa_usuario->puntaje_ia)) {\n            $etapa_completada = true;\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::ENTREVISTA_NOMBRE) {\n            if ($this->configuracion_modelo_servicio->obtenerValorLlaveConfiguracion(app(VacanteService::class)->obtenerConfiguracionesEtapaAplicante($etapa_usuario->etapa_vacante_id), 'solicitar_formato_entrevista')) {\n                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n\n                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n                    $etapa_completada = true;\n                }\n            } else {\n                $etapa_completada = true;\n            }\n        }\n\n        // Verificar si las etapas de preguntas prefiltro o videoentrevista ya han sido completadas\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE])) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'                      => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'                            => $etapa_usuario->usuario_id,\n                'incluir_cantidad_respuestas_aplicante' => true\n            ]));\n\n            $preguntas_contestadas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                if ($pregunta['respuestas_count'] > 0) {\n                    $preguntas_contestadas++;\n                }\n            }\n\n            // Validar que todas las preguntas hayan sido contestadas\n            if (count($preguntas) === $preguntas_contestadas) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n            if ((!is_null($etapa_usuario->pruebaTecnica?->enlace) && !empty($etapa_usuario->pruebaTecnica?->enlace) || $etapa_usuario->pruebaTecnica?->archivos->count() > 0) && $etapa_usuario->pruebaTecnica?->borrador == false) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE) {\n            $documentos_contratacion = app(EtapaVacanteService::class)->obtenerDocumentosContratacion(\n                $etapa_usuario->etapa_vacante_id,\n                new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id])\n            );\n\n            $documentos_solicitados     = collect($documentos_contratacion['documentos']);\n            $archivos_guardados         = collect($documentos_contratacion['archivos_guardados']);\n            $archivos_guardados_nombres = $archivos_guardados->pluck('nombre')->toArray();\n\n            $todos_cargados = true;\n            foreach ($documentos_solicitados as $documento) {\n                $nombre_normalizado = $this->normalizarNombreDocumento($documento['nombre']);\n\n                if (!in_array($nombre_normalizado, $archivos_guardados_nombres)) {\n                    $todos_cargados = false;\n                    break;\n                }\n            }\n\n            if ($todos_cargados && $documentos_solicitados->count() > 0) {\n                $etapa_completada = true;\n            }\n        }\n\n        return $etapa_completada;\n    }\n\n    /**\n     * Notificar documentos solicitados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function notificarDocumentosSolicitados(int $id): void {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_vacante_usuario) {\n            $this->enviarCorreoFinalizacionEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->vacante);\n        }\n    }\n\n    /**\n     * Descartar uno o varios aplicantes manualmente y moverlos a la etapa de descartados.\n     *\n     * @param array $ids IDs de las etapas de usuarios en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function descartarAplicantesManual(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n            if ($etapa_vacante_usuario) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n            }\n        }\n    }\n\n    /**\n     * Revertir descarte de aplicantes.\n     *\n     * @param array $ids IDs de las etapas de los usuarios descartados en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function revertirDescarteAplicantes(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_descartado = $this->repositorio->getUno($id);\n\n            if ($etapa_descartado && $etapa_descartado->etapa->nombre === EtapaVacante::DESCARTADOS_NOMBRE && $etapa_descartado->activo) {\n                $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $etapa_descartado->vacante->id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n                $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n                $etapa_previa          = $this->repositorio->obtenerEtapaPrevia($etapa_descartado->usuario_id, $etapas_ids);\n\n                if ($etapa_previa) {\n                    $this->repositorio->eliminar($etapa_descartado->id);\n                    $this->repositorio->actualizar($etapa_previa->id, ['activo' => true]);\n                }\n            }\n        }\n    }\n\n    /**\n     * Mover manualmente al aplicante a la siguiente etapa.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function moverAplicanteEtapaManual(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n        $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $etapa_usuario->puntaje ?? 0);\n    }\n\n    /**\n     * Marcar la vacante como abandonada por el aplicante.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function abandonarVacante(Request $request): void {\n        $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $request->vacante_id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n        $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n        $etapa_vacante_usuario = $this->repositorio->obtenerEtapaPrevia($request->usuario_id, $etapas_ids);\n\n        if ($etapa_vacante_usuario) {\n            $this->repositorio->actualizar($etapa_vacante_usuario->id, ['motivo_abandono' => $request->motivo_abandono]);\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n        }\n    }\n\n    /**\n     * Notificar al aplicante sobre el cambio de etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param bool $aplicar_validacion_fin_proceso Indica si se debe aplicar la validación de fin de proceso.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function notificarCambioEtapa(EtapaVacanteUsuario $etapa_usuario, bool $aplicar_validacion_fin_proceso = true): void {\n        $etapa_usuario->load(['etapa', 'vacante', 'usuario']);\n        $etapa = $etapa_usuario->etapa;\n\n        $plantilla_correo_id = [\n            EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE     => PlantillaCorreo::PREGUNTAS_PRE_FILTRO_ID,\n            EtapaVacante::PRUEBA_TECNICA_NOMBRE          => PlantillaCorreo::ENVIO_PRUEBA_TECNICA_ID,\n            EtapaVacante::VIDEO_ENTREVISTA_NOMBRE        => PlantillaCorreo::SOLICITUD_VIDEOENTREVISTAS_ID,\n            EtapaVacante::ENTREVISTA_NOMBRE              => PlantillaCorreo::NOTIFICACION_ENTREVISTA_ID,\n            EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE => PlantillaCorreo::SOLICITUD_DOCUMENTOS_ID,\n            EtapaVacante::CONTRATADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_CONTRATADOS_ID,\n            EtapaVacante::DESCARTADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_DESCARTADOS_ID\n        ][$etapa->nombre] ?? null;\n\n        if (isset($plantilla_correo_id)) {\n            $plantilla_correo_etapa = $this->plantilla_correo_servicio->obtenerUno(new Request([\n                'plantilla_correo_id' => $plantilla_correo_id,\n                'empresa_id'          => $etapa_usuario->vacante->empresa_id\n            ]));\n\n            if (!is_null($plantilla_correo_etapa)) {\n                $es_etapa_fin_proceso = in_array($etapa->nombre, [\n                    EtapaVacante::CONTRATADOS_NOMBRE,\n                    EtapaVacante::DESCARTADOS_NOMBRE\n                ]);\n\n                // Si es etapa de fin de proceso y notificar_fin_proceso es true, no enviar notificación\n                if ($aplicar_validacion_fin_proceso && $es_etapa_fin_proceso && $plantilla_correo_etapa->notificar_fin_proceso) {\n                    return;\n                }\n\n                $usuario            = $etapa_usuario->usuario;\n                $vacante            = $etapa_usuario->vacante;\n                $token_acceso       = $this->token_acceso_servicio->generar($usuario->id);\n                $enlace             = request()->getSchemeAndHttpHost() . \"/control-acceso/{$token_acceso->token}?vacante_id={$vacante->id}\";\n                $usuario_informador = null;\n\n                Mail::to($usuario->email)->queue(new NotificarPostulanteVacanteMail(\n                    $usuario,\n                    $enlace,\n                    $vacante,\n                    $plantilla_correo_etapa->titulo,\n                    $plantilla_correo_etapa->contenido,\n                    $plantilla_correo_etapa->con_logo_empresa,\n                    $etapa->nombre,\n                    $usuario_informador\n                ));\n\n                // Enviar notificación de avance en el proceso\n                $usuario->notify(new NotificarAvanceProcesoNotification(\n                    $vacante->id,\n                    $vacante->nombre_vacante,\n                    $etapa->nombre,\n                    $vacante->empresa->nombre ?? 'la empresa'\n                ));\n\n                $this->repositorio->actualizar($etapa_usuario->id, ['fecha_notificacion' => now()]);\n            }\n        }\n    }\n\n    /**\n     * Enviar correo de notificación al finalizar una etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_vacante_usuario Etapa del usuario en la vacante.\n     * @param Vacante $vacante Vacante.\n     * @return void\n     * @author Jair Carvajal\n     */\n    private function enviarCorreoFinalizacionEtapa(EtapaVacanteUsuario $etapa_vacante_usuario, Vacante $vacante): void {\n        $usuario     = Auth::user();\n        $maneja_logo = file_exists(public_path('empresas-logo/' . $vacante->empresa->id)) ? '1' : null;\n\n        Mail::send(new NotificarFinalizacionEtapaMail(\n            $usuario,\n            $vacante,\n            $etapa_vacante_usuario->etapa,\n            $maneja_logo\n        ));\n    }\n\n    /**\n     * Obtener candidatos recomendados con IA.\n     *\n     * Obtiene los 3 mejores candidatos para la vacante, entre varios candidatos seleccionados por el reclutador.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function obtenerCandidatosRecomendadosIA(Request $request): array {\n        $vacante       = $this->vacante_repositorio->getUno($request->vacante_id);\n        $candidatos    = $this->usuario_repositorio->obtenerCandidatosSeleccionadosVacante($request->usuarios_ids, $request->vacante_id);\n        $candidatos_ia = [];\n        $vacante_ia    = [\n            ...Arr::only($vacante->toArray(), ['nombre_vacante', 'salario', 'salario_maximo']),\n            'habilidades'               => $vacante->datos->first(fn($item) => $item->llave === 'habilidades')->valor,\n            'herramientas_tecnologicas' => $vacante->datos->first(fn($item) => $item->llave === 'herramientas_tecnologicas')->valor,\n            'experiencia_laboral'       => $vacante->datos->first(fn($item) => $item->llave === 'experiencia_laboral')->valor,\n            'nivel_educativo'           => $vacante->datos->first(fn($item) => $item->llave === 'nivel_educativo')->valor\n        ];\n\n        if (!is_null($vacante->ciudad_id)) {\n            $direccion_trabajo = $vacante->datos->first(fn($item) => $item->llave === 'direccion_trabajo')->valor;\n            $ubicacion_empresa = \"{$vacante->ciudad->departamento->pais->nombre}, {$vacante->ciudad->departamento->nombre} - {$vacante->ciudad->nombre}, {$direccion_trabajo}\";\n        } elseif (!is_null($vacante->empresa->ciudad_id)) {\n            $ubicacion_empresa = \"{$vacante->empresa->ciudad->departamento->pais->nombre}, {$vacante->empresa->ciudad->departamento->nombre} - {$vacante->empresa->ciudad->nombre}, {$vacante->empresa->direccion}\";\n        }\n\n        if (isset($ubicacion_empresa)) {\n            $vacante_ia['ubicacion'] = $ubicacion_empresa;\n        }\n\n        foreach ($candidatos as $candidato) {\n            if (!is_null($candidato->ciudad_id) && !is_null($candidato->direccion)) {\n                $ubicacion = \"{$candidato->ciudad->departamento->pais->nombre}, {$candidato->ciudad->departamento->nombre} - {$candidato->ciudad->nombre}, {$candidato->direccion}\";\n            }\n\n            $usuario = [\n                ...Arr::only($candidato->toArray(), ['id', 'nombre_completo', 'email', 'telefono', 'edad']),\n                'adecuacion' => $this->obtenerAdecuacionUsuario($candidato->id, $request->vacante_id)\n            ];\n\n            if (isset($ubicacion)) {\n                $usuario['ubicacion'] = $ubicacion;\n            }\n\n            if (!is_null($candidato->perfilLaboral)) {\n                $usuario['salario']                   = $candidato->perfilLaboral->salario;\n                $usuario['salario_maximo']            = $candidato->perfilLaboral->salario_maximo;\n                $usuario['habilidades']               = $candidato->perfilLaboral->habilidades;\n                $usuario['herramientas_tecnologicas'] = $candidato->perfilLaboral->herramientas_tecnologicas;\n                $usuario['estudios']                  = [];\n                $usuario['experiencias_laborales']    = [];\n                $usuario['idiomas']                   = [];\n                $usuario['etapas']                    = [];\n\n                foreach ($candidato->perfilLaboral->estudios as $item) {\n                    array_push($usuario['estudios'], [\n                        ...Arr::only($item->toArray(), ['titulo', 'fecha_inicio', 'fecha_fin']),\n                        'nivel_educativo' => $item->nivelEducativo->nombre,\n                    ]);\n                }\n\n                foreach ($candidato->perfilLaboral->experienciasLaborales as $item) {\n                    array_push($usuario['experiencias_laborales'], [...Arr::only($item->toArray(), ['empresa', 'cargo', 'fecha_inicio', 'fecha_fin', 'tiempo'])]);\n                }\n\n                foreach ($candidato->perfilLaboral->idiomas as $item) {\n                    array_push($usuario['idiomas'], [\n                        'idioma' => $item->idioma->nombre,\n                        'nivel'  => $item->nivel\n                    ]);\n                }\n\n                foreach ($candidato->etapasUsuarios as $item) {\n                    $datos_etapas = [\n                        'nombre'      => $item->etapa->nombre,\n                        'puntaje'     => $item->puntaje,\n                        'puntaje_ia'  => $item->puntaje_ia,\n                        'comentarios' => $item->comentarios->pluck('comentario')->values()->toArray()\n                    ];\n\n                    if ($item->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE) {\n                        $agendas = $this->agenda_repositorio->getTodo(new Request([\n                            'proceso_id'         => $vacante->proceso->id,\n                            'evaluado_id'        => $item->usuario_id,\n                            'estado_id'          => EstadoAgenda::FINALIZADA_ID,\n                            'incluir_resultados' => true\n                        ]));\n\n                        $datos_etapas['pruebas_psicometricas'] = [];\n\n                        foreach ($agendas as $agenda) {\n                            array_push($datos_etapas['pruebas_psicometricas'], [\n                                'prueba'     => $agenda->prueba->nombre,\n                                'ajuste'     => $agenda->ajuste,\n                                'resultados' => $agenda->resultados->map(function ($resultado) {\n                                    return [\n                                        'dimension' => $resultado->dimension->nombre,\n                                        'puntaje'   => $resultado->puntaje_transformado\n                                    ];\n                                })->values()->toArray()\n                            ]);\n                        }\n\n                        if (count($datos_etapas['pruebas_psicometricas']) === 0) {\n                            unset($datos_etapas['pruebas_psicometricas']);\n                        }\n                    }\n\n                    array_push($usuario['etapas'], $datos_etapas);\n                }\n            }\n\n            array_push($candidatos_ia, $usuario);\n        }\n\n        return $this->realizarPeticionIA('obtener-candidatos-recomendados', [\n            'vacante_id' => $request->vacante_id,\n            'vacante'    => json_encode($vacante_ia, JSON_UNESCAPED_UNICODE),\n            'candidatos' => json_encode($candidatos_ia, JSON_UNESCAPED_UNICODE)\n        ]);\n    }\n\n    /**\n     * Obtener competencias por mejorar para usuario que será contratado.\n     * SOLO Buscar agendas de TenDisc Plus (12) y Potencial Comercial (7)\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return array\n     * @author Sergio Vargas\n     */\n    public function obtenerCompetenciasPorMejorar(int $id): array {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n        $usuario_id = $etapa_vacante_usuario->usuario_id;\n        $proceso = $etapa_vacante_usuario->vacante->proceso;\n\n        if (is_null($proceso)) {\n            return ['pruebas' => []];\n        }\n\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id' => $proceso->id,\n            'evaluado_id' => $usuario_id,\n            'pruebas_ids' => [12, 7],\n            'estado_id' => 3,\n            'con_evaluado' => true\n        ]));\n\n        $resultado = ['pruebas' => []];\n\n        foreach ($agendas as $agenda) {\n            $competencias_bajas = $this->extraerCompetenciasBajas($agenda);\n\n            if (!empty($competencias_bajas)) {\n                $resultado['pruebas'][] = [\n                    'prueba_id' => $agenda->prueba_id,\n                    'nombre_prueba' => $agenda->prueba->nombre,\n                    'competencias' => $competencias_bajas\n                ];\n            }\n        }\n\n        return $resultado;\n    }\n\n    /**\n     * Extraer las 2 competencias más bajas de una agenda según su prueba.\n     *\n     * @param \\App\\Models\\Agendas\\Agenda $agenda Agenda finalizada.\n     * @return array\n     * @author Sergio Vargas\n     */\n    private function extraerCompetenciasBajas($agenda): array {\n        $resultados = $this->resultado_agenda_servicio->gestionarResultados($agenda);\n\n        if (empty($resultados)) {\n            return [];\n        }\n\n        $competencias_todas = [];\n\n        // TenDisc Plus (prueba_id = 12)\n        if ($agenda->prueba_id === 12) {\n            $factor_especificas = collect($resultados)->firstWhere('nombre', 'Competencias Específicas');\n            $factor_transversales = collect($resultados)->firstWhere('nombre', 'Competencias Transversales');\n\n            if ($factor_especificas) {\n                $competencias_todas = array_merge($competencias_todas, $factor_especificas['dimensiones']);\n            }\n            if ($factor_transversales) {\n                $competencias_todas = array_merge($competencias_todas, $factor_transversales['dimensiones']);\n            }\n        }\n\n        // Potencial Comercial (prueba_id = 7)\n        if ($agenda->prueba_id === 7) {\n            $factor_caracter = collect($resultados)->firstWhere('nombre', 'Carácter');\n            $factor_habilidades = collect($resultados)->firstWhere('nombre', 'Habilidades');\n\n            if ($factor_caracter) {\n                $competencias_todas = array_merge($competencias_todas, $factor_caracter['dimensiones']);\n            }\n            if ($factor_habilidades) {\n                $competencias_todas = array_merge($competencias_todas, $factor_habilidades['dimensiones']);\n            }\n        }\n\n        // Ordenar por puntaje ascendente y tomar las 2 más bajas\n        return collect($competencias_todas)\n            ->sortBy('puntaje_transformado')\n            ->take(2)\n            ->map(fn($c) => [\n                'nombre' => $c['nombre'],\n                'puntaje' => round($c['puntaje_transformado'], 0)\n            ])\n            ->values()\n            ->toArray();\n    }\n}\n","structuredPatch":[{"oldStart":534,"oldLines":13,"newStart":534,"newLines":14,"lines":["      *","      * @param int $id ID de la etapa del usuario en la vacante.","      * @param int $puntaje Puntaje dado por el reclutador.","+     * @param bool $forzar_actualizacion Si es true, omite la validación de puntaje nulo.","      * @return void","      * @author Daniel Beltrán","      */","-    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {","+    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {","         $etapa_usuario = $this->repositorio->getUno($id);"," ","-        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {","+        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {","             if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {","                 $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');","             }"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"ac06d5b8-8ad1-455a-99c0-0112e1124481","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01C5yw6Gj1ntvRNTLJjjWvSy","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. He modificado la función `guardarPuntajeAdecuacionReclutador` con los siguientes cambios:\n\n## Cambios realizados:\n\n1. **Nuevo parámetro `$forzar_actualizacion`**: Agregué un tercer parámetro booleano con valor por defecto `false`\n   \n2. **Modificación de la validación**: La condición ahora es:\n   ```php\n   if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje)))\n   ```\n\n3. **Actualización del DocBlock**: Añadí la documentación del nuevo parámetro\n\n## Comportamiento:\n\n- **Por defecto (`$forzar_actualizacion = false`)**: La función mantiene su comportamiento original, aplicando la validación `is_null($etapa_usuario->puntaje)`\n\n- **Cuando se pasa `true`**: La validación de puntaje nulo se omite, permitiendo actualizar el puntaje incluso si ya existe uno\n\n## Uso:\n\n```php\n// Comportamiento normal (solo actualiza si puntaje es null)\n$this->guardarPuntajeAdecuacionReclutador($id, $puntaje);\n\n// Forzar actualización (omite validación de puntaje null)\n$this->guardarPuntajeAdecuacionReclutador($id, $puntaje, true);\n```"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1177,"cache_read_input_tokens":49012,"cache_creation":{"ephemeral_5m_input_tokens":1177,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWvC49vUjf6esRzgCsYmU","type":"assistant","uuid":"480a55e7-b65a-46ad-9936-0877d9ba450f","timestamp":"2026-01-08T16:01:51.947Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-08T21:31:16.646Z","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8"}
{"type":"file-history-snapshot","messageId":"023aacca-7afe-440f-aced-4e6521ea83b1","snapshot":{"messageId":"023aacca-7afe-440f-aced-4e6521ea83b1","trackedFileBackups":{"app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php":{"backupFileName":"5419cff174eb966b@v2","version":2,"backupTime":"2026-01-08T21:31:18.886Z"}},"timestamp":"2026-01-08T21:31:18.866Z"},"isSnapshotUpdate":false}
{"parentUuid":"480a55e7-b65a-46ad-9936-0877d9ba450f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 110 to 110 from c:\\laragon\\www\\psicoalianza-2\\resources\\views\\mis-pruebas\\aplicantes\\modales\\modal-aplicacion-revision-hv.blade.php:\nmodalidad_trabajo_id_\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"analiza este archivo resources\\views\\mis-pruebas\\aplicantes\\modales\\modal-aplicacion-revision-hv.blade.php y agrege la aprte de modalidad de trabajo pero no se cequea con lo quue bine del back  que lelga asi {\n    \"data\": {\n        \"id\": 6,\n        \"usuario_id\": 25,\n        \"modalidad_trabajo_id\": 3,\n        \"salario\": 3541545,\n        \"salario_maximo\": 45664664,\n        \"habilidades\": \"Precisi\\u00f3n, organizaci\\u00f3n, cumplimiento estricto de procedimientos\",\n        \"herramientas_tecnologicas\": \"HPLC, UV-VIS, FTIR, LIMS\",\n        \"licencia_conducir\": null,\n        \"experiencias_laborales\": ["}]},"uuid":"023aacca-7afe-440f-aced-4e6521ea83b1","timestamp":"2026-01-08T21:31:18.816Z"}
{"parentUuid":"023aacca-7afe-440f-aced-4e6521ea83b1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015a3xbGBWnMN1XirPeuwUeZ","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a analizar el archivo para entender la estructura y corregir el problema con la modalidad de trabajo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":53015,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":53015,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWvdBtiKQ6bQh4TEDcv45","type":"assistant","uuid":"12ac1c5b-fce4-4875-ad8f-14f5bc03139b","timestamp":"2026-01-08T21:31:23.043Z"}
{"parentUuid":"12ac1c5b-fce4-4875-ad8f-14f5bc03139b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015a3xbGBWnMN1XirPeuwUeZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KDc2GesRkoTveJqUKtwrSi","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\resources\\views\\mis-pruebas\\aplicantes\\modales\\modal-aplicacion-revision-hv.blade.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":53015,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":53015,"ephemeral_1h_input_tokens":0},"output_tokens":123,"service_tier":"standard"}},"requestId":"req_011CWvdBtiKQ6bQh4TEDcv45","type":"assistant","uuid":"16537c15-1eb8-401e-ad21-1048fd08cfcb","timestamp":"2026-01-08T21:31:23.654Z"}
{"parentUuid":"16537c15-1eb8-401e-ad21-1048fd08cfcb","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KDc2GesRkoTveJqUKtwrSi","type":"tool_result","content":"     1→${crearModal({\n     2→    id: 'modal-aplicacion-revision-hv',\n     3→    titulo_header: 'Completar y verificar hoja de vida',\n     4→    dialog_class: 'modal-xl modal-dialog-centered modal-dialog-scrollable',\n     5→    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n     6→    modal_body: `\n     7→        <div class=\"mb-3 d-none\" id=\"alerta-ia-revision-hv\">\n     8→            ${crearAlerta('info', 'Ahora crearás tu perfil laboral, puedes agregar una hoja de vida para que se completen tus datos automáticamente con IA o puedes completarlos manualmente.')}\n     9→        </div>\n    10→\n    11→        <form id=\"formulario-revision-hv\" action=\"/perfiles-laborales\">\n    12→            @csrf\n    13→            <input type=\"hidden\" id=\"id\" name=\"id\">\n    14→            <input type=\"hidden\" id=\"revision_hv_usuario_id\" name=\"usuario_id\" value=\"{{ auth()->user()->id }}\">\n    15→            <input type=\"hidden\" id=\"revision_hv_etapa_vacante_usuario_id\" name=\"etapa_vacante_usuario_id\">\n    16→            <input type=\"hidden\" id=\"revision_hv_vacante_id\">\n    17→            <input type=\"hidden\" id=\"revision_hv_etapa_id\">\n    18→            <input type=\"hidden\" id=\"revision_hv_habilidades\" name=\"habilidades\">\n    19→            <input type=\"hidden\" id=\"revision_hv_herramientas_tecnologicas\" name=\"herramientas_tecnologicas\">\n    20→            <input type=\"hidden\" id=\"revision_hv_idiomas\" name=\"idiomas\">\n    21→            <input type=\"hidden\" id=\"revision_hv_estudios\" name=\"estudios\">\n    22→            <input type=\"hidden\" id=\"revision_hv_experiencias_laborales\" name=\"experiencias_laborales\">\n    23→            <input type=\"hidden\" id=\"revision_hv_discapacidades\" name=\"discapacidades\">\n    24→\n    25→            <div class=\"col-12 mb-4\">\n    26→                <div class=\"row align-items-end\">\n    27→                    <div class=\"col-12 mt-3 mb-1\">\n    28→                        Adjuntar hoja de vida (Opcional)\n    29→                    </div>\n    30→                    <div class=\"col-12 mt-1\">\n    31→                        ${crearInputFile({\n    32→                            id: 'hv_archivo',\n    33→                            name: 'hoja_vida',\n    34→                            placeholder: '',\n    35→                            required: false,\n    36→                            accept: 'application/pdf, image/jpeg, image/png',\n    37→                        })}\n    38→                    </div>\n    39→                </div>\n    40→            </div>\n    41→\n    42→            <div class=\"col-12 d-none\" id=\"contenedor-campos-perfil-revision\">\n    43→                <div class=\"row\">\n    44→                    <div class=\"col-12 ps-3 py-2\">\n    45→                        <div class=\"col-12 p-4 border rounded-3\">\n    46→                            <div class=\"row align-items-center\">\n    47→                                <div class=\"col fw-semibold text-headline-5 text-gray-10\">\n    48→                                    Nivel educativo\n    49→                                </div>\n    50→                                <div class=\"col-auto\">\n    51→                                    ${crearBoton({\n    52→                                        clases: 'btn-tonal-primary justify-content-center px-7',\n    53→                                        texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar nivel educativo`,\n    54→                                        type: 'button',\n    55→                                        onclick: `abrirModalNivelEducativoRevision()`\n    56→                                    })}\n    57→                                </div>\n    58→                                <div class=\"col-12\">\n    59→                                    <div class=\"row m-0 w-100\" id=\"contenedor-niveles-educativos-revision\"></div>\n    60→                                </div>\n    61→                            </div>\n    62→                        </div>\n    63→                    </div>\n    64→\n    65→                    <div class=\"col-12 ps-3 py-2\">\n    66→                        <div class=\"col-12 p-4 border rounded-3\">\n    67→                            <div class=\"row align-items-center\">\n    68→                                <div class=\"col\">\n    69→                                    <div class=\"row align-items-center\">\n    70→                                        <div class=\"col-12 fw-semibold text-headline-5 text-gray-10\">\n    71→                                            Experiencia laboral\n    72→                                        </div>\n    73→                                        <div class=\"col-auto text-label-1 mt-2\">\n    74→                                            No tengo experiencia laboral\n    75→                                        </div>\n    76→                                        <div class=\"col fw-bold mt-2\">\n    77→                                            ${crearToggle({\n    78→                                                id: 'revision_no_experiencia',\n    79→                                                name: 'no_experiencia',\n    80→                                                value: '0',\n    81→                                                checked: false,\n    82→                                                onchange: 'seleccionarNoTengoExperienciaRevision(this.checked)',\n    83→                                            })}\n    84→                                        </div>\n    85→                                    </div>\n    86→                                </div>\n    87→                                <div class=\"col-auto\">\n    88→                                    ${crearBoton({\n    89→                                        id: 'btn-agregar-experiencia-laboral-revision',\n    90→                                        clases: 'btn-tonal-primary justify-content-center',\n    91→                                        texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar experiencia laboral`,\n    92→                                        onclick: `abrirModalExperienciaLaboralRevision();`\n    93→                                    })}\n    94→                                </div>\n    95→                                <div class=\"col-12\">\n    96→                                    <div class=\"row m-0 w-100\" id=\"contenedor-experiencias-laborales-revision\"></div>\n    97→                                </div>\n    98→                            </div>\n    99→                        </div>\n   100→                    </div>\n   101→\n   102→                    <div class=\"col-12 ps-3 py-2\">\n   103→                        <div class=\"card shadow-sm\">\n   104→                            <div class=\"card-body\">\n   105→                                <div class=\"text-headline-6 text-gray-10 fw-semibold\">Modalidad de trabajo</div>\n   106→                                <div class=\"row mt-2\">\n   107→                                    @foreach ($modalidades_trabajos as $item)\n   108→                                        <div class=\"col-auto\">\n   109→                                            ${crearRadioButton({\n   110→                                                id: 'modalidad_trabajo_id_{{ $item->id }}',\n   111→                                                name: 'modalidad_trabajo_id',\n   112→                                                value: '{{ $item->id }}',\n   113→                                                label: '{{ $item->nombre }}',\n   114→                                                @if (isset($vacante))\n   115→                                                    @if ($vacante->modalidad_trabajo_id == $item->id)\n   116→                                                        checked: true,\n   117→                                                    @endif\n   118→                                                @else\n   119→                                                    @if ($item->id == 1)\n   120→                                                        checked: true,\n   121→                                                    @endif\n   122→                                                @endif\n   123→                                            })}\n   124→                                        </div>\n   125→                                    @endforeach\n   126→                                </div>\n   127→                            </div>\n   128→                        </div>\n   129→                    </div>\n   130→\n   131→                    <div class=\"col-12 mb-5 mt-2\">\n   132→                        <div class=\"rounded-3 p-3 border\">\n   133→                            <div class=\"col-12 pb-2\">\n   134→                                <div class=\"row\">\n   135→                                    <div class=\"col-12\">\n   136→                                        <label class=\"form-label text-gray-10 fw-semibold\">Salario</label>\n   137→                                    </div>\n   138→                                    <div class=\"col-auto\">\n   139→                                        ${crearRadioButton({\n   140→                                            id: 'revision_salario_especifico',\n   141→                                            name: 'tipo_salario',\n   142→                                            class: 'input-dinamico',\n   143→                                            value: 'especifico',\n   144→                                            label: 'Específico',\n   145→                                            checked: false,\n   146→                                            onchange: `seleccionarSalarioRevision(this.value)`,\n   147→                                        })}\n   148→                                    </div>\n   149→                                    <div class=\"col-auto\">\n   150→                                        ${crearRadioButton({\n   151→                                            id: 'revision_salario_rango',\n   152→                                            name: 'tipo_salario',\n   153→                                            class: 'input-dinamico',\n   154→                                            value: 'rango',\n   155→                                            label: 'Rango',\n   156→                                            checked: true,\n   157→                                            onchange: `seleccionarSalarioRevision(this.value)`,\n   158→                                        })}\n   159→                                    </div>\n   160→                                </div>\n   161→                                <div class=\"col-12\">\n   162→                                    <div class=\"row mt-3\" id=\"contenedor-campos-salario-revision\">\n   163→                                        <div class=\"col-12 col-md-6\">\n   164→                                            ${crearInput({\n   165→                                                id: 'revision_salario',\n   166→                                                name: 'salario',\n   167→                                                class: 'cleave',\n   168→                                                input_container_class: 'mb-0',\n   169→                                                label: 'Desde',\n   170→                                                placeholder: '',\n   171→                                                step: 0.01,\n   172→                                                required: true,\n   173→                                                minlength: 3,\n   174→                                                maxlength: 10,\n   175→                                                onkeyup: `validarRangoSalarioRevision()`,\n   176→                                                data: [{\n   177→                                                    texto: 'simbolo-cleave',\n   178→                                                    value: ''\n   179→                                                }],\n   180→                                                icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   181→                                            })}\n   182→                                        </div>\n   183→                                        <div class=\"col-12 col-md-6\">\n   184→                                            ${crearInput({\n   185→                                                id: 'revision_salario_maximo',\n   186→                                                name: 'salario_maximo',\n   187→                                                class: 'cleave',\n   188→                                                input_container_class: 'mb-0',\n   189→                                                label: 'Hasta',\n   190→                                                placeholder: '',\n   191→                                                min: 0,\n   192→                                                step: 0.01,\n   193→                                                required: true,\n   194→                                                minlength: 3,\n   195→                                                maxlength: 10,\n   196→                                                onkeyup: `validarRangoSalarioRevision()`,\n   197→                                                data: [{\n   198→                                                    texto: 'simbolo-cleave',\n   199→                                                    value: ''\n   200→                                                }],\n   201→                                                icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   202→                                            })}\n   203→                                        </div>\n   204→                                    </div>\n   205→                                </div>\n   206→                            </div>\n   207→                        </div>\n   208→                    </div>\n   209→\n   210→                    <div class=\"col-12\">\n   211→                        <div class=\"d-flex align-items-center gap-2 mb-1\">\n   212→                            <label for=\"revision_select_habilidades\" class=\"text-headline-5 text-gray-10 fw-semibold mb-0\">Habilidades</label>\n   213→                            <i class=\"bi bi-info-circle pointer\" role=\"button\" tabindex=\"0\"\n   214→                                ${crearTooltip({\n   215→                                    placement: 'top',\n   216→                                    content: 'Menciona las habilidades que te destacan profesionalmente, como tus fortalezas técnicas, creativas o interpersonales.'\n   217→                                })}></i>\n   218→                        </div>\n   219→                        <p class=\"text-body-3 text-gray-30 mb-3\">Añade tus habilidades o herramientas escribiéndolas y presionando enter para crear la etiqueta.</p>\n   220→                        ${crearSelect2({\n   221→                            id: 'revision_select_habilidades',\n   222→                            name: 'revision_select_habilidades',\n   223→                            class: 'crear-chips input-dinamico',\n   224→                            opciones: [],\n   225→                            multiple: true,\n   226→                            required: true,\n   227→                            adicional: 'data-placeholder=\"Escribe y presiona Enter\"'\n   228→                        })}\n   229→                    </div>\n   230→\n   231→                    <div class=\"col-12\">\n   232→                        <div class=\"d-flex align-items-center gap-2 mb-1\">\n   233→                            <label for=\"revision_select_herramientas_tecnologicas\" class=\"text-headline-5 text-gray-10 fw-semibold mb-0\">Herramientas tecnológicas</label>\n   234→                            <i class=\"bi bi-info-circle pointer\" role=\"button\" tabindex=\"0\"\n   235→                                ${crearTooltip({\n   236→                                    placement: 'top',\n   237→                                    content: 'Menciona los programas, plataformas o lenguajes que utilizas con frecuencia.'\n   238→                                })}></i>\n   239→                        </div>\n   240→                        ${crearSelect2({\n   241→                            id: 'revision_select_herramientas_tecnologicas',\n   242→                            name: 'revision_select_herramientas_tecnologicas',\n   243→                            class: 'crear-chips input-dinamico',\n   244→                            opciones: [],\n   245→                            multiple: true,\n   246→                            required: true,\n   247→                            adicional: 'data-placeholder=\"Escribe y presiona Enter\"'\n   248→                        })}\n   249→                    </div>\n   250→\n   251→                    <label class=\"text-headline-5 text-gray-10 fw-semibold mb-0 mt-4\">Información adicional</label>\n   252→                    <div class=\"col-12 my-3\">\n   253→                        ${crearAlerta('info', 'Esta sección es opcional. Puedes completarla si deseas incluir información adicional')}\n   254→                    </div>\n   255→\n   256→                    <div class=\"col-12 mb-5\">\n   257→                        <div class=\"rounded-2 p-3 border\">\n   258→                            <div class=\"text-headline-6 text-gray-10 fw-semibold\">Idioma</div>\n   259→                            <div class=\"row mt-2 pb-2\">\n   260→                                <div class=\"col-12\">\n   261→                                    ${crearMultiselect({\n   262→                                        opciones: [\n   263→                                            {'id': 1, 'nombre': 'Inglés'},\n   264→                                            {'id': 2, 'nombre': 'Portugués'},\n   265→                                            {'id': 3, 'nombre': 'Francés'},\n   266→                                            {'id': 4, 'nombre': 'Alemán'},\n   267→                                            {'id': 5, 'nombre': 'Mandarín'},\n   268→                                            {'id': 6, 'nombre': 'Italiano'},\n   269→                                            {'id': 7, 'nombre': 'Ruso'},\n   270→                                            {'id': 8, 'nombre': 'Árabe'},\n   271→                                        ],\n   272→                                        id: 'revision_idiomas_seleccionados',\n   273→                                        name: 'revision_idiomas_seleccionados',\n   274→                                        class: 'input-dinamico',\n   275→                                        input_container_class: 'mb-0',\n   276→                                        placeholder: 'Idiomas',\n   277→                                        onchange: 'seleccionarIdiomaRevision(this)',\n   278→                                    })}\n   279→                                </div>\n   280→                                <div class=\"col-12\">\n   281→                                    <div class=\"row mt-2\" id=\"contenedor-idiomas-revision\">\n   282→                                    </div>\n   283→                                </div>\n   284→                            </div>\n   285→                        </div>\n   286→                    </div>\n   287→\n   288→                    <div class=\"col-12 mt-3\">\n   289→                        <div class=\"row align-items-center\">\n   290→                            <div class=\"col-8 col-lg-5 col-xl-4 fw-semibold\">\n   291→                                Licencia de conducir\n   292→                            </div>\n   293→                            <div class=\"col-4 col-lg-3\">\n   294→                                ${crearToggle({\n   295→                                    id: 'revision_opcion_licencia_conducir',\n   296→                                    name: 'opcion_licencia_conducir',\n   297→                                    class: 'input-dinamico',\n   298→                                    value: true,\n   299→                                    checked: false,\n   300→                                    onchange: 'seleccionarLicenciaConducirRevision(this)',\n   301→                                })}\n   302→                            </div>\n   303→                            <div class=\"col-12 col-lg-4 col-xl-5\">\n   304→                                ${crearSelect2({\n   305→                                    opciones: [\n   306→                                        {id: 'A1', nombre: 'A1'},\n   307→                                        {id: 'A2', nombre: 'A2'},\n   308→                                        {id: 'B1', nombre: 'B1'},\n   309→                                        {id: 'B2', nombre: 'B2'},\n   310→                                        {id: 'B3', nombre: 'B3'},\n   311→                                        {id: 'C1', nombre: 'C1'},\n   312→                                        {id: 'C2', nombre: 'C2'},\n   313→                                        {id: 'C3', nombre: 'C3'},\n   314→                                    ],\n   315→                                    id: 'revision_tipo_licencia',\n   316→                                    name: 'licencia_conducir',\n   317→                                    input_container_class: 'mb-0',\n   318→                                    label: 'Tipo',\n   319→                                    required: true,\n   320→                                    disabled: true,\n   321→                                })}\n   322→                            </div>\n   323→                        </div>\n   324→                    </div>\n   325→\n   326→                    <div class=\"col-8 col-lg-5 col-xl-4 mt-5 fw-semibold\">\n   327→                        Tengo una discapacidad\n   328→                    </div>\n   329→                    <div class=\"col-4 col-lg-7 col-xl-8 mt-5 mb-5\">\n   330→                        ${crearToggle({\n   331→                            id: 'revision_vacante_apta_discapacitados',\n   332→                            name: 'vacante_apta_discapacitados',\n   333→                            class: 'input-dinamico',\n   334→                            value: true,\n   335→                            checked: false,\n   336→                            onchange: `seleccionarTengoDiscapacidadRevision(this.checked)`\n   337→                        })}\n   338→                    </div>\n   339→                    <div class=\"col-12\">\n   340→                        <div class=\"row w-100 mx-0\" id=\"contenedor-discapacidad-revision\"></div>\n   341→                    </div>\n   342→                </div>\n   343→            </div>\n   344→\n   345→            <div class=\"col-12\" id=\"contenedor-opciones-crear-ia-revision\">\n   346→                <div class=\"row\">\n   347→                    <div class=\"col-12\">\n   348→                        <div class=\"row align-itens-center\">\n   349→                            <div class=\"col py-5\"><hr class=\"m-0 border-3\"></div>\n   350→                            <div class=\"col-auto pt-3 text-label-1 text-black\">O</div>\n   351→                            <div class=\"col py-5\"><hr class=\"m-0 border-3\"></div>\n   352→                        </div>\n   353→                    </div>\n   354→                    <div class=\"col-12 mt-3\">\n   355→                        ${crearBoton({\n   356→                            id: 'btn-crear-perfil-ia-revision',\n   357→                            clases: 'btn-tonal-primary justify-content-center w-100',\n   358→                            texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar manualmente`,\n   359→                            disabled: false,\n   360→                            type: 'button',\n   361→                            onclick: 'crearPerfilManualmenteRevision()',\n   362→                        })}\n   363→                    </div>\n   364→                </div>\n   365→            </div>\n   366→\n   367→            <div class=\"col-12 mt-5\">\n   368→                <div class=\"row justify-content-center gap-3\">\n   369→                    <div class=\"col-auto\">\n   370→                        ${crearBoton({\n   371→                            type: 'button',\n   372→                            texto: 'Cancelar',\n   373→                            clases: 'btn-outline-primary justify-content-center px-7',\n   374→                            onclick: 'cerrarModalRevisionHV()',\n   375→                        })}\n   376→                    </div>\n   377→                    <div class=\"col-auto\">\n   378→                        ${crearBoton({\n   379→                            id: 'btn-guardar-hv',\n   380→                            type: 'submit',\n   381→                            texto: 'Guardar y enviar',\n   382→                            clases: 'btn-primary justify-content-center px-7',\n   383→                        })}\n   384→                    </div>\n   385→                </div>\n   386→            </div>\n   387→        </form>\n   388→    `\n   389→})}\n   390→\n   391→${crearModal({\n   392→    id: 'modal-generando-ia-revision',\n   393→    dialog_class: 'modal-md modal-dialog-centered',\n   394→    adiconales_modals_header: `data-bs-backdrop=\"static\"`,\n   395→    header_cerrar: 'd-none',\n   396→    titulo_header: 'Generando...',\n   397→    modal_body: `\n   398→        <div class=\"col-12\">\n   399→            <div class=\"row justify-content-center\">\n   400→                <div class=\"col-4\">\n   401→                    <img class=\"w-100\" src=\"{{ asset('/imagenes/gifs/cargue-ia.gif') }}\">\n   402→                </div>\n   403→            </div>\n   404→        </div>\n   405→    `\n   406→})}\n   407→\n   408→${crearModal({\n   409→    id: 'modal-agregar-nivel-educativo',\n   410→    dialog_class: 'modal-lg modal-dialog-centered',\n   411→    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n   412→    titulo_header: '<span class=\"text-gray-10 fw-semibold\">Agregar nivel educativo</span>',\n   413→    boton_footer1: {\n   414→        type: 'button',\n   415→        texto: 'Cancelar',\n   416→        class: 'btn-outline-primary',\n   417→        cerrar_modal: true,\n   418→    },\n   419→    boton_footer2: {\n   420→        type: 'submit',\n   421→        texto: 'Agregar nivel educativo',\n   422→        class: 'btn-primary',\n   423→        form: 'formulario-nivel-educativo',\n   424→    },\n   425→    modal_body: `\n   426→        <form id=\"formulario-nivel-educativo\" class=\"px-4\" action=\"/nivel-educativo\">\n   427→            @csrf\n   428→            <div class=\"row\">\n   429→                <div class=\"col-12\">\n   430→                    ${crearInput({\n   431→                        id: 'titulo',\n   432→                        name: 'titulo',\n   433→                        maxlength: 50,\n   434→                        required: true,\n   435→                        autocomplete: 'off',\n   436→                        label: 'Título',\n   437→                    })}\n   438→                </div>\n   439→                <div class=\"col-12 col-lg-6\">\n   440→                    ${crearInput({\n   441→                        id: 'institucion_educativa',\n   442→                        name: 'institucion_educativa',\n   443→                        input_container_class: 'mb-6',\n   444→                        maxlength: 50,\n   445→                        required: true,\n   446→                        autocomplete: 'off',\n   447→                        label: 'Institución educativa',\n   448→                    })}\n   449→                </div>\n   450→                <div class=\"col-12 col-lg-6\">\n   451→                    ${crearSelect2({\n   452→                        id: 'nivel_educativo_id',\n   453→                        opciones: @json($niveles_educativos),\n   454→                        name: 'nivel_educativo_id',\n   455→                        label: 'Nivel educativo',\n   456→                        placeholder: 'Nivel educativo',\n   457→                        required: true,\n   458→                        buscador: false\n   459→                    })}\n   460→                </div>\n   461→                <div class=\"col-5 text-headline-6 fw-semibold\">\n   462→                    Estoy cursando estos estudios\n   463→                </div>\n   464→                <div class=\"col-7 mb-5\">\n   465→                    ${crearToggle({\n   466→                        id: 'cursando_estudios',\n   467→                        name: 'graduado_cursando_estudios',\n   468→                        value: 'cursando',\n   469→                        checked: false,\n   470→                        onchange: 'seleccionarGraduadoCursando(this.checked)',\n   471→                    })}\n   472→                </div>\n   473→                <div class=\"col-12\" id=\"fechas-cursando-estudios\">\n   474→                    <div class=\"row align-items-center\">\n   475→                        <div class=\"col-12 col-md-6 mt-2\">\n   476→                            ${crearSelectorMesAnio({\n   477→                                id: 'fecha_inicio_estudio',\n   478→                                name: 'fecha_inicio_estudio',\n   479→                                placeholder: 'mm/yyyy',\n   480→                                disabled: false,\n   481→                                required: true,\n   482→                                input_container_class: 'mb-4',\n   483→                                label: 'Fecha de inicio',\n   484→                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n   485→                            })}\n   486→                        </div>\n   487→                        <div class=\"col-12 col-md-6 mt-2\">\n   488→                            ${crearSelectorMesAnio({\n   489→                                id: 'fecha_fin_estudio',\n   490→                                name: 'fecha_fin_estudio',\n   491→                                placeholder: 'mm/yyyy',\n   492→                                disabled: false,\n   493→                                required: true,\n   494→                                input_container_class: 'mb-4',\n   495→                                label: 'Fecha de finalización',\n   496→                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n   497→                            })}\n   498→                        </div>\n   499→                    </div>\n   500→                </div>\n   501→            </div>\n   502→        </form>\n   503→    `\n   504→})}\n   505→\n   506→${crearModal({\n   507→    id: 'modal-agregar-experiencia-laboral',\n   508→    dialog_class: 'modal-lg modal-dialog-centered',\n   509→    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n   510→    titulo_header: '<span class=\"text-gray-10 fw-semibold\">Agregar experiencia laboral</span>',\n   511→    boton_footer1: {\n   512→        type: 'button',\n   513→        texto: 'Cancelar',\n   514→        class: 'btn-outline-primary',\n   515→        cerrar_modal: true,\n   516→    },\n   517→    boton_footer2: {\n   518→        type: 'submit',\n   519→        texto: 'Agregar experiencia laboral',\n   520→        class: 'btn-primary',\n   521→        form: 'formulario-experiencia-laboral',\n   522→    },\n   523→    modal_body: `\n   524→        <form id=\"formulario-experiencia-laboral\" class=\"px-4\" action=\"/experiencia-laboral\">\n   525→            @csrf\n   526→            <div class=\"row\">\n   527→                <div class=\"col-12\">\n   528→                    ${crearInput({\n   529→                        id: 'cargo',\n   530→                        name: 'cargo',\n   531→                        maxlength: 50,\n   532→                        required: true,\n   533→                        autocomplete: 'off',\n   534→                        label: 'Cargo',\n   535→                    })}\n   536→                </div>\n   537→                <div class=\"col-12\">\n   538→                    ${crearInput({\n   539→                        id: 'empresa',\n   540→                        name: 'empresa',\n   541→                        maxlength: 50,\n   542→                        required: true,\n   543→                        autocomplete: 'off',\n   544→                        label: 'Empresa u organización',\n   545→                    })}\n   546→                </div>\n   547→                <div class=\"col-12\">\n   548→                    ${crearSelect2({\n   549→                        opciones: [\n   550→                            {id: 1, nombre: 'Presencial'},\n   551→                            {id: 2, nombre: 'Híbrido'},\n   552→                            {id: 3, nombre: 'Remoto'}\n   553→                        ],\n   554→                        id: 'modalidad_trabajo_id',\n   555→                        name: 'modalidad_trabajo_id',\n   556→                        label: 'Modalidad de trabajo',\n   557→                        placeholder: 'Seleccionar modalidad',\n   558→                        required: false,\n   559→                    })}\n   560→                </div>\n   561→                <div class=\"col-5 text-headline-6 fw-semibold\">\n   562→                    Actualmente tengo este trabajo\n   563→                </div>\n   564→                <div class=\"col-7 mb-5\">\n   565→                    ${crearToggle({\n   566→                        id: 'actualmente_trabajo',\n   567→                        name: 'actualmente_trabajo',\n   568→                        value: true,\n   569→                        checked: false,\n   570→                        onchange: 'seleccionarActualmenteTrabajo(this.checked)',\n   571→                    })}\n   572→                </div>\n   573→                <div class=\"col-12\">\n   574→                    <div class=\"row mt-2\" id=\"fechas-trabajo-experiencia\">\n   575→                        <div class=\"col-12 col-md-6 mt-3\">\n   576→                            ${crearSelectorMesAnio({\n   577→                                id: 'fecha_inicio_experiencia',\n   578→                                name: 'fecha_inicio_experiencia',\n   579→                                placeholder: 'mm/yyyy',\n   580→                                disabled: false,\n   581→                                required: true,\n   582→                                input_container_class: 'mb-2',\n   583→                                label: 'Fecha de inicio',\n   584→                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n   585→                            })}\n   586→                        </div>\n   587→                        <div class=\"col-12 col-md-6 mt-3\">\n   588→                            ${crearSelectorMesAnio({\n   589→                                id: 'fecha_fin_experiencia',\n   590→                                name: 'fecha_fin_experiencia',\n   591→                                placeholder: 'mm/yyyy',\n   592→                                disabled: false,\n   593→                                required: true,\n   594→                                input_container_class: 'mb-2',\n   595→                                label: 'Fecha de finalización',\n   596→                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n   597→                            })}\n   598→                        </div>\n   599→                    </div>\n   600→                </div>\n   601→                <div class=\"col-12 mt-3\">\n   602→                    ${crearTextarea({\n   603→                        id: 'funciones',\n   604→                        name: 'funciones',\n   605→                        label: 'Funciones y responsabilidades',\n   606→                        placeholder: 'Describe las principales funciones y responsabilidades del cargo...',\n   607→                        maxlength: 1000,\n   608→                        rows: 4,\n   609→                        required: false,\n   610→                    })}\n   611→                </div>\n   612→            </div>\n   613→        </form>\n   614→    `\n   615→})}\n   616→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"481db489-72e8-4b52-8bcd-c9800873020d","timestamp":"2026-01-08T21:31:25.232Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\resources\\views\\mis-pruebas\\aplicantes\\modales\\modal-aplicacion-revision-hv.blade.php","content":"${crearModal({\n    id: 'modal-aplicacion-revision-hv',\n    titulo_header: 'Completar y verificar hoja de vida',\n    dialog_class: 'modal-xl modal-dialog-centered modal-dialog-scrollable',\n    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n    modal_body: `\n        <div class=\"mb-3 d-none\" id=\"alerta-ia-revision-hv\">\n            ${crearAlerta('info', 'Ahora crearás tu perfil laboral, puedes agregar una hoja de vida para que se completen tus datos automáticamente con IA o puedes completarlos manualmente.')}\n        </div>\n\n        <form id=\"formulario-revision-hv\" action=\"/perfiles-laborales\">\n            @csrf\n            <input type=\"hidden\" id=\"id\" name=\"id\">\n            <input type=\"hidden\" id=\"revision_hv_usuario_id\" name=\"usuario_id\" value=\"{{ auth()->user()->id }}\">\n            <input type=\"hidden\" id=\"revision_hv_etapa_vacante_usuario_id\" name=\"etapa_vacante_usuario_id\">\n            <input type=\"hidden\" id=\"revision_hv_vacante_id\">\n            <input type=\"hidden\" id=\"revision_hv_etapa_id\">\n            <input type=\"hidden\" id=\"revision_hv_habilidades\" name=\"habilidades\">\n            <input type=\"hidden\" id=\"revision_hv_herramientas_tecnologicas\" name=\"herramientas_tecnologicas\">\n            <input type=\"hidden\" id=\"revision_hv_idiomas\" name=\"idiomas\">\n            <input type=\"hidden\" id=\"revision_hv_estudios\" name=\"estudios\">\n            <input type=\"hidden\" id=\"revision_hv_experiencias_laborales\" name=\"experiencias_laborales\">\n            <input type=\"hidden\" id=\"revision_hv_discapacidades\" name=\"discapacidades\">\n\n            <div class=\"col-12 mb-4\">\n                <div class=\"row align-items-end\">\n                    <div class=\"col-12 mt-3 mb-1\">\n                        Adjuntar hoja de vida (Opcional)\n                    </div>\n                    <div class=\"col-12 mt-1\">\n                        ${crearInputFile({\n                            id: 'hv_archivo',\n                            name: 'hoja_vida',\n                            placeholder: '',\n                            required: false,\n                            accept: 'application/pdf, image/jpeg, image/png',\n                        })}\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"col-12 d-none\" id=\"contenedor-campos-perfil-revision\">\n                <div class=\"row\">\n                    <div class=\"col-12 ps-3 py-2\">\n                        <div class=\"col-12 p-4 border rounded-3\">\n                            <div class=\"row align-items-center\">\n                                <div class=\"col fw-semibold text-headline-5 text-gray-10\">\n                                    Nivel educativo\n                                </div>\n                                <div class=\"col-auto\">\n                                    ${crearBoton({\n                                        clases: 'btn-tonal-primary justify-content-center px-7',\n                                        texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar nivel educativo`,\n                                        type: 'button',\n                                        onclick: `abrirModalNivelEducativoRevision()`\n                                    })}\n                                </div>\n                                <div class=\"col-12\">\n                                    <div class=\"row m-0 w-100\" id=\"contenedor-niveles-educativos-revision\"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12 ps-3 py-2\">\n                        <div class=\"col-12 p-4 border rounded-3\">\n                            <div class=\"row align-items-center\">\n                                <div class=\"col\">\n                                    <div class=\"row align-items-center\">\n                                        <div class=\"col-12 fw-semibold text-headline-5 text-gray-10\">\n                                            Experiencia laboral\n                                        </div>\n                                        <div class=\"col-auto text-label-1 mt-2\">\n                                            No tengo experiencia laboral\n                                        </div>\n                                        <div class=\"col fw-bold mt-2\">\n                                            ${crearToggle({\n                                                id: 'revision_no_experiencia',\n                                                name: 'no_experiencia',\n                                                value: '0',\n                                                checked: false,\n                                                onchange: 'seleccionarNoTengoExperienciaRevision(this.checked)',\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                                <div class=\"col-auto\">\n                                    ${crearBoton({\n                                        id: 'btn-agregar-experiencia-laboral-revision',\n                                        clases: 'btn-tonal-primary justify-content-center',\n                                        texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar experiencia laboral`,\n                                        onclick: `abrirModalExperienciaLaboralRevision();`\n                                    })}\n                                </div>\n                                <div class=\"col-12\">\n                                    <div class=\"row m-0 w-100\" id=\"contenedor-experiencias-laborales-revision\"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12 ps-3 py-2\">\n                        <div class=\"card shadow-sm\">\n                            <div class=\"card-body\">\n                                <div class=\"text-headline-6 text-gray-10 fw-semibold\">Modalidad de trabajo</div>\n                                <div class=\"row mt-2\">\n                                    @foreach ($modalidades_trabajos as $item)\n                                        <div class=\"col-auto\">\n                                            ${crearRadioButton({\n                                                id: 'modalidad_trabajo_id_{{ $item->id }}',\n                                                name: 'modalidad_trabajo_id',\n                                                value: '{{ $item->id }}',\n                                                label: '{{ $item->nombre }}',\n                                                @if (isset($vacante))\n                                                    @if ($vacante->modalidad_trabajo_id == $item->id)\n                                                        checked: true,\n                                                    @endif\n                                                @else\n                                                    @if ($item->id == 1)\n                                                        checked: true,\n                                                    @endif\n                                                @endif\n                                            })}\n                                        </div>\n                                    @endforeach\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12 mb-5 mt-2\">\n                        <div class=\"rounded-3 p-3 border\">\n                            <div class=\"col-12 pb-2\">\n                                <div class=\"row\">\n                                    <div class=\"col-12\">\n                                        <label class=\"form-label text-gray-10 fw-semibold\">Salario</label>\n                                    </div>\n                                    <div class=\"col-auto\">\n                                        ${crearRadioButton({\n                                            id: 'revision_salario_especifico',\n                                            name: 'tipo_salario',\n                                            class: 'input-dinamico',\n                                            value: 'especifico',\n                                            label: 'Específico',\n                                            checked: false,\n                                            onchange: `seleccionarSalarioRevision(this.value)`,\n                                        })}\n                                    </div>\n                                    <div class=\"col-auto\">\n                                        ${crearRadioButton({\n                                            id: 'revision_salario_rango',\n                                            name: 'tipo_salario',\n                                            class: 'input-dinamico',\n                                            value: 'rango',\n                                            label: 'Rango',\n                                            checked: true,\n                                            onchange: `seleccionarSalarioRevision(this.value)`,\n                                        })}\n                                    </div>\n                                </div>\n                                <div class=\"col-12\">\n                                    <div class=\"row mt-3\" id=\"contenedor-campos-salario-revision\">\n                                        <div class=\"col-12 col-md-6\">\n                                            ${crearInput({\n                                                id: 'revision_salario',\n                                                name: 'salario',\n                                                class: 'cleave',\n                                                input_container_class: 'mb-0',\n                                                label: 'Desde',\n                                                placeholder: '',\n                                                step: 0.01,\n                                                required: true,\n                                                minlength: 3,\n                                                maxlength: 10,\n                                                onkeyup: `validarRangoSalarioRevision()`,\n                                                data: [{\n                                                    texto: 'simbolo-cleave',\n                                                    value: ''\n                                                }],\n                                                icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                                            })}\n                                        </div>\n                                        <div class=\"col-12 col-md-6\">\n                                            ${crearInput({\n                                                id: 'revision_salario_maximo',\n                                                name: 'salario_maximo',\n                                                class: 'cleave',\n                                                input_container_class: 'mb-0',\n                                                label: 'Hasta',\n                                                placeholder: '',\n                                                min: 0,\n                                                step: 0.01,\n                                                required: true,\n                                                minlength: 3,\n                                                maxlength: 10,\n                                                onkeyup: `validarRangoSalarioRevision()`,\n                                                data: [{\n                                                    texto: 'simbolo-cleave',\n                                                    value: ''\n                                                }],\n                                                icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12\">\n                        <div class=\"d-flex align-items-center gap-2 mb-1\">\n                            <label for=\"revision_select_habilidades\" class=\"text-headline-5 text-gray-10 fw-semibold mb-0\">Habilidades</label>\n                            <i class=\"bi bi-info-circle pointer\" role=\"button\" tabindex=\"0\"\n                                ${crearTooltip({\n                                    placement: 'top',\n                                    content: 'Menciona las habilidades que te destacan profesionalmente, como tus fortalezas técnicas, creativas o interpersonales.'\n                                })}></i>\n                        </div>\n                        <p class=\"text-body-3 text-gray-30 mb-3\">Añade tus habilidades o herramientas escribiéndolas y presionando enter para crear la etiqueta.</p>\n                        ${crearSelect2({\n                            id: 'revision_select_habilidades',\n                            name: 'revision_select_habilidades',\n                            class: 'crear-chips input-dinamico',\n                            opciones: [],\n                            multiple: true,\n                            required: true,\n                            adicional: 'data-placeholder=\"Escribe y presiona Enter\"'\n                        })}\n                    </div>\n\n                    <div class=\"col-12\">\n                        <div class=\"d-flex align-items-center gap-2 mb-1\">\n                            <label for=\"revision_select_herramientas_tecnologicas\" class=\"text-headline-5 text-gray-10 fw-semibold mb-0\">Herramientas tecnológicas</label>\n                            <i class=\"bi bi-info-circle pointer\" role=\"button\" tabindex=\"0\"\n                                ${crearTooltip({\n                                    placement: 'top',\n                                    content: 'Menciona los programas, plataformas o lenguajes que utilizas con frecuencia.'\n                                })}></i>\n                        </div>\n                        ${crearSelect2({\n                            id: 'revision_select_herramientas_tecnologicas',\n                            name: 'revision_select_herramientas_tecnologicas',\n                            class: 'crear-chips input-dinamico',\n                            opciones: [],\n                            multiple: true,\n                            required: true,\n                            adicional: 'data-placeholder=\"Escribe y presiona Enter\"'\n                        })}\n                    </div>\n\n                    <label class=\"text-headline-5 text-gray-10 fw-semibold mb-0 mt-4\">Información adicional</label>\n                    <div class=\"col-12 my-3\">\n                        ${crearAlerta('info', 'Esta sección es opcional. Puedes completarla si deseas incluir información adicional')}\n                    </div>\n\n                    <div class=\"col-12 mb-5\">\n                        <div class=\"rounded-2 p-3 border\">\n                            <div class=\"text-headline-6 text-gray-10 fw-semibold\">Idioma</div>\n                            <div class=\"row mt-2 pb-2\">\n                                <div class=\"col-12\">\n                                    ${crearMultiselect({\n                                        opciones: [\n                                            {'id': 1, 'nombre': 'Inglés'},\n                                            {'id': 2, 'nombre': 'Portugués'},\n                                            {'id': 3, 'nombre': 'Francés'},\n                                            {'id': 4, 'nombre': 'Alemán'},\n                                            {'id': 5, 'nombre': 'Mandarín'},\n                                            {'id': 6, 'nombre': 'Italiano'},\n                                            {'id': 7, 'nombre': 'Ruso'},\n                                            {'id': 8, 'nombre': 'Árabe'},\n                                        ],\n                                        id: 'revision_idiomas_seleccionados',\n                                        name: 'revision_idiomas_seleccionados',\n                                        class: 'input-dinamico',\n                                        input_container_class: 'mb-0',\n                                        placeholder: 'Idiomas',\n                                        onchange: 'seleccionarIdiomaRevision(this)',\n                                    })}\n                                </div>\n                                <div class=\"col-12\">\n                                    <div class=\"row mt-2\" id=\"contenedor-idiomas-revision\">\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12 mt-3\">\n                        <div class=\"row align-items-center\">\n                            <div class=\"col-8 col-lg-5 col-xl-4 fw-semibold\">\n                                Licencia de conducir\n                            </div>\n                            <div class=\"col-4 col-lg-3\">\n                                ${crearToggle({\n                                    id: 'revision_opcion_licencia_conducir',\n                                    name: 'opcion_licencia_conducir',\n                                    class: 'input-dinamico',\n                                    value: true,\n                                    checked: false,\n                                    onchange: 'seleccionarLicenciaConducirRevision(this)',\n                                })}\n                            </div>\n                            <div class=\"col-12 col-lg-4 col-xl-5\">\n                                ${crearSelect2({\n                                    opciones: [\n                                        {id: 'A1', nombre: 'A1'},\n                                        {id: 'A2', nombre: 'A2'},\n                                        {id: 'B1', nombre: 'B1'},\n                                        {id: 'B2', nombre: 'B2'},\n                                        {id: 'B3', nombre: 'B3'},\n                                        {id: 'C1', nombre: 'C1'},\n                                        {id: 'C2', nombre: 'C2'},\n                                        {id: 'C3', nombre: 'C3'},\n                                    ],\n                                    id: 'revision_tipo_licencia',\n                                    name: 'licencia_conducir',\n                                    input_container_class: 'mb-0',\n                                    label: 'Tipo',\n                                    required: true,\n                                    disabled: true,\n                                })}\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-8 col-lg-5 col-xl-4 mt-5 fw-semibold\">\n                        Tengo una discapacidad\n                    </div>\n                    <div class=\"col-4 col-lg-7 col-xl-8 mt-5 mb-5\">\n                        ${crearToggle({\n                            id: 'revision_vacante_apta_discapacitados',\n                            name: 'vacante_apta_discapacitados',\n                            class: 'input-dinamico',\n                            value: true,\n                            checked: false,\n                            onchange: `seleccionarTengoDiscapacidadRevision(this.checked)`\n                        })}\n                    </div>\n                    <div class=\"col-12\">\n                        <div class=\"row w-100 mx-0\" id=\"contenedor-discapacidad-revision\"></div>\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"col-12\" id=\"contenedor-opciones-crear-ia-revision\">\n                <div class=\"row\">\n                    <div class=\"col-12\">\n                        <div class=\"row align-itens-center\">\n                            <div class=\"col py-5\"><hr class=\"m-0 border-3\"></div>\n                            <div class=\"col-auto pt-3 text-label-1 text-black\">O</div>\n                            <div class=\"col py-5\"><hr class=\"m-0 border-3\"></div>\n                        </div>\n                    </div>\n                    <div class=\"col-12 mt-3\">\n                        ${crearBoton({\n                            id: 'btn-crear-perfil-ia-revision',\n                            clases: 'btn-tonal-primary justify-content-center w-100',\n                            texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar manualmente`,\n                            disabled: false,\n                            type: 'button',\n                            onclick: 'crearPerfilManualmenteRevision()',\n                        })}\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"col-12 mt-5\">\n                <div class=\"row justify-content-center gap-3\">\n                    <div class=\"col-auto\">\n                        ${crearBoton({\n                            type: 'button',\n                            texto: 'Cancelar',\n                            clases: 'btn-outline-primary justify-content-center px-7',\n                            onclick: 'cerrarModalRevisionHV()',\n                        })}\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearBoton({\n                            id: 'btn-guardar-hv',\n                            type: 'submit',\n                            texto: 'Guardar y enviar',\n                            clases: 'btn-primary justify-content-center px-7',\n                        })}\n                    </div>\n                </div>\n            </div>\n        </form>\n    `\n})}\n\n${crearModal({\n    id: 'modal-generando-ia-revision',\n    dialog_class: 'modal-md modal-dialog-centered',\n    adiconales_modals_header: `data-bs-backdrop=\"static\"`,\n    header_cerrar: 'd-none',\n    titulo_header: 'Generando...',\n    modal_body: `\n        <div class=\"col-12\">\n            <div class=\"row justify-content-center\">\n                <div class=\"col-4\">\n                    <img class=\"w-100\" src=\"{{ asset('/imagenes/gifs/cargue-ia.gif') }}\">\n                </div>\n            </div>\n        </div>\n    `\n})}\n\n${crearModal({\n    id: 'modal-agregar-nivel-educativo',\n    dialog_class: 'modal-lg modal-dialog-centered',\n    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n    titulo_header: '<span class=\"text-gray-10 fw-semibold\">Agregar nivel educativo</span>',\n    boton_footer1: {\n        type: 'button',\n        texto: 'Cancelar',\n        class: 'btn-outline-primary',\n        cerrar_modal: true,\n    },\n    boton_footer2: {\n        type: 'submit',\n        texto: 'Agregar nivel educativo',\n        class: 'btn-primary',\n        form: 'formulario-nivel-educativo',\n    },\n    modal_body: `\n        <form id=\"formulario-nivel-educativo\" class=\"px-4\" action=\"/nivel-educativo\">\n            @csrf\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    ${crearInput({\n                        id: 'titulo',\n                        name: 'titulo',\n                        maxlength: 50,\n                        required: true,\n                        autocomplete: 'off',\n                        label: 'Título',\n                    })}\n                </div>\n                <div class=\"col-12 col-lg-6\">\n                    ${crearInput({\n                        id: 'institucion_educativa',\n                        name: 'institucion_educativa',\n                        input_container_class: 'mb-6',\n                        maxlength: 50,\n                        required: true,\n                        autocomplete: 'off',\n                        label: 'Institución educativa',\n                    })}\n                </div>\n                <div class=\"col-12 col-lg-6\">\n                    ${crearSelect2({\n                        id: 'nivel_educativo_id',\n                        opciones: @json($niveles_educativos),\n                        name: 'nivel_educativo_id',\n                        label: 'Nivel educativo',\n                        placeholder: 'Nivel educativo',\n                        required: true,\n                        buscador: false\n                    })}\n                </div>\n                <div class=\"col-5 text-headline-6 fw-semibold\">\n                    Estoy cursando estos estudios\n                </div>\n                <div class=\"col-7 mb-5\">\n                    ${crearToggle({\n                        id: 'cursando_estudios',\n                        name: 'graduado_cursando_estudios',\n                        value: 'cursando',\n                        checked: false,\n                        onchange: 'seleccionarGraduadoCursando(this.checked)',\n                    })}\n                </div>\n                <div class=\"col-12\" id=\"fechas-cursando-estudios\">\n                    <div class=\"row align-items-center\">\n                        <div class=\"col-12 col-md-6 mt-2\">\n                            ${crearSelectorMesAnio({\n                                id: 'fecha_inicio_estudio',\n                                name: 'fecha_inicio_estudio',\n                                placeholder: 'mm/yyyy',\n                                disabled: false,\n                                required: true,\n                                input_container_class: 'mb-4',\n                                label: 'Fecha de inicio',\n                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n                            })}\n                        </div>\n                        <div class=\"col-12 col-md-6 mt-2\">\n                            ${crearSelectorMesAnio({\n                                id: 'fecha_fin_estudio',\n                                name: 'fecha_fin_estudio',\n                                placeholder: 'mm/yyyy',\n                                disabled: false,\n                                required: true,\n                                input_container_class: 'mb-4',\n                                label: 'Fecha de finalización',\n                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n                            })}\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </form>\n    `\n})}\n\n${crearModal({\n    id: 'modal-agregar-experiencia-laboral',\n    dialog_class: 'modal-lg modal-dialog-centered',\n    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n    titulo_header: '<span class=\"text-gray-10 fw-semibold\">Agregar experiencia laboral</span>',\n    boton_footer1: {\n        type: 'button',\n        texto: 'Cancelar',\n        class: 'btn-outline-primary',\n        cerrar_modal: true,\n    },\n    boton_footer2: {\n        type: 'submit',\n        texto: 'Agregar experiencia laboral',\n        class: 'btn-primary',\n        form: 'formulario-experiencia-laboral',\n    },\n    modal_body: `\n        <form id=\"formulario-experiencia-laboral\" class=\"px-4\" action=\"/experiencia-laboral\">\n            @csrf\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    ${crearInput({\n                        id: 'cargo',\n                        name: 'cargo',\n                        maxlength: 50,\n                        required: true,\n                        autocomplete: 'off',\n                        label: 'Cargo',\n                    })}\n                </div>\n                <div class=\"col-12\">\n                    ${crearInput({\n                        id: 'empresa',\n                        name: 'empresa',\n                        maxlength: 50,\n                        required: true,\n                        autocomplete: 'off',\n                        label: 'Empresa u organización',\n                    })}\n                </div>\n                <div class=\"col-12\">\n                    ${crearSelect2({\n                        opciones: [\n                            {id: 1, nombre: 'Presencial'},\n                            {id: 2, nombre: 'Híbrido'},\n                            {id: 3, nombre: 'Remoto'}\n                        ],\n                        id: 'modalidad_trabajo_id',\n                        name: 'modalidad_trabajo_id',\n                        label: 'Modalidad de trabajo',\n                        placeholder: 'Seleccionar modalidad',\n                        required: false,\n                    })}\n                </div>\n                <div class=\"col-5 text-headline-6 fw-semibold\">\n                    Actualmente tengo este trabajo\n                </div>\n                <div class=\"col-7 mb-5\">\n                    ${crearToggle({\n                        id: 'actualmente_trabajo',\n                        name: 'actualmente_trabajo',\n                        value: true,\n                        checked: false,\n                        onchange: 'seleccionarActualmenteTrabajo(this.checked)',\n                    })}\n                </div>\n                <div class=\"col-12\">\n                    <div class=\"row mt-2\" id=\"fechas-trabajo-experiencia\">\n                        <div class=\"col-12 col-md-6 mt-3\">\n                            ${crearSelectorMesAnio({\n                                id: 'fecha_inicio_experiencia',\n                                name: 'fecha_inicio_experiencia',\n                                placeholder: 'mm/yyyy',\n                                disabled: false,\n                                required: true,\n                                input_container_class: 'mb-2',\n                                label: 'Fecha de inicio',\n                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n                            })}\n                        </div>\n                        <div class=\"col-12 col-md-6 mt-3\">\n                            ${crearSelectorMesAnio({\n                                id: 'fecha_fin_experiencia',\n                                name: 'fecha_fin_experiencia',\n                                placeholder: 'mm/yyyy',\n                                disabled: false,\n                                required: true,\n                                input_container_class: 'mb-2',\n                                label: 'Fecha de finalización',\n                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n                            })}\n                        </div>\n                    </div>\n                </div>\n                <div class=\"col-12 mt-3\">\n                    ${crearTextarea({\n                        id: 'funciones',\n                        name: 'funciones',\n                        label: 'Funciones y responsabilidades',\n                        placeholder: 'Describe las principales funciones y responsabilidades del cargo...',\n                        maxlength: 1000,\n                        rows: 4,\n                        required: false,\n                    })}\n                </div>\n            </div>\n        </form>\n    `\n})}\n","numLines":616,"startLine":1,"totalLines":616}}}
{"parentUuid":"481db489-72e8-4b52-8bcd-c9800873020d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01ARxaxznXgrBbDvXEup6oyo","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora déjame buscar el archivo JavaScript que maneja la lógica de este modal para entender cómo se cargan los datos del backend:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":9803,"cache_read_input_tokens":53015,"cache_creation":{"ephemeral_5m_input_tokens":9803,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWvdCMvBfkGutt9bzZVdR","type":"assistant","uuid":"38bc159e-4f85-4cb3-9657-3847577758e7","timestamp":"2026-01-08T21:31:29.192Z"}
{"parentUuid":"38bc159e-4f85-4cb3-9657-3847577758e7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01ARxaxznXgrBbDvXEup6oyo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HqsyzukY5PM8FDa5dZqdcX","name":"Glob","input":{"pattern":"**/*revision*hv*.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":9803,"cache_read_input_tokens":53015,"cache_creation":{"ephemeral_5m_input_tokens":9803,"ephemeral_1h_input_tokens":0},"output_tokens":95,"service_tier":"standard"}},"requestId":"req_011CWvdCMvBfkGutt9bzZVdR","type":"assistant","uuid":"02cdd38b-3429-46b2-9617-3fdec0739e4e","timestamp":"2026-01-08T21:31:29.698Z"}
{"parentUuid":"02cdd38b-3429-46b2-9617-3fdec0739e4e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HqsyzukY5PM8FDa5dZqdcX","type":"tool_result","content":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\vacantes\\modals-movimientos\\modal-revision-hv.js\nc:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js"}]},"uuid":"f844db7c-f0b1-4d82-833d-1f0e7162cae6","timestamp":"2026-01-08T21:31:33.048Z","toolUseResult":{"filenames":["c:\\laragon\\www\\psicoalianza-2\\public\\js\\vacantes\\modals-movimientos\\modal-revision-hv.js","c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js"],"durationMs":2224,"numFiles":2,"truncated":false}}
{"parentUuid":"f844db7c-f0b1-4d82-833d-1f0e7162cae6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TyZb5J8qkpFKgUx3DvUfLS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01G3QPVwcdppcWoYb3FvsLod","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":181,"cache_read_input_tokens":62818,"cache_creation":{"ephemeral_5m_input_tokens":181,"ephemeral_1h_input_tokens":0},"output_tokens":89,"service_tier":"standard"}},"requestId":"req_011CWvdCvzGQuDP6GhG6CZ5a","type":"assistant","uuid":"507e0720-3ab6-492b-ba2b-8f6ba9c6c6e4","timestamp":"2026-01-08T21:31:35.735Z"}
{"parentUuid":"507e0720-3ab6-492b-ba2b-8f6ba9c6c6e4","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01G3QPVwcdppcWoYb3FvsLod","type":"tool_result","content":"     1→var revision_hv_ia_activa = false;\n     2→\n     3→const TIEMPO_MODAL_APERTURA = 300;\n     4→const TIEMPO_INICIALIZACION_COMPONENTES = 300;\n     5→const TIEMPO_TRIGGER_SELECT = 200;\n     6→const TIEMPO_FORMULARIO_MANUAL = 100;\n     7→\n     8→let niveles_idiomas = [\n     9→    {\n    10→        id: 'A1',\n    11→        nombre: 'A1'\n    12→    },\n    13→    {\n    14→        id: 'A2',\n    15→        nombre: 'A2'\n    16→    },\n    17→    {\n    18→        id: 'B1',\n    19→        nombre: 'B1'\n    20→    },\n    21→    {\n    22→        id: 'B2',\n    23→        nombre: 'B2'\n    24→    },\n    25→    {\n    26→        id: 'C1',\n    27→        nombre: 'C1'\n    28→    },\n    29→    {\n    30→        id: 'C2',\n    31→        nombre: 'C2'\n    32→    },\n    33→];\n    34→\n    35→$(document).ready(function() {\n    36→    $(document).on('change', '#hv_archivo', function() {\n    37→        if (revision_hv_ia_activa && this.files && this.files[0]) {\n    38→            generarPerfilHVPorIARevision(this);\n    39→        }\n    40→    });\n    41→});\n    42→\n    43→/**\n    44→ * Cierra el modal de revisión de hoja de vida\n    45→ *\n    46→ * @returns {void}\n    47→ * @author Andres Gonzalez\n    48→ */\n    49→function cerrarModalRevisionHV() {\n    50→    $('#modal-aplicacion-revision-hv').modal('hide');\n    51→}\n    52→\n    53→/**\n    54→ * Abre el modal de revisión de hoja de vida\n    55→ *\n    56→ * @param {Object} datos_etapa - Datos de la etapa\n    57→ * @returns {void}\n    58→ * @author Andres Gonzalez\n    59→ */\n    60→function abrirModalRevisionHV(datos_etapa) {\n    61→    estudios = [];\n    62→    experiencias = [];\n    63→    indice_editar = null;\n    64→\n    65→    revision_hv_ia_activa = datos_etapa.configuracion_ia_hv == 1;\n    66→\n    67→    if (revision_hv_ia_activa) {\n    68→        $('#alerta-ia-revision-hv').removeClass('d-none');\n    69→    } else {\n    70→        $('#alerta-ia-revision-hv').addClass('d-none');\n    71→\n    72→        setTimeout(() => {\n    73→            crearPerfilManualmenteRevision();\n    74→        }, TIEMPO_FORMULARIO_MANUAL);\n    75→    }\n    76→\n    77→    // Limpiar contenedores\n    78→    $('#contenedor-niveles-educativos-revision').empty();\n    79→    $('#contenedor-experiencias-laborales-revision').empty();\n    80→    $('#contenedor-campos-perfil-revision').addClass('d-none');\n    81→    $('#contenedor-opciones-crear-ia-revision').removeClass('d-none');\n    82→\n    83→    // Sobreescribir temporalmente las funciones para este contexto\n    84→    window.validacionAdicional = validacionAdicionalRevisionHV;\n    85→    window.postSuccess = postSuccessRevisionHV;\n    86→\n    87→    configurarFormulario('formulario-revision-hv');\n    88→    configurarFormulario('formulario-nivel-educativo');\n    89→    configurarFormulario('formulario-experiencia-laboral');\n    90→\n    91→    $('#titulo-revision-hv').text(`Completa tu hoja de vida para: ${datos_etapa.vacante_nombre}`);\n    92→\n    93→    $('#revision_hv_etapa_vacante_usuario_id').val(datos_etapa.etapa_vacante_usuario_id || '');\n    94→    $('#revision_hv_vacante_id').val(datos_etapa.vacante_id || '');\n    95→    $('#revision_hv_etapa_id').val(datos_etapa.etapa_id || '');\n    96→\n    97→    let usuario_id = datos_etapa.usuario_id || $('#revision_hv_usuario_id').val();\n    98→    $('#revision_hv_usuario_id').val(usuario_id);\n    99→\n   100→    $('#modal-aplicacion-revision-hv').modal('show');\n   101→\n   102→    consultarPerfilLaboralUsuario();\n   103→\n   104→    // Inicializar componentes\n   105→    setTimeout(() => {\n   106→        inputsCleave();\n   107→        actualizarSelect2();\n   108→        inizializarMultiselect();\n   109→        inicializarTooltips();\n   110→        inicializarIputsFile();\n   111→\n   112→        // Limpiar espacios en blanco de habilidades y herramientas en tiempo real\n   113→        $('#revision_select_habilidades, #revision_select_herramientas_tecnologicas').on('change', function() {\n   114→            let valores = $(this).val();\n   115→            if (Array.isArray(valores)) {\n   116→                // Filtrar y limpiar espacios vacíos\n   117→                let valores_limpios = valores.filter(v => v && v.trim() !== '').map(v => v.trim());\n   118→                if (JSON.stringify(valores) !== JSON.stringify(valores_limpios)) {\n   119→                    $(this).val(valores_limpios).trigger('change.select2');\n   120→                }\n   121→            }\n   122→        });\n   123→\n   124→        configurarOverridesRevision();\n   125→    }, TIEMPO_INICIALIZACION_COMPONENTES);\n   126→}\n   127→\n   128→/**\n   129→ * Consulta el perfil laboral existente del usuario y pre-rellena el formulario\n   130→ *\n   131→ * @returns {void}\n   132→ * @author Andres Gonzalez\n   133→ */\n   134→function consultarPerfilLaboralUsuario() {\n   135→    let usuario_id = $('#revision_hv_usuario_id').val();\n   136→\n   137→    if (!usuario_id) {\n   138→        return;\n   139→    }\n   140→\n   141→    $.ajax({\n   142→        url: `/perfiles-laborales-consultar-usuario/${usuario_id}`,\n   143→        type: 'GET',\n   144→        success: function(respuesta) {\n   145→            if (respuesta.data) {\n   146→                preRellenarFormularioRevisionHV(respuesta.data);\n   147→            }\n   148→        },\n   149→        error: function(error) {}\n   150→    });\n   151→}\n   152→\n   153→/**\n   154→ * Pre-rellena el formulario de revisión HV con datos existentes\n   155→ *\n   156→ * @param {Object} perfil - Datos del perfil laboral\n   157→ * @returns {void}\n   158→ * @author Andres Gonzalez\n   159→ */\n   160→function preRellenarFormularioRevisionHV(perfil) {\n   161→    crearPerfilManualmenteRevision();\n   162→\n   163→    $('#id').val(perfil.id);\n   164→\n   165→    if (perfil.salario) {\n   166→        if (perfil.salario_maximo) {\n   167→            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n   168→            setTimeout(() => {\n   169→                $('#revision_salario').val(perfil.salario);\n   170→                $('#revision_salario_maximo').val(perfil.salario_maximo);\n   171→            }, 200);\n   172→        } else {\n   173→            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n   174→            setTimeout(() => {\n   175→                $('#revision_salario').val(perfil.salario);\n   176→            }, 200);\n   177→        }\n   178→    }\n   179→\n   180→    if (perfil.habilidades) {\n   181→        let habilidades_array = perfil.habilidades.split(',')\n   182→            .map(h => h.trim())\n   183→            .filter(h => h !== ''); // Filtrar elementos vacíos\n   184→        habilidades_array.forEach(habilidad => {\n   185→            if (habilidad) {\n   186→                let opcion = new Option(habilidad, habilidad, true, true);\n   187→                $('#revision_select_habilidades').append(opcion);\n   188→            }\n   189→        });\n   190→        $('#revision_select_habilidades').trigger('change');\n   191→    }\n   192→\n   193→    if (perfil.herramientas_tecnologicas) {\n   194→        let herramientas_array = perfil.herramientas_tecnologicas.split(',')\n   195→            .map(h => h.trim())\n   196→            .filter(h => h !== ''); // Filtrar elementos vacíos\n   197→        herramientas_array.forEach(herramienta => {\n   198→            if (herramienta) {\n   199→                let opcion = new Option(herramienta, herramienta, true, true);\n   200→                $('#revision_select_herramientas_tecnologicas').append(opcion);\n   201→            }\n   202→        });\n   203→        $('#revision_select_herramientas_tecnologicas').trigger('change');\n   204→    }\n   205→\n   206→    if (perfil.licencia_conducir) {\n   207→        $('#revision_opcion_licencia_conducir').prop('checked', true).trigger('change');\n   208→        setTimeout(() => {\n   209→            $('#revision_tipo_licencia').val(perfil.licencia_conducir).trigger('change');\n   210→        }, 100);\n   211→    }\n   212→\n   213→    if (perfil.estudios && perfil.estudios.length > 0) {\n   214→        estudios = perfil.estudios.map(estudio => ({\n   215→            nivel_educativo_id: estudio.nivel_educativo_id,\n   216→            nivel_educativo: estudio.nivel_educativo?.nombre || '',\n   217→            titulo: estudio.titulo,\n   218→            institucion_educativa: estudio.institucion_educativa,\n   219→            fecha_inicio: estudio.fecha_inicio,\n   220→            fecha_fin: estudio.fecha_fin,\n   221→            jornada: estudio.jornada,\n   222→            graduado: estudio.fecha_fin ? true : false\n   223→        }));\n   224→        mostrarNivelesEducativosRevision();\n   225→    }\n   226→\n   227→    if (perfil.experiencias_laborales && perfil.experiencias_laborales.length > 0) {\n   228→        experiencias = perfil.experiencias_laborales.map(exp => ({\n   229→            empresa: exp.empresa,\n   230→            cargo: exp.cargo,\n   231→            fecha_inicio: exp.fecha_inicio,\n   232→            fecha_fin: exp.fecha_fin,\n   233→            actualmente_trabajo: exp.fecha_fin ? 0 : 1,\n   234→            modalidad_trabajo_id: exp.modalidad_trabajo_id || null,\n   235→            funciones: exp.funciones || ''\n   236→        }));\n   237→        mostrarExperienciasLaboralesRevision();\n   238→        $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n   239→    } else {\n   240→        $('#revision_no_experiencia').prop('checked', true).trigger('change');\n   241→    }\n   242→\n   243→    if (perfil.idiomas && perfil.idiomas.length > 0) {\n   244→        let idiomas_ids = perfil.idiomas.map(idioma => idioma.idioma_id);\n   245→        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n   246→        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n   247→\n   248→        setTimeout(() => {\n   249→            perfil.idiomas.forEach(idioma => {\n   250→                $(`#nivel_idioma_${idioma.idioma_id}`).val(idioma.nivel).trigger('change');\n   251→            });\n   252→        }, 200);\n   253→    }\n   254→\n   255→    if (perfil.usuario && perfil.usuario.discapacidades && perfil.usuario.discapacidades.length > 0) {\n   256→        $('#revision_vacante_apta_discapacitados').prop('checked', true).trigger('change');\n   257→\n   258→        setTimeout(() => {\n   259→            let discapacidades_ids = perfil.usuario.discapacidades.map(disc => disc.id);\n   260→            $('#revision_select_discapacidades').val(discapacidades_ids).multiselect('refresh');\n   261→            seleccionarDiscapacidadRevision({name: 'revision_select_discapacidades'});\n   262→\n   263→            perfil.usuario.discapacidades.forEach(discapacidad => {\n   264→                if (discapacidad.id === 5 && discapacidad.pivot.otra_discapacidad) { // ID 5 = \"Otra\"\n   265→                    $('#revision_otra_discapacidad').val(discapacidad.pivot.otra_discapacidad);\n   266→                }\n   267→            });\n   268→        }, 200);\n   269→    }\n   270→\n   271→    // Reinicializar componentes después de rellenar\n   272→    setTimeout(() => {\n   273→        inputsCleave();\n   274→        actualizarSelect2();\n   275→    }, 300);\n   276→}\n   277→\n   278→/**\n   279→ * Configura los overrides de funciones globales para el contexto de revisión\n   280→ *\n   281→ * @returns {void}\n   282→ * @author Andres Gonzalez\n   283→ */\n   284→function configurarOverridesRevision() {\n   285→    if (!window.mostrarNivelesEducativos_original_revision) {\n   286→        window.mostrarNivelesEducativos_original_revision = window.mostrarNivelesEducativos;\n   287→    }\n   288→    if (!window.mostrarExperienciasLaborales_original_revision) {\n   289→        window.mostrarExperienciasLaborales_original_revision = window.mostrarExperienciasLaborales;\n   290→    }\n   291→\n   292→    window.mostrarNivelesEducativos = function() {\n   293→        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-niveles-educativos-revision').length > 0) {\n   294→            mostrarNivelesEducativosRevision();\n   295→        } else if (typeof window.mostrarNivelesEducativos_original_revision === 'function') {\n   296→            window.mostrarNivelesEducativos_original_revision();\n   297→        }\n   298→    };\n   299→\n   300→    window.mostrarExperienciasLaborales = function() {\n   301→        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-experiencias-laborales-revision').length > 0) {\n   302→            mostrarExperienciasLaboralesRevision();\n   303→        } else if (typeof window.mostrarExperienciasLaborales_original_revision === 'function') {\n   304→            window.mostrarExperienciasLaborales_original_revision();\n   305→        }\n   306→    };\n   307→}\n   308→\n   309→/**\n   310→ * Genera el perfil de HV usando IA (versión para revisión)\n   311→ *\n   312→ * @param {HTMLElement} input_archivo - Input de archivo\n   313→ * @returns {void}\n   314→ * @author Andres Gonzalez\n   315→ */\n   316→function generarPerfilHVPorIARevision(input_archivo) {\n   317→    if (!input_archivo.files || !input_archivo.files[0]) {\n   318→        return;\n   319→    }\n   320→\n   321→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   322→\n   323→    $('#modal-generando-ia-revision').modal('show');\n   324→\n   325→    $('#modal-generando-ia-revision').off('hidden.bs.modal.restaurar-ia').on('hidden.bs.modal.restaurar-ia', function() {\n   326→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   327→    });\n   328→\n   329→    let formulario = new FormData();\n   330→    formulario.append('archivo', input_archivo.files[0]);\n   331→    formulario.append('_method', 'POST');\n   332→    formulario.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n   333→\n   334→    const vacanteId = $('#revision_hv_vacante_id').val()\n   335→        || new URLSearchParams(window.location.search).get('vacante_id')\n   336→        || '';\n   337→    if (vacanteId) {\n   338→        formulario.append('vacante_id', vacanteId);\n   339→    }\n   340→\n   341→    $.ajax({\n   342→        url: '/perfiles-laborales-leer-hv-ia',\n   343→        type: 'POST',\n   344→        data: formulario,\n   345→        processData: false,\n   346→        contentType: false,\n   347→        success: function(respuesta) {\n   348→            $('#modal-generando-ia-revision').modal('hide');\n   349→            // Esperar a que se cierre el modal de IA antes de mostrar el principal\n   350→            setTimeout(() => {\n   351→                $('#modal-aplicacion-revision-hv').css('display', 'block');\n   352→            }, TIEMPO_MODAL_APERTURA);\n   353→\n   354→            if (respuesta.data) {\n   355→                // Mostrar formulario\n   356→                crearPerfilManualmenteRevision();\n   357→\n   358→                // Llenar habilidades desde la IA\n   359→                if (respuesta.data.habilidades) {\n   360→                    $('#revision_select_habilidades').val([]);\n   361→                    let habilidades_array = respuesta.data.habilidades.split(',').map(habilidad => habilidad.trim()).filter(habilidad => habilidad !== '');\n   362→                    habilidades_array.forEach(habilidad => {\n   363→                        if (habilidad) {\n   364→                            let opcion = new Option(habilidad, habilidad, true, true);\n   365→                            $('#revision_select_habilidades').append(opcion);\n   366→                        }\n   367→                    });\n   368→                    $('#revision_select_habilidades').trigger('change');\n   369→                }\n   370→\n   371→                // Llenar herramientas tecnológicas desde la IA\n   372→                if (respuesta.data.herramientas_tecnologicas) {\n   373→                    $('#revision_select_herramientas_tecnologicas').val([]);\n   374→                    let herramientas_array = respuesta.data.herramientas_tecnologicas.split(',').map(herramienta => herramienta.trim()).filter(herramienta => herramienta !== '');\n   375→                    herramientas_array.forEach(herramienta => {\n   376→                        if (herramienta) {\n   377→                            let opcion = new Option(herramienta, herramienta, true, true);\n   378→                            $('#revision_select_herramientas_tecnologicas').append(opcion);\n   379→                        }\n   380→                    });\n   381→                    $('#revision_select_herramientas_tecnologicas').trigger('change');\n   382→                }\n   383→\n   384→                // Llenar salario si existe\n   385→                if (respuesta.data.salario) {\n   386→                    $('#revision_salario').val(respuesta.data.salario);\n   387→                }\n   388→\n   389→                // Procesar estudios\n   390→                if (respuesta.data.estudios && Array.isArray(respuesta.data.estudios)) {\n   391→                    estudios = [];\n   392→                    respuesta.data.estudios.forEach(estudio => {\n   393→                        // Buscar el nivel educativo por nombre\n   394→                        let nivel_educativo_encontrado = niveles_educativos.find(function(nivel) {\n   395→                            return nivel.nombre.toLowerCase() === estudio.nivel_educativo.toLowerCase();\n   396→                        });\n   397→\n   398→                        estudios.push({\n   399→                            titulo: estudio.titulo,\n   400→                            institucion_educativa: estudio.institucion_educativa,\n   401→                            nivel_educativo_id: nivel_educativo_encontrado ? nivel_educativo_encontrado.id : null,\n   402→                            nivel_educativo: estudio.nivel_educativo,\n   403→                            fecha_inicio: estudio.fecha_inicio,\n   404→                            fecha_fin: estudio.fecha_fin || null,\n   405→                            jornada: estudio.jornada || 'Diurna',\n   406→                            graduado: estudio.fecha_fin ? true : false\n   407→                        });\n   408→                    });\n   409→                    mostrarNivelesEducativosRevision();\n   410→                }\n   411→\n   412→                // Procesar experiencias laborales\n   413→                if (respuesta.data.experiencias_laborales && Array.isArray(respuesta.data.experiencias_laborales)) {\n   414→                    experiencias = [];\n   415→                    respuesta.data.experiencias_laborales.forEach(experiencia => {\n   416→                        experiencias.push({\n   417→                            empresa: experiencia.empresa,\n   418→                            cargo: experiencia.cargo,\n   419→                            fecha_inicio: experiencia.fecha_inicio,\n   420→                            fecha_fin: experiencia.fecha_fin || null,\n   421→                            actualmente_trabajo: experiencia.fecha_fin ? 0 : 1,\n   422→                            modalidad_trabajo_id: experiencia.modalidad_trabajo_id || null,\n   423→                            funciones: experiencia.funciones || ''\n   424→                        });\n   425→                    });\n   426→                    mostrarExperienciasLaboralesRevision();\n   427→                    $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n   428→                }\n   429→\n   430→                // Procesar idiomas\n   431→                if (respuesta.data.idiomas && Array.isArray(respuesta.data.idiomas)) {\n   432→                    // Mapear nombres de idiomas de la IA a IDs del sistema\n   433→                    let idiomas_mapa = {\n   434→                        'Inglés': 1,\n   435→                        'Portugués': 2,\n   436→                        'Francés': 3,\n   437→                        'Alemán': 4,\n   438→                        'Mandarín': 5,\n   439→                        'Italiano': 6,\n   440→                        'Ruso': 7,\n   441→                        'Árabe': 8\n   442→                    };\n   443→\n   444→                    let idiomas_ids = [];\n   445→                    respuesta.data.idiomas.forEach(idioma_ia => {\n   446→                        let idioma_id = idiomas_mapa[idioma_ia.idioma];\n   447→                        if (idioma_id) {\n   448→                            idiomas_ids.push(idioma_id);\n   449→                        }\n   450→                    });\n   451→\n   452→                    if (idiomas_ids.length > 0) {\n   453→                        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n   454→                        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n   455→\n   456→                        setTimeout(() => {\n   457→                            respuesta.data.idiomas.forEach(idioma_ia => {\n   458→                                let idioma_id = idiomas_mapa[idioma_ia.idioma];\n   459→                                if (idioma_id) {\n   460→                                    $(`#nivel_idioma_${idioma_id}`).val(idioma_ia.nivel).trigger('change');\n   461→                                }\n   462→                            });\n   463→                        }, TIEMPO_TRIGGER_SELECT);\n   464→                    }\n   465→                }\n   466→\n   467→                revision_hv_ia_activa = false;\n   468→                mostrarToast('success', 'Datos extraídos correctamente. Por favor verifica y completa la información.');\n   469→            }\n   470→        },\n   471→        error: function(error) {\n   472→            $('#modal-generando-ia-revision').modal('hide');\n   473→\n   474→            setTimeout(() => {\n   475→                $('#modal-aplicacion-revision-hv').css('display', 'block');\n   476→            }, TIEMPO_MODAL_APERTURA);\n   477→            mostrarToast('danger', error.responseJSON?.message || 'Error al procesar el archivo con IA');\n   478→            console.error(error);\n   479→        }\n   480→    });\n   481→}\n   482→\n   483→/**\n   484→ * Muestra el formulario de perfil manualmente\n   485→ *\n   486→ * @returns {void}\n   487→ * @author Andres Gonzalez\n   488→ */\n   489→function crearPerfilManualmenteRevision() {\n   490→    $('#contenedor-campos-perfil-revision').removeClass('d-none');\n   491→    $('#contenedor-opciones-crear-ia-revision').addClass('d-none');\n   492→}\n   493→\n   494→/**\n   495→ * Abre el modal para agregar un nivel educativo\n   496→ *\n   497→ * @returns {void}\n   498→ * @author Andres Gonzalez\n   499→ */\n   500→function abrirModalNivelEducativoRevision() {\n   501→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   502→\n   503→    $('#modal-agregar-nivel-educativo').modal('show');\n   504→    limpiarFormulario('formulario-nivel-educativo');\n   505→    indice_editar = null;\n   506→\n   507→    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n   508→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   509→        limpiarFormulario('formulario-nivel-educativo');\n   510→        indice_editar = null;\n   511→    });\n   512→}\n   513→\n   514→/**\n   515→ * Abre el modal para agregar una experiencia laboral\n   516→ *\n   517→ * @returns {void}\n   518→ * @author Andres Gonzalez\n   519→ */\n   520→function abrirModalExperienciaLaboralRevision() {\n   521→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   522→\n   523→    $('#modal-agregar-experiencia-laboral').modal('show');\n   524→    limpiarFormulario('formulario-experiencia-laboral');\n   525→    indice_editar = null;\n   526→\n   527→    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n   528→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   529→        limpiarFormulario('formulario-experiencia-laboral');\n   530→        indice_editar = null;\n   531→    });\n   532→}\n   533→\n   534→/**\n   535→ * Maneja el toggle de \"no tengo experiencia\"\n   536→ *\n   537→ * @param {boolean} marcado - Estado del toggle\n   538→ * @returns {void}\n   539→ * @author Andres Gonzalez\n   540→ * @author Andres Morales\n   541→ */\n   542→function seleccionarNoTengoExperienciaRevision(marcado) {\n   543→    if (marcado) {\n   544→        $('#btn-agregar-experiencia-laboral-revision').addClass('d-none');\n   545→        experiencias = [];\n   546→        mostrarExperienciasLaboralesRevision();\n   547→    } else {\n   548→        $('#btn-agregar-experiencia-laboral-revision').removeClass('d-none');\n   549→    }\n   550→}\n   551→\n   552→/**\n   553→ * Cambia los campos de salario según el tipo seleccionado\n   554→ *\n   555→ * @param {string} tipo - Tipo de salario ('especifico' o 'rango')\n   556→ * @returns {void}\n   557→ * @author Andres Gonzalez\n   558→ */\n   559→function seleccionarSalarioRevision(tipo) {\n   560→    $('#contenedor-campos-salario-revision').empty();\n   561→    if (tipo == 'especifico') {\n   562→        $('#contenedor-campos-salario-revision').append(`\n   563→            <div class=\"col-12 col-md-6\">\n   564→                ${crearInput({\n   565→                    id: 'revision_salario',\n   566→                    name: 'salario',\n   567→                    class: 'cleave',\n   568→                    input_container_class: 'mb-0',\n   569→                    label: 'Cantidad',\n   570→                    placeholder: '',\n   571→                    min: 0,\n   572→                    step: 0.01,\n   573→                    required: true,\n   574→                    minlength: 3,\n   575→                    maxlength: 10,\n   576→                    data: [{\n   577→                        texto: 'simbolo-cleave',\n   578→                        value: ''\n   579→                    }],\n   580→                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   581→                })}\n   582→            </div>\n   583→        `);\n   584→    } else if (tipo == 'rango') {\n   585→        $('#contenedor-campos-salario-revision').append(`\n   586→            <div class=\"col-12 col-md-6\">\n   587→                ${crearInput({\n   588→                    id: 'revision_salario',\n   589→                    name: 'salario',\n   590→                    class: 'cleave',\n   591→                    input_container_class: 'mb-0',\n   592→                    label: 'Desde',\n   593→                    placeholder: '',\n   594→                    step: 0.01,\n   595→                    required: true,\n   596→                    minlength: 3,\n   597→                    maxlength: 10,\n   598→                    onkeyup: 'validarRangoSalarioRevision()',\n   599→                    data: [{\n   600→                        texto: 'simbolo-cleave',\n   601→                        value: ''\n   602→                    }],\n   603→                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   604→                })}\n   605→            </div>\n   606→            <div class=\"col-12 col-md-6\">\n   607→                ${crearInput({\n   608→                    id: 'revision_salario_maximo',\n   609→                    name: 'salario_maximo',\n   610→                    class: 'cleave',\n   611→                    input_container_class: 'mb-0',\n   612→                    label: 'Hasta',\n   613→                    placeholder: '',\n   614→                    min: 0,\n   615→                    step: 0.01,\n   616→                    required: true,\n   617→                    minlength: 3,\n   618→                    maxlength: 10,\n   619→                    onkeyup: 'validarRangoSalarioRevision()',\n   620→                    data: [{\n   621→                        texto: 'simbolo-cleave',\n   622→                        value: ''\n   623→                    }],\n   624→                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   625→                })}\n   626→            </div>\n   627→        `);\n   628→    }\n   629→    setTimeout(() => {\n   630→        inputsCleave();\n   631→        actualizarSelect2();\n   632→        configurarFormulario('formulario-revision-hv');\n   633→    }, 100);\n   634→}\n   635→\n   636→/**\n   637→ * Maneja la selección de idiomas\n   638→ *\n   639→ * @param {HTMLElement} elemento - Elemento del multiselect\n   640→ * @returns {void}\n   641→ * @author Andres Gonzalez\n   642→ */\n   643→function seleccionarIdiomaRevision(elemento) {\n   644→    let niveles = [];\n   645→    $('input[name=\"multiselect_' + elemento.name + '\"]:checked').each(function () {\n   646→        niveles.push({\n   647→            id: parseInt($(this).val()),\n   648→            nombre: $(this).closest('label').find('span').text().trim(),\n   649→        });\n   650→    });\n   651→    let campos_idiomas = '';\n   652→    for (let i = 0; i < niveles.length; i++) {\n   653→        campos_idiomas += `\n   654→            <div class=\"col-12 col-lg-6 mt-3\">\n   655→                <div class=\"text-headline-6 text-gray-10\">${niveles[i].nombre}</div>\n   656→                ${crearSelect2({\n   657→                    opciones: niveles_idiomas,\n   658→                    id: 'nivel_idioma_' + niveles[i].id,\n   659→                    name: 'nivel_idioma_' + niveles[i].id,\n   660→                    class: 'input-dinamico nivel-idioma',\n   661→                    input_container_class: 'mt-2 mb-0',\n   662→                    label: 'Nivel',\n   663→                    value: $('#nivel_idioma_' + niveles[i].id).val(),\n   664→                    required: true,\n   665→                })}\n   666→            </div>\n   667→            <input type=\"hidden\" value=\"${niveles[i].id}\" class=\"input-dinamico idioma\">\n   668→        `;\n   669→    }\n   670→    $('#contenedor-idiomas-revision').empty();\n   671→    $('#contenedor-idiomas-revision').append(campos_idiomas);\n   672→    actualizarSelect2();\n   673→}\n   674→\n   675→/**\n   676→ * Maneja el toggle de licencia de conducir\n   677→ *\n   678→ * @param {HTMLElement} elemento - Elemento del toggle\n   679→ * @returns {void}\n   680→ * @author Andres Gonzalez\n   681→ */\n   682→function seleccionarLicenciaConducirRevision(elemento) {\n   683→    let marcado = $(elemento).prop('checked');\n   684→    if (!marcado) {\n   685→        $('#revision_tipo_licencia').val('').trigger('change').trigger('select2:select');\n   686→    }\n   687→    $('#revision_tipo_licencia').prop('disabled', !marcado);\n   688→}\n   689→\n   690→/**\n   691→ * Maneja el toggle de discapacidad\n   692→ *\n   693→ * @param {boolean} posee_discapacidad - Si tiene discapacidad\n   694→ * @returns {void}\n   695→ * @author Andres Gonzalez\n   696→ */\n   697→function seleccionarTengoDiscapacidadRevision(posee_discapacidad) {\n   698→    $('#contenedor-discapacidad-revision').empty();\n   699→    if (posee_discapacidad) {\n   700→        $('#contenedor-discapacidad-revision').append(`\n   701→            <div class=\"col-12 p-4 border rounded-3\">\n   702→                <div class=\"row align-items-center pb-2\">\n   703→                    <div class=\"col-12\">\n   704→                        <label class=\"form-label fw-semibold\">Discapacidad</label>\n   705→                    </div>\n   706→                    <div class=\"col-6\">\n   707→                        ${crearMultiselect({\n   708→                            opciones: discapacidades,\n   709→                            id: 'revision_select_discapacidades',\n   710→                            name: 'revision_select_discapacidades',\n   711→                            class: 'input-dinamico',\n   712→                            input_container_class: 'mb-0',\n   713→                            placeholder: 'Discapacidad',\n   714→                            onchange: 'seleccionarDiscapacidadRevision(this.value)',\n   715→                            required: true,\n   716→                        })}\n   717→                    </div>\n   718→                    <div class=\"col-6\" id=\"contenedor-otra-discapacidad-revision\"></div>\n   719→                </div>\n   720→            </div>\n   721→        `);\n   722→        inizializarMultiselect();\n   723→    }\n   724→}\n   725→\n   726→/**\n   727→ * Maneja la selección de tipo de discapacidad\n   728→ *\n   729→ * @param {string} discapacidad_id - ID de la discapacidad\n   730→ * @returns {void}\n   731→ * @author Andres Gonzalez\n   732→ */\n   733→function seleccionarDiscapacidadRevision(discapacidad_id) {\n   734→    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val() || [];\n   735→    if (discapacidades_seleccionadas.includes('5')) {\n   736→        let otra_discapacidad_existente = $('#revision_otra_discapacidad').length > 0;\n   737→        if (!otra_discapacidad_existente) {\n   738→            $('#contenedor-otra-discapacidad-revision').append(`\n   739→                ${crearInput({\n   740→                    id: 'revision_otra_discapacidad',\n   741→                    name: 'revision_otra_discapacidad',\n   742→                    class: 'input-dinamico',\n   743→                    input_container_class: 'mb-0',\n   744→                    label: '¿Cuál?',\n   745→                    required: true,\n   746→                })}\n   747→            `);\n   748→        }\n   749→    } else {\n   750→        $('#contenedor-otra-discapacidad-revision').empty();\n   751→    }\n   752→}\n   753→\n   754→/**\n   755→ * Muestra los niveles educativos agregados (reutiliza lógica de crear.js)\n   756→ *\n   757→ * @returns {void}\n   758→ * @author Andres Gonzalez\n   759→ * @author Jair Carvajal\n   760→ */\n   761→function mostrarNivelesEducativosRevision() {\n   762→    $('#contenedor-niveles-educativos-revision').empty();\n   763→    if (estudios.length > 0) {\n   764→        // Ordenar estudios usando función global reutilizable\n   765→        let estudios_ordenados = ordenarEstudiosPorFecha(estudios);\n   766→\n   767→        estudios_ordenados.forEach((estudio) => {\n   768→            $('#contenedor-niveles-educativos-revision').append(`\n   769→                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"nivel-educativo-revision-${estudio.indice_original}\">\n   770→                    <div class=\"row mb-2\">\n   771→                        <div class=\"col-12 col-lg\">\n   772→                            <p class=\"mb-1 fw-bold text-gray-20\">${estudio.titulo}</p>\n   773→                            <p class=\"text-body-3 mb-1\">\n   774→                                ${estudio.fecha_inicio || estudio.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n   775→                                ${estudio.fecha_inicio ? moment(estudio.fecha_inicio).format(\"MMM YYYY\") : ''}\n   776→                                ${estudio.fecha_inicio && !estudio.fecha_fin ? ' - Actualmente' : estudio.fecha_fin ? ` - ${moment(estudio.fecha_fin).format(\"MMM YYYY\")}` : ''}\n   777→                                ${estudio.jornada ? ` - ${estudio.jornada}` : ''}\n   778→                            </p>\n   779→                            <p class=\"text-body-3 mb-1\"><i class=\"bi bi-buildings text-headline-5 me-2\"></i> ${estudio.institucion_educativa}</p>\n   780→                        </div>\n   781→                        <div class=\"col-auto\">\n   782→                            <div class=\"row justify-content-end\">\n   783→                                <div class=\"col-auto ps-0\">\n   784→                                    ${crearBoton({\n   785→                                        clases: 'btn-outline-primary btn-circle',\n   786→                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n   787→                                        onclick: `editarNivelEducativoRevision(${estudio.indice_original})`\n   788→                                    })}\n   789→                                </div>\n   790→                                <div class=\"col-auto ps-0\">\n   791→                                    ${crearBoton({\n   792→                                        clases: 'btn-outline-danger btn-circle',\n   793→                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n   794→                                        onclick: `eliminarNivelEducativoRevision(${estudio.indice_original})`\n   795→                                    })}\n   796→                                </div>\n   797→                            </div>\n   798→                        </div>\n   799→                        <div class=\"col-12 mt-3\">\n   800→                            <div class=\"row justify-content-between\">\n   801→                                <div class=\"col-auto\">\n   802→                                    <p class=\"text-body-3 text-gray-10 mb-0\">${estudio.nivel_educativo || ''}</p>\n   803→                                </div>\n   804→                                <div class=\"col-auto\">\n   805→                                    <div class=\"row justify-content-end align-items-center\">\n   806→                                        ${estudio.graduado ? `\n   807→                                            <div class=\"col-auto pe-0\">\n   808→                                                <i class=\"bi bi-mortarboard text-headline-5 text-cta-blue\"></i>\n   809→                                            </div>\n   810→                                            <div class=\"col-auto text-body-3 text-gray-10\">\n   811→                                                Graduado\n   812→                                            </div>\n   813→                                        ` : `\n   814→                                            <div class=\"col-auto pe-0\">\n   815→                                                <i class=\"bi ${estudio.jornada == 'Diurna' ? 'bi-sun' : estudio.jornada == 'Nocturna' ? 'bi-moon' : ''} text-headline-5 text-cta-blue\"></i>\n   816→                                            </div>\n   817→                                            <div class=\"col-auto text-body-3 text-gray-10\">\n   818→                                                ${estudio.jornada ? 'Modalidad:' : ''} ${estudio.jornada || ''}\n   819→                                            </div>\n   820→                                        `}\n   821→                                    </div>\n   822→                                </div>\n   823→                            </div>\n   824→                        </div>\n   825→                    </div>\n   826→                </div>\n   827→            `);\n   828→        });\n   829→    }\n   830→}\n   831→\n   832→/**\n   833→ * Muestra las experiencias laborales agregadas\n   834→ *\n   835→ * @returns {void}\n   836→ * @author Andres Gonzalez\n   837→ */\n   838→function mostrarExperienciasLaboralesRevision() {\n   839→    $('#contenedor-experiencias-laborales-revision').empty();\n   840→    if (experiencias.length > 0) {\n   841→        $('#revision_no_experiencia').prop('disabled', true);\n   842→        // Ordenar experiencias usando función global reutilizable\n   843→        let experiencias_ordenadas = ordenarExperienciasPorFecha(experiencias);\n   844→\n   845→        experiencias_ordenadas.forEach((experiencia) => {\n   846→            let modalidades = {1: 'Presencial', 2: 'Híbrido', 3: 'Remoto'};\n   847→            let html_modalidad = experiencia.modalidad_trabajo_id ? `\n   848→                <div class=\"mt-2\">\n   849→                    <small class=\"text-gray-30\">Modalidad:</small>\n   850→                    <span class=\"badge bg-primary ms-2\">${modalidades[experiencia.modalidad_trabajo_id]}</span>\n   851→                </div>\n   852→            ` : '';\n   853→            let html_funciones = experiencia.funciones ? `\n   854→                <div class=\"mt-2\">\n   855→                    <small class=\"text-gray-30 d-block\">Funciones:</small>\n   856→                    <p class=\"text-body-3 mb-0\">${experiencia.funciones}</p>\n   857→                </div>\n   858→            ` : '';\n   859→            $('#contenedor-experiencias-laborales-revision').append(`\n   860→                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"experiencia-laboral-revision-${experiencia.indice_original}\">\n   861→                    <div class=\"row mb-2\">\n   862→                        <div class=\"col-lg\">\n   863→                            <p class=\"mb-1 fw-bold text-gray-20\">${experiencia.cargo}</p>\n   864→                            <p class=\"text-body-3 mb-2\">\n   865→                                ${experiencia.fecha_inicio || experiencia.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n   866→                                ${experiencia.fecha_inicio ? moment(experiencia.fecha_inicio).format(\"MMM YYYY\") + (experiencia.fecha_fin ? ` - ${moment(experiencia.fecha_fin).format(\"MMM YYYY\")}` : \" - Actualmente\") : \"\"}\n   867→                                ${experiencia.fecha_inicio && experiencia.fecha_fin ? (() => {\n   868→                                    let inicio = moment(experiencia.fecha_inicio);\n   869→                                    let fin = moment(experiencia.fecha_fin);\n   870→                                    let anios = fin.diff(inicio, 'years');\n   871→                                    let meses = fin.diff(inicio.add(anios, 'years'), 'months');\n   872→                                    let texto = '';\n   873→                                    if (anios > 0) texto += `${anios} año${anios > 1 ? 's' : ''}`;\n   874→                                    if (meses > 0) texto += `${anios > 0 ? ' y ' : ''}${meses} mes${meses > 1 ? 'es' : ''}`;\n   875→                                    return texto ? ` | ${texto}` : '';\n   876→                                })() : ''}\n   877→                            </p>\n   878→                            <p class=\"text-body-3 mb-1 fw-semibold text-gray-10\">${experiencia.empresa}</p>\n   879→                            ${html_modalidad}\n   880→                            ${html_funciones}\n   881→                        </div>\n   882→                        <div class=\"col-auto\">\n   883→                            <div class=\"row justify-content-end\">\n   884→                                <div class=\"col-auto ps-0\">\n   885→                                    ${crearBoton({\n   886→                                        clases: 'btn-outline-primary btn-circle',\n   887→                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n   888→                                        onclick: `editarExperienciaLaboralRevision(${experiencia.indice_original})`\n   889→                                    })}\n   890→                                </div>\n   891→                                <div class=\"col-auto ps-0\">\n   892→                                    ${crearBoton({\n   893→                                        clases: 'btn-outline-danger btn-circle',\n   894→                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n   895→                                        onclick: `eliminarExperienciaLaboralRevision(${experiencia.indice_original})`\n   896→                                    })}\n   897→                                </div>\n   898→                            </div>\n   899→                        </div>\n   900→                    </div>\n   901→                </div>\n   902→            `);\n   903→        });\n   904→    } else {\n   905→        $('#revision_no_experiencia').prop('disabled', false);\n   906→    }\n   907→}\n   908→\n   909→/**\n   910→ * Edita un nivel educativo existente (reutiliza variables de crear.js)\n   911→ *\n   912→ * @param {number} indice - Índice del nivel educativo a editar\n   913→ * @returns {void}\n   914→ * @author Andres Gonzalez\n   915→ */\n   916→function editarNivelEducativoRevision(indice) {\n   917→    indice_editar = indice;\n   918→    let estudio = estudios[indice];\n   919→    $('#titulo').val(estudio.titulo);\n   920→    $('#institucion_educativa').val(estudio.institucion_educativa);\n   921→    $('#cursando_estudios').prop('checked', !estudio.graduado).trigger('change');\n   922→    $('#nivel_educativo_id').val(estudio.nivel_educativo_id).trigger('change');\n   923→    $('#fecha_inicio_estudio')[0]._flatpickr.setDate(estudio.fecha_inicio);\n   924→    if ($('#fecha_fin_estudio').length > 0) {\n   925→        $('#fecha_fin_estudio')[0]._flatpickr.setDate(estudio.fecha_fin || '');\n   926→    }\n   927→\n   928→    // Ocultar el modal principal temporalmente sin destruirlo\n   929→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   930→\n   931→    // Abrir el modal secundario\n   932→    $('#modal-agregar-nivel-educativo').modal('show');\n   933→\n   934→    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n   935→    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n   936→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   937→        limpiarFormulario('formulario-nivel-educativo');\n   938→        indice_editar = null;\n   939→    });\n   940→}\n   941→\n   942→/**\n   943→ * Elimina un nivel educativo (reutiliza array de crear.js)\n   944→ *\n   945→ * @param {number} indice - Índice del nivel educativo a eliminar\n   946→ * @returns {void}\n   947→ * @author Andres Gonzalez\n   948→ */\n   949→function eliminarNivelEducativoRevision(indice) {\n   950→    estudios.splice(indice, 1);\n   951→    mostrarNivelesEducativosRevision();\n   952→    mostrarToast('success', 'Nivel educativo eliminado exitosamente');\n   953→}\n   954→\n   955→/**\n   956→ * Edita una experiencia laboral existente (reutiliza variables de crear.js)\n   957→ *\n   958→ * @param {number} indice - Índice de la experiencia laboral a editar\n   959→ * @returns {void}\n   960→ * @author Andres Gonzalez\n   961→ */\n   962→function editarExperienciaLaboralRevision(indice) {\n   963→    indice_editar = indice;\n   964→    let experiencia = experiencias[indice];\n   965→    $('#cargo').val(experiencia.cargo);\n   966→    $('#empresa').val(experiencia.empresa);\n   967→    $('#actualmente_trabajo').prop('checked', experiencia.actualmente_trabajo).trigger('change');\n   968→    $('#fecha_inicio_experiencia')[0]._flatpickr.setDate(experiencia.fecha_inicio);\n   969→    if ($('#fecha_fin_experiencia').length) {\n   970→        $('#fecha_fin_experiencia')[0]._flatpickr.setDate(experiencia.fecha_fin || '');\n   971→    }\n   972→    $('#modalidad_trabajo_id').val(experiencia.modalidad_trabajo_id || '').trigger('change');\n   973→    $('#funciones').val(experiencia.funciones || '');\n   974→\n   975→    // Ocultar el modal principal temporalmente sin destruirlo\n   976→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   977→\n   978→    // Abrir el modal secundario\n   979→    $('#modal-agregar-experiencia-laboral').modal('show');\n   980→\n   981→    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n   982→    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n   983→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   984→        limpiarFormulario('formulario-experiencia-laboral');\n   985→        indice_editar = null;\n   986→    });\n   987→}\n   988→\n   989→/**\n   990→ * Elimina una experiencia laboral (reutiliza array de crear.js)\n   991→ *\n   992→ * @param {number} indice - Índice de la experiencia laboral a eliminar\n   993→ * @returns {void}\n   994→ * @author Andres Gonzalez\n   995→ */\n   996→function eliminarExperienciaLaboralRevision(indice) {\n   997→    experiencias.splice(indice, 1);\n   998→    mostrarExperienciasLaboralesRevision();\n   999→    mostrarToast('success', 'Experiencia laboral eliminada exitosamente');\n  1000→}\n  1001→\n  1002→/**\n  1003→ * Validación adicional para formularios de revisión de HV\n  1004→ * Esta función es llamada automáticamente por configurarFormulario()\n  1005→ * Maneja: formulario-revision-hv, formulario-nivel-educativo, formulario-experiencia-laboral\n  1006→ *\n  1007→ * @param {string} formulario - ID del formulario a validar\n  1008→ * @returns {boolean}\n  1009→ * @author Andres Gonzalez\n  1010→ */\n  1011→function validacionAdicionalRevisionHV(formulario) {\n  1012→    let valido = true;\n  1013→\n  1014→    if (formulario == 'formulario-nivel-educativo') {\n  1015→        let errores = $('#formulario-nivel-educativo').find('input.error , select.error , textarea.error');\n  1016→        if (errores.length == 0) {\n  1017→            let fecha_inicio = $('#fecha_inicio_estudio').val() ? moment($('#fecha_inicio_estudio').val(), 'YYYY-MM-DD') : null;\n  1018→            let fecha_fin = $('#fecha_fin_estudio').val() ? moment($('#fecha_fin_estudio').val(), 'YYYY-MM-DD') : null;\n  1019→            let fecha_actual = moment();\n  1020→\n  1021→            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n  1022→                mostrarToast('danger', 'La fecha de inicio del estudio no puede ser una fecha futura.');\n  1023→                valido = false;\n  1024→            }\n  1025→            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n  1026→                mostrarToast('danger', 'La fecha de finalización del estudio no puede ser una fecha futura.');\n  1027→                valido = false;\n  1028→            }\n  1029→            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n  1030→                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n  1031→                valido = false;\n  1032→            }\n  1033→\n  1034→            if (valido) {\n  1035→                let estudio = {\n  1036→                    titulo: $('#titulo').val(),\n  1037→                    institucion_educativa: $('#institucion_educativa').val(),\n  1038→                    nivel_educativo_id: parseInt($('#nivel_educativo_id').val()),\n  1039→                    nivel_educativo: $('#nivel_educativo_id option:selected').text().trim(),\n  1040→                    graduado: $('#cursando_estudios').prop('checked') ? false : true,\n  1041→                    fecha_inicio: $('#fecha_inicio_estudio').val(),\n  1042→                    fecha_fin: $('#fecha_fin_estudio').val() || null,\n  1043→                    jornada: $('#jornada').val() || null,\n  1044→                }\n  1045→                if (indice_editar == null) {\n  1046→                    estudios.push(estudio);\n  1047→                } else {\n  1048→                    estudios[indice_editar] = estudio;\n  1049→                    indice_editar = null;\n  1050→                }\n  1051→                mostrarNivelesEducativosRevision();\n  1052→                $('#modal-agregar-nivel-educativo').modal('hide');\n  1053→                mostrarToast('success', 'Nivel educativo guardado exitosamente');\n  1054→            }\n  1055→        }\n  1056→        return false;\n  1057→    }\n  1058→\n  1059→    if (formulario == 'formulario-experiencia-laboral') {\n  1060→        let errores = $('#formulario-experiencia-laboral').find('input.error , select.error , textarea.error');\n  1061→        if (errores.length == 0) {\n  1062→            let fecha_inicio = $('#fecha_inicio_experiencia').val() ? moment($('#fecha_inicio_experiencia').val(), 'YYYY-MM-DD') : null;\n  1063→            let fecha_fin = $('#fecha_fin_experiencia').val() ? moment($('#fecha_fin_experiencia').val(), 'YYYY-MM-DD') : null;\n  1064→            let fecha_actual = moment();\n  1065→\n  1066→            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n  1067→                mostrarToast('danger', 'La fecha de inicio de la experiencia no puede ser una fecha futura.');\n  1068→                valido = false;\n  1069→            }\n  1070→            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n  1071→                mostrarToast('danger', 'La fecha de finalización de la experiencia no puede ser una fecha futura.');\n  1072→                valido = false;\n  1073→            }\n  1074→            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n  1075→                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n  1076→                valido = false;\n  1077→            }\n  1078→\n  1079→            if (valido) {\n  1080→                let modalidad_trabajo_id = $('#modalidad_trabajo_id').val();\n  1081→                let experiencia = {\n  1082→                    cargo: $('#cargo').val(),\n  1083→                    empresa: $('#empresa').val(),\n  1084→                    actualmente_trabajo: $('#actualmente_trabajo').prop('checked') ? 1 : 0,\n  1085→                    fecha_inicio: $('#fecha_inicio_experiencia').val(),\n  1086→                    fecha_fin: $('#fecha_fin_experiencia').val() || null,\n  1087→                    modalidad_trabajo_id: modalidad_trabajo_id ? parseInt(modalidad_trabajo_id) : null,\n  1088→                    funciones: $('#funciones').val() || '',\n  1089→                }\n  1090→                if (indice_editar == null) {\n  1091→                    experiencias.push(experiencia);\n  1092→                } else {\n  1093→                    experiencias[indice_editar] = experiencia;\n  1094→                    indice_editar = null;\n  1095→                }\n  1096→                mostrarExperienciasLaboralesRevision();\n  1097→                $('#modal-agregar-experiencia-laboral').modal('hide');\n  1098→                mostrarToast('success', 'Experiencia laboral guardada exitosamente');\n  1099→            }\n  1100→        }\n  1101→        return false;\n  1102→    }\n  1103→\n  1104→    if (formulario !== 'formulario-revision-hv') {\n  1105→        return true;\n  1106→    }\n  1107→\n  1108→    let errores = $('#formulario-revision-hv').find('input.error , select.error , textarea.error');\n  1109→    if (errores.length > 0) {\n  1110→        mostrarToast('danger', 'Faltan algunos datos obligatorios. Por favor, revisa la información e intenta nuevamente');\n  1111→        return false;\n  1112→    }\n  1113→\n  1114→    let salario = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n  1115→    if (salario < 0) {\n  1116→        mostrarToast('danger', 'El salario no puede ser un valor negativo.');\n  1117→        valido = false;\n  1118→    }\n  1119→\n  1120→    if ($('#revision_salario_maximo').length > 0) {\n  1121→        let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n  1122→        if (salario_maximo < 0) {\n  1123→            mostrarToast('danger', 'El salario máximo no puede ser un valor negativo.');\n  1124→            valido = false;\n  1125→        }\n  1126→        if (salario_maximo < salario) {\n  1127→            if (salario_maximo > 0) {\n  1128→                mostrarToast('danger', 'El salario máximo no puede ser menor que el salario mínimo.');\n  1129→            }\n  1130→            valido = false;\n  1131→        }\n  1132→    }\n  1133→\n  1134→    validarRangoSalarioRevision();\n  1135→\n  1136→    let habilidades_seleccionadas = $('#revision_select_habilidades').val();\n  1137→    $('#revision_hv_habilidades').val(Array.isArray(habilidades_seleccionadas) ? habilidades_seleccionadas.join(', ') : '');\n  1138→\n  1139→    let herramientas_seleccionadas = $('#revision_select_herramientas_tecnologicas').val();\n  1140→    $('#revision_hv_herramientas_tecnologicas').val(Array.isArray(herramientas_seleccionadas) ? herramientas_seleccionadas.join(', ') : '');    \n  1141→    $('#revision_hv_estudios').val(JSON.stringify(estudios.map(({ nivel_educativo, graduado, ...estudio }) => estudio)));\n  1142→\n  1143→    if (experiencias.length > 0) {\n  1144→        $('#revision_hv_experiencias_laborales').val(JSON.stringify(experiencias.map(({ actualmente_trabajo, ...experiencia }) => experiencia)));\n  1145→    } else {\n  1146→        $('#revision_hv_experiencias_laborales').val('');\n  1147→    }\n  1148→\n  1149→    let elementos_idiomas = $('.idioma');\n  1150→    let niveles = $('.nivel-idioma');\n  1151→    let idiomas_seleccionados = [];\n  1152→    for (let i = 0; i < elementos_idiomas.length; i++) {\n  1153→        idiomas_seleccionados.push({\n  1154→            idioma_id: parseInt($(elementos_idiomas[i]).val()),\n  1155→            nivel: $(niveles[i]).val()\n  1156→        });\n  1157→    }\n  1158→    if (idiomas_seleccionados.length == 0) {\n  1159→        $('#revision_hv_idiomas').val('');\n  1160→    } else {\n  1161→        $('#revision_hv_idiomas').val(JSON.stringify(idiomas_seleccionados));\n  1162→    }\n  1163→\n  1164→    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val();\n  1165→    let discapacidades_finales = [];\n  1166→    let usuario_id = parseInt($('#revision_hv_usuario_id').val());\n  1167→    if (discapacidades_seleccionadas) {\n  1168→        discapacidades_seleccionadas.forEach(discapacidad_id => {\n  1169→            let discapacidad = discapacidades.find(d => d.id == discapacidad_id);\n  1170→            if (discapacidad) {\n  1171→                let otra_discapacidad = null;\n  1172→                if (discapacidad.id == '5') {\n  1173→                    otra_discapacidad = $('#revision_otra_discapacidad').val().trim();\n  1174→                }\n  1175→                discapacidades_finales.push({\n  1176→                    usuario_id: usuario_id,\n  1177→                    discapacidad_id: parseInt(discapacidad_id),\n  1178→                    otra_discapacidad: otra_discapacidad\n  1179→                });\n  1180→            }\n  1181→        });\n  1182→        $('#revision_hv_discapacidades').val(JSON.stringify(discapacidades_finales));\n  1183→    } else {\n  1184→        $('#revision_hv_discapacidades').val('');\n  1185→    }\n  1186→\n  1187→    if (estudios.length == 0) {\n  1188→        mostrarToast('danger', 'Debes agregar al menos un nivel educativo para continuar.');\n  1189→        valido = false;\n  1190→    }\n  1191→\n  1192→    valido = validarFechasInicio(estudios);\n  1193→\n  1194→    if (experiencias.length == 0 && !$('#revision_no_experiencia').prop('checked')) {\n  1195→        mostrarToast('danger', 'Debes agregar al menos una experiencia laboral para continuar.');\n  1196→        valido = false;\n  1197→    }\n  1198→\n  1199→    return valido;\n  1200→}\n  1201→\n  1202→/**\n  1203→ * Callback después de enviar exitosamente el formulario de revisión HV\n  1204→ *\n  1205→ * @param {Object} respuesta - Respuesta del servidor\n  1206→ * @returns {void}\n  1207→ * @author Andres Gonzalez\n  1208→ */\n  1209→function postSuccessRevisionHV(respuesta) {\n  1210→    $('#modal-aplicacion-revision-hv').modal('hide');\n  1211→    limpiarFormularioRevisionHV();\n  1212→\n  1213→    // Recargar la tabla de tareas pendientes\n  1214→    actualizarDatatables('tabla-tareas-pendientes');\n  1215→}\n  1216→\n  1217→/**\n  1218→ * Función para validar las fechas de inicio\n  1219→ *\n  1220→ * @param {Object} estudios - estudios del aplicante\n  1221→ * @returns {boolean}\n  1222→ * @author Jair Carvajal\n  1223→ */\n  1224→function validarFechasInicio(estudios) {\n  1225→    let error = true;\n  1226→    for (const ESTUDIO of estudios) {\n  1227→        if (ESTUDIO.fecha_inicio === null) {\n  1228→            mostrarToast('danger', `El título ${ESTUDIO.titulo}. le hace falta la fecha de inicio para continuar.`);\n  1229→            error = false;\n  1230→        }\n  1231→    }\n  1232→    return error;\n  1233→}\n  1234→\n  1235→/**\n  1236→ * Valida el rango de salario\n  1237→ *\n  1238→ * @returns {boolean}\n  1239→ * @author Andres Gonzalez\n  1240→ */\n  1241→function validarRangoSalarioRevision() {\n  1242→    if ($('input[name=\"tipo_salario\"]:checked').val() !== 'rango') {\n  1243→        return true;\n  1244→    }\n  1245→    let salario_desde = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n  1246→    let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n  1247→    let campo_hasta = $('#revision_salario_maximo');\n  1248→    let contenedor_hasta = campo_hasta.closest('.input-container');\n  1249→    campo_hasta.removeClass('error');\n  1250→    contenedor_hasta.siblings('label[for=\"revision_salario_maximo\"].error').remove();\n  1251→    if (salario_desde > 99 && salario_maximo > 99 && salario_desde >= salario_maximo) {\n  1252→        setTimeout(() => {\n  1253→            campo_hasta.addClass('error');\n  1254→            contenedor_hasta.after('<label for=\"revision_salario_maximo\" class=\"error text-red-cta\">El salario hasta no debe ser menor o igual al salario desde</label>');\n  1255→            return false;\n  1256→        }, 100);\n  1257→    }\n  1258→    return true;\n  1259→}\n  1260→\n  1261→/**\n  1262→ * Limpiar formulario\n  1263→ *\n  1264→ * @returns {void}\n  1265→ * @author Andres Gonzalez\n  1266→ */\n  1267→function limpiarFormularioRevisionHV() {\n  1268→    let formulario = $('#formulario-revision-hv');\n  1269→    formulario[0].reset();\n  1270→    formulario.find('.input-dinamico').removeClass('error');\n  1271→    formulario.find('label.error').remove();\n  1272→\n  1273→    $('#contenedor-idiomas-revision').empty();\n  1274→    $('#contenedor-discapacidad-revision').empty();\n  1275→    $('#contenedor-niveles-educativos-revision').empty();\n  1276→    $('#contenedor-experiencias-laborales-revision').empty();\n  1277→\n  1278→    $('#revision_select_habilidades').val('').trigger('change');\n  1279→    $('#revision_select_herramientas_tecnologicas').val('').trigger('change');\n  1280→    $('#revision_idiomas_seleccionados').val([]).multiselect('refresh');\n  1281→    $('#revision_select_discapacidades').val([]).multiselect('refresh');\n  1282→\n  1283→    $('#revision_opcion_licencia_conducir').prop('checked', false);\n  1284→    $('#revision_tipo_licencia').val('').prop('disabled', true).trigger('change');\n  1285→    $('#revision_vacante_apta_discapacitados').prop('checked', false);\n  1286→\n  1287→    estudios = [];\n  1288→    experiencias = [];\n  1289→    indice_editar = null;\n  1290→\n  1291→    inputsCleave();\n  1292→    actualizarSelect2();\n  1293→}\n  1294→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"536c91b2-32fa-4076-8c6d-36b02ecfcaf2","timestamp":"2026-01-08T21:31:37.535Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js","content":"var revision_hv_ia_activa = false;\n\nconst TIEMPO_MODAL_APERTURA = 300;\nconst TIEMPO_INICIALIZACION_COMPONENTES = 300;\nconst TIEMPO_TRIGGER_SELECT = 200;\nconst TIEMPO_FORMULARIO_MANUAL = 100;\n\nlet niveles_idiomas = [\n    {\n        id: 'A1',\n        nombre: 'A1'\n    },\n    {\n        id: 'A2',\n        nombre: 'A2'\n    },\n    {\n        id: 'B1',\n        nombre: 'B1'\n    },\n    {\n        id: 'B2',\n        nombre: 'B2'\n    },\n    {\n        id: 'C1',\n        nombre: 'C1'\n    },\n    {\n        id: 'C2',\n        nombre: 'C2'\n    },\n];\n\n$(document).ready(function() {\n    $(document).on('change', '#hv_archivo', function() {\n        if (revision_hv_ia_activa && this.files && this.files[0]) {\n            generarPerfilHVPorIARevision(this);\n        }\n    });\n});\n\n/**\n * Cierra el modal de revisión de hoja de vida\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction cerrarModalRevisionHV() {\n    $('#modal-aplicacion-revision-hv').modal('hide');\n}\n\n/**\n * Abre el modal de revisión de hoja de vida\n *\n * @param {Object} datos_etapa - Datos de la etapa\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalRevisionHV(datos_etapa) {\n    estudios = [];\n    experiencias = [];\n    indice_editar = null;\n\n    revision_hv_ia_activa = datos_etapa.configuracion_ia_hv == 1;\n\n    if (revision_hv_ia_activa) {\n        $('#alerta-ia-revision-hv').removeClass('d-none');\n    } else {\n        $('#alerta-ia-revision-hv').addClass('d-none');\n\n        setTimeout(() => {\n            crearPerfilManualmenteRevision();\n        }, TIEMPO_FORMULARIO_MANUAL);\n    }\n\n    // Limpiar contenedores\n    $('#contenedor-niveles-educativos-revision').empty();\n    $('#contenedor-experiencias-laborales-revision').empty();\n    $('#contenedor-campos-perfil-revision').addClass('d-none');\n    $('#contenedor-opciones-crear-ia-revision').removeClass('d-none');\n\n    // Sobreescribir temporalmente las funciones para este contexto\n    window.validacionAdicional = validacionAdicionalRevisionHV;\n    window.postSuccess = postSuccessRevisionHV;\n\n    configurarFormulario('formulario-revision-hv');\n    configurarFormulario('formulario-nivel-educativo');\n    configurarFormulario('formulario-experiencia-laboral');\n\n    $('#titulo-revision-hv').text(`Completa tu hoja de vida para: ${datos_etapa.vacante_nombre}`);\n\n    $('#revision_hv_etapa_vacante_usuario_id').val(datos_etapa.etapa_vacante_usuario_id || '');\n    $('#revision_hv_vacante_id').val(datos_etapa.vacante_id || '');\n    $('#revision_hv_etapa_id').val(datos_etapa.etapa_id || '');\n\n    let usuario_id = datos_etapa.usuario_id || $('#revision_hv_usuario_id').val();\n    $('#revision_hv_usuario_id').val(usuario_id);\n\n    $('#modal-aplicacion-revision-hv').modal('show');\n\n    consultarPerfilLaboralUsuario();\n\n    // Inicializar componentes\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n        inizializarMultiselect();\n        inicializarTooltips();\n        inicializarIputsFile();\n\n        // Limpiar espacios en blanco de habilidades y herramientas en tiempo real\n        $('#revision_select_habilidades, #revision_select_herramientas_tecnologicas').on('change', function() {\n            let valores = $(this).val();\n            if (Array.isArray(valores)) {\n                // Filtrar y limpiar espacios vacíos\n                let valores_limpios = valores.filter(v => v && v.trim() !== '').map(v => v.trim());\n                if (JSON.stringify(valores) !== JSON.stringify(valores_limpios)) {\n                    $(this).val(valores_limpios).trigger('change.select2');\n                }\n            }\n        });\n\n        configurarOverridesRevision();\n    }, TIEMPO_INICIALIZACION_COMPONENTES);\n}\n\n/**\n * Consulta el perfil laboral existente del usuario y pre-rellena el formulario\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction consultarPerfilLaboralUsuario() {\n    let usuario_id = $('#revision_hv_usuario_id').val();\n\n    if (!usuario_id) {\n        return;\n    }\n\n    $.ajax({\n        url: `/perfiles-laborales-consultar-usuario/${usuario_id}`,\n        type: 'GET',\n        success: function(respuesta) {\n            if (respuesta.data) {\n                preRellenarFormularioRevisionHV(respuesta.data);\n            }\n        },\n        error: function(error) {}\n    });\n}\n\n/**\n * Pre-rellena el formulario de revisión HV con datos existentes\n *\n * @param {Object} perfil - Datos del perfil laboral\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }\n\n    if (perfil.habilidades) {\n        let habilidades_array = perfil.habilidades.split(',')\n            .map(h => h.trim())\n            .filter(h => h !== ''); // Filtrar elementos vacíos\n        habilidades_array.forEach(habilidad => {\n            if (habilidad) {\n                let opcion = new Option(habilidad, habilidad, true, true);\n                $('#revision_select_habilidades').append(opcion);\n            }\n        });\n        $('#revision_select_habilidades').trigger('change');\n    }\n\n    if (perfil.herramientas_tecnologicas) {\n        let herramientas_array = perfil.herramientas_tecnologicas.split(',')\n            .map(h => h.trim())\n            .filter(h => h !== ''); // Filtrar elementos vacíos\n        herramientas_array.forEach(herramienta => {\n            if (herramienta) {\n                let opcion = new Option(herramienta, herramienta, true, true);\n                $('#revision_select_herramientas_tecnologicas').append(opcion);\n            }\n        });\n        $('#revision_select_herramientas_tecnologicas').trigger('change');\n    }\n\n    if (perfil.licencia_conducir) {\n        $('#revision_opcion_licencia_conducir').prop('checked', true).trigger('change');\n        setTimeout(() => {\n            $('#revision_tipo_licencia').val(perfil.licencia_conducir).trigger('change');\n        }, 100);\n    }\n\n    if (perfil.estudios && perfil.estudios.length > 0) {\n        estudios = perfil.estudios.map(estudio => ({\n            nivel_educativo_id: estudio.nivel_educativo_id,\n            nivel_educativo: estudio.nivel_educativo?.nombre || '',\n            titulo: estudio.titulo,\n            institucion_educativa: estudio.institucion_educativa,\n            fecha_inicio: estudio.fecha_inicio,\n            fecha_fin: estudio.fecha_fin,\n            jornada: estudio.jornada,\n            graduado: estudio.fecha_fin ? true : false\n        }));\n        mostrarNivelesEducativosRevision();\n    }\n\n    if (perfil.experiencias_laborales && perfil.experiencias_laborales.length > 0) {\n        experiencias = perfil.experiencias_laborales.map(exp => ({\n            empresa: exp.empresa,\n            cargo: exp.cargo,\n            fecha_inicio: exp.fecha_inicio,\n            fecha_fin: exp.fecha_fin,\n            actualmente_trabajo: exp.fecha_fin ? 0 : 1,\n            modalidad_trabajo_id: exp.modalidad_trabajo_id || null,\n            funciones: exp.funciones || ''\n        }));\n        mostrarExperienciasLaboralesRevision();\n        $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n    } else {\n        $('#revision_no_experiencia').prop('checked', true).trigger('change');\n    }\n\n    if (perfil.idiomas && perfil.idiomas.length > 0) {\n        let idiomas_ids = perfil.idiomas.map(idioma => idioma.idioma_id);\n        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n\n        setTimeout(() => {\n            perfil.idiomas.forEach(idioma => {\n                $(`#nivel_idioma_${idioma.idioma_id}`).val(idioma.nivel).trigger('change');\n            });\n        }, 200);\n    }\n\n    if (perfil.usuario && perfil.usuario.discapacidades && perfil.usuario.discapacidades.length > 0) {\n        $('#revision_vacante_apta_discapacitados').prop('checked', true).trigger('change');\n\n        setTimeout(() => {\n            let discapacidades_ids = perfil.usuario.discapacidades.map(disc => disc.id);\n            $('#revision_select_discapacidades').val(discapacidades_ids).multiselect('refresh');\n            seleccionarDiscapacidadRevision({name: 'revision_select_discapacidades'});\n\n            perfil.usuario.discapacidades.forEach(discapacidad => {\n                if (discapacidad.id === 5 && discapacidad.pivot.otra_discapacidad) { // ID 5 = \"Otra\"\n                    $('#revision_otra_discapacidad').val(discapacidad.pivot.otra_discapacidad);\n                }\n            });\n        }, 200);\n    }\n\n    // Reinicializar componentes después de rellenar\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n    }, 300);\n}\n\n/**\n * Configura los overrides de funciones globales para el contexto de revisión\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction configurarOverridesRevision() {\n    if (!window.mostrarNivelesEducativos_original_revision) {\n        window.mostrarNivelesEducativos_original_revision = window.mostrarNivelesEducativos;\n    }\n    if (!window.mostrarExperienciasLaborales_original_revision) {\n        window.mostrarExperienciasLaborales_original_revision = window.mostrarExperienciasLaborales;\n    }\n\n    window.mostrarNivelesEducativos = function() {\n        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-niveles-educativos-revision').length > 0) {\n            mostrarNivelesEducativosRevision();\n        } else if (typeof window.mostrarNivelesEducativos_original_revision === 'function') {\n            window.mostrarNivelesEducativos_original_revision();\n        }\n    };\n\n    window.mostrarExperienciasLaborales = function() {\n        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-experiencias-laborales-revision').length > 0) {\n            mostrarExperienciasLaboralesRevision();\n        } else if (typeof window.mostrarExperienciasLaborales_original_revision === 'function') {\n            window.mostrarExperienciasLaborales_original_revision();\n        }\n    };\n}\n\n/**\n * Genera el perfil de HV usando IA (versión para revisión)\n *\n * @param {HTMLElement} input_archivo - Input de archivo\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction generarPerfilHVPorIARevision(input_archivo) {\n    if (!input_archivo.files || !input_archivo.files[0]) {\n        return;\n    }\n\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-generando-ia-revision').modal('show');\n\n    $('#modal-generando-ia-revision').off('hidden.bs.modal.restaurar-ia').on('hidden.bs.modal.restaurar-ia', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n    });\n\n    let formulario = new FormData();\n    formulario.append('archivo', input_archivo.files[0]);\n    formulario.append('_method', 'POST');\n    formulario.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n\n    const vacanteId = $('#revision_hv_vacante_id').val()\n        || new URLSearchParams(window.location.search).get('vacante_id')\n        || '';\n    if (vacanteId) {\n        formulario.append('vacante_id', vacanteId);\n    }\n\n    $.ajax({\n        url: '/perfiles-laborales-leer-hv-ia',\n        type: 'POST',\n        data: formulario,\n        processData: false,\n        contentType: false,\n        success: function(respuesta) {\n            $('#modal-generando-ia-revision').modal('hide');\n            // Esperar a que se cierre el modal de IA antes de mostrar el principal\n            setTimeout(() => {\n                $('#modal-aplicacion-revision-hv').css('display', 'block');\n            }, TIEMPO_MODAL_APERTURA);\n\n            if (respuesta.data) {\n                // Mostrar formulario\n                crearPerfilManualmenteRevision();\n\n                // Llenar habilidades desde la IA\n                if (respuesta.data.habilidades) {\n                    $('#revision_select_habilidades').val([]);\n                    let habilidades_array = respuesta.data.habilidades.split(',').map(habilidad => habilidad.trim()).filter(habilidad => habilidad !== '');\n                    habilidades_array.forEach(habilidad => {\n                        if (habilidad) {\n                            let opcion = new Option(habilidad, habilidad, true, true);\n                            $('#revision_select_habilidades').append(opcion);\n                        }\n                    });\n                    $('#revision_select_habilidades').trigger('change');\n                }\n\n                // Llenar herramientas tecnológicas desde la IA\n                if (respuesta.data.herramientas_tecnologicas) {\n                    $('#revision_select_herramientas_tecnologicas').val([]);\n                    let herramientas_array = respuesta.data.herramientas_tecnologicas.split(',').map(herramienta => herramienta.trim()).filter(herramienta => herramienta !== '');\n                    herramientas_array.forEach(herramienta => {\n                        if (herramienta) {\n                            let opcion = new Option(herramienta, herramienta, true, true);\n                            $('#revision_select_herramientas_tecnologicas').append(opcion);\n                        }\n                    });\n                    $('#revision_select_herramientas_tecnologicas').trigger('change');\n                }\n\n                // Llenar salario si existe\n                if (respuesta.data.salario) {\n                    $('#revision_salario').val(respuesta.data.salario);\n                }\n\n                // Procesar estudios\n                if (respuesta.data.estudios && Array.isArray(respuesta.data.estudios)) {\n                    estudios = [];\n                    respuesta.data.estudios.forEach(estudio => {\n                        // Buscar el nivel educativo por nombre\n                        let nivel_educativo_encontrado = niveles_educativos.find(function(nivel) {\n                            return nivel.nombre.toLowerCase() === estudio.nivel_educativo.toLowerCase();\n                        });\n\n                        estudios.push({\n                            titulo: estudio.titulo,\n                            institucion_educativa: estudio.institucion_educativa,\n                            nivel_educativo_id: nivel_educativo_encontrado ? nivel_educativo_encontrado.id : null,\n                            nivel_educativo: estudio.nivel_educativo,\n                            fecha_inicio: estudio.fecha_inicio,\n                            fecha_fin: estudio.fecha_fin || null,\n                            jornada: estudio.jornada || 'Diurna',\n                            graduado: estudio.fecha_fin ? true : false\n                        });\n                    });\n                    mostrarNivelesEducativosRevision();\n                }\n\n                // Procesar experiencias laborales\n                if (respuesta.data.experiencias_laborales && Array.isArray(respuesta.data.experiencias_laborales)) {\n                    experiencias = [];\n                    respuesta.data.experiencias_laborales.forEach(experiencia => {\n                        experiencias.push({\n                            empresa: experiencia.empresa,\n                            cargo: experiencia.cargo,\n                            fecha_inicio: experiencia.fecha_inicio,\n                            fecha_fin: experiencia.fecha_fin || null,\n                            actualmente_trabajo: experiencia.fecha_fin ? 0 : 1,\n                            modalidad_trabajo_id: experiencia.modalidad_trabajo_id || null,\n                            funciones: experiencia.funciones || ''\n                        });\n                    });\n                    mostrarExperienciasLaboralesRevision();\n                    $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n                }\n\n                // Procesar idiomas\n                if (respuesta.data.idiomas && Array.isArray(respuesta.data.idiomas)) {\n                    // Mapear nombres de idiomas de la IA a IDs del sistema\n                    let idiomas_mapa = {\n                        'Inglés': 1,\n                        'Portugués': 2,\n                        'Francés': 3,\n                        'Alemán': 4,\n                        'Mandarín': 5,\n                        'Italiano': 6,\n                        'Ruso': 7,\n                        'Árabe': 8\n                    };\n\n                    let idiomas_ids = [];\n                    respuesta.data.idiomas.forEach(idioma_ia => {\n                        let idioma_id = idiomas_mapa[idioma_ia.idioma];\n                        if (idioma_id) {\n                            idiomas_ids.push(idioma_id);\n                        }\n                    });\n\n                    if (idiomas_ids.length > 0) {\n                        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n                        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n\n                        setTimeout(() => {\n                            respuesta.data.idiomas.forEach(idioma_ia => {\n                                let idioma_id = idiomas_mapa[idioma_ia.idioma];\n                                if (idioma_id) {\n                                    $(`#nivel_idioma_${idioma_id}`).val(idioma_ia.nivel).trigger('change');\n                                }\n                            });\n                        }, TIEMPO_TRIGGER_SELECT);\n                    }\n                }\n\n                revision_hv_ia_activa = false;\n                mostrarToast('success', 'Datos extraídos correctamente. Por favor verifica y completa la información.');\n            }\n        },\n        error: function(error) {\n            $('#modal-generando-ia-revision').modal('hide');\n\n            setTimeout(() => {\n                $('#modal-aplicacion-revision-hv').css('display', 'block');\n            }, TIEMPO_MODAL_APERTURA);\n            mostrarToast('danger', error.responseJSON?.message || 'Error al procesar el archivo con IA');\n            console.error(error);\n        }\n    });\n}\n\n/**\n * Muestra el formulario de perfil manualmente\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction crearPerfilManualmenteRevision() {\n    $('#contenedor-campos-perfil-revision').removeClass('d-none');\n    $('#contenedor-opciones-crear-ia-revision').addClass('d-none');\n}\n\n/**\n * Abre el modal para agregar un nivel educativo\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalNivelEducativoRevision() {\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-agregar-nivel-educativo').modal('show');\n    limpiarFormulario('formulario-nivel-educativo');\n    indice_editar = null;\n\n    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-nivel-educativo');\n        indice_editar = null;\n    });\n}\n\n/**\n * Abre el modal para agregar una experiencia laboral\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalExperienciaLaboralRevision() {\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-agregar-experiencia-laboral').modal('show');\n    limpiarFormulario('formulario-experiencia-laboral');\n    indice_editar = null;\n\n    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-experiencia-laboral');\n        indice_editar = null;\n    });\n}\n\n/**\n * Maneja el toggle de \"no tengo experiencia\"\n *\n * @param {boolean} marcado - Estado del toggle\n * @returns {void}\n * @author Andres Gonzalez\n * @author Andres Morales\n */\nfunction seleccionarNoTengoExperienciaRevision(marcado) {\n    if (marcado) {\n        $('#btn-agregar-experiencia-laboral-revision').addClass('d-none');\n        experiencias = [];\n        mostrarExperienciasLaboralesRevision();\n    } else {\n        $('#btn-agregar-experiencia-laboral-revision').removeClass('d-none');\n    }\n}\n\n/**\n * Cambia los campos de salario según el tipo seleccionado\n *\n * @param {string} tipo - Tipo de salario ('especifico' o 'rango')\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarSalarioRevision(tipo) {\n    $('#contenedor-campos-salario-revision').empty();\n    if (tipo == 'especifico') {\n        $('#contenedor-campos-salario-revision').append(`\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario',\n                    name: 'salario',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Cantidad',\n                    placeholder: '',\n                    min: 0,\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n        `);\n    } else if (tipo == 'rango') {\n        $('#contenedor-campos-salario-revision').append(`\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario',\n                    name: 'salario',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Desde',\n                    placeholder: '',\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    onkeyup: 'validarRangoSalarioRevision()',\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario_maximo',\n                    name: 'salario_maximo',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Hasta',\n                    placeholder: '',\n                    min: 0,\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    onkeyup: 'validarRangoSalarioRevision()',\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n        `);\n    }\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n        configurarFormulario('formulario-revision-hv');\n    }, 100);\n}\n\n/**\n * Maneja la selección de idiomas\n *\n * @param {HTMLElement} elemento - Elemento del multiselect\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarIdiomaRevision(elemento) {\n    let niveles = [];\n    $('input[name=\"multiselect_' + elemento.name + '\"]:checked').each(function () {\n        niveles.push({\n            id: parseInt($(this).val()),\n            nombre: $(this).closest('label').find('span').text().trim(),\n        });\n    });\n    let campos_idiomas = '';\n    for (let i = 0; i < niveles.length; i++) {\n        campos_idiomas += `\n            <div class=\"col-12 col-lg-6 mt-3\">\n                <div class=\"text-headline-6 text-gray-10\">${niveles[i].nombre}</div>\n                ${crearSelect2({\n                    opciones: niveles_idiomas,\n                    id: 'nivel_idioma_' + niveles[i].id,\n                    name: 'nivel_idioma_' + niveles[i].id,\n                    class: 'input-dinamico nivel-idioma',\n                    input_container_class: 'mt-2 mb-0',\n                    label: 'Nivel',\n                    value: $('#nivel_idioma_' + niveles[i].id).val(),\n                    required: true,\n                })}\n            </div>\n            <input type=\"hidden\" value=\"${niveles[i].id}\" class=\"input-dinamico idioma\">\n        `;\n    }\n    $('#contenedor-idiomas-revision').empty();\n    $('#contenedor-idiomas-revision').append(campos_idiomas);\n    actualizarSelect2();\n}\n\n/**\n * Maneja el toggle de licencia de conducir\n *\n * @param {HTMLElement} elemento - Elemento del toggle\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarLicenciaConducirRevision(elemento) {\n    let marcado = $(elemento).prop('checked');\n    if (!marcado) {\n        $('#revision_tipo_licencia').val('').trigger('change').trigger('select2:select');\n    }\n    $('#revision_tipo_licencia').prop('disabled', !marcado);\n}\n\n/**\n * Maneja el toggle de discapacidad\n *\n * @param {boolean} posee_discapacidad - Si tiene discapacidad\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarTengoDiscapacidadRevision(posee_discapacidad) {\n    $('#contenedor-discapacidad-revision').empty();\n    if (posee_discapacidad) {\n        $('#contenedor-discapacidad-revision').append(`\n            <div class=\"col-12 p-4 border rounded-3\">\n                <div class=\"row align-items-center pb-2\">\n                    <div class=\"col-12\">\n                        <label class=\"form-label fw-semibold\">Discapacidad</label>\n                    </div>\n                    <div class=\"col-6\">\n                        ${crearMultiselect({\n                            opciones: discapacidades,\n                            id: 'revision_select_discapacidades',\n                            name: 'revision_select_discapacidades',\n                            class: 'input-dinamico',\n                            input_container_class: 'mb-0',\n                            placeholder: 'Discapacidad',\n                            onchange: 'seleccionarDiscapacidadRevision(this.value)',\n                            required: true,\n                        })}\n                    </div>\n                    <div class=\"col-6\" id=\"contenedor-otra-discapacidad-revision\"></div>\n                </div>\n            </div>\n        `);\n        inizializarMultiselect();\n    }\n}\n\n/**\n * Maneja la selección de tipo de discapacidad\n *\n * @param {string} discapacidad_id - ID de la discapacidad\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarDiscapacidadRevision(discapacidad_id) {\n    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val() || [];\n    if (discapacidades_seleccionadas.includes('5')) {\n        let otra_discapacidad_existente = $('#revision_otra_discapacidad').length > 0;\n        if (!otra_discapacidad_existente) {\n            $('#contenedor-otra-discapacidad-revision').append(`\n                ${crearInput({\n                    id: 'revision_otra_discapacidad',\n                    name: 'revision_otra_discapacidad',\n                    class: 'input-dinamico',\n                    input_container_class: 'mb-0',\n                    label: '¿Cuál?',\n                    required: true,\n                })}\n            `);\n        }\n    } else {\n        $('#contenedor-otra-discapacidad-revision').empty();\n    }\n}\n\n/**\n * Muestra los niveles educativos agregados (reutiliza lógica de crear.js)\n *\n * @returns {void}\n * @author Andres Gonzalez\n * @author Jair Carvajal\n */\nfunction mostrarNivelesEducativosRevision() {\n    $('#contenedor-niveles-educativos-revision').empty();\n    if (estudios.length > 0) {\n        // Ordenar estudios usando función global reutilizable\n        let estudios_ordenados = ordenarEstudiosPorFecha(estudios);\n\n        estudios_ordenados.forEach((estudio) => {\n            $('#contenedor-niveles-educativos-revision').append(`\n                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"nivel-educativo-revision-${estudio.indice_original}\">\n                    <div class=\"row mb-2\">\n                        <div class=\"col-12 col-lg\">\n                            <p class=\"mb-1 fw-bold text-gray-20\">${estudio.titulo}</p>\n                            <p class=\"text-body-3 mb-1\">\n                                ${estudio.fecha_inicio || estudio.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n                                ${estudio.fecha_inicio ? moment(estudio.fecha_inicio).format(\"MMM YYYY\") : ''}\n                                ${estudio.fecha_inicio && !estudio.fecha_fin ? ' - Actualmente' : estudio.fecha_fin ? ` - ${moment(estudio.fecha_fin).format(\"MMM YYYY\")}` : ''}\n                                ${estudio.jornada ? ` - ${estudio.jornada}` : ''}\n                            </p>\n                            <p class=\"text-body-3 mb-1\"><i class=\"bi bi-buildings text-headline-5 me-2\"></i> ${estudio.institucion_educativa}</p>\n                        </div>\n                        <div class=\"col-auto\">\n                            <div class=\"row justify-content-end\">\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-primary btn-circle',\n                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n                                        onclick: `editarNivelEducativoRevision(${estudio.indice_original})`\n                                    })}\n                                </div>\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-danger btn-circle',\n                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n                                        onclick: `eliminarNivelEducativoRevision(${estudio.indice_original})`\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-12 mt-3\">\n                            <div class=\"row justify-content-between\">\n                                <div class=\"col-auto\">\n                                    <p class=\"text-body-3 text-gray-10 mb-0\">${estudio.nivel_educativo || ''}</p>\n                                </div>\n                                <div class=\"col-auto\">\n                                    <div class=\"row justify-content-end align-items-center\">\n                                        ${estudio.graduado ? `\n                                            <div class=\"col-auto pe-0\">\n                                                <i class=\"bi bi-mortarboard text-headline-5 text-cta-blue\"></i>\n                                            </div>\n                                            <div class=\"col-auto text-body-3 text-gray-10\">\n                                                Graduado\n                                            </div>\n                                        ` : `\n                                            <div class=\"col-auto pe-0\">\n                                                <i class=\"bi ${estudio.jornada == 'Diurna' ? 'bi-sun' : estudio.jornada == 'Nocturna' ? 'bi-moon' : ''} text-headline-5 text-cta-blue\"></i>\n                                            </div>\n                                            <div class=\"col-auto text-body-3 text-gray-10\">\n                                                ${estudio.jornada ? 'Modalidad:' : ''} ${estudio.jornada || ''}\n                                            </div>\n                                        `}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `);\n        });\n    }\n}\n\n/**\n * Muestra las experiencias laborales agregadas\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction mostrarExperienciasLaboralesRevision() {\n    $('#contenedor-experiencias-laborales-revision').empty();\n    if (experiencias.length > 0) {\n        $('#revision_no_experiencia').prop('disabled', true);\n        // Ordenar experiencias usando función global reutilizable\n        let experiencias_ordenadas = ordenarExperienciasPorFecha(experiencias);\n\n        experiencias_ordenadas.forEach((experiencia) => {\n            let modalidades = {1: 'Presencial', 2: 'Híbrido', 3: 'Remoto'};\n            let html_modalidad = experiencia.modalidad_trabajo_id ? `\n                <div class=\"mt-2\">\n                    <small class=\"text-gray-30\">Modalidad:</small>\n                    <span class=\"badge bg-primary ms-2\">${modalidades[experiencia.modalidad_trabajo_id]}</span>\n                </div>\n            ` : '';\n            let html_funciones = experiencia.funciones ? `\n                <div class=\"mt-2\">\n                    <small class=\"text-gray-30 d-block\">Funciones:</small>\n                    <p class=\"text-body-3 mb-0\">${experiencia.funciones}</p>\n                </div>\n            ` : '';\n            $('#contenedor-experiencias-laborales-revision').append(`\n                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"experiencia-laboral-revision-${experiencia.indice_original}\">\n                    <div class=\"row mb-2\">\n                        <div class=\"col-lg\">\n                            <p class=\"mb-1 fw-bold text-gray-20\">${experiencia.cargo}</p>\n                            <p class=\"text-body-3 mb-2\">\n                                ${experiencia.fecha_inicio || experiencia.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n                                ${experiencia.fecha_inicio ? moment(experiencia.fecha_inicio).format(\"MMM YYYY\") + (experiencia.fecha_fin ? ` - ${moment(experiencia.fecha_fin).format(\"MMM YYYY\")}` : \" - Actualmente\") : \"\"}\n                                ${experiencia.fecha_inicio && experiencia.fecha_fin ? (() => {\n                                    let inicio = moment(experiencia.fecha_inicio);\n                                    let fin = moment(experiencia.fecha_fin);\n                                    let anios = fin.diff(inicio, 'years');\n                                    let meses = fin.diff(inicio.add(anios, 'years'), 'months');\n                                    let texto = '';\n                                    if (anios > 0) texto += `${anios} año${anios > 1 ? 's' : ''}`;\n                                    if (meses > 0) texto += `${anios > 0 ? ' y ' : ''}${meses} mes${meses > 1 ? 'es' : ''}`;\n                                    return texto ? ` | ${texto}` : '';\n                                })() : ''}\n                            </p>\n                            <p class=\"text-body-3 mb-1 fw-semibold text-gray-10\">${experiencia.empresa}</p>\n                            ${html_modalidad}\n                            ${html_funciones}\n                        </div>\n                        <div class=\"col-auto\">\n                            <div class=\"row justify-content-end\">\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-primary btn-circle',\n                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n                                        onclick: `editarExperienciaLaboralRevision(${experiencia.indice_original})`\n                                    })}\n                                </div>\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-danger btn-circle',\n                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n                                        onclick: `eliminarExperienciaLaboralRevision(${experiencia.indice_original})`\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `);\n        });\n    } else {\n        $('#revision_no_experiencia').prop('disabled', false);\n    }\n}\n\n/**\n * Edita un nivel educativo existente (reutiliza variables de crear.js)\n *\n * @param {number} indice - Índice del nivel educativo a editar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction editarNivelEducativoRevision(indice) {\n    indice_editar = indice;\n    let estudio = estudios[indice];\n    $('#titulo').val(estudio.titulo);\n    $('#institucion_educativa').val(estudio.institucion_educativa);\n    $('#cursando_estudios').prop('checked', !estudio.graduado).trigger('change');\n    $('#nivel_educativo_id').val(estudio.nivel_educativo_id).trigger('change');\n    $('#fecha_inicio_estudio')[0]._flatpickr.setDate(estudio.fecha_inicio);\n    if ($('#fecha_fin_estudio').length > 0) {\n        $('#fecha_fin_estudio')[0]._flatpickr.setDate(estudio.fecha_fin || '');\n    }\n\n    // Ocultar el modal principal temporalmente sin destruirlo\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    // Abrir el modal secundario\n    $('#modal-agregar-nivel-educativo').modal('show');\n\n    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-nivel-educativo');\n        indice_editar = null;\n    });\n}\n\n/**\n * Elimina un nivel educativo (reutiliza array de crear.js)\n *\n * @param {number} indice - Índice del nivel educativo a eliminar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction eliminarNivelEducativoRevision(indice) {\n    estudios.splice(indice, 1);\n    mostrarNivelesEducativosRevision();\n    mostrarToast('success', 'Nivel educativo eliminado exitosamente');\n}\n\n/**\n * Edita una experiencia laboral existente (reutiliza variables de crear.js)\n *\n * @param {number} indice - Índice de la experiencia laboral a editar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction editarExperienciaLaboralRevision(indice) {\n    indice_editar = indice;\n    let experiencia = experiencias[indice];\n    $('#cargo').val(experiencia.cargo);\n    $('#empresa').val(experiencia.empresa);\n    $('#actualmente_trabajo').prop('checked', experiencia.actualmente_trabajo).trigger('change');\n    $('#fecha_inicio_experiencia')[0]._flatpickr.setDate(experiencia.fecha_inicio);\n    if ($('#fecha_fin_experiencia').length) {\n        $('#fecha_fin_experiencia')[0]._flatpickr.setDate(experiencia.fecha_fin || '');\n    }\n    $('#modalidad_trabajo_id').val(experiencia.modalidad_trabajo_id || '').trigger('change');\n    $('#funciones').val(experiencia.funciones || '');\n\n    // Ocultar el modal principal temporalmente sin destruirlo\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    // Abrir el modal secundario\n    $('#modal-agregar-experiencia-laboral').modal('show');\n\n    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-experiencia-laboral');\n        indice_editar = null;\n    });\n}\n\n/**\n * Elimina una experiencia laboral (reutiliza array de crear.js)\n *\n * @param {number} indice - Índice de la experiencia laboral a eliminar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction eliminarExperienciaLaboralRevision(indice) {\n    experiencias.splice(indice, 1);\n    mostrarExperienciasLaboralesRevision();\n    mostrarToast('success', 'Experiencia laboral eliminada exitosamente');\n}\n\n/**\n * Validación adicional para formularios de revisión de HV\n * Esta función es llamada automáticamente por configurarFormulario()\n * Maneja: formulario-revision-hv, formulario-nivel-educativo, formulario-experiencia-laboral\n *\n * @param {string} formulario - ID del formulario a validar\n * @returns {boolean}\n * @author Andres Gonzalez\n */\nfunction validacionAdicionalRevisionHV(formulario) {\n    let valido = true;\n\n    if (formulario == 'formulario-nivel-educativo') {\n        let errores = $('#formulario-nivel-educativo').find('input.error , select.error , textarea.error');\n        if (errores.length == 0) {\n            let fecha_inicio = $('#fecha_inicio_estudio').val() ? moment($('#fecha_inicio_estudio').val(), 'YYYY-MM-DD') : null;\n            let fecha_fin = $('#fecha_fin_estudio').val() ? moment($('#fecha_fin_estudio').val(), 'YYYY-MM-DD') : null;\n            let fecha_actual = moment();\n\n            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de inicio del estudio no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de finalización del estudio no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n                valido = false;\n            }\n\n            if (valido) {\n                let estudio = {\n                    titulo: $('#titulo').val(),\n                    institucion_educativa: $('#institucion_educativa').val(),\n                    nivel_educativo_id: parseInt($('#nivel_educativo_id').val()),\n                    nivel_educativo: $('#nivel_educativo_id option:selected').text().trim(),\n                    graduado: $('#cursando_estudios').prop('checked') ? false : true,\n                    fecha_inicio: $('#fecha_inicio_estudio').val(),\n                    fecha_fin: $('#fecha_fin_estudio').val() || null,\n                    jornada: $('#jornada').val() || null,\n                }\n                if (indice_editar == null) {\n                    estudios.push(estudio);\n                } else {\n                    estudios[indice_editar] = estudio;\n                    indice_editar = null;\n                }\n                mostrarNivelesEducativosRevision();\n                $('#modal-agregar-nivel-educativo').modal('hide');\n                mostrarToast('success', 'Nivel educativo guardado exitosamente');\n            }\n        }\n        return false;\n    }\n\n    if (formulario == 'formulario-experiencia-laboral') {\n        let errores = $('#formulario-experiencia-laboral').find('input.error , select.error , textarea.error');\n        if (errores.length == 0) {\n            let fecha_inicio = $('#fecha_inicio_experiencia').val() ? moment($('#fecha_inicio_experiencia').val(), 'YYYY-MM-DD') : null;\n            let fecha_fin = $('#fecha_fin_experiencia').val() ? moment($('#fecha_fin_experiencia').val(), 'YYYY-MM-DD') : null;\n            let fecha_actual = moment();\n\n            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de inicio de la experiencia no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de finalización de la experiencia no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n                valido = false;\n            }\n\n            if (valido) {\n                let modalidad_trabajo_id = $('#modalidad_trabajo_id').val();\n                let experiencia = {\n                    cargo: $('#cargo').val(),\n                    empresa: $('#empresa').val(),\n                    actualmente_trabajo: $('#actualmente_trabajo').prop('checked') ? 1 : 0,\n                    fecha_inicio: $('#fecha_inicio_experiencia').val(),\n                    fecha_fin: $('#fecha_fin_experiencia').val() || null,\n                    modalidad_trabajo_id: modalidad_trabajo_id ? parseInt(modalidad_trabajo_id) : null,\n                    funciones: $('#funciones').val() || '',\n                }\n                if (indice_editar == null) {\n                    experiencias.push(experiencia);\n                } else {\n                    experiencias[indice_editar] = experiencia;\n                    indice_editar = null;\n                }\n                mostrarExperienciasLaboralesRevision();\n                $('#modal-agregar-experiencia-laboral').modal('hide');\n                mostrarToast('success', 'Experiencia laboral guardada exitosamente');\n            }\n        }\n        return false;\n    }\n\n    if (formulario !== 'formulario-revision-hv') {\n        return true;\n    }\n\n    let errores = $('#formulario-revision-hv').find('input.error , select.error , textarea.error');\n    if (errores.length > 0) {\n        mostrarToast('danger', 'Faltan algunos datos obligatorios. Por favor, revisa la información e intenta nuevamente');\n        return false;\n    }\n\n    let salario = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n    if (salario < 0) {\n        mostrarToast('danger', 'El salario no puede ser un valor negativo.');\n        valido = false;\n    }\n\n    if ($('#revision_salario_maximo').length > 0) {\n        let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n        if (salario_maximo < 0) {\n            mostrarToast('danger', 'El salario máximo no puede ser un valor negativo.');\n            valido = false;\n        }\n        if (salario_maximo < salario) {\n            if (salario_maximo > 0) {\n                mostrarToast('danger', 'El salario máximo no puede ser menor que el salario mínimo.');\n            }\n            valido = false;\n        }\n    }\n\n    validarRangoSalarioRevision();\n\n    let habilidades_seleccionadas = $('#revision_select_habilidades').val();\n    $('#revision_hv_habilidades').val(Array.isArray(habilidades_seleccionadas) ? habilidades_seleccionadas.join(', ') : '');\n\n    let herramientas_seleccionadas = $('#revision_select_herramientas_tecnologicas').val();\n    $('#revision_hv_herramientas_tecnologicas').val(Array.isArray(herramientas_seleccionadas) ? herramientas_seleccionadas.join(', ') : '');    \n    $('#revision_hv_estudios').val(JSON.stringify(estudios.map(({ nivel_educativo, graduado, ...estudio }) => estudio)));\n\n    if (experiencias.length > 0) {\n        $('#revision_hv_experiencias_laborales').val(JSON.stringify(experiencias.map(({ actualmente_trabajo, ...experiencia }) => experiencia)));\n    } else {\n        $('#revision_hv_experiencias_laborales').val('');\n    }\n\n    let elementos_idiomas = $('.idioma');\n    let niveles = $('.nivel-idioma');\n    let idiomas_seleccionados = [];\n    for (let i = 0; i < elementos_idiomas.length; i++) {\n        idiomas_seleccionados.push({\n            idioma_id: parseInt($(elementos_idiomas[i]).val()),\n            nivel: $(niveles[i]).val()\n        });\n    }\n    if (idiomas_seleccionados.length == 0) {\n        $('#revision_hv_idiomas').val('');\n    } else {\n        $('#revision_hv_idiomas').val(JSON.stringify(idiomas_seleccionados));\n    }\n\n    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val();\n    let discapacidades_finales = [];\n    let usuario_id = parseInt($('#revision_hv_usuario_id').val());\n    if (discapacidades_seleccionadas) {\n        discapacidades_seleccionadas.forEach(discapacidad_id => {\n            let discapacidad = discapacidades.find(d => d.id == discapacidad_id);\n            if (discapacidad) {\n                let otra_discapacidad = null;\n                if (discapacidad.id == '5') {\n                    otra_discapacidad = $('#revision_otra_discapacidad').val().trim();\n                }\n                discapacidades_finales.push({\n                    usuario_id: usuario_id,\n                    discapacidad_id: parseInt(discapacidad_id),\n                    otra_discapacidad: otra_discapacidad\n                });\n            }\n        });\n        $('#revision_hv_discapacidades').val(JSON.stringify(discapacidades_finales));\n    } else {\n        $('#revision_hv_discapacidades').val('');\n    }\n\n    if (estudios.length == 0) {\n        mostrarToast('danger', 'Debes agregar al menos un nivel educativo para continuar.');\n        valido = false;\n    }\n\n    valido = validarFechasInicio(estudios);\n\n    if (experiencias.length == 0 && !$('#revision_no_experiencia').prop('checked')) {\n        mostrarToast('danger', 'Debes agregar al menos una experiencia laboral para continuar.');\n        valido = false;\n    }\n\n    return valido;\n}\n\n/**\n * Callback después de enviar exitosamente el formulario de revisión HV\n *\n * @param {Object} respuesta - Respuesta del servidor\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction postSuccessRevisionHV(respuesta) {\n    $('#modal-aplicacion-revision-hv').modal('hide');\n    limpiarFormularioRevisionHV();\n\n    // Recargar la tabla de tareas pendientes\n    actualizarDatatables('tabla-tareas-pendientes');\n}\n\n/**\n * Función para validar las fechas de inicio\n *\n * @param {Object} estudios - estudios del aplicante\n * @returns {boolean}\n * @author Jair Carvajal\n */\nfunction validarFechasInicio(estudios) {\n    let error = true;\n    for (const ESTUDIO of estudios) {\n        if (ESTUDIO.fecha_inicio === null) {\n            mostrarToast('danger', `El título ${ESTUDIO.titulo}. le hace falta la fecha de inicio para continuar.`);\n            error = false;\n        }\n    }\n    return error;\n}\n\n/**\n * Valida el rango de salario\n *\n * @returns {boolean}\n * @author Andres Gonzalez\n */\nfunction validarRangoSalarioRevision() {\n    if ($('input[name=\"tipo_salario\"]:checked').val() !== 'rango') {\n        return true;\n    }\n    let salario_desde = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n    let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n    let campo_hasta = $('#revision_salario_maximo');\n    let contenedor_hasta = campo_hasta.closest('.input-container');\n    campo_hasta.removeClass('error');\n    contenedor_hasta.siblings('label[for=\"revision_salario_maximo\"].error').remove();\n    if (salario_desde > 99 && salario_maximo > 99 && salario_desde >= salario_maximo) {\n        setTimeout(() => {\n            campo_hasta.addClass('error');\n            contenedor_hasta.after('<label for=\"revision_salario_maximo\" class=\"error text-red-cta\">El salario hasta no debe ser menor o igual al salario desde</label>');\n            return false;\n        }, 100);\n    }\n    return true;\n}\n\n/**\n * Limpiar formulario\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction limpiarFormularioRevisionHV() {\n    let formulario = $('#formulario-revision-hv');\n    formulario[0].reset();\n    formulario.find('.input-dinamico').removeClass('error');\n    formulario.find('label.error').remove();\n\n    $('#contenedor-idiomas-revision').empty();\n    $('#contenedor-discapacidad-revision').empty();\n    $('#contenedor-niveles-educativos-revision').empty();\n    $('#contenedor-experiencias-laborales-revision').empty();\n\n    $('#revision_select_habilidades').val('').trigger('change');\n    $('#revision_select_herramientas_tecnologicas').val('').trigger('change');\n    $('#revision_idiomas_seleccionados').val([]).multiselect('refresh');\n    $('#revision_select_discapacidades').val([]).multiselect('refresh');\n\n    $('#revision_opcion_licencia_conducir').prop('checked', false);\n    $('#revision_tipo_licencia').val('').prop('disabled', true).trigger('change');\n    $('#revision_vacante_apta_discapacitados').prop('checked', false);\n\n    estudios = [];\n    experiencias = [];\n    indice_editar = null;\n\n    inputsCleave();\n    actualizarSelect2();\n}\n","numLines":1294,"startLine":1,"totalLines":1294}}}
{"parentUuid":"536c91b2-32fa-4076-8c6d-36b02ecfcaf2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LAEbTuF2aGwKoBkAiKNBb9","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto, ahora entiendo el problema. El backend envía `modalidad_trabajo_id` con un valor (en tu ejemplo es `3`), pero en el modal de revisión HV (líneas 102-129 del archivo Blade) hay radio buttons para seleccionar la modalidad de trabajo del **perfil laboral del usuario**, no de cada experiencia laboral individual.\n\nEl problema es que cuando se pre-rellena el formulario con los datos existentes (función `preRellenarFormularioRevisionHV` en el JS), **no se está seleccionando el radio button de modalidad de trabajo** según el `modalidad_trabajo_id` que viene del backend.\n\nVoy a corregir esto:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":20108,"cache_read_input_tokens":62999,"cache_creation":{"ephemeral_5m_input_tokens":20108,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWvdDG9wcKsFuvaLSzcb2","type":"assistant","uuid":"5893a42d-54ad-4781-97d9-e1550f3ce81c","timestamp":"2026-01-08T21:31:45.447Z"}
{"parentUuid":"5893a42d-54ad-4781-97d9-e1550f3ce81c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LAEbTuF2aGwKoBkAiKNBb9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YQrNWD7p1EKrVivux9W5aP","name":"Edit","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js","old_string":"function preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }","new_string":"function preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    // Pre-seleccionar modalidad de trabajo\n    if (perfil.modalidad_trabajo_id) {\n        setTimeout(() => {\n            $(`input[name=\"modalidad_trabajo_id\"][value=\"${perfil.modalidad_trabajo_id}\"]`).prop('checked', true);\n        }, 100);\n    }\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":20108,"cache_read_input_tokens":62999,"cache_creation":{"ephemeral_5m_input_tokens":20108,"ephemeral_1h_input_tokens":0},"output_tokens":802,"service_tier":"standard"}},"requestId":"req_011CWvdDG9wcKsFuvaLSzcb2","type":"assistant","uuid":"8440d5fc-6f22-4148-ac89-2708c073830d","timestamp":"2026-01-08T21:31:53.087Z"}
{"type":"file-history-snapshot","messageId":"8440d5fc-6f22-4148-ac89-2708c073830d","snapshot":{"messageId":"023aacca-7afe-440f-aced-4e6521ea83b1","trackedFileBackups":{"app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php":{"backupFileName":"5419cff174eb966b@v2","version":2,"backupTime":"2026-01-08T21:31:18.886Z"},"public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js":{"backupFileName":"0a63c33c166bea46@v1","version":1,"backupTime":"2026-01-08T21:32:13.220Z"}},"timestamp":"2026-01-08T21:31:18.866Z"},"isSnapshotUpdate":true}
{"parentUuid":"8440d5fc-6f22-4148-ac89-2708c073830d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YQrNWD7p1EKrVivux9W5aP","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   156→ * @param {Object} perfil - Datos del perfil laboral\n   157→ * @returns {void}\n   158→ * @author Andres Gonzalez\n   159→ */\n   160→function preRellenarFormularioRevisionHV(perfil) {\n   161→    crearPerfilManualmenteRevision();\n   162→\n   163→    $('#id').val(perfil.id);\n   164→\n   165→    // Pre-seleccionar modalidad de trabajo\n   166→    if (perfil.modalidad_trabajo_id) {\n   167→        setTimeout(() => {\n   168→            $(`input[name=\"modalidad_trabajo_id\"][value=\"${perfil.modalidad_trabajo_id}\"]`).prop('checked', true);\n   169→        }, 100);\n   170→    }\n   171→\n   172→    if (perfil.salario) {\n   173→        if (perfil.salario_maximo) {\n   174→            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n   175→            setTimeout(() => {\n   176→                $('#revision_salario').val(perfil.salario);\n   177→                $('#revision_salario_maximo').val(perfil.salario_maximo);\n   178→            }, 200);\n   179→        } else {\n   180→            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n   181→            setTimeout(() => {\n   182→                $('#revision_salario').val(perfil.salario);\n   183→            }, 200);\n   184→        }\n   185→    }\n   186→\n   187→    if (perfil.habilidades) {\n   188→        let habilidades_array = perfil.habilidades.split(',')\n   189→            .map(h => h.trim())"}]},"uuid":"edbadba6-a132-4221-b369-6d2e01e37320","timestamp":"2026-01-08T21:32:13.283Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js","oldString":"function preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }","newString":"function preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    // Pre-seleccionar modalidad de trabajo\n    if (perfil.modalidad_trabajo_id) {\n        setTimeout(() => {\n            $(`input[name=\"modalidad_trabajo_id\"][value=\"${perfil.modalidad_trabajo_id}\"]`).prop('checked', true);\n        }, 100);\n    }\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }","originalFile":"var revision_hv_ia_activa = false;\n\nconst TIEMPO_MODAL_APERTURA = 300;\nconst TIEMPO_INICIALIZACION_COMPONENTES = 300;\nconst TIEMPO_TRIGGER_SELECT = 200;\nconst TIEMPO_FORMULARIO_MANUAL = 100;\n\nlet niveles_idiomas = [\n    {\n        id: 'A1',\n        nombre: 'A1'\n    },\n    {\n        id: 'A2',\n        nombre: 'A2'\n    },\n    {\n        id: 'B1',\n        nombre: 'B1'\n    },\n    {\n        id: 'B2',\n        nombre: 'B2'\n    },\n    {\n        id: 'C1',\n        nombre: 'C1'\n    },\n    {\n        id: 'C2',\n        nombre: 'C2'\n    },\n];\n\n$(document).ready(function() {\n    $(document).on('change', '#hv_archivo', function() {\n        if (revision_hv_ia_activa && this.files && this.files[0]) {\n            generarPerfilHVPorIARevision(this);\n        }\n    });\n});\n\n/**\n * Cierra el modal de revisión de hoja de vida\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction cerrarModalRevisionHV() {\n    $('#modal-aplicacion-revision-hv').modal('hide');\n}\n\n/**\n * Abre el modal de revisión de hoja de vida\n *\n * @param {Object} datos_etapa - Datos de la etapa\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalRevisionHV(datos_etapa) {\n    estudios = [];\n    experiencias = [];\n    indice_editar = null;\n\n    revision_hv_ia_activa = datos_etapa.configuracion_ia_hv == 1;\n\n    if (revision_hv_ia_activa) {\n        $('#alerta-ia-revision-hv').removeClass('d-none');\n    } else {\n        $('#alerta-ia-revision-hv').addClass('d-none');\n\n        setTimeout(() => {\n            crearPerfilManualmenteRevision();\n        }, TIEMPO_FORMULARIO_MANUAL);\n    }\n\n    // Limpiar contenedores\n    $('#contenedor-niveles-educativos-revision').empty();\n    $('#contenedor-experiencias-laborales-revision').empty();\n    $('#contenedor-campos-perfil-revision').addClass('d-none');\n    $('#contenedor-opciones-crear-ia-revision').removeClass('d-none');\n\n    // Sobreescribir temporalmente las funciones para este contexto\n    window.validacionAdicional = validacionAdicionalRevisionHV;\n    window.postSuccess = postSuccessRevisionHV;\n\n    configurarFormulario('formulario-revision-hv');\n    configurarFormulario('formulario-nivel-educativo');\n    configurarFormulario('formulario-experiencia-laboral');\n\n    $('#titulo-revision-hv').text(`Completa tu hoja de vida para: ${datos_etapa.vacante_nombre}`);\n\n    $('#revision_hv_etapa_vacante_usuario_id').val(datos_etapa.etapa_vacante_usuario_id || '');\n    $('#revision_hv_vacante_id').val(datos_etapa.vacante_id || '');\n    $('#revision_hv_etapa_id').val(datos_etapa.etapa_id || '');\n\n    let usuario_id = datos_etapa.usuario_id || $('#revision_hv_usuario_id').val();\n    $('#revision_hv_usuario_id').val(usuario_id);\n\n    $('#modal-aplicacion-revision-hv').modal('show');\n\n    consultarPerfilLaboralUsuario();\n\n    // Inicializar componentes\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n        inizializarMultiselect();\n        inicializarTooltips();\n        inicializarIputsFile();\n\n        // Limpiar espacios en blanco de habilidades y herramientas en tiempo real\n        $('#revision_select_habilidades, #revision_select_herramientas_tecnologicas').on('change', function() {\n            let valores = $(this).val();\n            if (Array.isArray(valores)) {\n                // Filtrar y limpiar espacios vacíos\n                let valores_limpios = valores.filter(v => v && v.trim() !== '').map(v => v.trim());\n                if (JSON.stringify(valores) !== JSON.stringify(valores_limpios)) {\n                    $(this).val(valores_limpios).trigger('change.select2');\n                }\n            }\n        });\n\n        configurarOverridesRevision();\n    }, TIEMPO_INICIALIZACION_COMPONENTES);\n}\n\n/**\n * Consulta el perfil laboral existente del usuario y pre-rellena el formulario\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction consultarPerfilLaboralUsuario() {\n    let usuario_id = $('#revision_hv_usuario_id').val();\n\n    if (!usuario_id) {\n        return;\n    }\n\n    $.ajax({\n        url: `/perfiles-laborales-consultar-usuario/${usuario_id}`,\n        type: 'GET',\n        success: function(respuesta) {\n            if (respuesta.data) {\n                preRellenarFormularioRevisionHV(respuesta.data);\n            }\n        },\n        error: function(error) {}\n    });\n}\n\n/**\n * Pre-rellena el formulario de revisión HV con datos existentes\n *\n * @param {Object} perfil - Datos del perfil laboral\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }\n\n    if (perfil.habilidades) {\n        let habilidades_array = perfil.habilidades.split(',')\n            .map(h => h.trim())\n            .filter(h => h !== ''); // Filtrar elementos vacíos\n        habilidades_array.forEach(habilidad => {\n            if (habilidad) {\n                let opcion = new Option(habilidad, habilidad, true, true);\n                $('#revision_select_habilidades').append(opcion);\n            }\n        });\n        $('#revision_select_habilidades').trigger('change');\n    }\n\n    if (perfil.herramientas_tecnologicas) {\n        let herramientas_array = perfil.herramientas_tecnologicas.split(',')\n            .map(h => h.trim())\n            .filter(h => h !== ''); // Filtrar elementos vacíos\n        herramientas_array.forEach(herramienta => {\n            if (herramienta) {\n                let opcion = new Option(herramienta, herramienta, true, true);\n                $('#revision_select_herramientas_tecnologicas').append(opcion);\n            }\n        });\n        $('#revision_select_herramientas_tecnologicas').trigger('change');\n    }\n\n    if (perfil.licencia_conducir) {\n        $('#revision_opcion_licencia_conducir').prop('checked', true).trigger('change');\n        setTimeout(() => {\n            $('#revision_tipo_licencia').val(perfil.licencia_conducir).trigger('change');\n        }, 100);\n    }\n\n    if (perfil.estudios && perfil.estudios.length > 0) {\n        estudios = perfil.estudios.map(estudio => ({\n            nivel_educativo_id: estudio.nivel_educativo_id,\n            nivel_educativo: estudio.nivel_educativo?.nombre || '',\n            titulo: estudio.titulo,\n            institucion_educativa: estudio.institucion_educativa,\n            fecha_inicio: estudio.fecha_inicio,\n            fecha_fin: estudio.fecha_fin,\n            jornada: estudio.jornada,\n            graduado: estudio.fecha_fin ? true : false\n        }));\n        mostrarNivelesEducativosRevision();\n    }\n\n    if (perfil.experiencias_laborales && perfil.experiencias_laborales.length > 0) {\n        experiencias = perfil.experiencias_laborales.map(exp => ({\n            empresa: exp.empresa,\n            cargo: exp.cargo,\n            fecha_inicio: exp.fecha_inicio,\n            fecha_fin: exp.fecha_fin,\n            actualmente_trabajo: exp.fecha_fin ? 0 : 1,\n            modalidad_trabajo_id: exp.modalidad_trabajo_id || null,\n            funciones: exp.funciones || ''\n        }));\n        mostrarExperienciasLaboralesRevision();\n        $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n    } else {\n        $('#revision_no_experiencia').prop('checked', true).trigger('change');\n    }\n\n    if (perfil.idiomas && perfil.idiomas.length > 0) {\n        let idiomas_ids = perfil.idiomas.map(idioma => idioma.idioma_id);\n        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n\n        setTimeout(() => {\n            perfil.idiomas.forEach(idioma => {\n                $(`#nivel_idioma_${idioma.idioma_id}`).val(idioma.nivel).trigger('change');\n            });\n        }, 200);\n    }\n\n    if (perfil.usuario && perfil.usuario.discapacidades && perfil.usuario.discapacidades.length > 0) {\n        $('#revision_vacante_apta_discapacitados').prop('checked', true).trigger('change');\n\n        setTimeout(() => {\n            let discapacidades_ids = perfil.usuario.discapacidades.map(disc => disc.id);\n            $('#revision_select_discapacidades').val(discapacidades_ids).multiselect('refresh');\n            seleccionarDiscapacidadRevision({name: 'revision_select_discapacidades'});\n\n            perfil.usuario.discapacidades.forEach(discapacidad => {\n                if (discapacidad.id === 5 && discapacidad.pivot.otra_discapacidad) { // ID 5 = \"Otra\"\n                    $('#revision_otra_discapacidad').val(discapacidad.pivot.otra_discapacidad);\n                }\n            });\n        }, 200);\n    }\n\n    // Reinicializar componentes después de rellenar\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n    }, 300);\n}\n\n/**\n * Configura los overrides de funciones globales para el contexto de revisión\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction configurarOverridesRevision() {\n    if (!window.mostrarNivelesEducativos_original_revision) {\n        window.mostrarNivelesEducativos_original_revision = window.mostrarNivelesEducativos;\n    }\n    if (!window.mostrarExperienciasLaborales_original_revision) {\n        window.mostrarExperienciasLaborales_original_revision = window.mostrarExperienciasLaborales;\n    }\n\n    window.mostrarNivelesEducativos = function() {\n        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-niveles-educativos-revision').length > 0) {\n            mostrarNivelesEducativosRevision();\n        } else if (typeof window.mostrarNivelesEducativos_original_revision === 'function') {\n            window.mostrarNivelesEducativos_original_revision();\n        }\n    };\n\n    window.mostrarExperienciasLaborales = function() {\n        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-experiencias-laborales-revision').length > 0) {\n            mostrarExperienciasLaboralesRevision();\n        } else if (typeof window.mostrarExperienciasLaborales_original_revision === 'function') {\n            window.mostrarExperienciasLaborales_original_revision();\n        }\n    };\n}\n\n/**\n * Genera el perfil de HV usando IA (versión para revisión)\n *\n * @param {HTMLElement} input_archivo - Input de archivo\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction generarPerfilHVPorIARevision(input_archivo) {\n    if (!input_archivo.files || !input_archivo.files[0]) {\n        return;\n    }\n\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-generando-ia-revision').modal('show');\n\n    $('#modal-generando-ia-revision').off('hidden.bs.modal.restaurar-ia').on('hidden.bs.modal.restaurar-ia', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n    });\n\n    let formulario = new FormData();\n    formulario.append('archivo', input_archivo.files[0]);\n    formulario.append('_method', 'POST');\n    formulario.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n\n    const vacanteId = $('#revision_hv_vacante_id').val()\n        || new URLSearchParams(window.location.search).get('vacante_id')\n        || '';\n    if (vacanteId) {\n        formulario.append('vacante_id', vacanteId);\n    }\n\n    $.ajax({\n        url: '/perfiles-laborales-leer-hv-ia',\n        type: 'POST',\n        data: formulario,\n        processData: false,\n        contentType: false,\n        success: function(respuesta) {\n            $('#modal-generando-ia-revision').modal('hide');\n            // Esperar a que se cierre el modal de IA antes de mostrar el principal\n            setTimeout(() => {\n                $('#modal-aplicacion-revision-hv').css('display', 'block');\n            }, TIEMPO_MODAL_APERTURA);\n\n            if (respuesta.data) {\n                // Mostrar formulario\n                crearPerfilManualmenteRevision();\n\n                // Llenar habilidades desde la IA\n                if (respuesta.data.habilidades) {\n                    $('#revision_select_habilidades').val([]);\n                    let habilidades_array = respuesta.data.habilidades.split(',').map(habilidad => habilidad.trim()).filter(habilidad => habilidad !== '');\n                    habilidades_array.forEach(habilidad => {\n                        if (habilidad) {\n                            let opcion = new Option(habilidad, habilidad, true, true);\n                            $('#revision_select_habilidades').append(opcion);\n                        }\n                    });\n                    $('#revision_select_habilidades').trigger('change');\n                }\n\n                // Llenar herramientas tecnológicas desde la IA\n                if (respuesta.data.herramientas_tecnologicas) {\n                    $('#revision_select_herramientas_tecnologicas').val([]);\n                    let herramientas_array = respuesta.data.herramientas_tecnologicas.split(',').map(herramienta => herramienta.trim()).filter(herramienta => herramienta !== '');\n                    herramientas_array.forEach(herramienta => {\n                        if (herramienta) {\n                            let opcion = new Option(herramienta, herramienta, true, true);\n                            $('#revision_select_herramientas_tecnologicas').append(opcion);\n                        }\n                    });\n                    $('#revision_select_herramientas_tecnologicas').trigger('change');\n                }\n\n                // Llenar salario si existe\n                if (respuesta.data.salario) {\n                    $('#revision_salario').val(respuesta.data.salario);\n                }\n\n                // Procesar estudios\n                if (respuesta.data.estudios && Array.isArray(respuesta.data.estudios)) {\n                    estudios = [];\n                    respuesta.data.estudios.forEach(estudio => {\n                        // Buscar el nivel educativo por nombre\n                        let nivel_educativo_encontrado = niveles_educativos.find(function(nivel) {\n                            return nivel.nombre.toLowerCase() === estudio.nivel_educativo.toLowerCase();\n                        });\n\n                        estudios.push({\n                            titulo: estudio.titulo,\n                            institucion_educativa: estudio.institucion_educativa,\n                            nivel_educativo_id: nivel_educativo_encontrado ? nivel_educativo_encontrado.id : null,\n                            nivel_educativo: estudio.nivel_educativo,\n                            fecha_inicio: estudio.fecha_inicio,\n                            fecha_fin: estudio.fecha_fin || null,\n                            jornada: estudio.jornada || 'Diurna',\n                            graduado: estudio.fecha_fin ? true : false\n                        });\n                    });\n                    mostrarNivelesEducativosRevision();\n                }\n\n                // Procesar experiencias laborales\n                if (respuesta.data.experiencias_laborales && Array.isArray(respuesta.data.experiencias_laborales)) {\n                    experiencias = [];\n                    respuesta.data.experiencias_laborales.forEach(experiencia => {\n                        experiencias.push({\n                            empresa: experiencia.empresa,\n                            cargo: experiencia.cargo,\n                            fecha_inicio: experiencia.fecha_inicio,\n                            fecha_fin: experiencia.fecha_fin || null,\n                            actualmente_trabajo: experiencia.fecha_fin ? 0 : 1,\n                            modalidad_trabajo_id: experiencia.modalidad_trabajo_id || null,\n                            funciones: experiencia.funciones || ''\n                        });\n                    });\n                    mostrarExperienciasLaboralesRevision();\n                    $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n                }\n\n                // Procesar idiomas\n                if (respuesta.data.idiomas && Array.isArray(respuesta.data.idiomas)) {\n                    // Mapear nombres de idiomas de la IA a IDs del sistema\n                    let idiomas_mapa = {\n                        'Inglés': 1,\n                        'Portugués': 2,\n                        'Francés': 3,\n                        'Alemán': 4,\n                        'Mandarín': 5,\n                        'Italiano': 6,\n                        'Ruso': 7,\n                        'Árabe': 8\n                    };\n\n                    let idiomas_ids = [];\n                    respuesta.data.idiomas.forEach(idioma_ia => {\n                        let idioma_id = idiomas_mapa[idioma_ia.idioma];\n                        if (idioma_id) {\n                            idiomas_ids.push(idioma_id);\n                        }\n                    });\n\n                    if (idiomas_ids.length > 0) {\n                        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n                        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n\n                        setTimeout(() => {\n                            respuesta.data.idiomas.forEach(idioma_ia => {\n                                let idioma_id = idiomas_mapa[idioma_ia.idioma];\n                                if (idioma_id) {\n                                    $(`#nivel_idioma_${idioma_id}`).val(idioma_ia.nivel).trigger('change');\n                                }\n                            });\n                        }, TIEMPO_TRIGGER_SELECT);\n                    }\n                }\n\n                revision_hv_ia_activa = false;\n                mostrarToast('success', 'Datos extraídos correctamente. Por favor verifica y completa la información.');\n            }\n        },\n        error: function(error) {\n            $('#modal-generando-ia-revision').modal('hide');\n\n            setTimeout(() => {\n                $('#modal-aplicacion-revision-hv').css('display', 'block');\n            }, TIEMPO_MODAL_APERTURA);\n            mostrarToast('danger', error.responseJSON?.message || 'Error al procesar el archivo con IA');\n            console.error(error);\n        }\n    });\n}\n\n/**\n * Muestra el formulario de perfil manualmente\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction crearPerfilManualmenteRevision() {\n    $('#contenedor-campos-perfil-revision').removeClass('d-none');\n    $('#contenedor-opciones-crear-ia-revision').addClass('d-none');\n}\n\n/**\n * Abre el modal para agregar un nivel educativo\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalNivelEducativoRevision() {\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-agregar-nivel-educativo').modal('show');\n    limpiarFormulario('formulario-nivel-educativo');\n    indice_editar = null;\n\n    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-nivel-educativo');\n        indice_editar = null;\n    });\n}\n\n/**\n * Abre el modal para agregar una experiencia laboral\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalExperienciaLaboralRevision() {\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-agregar-experiencia-laboral').modal('show');\n    limpiarFormulario('formulario-experiencia-laboral');\n    indice_editar = null;\n\n    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-experiencia-laboral');\n        indice_editar = null;\n    });\n}\n\n/**\n * Maneja el toggle de \"no tengo experiencia\"\n *\n * @param {boolean} marcado - Estado del toggle\n * @returns {void}\n * @author Andres Gonzalez\n * @author Andres Morales\n */\nfunction seleccionarNoTengoExperienciaRevision(marcado) {\n    if (marcado) {\n        $('#btn-agregar-experiencia-laboral-revision').addClass('d-none');\n        experiencias = [];\n        mostrarExperienciasLaboralesRevision();\n    } else {\n        $('#btn-agregar-experiencia-laboral-revision').removeClass('d-none');\n    }\n}\n\n/**\n * Cambia los campos de salario según el tipo seleccionado\n *\n * @param {string} tipo - Tipo de salario ('especifico' o 'rango')\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarSalarioRevision(tipo) {\n    $('#contenedor-campos-salario-revision').empty();\n    if (tipo == 'especifico') {\n        $('#contenedor-campos-salario-revision').append(`\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario',\n                    name: 'salario',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Cantidad',\n                    placeholder: '',\n                    min: 0,\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n        `);\n    } else if (tipo == 'rango') {\n        $('#contenedor-campos-salario-revision').append(`\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario',\n                    name: 'salario',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Desde',\n                    placeholder: '',\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    onkeyup: 'validarRangoSalarioRevision()',\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario_maximo',\n                    name: 'salario_maximo',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Hasta',\n                    placeholder: '',\n                    min: 0,\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    onkeyup: 'validarRangoSalarioRevision()',\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n        `);\n    }\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n        configurarFormulario('formulario-revision-hv');\n    }, 100);\n}\n\n/**\n * Maneja la selección de idiomas\n *\n * @param {HTMLElement} elemento - Elemento del multiselect\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarIdiomaRevision(elemento) {\n    let niveles = [];\n    $('input[name=\"multiselect_' + elemento.name + '\"]:checked').each(function () {\n        niveles.push({\n            id: parseInt($(this).val()),\n            nombre: $(this).closest('label').find('span').text().trim(),\n        });\n    });\n    let campos_idiomas = '';\n    for (let i = 0; i < niveles.length; i++) {\n        campos_idiomas += `\n            <div class=\"col-12 col-lg-6 mt-3\">\n                <div class=\"text-headline-6 text-gray-10\">${niveles[i].nombre}</div>\n                ${crearSelect2({\n                    opciones: niveles_idiomas,\n                    id: 'nivel_idioma_' + niveles[i].id,\n                    name: 'nivel_idioma_' + niveles[i].id,\n                    class: 'input-dinamico nivel-idioma',\n                    input_container_class: 'mt-2 mb-0',\n                    label: 'Nivel',\n                    value: $('#nivel_idioma_' + niveles[i].id).val(),\n                    required: true,\n                })}\n            </div>\n            <input type=\"hidden\" value=\"${niveles[i].id}\" class=\"input-dinamico idioma\">\n        `;\n    }\n    $('#contenedor-idiomas-revision').empty();\n    $('#contenedor-idiomas-revision').append(campos_idiomas);\n    actualizarSelect2();\n}\n\n/**\n * Maneja el toggle de licencia de conducir\n *\n * @param {HTMLElement} elemento - Elemento del toggle\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarLicenciaConducirRevision(elemento) {\n    let marcado = $(elemento).prop('checked');\n    if (!marcado) {\n        $('#revision_tipo_licencia').val('').trigger('change').trigger('select2:select');\n    }\n    $('#revision_tipo_licencia').prop('disabled', !marcado);\n}\n\n/**\n * Maneja el toggle de discapacidad\n *\n * @param {boolean} posee_discapacidad - Si tiene discapacidad\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarTengoDiscapacidadRevision(posee_discapacidad) {\n    $('#contenedor-discapacidad-revision').empty();\n    if (posee_discapacidad) {\n        $('#contenedor-discapacidad-revision').append(`\n            <div class=\"col-12 p-4 border rounded-3\">\n                <div class=\"row align-items-center pb-2\">\n                    <div class=\"col-12\">\n                        <label class=\"form-label fw-semibold\">Discapacidad</label>\n                    </div>\n                    <div class=\"col-6\">\n                        ${crearMultiselect({\n                            opciones: discapacidades,\n                            id: 'revision_select_discapacidades',\n                            name: 'revision_select_discapacidades',\n                            class: 'input-dinamico',\n                            input_container_class: 'mb-0',\n                            placeholder: 'Discapacidad',\n                            onchange: 'seleccionarDiscapacidadRevision(this.value)',\n                            required: true,\n                        })}\n                    </div>\n                    <div class=\"col-6\" id=\"contenedor-otra-discapacidad-revision\"></div>\n                </div>\n            </div>\n        `);\n        inizializarMultiselect();\n    }\n}\n\n/**\n * Maneja la selección de tipo de discapacidad\n *\n * @param {string} discapacidad_id - ID de la discapacidad\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarDiscapacidadRevision(discapacidad_id) {\n    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val() || [];\n    if (discapacidades_seleccionadas.includes('5')) {\n        let otra_discapacidad_existente = $('#revision_otra_discapacidad').length > 0;\n        if (!otra_discapacidad_existente) {\n            $('#contenedor-otra-discapacidad-revision').append(`\n                ${crearInput({\n                    id: 'revision_otra_discapacidad',\n                    name: 'revision_otra_discapacidad',\n                    class: 'input-dinamico',\n                    input_container_class: 'mb-0',\n                    label: '¿Cuál?',\n                    required: true,\n                })}\n            `);\n        }\n    } else {\n        $('#contenedor-otra-discapacidad-revision').empty();\n    }\n}\n\n/**\n * Muestra los niveles educativos agregados (reutiliza lógica de crear.js)\n *\n * @returns {void}\n * @author Andres Gonzalez\n * @author Jair Carvajal\n */\nfunction mostrarNivelesEducativosRevision() {\n    $('#contenedor-niveles-educativos-revision').empty();\n    if (estudios.length > 0) {\n        // Ordenar estudios usando función global reutilizable\n        let estudios_ordenados = ordenarEstudiosPorFecha(estudios);\n\n        estudios_ordenados.forEach((estudio) => {\n            $('#contenedor-niveles-educativos-revision').append(`\n                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"nivel-educativo-revision-${estudio.indice_original}\">\n                    <div class=\"row mb-2\">\n                        <div class=\"col-12 col-lg\">\n                            <p class=\"mb-1 fw-bold text-gray-20\">${estudio.titulo}</p>\n                            <p class=\"text-body-3 mb-1\">\n                                ${estudio.fecha_inicio || estudio.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n                                ${estudio.fecha_inicio ? moment(estudio.fecha_inicio).format(\"MMM YYYY\") : ''}\n                                ${estudio.fecha_inicio && !estudio.fecha_fin ? ' - Actualmente' : estudio.fecha_fin ? ` - ${moment(estudio.fecha_fin).format(\"MMM YYYY\")}` : ''}\n                                ${estudio.jornada ? ` - ${estudio.jornada}` : ''}\n                            </p>\n                            <p class=\"text-body-3 mb-1\"><i class=\"bi bi-buildings text-headline-5 me-2\"></i> ${estudio.institucion_educativa}</p>\n                        </div>\n                        <div class=\"col-auto\">\n                            <div class=\"row justify-content-end\">\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-primary btn-circle',\n                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n                                        onclick: `editarNivelEducativoRevision(${estudio.indice_original})`\n                                    })}\n                                </div>\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-danger btn-circle',\n                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n                                        onclick: `eliminarNivelEducativoRevision(${estudio.indice_original})`\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-12 mt-3\">\n                            <div class=\"row justify-content-between\">\n                                <div class=\"col-auto\">\n                                    <p class=\"text-body-3 text-gray-10 mb-0\">${estudio.nivel_educativo || ''}</p>\n                                </div>\n                                <div class=\"col-auto\">\n                                    <div class=\"row justify-content-end align-items-center\">\n                                        ${estudio.graduado ? `\n                                            <div class=\"col-auto pe-0\">\n                                                <i class=\"bi bi-mortarboard text-headline-5 text-cta-blue\"></i>\n                                            </div>\n                                            <div class=\"col-auto text-body-3 text-gray-10\">\n                                                Graduado\n                                            </div>\n                                        ` : `\n                                            <div class=\"col-auto pe-0\">\n                                                <i class=\"bi ${estudio.jornada == 'Diurna' ? 'bi-sun' : estudio.jornada == 'Nocturna' ? 'bi-moon' : ''} text-headline-5 text-cta-blue\"></i>\n                                            </div>\n                                            <div class=\"col-auto text-body-3 text-gray-10\">\n                                                ${estudio.jornada ? 'Modalidad:' : ''} ${estudio.jornada || ''}\n                                            </div>\n                                        `}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `);\n        });\n    }\n}\n\n/**\n * Muestra las experiencias laborales agregadas\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction mostrarExperienciasLaboralesRevision() {\n    $('#contenedor-experiencias-laborales-revision').empty();\n    if (experiencias.length > 0) {\n        $('#revision_no_experiencia').prop('disabled', true);\n        // Ordenar experiencias usando función global reutilizable\n        let experiencias_ordenadas = ordenarExperienciasPorFecha(experiencias);\n\n        experiencias_ordenadas.forEach((experiencia) => {\n            let modalidades = {1: 'Presencial', 2: 'Híbrido', 3: 'Remoto'};\n            let html_modalidad = experiencia.modalidad_trabajo_id ? `\n                <div class=\"mt-2\">\n                    <small class=\"text-gray-30\">Modalidad:</small>\n                    <span class=\"badge bg-primary ms-2\">${modalidades[experiencia.modalidad_trabajo_id]}</span>\n                </div>\n            ` : '';\n            let html_funciones = experiencia.funciones ? `\n                <div class=\"mt-2\">\n                    <small class=\"text-gray-30 d-block\">Funciones:</small>\n                    <p class=\"text-body-3 mb-0\">${experiencia.funciones}</p>\n                </div>\n            ` : '';\n            $('#contenedor-experiencias-laborales-revision').append(`\n                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"experiencia-laboral-revision-${experiencia.indice_original}\">\n                    <div class=\"row mb-2\">\n                        <div class=\"col-lg\">\n                            <p class=\"mb-1 fw-bold text-gray-20\">${experiencia.cargo}</p>\n                            <p class=\"text-body-3 mb-2\">\n                                ${experiencia.fecha_inicio || experiencia.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n                                ${experiencia.fecha_inicio ? moment(experiencia.fecha_inicio).format(\"MMM YYYY\") + (experiencia.fecha_fin ? ` - ${moment(experiencia.fecha_fin).format(\"MMM YYYY\")}` : \" - Actualmente\") : \"\"}\n                                ${experiencia.fecha_inicio && experiencia.fecha_fin ? (() => {\n                                    let inicio = moment(experiencia.fecha_inicio);\n                                    let fin = moment(experiencia.fecha_fin);\n                                    let anios = fin.diff(inicio, 'years');\n                                    let meses = fin.diff(inicio.add(anios, 'years'), 'months');\n                                    let texto = '';\n                                    if (anios > 0) texto += `${anios} año${anios > 1 ? 's' : ''}`;\n                                    if (meses > 0) texto += `${anios > 0 ? ' y ' : ''}${meses} mes${meses > 1 ? 'es' : ''}`;\n                                    return texto ? ` | ${texto}` : '';\n                                })() : ''}\n                            </p>\n                            <p class=\"text-body-3 mb-1 fw-semibold text-gray-10\">${experiencia.empresa}</p>\n                            ${html_modalidad}\n                            ${html_funciones}\n                        </div>\n                        <div class=\"col-auto\">\n                            <div class=\"row justify-content-end\">\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-primary btn-circle',\n                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n                                        onclick: `editarExperienciaLaboralRevision(${experiencia.indice_original})`\n                                    })}\n                                </div>\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-danger btn-circle',\n                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n                                        onclick: `eliminarExperienciaLaboralRevision(${experiencia.indice_original})`\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `);\n        });\n    } else {\n        $('#revision_no_experiencia').prop('disabled', false);\n    }\n}\n\n/**\n * Edita un nivel educativo existente (reutiliza variables de crear.js)\n *\n * @param {number} indice - Índice del nivel educativo a editar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction editarNivelEducativoRevision(indice) {\n    indice_editar = indice;\n    let estudio = estudios[indice];\n    $('#titulo').val(estudio.titulo);\n    $('#institucion_educativa').val(estudio.institucion_educativa);\n    $('#cursando_estudios').prop('checked', !estudio.graduado).trigger('change');\n    $('#nivel_educativo_id').val(estudio.nivel_educativo_id).trigger('change');\n    $('#fecha_inicio_estudio')[0]._flatpickr.setDate(estudio.fecha_inicio);\n    if ($('#fecha_fin_estudio').length > 0) {\n        $('#fecha_fin_estudio')[0]._flatpickr.setDate(estudio.fecha_fin || '');\n    }\n\n    // Ocultar el modal principal temporalmente sin destruirlo\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    // Abrir el modal secundario\n    $('#modal-agregar-nivel-educativo').modal('show');\n\n    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-nivel-educativo');\n        indice_editar = null;\n    });\n}\n\n/**\n * Elimina un nivel educativo (reutiliza array de crear.js)\n *\n * @param {number} indice - Índice del nivel educativo a eliminar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction eliminarNivelEducativoRevision(indice) {\n    estudios.splice(indice, 1);\n    mostrarNivelesEducativosRevision();\n    mostrarToast('success', 'Nivel educativo eliminado exitosamente');\n}\n\n/**\n * Edita una experiencia laboral existente (reutiliza variables de crear.js)\n *\n * @param {number} indice - Índice de la experiencia laboral a editar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction editarExperienciaLaboralRevision(indice) {\n    indice_editar = indice;\n    let experiencia = experiencias[indice];\n    $('#cargo').val(experiencia.cargo);\n    $('#empresa').val(experiencia.empresa);\n    $('#actualmente_trabajo').prop('checked', experiencia.actualmente_trabajo).trigger('change');\n    $('#fecha_inicio_experiencia')[0]._flatpickr.setDate(experiencia.fecha_inicio);\n    if ($('#fecha_fin_experiencia').length) {\n        $('#fecha_fin_experiencia')[0]._flatpickr.setDate(experiencia.fecha_fin || '');\n    }\n    $('#modalidad_trabajo_id').val(experiencia.modalidad_trabajo_id || '').trigger('change');\n    $('#funciones').val(experiencia.funciones || '');\n\n    // Ocultar el modal principal temporalmente sin destruirlo\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    // Abrir el modal secundario\n    $('#modal-agregar-experiencia-laboral').modal('show');\n\n    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-experiencia-laboral');\n        indice_editar = null;\n    });\n}\n\n/**\n * Elimina una experiencia laboral (reutiliza array de crear.js)\n *\n * @param {number} indice - Índice de la experiencia laboral a eliminar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction eliminarExperienciaLaboralRevision(indice) {\n    experiencias.splice(indice, 1);\n    mostrarExperienciasLaboralesRevision();\n    mostrarToast('success', 'Experiencia laboral eliminada exitosamente');\n}\n\n/**\n * Validación adicional para formularios de revisión de HV\n * Esta función es llamada automáticamente por configurarFormulario()\n * Maneja: formulario-revision-hv, formulario-nivel-educativo, formulario-experiencia-laboral\n *\n * @param {string} formulario - ID del formulario a validar\n * @returns {boolean}\n * @author Andres Gonzalez\n */\nfunction validacionAdicionalRevisionHV(formulario) {\n    let valido = true;\n\n    if (formulario == 'formulario-nivel-educativo') {\n        let errores = $('#formulario-nivel-educativo').find('input.error , select.error , textarea.error');\n        if (errores.length == 0) {\n            let fecha_inicio = $('#fecha_inicio_estudio').val() ? moment($('#fecha_inicio_estudio').val(), 'YYYY-MM-DD') : null;\n            let fecha_fin = $('#fecha_fin_estudio').val() ? moment($('#fecha_fin_estudio').val(), 'YYYY-MM-DD') : null;\n            let fecha_actual = moment();\n\n            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de inicio del estudio no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de finalización del estudio no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n                valido = false;\n            }\n\n            if (valido) {\n                let estudio = {\n                    titulo: $('#titulo').val(),\n                    institucion_educativa: $('#institucion_educativa').val(),\n                    nivel_educativo_id: parseInt($('#nivel_educativo_id').val()),\n                    nivel_educativo: $('#nivel_educativo_id option:selected').text().trim(),\n                    graduado: $('#cursando_estudios').prop('checked') ? false : true,\n                    fecha_inicio: $('#fecha_inicio_estudio').val(),\n                    fecha_fin: $('#fecha_fin_estudio').val() || null,\n                    jornada: $('#jornada').val() || null,\n                }\n                if (indice_editar == null) {\n                    estudios.push(estudio);\n                } else {\n                    estudios[indice_editar] = estudio;\n                    indice_editar = null;\n                }\n                mostrarNivelesEducativosRevision();\n                $('#modal-agregar-nivel-educativo').modal('hide');\n                mostrarToast('success', 'Nivel educativo guardado exitosamente');\n            }\n        }\n        return false;\n    }\n\n    if (formulario == 'formulario-experiencia-laboral') {\n        let errores = $('#formulario-experiencia-laboral').find('input.error , select.error , textarea.error');\n        if (errores.length == 0) {\n            let fecha_inicio = $('#fecha_inicio_experiencia').val() ? moment($('#fecha_inicio_experiencia').val(), 'YYYY-MM-DD') : null;\n            let fecha_fin = $('#fecha_fin_experiencia').val() ? moment($('#fecha_fin_experiencia').val(), 'YYYY-MM-DD') : null;\n            let fecha_actual = moment();\n\n            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de inicio de la experiencia no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de finalización de la experiencia no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n                valido = false;\n            }\n\n            if (valido) {\n                let modalidad_trabajo_id = $('#modalidad_trabajo_id').val();\n                let experiencia = {\n                    cargo: $('#cargo').val(),\n                    empresa: $('#empresa').val(),\n                    actualmente_trabajo: $('#actualmente_trabajo').prop('checked') ? 1 : 0,\n                    fecha_inicio: $('#fecha_inicio_experiencia').val(),\n                    fecha_fin: $('#fecha_fin_experiencia').val() || null,\n                    modalidad_trabajo_id: modalidad_trabajo_id ? parseInt(modalidad_trabajo_id) : null,\n                    funciones: $('#funciones').val() || '',\n                }\n                if (indice_editar == null) {\n                    experiencias.push(experiencia);\n                } else {\n                    experiencias[indice_editar] = experiencia;\n                    indice_editar = null;\n                }\n                mostrarExperienciasLaboralesRevision();\n                $('#modal-agregar-experiencia-laboral').modal('hide');\n                mostrarToast('success', 'Experiencia laboral guardada exitosamente');\n            }\n        }\n        return false;\n    }\n\n    if (formulario !== 'formulario-revision-hv') {\n        return true;\n    }\n\n    let errores = $('#formulario-revision-hv').find('input.error , select.error , textarea.error');\n    if (errores.length > 0) {\n        mostrarToast('danger', 'Faltan algunos datos obligatorios. Por favor, revisa la información e intenta nuevamente');\n        return false;\n    }\n\n    let salario = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n    if (salario < 0) {\n        mostrarToast('danger', 'El salario no puede ser un valor negativo.');\n        valido = false;\n    }\n\n    if ($('#revision_salario_maximo').length > 0) {\n        let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n        if (salario_maximo < 0) {\n            mostrarToast('danger', 'El salario máximo no puede ser un valor negativo.');\n            valido = false;\n        }\n        if (salario_maximo < salario) {\n            if (salario_maximo > 0) {\n                mostrarToast('danger', 'El salario máximo no puede ser menor que el salario mínimo.');\n            }\n            valido = false;\n        }\n    }\n\n    validarRangoSalarioRevision();\n\n    let habilidades_seleccionadas = $('#revision_select_habilidades').val();\n    $('#revision_hv_habilidades').val(Array.isArray(habilidades_seleccionadas) ? habilidades_seleccionadas.join(', ') : '');\n\n    let herramientas_seleccionadas = $('#revision_select_herramientas_tecnologicas').val();\n    $('#revision_hv_herramientas_tecnologicas').val(Array.isArray(herramientas_seleccionadas) ? herramientas_seleccionadas.join(', ') : '');    \n    $('#revision_hv_estudios').val(JSON.stringify(estudios.map(({ nivel_educativo, graduado, ...estudio }) => estudio)));\n\n    if (experiencias.length > 0) {\n        $('#revision_hv_experiencias_laborales').val(JSON.stringify(experiencias.map(({ actualmente_trabajo, ...experiencia }) => experiencia)));\n    } else {\n        $('#revision_hv_experiencias_laborales').val('');\n    }\n\n    let elementos_idiomas = $('.idioma');\n    let niveles = $('.nivel-idioma');\n    let idiomas_seleccionados = [];\n    for (let i = 0; i < elementos_idiomas.length; i++) {\n        idiomas_seleccionados.push({\n            idioma_id: parseInt($(elementos_idiomas[i]).val()),\n            nivel: $(niveles[i]).val()\n        });\n    }\n    if (idiomas_seleccionados.length == 0) {\n        $('#revision_hv_idiomas').val('');\n    } else {\n        $('#revision_hv_idiomas').val(JSON.stringify(idiomas_seleccionados));\n    }\n\n    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val();\n    let discapacidades_finales = [];\n    let usuario_id = parseInt($('#revision_hv_usuario_id').val());\n    if (discapacidades_seleccionadas) {\n        discapacidades_seleccionadas.forEach(discapacidad_id => {\n            let discapacidad = discapacidades.find(d => d.id == discapacidad_id);\n            if (discapacidad) {\n                let otra_discapacidad = null;\n                if (discapacidad.id == '5') {\n                    otra_discapacidad = $('#revision_otra_discapacidad').val().trim();\n                }\n                discapacidades_finales.push({\n                    usuario_id: usuario_id,\n                    discapacidad_id: parseInt(discapacidad_id),\n                    otra_discapacidad: otra_discapacidad\n                });\n            }\n        });\n        $('#revision_hv_discapacidades').val(JSON.stringify(discapacidades_finales));\n    } else {\n        $('#revision_hv_discapacidades').val('');\n    }\n\n    if (estudios.length == 0) {\n        mostrarToast('danger', 'Debes agregar al menos un nivel educativo para continuar.');\n        valido = false;\n    }\n\n    valido = validarFechasInicio(estudios);\n\n    if (experiencias.length == 0 && !$('#revision_no_experiencia').prop('checked')) {\n        mostrarToast('danger', 'Debes agregar al menos una experiencia laboral para continuar.');\n        valido = false;\n    }\n\n    return valido;\n}\n\n/**\n * Callback después de enviar exitosamente el formulario de revisión HV\n *\n * @param {Object} respuesta - Respuesta del servidor\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction postSuccessRevisionHV(respuesta) {\n    $('#modal-aplicacion-revision-hv').modal('hide');\n    limpiarFormularioRevisionHV();\n\n    // Recargar la tabla de tareas pendientes\n    actualizarDatatables('tabla-tareas-pendientes');\n}\n\n/**\n * Función para validar las fechas de inicio\n *\n * @param {Object} estudios - estudios del aplicante\n * @returns {boolean}\n * @author Jair Carvajal\n */\nfunction validarFechasInicio(estudios) {\n    let error = true;\n    for (const ESTUDIO of estudios) {\n        if (ESTUDIO.fecha_inicio === null) {\n            mostrarToast('danger', `El título ${ESTUDIO.titulo}. le hace falta la fecha de inicio para continuar.`);\n            error = false;\n        }\n    }\n    return error;\n}\n\n/**\n * Valida el rango de salario\n *\n * @returns {boolean}\n * @author Andres Gonzalez\n */\nfunction validarRangoSalarioRevision() {\n    if ($('input[name=\"tipo_salario\"]:checked').val() !== 'rango') {\n        return true;\n    }\n    let salario_desde = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n    let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n    let campo_hasta = $('#revision_salario_maximo');\n    let contenedor_hasta = campo_hasta.closest('.input-container');\n    campo_hasta.removeClass('error');\n    contenedor_hasta.siblings('label[for=\"revision_salario_maximo\"].error').remove();\n    if (salario_desde > 99 && salario_maximo > 99 && salario_desde >= salario_maximo) {\n        setTimeout(() => {\n            campo_hasta.addClass('error');\n            contenedor_hasta.after('<label for=\"revision_salario_maximo\" class=\"error text-red-cta\">El salario hasta no debe ser menor o igual al salario desde</label>');\n            return false;\n        }, 100);\n    }\n    return true;\n}\n\n/**\n * Limpiar formulario\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction limpiarFormularioRevisionHV() {\n    let formulario = $('#formulario-revision-hv');\n    formulario[0].reset();\n    formulario.find('.input-dinamico').removeClass('error');\n    formulario.find('label.error').remove();\n\n    $('#contenedor-idiomas-revision').empty();\n    $('#contenedor-discapacidad-revision').empty();\n    $('#contenedor-niveles-educativos-revision').empty();\n    $('#contenedor-experiencias-laborales-revision').empty();\n\n    $('#revision_select_habilidades').val('').trigger('change');\n    $('#revision_select_herramientas_tecnologicas').val('').trigger('change');\n    $('#revision_idiomas_seleccionados').val([]).multiselect('refresh');\n    $('#revision_select_discapacidades').val([]).multiselect('refresh');\n\n    $('#revision_opcion_licencia_conducir').prop('checked', false);\n    $('#revision_tipo_licencia').val('').prop('disabled', true).trigger('change');\n    $('#revision_vacante_apta_discapacitados').prop('checked', false);\n\n    estudios = [];\n    experiencias = [];\n    indice_editar = null;\n\n    inputsCleave();\n    actualizarSelect2();\n}\n","structuredPatch":[{"oldStart":162,"oldLines":6,"newStart":162,"newLines":13,"lines":[" ","     $('#id').val(perfil.id);"," ","+    // Pre-seleccionar modalidad de trabajo","+    if (perfil.modalidad_trabajo_id) {","+        setTimeout(() => {","+            $(`input[name=\"modalidad_trabajo_id\"][value=\"${perfil.modalidad_trabajo_id}\"]`).prop('checked', true);","+        }, 100);","+    }","+","     if (perfil.salario) {","         if (perfil.salario_maximo) {","             $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"edbadba6-a132-4221-b369-6d2e01e37320","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.0.74","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PwE3v6T9H1EAZ1hVwWJQFF","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. He agregado el código para pre-seleccionar la modalidad de trabajo cuando se carga el perfil laboral existente del usuario.\n\n## Resumen de los cambios realizados:\n\n### 1. **Servicio Backend** ([EtapaVacanteUsuarioService.php](c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php:541))\n- Agregué el parámetro `$forzar_actualizacion` (por defecto `false`) a la función `guardarPuntajeAdecuacionReclutador`\n- Modificada la validación para omitir el chequeo de `is_null($etapa_usuario->puntaje)` cuando `$forzar_actualizacion = true`\n\n### 2. **Frontend JavaScript** ([aplicacion-revision-hv.js](c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js:166-170))\n- Agregué código en la función `preRellenarFormularioRevisionHV` para seleccionar automáticamente el radio button de modalidad de trabajo según el valor `modalidad_trabajo_id` que viene del backend\n\n## Cómo funciona:\n\nCuando el backend devuelve:\n```json\n{\n    \"data\": {\n        \"id\": 6,\n        \"usuario_id\": 25,\n        \"modalidad_trabajo_id\": 3,\n        \"salario\": 3541545,\n        ...\n    }\n}\n```\n\nAhora el frontend:\n1. Detecta que `perfil.modalidad_trabajo_id` existe y tiene valor `3`\n2. Selecciona automáticamente el radio button con `value=\"3\"` (que sería \"Remoto\")\n3. Lo hace con un pequeño timeout de 100ms para asegurar que los componentes estén renderizados\n\nEl radio button correspondiente quedará marcado correctamente en el modal."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3368,"cache_read_input_tokens":83107,"cache_creation":{"ephemeral_5m_input_tokens":3368,"ephemeral_1h_input_tokens":0},"output_tokens":506,"service_tier":"standard"}},"requestId":"req_011CWvdG4trTxgi74rQw7BWb","type":"assistant","uuid":"f617782a-f0eb-4142-83b6-b6cab2c75b71","timestamp":"2026-01-08T21:32:30.268Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-09T16:20:34.855Z","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8"}
{"type":"file-history-snapshot","messageId":"ce6b53f8-8f47-434a-a7b7-4f08de5ab95e","snapshot":{"messageId":"ce6b53f8-8f47-434a-a7b7-4f08de5ab95e","trackedFileBackups":{"app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php":{"backupFileName":"5419cff174eb966b@v3","version":3,"backupTime":"2026-01-09T16:20:36.134Z"},"public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js":{"backupFileName":"0a63c33c166bea46@v2","version":2,"backupTime":"2026-01-09T16:20:36.153Z"}},"timestamp":"2026-01-09T16:20:36.120Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 543 to 543 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php:\n&& is_null($etapa_usuario->puntaje)\n\nThis may or may not be related to the current task.</ide_selection>"}]},"uuid":"3ebd859c-c22b-410a-aa64-548a9a26e454","timestamp":"2026-01-08T15:59:52.609Z"}
{"parentUuid":"3ebd859c-c22b-410a-aa64-548a9a26e454","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"text","text":"listo en esta funcion public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void { alk komneto d ehacer sta validacion && is_null($etapa_usuario->puntaje) quiero que esa validacion no se aplique si llega otro prameto como true y que por defecto se afalse para que aplique esa validacion"}]},"uuid":"01cb658e-aa08-4be5-a443-93dac4789221","timestamp":"2026-01-08T15:59:52.609Z"}
{"parentUuid":"01cb658e-aa08-4be5-a443-93dac4789221","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T15:59:59.192Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011Sxn7AN1pP8KJz2btzmRsz","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a modificar la función `guardarPuntajeAdecuacionReclutador` para agregar un parámetro que permita omitir la validación de `is_null($etapa_usuario->puntaje)`.\n\nPrimero, déjame leer el archivo completo para entender el contexto:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":24401,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24401,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvBuyuztDKcqyyBb4PA6","uuid":"90ee2a1a-30dc-4fc8-9926-b42f9b14c613"}
{"parentUuid":"90ee2a1a-30dc-4fc8-9926-b42f9b14c613","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T16:00:00.140Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_011Sxn7AN1pP8KJz2btzmRsz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VG8JtuyPgJE8wnKDcdLP5a","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":24401,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24401,"ephemeral_1h_input_tokens":0},"output_tokens":169,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvBuyuztDKcqyyBb4PA6","uuid":"035c8a9b-06e3-45e0-80bc-3825e3f60b4c"}
{"parentUuid":"035c8a9b-06e3-45e0-80bc-3825e3f60b4c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VG8JtuyPgJE8wnKDcdLP5a","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Vacantes;\n     4→\n     5→use App\\Traits\\IATrait;\n     6→use App\\Traits\\StringTrait;\n     7→use Illuminate\\Support\\Arr;\n     8→use App\\Traits\\ArchivoTrait;\n     9→use Illuminate\\Http\\Request;\n    10→use App\\Models\\Vacantes\\Vacante;\n    11→use App\\Http\\Services\\BaseService;\n    12→use App\\Models\\Agendas\\EstadoAgenda;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Illuminate\\Support\\Facades\\Mail;\n    15→use App\\Models\\Vacantes\\EtapaVacante;\n    16→use App\\Models\\Vacantes\\EstadoVacante;\n    17→use App\\Models\\Vacantes\\MovimientoVacante;\n    18→use App\\Mail\\NotificarFinalizacionEtapaMail;\n    19→use App\\Mail\\NotificarPostulanteVacanteMail;\n    20→use App\\Models\\Vacantes\\EtapaVacanteUsuario;\n    21→use Illuminate\\Http\\Client\\RequestException;\n    22→use App\\Http\\Services\\Vacantes\\VacanteService;\n    23→use App\\Models\\Configuraciones\\PlantillaCorreo;\n    24→use Illuminate\\Http\\Client\\ConnectionException;\n    25→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    26→use App\\Http\\Services\\Usuarios\\TokenAccesoService;\n    27→use App\\Http\\Repositories\\Agendas\\AgendaRepository;\n    28→use App\\Http\\Services\\Vacantes\\EtapaVacanteService;\n    29→use App\\Jobs\\Vacantes\\ProcesarVideoentrevistaIAJob;\n    30→use App\\Http\\Repositories\\Procesos\\ProcesoRepository;\n    31→use App\\Http\\Repositories\\Vacantes\\VacanteRepository;\n    32→use App\\Http\\Services\\Agendas\\ResultadoAgendaService;\n    33→use App\\Http\\Services\\Configuraciones\\ArchivoService;\n    34→use App\\Notifications\\NotificarAvanceProcesoNotification;\n    35→use App\\Http\\Repositories\\Vacantes\\EtapaVacanteRepository;\n    36→use App\\Http\\Repositories\\Vacantes\\TranscripcionRepository;\n    37→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    38→use App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    39→use App\\Http\\Repositories\\Vacantes\\AspectoPuntajeRepository;\n    40→use App\\Http\\Services\\Configuraciones\\PlantillaCorreoService;\n    41→use App\\Http\\Repositories\\Vacantes\\FormatoEntrevistaRepository;\n    42→use App\\Http\\Repositories\\Vacantes\\EtapaVacanteUsuarioRepository;\n    43→use App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\n    44→use App\\Http\\Repositories\\Vacantes\\EtapaMovimientoVacanteRepository;\n    45→use App\\Http\\Repositories\\OfertasLaborales\\PreguntaOfertaLaboralRepository;\n    46→use App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\n    47→use App\\Http\\Repositories\\OfertasLaborales\\PuntajePreguntaOfertaLaboralRepository;\n    48→\n    49→/**\n    50→ * @property EtapaVacanteUsuarioRepository $repositorio\n    51→ */\n    52→class EtapaVacanteUsuarioService extends BaseService\n    53→{\n    54→    use ArchivoTrait, IATrait, StringTrait;\n    55→\n    56→    /**\n    57→     * @var float|int $puntaje_total Puntaje total, utilizado para la adecuación de HV.\n    58→     */\n    59→    private $puntaje_total = 0;\n    60→\n    61→    /**\n    62→     * @var float $puntaje Puntaje de aspecto, utilizado para la adecuación de HV.\n    63→     */\n    64→    private $puntaje = 0;\n    65→\n    66→    /**\n    67→     * @var bool $cumple Indica si cumple con el aspecto, utilizada para la adecuación de HV.\n    68→     */\n    69→    private $cumple = false;\n    70→\n    71→    /**\n    72→     * Constructor.\n    73→     *\n    74→     * @param EtapaVacanteUsuarioRepository $repositorio Repositorio de etapas de vacantes de usuarios.\n    75→     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n    76→     * @param EtapaVacanteRepository $etapa_vacante_repositorio Repositorio de etapas de vacantes.\n    77→     * @param AspectoPuntajeRepository $aspecto_puntaje_repositorio Repositorio de puntajes de aspectos.\n    78→     * @param ArchivoService $archivo_servicio Servicio de archivos.\n    79→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    80→     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n    81→     * @param PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio Repositorio de preguntas de ofertas laborales.\n    82→     * @param PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio Repositorio de puntajes de preguntas de ofertas laborales.\n    83→     * @param EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio Repositorio de movimientos de etapas de vacantes.\n    84→     * @param ProcesoRepository $proceso_repositorio Repositorio de procesos.\n    85→     * @param TranscripcionRepository $transcripcion_repositorio Repositorio de transcripciones.\n    86→     * @param PlantillaCorreoService $plantilla_correo_servicio Servicio de plantillas de correo.\n    87→     * @param TokenAccesoService $token_acceso_servicio Servicio de tokens de acceso.\n    88→     * @param UserRepository $usuario_repositorio Servicio de usuarios.\n    89→     * @param VacanteRepository $vacante_repositorio Repositorio de vacantes.\n    90→     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n    91→     * @param ResultadoAgendaService $resultado_agenda_servicio Servicio de resultados de agendas.\n    92→     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n    93→     * @param FormatoEntrevistaRepository $formato_entrevista_repositorio Repositorio de formatos de entrevista.\n    94→     * @return void\n    95→     * @author Daniel Beltrán\n    96→     * @author Andres Gonzalez\n    97→     */\n    98→    public function __construct(\n    99→        EtapaVacanteUsuarioRepository $repositorio,\n   100→        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n   101→        protected EtapaVacanteRepository $etapa_vacante_repositorio,\n   102→        protected AspectoPuntajeRepository $aspecto_puntaje_repositorio,\n   103→        protected ArchivoService $archivo_servicio,\n   104→        protected ArchivoRepository $archivo_repositorio,\n   105→        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n   106→        protected PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio,\n   107→        protected PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio,\n   108→        protected EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio,\n   109→        protected ProcesoRepository $proceso_repositorio,\n   110→        protected TranscripcionRepository $transcripcion_repositorio,\n   111→        protected PlantillaCorreoService $plantilla_correo_servicio,\n   112→        protected TokenAccesoService $token_acceso_servicio,\n   113→        protected UserRepository $usuario_repositorio,\n   114→        protected VacanteRepository $vacante_repositorio,\n   115→        protected AgendaRepository $agenda_repositorio,\n   116→        protected ResultadoAgendaService $resultado_agenda_servicio,\n   117→        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n   118→        protected FormatoEntrevistaRepository $formato_entrevista_repositorio\n   119→    ) {\n   120→        parent::__construct($repositorio);\n   121→    }\n   122→\n   123→    /**\n   124→     * Guardar documento solicitado de una etapa de vacante de usuario.\n   125→     *\n   126→     * @param Request $request Contenido de la petición.\n   127→     * @return void\n   128→     * @author Andres Gonzalez\n   129→     */\n   130→    public function guardarDocumentoSolicitado(Request $request): void {\n   131→        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   132→\n   133→        if ($request->hasFile('archivo')) {\n   134→            $this->archivo_servicio->guardarVarios(EtapaVacanteUsuario::class, $request->etapa_vacante_usuario_id, [$request->nombre_documento => $request->file('archivo')], 'empresas/' . $empresa->id . '/documentos-solicitados', true);\n   135→        }\n   136→    }\n   137→\n   138→    /**\n   139→     * Establecer valores para puntaje y cumplimiento de un aspecto.\n   140→     *\n   141→     * @param float $puntaje Puntaje obtenido.\n   142→     * @param bool $cumple Indica si cumple.\n   143→     * @return void\n   144→     * @author Daniel Beltrán\n   145→     */\n   146→    private function establecerPuntajeCumplimiento(float $puntaje = 0, bool $cumple = false): void {\n   147→        $this->puntaje = $puntaje;\n   148→        $this->cumple  = $cumple;\n   149→    }\n   150→\n   151→    /**\n   152→     * Guardar puntaje de un aspecto evaluado.\n   153→     *\n   154→     * @param int $etapa_vacante_usuario_id ID de la etapa del usuario en la vacante.\n   155→     * @param string $categoria Categoría del aspecto.\n   156→     * @param string $aspecto Aspecto evaluado.\n   157→     * @return void\n   158→     * @author Daniel Beltrán\n   159→     */\n   160→    private function guardarAspectoPuntaje(int $etapa_vacante_usuario_id, string $categoria, string $aspecto): void {\n   161→        $this->aspecto_puntaje_repositorio->crearOActualizar([\n   162→            'etapa_vacante_usuario_id' => $etapa_vacante_usuario_id,\n   163→            'categoria'                => $categoria,\n   164→            'aspecto'                  => $aspecto\n   165→        ], [\n   166→            'puntaje'                  => $this->puntaje,\n   167→            'cumple'                   => $this->cumple\n   168→        ]);\n   169→\n   170→        $this->puntaje_total += $this->puntaje;\n   171→        $this->establecerPuntajeCumplimiento();\n   172→    }\n   173→\n   174→    /**\n   175→     * Generar adecuación de hoja de vida.\n   176→     *\n   177→     * @param int $id ID de la etapa del usuario en la vacante.\n   178→     * @return void\n   179→     * @author Daniel Beltrán\n   180→     */\n   181→    public function generarAdecuacionHV(int $id): void {\n   182→        $etapa_usuario = $this->repositorio->getUno($id);\n   183→\n   184→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   185→        if ($etapa_usuario->etapa->nombre === EtapaVacante::REVISION_HV_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n   186→            $perfil_laboral = $this->perfil_laboral_repositorio->getUnoAvanzado(new Request([\n   187→                'usuario_id'                     => $etapa_usuario->usuario_id,\n   188→                'incluir_experiencias_laborales' => true,\n   189→                'incluir_estudios'               => true,\n   190→                'incluir_idiomas'                => true,\n   191→                'incluir_usuario'                => true\n   192→            ]));\n   193→\n   194→            // Generar y guardar la adecuación del perfil de candidato (habilidades y herramientas tecnológicas)\n   195→            $categoria            = 'perfil';\n   196→            $puntaje_aspecto      = 100 / 2;\n   197→            $datos_vacante        = $etapa_usuario->vacante->datos;\n   198→            $habilidades_vacante  = $datos_vacante->where('llave', 'habilidades')->first();\n   199→            $herramientas_vacante = $datos_vacante->where('llave', 'herramientas_tecnologicas')->first();\n   200→\n   201→            // Validar coincidencia para las habilidades\n   202→            if (!is_null($habilidades_vacante->valor) && !empty($habilidades_vacante->valor)) {\n   203→                $habilidades_vacante        = array_map(fn($item) => trim($item), explode(',', $habilidades_vacante->valor));\n   204→                $habilidades_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->habilidades));\n   205→                $coincidencias              = count(array_uintersect($habilidades_vacante, $habilidades_perfil_laboral, 'strcasecmp'));\n   206→\n   207→                if ($coincidencias >= count($habilidades_vacante)) {\n   208→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   209→                }\n   210→            } else {\n   211→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   212→            }\n   213→\n   214→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'habilidades');\n   215→\n   216→            // Validar coincidencia para las herramientas tecnológicas\n   217→            if (!is_null($herramientas_vacante->valor) && !empty($herramientas_vacante->valor)) {\n   218→                $herramientas_vacante        = array_map(fn($item) => trim($item), explode(',', $herramientas_vacante->valor));\n   219→                $herramientas_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->herramientas_tecnologicas));\n   220→                $coincidencias               = count(array_uintersect($herramientas_vacante, $herramientas_perfil_laboral, 'strcasecmp'));\n   221→\n   222→                if ($coincidencias >= count($herramientas_vacante)) {\n   223→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   224→                }\n   225→            } else {\n   226→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   227→            }\n   228→\n   229→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'herramientas');\n   230→\n   231→            // Generar y guardar la adecuación de requisitos del candidato (género, edad, nivel educativo, modalidad de trabajo, salario, experiencia, idiomas, licencia de conducir)\n   232→            $categoria       = 'requisito';\n   233→            $puntaje_aspecto = 100 / 8;\n   234→\n   235→            // Validar coincidencia de género\n   236→            $genero_vacante = $datos_vacante->where('llave', 'genero')->first();\n   237→\n   238→            if (!is_null($genero_vacante) && !empty($genero_vacante)) {\n   239→                if ($genero_vacante->valor === mb_convert_case($perfil_laboral->usuario->genero->nombre, MB_CASE_LOWER)) {\n   240→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   241→                } elseif ($genero_vacante->valor === 'indiferente') {\n   242→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   243→                }\n   244→            } else {\n   245→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   246→            }\n   247→\n   248→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'genero');\n   249→\n   250→            // Validar coincidencia de edad\n   251→            $edad_minima_vacante = $datos_vacante->where('llave', 'edad_minima')->first();\n   252→            $edad_maxima_vacante = $datos_vacante->where('llave', 'edad_maxima')->first();\n   253→\n   254→            if (empty($edad_minima_vacante->valor) || empty($edad_maxima_vacante->valor)) {\n   255→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   256→            } elseif ($perfil_laboral->usuario->edad >= $edad_minima_vacante->valor && $perfil_laboral->usuario->edad <= $edad_maxima_vacante->valor) {\n   257→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   258→            }\n   259→\n   260→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'edad');\n   261→\n   262→            // Validar coincidencia de nivel educativo\n   263→            $nivel_educativo_vacante = $datos_vacante->where('llave', 'nivel_educativo')->first();\n   264→            $escala_estudios         = [\n   265→                'Preescolar'                      => 1,\n   266→                'Primaria'                        => 2,\n   267→                'Secundaria básica'               => 3,\n   268→                'Secundaria superior'             => 4,\n   269→                'Educación continua y permanente' => 5,\n   270→                'Técnico'                         => 6,\n   271→                'Tecnólogo'                       => 7,\n   272→                'Profesional'                     => 8,\n   273→                'Especialización (postgrado)'     => 9,\n   274→                'Maestría (postgrado)'            => 10,\n   275→                'Doctorado (postgrado)'           => 11\n   276→            ];\n   277→\n   278→            if (empty($nivel_educativo_vacante->valor) || $nivel_educativo_vacante->valor === 'indiferente') {\n   279→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   280→            } elseif (count($perfil_laboral->estudios) > 0) {\n   281→                $cumple_nivel_educativo = false;\n   282→\n   283→                foreach ($perfil_laboral->estudios as $estudio) {\n   284→                    if ($escala_estudios[$nivel_educativo_vacante->valor] <= $escala_estudios[$estudio->nivelEducativo->nombre]) {\n   285→                        $cumple_nivel_educativo = true;\n   286→                        break;\n   287→                    }\n   288→                }\n   289→\n   290→                if ($cumple_nivel_educativo) {\n   291→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   292→                }\n   293→            }\n   294→\n   295→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'estudios');\n   296→\n   297→            // Validar coincidencia de modalidad de trabajo\n   298→            if (!is_null($etapa_usuario->vacante->modalidad_trabajo_id)) {\n   299→                if ($etapa_usuario->vacante->modalidad_trabajo_id === $perfil_laboral->modalidad_trabajo_id) {\n   300→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   301→                }\n   302→            } else {\n   303→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   304→            }\n   305→\n   306→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'modalidad_trabajo');\n   307→\n   308→            // Validar coincidencia de salario\n   309→            if (is_null($etapa_usuario->vacante->salario)) {\n   310→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   311→            } elseif (!is_null($etapa_usuario->vacante->salario) && is_null($etapa_usuario->vacante->salario_maximo)) {\n   312→                // Salario fijo\n   313→                if (!is_null($perfil_laboral->salario_maximo)) {\n   314→                    // Validar cuando el salario de la vacante es fijo pero el del usuario es rango\n   315→                    if (($etapa_usuario->vacante->salario >= $perfil_laboral->salario && $etapa_usuario->vacante->salario <= $perfil_laboral->salario_maximo) || ($perfil_laboral->salario <= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario)) {\n   316→                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   317→                    }\n   318→                } elseif ($perfil_laboral->salario <= $etapa_usuario->vacante->salario) {\n   319→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   320→                }\n   321→            } elseif (!is_null($etapa_usuario->vacante->salario) && !is_null($etapa_usuario->vacante->salario_maximo)) {\n   322→                // Rango de salario\n   323→                if (!is_null($perfil_laboral->salario_maximo)) {\n   324→                    // Validar cuando el salario del usuario y de la vacante son rangos\n   325→                    if (($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) || ($perfil_laboral->salario_maximo >= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario_maximo)) {\n   326→                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   327→                    }\n   328→                } else {\n   329→                    if ($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) {\n   330→                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   331→                    }\n   332→                }\n   333→            }\n   334→\n   335→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'salario');\n   336→\n   337→            // Validar coincidencia de experiencia\n   338→            $experiencia_vacante   = $datos_vacante->where('llave', 'experiencia_laboral')->first();\n   339→            $experiencia_aplicante = $perfil_laboral->experienciasLaborales->sum('tiempo');\n   340→            $experiencias          = [\n   341→                '1 año'        => 1,\n   342→                '2 años'       => 2,\n   343→                '3 años'       => 3,\n   344→                '4 años'       => 4,\n   345→                '5 años o más' => 5\n   346→            ];\n   347→\n   348→            if (empty($experiencia_vacante->valor) || $experiencia_vacante->valor === 'Sin experiencia') {\n   349→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   350→            } elseif ($experiencia_vacante->valor === 'Menos de 1 año') {\n   351→                if ($experiencia_aplicante > 0 && $experiencia_aplicante < 365) {\n   352→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   353→                }\n   354→            } elseif (($experiencias[$experiencia_vacante->valor] * 365) <= $experiencia_aplicante) {\n   355→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   356→            }\n   357→\n   358→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'experiencia');\n   359→\n   360→            // Validar coincidencia de idiomas\n   361→            $idiomas_vacante = $etapa_usuario->vacante->idiomas;\n   362→            $escala_idiomas  = [\n   363→                'A1' => 1,\n   364→                'A2' => 2,\n   365→                'B1' => 3,\n   366→                'B2' => 4,\n   367→                'C1' => 5,\n   368→                'C2' => 6\n   369→            ];\n   370→\n   371→            if ($idiomas_vacante->count() > 0) {\n   372→                $coincidencias_idiomas = 0;\n   373→\n   374→                if ($perfil_laboral->idiomas->count() > 0) {\n   375→                    foreach ($idiomas_vacante as $idioma) {\n   376→                        foreach ($perfil_laboral->idiomas as $idioma_perfil) {\n   377→                            if ($idioma->idioma_id === $idioma_perfil->idioma_id && $escala_idiomas[$idioma->nivel] <= $escala_idiomas[$idioma_perfil->nivel]) {\n   378→                                $coincidencias_idiomas++;\n   379→                            }\n   380→                        }\n   381→                    }\n   382→                }\n   383→\n   384→                if ($coincidencias_idiomas >= $idiomas_vacante->count()) {\n   385→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   386→                }\n   387→            } else {\n   388→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   389→            }\n   390→\n   391→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'idiomas');\n   392→\n   393→            // Validar coincidencia de licencia de conducir\n   394→            $licencia_conducir_vacante = $datos_vacante->where('llave', 'licencia_conducir')->first();\n   395→            $escala_licencias          = [\n   396→                'A1' => 1,\n   397→                'A2' => 2,\n   398→                'B1' => 3,\n   399→                'B2' => 4,\n   400→                'B3' => 5,\n   401→                'C1' => 6,\n   402→                'C2' => 7,\n   403→                'C3' => 8\n   404→            ];\n   405→\n   406→            if (empty($licencia_conducir_vacante->valor)) {\n   407→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   408→            } elseif (is_null($perfil_laboral->licencia_conducir)) {\n   409→                if (empty($licencia_conducir_vacante->valor)) {\n   410→                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   411→                }\n   412→            } elseif ($escala_licencias[$licencia_conducir_vacante->valor] <= $escala_licencias[$perfil_laboral->licencia_conducir]) {\n   413→                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n   414→            }\n   415→\n   416→            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'licencia_conducir');\n   417→\n   418→            $puntaje_total = round($this->puntaje_total / 2); // Se divide entre las dos categorías existentes\n   419→            $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::REVISION_HV_ID, $puntaje_total, 'descartar_candidatos_adecuaciones_bajas_hv', 'descartar_candidatos_adecuaciones_medias_hv');\n   420→        }\n   421→    }\n   422→\n   423→    /**\n   424→     * Generar adecuación para preguntas prefiltro.\n   425→     *\n   426→     * Califica las respuestas del aplicante en cada una de las preguntas y calcula la adecuación en base a sus resultados.\n   427→     *\n   428→     * @param int $id ID de la etapa del usuario en la vacante.\n   429→     * @return void\n   430→     * @author Daniel Beltrán\n   431→     */\n   432→    public function generarAdecuacionPrefiltro(int $id): void {\n   433→        $etapa_usuario = $this->repositorio->getUno($id);\n   434→\n   435→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   436→        if ($etapa_usuario->etapa->nombre === EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n   437→            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n   438→                'etapa_vacante_id'   => $etapa_usuario->etapa_vacante_id,\n   439→                'usuario_id'         => $etapa_usuario->usuario_id,\n   440→                'incluir_respuestas' => true\n   441→            ]));\n   442→\n   443→            $porcentaje_pregunta  = 100 / $preguntas->count();\n   444→            $respuestas_correctas = 0;\n   445→\n   446→            foreach ($preguntas as $pregunta) {\n   447→                $puntaje    = null;\n   448→                $puntaje_ia = null;\n   449→\n   450→                if ($pregunta->es_abierta) {\n   451→                    $respuesta = $opcion_seleccionada = $pregunta->respuestas->first();\n   452→\n   453→                    if (!is_null($respuesta)) {\n   454→                        try {\n   455→                            $peticion_ia = $this->realizarPeticionIA(\n   456→                                ruta: 'calificar-pregunta-abierta',\n   457→                                parametros: [\n   458→                                    'pregunta'  => $pregunta->enunciado,\n   459→                                    'respuesta' => $respuesta->respuesta,\n   460→                                ],\n   461→                                contexto_tracking: [\n   462→                                    'vacante_id' => $etapa_usuario->etapa->vacante_id ?? null,\n   463→                                    'agenda_id' => null,\n   464→                                ]\n   465→                            );\n   466→\n   467→                            if (!is_null($peticion_ia) && $peticion_ia['status_code'] === 200) {\n   468→                                $puntaje_ia = $peticion_ia['calificacion'];\n   469→                            }\n   470→                        } catch (RequestException|ConnectionException $error) {}\n   471→                    }\n   472→                } else {\n   473→                    $opciones_correctas = $pregunta->opciones->where('es_correcta', true);\n   474→\n   475→                    // Selección única\n   476→                    if ($opciones_correctas->count() === 1) {\n   477→                        $opcion_correcta     = $opciones_correctas->first();\n   478→                        $opcion_seleccionada = $pregunta->respuestas->first();\n   479→                        $puntaje             = (int) (!is_null($opcion_seleccionada) && $opcion_correcta->id === $opcion_seleccionada->opcion_pregunta_id);\n   480→                    } else { // Selección múltiple\n   481→                        $opciones_correctas     = $opciones_correctas->pluck('id')->toArray();\n   482→                        $opciones_seleccionadas = $pregunta->respuestas->pluck('opcion_pregunta_id')->toArray();\n   483→                        $aciertos               = count(array_intersect($opciones_seleccionadas, $opciones_correctas));\n   484→                        $fallos                 = count(array_diff($opciones_seleccionadas, $opciones_correctas));\n   485→                        $puntaje                = (int) ($aciertos - $fallos === count($opciones_correctas));\n   486→                    }\n   487→                }\n   488→\n   489→                // Guardar el puntaje obtenido en cada pregunta\n   490→                $this->puntaje_pregunta_oferta_laboral_repositorio->crearSiNoExiste([\n   491→                    'pregunta_id' => $pregunta->id,\n   492→                    'usuario_id'  => $etapa_usuario->usuario_id\n   493→                ], [\n   494→                    'puntaje'     => $puntaje,\n   495→                    'puntaje_ia'  => $puntaje_ia\n   496→                ]);\n   497→\n   498→                // Sumar el puntaje total\n   499→                if (is_null($puntaje) && !is_null($puntaje_ia)) {\n   500→                    $respuestas_correctas += $puntaje_ia;\n   501→                } else {\n   502→                    $respuestas_correctas += $puntaje;\n   503→                }\n   504→            }\n   505→\n   506→            $puntaje_etapa = $respuestas_correctas * $porcentaje_pregunta;\n   507→\n   508→            if ($etapa_usuario->vacante->automatizar_etapas) {\n   509→                // Obtener el movimiento de la etapa con sus configuraciones\n   510→                $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n   511→                    'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n   512→                    'movimiento_vacante_id'   => MovimientoVacante::PREGUNTAS_PREFILTRO_ID,\n   513→                    'incluir_configuraciones' => true\n   514→                ]));\n   515→\n   516→                $configuracion_preguntas_correctas = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', 'descartar_candidatos_respondieron_menos_preguntas_prefiltro')->first();\n   517→\n   518→                // Avanzar al aplicante de etapa o descartarlo según la configuración de la etapa\n   519→                if (!is_null($configuracion_preguntas_correctas) && $configuracion_preguntas_correctas->valor <= $respuestas_correctas) {\n   520→                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa);\n   521→                } else {\n   522→                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa, descartar: true);\n   523→                }\n   524→            } else {\n   525→                $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_etapa]);\n   526→            }\n   527→        }\n   528→    }\n   529→\n   530→    /**\n   531→     * Guardar el puntaje de adecuación dado por el reclutador.\n   532→     *\n   533→     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n   534→     *\n   535→     * @param int $id ID de la etapa del usuario en la vacante.\n   536→     * @param int $puntaje Puntaje dado por el reclutador.\n   537→     * @return void\n   538→     * @author Daniel Beltrán\n   539→     */\n   540→    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n   541→        $etapa_usuario = $this->repositorio->getUno($id);\n   542→\n   543→        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n   544→            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n   545→                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n   546→            }\n   547→\n   548→            if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::VIDEO_ENTREVISTA_NOMBRE, EtapaVacante::ENTREVISTA_NOMBRE])) {\n   549→                if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE) {\n   550→                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID;\n   551→                    $llave_configuracion_formato             = 'solicitar_formato_videoentrevista';\n   552→                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_videoentrevista';\n   553→                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_videoentrevista';\n   554→                } else {\n   555→                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n   556→                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n   557→                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n   558→                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n   559→                }\n   560→\n   561→                if ($this->verificarFormatoEntrevista($etapa_usuario, $movimiento_vacante_id, $llave_configuracion_formato)) {\n   562→                    $this->gestionarContinuidadAplicante($etapa_usuario, $movimiento_vacante_id, $puntaje, $llave_configuracion_adecuaciones_bajas, $llave_configuracion_adecuaciones_medias);\n   563→                } else {\n   564→                    $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n   565→                }\n   566→\n   567→                // TODO: Invocar esta función al momento de completar el formato de entrevista\n   568→            }\n   569→        }\n   570→    }\n   571→\n   572→    /**\n   573→     * Generar adecuación para pruebas psicométricas.\n   574→     *\n   575→     * @param int $id ID de la etapa del usuario en la vacante.\n   576→     * @return void\n   577→     * @author Daniel Beltrán\n   578→     */\n   579→    public function generarAdecuacionPruebasPsicometricas(int $id): void {\n   580→        $etapa_usuario = $this->repositorio->getUno($id);\n   581→\n   582→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   583→        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n   584→            $indice_talento = $this->proceso_repositorio->obtenerIndiceTalento($etapa_usuario->vacante->proceso->id, $etapa_usuario->usuario_id)->indice_talento;\n   585→\n   586→            if ($indice_talento >= 0) {\n   587→                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBAS_PSICOMETRICAS_ID, $indice_talento, 'descartar_candidatos_puntuaciones_bajas', 'descartar_candidatos_puntuaciones_medias', true);\n   588→            }\n   589→        }\n   590→    }\n   591→\n   592→    /**\n   593→     * Generar adecuación para videoentrevista.\n   594→     *\n   595→     * @param int $id ID de la etapa del usuario en la vacante.\n   596→     * @return void\n   597→     * @author Daniel Beltrán\n   598→     * @author Andres Gonzalez\n   599→     */\n   600→    public function generarAdecuacionVideoentrevista(int $id): void {\n   601→        $etapa_usuario = $this->repositorio->getUno($id);\n   602→\n   603→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   604→        if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje_ia)) {\n   605→            ProcesarVideoentrevistaIAJob::dispatch($etapa_usuario);\n   606→        }\n   607→    }\n   608→\n   609→    /**\n   610→     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n   611→     *\n   612→     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n   613→     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n   614→     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n   615→     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n   616→     * @author Daniel Beltrán\n   617→     */\n   618→    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n   619→        $formato_diligenciado = false;\n   620→        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n   621→            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n   622→            'movimiento_vacante_id'   => $movimiento_vacante_id,\n   623→            'incluir_configuraciones' => true\n   624→        ]));\n   625→\n   626→        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n   627→\n   628→        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n   629→            $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n   630→        } else {\n   631→            $formato_diligenciado = true;\n   632→        }\n   633→\n   634→        return $formato_diligenciado;\n   635→    }\n   636→\n   637→    /**\n   638→     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n   639→     *\n   640→     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n   641→     * @param int $usuario_id ID del usuario (aplicante).\n   642→     * @return void\n   643→     * @author Daniel Beltrán\n   644→     */\n   645→    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n   646→        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n   647→            'etapa_vacante_id' => $etapa_vacante_id,\n   648→            'usuario_id'       => $usuario_id\n   649→        ]));\n   650→\n   651→        if ($etapa_usuario->activo) {\n   652→            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n   653→                'etapa_vacante_id' => $etapa_usuario->etapa_vacante_id,\n   654→                'usuario_id'       => $etapa_usuario->usuario_id,\n   655→                'incluir_puntajes' => true\n   656→            ]));\n   657→\n   658→            $puntaje            = 0;\n   659→            $puntaje_individual = 100 / $preguntas->count();\n   660→\n   661→            foreach ($preguntas as $pregunta) {\n   662→                if (is_null($pregunta->puntajes[0]->puntaje) && !is_null($pregunta->puntajes[0]->puntaje_ia)) {\n   663→                    $puntaje += $pregunta->puntajes[0]->puntaje_ia;\n   664→                } elseif (!is_null($pregunta->puntajes[0]->puntaje)) {\n   665→                    $puntaje += $pregunta->puntajes[0]->puntaje;\n   666→                }\n   667→            }\n   668→\n   669→            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_individual * $puntaje]);\n   670→        }\n   671→    }\n   672→\n   673→    /**\n   674→     * Guardar el puntaje de la etapa actual y gestionar la continuidad del aplicante en la vacante.\n   675→     *\n   676→     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n   677→     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n   678→     * @param int $puntaje Puntaje obtenido en la etapa actual.\n   679→     * @param string $llave_puntajes_bajos Llave de configuración para puntajes bajos.\n   680→     * @param string $llave_puntajes_medios Llave de configuración para puntajes medios.\n   681→     * @param bool $escala_pruebas_psicometricas Indica si debe utilizar la escala de puntajes de pruebas psicométricas.\n   682→     * @return void\n   683→     * @author Daniel Beltrán\n   684→     */\n   685→    public function gestionarContinuidadAplicante(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, int $puntaje, string $llave_puntajes_bajos, string $llave_puntajes_medios, bool $escala_pruebas_psicometricas = false) {\n   686→        if ($etapa_usuario->vacante->automatizar_etapas) {\n   687→            $calificacion_baja  = 40;\n   688→            $calificacion_media = 70;\n   689→\n   690→            if ($escala_pruebas_psicometricas) {\n   691→                $calificacion_baja  = 59;\n   692→                $calificacion_media = 75;\n   693→            }\n   694→\n   695→            // Obtener el movimiento de la etapa con sus configuraciones\n   696→            $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n   697→                'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n   698→                'movimiento_vacante_id'   => $movimiento_vacante_id,\n   699→                'incluir_configuraciones' => true\n   700→            ]));\n   701→\n   702→            $configuracion_adecuaciones_bajas  = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_bajos)->first();\n   703→            $configuracion_adecuaciones_medias = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_medios)->first();\n   704→\n   705→            if (!is_null($configuracion_adecuaciones_medias) && filter_var($configuracion_adecuaciones_medias->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_media) {\n   706→                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n   707→                return;\n   708→            } elseif (!is_null($configuracion_adecuaciones_bajas) && filter_var($configuracion_adecuaciones_bajas->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_baja) {\n   709→                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n   710→                return;\n   711→            }\n   712→\n   713→            $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje);\n   714→        } else {\n   715→            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n   716→        }\n   717→    }\n   718→\n   719→    /**\n   720→     * Guardar puntaje de la etapa actual y mover al aplicante a la siguiente etapa.\n   721→     *\n   722→     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n   723→     * @param ?int $puntaje Puntaje obtenido en la etapa actual.\n   724→     * @param ?int $puntaje_ia Puntaje obtenido por la IA en la etapa actual.\n   725→     * @param ?string $notas_ia Notas dadas por la IA para la etapa actual.\n   726→     * @param bool $descartar Indica si la etapa a la que se debe cambiar es 'descartados'.\n   727→     * @return void\n   728→     * @author Daniel Beltrán\n   729→     * @author Andres Gonzalez\n   730→     */\n   731→    public function guardarPuntajeYCambiarDeEtapa(EtapaVacanteUsuario $etapa_usuario, ?int $puntaje = null, ?int $puntaje_ia = null, ?string $notas_ia = null, bool $descartar = false): void {\n   732→        if ($descartar) {\n   733→            $etapa_siguiente = $this->etapa_vacante_repositorio->getUnoAvanzado(new Request(['vacante_id' => $etapa_usuario->vacante->id, 'nombre' => EtapaVacante::DESCARTADOS_NOMBRE]));\n   734→        } else {\n   735→            $etapa_siguiente = $this->etapa_vacante_repositorio->obtenerEtapaSiguiente($etapa_usuario->vacante->id, $etapa_usuario->etapa->orden);\n   736→        }\n   737→\n   738→        $etapa_actual_activa = true;\n   739→\n   740→        if ($etapa_siguiente->nombre !== EtapaVacante::CONTRATADOS_NOMBRE) {\n   741→            $etapa_actual_activa = false;\n   742→            $nueva_etapa_usuario = $this->repositorio->crear([\n   743→                'usuario_id'       => $etapa_usuario->usuario_id,\n   744→                'etapa_vacante_id' => $etapa_siguiente->id,\n   745→                'activo'           => true\n   746→            ]);\n   747→\n   748→            // Crear agendas de pruebas psicométricas si la etapa siguiente son pruebas psicométricas.\n   749→            app(VacanteService::class)->crearAgendasPruebasPsicometricas($etapa_usuario, $etapa_siguiente->id);\n   750→\n   751→            if ($nueva_etapa_usuario) {\n   752→                $this->notificarCambioEtapa($nueva_etapa_usuario);\n   753→            }\n   754→        }\n   755→\n   756→        $this->repositorio->actualizar($etapa_usuario->id, [\n   757→            'puntaje'    => $puntaje,\n   758→            'puntaje_ia' => $puntaje_ia,\n   759→            'notas_ia'   => $notas_ia,\n   760→            'activo'     => $etapa_actual_activa\n   761→        ]);\n   762→\n   763→        // Cuando la etapa es contratado, se valida si ya se han completado las vacantes requeridas para cerrar la vacante\n   764→        if ($etapa_siguiente->nombre === EtapaVacante::CONTRATADOS_NOMBRE) {\n   765→            if ($etapa_usuario->vacante->cantidad_vacantes === $this->repositorio->contarContratados($etapa_usuario->etapa->vacante_id)) {\n   766→                $this->vacante_repositorio->actualizar($etapa_usuario->etapa->vacante_id, ['estado_id' => EstadoVacante::COMPLETADA_ID]);\n   767→\n   768→                $aplicantes_activos_restantes_ids = $this->repositorio->getTodo(new Request([\n   769→                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n   770→                    'activo'                 => true,\n   771→                    'excluir_etapas'         => [EtapaVacante::DESCARTADOS_NOMBRE, EtapaVacante::CONTRATADOS_NOMBRE]\n   772→                ]))->pluck('id')->toArray();\n   773→\n   774→                // Descartar a los aplicantes que quedan activos en la vacante\n   775→                $this->descartarAplicantesManual($aplicantes_activos_restantes_ids);\n   776→\n   777→                $aplicantes_activos_sin_notificar = $this->repositorio->getTodo(new Request([\n   778→                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n   779→                    'activo'                 => true,\n   780→                    'sin_fecha_notificacion' => true\n   781→                ]));\n   782→\n   783→                foreach ($aplicantes_activos_sin_notificar as $aplicante) {\n   784→                    $this->notificarCambioEtapa($aplicante, false);\n   785→                }\n   786→            }\n   787→        }\n   788→    }\n   789→\n   790→    /**\n   791→     * Obtener la adecuación actual del usuario en la vacante.\n   792→     *\n   793→     * @param int $usuario_id ID del usuario.\n   794→     * @param int $vacante_id ID de la vacante.\n   795→     * @return ?int\n   796→     * @author Daniel Beltrán\n   797→     * @author Andres Gonzalez\n   798→     */\n   799→    public function obtenerAdecuacionUsuario(int $usuario_id, int $vacante_id): ?int {\n   800→        $etapas     = $this->repositorio->obtenerEtapasCompletadasUsuario($usuario_id, $vacante_id);\n   801→        $adecuacion = 0;\n   802→\n   803→        foreach ($etapas as $etapa) {\n   804→            if (!is_null($etapa->puntaje)) {\n   805→                $adecuacion += $etapa->puntaje;\n   806→            } elseif (is_null($etapa->puntaje) && !is_null($etapa->puntaje_ia)) {\n   807→                $adecuacion += $etapa->puntaje_ia;\n   808→            }\n   809→        }\n   810→\n   811→        return ($etapas->count() > 0) ? $adecuacion / $etapas->count() : null;\n   812→    }\n   813→\n   814→    /**\n   815→     * Verificar si una etapa ya ha sido completada por el aplicante.\n   816→     *\n   817→     * @param int $id ID de la etapa del usuario en la vacante (etapa_vacante_usuario_id).\n   818→     * @return bool\n   819→     * @author Daniel Beltrán\n   820→     * @author Andres Gonzalez\n   821→     */\n   822→    public function verificarEtapaCompletada(int $id): bool {\n   823→        $etapa_usuario    = $this->repositorio->getUno($id);\n   824→        $etapa_completada = false;\n   825→\n   826→        // Verificar si la etapa de revisión de hoja de vida ya fue completada\n   827→        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::REVISION_HV_NOMBRE, EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE]) && !is_null($etapa_usuario->puntaje) || !is_null($etapa_usuario->puntaje_ia)) {\n   828→            $etapa_completada = true;\n   829→        }\n   830→\n   831→        if ($etapa_usuario->etapa->nombre === EtapaVacante::ENTREVISTA_NOMBRE) {\n   832→            if ($this->configuracion_modelo_servicio->obtenerValorLlaveConfiguracion(app(VacanteService::class)->obtenerConfiguracionesEtapaAplicante($etapa_usuario->etapa_vacante_id), 'solicitar_formato_entrevista')) {\n   833→                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n   834→\n   835→                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n   836→                    $etapa_completada = true;\n   837→                }\n   838→            } else {\n   839→                $etapa_completada = true;\n   840→            }\n   841→        }\n   842→\n   843→        // Verificar si las etapas de preguntas prefiltro o videoentrevista ya han sido completadas\n   844→        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE])) {\n   845→            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n   846→                'etapa_vacante_id'                      => $etapa_usuario->etapa_vacante_id,\n   847→                'usuario_id'                            => $etapa_usuario->usuario_id,\n   848→                'incluir_cantidad_respuestas_aplicante' => true\n   849→            ]));\n   850→\n   851→            $preguntas_contestadas = 0;\n   852→\n   853→            foreach ($preguntas as $pregunta) {\n   854→                if ($pregunta['respuestas_count'] > 0) {\n   855→                    $preguntas_contestadas++;\n   856→                }\n   857→            }\n   858→\n   859→            // Validar que todas las preguntas hayan sido contestadas\n   860→            if (count($preguntas) === $preguntas_contestadas) {\n   861→                $etapa_completada = true;\n   862→            }\n   863→        }\n   864→\n   865→        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n   866→            if ((!is_null($etapa_usuario->pruebaTecnica?->enlace) && !empty($etapa_usuario->pruebaTecnica?->enlace) || $etapa_usuario->pruebaTecnica?->archivos->count() > 0) && $etapa_usuario->pruebaTecnica?->borrador == false) {\n   867→                $etapa_completada = true;\n   868→            }\n   869→        }\n   870→\n   871→        if ($etapa_usuario->etapa->nombre === EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE) {\n   872→            $documentos_contratacion = app(EtapaVacanteService::class)->obtenerDocumentosContratacion(\n   873→                $etapa_usuario->etapa_vacante_id,\n   874→                new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id])\n   875→            );\n   876→\n   877→            $documentos_solicitados     = collect($documentos_contratacion['documentos']);\n   878→            $archivos_guardados         = collect($documentos_contratacion['archivos_guardados']);\n   879→            $archivos_guardados_nombres = $archivos_guardados->pluck('nombre')->toArray();\n   880→\n   881→            $todos_cargados = true;\n   882→            foreach ($documentos_solicitados as $documento) {\n   883→                $nombre_normalizado = $this->normalizarNombreDocumento($documento['nombre']);\n   884→\n   885→                if (!in_array($nombre_normalizado, $archivos_guardados_nombres)) {\n   886→                    $todos_cargados = false;\n   887→                    break;\n   888→                }\n   889→            }\n   890→\n   891→            if ($todos_cargados && $documentos_solicitados->count() > 0) {\n   892→                $etapa_completada = true;\n   893→            }\n   894→        }\n   895→\n   896→        return $etapa_completada;\n   897→    }\n   898→\n   899→    /**\n   900→     * Notificar documentos solicitados.\n   901→     *\n   902→     * @param int $id ID de la etapa del usuario en la vacante.\n   903→     * @return void\n   904→     * @author Andres Gonzalez\n   905→     * @author Jair Carvajal\n   906→     * @author Daniel Beltrán\n   907→     */\n   908→    public function notificarDocumentosSolicitados(int $id): void {\n   909→        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n   910→\n   911→        if ($etapa_vacante_usuario) {\n   912→            $this->enviarCorreoFinalizacionEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->vacante);\n   913→        }\n   914→    }\n   915→\n   916→    /**\n   917→     * Descartar uno o varios aplicantes manualmente y moverlos a la etapa de descartados.\n   918→     *\n   919→     * @param array $ids IDs de las etapas de usuarios en la vacante.\n   920→     * @return void\n   921→     * @author Andres Gonzalez\n   922→     * @author Daniel Beltrán\n   923→     */\n   924→    public function descartarAplicantesManual(array $ids): void {\n   925→        foreach ($ids as $id) {\n   926→            $etapa_vacante_usuario = $this->repositorio->getUno($id);\n   927→\n   928→            if ($etapa_vacante_usuario) {\n   929→                $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n   930→            }\n   931→        }\n   932→    }\n   933→\n   934→    /**\n   935→     * Revertir descarte de aplicantes.\n   936→     *\n   937→     * @param array $ids IDs de las etapas de los usuarios descartados en la vacante.\n   938→     * @return void\n   939→     * @author Andres Gonzalez\n   940→     */\n   941→    public function revertirDescarteAplicantes(array $ids): void {\n   942→        foreach ($ids as $id) {\n   943→            $etapa_descartado = $this->repositorio->getUno($id);\n   944→\n   945→            if ($etapa_descartado && $etapa_descartado->etapa->nombre === EtapaVacante::DESCARTADOS_NOMBRE && $etapa_descartado->activo) {\n   946→                $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $etapa_descartado->vacante->id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n   947→                $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n   948→                $etapa_previa          = $this->repositorio->obtenerEtapaPrevia($etapa_descartado->usuario_id, $etapas_ids);\n   949→\n   950→                if ($etapa_previa) {\n   951→                    $this->repositorio->eliminar($etapa_descartado->id);\n   952→                    $this->repositorio->actualizar($etapa_previa->id, ['activo' => true]);\n   953→                }\n   954→            }\n   955→        }\n   956→    }\n   957→\n   958→    /**\n   959→     * Mover manualmente al aplicante a la siguiente etapa.\n   960→     *\n   961→     * @param int $id ID de la etapa del usuario en la vacante.\n   962→     * @return void\n   963→     * @author Andres Gonzalez\n   964→     * @author Daniel Beltrán\n   965→     */\n   966→    public function moverAplicanteEtapaManual(int $id): void {\n   967→        $etapa_usuario = $this->repositorio->getUno($id);\n   968→        $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $etapa_usuario->puntaje ?? 0);\n   969→    }\n   970→\n   971→    /**\n   972→     * Marcar la vacante como abandonada por el aplicante.\n   973→     *\n   974→     * @param Request $request Contenido de la petición.\n   975→     * @return void\n   976→     * @author Andres Gonzalez\n   977→     * @author Daniel Beltrán\n   978→     */\n   979→    public function abandonarVacante(Request $request): void {\n   980→        $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $request->vacante_id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n   981→        $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n   982→        $etapa_vacante_usuario = $this->repositorio->obtenerEtapaPrevia($request->usuario_id, $etapas_ids);\n   983→\n   984→        if ($etapa_vacante_usuario) {\n   985→            $this->repositorio->actualizar($etapa_vacante_usuario->id, ['motivo_abandono' => $request->motivo_abandono]);\n   986→            $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n   987→        }\n   988→    }\n   989→\n   990→    /**\n   991→     * Notificar al aplicante sobre el cambio de etapa.\n   992→     *\n   993→     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n   994→     * @param bool $aplicar_validacion_fin_proceso Indica si se debe aplicar la validación de fin de proceso.\n   995→     * @return void\n   996→     * @author Andres Gonzalez\n   997→     */\n   998→    public function notificarCambioEtapa(EtapaVacanteUsuario $etapa_usuario, bool $aplicar_validacion_fin_proceso = true): void {\n   999→        $etapa_usuario->load(['etapa', 'vacante', 'usuario']);\n  1000→        $etapa = $etapa_usuario->etapa;\n  1001→\n  1002→        $plantilla_correo_id = [\n  1003→            EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE     => PlantillaCorreo::PREGUNTAS_PRE_FILTRO_ID,\n  1004→            EtapaVacante::PRUEBA_TECNICA_NOMBRE          => PlantillaCorreo::ENVIO_PRUEBA_TECNICA_ID,\n  1005→            EtapaVacante::VIDEO_ENTREVISTA_NOMBRE        => PlantillaCorreo::SOLICITUD_VIDEOENTREVISTAS_ID,\n  1006→            EtapaVacante::ENTREVISTA_NOMBRE              => PlantillaCorreo::NOTIFICACION_ENTREVISTA_ID,\n  1007→            EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE => PlantillaCorreo::SOLICITUD_DOCUMENTOS_ID,\n  1008→            EtapaVacante::CONTRATADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_CONTRATADOS_ID,\n  1009→            EtapaVacante::DESCARTADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_DESCARTADOS_ID\n  1010→        ][$etapa->nombre] ?? null;\n  1011→\n  1012→        if (isset($plantilla_correo_id)) {\n  1013→            $plantilla_correo_etapa = $this->plantilla_correo_servicio->obtenerUno(new Request([\n  1014→                'plantilla_correo_id' => $plantilla_correo_id,\n  1015→                'empresa_id'          => $etapa_usuario->vacante->empresa_id\n  1016→            ]));\n  1017→\n  1018→            if (!is_null($plantilla_correo_etapa)) {\n  1019→                $es_etapa_fin_proceso = in_array($etapa->nombre, [\n  1020→                    EtapaVacante::CONTRATADOS_NOMBRE,\n  1021→                    EtapaVacante::DESCARTADOS_NOMBRE\n  1022→                ]);\n  1023→\n  1024→                // Si es etapa de fin de proceso y notificar_fin_proceso es true, no enviar notificación\n  1025→                if ($aplicar_validacion_fin_proceso && $es_etapa_fin_proceso && $plantilla_correo_etapa->notificar_fin_proceso) {\n  1026→                    return;\n  1027→                }\n  1028→\n  1029→                $usuario            = $etapa_usuario->usuario;\n  1030→                $vacante            = $etapa_usuario->vacante;\n  1031→                $token_acceso       = $this->token_acceso_servicio->generar($usuario->id);\n  1032→                $enlace             = request()->getSchemeAndHttpHost() . \"/control-acceso/{$token_acceso->token}?vacante_id={$vacante->id}\";\n  1033→                $usuario_informador = null;\n  1034→\n  1035→                Mail::to($usuario->email)->queue(new NotificarPostulanteVacanteMail(\n  1036→                    $usuario,\n  1037→                    $enlace,\n  1038→                    $vacante,\n  1039→                    $plantilla_correo_etapa->titulo,\n  1040→                    $plantilla_correo_etapa->contenido,\n  1041→                    $plantilla_correo_etapa->con_logo_empresa,\n  1042→                    $etapa->nombre,\n  1043→                    $usuario_informador\n  1044→                ));\n  1045→\n  1046→                // Enviar notificación de avance en el proceso\n  1047→                $usuario->notify(new NotificarAvanceProcesoNotification(\n  1048→                    $vacante->id,\n  1049→                    $vacante->nombre_vacante,\n  1050→                    $etapa->nombre,\n  1051→                    $vacante->empresa->nombre ?? 'la empresa'\n  1052→                ));\n  1053→\n  1054→                $this->repositorio->actualizar($etapa_usuario->id, ['fecha_notificacion' => now()]);\n  1055→            }\n  1056→        }\n  1057→    }\n  1058→\n  1059→    /**\n  1060→     * Enviar correo de notificación al finalizar una etapa.\n  1061→     *\n  1062→     * @param EtapaVacanteUsuario $etapa_vacante_usuario Etapa del usuario en la vacante.\n  1063→     * @param Vacante $vacante Vacante.\n  1064→     * @return void\n  1065→     * @author Jair Carvajal\n  1066→     */\n  1067→    private function enviarCorreoFinalizacionEtapa(EtapaVacanteUsuario $etapa_vacante_usuario, Vacante $vacante): void {\n  1068→        $usuario     = Auth::user();\n  1069→        $maneja_logo = file_exists(public_path('empresas-logo/' . $vacante->empresa->id)) ? '1' : null;\n  1070→\n  1071→        Mail::send(new NotificarFinalizacionEtapaMail(\n  1072→            $usuario,\n  1073→            $vacante,\n  1074→            $etapa_vacante_usuario->etapa,\n  1075→            $maneja_logo\n  1076→        ));\n  1077→    }\n  1078→\n  1079→    /**\n  1080→     * Obtener candidatos recomendados con IA.\n  1081→     *\n  1082→     * Obtiene los 3 mejores candidatos para la vacante, entre varios candidatos seleccionados por el reclutador.\n  1083→     *\n  1084→     * @param Request $request Contenido de la petición.\n  1085→     * @return void\n  1086→     * @author Daniel Beltrán\n  1087→     */\n  1088→    public function obtenerCandidatosRecomendadosIA(Request $request): array {\n  1089→        $vacante       = $this->vacante_repositorio->getUno($request->vacante_id);\n  1090→        $candidatos    = $this->usuario_repositorio->obtenerCandidatosSeleccionadosVacante($request->usuarios_ids, $request->vacante_id);\n  1091→        $candidatos_ia = [];\n  1092→        $vacante_ia    = [\n  1093→            ...Arr::only($vacante->toArray(), ['nombre_vacante', 'salario', 'salario_maximo']),\n  1094→            'habilidades'               => $vacante->datos->first(fn($item) => $item->llave === 'habilidades')->valor,\n  1095→            'herramientas_tecnologicas' => $vacante->datos->first(fn($item) => $item->llave === 'herramientas_tecnologicas')->valor,\n  1096→            'experiencia_laboral'       => $vacante->datos->first(fn($item) => $item->llave === 'experiencia_laboral')->valor,\n  1097→            'nivel_educativo'           => $vacante->datos->first(fn($item) => $item->llave === 'nivel_educativo')->valor\n  1098→        ];\n  1099→\n  1100→        if (!is_null($vacante->ciudad_id)) {\n  1101→            $direccion_trabajo = $vacante->datos->first(fn($item) => $item->llave === 'direccion_trabajo')->valor;\n  1102→            $ubicacion_empresa = \"{$vacante->ciudad->departamento->pais->nombre}, {$vacante->ciudad->departamento->nombre} - {$vacante->ciudad->nombre}, {$direccion_trabajo}\";\n  1103→        } elseif (!is_null($vacante->empresa->ciudad_id)) {\n  1104→            $ubicacion_empresa = \"{$vacante->empresa->ciudad->departamento->pais->nombre}, {$vacante->empresa->ciudad->departamento->nombre} - {$vacante->empresa->ciudad->nombre}, {$vacante->empresa->direccion}\";\n  1105→        }\n  1106→\n  1107→        if (isset($ubicacion_empresa)) {\n  1108→            $vacante_ia['ubicacion'] = $ubicacion_empresa;\n  1109→        }\n  1110→\n  1111→        foreach ($candidatos as $candidato) {\n  1112→            if (!is_null($candidato->ciudad_id) && !is_null($candidato->direccion)) {\n  1113→                $ubicacion = \"{$candidato->ciudad->departamento->pais->nombre}, {$candidato->ciudad->departamento->nombre} - {$candidato->ciudad->nombre}, {$candidato->direccion}\";\n  1114→            }\n  1115→\n  1116→            $usuario = [\n  1117→                ...Arr::only($candidato->toArray(), ['id', 'nombre_completo', 'email', 'telefono', 'edad']),\n  1118→                'adecuacion' => $this->obtenerAdecuacionUsuario($candidato->id, $request->vacante_id)\n  1119→            ];\n  1120→\n  1121→            if (isset($ubicacion)) {\n  1122→                $usuario['ubicacion'] = $ubicacion;\n  1123→            }\n  1124→\n  1125→            if (!is_null($candidato->perfilLaboral)) {\n  1126→                $usuario['salario']                   = $candidato->perfilLaboral->salario;\n  1127→                $usuario['salario_maximo']            = $candidato->perfilLaboral->salario_maximo;\n  1128→                $usuario['habilidades']               = $candidato->perfilLaboral->habilidades;\n  1129→                $usuario['herramientas_tecnologicas'] = $candidato->perfilLaboral->herramientas_tecnologicas;\n  1130→                $usuario['estudios']                  = [];\n  1131→                $usuario['experiencias_laborales']    = [];\n  1132→                $usuario['idiomas']                   = [];\n  1133→                $usuario['etapas']                    = [];\n  1134→\n  1135→                foreach ($candidato->perfilLaboral->estudios as $item) {\n  1136→                    array_push($usuario['estudios'], [\n  1137→                        ...Arr::only($item->toArray(), ['titulo', 'fecha_inicio', 'fecha_fin']),\n  1138→                        'nivel_educativo' => $item->nivelEducativo->nombre,\n  1139→                    ]);\n  1140→                }\n  1141→\n  1142→                foreach ($candidato->perfilLaboral->experienciasLaborales as $item) {\n  1143→                    array_push($usuario['experiencias_laborales'], [...Arr::only($item->toArray(), ['empresa', 'cargo', 'fecha_inicio', 'fecha_fin', 'tiempo'])]);\n  1144→                }\n  1145→\n  1146→                foreach ($candidato->perfilLaboral->idiomas as $item) {\n  1147→                    array_push($usuario['idiomas'], [\n  1148→                        'idioma' => $item->idioma->nombre,\n  1149→                        'nivel'  => $item->nivel\n  1150→                    ]);\n  1151→                }\n  1152→\n  1153→                foreach ($candidato->etapasUsuarios as $item) {\n  1154→                    $datos_etapas = [\n  1155→                        'nombre'      => $item->etapa->nombre,\n  1156→                        'puntaje'     => $item->puntaje,\n  1157→                        'puntaje_ia'  => $item->puntaje_ia,\n  1158→                        'comentarios' => $item->comentarios->pluck('comentario')->values()->toArray()\n  1159→                    ];\n  1160→\n  1161→                    if ($item->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE) {\n  1162→                        $agendas = $this->agenda_repositorio->getTodo(new Request([\n  1163→                            'proceso_id'         => $vacante->proceso->id,\n  1164→                            'evaluado_id'        => $item->usuario_id,\n  1165→                            'estado_id'          => EstadoAgenda::FINALIZADA_ID,\n  1166→                            'incluir_resultados' => true\n  1167→                        ]));\n  1168→\n  1169→                        $datos_etapas['pruebas_psicometricas'] = [];\n  1170→\n  1171→                        foreach ($agendas as $agenda) {\n  1172→                            array_push($datos_etapas['pruebas_psicometricas'], [\n  1173→                                'prueba'     => $agenda->prueba->nombre,\n  1174→                                'ajuste'     => $agenda->ajuste,\n  1175→                                'resultados' => $agenda->resultados->map(function ($resultado) {\n  1176→                                    return [\n  1177→                                        'dimension' => $resultado->dimension->nombre,\n  1178→                                        'puntaje'   => $resultado->puntaje_transformado\n  1179→                                    ];\n  1180→                                })->values()->toArray()\n  1181→                            ]);\n  1182→                        }\n  1183→\n  1184→                        if (count($datos_etapas['pruebas_psicometricas']) === 0) {\n  1185→                            unset($datos_etapas['pruebas_psicometricas']);\n  1186→                        }\n  1187→                    }\n  1188→\n  1189→                    array_push($usuario['etapas'], $datos_etapas);\n  1190→                }\n  1191→            }\n  1192→\n  1193→            array_push($candidatos_ia, $usuario);\n  1194→        }\n  1195→\n  1196→        return $this->realizarPeticionIA('obtener-candidatos-recomendados', [\n  1197→            'vacante_id' => $request->vacante_id,\n  1198→            'vacante'    => json_encode($vacante_ia, JSON_UNESCAPED_UNICODE),\n  1199→            'candidatos' => json_encode($candidatos_ia, JSON_UNESCAPED_UNICODE)\n  1200→        ]);\n  1201→    }\n  1202→\n  1203→    /**\n  1204→     * Obtener competencias por mejorar para usuario que será contratado.\n  1205→     * SOLO Buscar agendas de TenDisc Plus (12) y Potencial Comercial (7)\n  1206→     * @param int $id ID de la etapa del usuario en la vacante.\n  1207→     * @return array\n  1208→     * @author Sergio Vargas\n  1209→     */\n  1210→    public function obtenerCompetenciasPorMejorar(int $id): array {\n  1211→        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n  1212→        $usuario_id = $etapa_vacante_usuario->usuario_id;\n  1213→        $proceso = $etapa_vacante_usuario->vacante->proceso;\n  1214→\n  1215→        if (is_null($proceso)) {\n  1216→            return ['pruebas' => []];\n  1217→        }\n  1218→\n  1219→        $agendas = $this->agenda_repositorio->getTodo(new Request([\n  1220→            'proceso_id' => $proceso->id,\n  1221→            'evaluado_id' => $usuario_id,\n  1222→            'pruebas_ids' => [12, 7],\n  1223→            'estado_id' => 3,\n  1224→            'con_evaluado' => true\n  1225→        ]));\n  1226→\n  1227→        $resultado = ['pruebas' => []];\n  1228→\n  1229→        foreach ($agendas as $agenda) {\n  1230→            $competencias_bajas = $this->extraerCompetenciasBajas($agenda);\n  1231→\n  1232→            if (!empty($competencias_bajas)) {\n  1233→                $resultado['pruebas'][] = [\n  1234→                    'prueba_id' => $agenda->prueba_id,\n  1235→                    'nombre_prueba' => $agenda->prueba->nombre,\n  1236→                    'competencias' => $competencias_bajas\n  1237→                ];\n  1238→            }\n  1239→        }\n  1240→\n  1241→        return $resultado;\n  1242→    }\n  1243→\n  1244→    /**\n  1245→     * Extraer las 2 competencias más bajas de una agenda según su prueba.\n  1246→     *\n  1247→     * @param \\App\\Models\\Agendas\\Agenda $agenda Agenda finalizada.\n  1248→     * @return array\n  1249→     * @author Sergio Vargas\n  1250→     */\n  1251→    private function extraerCompetenciasBajas($agenda): array {\n  1252→        $resultados = $this->resultado_agenda_servicio->gestionarResultados($agenda);\n  1253→\n  1254→        if (empty($resultados)) {\n  1255→            return [];\n  1256→        }\n  1257→\n  1258→        $competencias_todas = [];\n  1259→\n  1260→        // TenDisc Plus (prueba_id = 12)\n  1261→        if ($agenda->prueba_id === 12) {\n  1262→            $factor_especificas = collect($resultados)->firstWhere('nombre', 'Competencias Específicas');\n  1263→            $factor_transversales = collect($resultados)->firstWhere('nombre', 'Competencias Transversales');\n  1264→\n  1265→            if ($factor_especificas) {\n  1266→                $competencias_todas = array_merge($competencias_todas, $factor_especificas['dimensiones']);\n  1267→            }\n  1268→            if ($factor_transversales) {\n  1269→                $competencias_todas = array_merge($competencias_todas, $factor_transversales['dimensiones']);\n  1270→            }\n  1271→        }\n  1272→\n  1273→        // Potencial Comercial (prueba_id = 7)\n  1274→        if ($agenda->prueba_id === 7) {\n  1275→            $factor_caracter = collect($resultados)->firstWhere('nombre', 'Carácter');\n  1276→            $factor_habilidades = collect($resultados)->firstWhere('nombre', 'Habilidades');\n  1277→\n  1278→            if ($factor_caracter) {\n  1279→                $competencias_todas = array_merge($competencias_todas, $factor_caracter['dimensiones']);\n  1280→            }\n  1281→            if ($factor_habilidades) {\n  1282→                $competencias_todas = array_merge($competencias_todas, $factor_habilidades['dimensiones']);\n  1283→            }\n  1284→        }\n  1285→\n  1286→        // Ordenar por puntaje ascendente y tomar las 2 más bajas\n  1287→        return collect($competencias_todas)\n  1288→            ->sortBy('puntaje_transformado')\n  1289→            ->take(2)\n  1290→            ->map(fn($c) => [\n  1291→                'nombre' => $c['nombre'],\n  1292→                'puntaje' => round($c['puntaje_transformado'], 0)\n  1293→            ])\n  1294→            ->values()\n  1295→            ->toArray();\n  1296→    }\n  1297→}\n  1298→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"666538e6-b052-4215-812f-9cf95f5263fb","timestamp":"2026-01-08T16:00:02.692Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Vacantes;\n\nuse App\\Traits\\IATrait;\nuse App\\Traits\\StringTrait;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Vacantes\\Vacante;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Agendas\\EstadoAgenda;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Support\\Facades\\Mail;\nuse App\\Models\\Vacantes\\EtapaVacante;\nuse App\\Models\\Vacantes\\EstadoVacante;\nuse App\\Models\\Vacantes\\MovimientoVacante;\nuse App\\Mail\\NotificarFinalizacionEtapaMail;\nuse App\\Mail\\NotificarPostulanteVacanteMail;\nuse App\\Models\\Vacantes\\EtapaVacanteUsuario;\nuse Illuminate\\Http\\Client\\RequestException;\nuse App\\Http\\Services\\Vacantes\\VacanteService;\nuse App\\Models\\Configuraciones\\PlantillaCorreo;\nuse Illuminate\\Http\\Client\\ConnectionException;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Services\\Usuarios\\TokenAccesoService;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Services\\Vacantes\\EtapaVacanteService;\nuse App\\Jobs\\Vacantes\\ProcesarVideoentrevistaIAJob;\nuse App\\Http\\Repositories\\Procesos\\ProcesoRepository;\nuse App\\Http\\Repositories\\Vacantes\\VacanteRepository;\nuse App\\Http\\Services\\Agendas\\ResultadoAgendaService;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse App\\Notifications\\NotificarAvanceProcesoNotification;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteRepository;\nuse App\\Http\\Repositories\\Vacantes\\TranscripcionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Vacantes\\AspectoPuntajeRepository;\nuse App\\Http\\Services\\Configuraciones\\PlantillaCorreoService;\nuse App\\Http\\Repositories\\Vacantes\\FormatoEntrevistaRepository;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteUsuarioRepository;\nuse App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\nuse App\\Http\\Repositories\\Vacantes\\EtapaMovimientoVacanteRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PreguntaOfertaLaboralRepository;\nuse App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PuntajePreguntaOfertaLaboralRepository;\n\n/**\n * @property EtapaVacanteUsuarioRepository $repositorio\n */\nclass EtapaVacanteUsuarioService extends BaseService\n{\n    use ArchivoTrait, IATrait, StringTrait;\n\n    /**\n     * @var float|int $puntaje_total Puntaje total, utilizado para la adecuación de HV.\n     */\n    private $puntaje_total = 0;\n\n    /**\n     * @var float $puntaje Puntaje de aspecto, utilizado para la adecuación de HV.\n     */\n    private $puntaje = 0;\n\n    /**\n     * @var bool $cumple Indica si cumple con el aspecto, utilizada para la adecuación de HV.\n     */\n    private $cumple = false;\n\n    /**\n     * Constructor.\n     *\n     * @param EtapaVacanteUsuarioRepository $repositorio Repositorio de etapas de vacantes de usuarios.\n     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n     * @param EtapaVacanteRepository $etapa_vacante_repositorio Repositorio de etapas de vacantes.\n     * @param AspectoPuntajeRepository $aspecto_puntaje_repositorio Repositorio de puntajes de aspectos.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio Repositorio de preguntas de ofertas laborales.\n     * @param PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio Repositorio de puntajes de preguntas de ofertas laborales.\n     * @param EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio Repositorio de movimientos de etapas de vacantes.\n     * @param ProcesoRepository $proceso_repositorio Repositorio de procesos.\n     * @param TranscripcionRepository $transcripcion_repositorio Repositorio de transcripciones.\n     * @param PlantillaCorreoService $plantilla_correo_servicio Servicio de plantillas de correo.\n     * @param TokenAccesoService $token_acceso_servicio Servicio de tokens de acceso.\n     * @param UserRepository $usuario_repositorio Servicio de usuarios.\n     * @param VacanteRepository $vacante_repositorio Repositorio de vacantes.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param ResultadoAgendaService $resultado_agenda_servicio Servicio de resultados de agendas.\n     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n     * @param FormatoEntrevistaRepository $formato_entrevista_repositorio Repositorio de formatos de entrevista.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function __construct(\n        EtapaVacanteUsuarioRepository $repositorio,\n        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n        protected EtapaVacanteRepository $etapa_vacante_repositorio,\n        protected AspectoPuntajeRepository $aspecto_puntaje_repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio,\n        protected PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio,\n        protected EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio,\n        protected ProcesoRepository $proceso_repositorio,\n        protected TranscripcionRepository $transcripcion_repositorio,\n        protected PlantillaCorreoService $plantilla_correo_servicio,\n        protected TokenAccesoService $token_acceso_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected VacanteRepository $vacante_repositorio,\n        protected AgendaRepository $agenda_repositorio,\n        protected ResultadoAgendaService $resultado_agenda_servicio,\n        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n        protected FormatoEntrevistaRepository $formato_entrevista_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar documento solicitado de una etapa de vacante de usuario.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function guardarDocumentoSolicitado(Request $request): void {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n        if ($request->hasFile('archivo')) {\n            $this->archivo_servicio->guardarVarios(EtapaVacanteUsuario::class, $request->etapa_vacante_usuario_id, [$request->nombre_documento => $request->file('archivo')], 'empresas/' . $empresa->id . '/documentos-solicitados', true);\n        }\n    }\n\n    /**\n     * Establecer valores para puntaje y cumplimiento de un aspecto.\n     *\n     * @param float $puntaje Puntaje obtenido.\n     * @param bool $cumple Indica si cumple.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function establecerPuntajeCumplimiento(float $puntaje = 0, bool $cumple = false): void {\n        $this->puntaje = $puntaje;\n        $this->cumple  = $cumple;\n    }\n\n    /**\n     * Guardar puntaje de un aspecto evaluado.\n     *\n     * @param int $etapa_vacante_usuario_id ID de la etapa del usuario en la vacante.\n     * @param string $categoria Categoría del aspecto.\n     * @param string $aspecto Aspecto evaluado.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function guardarAspectoPuntaje(int $etapa_vacante_usuario_id, string $categoria, string $aspecto): void {\n        $this->aspecto_puntaje_repositorio->crearOActualizar([\n            'etapa_vacante_usuario_id' => $etapa_vacante_usuario_id,\n            'categoria'                => $categoria,\n            'aspecto'                  => $aspecto\n        ], [\n            'puntaje'                  => $this->puntaje,\n            'cumple'                   => $this->cumple\n        ]);\n\n        $this->puntaje_total += $this->puntaje;\n        $this->establecerPuntajeCumplimiento();\n    }\n\n    /**\n     * Generar adecuación de hoja de vida.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionHV(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::REVISION_HV_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $perfil_laboral = $this->perfil_laboral_repositorio->getUnoAvanzado(new Request([\n                'usuario_id'                     => $etapa_usuario->usuario_id,\n                'incluir_experiencias_laborales' => true,\n                'incluir_estudios'               => true,\n                'incluir_idiomas'                => true,\n                'incluir_usuario'                => true\n            ]));\n\n            // Generar y guardar la adecuación del perfil de candidato (habilidades y herramientas tecnológicas)\n            $categoria            = 'perfil';\n            $puntaje_aspecto      = 100 / 2;\n            $datos_vacante        = $etapa_usuario->vacante->datos;\n            $habilidades_vacante  = $datos_vacante->where('llave', 'habilidades')->first();\n            $herramientas_vacante = $datos_vacante->where('llave', 'herramientas_tecnologicas')->first();\n\n            // Validar coincidencia para las habilidades\n            if (!is_null($habilidades_vacante->valor) && !empty($habilidades_vacante->valor)) {\n                $habilidades_vacante        = array_map(fn($item) => trim($item), explode(',', $habilidades_vacante->valor));\n                $habilidades_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->habilidades));\n                $coincidencias              = count(array_uintersect($habilidades_vacante, $habilidades_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($habilidades_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'habilidades');\n\n            // Validar coincidencia para las herramientas tecnológicas\n            if (!is_null($herramientas_vacante->valor) && !empty($herramientas_vacante->valor)) {\n                $herramientas_vacante        = array_map(fn($item) => trim($item), explode(',', $herramientas_vacante->valor));\n                $herramientas_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->herramientas_tecnologicas));\n                $coincidencias               = count(array_uintersect($herramientas_vacante, $herramientas_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($herramientas_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'herramientas');\n\n            // Generar y guardar la adecuación de requisitos del candidato (género, edad, nivel educativo, modalidad de trabajo, salario, experiencia, idiomas, licencia de conducir)\n            $categoria       = 'requisito';\n            $puntaje_aspecto = 100 / 8;\n\n            // Validar coincidencia de género\n            $genero_vacante = $datos_vacante->where('llave', 'genero')->first();\n\n            if (!is_null($genero_vacante) && !empty($genero_vacante)) {\n                if ($genero_vacante->valor === mb_convert_case($perfil_laboral->usuario->genero->nombre, MB_CASE_LOWER)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                } elseif ($genero_vacante->valor === 'indiferente') {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'genero');\n\n            // Validar coincidencia de edad\n            $edad_minima_vacante = $datos_vacante->where('llave', 'edad_minima')->first();\n            $edad_maxima_vacante = $datos_vacante->where('llave', 'edad_maxima')->first();\n\n            if (empty($edad_minima_vacante->valor) || empty($edad_maxima_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($perfil_laboral->usuario->edad >= $edad_minima_vacante->valor && $perfil_laboral->usuario->edad <= $edad_maxima_vacante->valor) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'edad');\n\n            // Validar coincidencia de nivel educativo\n            $nivel_educativo_vacante = $datos_vacante->where('llave', 'nivel_educativo')->first();\n            $escala_estudios         = [\n                'Preescolar'                      => 1,\n                'Primaria'                        => 2,\n                'Secundaria básica'               => 3,\n                'Secundaria superior'             => 4,\n                'Educación continua y permanente' => 5,\n                'Técnico'                         => 6,\n                'Tecnólogo'                       => 7,\n                'Profesional'                     => 8,\n                'Especialización (postgrado)'     => 9,\n                'Maestría (postgrado)'            => 10,\n                'Doctorado (postgrado)'           => 11\n            ];\n\n            if (empty($nivel_educativo_vacante->valor) || $nivel_educativo_vacante->valor === 'indiferente') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (count($perfil_laboral->estudios) > 0) {\n                $cumple_nivel_educativo = false;\n\n                foreach ($perfil_laboral->estudios as $estudio) {\n                    if ($escala_estudios[$nivel_educativo_vacante->valor] <= $escala_estudios[$estudio->nivelEducativo->nombre]) {\n                        $cumple_nivel_educativo = true;\n                        break;\n                    }\n                }\n\n                if ($cumple_nivel_educativo) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'estudios');\n\n            // Validar coincidencia de modalidad de trabajo\n            if (!is_null($etapa_usuario->vacante->modalidad_trabajo_id)) {\n                if ($etapa_usuario->vacante->modalidad_trabajo_id === $perfil_laboral->modalidad_trabajo_id) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'modalidad_trabajo');\n\n            // Validar coincidencia de salario\n            if (is_null($etapa_usuario->vacante->salario)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (!is_null($etapa_usuario->vacante->salario) && is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Salario fijo\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario de la vacante es fijo pero el del usuario es rango\n                    if (($etapa_usuario->vacante->salario >= $perfil_laboral->salario && $etapa_usuario->vacante->salario <= $perfil_laboral->salario_maximo) || ($perfil_laboral->salario <= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } elseif ($perfil_laboral->salario <= $etapa_usuario->vacante->salario) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (!is_null($etapa_usuario->vacante->salario) && !is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Rango de salario\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario del usuario y de la vacante son rangos\n                    if (($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) || ($perfil_laboral->salario_maximo >= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario_maximo)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } else {\n                    if ($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'salario');\n\n            // Validar coincidencia de experiencia\n            $experiencia_vacante   = $datos_vacante->where('llave', 'experiencia_laboral')->first();\n            $experiencia_aplicante = $perfil_laboral->experienciasLaborales->sum('tiempo');\n            $experiencias          = [\n                '1 año'        => 1,\n                '2 años'       => 2,\n                '3 años'       => 3,\n                '4 años'       => 4,\n                '5 años o más' => 5\n            ];\n\n            if (empty($experiencia_vacante->valor) || $experiencia_vacante->valor === 'Sin experiencia') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($experiencia_vacante->valor === 'Menos de 1 año') {\n                if ($experiencia_aplicante > 0 && $experiencia_aplicante < 365) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (($experiencias[$experiencia_vacante->valor] * 365) <= $experiencia_aplicante) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'experiencia');\n\n            // Validar coincidencia de idiomas\n            $idiomas_vacante = $etapa_usuario->vacante->idiomas;\n            $escala_idiomas  = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'C1' => 5,\n                'C2' => 6\n            ];\n\n            if ($idiomas_vacante->count() > 0) {\n                $coincidencias_idiomas = 0;\n\n                if ($perfil_laboral->idiomas->count() > 0) {\n                    foreach ($idiomas_vacante as $idioma) {\n                        foreach ($perfil_laboral->idiomas as $idioma_perfil) {\n                            if ($idioma->idioma_id === $idioma_perfil->idioma_id && $escala_idiomas[$idioma->nivel] <= $escala_idiomas[$idioma_perfil->nivel]) {\n                                $coincidencias_idiomas++;\n                            }\n                        }\n                    }\n                }\n\n                if ($coincidencias_idiomas >= $idiomas_vacante->count()) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'idiomas');\n\n            // Validar coincidencia de licencia de conducir\n            $licencia_conducir_vacante = $datos_vacante->where('llave', 'licencia_conducir')->first();\n            $escala_licencias          = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'B3' => 5,\n                'C1' => 6,\n                'C2' => 7,\n                'C3' => 8\n            ];\n\n            if (empty($licencia_conducir_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (is_null($perfil_laboral->licencia_conducir)) {\n                if (empty($licencia_conducir_vacante->valor)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif ($escala_licencias[$licencia_conducir_vacante->valor] <= $escala_licencias[$perfil_laboral->licencia_conducir]) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'licencia_conducir');\n\n            $puntaje_total = round($this->puntaje_total / 2); // Se divide entre las dos categorías existentes\n            $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::REVISION_HV_ID, $puntaje_total, 'descartar_candidatos_adecuaciones_bajas_hv', 'descartar_candidatos_adecuaciones_medias_hv');\n        }\n    }\n\n    /**\n     * Generar adecuación para preguntas prefiltro.\n     *\n     * Califica las respuestas del aplicante en cada una de las preguntas y calcula la adecuación en base a sus resultados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPrefiltro(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'   => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'         => $etapa_usuario->usuario_id,\n                'incluir_respuestas' => true\n            ]));\n\n            $porcentaje_pregunta  = 100 / $preguntas->count();\n            $respuestas_correctas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                $puntaje    = null;\n                $puntaje_ia = null;\n\n                if ($pregunta->es_abierta) {\n                    $respuesta = $opcion_seleccionada = $pregunta->respuestas->first();\n\n                    if (!is_null($respuesta)) {\n                        try {\n                            $peticion_ia = $this->realizarPeticionIA(\n                                ruta: 'calificar-pregunta-abierta',\n                                parametros: [\n                                    'pregunta'  => $pregunta->enunciado,\n                                    'respuesta' => $respuesta->respuesta,\n                                ],\n                                contexto_tracking: [\n                                    'vacante_id' => $etapa_usuario->etapa->vacante_id ?? null,\n                                    'agenda_id' => null,\n                                ]\n                            );\n\n                            if (!is_null($peticion_ia) && $peticion_ia['status_code'] === 200) {\n                                $puntaje_ia = $peticion_ia['calificacion'];\n                            }\n                        } catch (RequestException|ConnectionException $error) {}\n                    }\n                } else {\n                    $opciones_correctas = $pregunta->opciones->where('es_correcta', true);\n\n                    // Selección única\n                    if ($opciones_correctas->count() === 1) {\n                        $opcion_correcta     = $opciones_correctas->first();\n                        $opcion_seleccionada = $pregunta->respuestas->first();\n                        $puntaje             = (int) (!is_null($opcion_seleccionada) && $opcion_correcta->id === $opcion_seleccionada->opcion_pregunta_id);\n                    } else { // Selección múltiple\n                        $opciones_correctas     = $opciones_correctas->pluck('id')->toArray();\n                        $opciones_seleccionadas = $pregunta->respuestas->pluck('opcion_pregunta_id')->toArray();\n                        $aciertos               = count(array_intersect($opciones_seleccionadas, $opciones_correctas));\n                        $fallos                 = count(array_diff($opciones_seleccionadas, $opciones_correctas));\n                        $puntaje                = (int) ($aciertos - $fallos === count($opciones_correctas));\n                    }\n                }\n\n                // Guardar el puntaje obtenido en cada pregunta\n                $this->puntaje_pregunta_oferta_laboral_repositorio->crearSiNoExiste([\n                    'pregunta_id' => $pregunta->id,\n                    'usuario_id'  => $etapa_usuario->usuario_id\n                ], [\n                    'puntaje'     => $puntaje,\n                    'puntaje_ia'  => $puntaje_ia\n                ]);\n\n                // Sumar el puntaje total\n                if (is_null($puntaje) && !is_null($puntaje_ia)) {\n                    $respuestas_correctas += $puntaje_ia;\n                } else {\n                    $respuestas_correctas += $puntaje;\n                }\n            }\n\n            $puntaje_etapa = $respuestas_correctas * $porcentaje_pregunta;\n\n            if ($etapa_usuario->vacante->automatizar_etapas) {\n                // Obtener el movimiento de la etapa con sus configuraciones\n                $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                    'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                    'movimiento_vacante_id'   => MovimientoVacante::PREGUNTAS_PREFILTRO_ID,\n                    'incluir_configuraciones' => true\n                ]));\n\n                $configuracion_preguntas_correctas = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', 'descartar_candidatos_respondieron_menos_preguntas_prefiltro')->first();\n\n                // Avanzar al aplicante de etapa o descartarlo según la configuración de la etapa\n                if (!is_null($configuracion_preguntas_correctas) && $configuracion_preguntas_correctas->valor <= $respuestas_correctas) {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa);\n                } else {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa, descartar: true);\n                }\n            } else {\n                $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_etapa]);\n            }\n        }\n    }\n\n    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n            }\n\n            if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::VIDEO_ENTREVISTA_NOMBRE, EtapaVacante::ENTREVISTA_NOMBRE])) {\n                if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE) {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_videoentrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_videoentrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_videoentrevista';\n                } else {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n                }\n\n                if ($this->verificarFormatoEntrevista($etapa_usuario, $movimiento_vacante_id, $llave_configuracion_formato)) {\n                    $this->gestionarContinuidadAplicante($etapa_usuario, $movimiento_vacante_id, $puntaje, $llave_configuracion_adecuaciones_bajas, $llave_configuracion_adecuaciones_medias);\n                } else {\n                    $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n                }\n\n                // TODO: Invocar esta función al momento de completar el formato de entrevista\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para pruebas psicométricas.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPruebasPsicometricas(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $indice_talento = $this->proceso_repositorio->obtenerIndiceTalento($etapa_usuario->vacante->proceso->id, $etapa_usuario->usuario_id)->indice_talento;\n\n            if ($indice_talento >= 0) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBAS_PSICOMETRICAS_ID, $indice_talento, 'descartar_candidatos_puntuaciones_bajas', 'descartar_candidatos_puntuaciones_medias', true);\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para videoentrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function generarAdecuacionVideoentrevista(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje_ia)) {\n            ProcesarVideoentrevistaIAJob::dispatch($etapa_usuario);\n        }\n    }\n\n    /**\n     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n     * @author Daniel Beltrán\n     */\n    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n        $formato_diligenciado = false;\n        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n            'movimiento_vacante_id'   => $movimiento_vacante_id,\n            'incluir_configuraciones' => true\n        ]));\n\n        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n        } else {\n            $formato_diligenciado = true;\n        }\n\n        return $formato_diligenciado;\n    }\n\n    /**\n     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n     *\n     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n     * @param int $usuario_id ID del usuario (aplicante).\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id' => $etapa_vacante_id,\n            'usuario_id'       => $usuario_id\n        ]));\n\n        if ($etapa_usuario->activo) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id' => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'       => $etapa_usuario->usuario_id,\n                'incluir_puntajes' => true\n            ]));\n\n            $puntaje            = 0;\n            $puntaje_individual = 100 / $preguntas->count();\n\n            foreach ($preguntas as $pregunta) {\n                if (is_null($pregunta->puntajes[0]->puntaje) && !is_null($pregunta->puntajes[0]->puntaje_ia)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje_ia;\n                } elseif (!is_null($pregunta->puntajes[0]->puntaje)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje;\n                }\n            }\n\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_individual * $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar el puntaje de la etapa actual y gestionar la continuidad del aplicante en la vacante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param int $puntaje Puntaje obtenido en la etapa actual.\n     * @param string $llave_puntajes_bajos Llave de configuración para puntajes bajos.\n     * @param string $llave_puntajes_medios Llave de configuración para puntajes medios.\n     * @param bool $escala_pruebas_psicometricas Indica si debe utilizar la escala de puntajes de pruebas psicométricas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function gestionarContinuidadAplicante(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, int $puntaje, string $llave_puntajes_bajos, string $llave_puntajes_medios, bool $escala_pruebas_psicometricas = false) {\n        if ($etapa_usuario->vacante->automatizar_etapas) {\n            $calificacion_baja  = 40;\n            $calificacion_media = 70;\n\n            if ($escala_pruebas_psicometricas) {\n                $calificacion_baja  = 59;\n                $calificacion_media = 75;\n            }\n\n            // Obtener el movimiento de la etapa con sus configuraciones\n            $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                'movimiento_vacante_id'   => $movimiento_vacante_id,\n                'incluir_configuraciones' => true\n            ]));\n\n            $configuracion_adecuaciones_bajas  = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_bajos)->first();\n            $configuracion_adecuaciones_medias = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_medios)->first();\n\n            if (!is_null($configuracion_adecuaciones_medias) && filter_var($configuracion_adecuaciones_medias->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_media) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            } elseif (!is_null($configuracion_adecuaciones_bajas) && filter_var($configuracion_adecuaciones_bajas->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_baja) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            }\n\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje);\n        } else {\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar puntaje de la etapa actual y mover al aplicante a la siguiente etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param ?int $puntaje Puntaje obtenido en la etapa actual.\n     * @param ?int $puntaje_ia Puntaje obtenido por la IA en la etapa actual.\n     * @param ?string $notas_ia Notas dadas por la IA para la etapa actual.\n     * @param bool $descartar Indica si la etapa a la que se debe cambiar es 'descartados'.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function guardarPuntajeYCambiarDeEtapa(EtapaVacanteUsuario $etapa_usuario, ?int $puntaje = null, ?int $puntaje_ia = null, ?string $notas_ia = null, bool $descartar = false): void {\n        if ($descartar) {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->getUnoAvanzado(new Request(['vacante_id' => $etapa_usuario->vacante->id, 'nombre' => EtapaVacante::DESCARTADOS_NOMBRE]));\n        } else {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->obtenerEtapaSiguiente($etapa_usuario->vacante->id, $etapa_usuario->etapa->orden);\n        }\n\n        $etapa_actual_activa = true;\n\n        if ($etapa_siguiente->nombre !== EtapaVacante::CONTRATADOS_NOMBRE) {\n            $etapa_actual_activa = false;\n            $nueva_etapa_usuario = $this->repositorio->crear([\n                'usuario_id'       => $etapa_usuario->usuario_id,\n                'etapa_vacante_id' => $etapa_siguiente->id,\n                'activo'           => true\n            ]);\n\n            // Crear agendas de pruebas psicométricas si la etapa siguiente son pruebas psicométricas.\n            app(VacanteService::class)->crearAgendasPruebasPsicometricas($etapa_usuario, $etapa_siguiente->id);\n\n            if ($nueva_etapa_usuario) {\n                $this->notificarCambioEtapa($nueva_etapa_usuario);\n            }\n        }\n\n        $this->repositorio->actualizar($etapa_usuario->id, [\n            'puntaje'    => $puntaje,\n            'puntaje_ia' => $puntaje_ia,\n            'notas_ia'   => $notas_ia,\n            'activo'     => $etapa_actual_activa\n        ]);\n\n        // Cuando la etapa es contratado, se valida si ya se han completado las vacantes requeridas para cerrar la vacante\n        if ($etapa_siguiente->nombre === EtapaVacante::CONTRATADOS_NOMBRE) {\n            if ($etapa_usuario->vacante->cantidad_vacantes === $this->repositorio->contarContratados($etapa_usuario->etapa->vacante_id)) {\n                $this->vacante_repositorio->actualizar($etapa_usuario->etapa->vacante_id, ['estado_id' => EstadoVacante::COMPLETADA_ID]);\n\n                $aplicantes_activos_restantes_ids = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'excluir_etapas'         => [EtapaVacante::DESCARTADOS_NOMBRE, EtapaVacante::CONTRATADOS_NOMBRE]\n                ]))->pluck('id')->toArray();\n\n                // Descartar a los aplicantes que quedan activos en la vacante\n                $this->descartarAplicantesManual($aplicantes_activos_restantes_ids);\n\n                $aplicantes_activos_sin_notificar = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'sin_fecha_notificacion' => true\n                ]));\n\n                foreach ($aplicantes_activos_sin_notificar as $aplicante) {\n                    $this->notificarCambioEtapa($aplicante, false);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener la adecuación actual del usuario en la vacante.\n     *\n     * @param int $usuario_id ID del usuario.\n     * @param int $vacante_id ID de la vacante.\n     * @return ?int\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function obtenerAdecuacionUsuario(int $usuario_id, int $vacante_id): ?int {\n        $etapas     = $this->repositorio->obtenerEtapasCompletadasUsuario($usuario_id, $vacante_id);\n        $adecuacion = 0;\n\n        foreach ($etapas as $etapa) {\n            if (!is_null($etapa->puntaje)) {\n                $adecuacion += $etapa->puntaje;\n            } elseif (is_null($etapa->puntaje) && !is_null($etapa->puntaje_ia)) {\n                $adecuacion += $etapa->puntaje_ia;\n            }\n        }\n\n        return ($etapas->count() > 0) ? $adecuacion / $etapas->count() : null;\n    }\n\n    /**\n     * Verificar si una etapa ya ha sido completada por el aplicante.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante (etapa_vacante_usuario_id).\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function verificarEtapaCompletada(int $id): bool {\n        $etapa_usuario    = $this->repositorio->getUno($id);\n        $etapa_completada = false;\n\n        // Verificar si la etapa de revisión de hoja de vida ya fue completada\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::REVISION_HV_NOMBRE, EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE]) && !is_null($etapa_usuario->puntaje) || !is_null($etapa_usuario->puntaje_ia)) {\n            $etapa_completada = true;\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::ENTREVISTA_NOMBRE) {\n            if ($this->configuracion_modelo_servicio->obtenerValorLlaveConfiguracion(app(VacanteService::class)->obtenerConfiguracionesEtapaAplicante($etapa_usuario->etapa_vacante_id), 'solicitar_formato_entrevista')) {\n                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n\n                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n                    $etapa_completada = true;\n                }\n            } else {\n                $etapa_completada = true;\n            }\n        }\n\n        // Verificar si las etapas de preguntas prefiltro o videoentrevista ya han sido completadas\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE])) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'                      => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'                            => $etapa_usuario->usuario_id,\n                'incluir_cantidad_respuestas_aplicante' => true\n            ]));\n\n            $preguntas_contestadas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                if ($pregunta['respuestas_count'] > 0) {\n                    $preguntas_contestadas++;\n                }\n            }\n\n            // Validar que todas las preguntas hayan sido contestadas\n            if (count($preguntas) === $preguntas_contestadas) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n            if ((!is_null($etapa_usuario->pruebaTecnica?->enlace) && !empty($etapa_usuario->pruebaTecnica?->enlace) || $etapa_usuario->pruebaTecnica?->archivos->count() > 0) && $etapa_usuario->pruebaTecnica?->borrador == false) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE) {\n            $documentos_contratacion = app(EtapaVacanteService::class)->obtenerDocumentosContratacion(\n                $etapa_usuario->etapa_vacante_id,\n                new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id])\n            );\n\n            $documentos_solicitados     = collect($documentos_contratacion['documentos']);\n            $archivos_guardados         = collect($documentos_contratacion['archivos_guardados']);\n            $archivos_guardados_nombres = $archivos_guardados->pluck('nombre')->toArray();\n\n            $todos_cargados = true;\n            foreach ($documentos_solicitados as $documento) {\n                $nombre_normalizado = $this->normalizarNombreDocumento($documento['nombre']);\n\n                if (!in_array($nombre_normalizado, $archivos_guardados_nombres)) {\n                    $todos_cargados = false;\n                    break;\n                }\n            }\n\n            if ($todos_cargados && $documentos_solicitados->count() > 0) {\n                $etapa_completada = true;\n            }\n        }\n\n        return $etapa_completada;\n    }\n\n    /**\n     * Notificar documentos solicitados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function notificarDocumentosSolicitados(int $id): void {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_vacante_usuario) {\n            $this->enviarCorreoFinalizacionEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->vacante);\n        }\n    }\n\n    /**\n     * Descartar uno o varios aplicantes manualmente y moverlos a la etapa de descartados.\n     *\n     * @param array $ids IDs de las etapas de usuarios en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function descartarAplicantesManual(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n            if ($etapa_vacante_usuario) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n            }\n        }\n    }\n\n    /**\n     * Revertir descarte de aplicantes.\n     *\n     * @param array $ids IDs de las etapas de los usuarios descartados en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function revertirDescarteAplicantes(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_descartado = $this->repositorio->getUno($id);\n\n            if ($etapa_descartado && $etapa_descartado->etapa->nombre === EtapaVacante::DESCARTADOS_NOMBRE && $etapa_descartado->activo) {\n                $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $etapa_descartado->vacante->id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n                $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n                $etapa_previa          = $this->repositorio->obtenerEtapaPrevia($etapa_descartado->usuario_id, $etapas_ids);\n\n                if ($etapa_previa) {\n                    $this->repositorio->eliminar($etapa_descartado->id);\n                    $this->repositorio->actualizar($etapa_previa->id, ['activo' => true]);\n                }\n            }\n        }\n    }\n\n    /**\n     * Mover manualmente al aplicante a la siguiente etapa.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function moverAplicanteEtapaManual(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n        $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $etapa_usuario->puntaje ?? 0);\n    }\n\n    /**\n     * Marcar la vacante como abandonada por el aplicante.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function abandonarVacante(Request $request): void {\n        $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $request->vacante_id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n        $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n        $etapa_vacante_usuario = $this->repositorio->obtenerEtapaPrevia($request->usuario_id, $etapas_ids);\n\n        if ($etapa_vacante_usuario) {\n            $this->repositorio->actualizar($etapa_vacante_usuario->id, ['motivo_abandono' => $request->motivo_abandono]);\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n        }\n    }\n\n    /**\n     * Notificar al aplicante sobre el cambio de etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param bool $aplicar_validacion_fin_proceso Indica si se debe aplicar la validación de fin de proceso.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function notificarCambioEtapa(EtapaVacanteUsuario $etapa_usuario, bool $aplicar_validacion_fin_proceso = true): void {\n        $etapa_usuario->load(['etapa', 'vacante', 'usuario']);\n        $etapa = $etapa_usuario->etapa;\n\n        $plantilla_correo_id = [\n            EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE     => PlantillaCorreo::PREGUNTAS_PRE_FILTRO_ID,\n            EtapaVacante::PRUEBA_TECNICA_NOMBRE          => PlantillaCorreo::ENVIO_PRUEBA_TECNICA_ID,\n            EtapaVacante::VIDEO_ENTREVISTA_NOMBRE        => PlantillaCorreo::SOLICITUD_VIDEOENTREVISTAS_ID,\n            EtapaVacante::ENTREVISTA_NOMBRE              => PlantillaCorreo::NOTIFICACION_ENTREVISTA_ID,\n            EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE => PlantillaCorreo::SOLICITUD_DOCUMENTOS_ID,\n            EtapaVacante::CONTRATADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_CONTRATADOS_ID,\n            EtapaVacante::DESCARTADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_DESCARTADOS_ID\n        ][$etapa->nombre] ?? null;\n\n        if (isset($plantilla_correo_id)) {\n            $plantilla_correo_etapa = $this->plantilla_correo_servicio->obtenerUno(new Request([\n                'plantilla_correo_id' => $plantilla_correo_id,\n                'empresa_id'          => $etapa_usuario->vacante->empresa_id\n            ]));\n\n            if (!is_null($plantilla_correo_etapa)) {\n                $es_etapa_fin_proceso = in_array($etapa->nombre, [\n                    EtapaVacante::CONTRATADOS_NOMBRE,\n                    EtapaVacante::DESCARTADOS_NOMBRE\n                ]);\n\n                // Si es etapa de fin de proceso y notificar_fin_proceso es true, no enviar notificación\n                if ($aplicar_validacion_fin_proceso && $es_etapa_fin_proceso && $plantilla_correo_etapa->notificar_fin_proceso) {\n                    return;\n                }\n\n                $usuario            = $etapa_usuario->usuario;\n                $vacante            = $etapa_usuario->vacante;\n                $token_acceso       = $this->token_acceso_servicio->generar($usuario->id);\n                $enlace             = request()->getSchemeAndHttpHost() . \"/control-acceso/{$token_acceso->token}?vacante_id={$vacante->id}\";\n                $usuario_informador = null;\n\n                Mail::to($usuario->email)->queue(new NotificarPostulanteVacanteMail(\n                    $usuario,\n                    $enlace,\n                    $vacante,\n                    $plantilla_correo_etapa->titulo,\n                    $plantilla_correo_etapa->contenido,\n                    $plantilla_correo_etapa->con_logo_empresa,\n                    $etapa->nombre,\n                    $usuario_informador\n                ));\n\n                // Enviar notificación de avance en el proceso\n                $usuario->notify(new NotificarAvanceProcesoNotification(\n                    $vacante->id,\n                    $vacante->nombre_vacante,\n                    $etapa->nombre,\n                    $vacante->empresa->nombre ?? 'la empresa'\n                ));\n\n                $this->repositorio->actualizar($etapa_usuario->id, ['fecha_notificacion' => now()]);\n            }\n        }\n    }\n\n    /**\n     * Enviar correo de notificación al finalizar una etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_vacante_usuario Etapa del usuario en la vacante.\n     * @param Vacante $vacante Vacante.\n     * @return void\n     * @author Jair Carvajal\n     */\n    private function enviarCorreoFinalizacionEtapa(EtapaVacanteUsuario $etapa_vacante_usuario, Vacante $vacante): void {\n        $usuario     = Auth::user();\n        $maneja_logo = file_exists(public_path('empresas-logo/' . $vacante->empresa->id)) ? '1' : null;\n\n        Mail::send(new NotificarFinalizacionEtapaMail(\n            $usuario,\n            $vacante,\n            $etapa_vacante_usuario->etapa,\n            $maneja_logo\n        ));\n    }\n\n    /**\n     * Obtener candidatos recomendados con IA.\n     *\n     * Obtiene los 3 mejores candidatos para la vacante, entre varios candidatos seleccionados por el reclutador.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function obtenerCandidatosRecomendadosIA(Request $request): array {\n        $vacante       = $this->vacante_repositorio->getUno($request->vacante_id);\n        $candidatos    = $this->usuario_repositorio->obtenerCandidatosSeleccionadosVacante($request->usuarios_ids, $request->vacante_id);\n        $candidatos_ia = [];\n        $vacante_ia    = [\n            ...Arr::only($vacante->toArray(), ['nombre_vacante', 'salario', 'salario_maximo']),\n            'habilidades'               => $vacante->datos->first(fn($item) => $item->llave === 'habilidades')->valor,\n            'herramientas_tecnologicas' => $vacante->datos->first(fn($item) => $item->llave === 'herramientas_tecnologicas')->valor,\n            'experiencia_laboral'       => $vacante->datos->first(fn($item) => $item->llave === 'experiencia_laboral')->valor,\n            'nivel_educativo'           => $vacante->datos->first(fn($item) => $item->llave === 'nivel_educativo')->valor\n        ];\n\n        if (!is_null($vacante->ciudad_id)) {\n            $direccion_trabajo = $vacante->datos->first(fn($item) => $item->llave === 'direccion_trabajo')->valor;\n            $ubicacion_empresa = \"{$vacante->ciudad->departamento->pais->nombre}, {$vacante->ciudad->departamento->nombre} - {$vacante->ciudad->nombre}, {$direccion_trabajo}\";\n        } elseif (!is_null($vacante->empresa->ciudad_id)) {\n            $ubicacion_empresa = \"{$vacante->empresa->ciudad->departamento->pais->nombre}, {$vacante->empresa->ciudad->departamento->nombre} - {$vacante->empresa->ciudad->nombre}, {$vacante->empresa->direccion}\";\n        }\n\n        if (isset($ubicacion_empresa)) {\n            $vacante_ia['ubicacion'] = $ubicacion_empresa;\n        }\n\n        foreach ($candidatos as $candidato) {\n            if (!is_null($candidato->ciudad_id) && !is_null($candidato->direccion)) {\n                $ubicacion = \"{$candidato->ciudad->departamento->pais->nombre}, {$candidato->ciudad->departamento->nombre} - {$candidato->ciudad->nombre}, {$candidato->direccion}\";\n            }\n\n            $usuario = [\n                ...Arr::only($candidato->toArray(), ['id', 'nombre_completo', 'email', 'telefono', 'edad']),\n                'adecuacion' => $this->obtenerAdecuacionUsuario($candidato->id, $request->vacante_id)\n            ];\n\n            if (isset($ubicacion)) {\n                $usuario['ubicacion'] = $ubicacion;\n            }\n\n            if (!is_null($candidato->perfilLaboral)) {\n                $usuario['salario']                   = $candidato->perfilLaboral->salario;\n                $usuario['salario_maximo']            = $candidato->perfilLaboral->salario_maximo;\n                $usuario['habilidades']               = $candidato->perfilLaboral->habilidades;\n                $usuario['herramientas_tecnologicas'] = $candidato->perfilLaboral->herramientas_tecnologicas;\n                $usuario['estudios']                  = [];\n                $usuario['experiencias_laborales']    = [];\n                $usuario['idiomas']                   = [];\n                $usuario['etapas']                    = [];\n\n                foreach ($candidato->perfilLaboral->estudios as $item) {\n                    array_push($usuario['estudios'], [\n                        ...Arr::only($item->toArray(), ['titulo', 'fecha_inicio', 'fecha_fin']),\n                        'nivel_educativo' => $item->nivelEducativo->nombre,\n                    ]);\n                }\n\n                foreach ($candidato->perfilLaboral->experienciasLaborales as $item) {\n                    array_push($usuario['experiencias_laborales'], [...Arr::only($item->toArray(), ['empresa', 'cargo', 'fecha_inicio', 'fecha_fin', 'tiempo'])]);\n                }\n\n                foreach ($candidato->perfilLaboral->idiomas as $item) {\n                    array_push($usuario['idiomas'], [\n                        'idioma' => $item->idioma->nombre,\n                        'nivel'  => $item->nivel\n                    ]);\n                }\n\n                foreach ($candidato->etapasUsuarios as $item) {\n                    $datos_etapas = [\n                        'nombre'      => $item->etapa->nombre,\n                        'puntaje'     => $item->puntaje,\n                        'puntaje_ia'  => $item->puntaje_ia,\n                        'comentarios' => $item->comentarios->pluck('comentario')->values()->toArray()\n                    ];\n\n                    if ($item->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE) {\n                        $agendas = $this->agenda_repositorio->getTodo(new Request([\n                            'proceso_id'         => $vacante->proceso->id,\n                            'evaluado_id'        => $item->usuario_id,\n                            'estado_id'          => EstadoAgenda::FINALIZADA_ID,\n                            'incluir_resultados' => true\n                        ]));\n\n                        $datos_etapas['pruebas_psicometricas'] = [];\n\n                        foreach ($agendas as $agenda) {\n                            array_push($datos_etapas['pruebas_psicometricas'], [\n                                'prueba'     => $agenda->prueba->nombre,\n                                'ajuste'     => $agenda->ajuste,\n                                'resultados' => $agenda->resultados->map(function ($resultado) {\n                                    return [\n                                        'dimension' => $resultado->dimension->nombre,\n                                        'puntaje'   => $resultado->puntaje_transformado\n                                    ];\n                                })->values()->toArray()\n                            ]);\n                        }\n\n                        if (count($datos_etapas['pruebas_psicometricas']) === 0) {\n                            unset($datos_etapas['pruebas_psicometricas']);\n                        }\n                    }\n\n                    array_push($usuario['etapas'], $datos_etapas);\n                }\n            }\n\n            array_push($candidatos_ia, $usuario);\n        }\n\n        return $this->realizarPeticionIA('obtener-candidatos-recomendados', [\n            'vacante_id' => $request->vacante_id,\n            'vacante'    => json_encode($vacante_ia, JSON_UNESCAPED_UNICODE),\n            'candidatos' => json_encode($candidatos_ia, JSON_UNESCAPED_UNICODE)\n        ]);\n    }\n\n    /**\n     * Obtener competencias por mejorar para usuario que será contratado.\n     * SOLO Buscar agendas de TenDisc Plus (12) y Potencial Comercial (7)\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return array\n     * @author Sergio Vargas\n     */\n    public function obtenerCompetenciasPorMejorar(int $id): array {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n        $usuario_id = $etapa_vacante_usuario->usuario_id;\n        $proceso = $etapa_vacante_usuario->vacante->proceso;\n\n        if (is_null($proceso)) {\n            return ['pruebas' => []];\n        }\n\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id' => $proceso->id,\n            'evaluado_id' => $usuario_id,\n            'pruebas_ids' => [12, 7],\n            'estado_id' => 3,\n            'con_evaluado' => true\n        ]));\n\n        $resultado = ['pruebas' => []];\n\n        foreach ($agendas as $agenda) {\n            $competencias_bajas = $this->extraerCompetenciasBajas($agenda);\n\n            if (!empty($competencias_bajas)) {\n                $resultado['pruebas'][] = [\n                    'prueba_id' => $agenda->prueba_id,\n                    'nombre_prueba' => $agenda->prueba->nombre,\n                    'competencias' => $competencias_bajas\n                ];\n            }\n        }\n\n        return $resultado;\n    }\n\n    /**\n     * Extraer las 2 competencias más bajas de una agenda según su prueba.\n     *\n     * @param \\App\\Models\\Agendas\\Agenda $agenda Agenda finalizada.\n     * @return array\n     * @author Sergio Vargas\n     */\n    private function extraerCompetenciasBajas($agenda): array {\n        $resultados = $this->resultado_agenda_servicio->gestionarResultados($agenda);\n\n        if (empty($resultados)) {\n            return [];\n        }\n\n        $competencias_todas = [];\n\n        // TenDisc Plus (prueba_id = 12)\n        if ($agenda->prueba_id === 12) {\n            $factor_especificas = collect($resultados)->firstWhere('nombre', 'Competencias Específicas');\n            $factor_transversales = collect($resultados)->firstWhere('nombre', 'Competencias Transversales');\n\n            if ($factor_especificas) {\n                $competencias_todas = array_merge($competencias_todas, $factor_especificas['dimensiones']);\n            }\n            if ($factor_transversales) {\n                $competencias_todas = array_merge($competencias_todas, $factor_transversales['dimensiones']);\n            }\n        }\n\n        // Potencial Comercial (prueba_id = 7)\n        if ($agenda->prueba_id === 7) {\n            $factor_caracter = collect($resultados)->firstWhere('nombre', 'Carácter');\n            $factor_habilidades = collect($resultados)->firstWhere('nombre', 'Habilidades');\n\n            if ($factor_caracter) {\n                $competencias_todas = array_merge($competencias_todas, $factor_caracter['dimensiones']);\n            }\n            if ($factor_habilidades) {\n                $competencias_todas = array_merge($competencias_todas, $factor_habilidades['dimensiones']);\n            }\n        }\n\n        // Ordenar por puntaje ascendente y tomar las 2 más bajas\n        return collect($competencias_todas)\n            ->sortBy('puntaje_transformado')\n            ->take(2)\n            ->map(fn($c) => [\n                'nombre' => $c['nombre'],\n                'puntaje' => round($c['puntaje_transformado'], 0)\n            ])\n            ->values()\n            ->toArray();\n    }\n}\n","numLines":1298,"startLine":1,"totalLines":1298}}}
{"parentUuid":"666538e6-b052-4215-812f-9cf95f5263fb","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T16:00:07.969Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015wsGdYTdzQjj9cBZ9M3TVF","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a modificar la función `guardarPuntajeAdecuacionReclutador` para agregar un parámetro booleano que permita omitir la validación `is_null($etapa_usuario->puntaje)` cuando sea necesario."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":24611,"cache_read_input_tokens":24401,"cache_creation":{"ephemeral_5m_input_tokens":24611,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvBvj6HwhWoXdHLH9hJL","uuid":"33f6b136-9a90-46cf-9bd6-db46732b85b2"}
{"parentUuid":"33f6b136-9a90-46cf-9bd6-db46732b85b2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T16:00:15.441Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015wsGdYTdzQjj9cBZ9M3TVF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PSgK8NLLjC9xtMQz72hxxV","name":"Edit","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","old_string":"    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {","new_string":"    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @param bool $forzar_actualizacion Si es true, omite la validación de puntaje nulo.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":24611,"cache_read_input_tokens":24401,"cache_creation":{"ephemeral_5m_input_tokens":24611,"ephemeral_1h_input_tokens":0},"output_tokens":642,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvBvj6HwhWoXdHLH9hJL","uuid":"17547fb8-8b05-4a9d-b225-2aed7bcace48"}
{"parentUuid":"17547fb8-8b05-4a9d-b225-2aed7bcace48","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PSgK8NLLjC9xtMQz72hxxV","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   526→            }\n   527→        }\n   528→    }\n   529→\n   530→    /**\n   531→     * Guardar el puntaje de adecuación dado por el reclutador.\n   532→     *\n   533→     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n   534→     *\n   535→     * @param int $id ID de la etapa del usuario en la vacante.\n   536→     * @param int $puntaje Puntaje dado por el reclutador.\n   537→     * @param bool $forzar_actualizacion Si es true, omite la validación de puntaje nulo.\n   538→     * @return void\n   539→     * @author Daniel Beltrán\n   540→     */\n   541→    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {\n   542→        $etapa_usuario = $this->repositorio->getUno($id);\n   543→\n   544→        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {\n   545→            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n   546→                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n   547→            }\n   548→"}]},"uuid":"c2823f45-6a19-41ad-8f05-4451295ec1c8","timestamp":"2026-01-08T16:01:40.666Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","oldString":"    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {","newString":"    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @param bool $forzar_actualizacion Si es true, omite la validación de puntaje nulo.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Vacantes;\n\nuse App\\Traits\\IATrait;\nuse App\\Traits\\StringTrait;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Vacantes\\Vacante;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Agendas\\EstadoAgenda;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Support\\Facades\\Mail;\nuse App\\Models\\Vacantes\\EtapaVacante;\nuse App\\Models\\Vacantes\\EstadoVacante;\nuse App\\Models\\Vacantes\\MovimientoVacante;\nuse App\\Mail\\NotificarFinalizacionEtapaMail;\nuse App\\Mail\\NotificarPostulanteVacanteMail;\nuse App\\Models\\Vacantes\\EtapaVacanteUsuario;\nuse Illuminate\\Http\\Client\\RequestException;\nuse App\\Http\\Services\\Vacantes\\VacanteService;\nuse App\\Models\\Configuraciones\\PlantillaCorreo;\nuse Illuminate\\Http\\Client\\ConnectionException;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Services\\Usuarios\\TokenAccesoService;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Services\\Vacantes\\EtapaVacanteService;\nuse App\\Jobs\\Vacantes\\ProcesarVideoentrevistaIAJob;\nuse App\\Http\\Repositories\\Procesos\\ProcesoRepository;\nuse App\\Http\\Repositories\\Vacantes\\VacanteRepository;\nuse App\\Http\\Services\\Agendas\\ResultadoAgendaService;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse App\\Notifications\\NotificarAvanceProcesoNotification;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteRepository;\nuse App\\Http\\Repositories\\Vacantes\\TranscripcionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Vacantes\\AspectoPuntajeRepository;\nuse App\\Http\\Services\\Configuraciones\\PlantillaCorreoService;\nuse App\\Http\\Repositories\\Vacantes\\FormatoEntrevistaRepository;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteUsuarioRepository;\nuse App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\nuse App\\Http\\Repositories\\Vacantes\\EtapaMovimientoVacanteRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PreguntaOfertaLaboralRepository;\nuse App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PuntajePreguntaOfertaLaboralRepository;\n\n/**\n * @property EtapaVacanteUsuarioRepository $repositorio\n */\nclass EtapaVacanteUsuarioService extends BaseService\n{\n    use ArchivoTrait, IATrait, StringTrait;\n\n    /**\n     * @var float|int $puntaje_total Puntaje total, utilizado para la adecuación de HV.\n     */\n    private $puntaje_total = 0;\n\n    /**\n     * @var float $puntaje Puntaje de aspecto, utilizado para la adecuación de HV.\n     */\n    private $puntaje = 0;\n\n    /**\n     * @var bool $cumple Indica si cumple con el aspecto, utilizada para la adecuación de HV.\n     */\n    private $cumple = false;\n\n    /**\n     * Constructor.\n     *\n     * @param EtapaVacanteUsuarioRepository $repositorio Repositorio de etapas de vacantes de usuarios.\n     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n     * @param EtapaVacanteRepository $etapa_vacante_repositorio Repositorio de etapas de vacantes.\n     * @param AspectoPuntajeRepository $aspecto_puntaje_repositorio Repositorio de puntajes de aspectos.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio Repositorio de preguntas de ofertas laborales.\n     * @param PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio Repositorio de puntajes de preguntas de ofertas laborales.\n     * @param EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio Repositorio de movimientos de etapas de vacantes.\n     * @param ProcesoRepository $proceso_repositorio Repositorio de procesos.\n     * @param TranscripcionRepository $transcripcion_repositorio Repositorio de transcripciones.\n     * @param PlantillaCorreoService $plantilla_correo_servicio Servicio de plantillas de correo.\n     * @param TokenAccesoService $token_acceso_servicio Servicio de tokens de acceso.\n     * @param UserRepository $usuario_repositorio Servicio de usuarios.\n     * @param VacanteRepository $vacante_repositorio Repositorio de vacantes.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param ResultadoAgendaService $resultado_agenda_servicio Servicio de resultados de agendas.\n     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n     * @param FormatoEntrevistaRepository $formato_entrevista_repositorio Repositorio de formatos de entrevista.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function __construct(\n        EtapaVacanteUsuarioRepository $repositorio,\n        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n        protected EtapaVacanteRepository $etapa_vacante_repositorio,\n        protected AspectoPuntajeRepository $aspecto_puntaje_repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio,\n        protected PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio,\n        protected EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio,\n        protected ProcesoRepository $proceso_repositorio,\n        protected TranscripcionRepository $transcripcion_repositorio,\n        protected PlantillaCorreoService $plantilla_correo_servicio,\n        protected TokenAccesoService $token_acceso_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected VacanteRepository $vacante_repositorio,\n        protected AgendaRepository $agenda_repositorio,\n        protected ResultadoAgendaService $resultado_agenda_servicio,\n        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n        protected FormatoEntrevistaRepository $formato_entrevista_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar documento solicitado de una etapa de vacante de usuario.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function guardarDocumentoSolicitado(Request $request): void {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n        if ($request->hasFile('archivo')) {\n            $this->archivo_servicio->guardarVarios(EtapaVacanteUsuario::class, $request->etapa_vacante_usuario_id, [$request->nombre_documento => $request->file('archivo')], 'empresas/' . $empresa->id . '/documentos-solicitados', true);\n        }\n    }\n\n    /**\n     * Establecer valores para puntaje y cumplimiento de un aspecto.\n     *\n     * @param float $puntaje Puntaje obtenido.\n     * @param bool $cumple Indica si cumple.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function establecerPuntajeCumplimiento(float $puntaje = 0, bool $cumple = false): void {\n        $this->puntaje = $puntaje;\n        $this->cumple  = $cumple;\n    }\n\n    /**\n     * Guardar puntaje de un aspecto evaluado.\n     *\n     * @param int $etapa_vacante_usuario_id ID de la etapa del usuario en la vacante.\n     * @param string $categoria Categoría del aspecto.\n     * @param string $aspecto Aspecto evaluado.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function guardarAspectoPuntaje(int $etapa_vacante_usuario_id, string $categoria, string $aspecto): void {\n        $this->aspecto_puntaje_repositorio->crearOActualizar([\n            'etapa_vacante_usuario_id' => $etapa_vacante_usuario_id,\n            'categoria'                => $categoria,\n            'aspecto'                  => $aspecto\n        ], [\n            'puntaje'                  => $this->puntaje,\n            'cumple'                   => $this->cumple\n        ]);\n\n        $this->puntaje_total += $this->puntaje;\n        $this->establecerPuntajeCumplimiento();\n    }\n\n    /**\n     * Generar adecuación de hoja de vida.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionHV(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::REVISION_HV_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $perfil_laboral = $this->perfil_laboral_repositorio->getUnoAvanzado(new Request([\n                'usuario_id'                     => $etapa_usuario->usuario_id,\n                'incluir_experiencias_laborales' => true,\n                'incluir_estudios'               => true,\n                'incluir_idiomas'                => true,\n                'incluir_usuario'                => true\n            ]));\n\n            // Generar y guardar la adecuación del perfil de candidato (habilidades y herramientas tecnológicas)\n            $categoria            = 'perfil';\n            $puntaje_aspecto      = 100 / 2;\n            $datos_vacante        = $etapa_usuario->vacante->datos;\n            $habilidades_vacante  = $datos_vacante->where('llave', 'habilidades')->first();\n            $herramientas_vacante = $datos_vacante->where('llave', 'herramientas_tecnologicas')->first();\n\n            // Validar coincidencia para las habilidades\n            if (!is_null($habilidades_vacante->valor) && !empty($habilidades_vacante->valor)) {\n                $habilidades_vacante        = array_map(fn($item) => trim($item), explode(',', $habilidades_vacante->valor));\n                $habilidades_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->habilidades));\n                $coincidencias              = count(array_uintersect($habilidades_vacante, $habilidades_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($habilidades_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'habilidades');\n\n            // Validar coincidencia para las herramientas tecnológicas\n            if (!is_null($herramientas_vacante->valor) && !empty($herramientas_vacante->valor)) {\n                $herramientas_vacante        = array_map(fn($item) => trim($item), explode(',', $herramientas_vacante->valor));\n                $herramientas_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->herramientas_tecnologicas));\n                $coincidencias               = count(array_uintersect($herramientas_vacante, $herramientas_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($herramientas_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'herramientas');\n\n            // Generar y guardar la adecuación de requisitos del candidato (género, edad, nivel educativo, modalidad de trabajo, salario, experiencia, idiomas, licencia de conducir)\n            $categoria       = 'requisito';\n            $puntaje_aspecto = 100 / 8;\n\n            // Validar coincidencia de género\n            $genero_vacante = $datos_vacante->where('llave', 'genero')->first();\n\n            if (!is_null($genero_vacante) && !empty($genero_vacante)) {\n                if ($genero_vacante->valor === mb_convert_case($perfil_laboral->usuario->genero->nombre, MB_CASE_LOWER)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                } elseif ($genero_vacante->valor === 'indiferente') {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'genero');\n\n            // Validar coincidencia de edad\n            $edad_minima_vacante = $datos_vacante->where('llave', 'edad_minima')->first();\n            $edad_maxima_vacante = $datos_vacante->where('llave', 'edad_maxima')->first();\n\n            if (empty($edad_minima_vacante->valor) || empty($edad_maxima_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($perfil_laboral->usuario->edad >= $edad_minima_vacante->valor && $perfil_laboral->usuario->edad <= $edad_maxima_vacante->valor) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'edad');\n\n            // Validar coincidencia de nivel educativo\n            $nivel_educativo_vacante = $datos_vacante->where('llave', 'nivel_educativo')->first();\n            $escala_estudios         = [\n                'Preescolar'                      => 1,\n                'Primaria'                        => 2,\n                'Secundaria básica'               => 3,\n                'Secundaria superior'             => 4,\n                'Educación continua y permanente' => 5,\n                'Técnico'                         => 6,\n                'Tecnólogo'                       => 7,\n                'Profesional'                     => 8,\n                'Especialización (postgrado)'     => 9,\n                'Maestría (postgrado)'            => 10,\n                'Doctorado (postgrado)'           => 11\n            ];\n\n            if (empty($nivel_educativo_vacante->valor) || $nivel_educativo_vacante->valor === 'indiferente') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (count($perfil_laboral->estudios) > 0) {\n                $cumple_nivel_educativo = false;\n\n                foreach ($perfil_laboral->estudios as $estudio) {\n                    if ($escala_estudios[$nivel_educativo_vacante->valor] <= $escala_estudios[$estudio->nivelEducativo->nombre]) {\n                        $cumple_nivel_educativo = true;\n                        break;\n                    }\n                }\n\n                if ($cumple_nivel_educativo) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'estudios');\n\n            // Validar coincidencia de modalidad de trabajo\n            if (!is_null($etapa_usuario->vacante->modalidad_trabajo_id)) {\n                if ($etapa_usuario->vacante->modalidad_trabajo_id === $perfil_laboral->modalidad_trabajo_id) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'modalidad_trabajo');\n\n            // Validar coincidencia de salario\n            if (is_null($etapa_usuario->vacante->salario)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (!is_null($etapa_usuario->vacante->salario) && is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Salario fijo\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario de la vacante es fijo pero el del usuario es rango\n                    if (($etapa_usuario->vacante->salario >= $perfil_laboral->salario && $etapa_usuario->vacante->salario <= $perfil_laboral->salario_maximo) || ($perfil_laboral->salario <= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } elseif ($perfil_laboral->salario <= $etapa_usuario->vacante->salario) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (!is_null($etapa_usuario->vacante->salario) && !is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Rango de salario\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario del usuario y de la vacante son rangos\n                    if (($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) || ($perfil_laboral->salario_maximo >= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario_maximo)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } else {\n                    if ($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'salario');\n\n            // Validar coincidencia de experiencia\n            $experiencia_vacante   = $datos_vacante->where('llave', 'experiencia_laboral')->first();\n            $experiencia_aplicante = $perfil_laboral->experienciasLaborales->sum('tiempo');\n            $experiencias          = [\n                '1 año'        => 1,\n                '2 años'       => 2,\n                '3 años'       => 3,\n                '4 años'       => 4,\n                '5 años o más' => 5\n            ];\n\n            if (empty($experiencia_vacante->valor) || $experiencia_vacante->valor === 'Sin experiencia') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($experiencia_vacante->valor === 'Menos de 1 año') {\n                if ($experiencia_aplicante > 0 && $experiencia_aplicante < 365) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (($experiencias[$experiencia_vacante->valor] * 365) <= $experiencia_aplicante) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'experiencia');\n\n            // Validar coincidencia de idiomas\n            $idiomas_vacante = $etapa_usuario->vacante->idiomas;\n            $escala_idiomas  = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'C1' => 5,\n                'C2' => 6\n            ];\n\n            if ($idiomas_vacante->count() > 0) {\n                $coincidencias_idiomas = 0;\n\n                if ($perfil_laboral->idiomas->count() > 0) {\n                    foreach ($idiomas_vacante as $idioma) {\n                        foreach ($perfil_laboral->idiomas as $idioma_perfil) {\n                            if ($idioma->idioma_id === $idioma_perfil->idioma_id && $escala_idiomas[$idioma->nivel] <= $escala_idiomas[$idioma_perfil->nivel]) {\n                                $coincidencias_idiomas++;\n                            }\n                        }\n                    }\n                }\n\n                if ($coincidencias_idiomas >= $idiomas_vacante->count()) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'idiomas');\n\n            // Validar coincidencia de licencia de conducir\n            $licencia_conducir_vacante = $datos_vacante->where('llave', 'licencia_conducir')->first();\n            $escala_licencias          = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'B3' => 5,\n                'C1' => 6,\n                'C2' => 7,\n                'C3' => 8\n            ];\n\n            if (empty($licencia_conducir_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (is_null($perfil_laboral->licencia_conducir)) {\n                if (empty($licencia_conducir_vacante->valor)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif ($escala_licencias[$licencia_conducir_vacante->valor] <= $escala_licencias[$perfil_laboral->licencia_conducir]) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'licencia_conducir');\n\n            $puntaje_total = round($this->puntaje_total / 2); // Se divide entre las dos categorías existentes\n            $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::REVISION_HV_ID, $puntaje_total, 'descartar_candidatos_adecuaciones_bajas_hv', 'descartar_candidatos_adecuaciones_medias_hv');\n        }\n    }\n\n    /**\n     * Generar adecuación para preguntas prefiltro.\n     *\n     * Califica las respuestas del aplicante en cada una de las preguntas y calcula la adecuación en base a sus resultados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPrefiltro(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'   => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'         => $etapa_usuario->usuario_id,\n                'incluir_respuestas' => true\n            ]));\n\n            $porcentaje_pregunta  = 100 / $preguntas->count();\n            $respuestas_correctas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                $puntaje    = null;\n                $puntaje_ia = null;\n\n                if ($pregunta->es_abierta) {\n                    $respuesta = $opcion_seleccionada = $pregunta->respuestas->first();\n\n                    if (!is_null($respuesta)) {\n                        try {\n                            $peticion_ia = $this->realizarPeticionIA(\n                                ruta: 'calificar-pregunta-abierta',\n                                parametros: [\n                                    'pregunta'  => $pregunta->enunciado,\n                                    'respuesta' => $respuesta->respuesta,\n                                ],\n                                contexto_tracking: [\n                                    'vacante_id' => $etapa_usuario->etapa->vacante_id ?? null,\n                                    'agenda_id' => null,\n                                ]\n                            );\n\n                            if (!is_null($peticion_ia) && $peticion_ia['status_code'] === 200) {\n                                $puntaje_ia = $peticion_ia['calificacion'];\n                            }\n                        } catch (RequestException|ConnectionException $error) {}\n                    }\n                } else {\n                    $opciones_correctas = $pregunta->opciones->where('es_correcta', true);\n\n                    // Selección única\n                    if ($opciones_correctas->count() === 1) {\n                        $opcion_correcta     = $opciones_correctas->first();\n                        $opcion_seleccionada = $pregunta->respuestas->first();\n                        $puntaje             = (int) (!is_null($opcion_seleccionada) && $opcion_correcta->id === $opcion_seleccionada->opcion_pregunta_id);\n                    } else { // Selección múltiple\n                        $opciones_correctas     = $opciones_correctas->pluck('id')->toArray();\n                        $opciones_seleccionadas = $pregunta->respuestas->pluck('opcion_pregunta_id')->toArray();\n                        $aciertos               = count(array_intersect($opciones_seleccionadas, $opciones_correctas));\n                        $fallos                 = count(array_diff($opciones_seleccionadas, $opciones_correctas));\n                        $puntaje                = (int) ($aciertos - $fallos === count($opciones_correctas));\n                    }\n                }\n\n                // Guardar el puntaje obtenido en cada pregunta\n                $this->puntaje_pregunta_oferta_laboral_repositorio->crearSiNoExiste([\n                    'pregunta_id' => $pregunta->id,\n                    'usuario_id'  => $etapa_usuario->usuario_id\n                ], [\n                    'puntaje'     => $puntaje,\n                    'puntaje_ia'  => $puntaje_ia\n                ]);\n\n                // Sumar el puntaje total\n                if (is_null($puntaje) && !is_null($puntaje_ia)) {\n                    $respuestas_correctas += $puntaje_ia;\n                } else {\n                    $respuestas_correctas += $puntaje;\n                }\n            }\n\n            $puntaje_etapa = $respuestas_correctas * $porcentaje_pregunta;\n\n            if ($etapa_usuario->vacante->automatizar_etapas) {\n                // Obtener el movimiento de la etapa con sus configuraciones\n                $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                    'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                    'movimiento_vacante_id'   => MovimientoVacante::PREGUNTAS_PREFILTRO_ID,\n                    'incluir_configuraciones' => true\n                ]));\n\n                $configuracion_preguntas_correctas = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', 'descartar_candidatos_respondieron_menos_preguntas_prefiltro')->first();\n\n                // Avanzar al aplicante de etapa o descartarlo según la configuración de la etapa\n                if (!is_null($configuracion_preguntas_correctas) && $configuracion_preguntas_correctas->valor <= $respuestas_correctas) {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa);\n                } else {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa, descartar: true);\n                }\n            } else {\n                $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_etapa]);\n            }\n        }\n    }\n\n    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n            }\n\n            if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::VIDEO_ENTREVISTA_NOMBRE, EtapaVacante::ENTREVISTA_NOMBRE])) {\n                if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE) {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_videoentrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_videoentrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_videoentrevista';\n                } else {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n                }\n\n                if ($this->verificarFormatoEntrevista($etapa_usuario, $movimiento_vacante_id, $llave_configuracion_formato)) {\n                    $this->gestionarContinuidadAplicante($etapa_usuario, $movimiento_vacante_id, $puntaje, $llave_configuracion_adecuaciones_bajas, $llave_configuracion_adecuaciones_medias);\n                } else {\n                    $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n                }\n\n                // TODO: Invocar esta función al momento de completar el formato de entrevista\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para pruebas psicométricas.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPruebasPsicometricas(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $indice_talento = $this->proceso_repositorio->obtenerIndiceTalento($etapa_usuario->vacante->proceso->id, $etapa_usuario->usuario_id)->indice_talento;\n\n            if ($indice_talento >= 0) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBAS_PSICOMETRICAS_ID, $indice_talento, 'descartar_candidatos_puntuaciones_bajas', 'descartar_candidatos_puntuaciones_medias', true);\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para videoentrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function generarAdecuacionVideoentrevista(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje_ia)) {\n            ProcesarVideoentrevistaIAJob::dispatch($etapa_usuario);\n        }\n    }\n\n    /**\n     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n     * @author Daniel Beltrán\n     */\n    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n        $formato_diligenciado = false;\n        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n            'movimiento_vacante_id'   => $movimiento_vacante_id,\n            'incluir_configuraciones' => true\n        ]));\n\n        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n        } else {\n            $formato_diligenciado = true;\n        }\n\n        return $formato_diligenciado;\n    }\n\n    /**\n     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n     *\n     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n     * @param int $usuario_id ID del usuario (aplicante).\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id' => $etapa_vacante_id,\n            'usuario_id'       => $usuario_id\n        ]));\n\n        if ($etapa_usuario->activo) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id' => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'       => $etapa_usuario->usuario_id,\n                'incluir_puntajes' => true\n            ]));\n\n            $puntaje            = 0;\n            $puntaje_individual = 100 / $preguntas->count();\n\n            foreach ($preguntas as $pregunta) {\n                if (is_null($pregunta->puntajes[0]->puntaje) && !is_null($pregunta->puntajes[0]->puntaje_ia)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje_ia;\n                } elseif (!is_null($pregunta->puntajes[0]->puntaje)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje;\n                }\n            }\n\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_individual * $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar el puntaje de la etapa actual y gestionar la continuidad del aplicante en la vacante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param int $puntaje Puntaje obtenido en la etapa actual.\n     * @param string $llave_puntajes_bajos Llave de configuración para puntajes bajos.\n     * @param string $llave_puntajes_medios Llave de configuración para puntajes medios.\n     * @param bool $escala_pruebas_psicometricas Indica si debe utilizar la escala de puntajes de pruebas psicométricas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function gestionarContinuidadAplicante(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, int $puntaje, string $llave_puntajes_bajos, string $llave_puntajes_medios, bool $escala_pruebas_psicometricas = false) {\n        if ($etapa_usuario->vacante->automatizar_etapas) {\n            $calificacion_baja  = 40;\n            $calificacion_media = 70;\n\n            if ($escala_pruebas_psicometricas) {\n                $calificacion_baja  = 59;\n                $calificacion_media = 75;\n            }\n\n            // Obtener el movimiento de la etapa con sus configuraciones\n            $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                'movimiento_vacante_id'   => $movimiento_vacante_id,\n                'incluir_configuraciones' => true\n            ]));\n\n            $configuracion_adecuaciones_bajas  = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_bajos)->first();\n            $configuracion_adecuaciones_medias = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_medios)->first();\n\n            if (!is_null($configuracion_adecuaciones_medias) && filter_var($configuracion_adecuaciones_medias->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_media) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            } elseif (!is_null($configuracion_adecuaciones_bajas) && filter_var($configuracion_adecuaciones_bajas->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_baja) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            }\n\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje);\n        } else {\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar puntaje de la etapa actual y mover al aplicante a la siguiente etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param ?int $puntaje Puntaje obtenido en la etapa actual.\n     * @param ?int $puntaje_ia Puntaje obtenido por la IA en la etapa actual.\n     * @param ?string $notas_ia Notas dadas por la IA para la etapa actual.\n     * @param bool $descartar Indica si la etapa a la que se debe cambiar es 'descartados'.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function guardarPuntajeYCambiarDeEtapa(EtapaVacanteUsuario $etapa_usuario, ?int $puntaje = null, ?int $puntaje_ia = null, ?string $notas_ia = null, bool $descartar = false): void {\n        if ($descartar) {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->getUnoAvanzado(new Request(['vacante_id' => $etapa_usuario->vacante->id, 'nombre' => EtapaVacante::DESCARTADOS_NOMBRE]));\n        } else {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->obtenerEtapaSiguiente($etapa_usuario->vacante->id, $etapa_usuario->etapa->orden);\n        }\n\n        $etapa_actual_activa = true;\n\n        if ($etapa_siguiente->nombre !== EtapaVacante::CONTRATADOS_NOMBRE) {\n            $etapa_actual_activa = false;\n            $nueva_etapa_usuario = $this->repositorio->crear([\n                'usuario_id'       => $etapa_usuario->usuario_id,\n                'etapa_vacante_id' => $etapa_siguiente->id,\n                'activo'           => true\n            ]);\n\n            // Crear agendas de pruebas psicométricas si la etapa siguiente son pruebas psicométricas.\n            app(VacanteService::class)->crearAgendasPruebasPsicometricas($etapa_usuario, $etapa_siguiente->id);\n\n            if ($nueva_etapa_usuario) {\n                $this->notificarCambioEtapa($nueva_etapa_usuario);\n            }\n        }\n\n        $this->repositorio->actualizar($etapa_usuario->id, [\n            'puntaje'    => $puntaje,\n            'puntaje_ia' => $puntaje_ia,\n            'notas_ia'   => $notas_ia,\n            'activo'     => $etapa_actual_activa\n        ]);\n\n        // Cuando la etapa es contratado, se valida si ya se han completado las vacantes requeridas para cerrar la vacante\n        if ($etapa_siguiente->nombre === EtapaVacante::CONTRATADOS_NOMBRE) {\n            if ($etapa_usuario->vacante->cantidad_vacantes === $this->repositorio->contarContratados($etapa_usuario->etapa->vacante_id)) {\n                $this->vacante_repositorio->actualizar($etapa_usuario->etapa->vacante_id, ['estado_id' => EstadoVacante::COMPLETADA_ID]);\n\n                $aplicantes_activos_restantes_ids = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'excluir_etapas'         => [EtapaVacante::DESCARTADOS_NOMBRE, EtapaVacante::CONTRATADOS_NOMBRE]\n                ]))->pluck('id')->toArray();\n\n                // Descartar a los aplicantes que quedan activos en la vacante\n                $this->descartarAplicantesManual($aplicantes_activos_restantes_ids);\n\n                $aplicantes_activos_sin_notificar = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'sin_fecha_notificacion' => true\n                ]));\n\n                foreach ($aplicantes_activos_sin_notificar as $aplicante) {\n                    $this->notificarCambioEtapa($aplicante, false);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener la adecuación actual del usuario en la vacante.\n     *\n     * @param int $usuario_id ID del usuario.\n     * @param int $vacante_id ID de la vacante.\n     * @return ?int\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function obtenerAdecuacionUsuario(int $usuario_id, int $vacante_id): ?int {\n        $etapas     = $this->repositorio->obtenerEtapasCompletadasUsuario($usuario_id, $vacante_id);\n        $adecuacion = 0;\n\n        foreach ($etapas as $etapa) {\n            if (!is_null($etapa->puntaje)) {\n                $adecuacion += $etapa->puntaje;\n            } elseif (is_null($etapa->puntaje) && !is_null($etapa->puntaje_ia)) {\n                $adecuacion += $etapa->puntaje_ia;\n            }\n        }\n\n        return ($etapas->count() > 0) ? $adecuacion / $etapas->count() : null;\n    }\n\n    /**\n     * Verificar si una etapa ya ha sido completada por el aplicante.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante (etapa_vacante_usuario_id).\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function verificarEtapaCompletada(int $id): bool {\n        $etapa_usuario    = $this->repositorio->getUno($id);\n        $etapa_completada = false;\n\n        // Verificar si la etapa de revisión de hoja de vida ya fue completada\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::REVISION_HV_NOMBRE, EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE]) && !is_null($etapa_usuario->puntaje) || !is_null($etapa_usuario->puntaje_ia)) {\n            $etapa_completada = true;\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::ENTREVISTA_NOMBRE) {\n            if ($this->configuracion_modelo_servicio->obtenerValorLlaveConfiguracion(app(VacanteService::class)->obtenerConfiguracionesEtapaAplicante($etapa_usuario->etapa_vacante_id), 'solicitar_formato_entrevista')) {\n                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n\n                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n                    $etapa_completada = true;\n                }\n            } else {\n                $etapa_completada = true;\n            }\n        }\n\n        // Verificar si las etapas de preguntas prefiltro o videoentrevista ya han sido completadas\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE])) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'                      => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'                            => $etapa_usuario->usuario_id,\n                'incluir_cantidad_respuestas_aplicante' => true\n            ]));\n\n            $preguntas_contestadas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                if ($pregunta['respuestas_count'] > 0) {\n                    $preguntas_contestadas++;\n                }\n            }\n\n            // Validar que todas las preguntas hayan sido contestadas\n            if (count($preguntas) === $preguntas_contestadas) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n            if ((!is_null($etapa_usuario->pruebaTecnica?->enlace) && !empty($etapa_usuario->pruebaTecnica?->enlace) || $etapa_usuario->pruebaTecnica?->archivos->count() > 0) && $etapa_usuario->pruebaTecnica?->borrador == false) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE) {\n            $documentos_contratacion = app(EtapaVacanteService::class)->obtenerDocumentosContratacion(\n                $etapa_usuario->etapa_vacante_id,\n                new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id])\n            );\n\n            $documentos_solicitados     = collect($documentos_contratacion['documentos']);\n            $archivos_guardados         = collect($documentos_contratacion['archivos_guardados']);\n            $archivos_guardados_nombres = $archivos_guardados->pluck('nombre')->toArray();\n\n            $todos_cargados = true;\n            foreach ($documentos_solicitados as $documento) {\n                $nombre_normalizado = $this->normalizarNombreDocumento($documento['nombre']);\n\n                if (!in_array($nombre_normalizado, $archivos_guardados_nombres)) {\n                    $todos_cargados = false;\n                    break;\n                }\n            }\n\n            if ($todos_cargados && $documentos_solicitados->count() > 0) {\n                $etapa_completada = true;\n            }\n        }\n\n        return $etapa_completada;\n    }\n\n    /**\n     * Notificar documentos solicitados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function notificarDocumentosSolicitados(int $id): void {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_vacante_usuario) {\n            $this->enviarCorreoFinalizacionEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->vacante);\n        }\n    }\n\n    /**\n     * Descartar uno o varios aplicantes manualmente y moverlos a la etapa de descartados.\n     *\n     * @param array $ids IDs de las etapas de usuarios en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function descartarAplicantesManual(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n            if ($etapa_vacante_usuario) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n            }\n        }\n    }\n\n    /**\n     * Revertir descarte de aplicantes.\n     *\n     * @param array $ids IDs de las etapas de los usuarios descartados en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function revertirDescarteAplicantes(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_descartado = $this->repositorio->getUno($id);\n\n            if ($etapa_descartado && $etapa_descartado->etapa->nombre === EtapaVacante::DESCARTADOS_NOMBRE && $etapa_descartado->activo) {\n                $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $etapa_descartado->vacante->id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n                $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n                $etapa_previa          = $this->repositorio->obtenerEtapaPrevia($etapa_descartado->usuario_id, $etapas_ids);\n\n                if ($etapa_previa) {\n                    $this->repositorio->eliminar($etapa_descartado->id);\n                    $this->repositorio->actualizar($etapa_previa->id, ['activo' => true]);\n                }\n            }\n        }\n    }\n\n    /**\n     * Mover manualmente al aplicante a la siguiente etapa.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function moverAplicanteEtapaManual(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n        $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $etapa_usuario->puntaje ?? 0);\n    }\n\n    /**\n     * Marcar la vacante como abandonada por el aplicante.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function abandonarVacante(Request $request): void {\n        $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $request->vacante_id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n        $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n        $etapa_vacante_usuario = $this->repositorio->obtenerEtapaPrevia($request->usuario_id, $etapas_ids);\n\n        if ($etapa_vacante_usuario) {\n            $this->repositorio->actualizar($etapa_vacante_usuario->id, ['motivo_abandono' => $request->motivo_abandono]);\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n        }\n    }\n\n    /**\n     * Notificar al aplicante sobre el cambio de etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param bool $aplicar_validacion_fin_proceso Indica si se debe aplicar la validación de fin de proceso.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function notificarCambioEtapa(EtapaVacanteUsuario $etapa_usuario, bool $aplicar_validacion_fin_proceso = true): void {\n        $etapa_usuario->load(['etapa', 'vacante', 'usuario']);\n        $etapa = $etapa_usuario->etapa;\n\n        $plantilla_correo_id = [\n            EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE     => PlantillaCorreo::PREGUNTAS_PRE_FILTRO_ID,\n            EtapaVacante::PRUEBA_TECNICA_NOMBRE          => PlantillaCorreo::ENVIO_PRUEBA_TECNICA_ID,\n            EtapaVacante::VIDEO_ENTREVISTA_NOMBRE        => PlantillaCorreo::SOLICITUD_VIDEOENTREVISTAS_ID,\n            EtapaVacante::ENTREVISTA_NOMBRE              => PlantillaCorreo::NOTIFICACION_ENTREVISTA_ID,\n            EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE => PlantillaCorreo::SOLICITUD_DOCUMENTOS_ID,\n            EtapaVacante::CONTRATADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_CONTRATADOS_ID,\n            EtapaVacante::DESCARTADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_DESCARTADOS_ID\n        ][$etapa->nombre] ?? null;\n\n        if (isset($plantilla_correo_id)) {\n            $plantilla_correo_etapa = $this->plantilla_correo_servicio->obtenerUno(new Request([\n                'plantilla_correo_id' => $plantilla_correo_id,\n                'empresa_id'          => $etapa_usuario->vacante->empresa_id\n            ]));\n\n            if (!is_null($plantilla_correo_etapa)) {\n                $es_etapa_fin_proceso = in_array($etapa->nombre, [\n                    EtapaVacante::CONTRATADOS_NOMBRE,\n                    EtapaVacante::DESCARTADOS_NOMBRE\n                ]);\n\n                // Si es etapa de fin de proceso y notificar_fin_proceso es true, no enviar notificación\n                if ($aplicar_validacion_fin_proceso && $es_etapa_fin_proceso && $plantilla_correo_etapa->notificar_fin_proceso) {\n                    return;\n                }\n\n                $usuario            = $etapa_usuario->usuario;\n                $vacante            = $etapa_usuario->vacante;\n                $token_acceso       = $this->token_acceso_servicio->generar($usuario->id);\n                $enlace             = request()->getSchemeAndHttpHost() . \"/control-acceso/{$token_acceso->token}?vacante_id={$vacante->id}\";\n                $usuario_informador = null;\n\n                Mail::to($usuario->email)->queue(new NotificarPostulanteVacanteMail(\n                    $usuario,\n                    $enlace,\n                    $vacante,\n                    $plantilla_correo_etapa->titulo,\n                    $plantilla_correo_etapa->contenido,\n                    $plantilla_correo_etapa->con_logo_empresa,\n                    $etapa->nombre,\n                    $usuario_informador\n                ));\n\n                // Enviar notificación de avance en el proceso\n                $usuario->notify(new NotificarAvanceProcesoNotification(\n                    $vacante->id,\n                    $vacante->nombre_vacante,\n                    $etapa->nombre,\n                    $vacante->empresa->nombre ?? 'la empresa'\n                ));\n\n                $this->repositorio->actualizar($etapa_usuario->id, ['fecha_notificacion' => now()]);\n            }\n        }\n    }\n\n    /**\n     * Enviar correo de notificación al finalizar una etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_vacante_usuario Etapa del usuario en la vacante.\n     * @param Vacante $vacante Vacante.\n     * @return void\n     * @author Jair Carvajal\n     */\n    private function enviarCorreoFinalizacionEtapa(EtapaVacanteUsuario $etapa_vacante_usuario, Vacante $vacante): void {\n        $usuario     = Auth::user();\n        $maneja_logo = file_exists(public_path('empresas-logo/' . $vacante->empresa->id)) ? '1' : null;\n\n        Mail::send(new NotificarFinalizacionEtapaMail(\n            $usuario,\n            $vacante,\n            $etapa_vacante_usuario->etapa,\n            $maneja_logo\n        ));\n    }\n\n    /**\n     * Obtener candidatos recomendados con IA.\n     *\n     * Obtiene los 3 mejores candidatos para la vacante, entre varios candidatos seleccionados por el reclutador.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function obtenerCandidatosRecomendadosIA(Request $request): array {\n        $vacante       = $this->vacante_repositorio->getUno($request->vacante_id);\n        $candidatos    = $this->usuario_repositorio->obtenerCandidatosSeleccionadosVacante($request->usuarios_ids, $request->vacante_id);\n        $candidatos_ia = [];\n        $vacante_ia    = [\n            ...Arr::only($vacante->toArray(), ['nombre_vacante', 'salario', 'salario_maximo']),\n            'habilidades'               => $vacante->datos->first(fn($item) => $item->llave === 'habilidades')->valor,\n            'herramientas_tecnologicas' => $vacante->datos->first(fn($item) => $item->llave === 'herramientas_tecnologicas')->valor,\n            'experiencia_laboral'       => $vacante->datos->first(fn($item) => $item->llave === 'experiencia_laboral')->valor,\n            'nivel_educativo'           => $vacante->datos->first(fn($item) => $item->llave === 'nivel_educativo')->valor\n        ];\n\n        if (!is_null($vacante->ciudad_id)) {\n            $direccion_trabajo = $vacante->datos->first(fn($item) => $item->llave === 'direccion_trabajo')->valor;\n            $ubicacion_empresa = \"{$vacante->ciudad->departamento->pais->nombre}, {$vacante->ciudad->departamento->nombre} - {$vacante->ciudad->nombre}, {$direccion_trabajo}\";\n        } elseif (!is_null($vacante->empresa->ciudad_id)) {\n            $ubicacion_empresa = \"{$vacante->empresa->ciudad->departamento->pais->nombre}, {$vacante->empresa->ciudad->departamento->nombre} - {$vacante->empresa->ciudad->nombre}, {$vacante->empresa->direccion}\";\n        }\n\n        if (isset($ubicacion_empresa)) {\n            $vacante_ia['ubicacion'] = $ubicacion_empresa;\n        }\n\n        foreach ($candidatos as $candidato) {\n            if (!is_null($candidato->ciudad_id) && !is_null($candidato->direccion)) {\n                $ubicacion = \"{$candidato->ciudad->departamento->pais->nombre}, {$candidato->ciudad->departamento->nombre} - {$candidato->ciudad->nombre}, {$candidato->direccion}\";\n            }\n\n            $usuario = [\n                ...Arr::only($candidato->toArray(), ['id', 'nombre_completo', 'email', 'telefono', 'edad']),\n                'adecuacion' => $this->obtenerAdecuacionUsuario($candidato->id, $request->vacante_id)\n            ];\n\n            if (isset($ubicacion)) {\n                $usuario['ubicacion'] = $ubicacion;\n            }\n\n            if (!is_null($candidato->perfilLaboral)) {\n                $usuario['salario']                   = $candidato->perfilLaboral->salario;\n                $usuario['salario_maximo']            = $candidato->perfilLaboral->salario_maximo;\n                $usuario['habilidades']               = $candidato->perfilLaboral->habilidades;\n                $usuario['herramientas_tecnologicas'] = $candidato->perfilLaboral->herramientas_tecnologicas;\n                $usuario['estudios']                  = [];\n                $usuario['experiencias_laborales']    = [];\n                $usuario['idiomas']                   = [];\n                $usuario['etapas']                    = [];\n\n                foreach ($candidato->perfilLaboral->estudios as $item) {\n                    array_push($usuario['estudios'], [\n                        ...Arr::only($item->toArray(), ['titulo', 'fecha_inicio', 'fecha_fin']),\n                        'nivel_educativo' => $item->nivelEducativo->nombre,\n                    ]);\n                }\n\n                foreach ($candidato->perfilLaboral->experienciasLaborales as $item) {\n                    array_push($usuario['experiencias_laborales'], [...Arr::only($item->toArray(), ['empresa', 'cargo', 'fecha_inicio', 'fecha_fin', 'tiempo'])]);\n                }\n\n                foreach ($candidato->perfilLaboral->idiomas as $item) {\n                    array_push($usuario['idiomas'], [\n                        'idioma' => $item->idioma->nombre,\n                        'nivel'  => $item->nivel\n                    ]);\n                }\n\n                foreach ($candidato->etapasUsuarios as $item) {\n                    $datos_etapas = [\n                        'nombre'      => $item->etapa->nombre,\n                        'puntaje'     => $item->puntaje,\n                        'puntaje_ia'  => $item->puntaje_ia,\n                        'comentarios' => $item->comentarios->pluck('comentario')->values()->toArray()\n                    ];\n\n                    if ($item->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE) {\n                        $agendas = $this->agenda_repositorio->getTodo(new Request([\n                            'proceso_id'         => $vacante->proceso->id,\n                            'evaluado_id'        => $item->usuario_id,\n                            'estado_id'          => EstadoAgenda::FINALIZADA_ID,\n                            'incluir_resultados' => true\n                        ]));\n\n                        $datos_etapas['pruebas_psicometricas'] = [];\n\n                        foreach ($agendas as $agenda) {\n                            array_push($datos_etapas['pruebas_psicometricas'], [\n                                'prueba'     => $agenda->prueba->nombre,\n                                'ajuste'     => $agenda->ajuste,\n                                'resultados' => $agenda->resultados->map(function ($resultado) {\n                                    return [\n                                        'dimension' => $resultado->dimension->nombre,\n                                        'puntaje'   => $resultado->puntaje_transformado\n                                    ];\n                                })->values()->toArray()\n                            ]);\n                        }\n\n                        if (count($datos_etapas['pruebas_psicometricas']) === 0) {\n                            unset($datos_etapas['pruebas_psicometricas']);\n                        }\n                    }\n\n                    array_push($usuario['etapas'], $datos_etapas);\n                }\n            }\n\n            array_push($candidatos_ia, $usuario);\n        }\n\n        return $this->realizarPeticionIA('obtener-candidatos-recomendados', [\n            'vacante_id' => $request->vacante_id,\n            'vacante'    => json_encode($vacante_ia, JSON_UNESCAPED_UNICODE),\n            'candidatos' => json_encode($candidatos_ia, JSON_UNESCAPED_UNICODE)\n        ]);\n    }\n\n    /**\n     * Obtener competencias por mejorar para usuario que será contratado.\n     * SOLO Buscar agendas de TenDisc Plus (12) y Potencial Comercial (7)\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return array\n     * @author Sergio Vargas\n     */\n    public function obtenerCompetenciasPorMejorar(int $id): array {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n        $usuario_id = $etapa_vacante_usuario->usuario_id;\n        $proceso = $etapa_vacante_usuario->vacante->proceso;\n\n        if (is_null($proceso)) {\n            return ['pruebas' => []];\n        }\n\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id' => $proceso->id,\n            'evaluado_id' => $usuario_id,\n            'pruebas_ids' => [12, 7],\n            'estado_id' => 3,\n            'con_evaluado' => true\n        ]));\n\n        $resultado = ['pruebas' => []];\n\n        foreach ($agendas as $agenda) {\n            $competencias_bajas = $this->extraerCompetenciasBajas($agenda);\n\n            if (!empty($competencias_bajas)) {\n                $resultado['pruebas'][] = [\n                    'prueba_id' => $agenda->prueba_id,\n                    'nombre_prueba' => $agenda->prueba->nombre,\n                    'competencias' => $competencias_bajas\n                ];\n            }\n        }\n\n        return $resultado;\n    }\n\n    /**\n     * Extraer las 2 competencias más bajas de una agenda según su prueba.\n     *\n     * @param \\App\\Models\\Agendas\\Agenda $agenda Agenda finalizada.\n     * @return array\n     * @author Sergio Vargas\n     */\n    private function extraerCompetenciasBajas($agenda): array {\n        $resultados = $this->resultado_agenda_servicio->gestionarResultados($agenda);\n\n        if (empty($resultados)) {\n            return [];\n        }\n\n        $competencias_todas = [];\n\n        // TenDisc Plus (prueba_id = 12)\n        if ($agenda->prueba_id === 12) {\n            $factor_especificas = collect($resultados)->firstWhere('nombre', 'Competencias Específicas');\n            $factor_transversales = collect($resultados)->firstWhere('nombre', 'Competencias Transversales');\n\n            if ($factor_especificas) {\n                $competencias_todas = array_merge($competencias_todas, $factor_especificas['dimensiones']);\n            }\n            if ($factor_transversales) {\n                $competencias_todas = array_merge($competencias_todas, $factor_transversales['dimensiones']);\n            }\n        }\n\n        // Potencial Comercial (prueba_id = 7)\n        if ($agenda->prueba_id === 7) {\n            $factor_caracter = collect($resultados)->firstWhere('nombre', 'Carácter');\n            $factor_habilidades = collect($resultados)->firstWhere('nombre', 'Habilidades');\n\n            if ($factor_caracter) {\n                $competencias_todas = array_merge($competencias_todas, $factor_caracter['dimensiones']);\n            }\n            if ($factor_habilidades) {\n                $competencias_todas = array_merge($competencias_todas, $factor_habilidades['dimensiones']);\n            }\n        }\n\n        // Ordenar por puntaje ascendente y tomar las 2 más bajas\n        return collect($competencias_todas)\n            ->sortBy('puntaje_transformado')\n            ->take(2)\n            ->map(fn($c) => [\n                'nombre' => $c['nombre'],\n                'puntaje' => round($c['puntaje_transformado'], 0)\n            ])\n            ->values()\n            ->toArray();\n    }\n}\n","structuredPatch":[{"oldStart":534,"oldLines":13,"newStart":534,"newLines":14,"lines":["      *","      * @param int $id ID de la etapa del usuario en la vacante.","      * @param int $puntaje Puntaje dado por el reclutador.","+     * @param bool $forzar_actualizacion Si es true, omite la validación de puntaje nulo.","      * @return void","      * @author Daniel Beltrán","      */","-    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje): void {","+    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {","         $etapa_usuario = $this->repositorio->getUno($id);"," ","-        if ($etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {","+        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {","             if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {","                 $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');","             }"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"c2823f45-6a19-41ad-8f05-4451295ec1c8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T16:01:51.947Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01C5yw6Gj1ntvRNTLJjjWvSy","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. He modificado la función `guardarPuntajeAdecuacionReclutador` con los siguientes cambios:\n\n## Cambios realizados:\n\n1. **Nuevo parámetro `$forzar_actualizacion`**: Agregué un tercer parámetro booleano con valor por defecto `false`\n   \n2. **Modificación de la validación**: La condición ahora es:\n   ```php\n   if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje)))\n   ```\n\n3. **Actualización del DocBlock**: Añadí la documentación del nuevo parámetro\n\n## Comportamiento:\n\n- **Por defecto (`$forzar_actualizacion = false`)**: La función mantiene su comportamiento original, aplicando la validación `is_null($etapa_usuario->puntaje)`\n\n- **Cuando se pasa `true`**: La validación de puntaje nulo se omite, permitiendo actualizar el puntaje incluso si ya existe uno\n\n## Uso:\n\n```php\n// Comportamiento normal (solo actualiza si puntaje es null)\n$this->guardarPuntajeAdecuacionReclutador($id, $puntaje);\n\n// Forzar actualización (omite validación de puntaje null)\n$this->guardarPuntajeAdecuacionReclutador($id, $puntaje, true);\n```"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1177,"cache_read_input_tokens":49012,"cache_creation":{"ephemeral_5m_input_tokens":1177,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvC49vUjf6esRzgCsYmU","uuid":"ec67a271-656e-44d5-9a6c-ad609a31b5d8"}
{"parentUuid":"ec67a271-656e-44d5-9a6c-ad609a31b5d8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 110 to 110 from c:\\laragon\\www\\psicoalianza-2\\resources\\views\\mis-pruebas\\aplicantes\\modales\\modal-aplicacion-revision-hv.blade.php:\nmodalidad_trabajo_id_\n\nThis may or may not be related to the current task.</ide_selection>"}]},"uuid":"f201f0cc-9efd-41bb-b230-4d65a4d693d3","timestamp":"2026-01-08T21:31:18.816Z"}
{"parentUuid":"f201f0cc-9efd-41bb-b230-4d65a4d693d3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"text","text":"analiza este archivo resources\\views\\mis-pruebas\\aplicantes\\modales\\modal-aplicacion-revision-hv.blade.php y agrege la aprte de modalidad de trabajo pero no se cequea con lo quue bine del back  que lelga asi {\n    \"data\": {\n        \"id\": 6,\n        \"usuario_id\": 25,\n        \"modalidad_trabajo_id\": 3,\n        \"salario\": 3541545,\n        \"salario_maximo\": 45664664,\n        \"habilidades\": \"Precisi\\u00f3n, organizaci\\u00f3n, cumplimiento estricto de procedimientos\",\n        \"herramientas_tecnologicas\": \"HPLC, UV-VIS, FTIR, LIMS\",\n        \"licencia_conducir\": null,\n        \"experiencias_laborales\": ["}]},"uuid":"d4383020-3009-450a-8602-d50a110a9069","timestamp":"2026-01-08T21:31:18.816Z"}
{"parentUuid":"d4383020-3009-450a-8602-d50a110a9069","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T21:31:23.043Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015a3xbGBWnMN1XirPeuwUeZ","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a analizar el archivo para entender la estructura y corregir el problema con la modalidad de trabajo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":53015,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":53015,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvdBtiKQ6bQh4TEDcv45","uuid":"e5483e19-bd35-47e8-9717-b784352cc8b8"}
{"parentUuid":"e5483e19-bd35-47e8-9717-b784352cc8b8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T21:31:23.654Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015a3xbGBWnMN1XirPeuwUeZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KDc2GesRkoTveJqUKtwrSi","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\resources\\views\\mis-pruebas\\aplicantes\\modales\\modal-aplicacion-revision-hv.blade.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":53015,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":53015,"ephemeral_1h_input_tokens":0},"output_tokens":123,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvdBtiKQ6bQh4TEDcv45","uuid":"1234f0b1-eea2-4303-bfb7-3538629f0ec9"}
{"parentUuid":"1234f0b1-eea2-4303-bfb7-3538629f0ec9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KDc2GesRkoTveJqUKtwrSi","type":"tool_result","content":"     1→${crearModal({\n     2→    id: 'modal-aplicacion-revision-hv',\n     3→    titulo_header: 'Completar y verificar hoja de vida',\n     4→    dialog_class: 'modal-xl modal-dialog-centered modal-dialog-scrollable',\n     5→    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n     6→    modal_body: `\n     7→        <div class=\"mb-3 d-none\" id=\"alerta-ia-revision-hv\">\n     8→            ${crearAlerta('info', 'Ahora crearás tu perfil laboral, puedes agregar una hoja de vida para que se completen tus datos automáticamente con IA o puedes completarlos manualmente.')}\n     9→        </div>\n    10→\n    11→        <form id=\"formulario-revision-hv\" action=\"/perfiles-laborales\">\n    12→            @csrf\n    13→            <input type=\"hidden\" id=\"id\" name=\"id\">\n    14→            <input type=\"hidden\" id=\"revision_hv_usuario_id\" name=\"usuario_id\" value=\"{{ auth()->user()->id }}\">\n    15→            <input type=\"hidden\" id=\"revision_hv_etapa_vacante_usuario_id\" name=\"etapa_vacante_usuario_id\">\n    16→            <input type=\"hidden\" id=\"revision_hv_vacante_id\">\n    17→            <input type=\"hidden\" id=\"revision_hv_etapa_id\">\n    18→            <input type=\"hidden\" id=\"revision_hv_habilidades\" name=\"habilidades\">\n    19→            <input type=\"hidden\" id=\"revision_hv_herramientas_tecnologicas\" name=\"herramientas_tecnologicas\">\n    20→            <input type=\"hidden\" id=\"revision_hv_idiomas\" name=\"idiomas\">\n    21→            <input type=\"hidden\" id=\"revision_hv_estudios\" name=\"estudios\">\n    22→            <input type=\"hidden\" id=\"revision_hv_experiencias_laborales\" name=\"experiencias_laborales\">\n    23→            <input type=\"hidden\" id=\"revision_hv_discapacidades\" name=\"discapacidades\">\n    24→\n    25→            <div class=\"col-12 mb-4\">\n    26→                <div class=\"row align-items-end\">\n    27→                    <div class=\"col-12 mt-3 mb-1\">\n    28→                        Adjuntar hoja de vida (Opcional)\n    29→                    </div>\n    30→                    <div class=\"col-12 mt-1\">\n    31→                        ${crearInputFile({\n    32→                            id: 'hv_archivo',\n    33→                            name: 'hoja_vida',\n    34→                            placeholder: '',\n    35→                            required: false,\n    36→                            accept: 'application/pdf, image/jpeg, image/png',\n    37→                        })}\n    38→                    </div>\n    39→                </div>\n    40→            </div>\n    41→\n    42→            <div class=\"col-12 d-none\" id=\"contenedor-campos-perfil-revision\">\n    43→                <div class=\"row\">\n    44→                    <div class=\"col-12 ps-3 py-2\">\n    45→                        <div class=\"col-12 p-4 border rounded-3\">\n    46→                            <div class=\"row align-items-center\">\n    47→                                <div class=\"col fw-semibold text-headline-5 text-gray-10\">\n    48→                                    Nivel educativo\n    49→                                </div>\n    50→                                <div class=\"col-auto\">\n    51→                                    ${crearBoton({\n    52→                                        clases: 'btn-tonal-primary justify-content-center px-7',\n    53→                                        texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar nivel educativo`,\n    54→                                        type: 'button',\n    55→                                        onclick: `abrirModalNivelEducativoRevision()`\n    56→                                    })}\n    57→                                </div>\n    58→                                <div class=\"col-12\">\n    59→                                    <div class=\"row m-0 w-100\" id=\"contenedor-niveles-educativos-revision\"></div>\n    60→                                </div>\n    61→                            </div>\n    62→                        </div>\n    63→                    </div>\n    64→\n    65→                    <div class=\"col-12 ps-3 py-2\">\n    66→                        <div class=\"col-12 p-4 border rounded-3\">\n    67→                            <div class=\"row align-items-center\">\n    68→                                <div class=\"col\">\n    69→                                    <div class=\"row align-items-center\">\n    70→                                        <div class=\"col-12 fw-semibold text-headline-5 text-gray-10\">\n    71→                                            Experiencia laboral\n    72→                                        </div>\n    73→                                        <div class=\"col-auto text-label-1 mt-2\">\n    74→                                            No tengo experiencia laboral\n    75→                                        </div>\n    76→                                        <div class=\"col fw-bold mt-2\">\n    77→                                            ${crearToggle({\n    78→                                                id: 'revision_no_experiencia',\n    79→                                                name: 'no_experiencia',\n    80→                                                value: '0',\n    81→                                                checked: false,\n    82→                                                onchange: 'seleccionarNoTengoExperienciaRevision(this.checked)',\n    83→                                            })}\n    84→                                        </div>\n    85→                                    </div>\n    86→                                </div>\n    87→                                <div class=\"col-auto\">\n    88→                                    ${crearBoton({\n    89→                                        id: 'btn-agregar-experiencia-laboral-revision',\n    90→                                        clases: 'btn-tonal-primary justify-content-center',\n    91→                                        texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar experiencia laboral`,\n    92→                                        onclick: `abrirModalExperienciaLaboralRevision();`\n    93→                                    })}\n    94→                                </div>\n    95→                                <div class=\"col-12\">\n    96→                                    <div class=\"row m-0 w-100\" id=\"contenedor-experiencias-laborales-revision\"></div>\n    97→                                </div>\n    98→                            </div>\n    99→                        </div>\n   100→                    </div>\n   101→\n   102→                    <div class=\"col-12 ps-3 py-2\">\n   103→                        <div class=\"card shadow-sm\">\n   104→                            <div class=\"card-body\">\n   105→                                <div class=\"text-headline-6 text-gray-10 fw-semibold\">Modalidad de trabajo</div>\n   106→                                <div class=\"row mt-2\">\n   107→                                    @foreach ($modalidades_trabajos as $item)\n   108→                                        <div class=\"col-auto\">\n   109→                                            ${crearRadioButton({\n   110→                                                id: 'modalidad_trabajo_id_{{ $item->id }}',\n   111→                                                name: 'modalidad_trabajo_id',\n   112→                                                value: '{{ $item->id }}',\n   113→                                                label: '{{ $item->nombre }}',\n   114→                                                @if (isset($vacante))\n   115→                                                    @if ($vacante->modalidad_trabajo_id == $item->id)\n   116→                                                        checked: true,\n   117→                                                    @endif\n   118→                                                @else\n   119→                                                    @if ($item->id == 1)\n   120→                                                        checked: true,\n   121→                                                    @endif\n   122→                                                @endif\n   123→                                            })}\n   124→                                        </div>\n   125→                                    @endforeach\n   126→                                </div>\n   127→                            </div>\n   128→                        </div>\n   129→                    </div>\n   130→\n   131→                    <div class=\"col-12 mb-5 mt-2\">\n   132→                        <div class=\"rounded-3 p-3 border\">\n   133→                            <div class=\"col-12 pb-2\">\n   134→                                <div class=\"row\">\n   135→                                    <div class=\"col-12\">\n   136→                                        <label class=\"form-label text-gray-10 fw-semibold\">Salario</label>\n   137→                                    </div>\n   138→                                    <div class=\"col-auto\">\n   139→                                        ${crearRadioButton({\n   140→                                            id: 'revision_salario_especifico',\n   141→                                            name: 'tipo_salario',\n   142→                                            class: 'input-dinamico',\n   143→                                            value: 'especifico',\n   144→                                            label: 'Específico',\n   145→                                            checked: false,\n   146→                                            onchange: `seleccionarSalarioRevision(this.value)`,\n   147→                                        })}\n   148→                                    </div>\n   149→                                    <div class=\"col-auto\">\n   150→                                        ${crearRadioButton({\n   151→                                            id: 'revision_salario_rango',\n   152→                                            name: 'tipo_salario',\n   153→                                            class: 'input-dinamico',\n   154→                                            value: 'rango',\n   155→                                            label: 'Rango',\n   156→                                            checked: true,\n   157→                                            onchange: `seleccionarSalarioRevision(this.value)`,\n   158→                                        })}\n   159→                                    </div>\n   160→                                </div>\n   161→                                <div class=\"col-12\">\n   162→                                    <div class=\"row mt-3\" id=\"contenedor-campos-salario-revision\">\n   163→                                        <div class=\"col-12 col-md-6\">\n   164→                                            ${crearInput({\n   165→                                                id: 'revision_salario',\n   166→                                                name: 'salario',\n   167→                                                class: 'cleave',\n   168→                                                input_container_class: 'mb-0',\n   169→                                                label: 'Desde',\n   170→                                                placeholder: '',\n   171→                                                step: 0.01,\n   172→                                                required: true,\n   173→                                                minlength: 3,\n   174→                                                maxlength: 10,\n   175→                                                onkeyup: `validarRangoSalarioRevision()`,\n   176→                                                data: [{\n   177→                                                    texto: 'simbolo-cleave',\n   178→                                                    value: ''\n   179→                                                }],\n   180→                                                icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   181→                                            })}\n   182→                                        </div>\n   183→                                        <div class=\"col-12 col-md-6\">\n   184→                                            ${crearInput({\n   185→                                                id: 'revision_salario_maximo',\n   186→                                                name: 'salario_maximo',\n   187→                                                class: 'cleave',\n   188→                                                input_container_class: 'mb-0',\n   189→                                                label: 'Hasta',\n   190→                                                placeholder: '',\n   191→                                                min: 0,\n   192→                                                step: 0.01,\n   193→                                                required: true,\n   194→                                                minlength: 3,\n   195→                                                maxlength: 10,\n   196→                                                onkeyup: `validarRangoSalarioRevision()`,\n   197→                                                data: [{\n   198→                                                    texto: 'simbolo-cleave',\n   199→                                                    value: ''\n   200→                                                }],\n   201→                                                icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   202→                                            })}\n   203→                                        </div>\n   204→                                    </div>\n   205→                                </div>\n   206→                            </div>\n   207→                        </div>\n   208→                    </div>\n   209→\n   210→                    <div class=\"col-12\">\n   211→                        <div class=\"d-flex align-items-center gap-2 mb-1\">\n   212→                            <label for=\"revision_select_habilidades\" class=\"text-headline-5 text-gray-10 fw-semibold mb-0\">Habilidades</label>\n   213→                            <i class=\"bi bi-info-circle pointer\" role=\"button\" tabindex=\"0\"\n   214→                                ${crearTooltip({\n   215→                                    placement: 'top',\n   216→                                    content: 'Menciona las habilidades que te destacan profesionalmente, como tus fortalezas técnicas, creativas o interpersonales.'\n   217→                                })}></i>\n   218→                        </div>\n   219→                        <p class=\"text-body-3 text-gray-30 mb-3\">Añade tus habilidades o herramientas escribiéndolas y presionando enter para crear la etiqueta.</p>\n   220→                        ${crearSelect2({\n   221→                            id: 'revision_select_habilidades',\n   222→                            name: 'revision_select_habilidades',\n   223→                            class: 'crear-chips input-dinamico',\n   224→                            opciones: [],\n   225→                            multiple: true,\n   226→                            required: true,\n   227→                            adicional: 'data-placeholder=\"Escribe y presiona Enter\"'\n   228→                        })}\n   229→                    </div>\n   230→\n   231→                    <div class=\"col-12\">\n   232→                        <div class=\"d-flex align-items-center gap-2 mb-1\">\n   233→                            <label for=\"revision_select_herramientas_tecnologicas\" class=\"text-headline-5 text-gray-10 fw-semibold mb-0\">Herramientas tecnológicas</label>\n   234→                            <i class=\"bi bi-info-circle pointer\" role=\"button\" tabindex=\"0\"\n   235→                                ${crearTooltip({\n   236→                                    placement: 'top',\n   237→                                    content: 'Menciona los programas, plataformas o lenguajes que utilizas con frecuencia.'\n   238→                                })}></i>\n   239→                        </div>\n   240→                        ${crearSelect2({\n   241→                            id: 'revision_select_herramientas_tecnologicas',\n   242→                            name: 'revision_select_herramientas_tecnologicas',\n   243→                            class: 'crear-chips input-dinamico',\n   244→                            opciones: [],\n   245→                            multiple: true,\n   246→                            required: true,\n   247→                            adicional: 'data-placeholder=\"Escribe y presiona Enter\"'\n   248→                        })}\n   249→                    </div>\n   250→\n   251→                    <label class=\"text-headline-5 text-gray-10 fw-semibold mb-0 mt-4\">Información adicional</label>\n   252→                    <div class=\"col-12 my-3\">\n   253→                        ${crearAlerta('info', 'Esta sección es opcional. Puedes completarla si deseas incluir información adicional')}\n   254→                    </div>\n   255→\n   256→                    <div class=\"col-12 mb-5\">\n   257→                        <div class=\"rounded-2 p-3 border\">\n   258→                            <div class=\"text-headline-6 text-gray-10 fw-semibold\">Idioma</div>\n   259→                            <div class=\"row mt-2 pb-2\">\n   260→                                <div class=\"col-12\">\n   261→                                    ${crearMultiselect({\n   262→                                        opciones: [\n   263→                                            {'id': 1, 'nombre': 'Inglés'},\n   264→                                            {'id': 2, 'nombre': 'Portugués'},\n   265→                                            {'id': 3, 'nombre': 'Francés'},\n   266→                                            {'id': 4, 'nombre': 'Alemán'},\n   267→                                            {'id': 5, 'nombre': 'Mandarín'},\n   268→                                            {'id': 6, 'nombre': 'Italiano'},\n   269→                                            {'id': 7, 'nombre': 'Ruso'},\n   270→                                            {'id': 8, 'nombre': 'Árabe'},\n   271→                                        ],\n   272→                                        id: 'revision_idiomas_seleccionados',\n   273→                                        name: 'revision_idiomas_seleccionados',\n   274→                                        class: 'input-dinamico',\n   275→                                        input_container_class: 'mb-0',\n   276→                                        placeholder: 'Idiomas',\n   277→                                        onchange: 'seleccionarIdiomaRevision(this)',\n   278→                                    })}\n   279→                                </div>\n   280→                                <div class=\"col-12\">\n   281→                                    <div class=\"row mt-2\" id=\"contenedor-idiomas-revision\">\n   282→                                    </div>\n   283→                                </div>\n   284→                            </div>\n   285→                        </div>\n   286→                    </div>\n   287→\n   288→                    <div class=\"col-12 mt-3\">\n   289→                        <div class=\"row align-items-center\">\n   290→                            <div class=\"col-8 col-lg-5 col-xl-4 fw-semibold\">\n   291→                                Licencia de conducir\n   292→                            </div>\n   293→                            <div class=\"col-4 col-lg-3\">\n   294→                                ${crearToggle({\n   295→                                    id: 'revision_opcion_licencia_conducir',\n   296→                                    name: 'opcion_licencia_conducir',\n   297→                                    class: 'input-dinamico',\n   298→                                    value: true,\n   299→                                    checked: false,\n   300→                                    onchange: 'seleccionarLicenciaConducirRevision(this)',\n   301→                                })}\n   302→                            </div>\n   303→                            <div class=\"col-12 col-lg-4 col-xl-5\">\n   304→                                ${crearSelect2({\n   305→                                    opciones: [\n   306→                                        {id: 'A1', nombre: 'A1'},\n   307→                                        {id: 'A2', nombre: 'A2'},\n   308→                                        {id: 'B1', nombre: 'B1'},\n   309→                                        {id: 'B2', nombre: 'B2'},\n   310→                                        {id: 'B3', nombre: 'B3'},\n   311→                                        {id: 'C1', nombre: 'C1'},\n   312→                                        {id: 'C2', nombre: 'C2'},\n   313→                                        {id: 'C3', nombre: 'C3'},\n   314→                                    ],\n   315→                                    id: 'revision_tipo_licencia',\n   316→                                    name: 'licencia_conducir',\n   317→                                    input_container_class: 'mb-0',\n   318→                                    label: 'Tipo',\n   319→                                    required: true,\n   320→                                    disabled: true,\n   321→                                })}\n   322→                            </div>\n   323→                        </div>\n   324→                    </div>\n   325→\n   326→                    <div class=\"col-8 col-lg-5 col-xl-4 mt-5 fw-semibold\">\n   327→                        Tengo una discapacidad\n   328→                    </div>\n   329→                    <div class=\"col-4 col-lg-7 col-xl-8 mt-5 mb-5\">\n   330→                        ${crearToggle({\n   331→                            id: 'revision_vacante_apta_discapacitados',\n   332→                            name: 'vacante_apta_discapacitados',\n   333→                            class: 'input-dinamico',\n   334→                            value: true,\n   335→                            checked: false,\n   336→                            onchange: `seleccionarTengoDiscapacidadRevision(this.checked)`\n   337→                        })}\n   338→                    </div>\n   339→                    <div class=\"col-12\">\n   340→                        <div class=\"row w-100 mx-0\" id=\"contenedor-discapacidad-revision\"></div>\n   341→                    </div>\n   342→                </div>\n   343→            </div>\n   344→\n   345→            <div class=\"col-12\" id=\"contenedor-opciones-crear-ia-revision\">\n   346→                <div class=\"row\">\n   347→                    <div class=\"col-12\">\n   348→                        <div class=\"row align-itens-center\">\n   349→                            <div class=\"col py-5\"><hr class=\"m-0 border-3\"></div>\n   350→                            <div class=\"col-auto pt-3 text-label-1 text-black\">O</div>\n   351→                            <div class=\"col py-5\"><hr class=\"m-0 border-3\"></div>\n   352→                        </div>\n   353→                    </div>\n   354→                    <div class=\"col-12 mt-3\">\n   355→                        ${crearBoton({\n   356→                            id: 'btn-crear-perfil-ia-revision',\n   357→                            clases: 'btn-tonal-primary justify-content-center w-100',\n   358→                            texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar manualmente`,\n   359→                            disabled: false,\n   360→                            type: 'button',\n   361→                            onclick: 'crearPerfilManualmenteRevision()',\n   362→                        })}\n   363→                    </div>\n   364→                </div>\n   365→            </div>\n   366→\n   367→            <div class=\"col-12 mt-5\">\n   368→                <div class=\"row justify-content-center gap-3\">\n   369→                    <div class=\"col-auto\">\n   370→                        ${crearBoton({\n   371→                            type: 'button',\n   372→                            texto: 'Cancelar',\n   373→                            clases: 'btn-outline-primary justify-content-center px-7',\n   374→                            onclick: 'cerrarModalRevisionHV()',\n   375→                        })}\n   376→                    </div>\n   377→                    <div class=\"col-auto\">\n   378→                        ${crearBoton({\n   379→                            id: 'btn-guardar-hv',\n   380→                            type: 'submit',\n   381→                            texto: 'Guardar y enviar',\n   382→                            clases: 'btn-primary justify-content-center px-7',\n   383→                        })}\n   384→                    </div>\n   385→                </div>\n   386→            </div>\n   387→        </form>\n   388→    `\n   389→})}\n   390→\n   391→${crearModal({\n   392→    id: 'modal-generando-ia-revision',\n   393→    dialog_class: 'modal-md modal-dialog-centered',\n   394→    adiconales_modals_header: `data-bs-backdrop=\"static\"`,\n   395→    header_cerrar: 'd-none',\n   396→    titulo_header: 'Generando...',\n   397→    modal_body: `\n   398→        <div class=\"col-12\">\n   399→            <div class=\"row justify-content-center\">\n   400→                <div class=\"col-4\">\n   401→                    <img class=\"w-100\" src=\"{{ asset('/imagenes/gifs/cargue-ia.gif') }}\">\n   402→                </div>\n   403→            </div>\n   404→        </div>\n   405→    `\n   406→})}\n   407→\n   408→${crearModal({\n   409→    id: 'modal-agregar-nivel-educativo',\n   410→    dialog_class: 'modal-lg modal-dialog-centered',\n   411→    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n   412→    titulo_header: '<span class=\"text-gray-10 fw-semibold\">Agregar nivel educativo</span>',\n   413→    boton_footer1: {\n   414→        type: 'button',\n   415→        texto: 'Cancelar',\n   416→        class: 'btn-outline-primary',\n   417→        cerrar_modal: true,\n   418→    },\n   419→    boton_footer2: {\n   420→        type: 'submit',\n   421→        texto: 'Agregar nivel educativo',\n   422→        class: 'btn-primary',\n   423→        form: 'formulario-nivel-educativo',\n   424→    },\n   425→    modal_body: `\n   426→        <form id=\"formulario-nivel-educativo\" class=\"px-4\" action=\"/nivel-educativo\">\n   427→            @csrf\n   428→            <div class=\"row\">\n   429→                <div class=\"col-12\">\n   430→                    ${crearInput({\n   431→                        id: 'titulo',\n   432→                        name: 'titulo',\n   433→                        maxlength: 50,\n   434→                        required: true,\n   435→                        autocomplete: 'off',\n   436→                        label: 'Título',\n   437→                    })}\n   438→                </div>\n   439→                <div class=\"col-12 col-lg-6\">\n   440→                    ${crearInput({\n   441→                        id: 'institucion_educativa',\n   442→                        name: 'institucion_educativa',\n   443→                        input_container_class: 'mb-6',\n   444→                        maxlength: 50,\n   445→                        required: true,\n   446→                        autocomplete: 'off',\n   447→                        label: 'Institución educativa',\n   448→                    })}\n   449→                </div>\n   450→                <div class=\"col-12 col-lg-6\">\n   451→                    ${crearSelect2({\n   452→                        id: 'nivel_educativo_id',\n   453→                        opciones: @json($niveles_educativos),\n   454→                        name: 'nivel_educativo_id',\n   455→                        label: 'Nivel educativo',\n   456→                        placeholder: 'Nivel educativo',\n   457→                        required: true,\n   458→                        buscador: false\n   459→                    })}\n   460→                </div>\n   461→                <div class=\"col-5 text-headline-6 fw-semibold\">\n   462→                    Estoy cursando estos estudios\n   463→                </div>\n   464→                <div class=\"col-7 mb-5\">\n   465→                    ${crearToggle({\n   466→                        id: 'cursando_estudios',\n   467→                        name: 'graduado_cursando_estudios',\n   468→                        value: 'cursando',\n   469→                        checked: false,\n   470→                        onchange: 'seleccionarGraduadoCursando(this.checked)',\n   471→                    })}\n   472→                </div>\n   473→                <div class=\"col-12\" id=\"fechas-cursando-estudios\">\n   474→                    <div class=\"row align-items-center\">\n   475→                        <div class=\"col-12 col-md-6 mt-2\">\n   476→                            ${crearSelectorMesAnio({\n   477→                                id: 'fecha_inicio_estudio',\n   478→                                name: 'fecha_inicio_estudio',\n   479→                                placeholder: 'mm/yyyy',\n   480→                                disabled: false,\n   481→                                required: true,\n   482→                                input_container_class: 'mb-4',\n   483→                                label: 'Fecha de inicio',\n   484→                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n   485→                            })}\n   486→                        </div>\n   487→                        <div class=\"col-12 col-md-6 mt-2\">\n   488→                            ${crearSelectorMesAnio({\n   489→                                id: 'fecha_fin_estudio',\n   490→                                name: 'fecha_fin_estudio',\n   491→                                placeholder: 'mm/yyyy',\n   492→                                disabled: false,\n   493→                                required: true,\n   494→                                input_container_class: 'mb-4',\n   495→                                label: 'Fecha de finalización',\n   496→                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n   497→                            })}\n   498→                        </div>\n   499→                    </div>\n   500→                </div>\n   501→            </div>\n   502→        </form>\n   503→    `\n   504→})}\n   505→\n   506→${crearModal({\n   507→    id: 'modal-agregar-experiencia-laboral',\n   508→    dialog_class: 'modal-lg modal-dialog-centered',\n   509→    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n   510→    titulo_header: '<span class=\"text-gray-10 fw-semibold\">Agregar experiencia laboral</span>',\n   511→    boton_footer1: {\n   512→        type: 'button',\n   513→        texto: 'Cancelar',\n   514→        class: 'btn-outline-primary',\n   515→        cerrar_modal: true,\n   516→    },\n   517→    boton_footer2: {\n   518→        type: 'submit',\n   519→        texto: 'Agregar experiencia laboral',\n   520→        class: 'btn-primary',\n   521→        form: 'formulario-experiencia-laboral',\n   522→    },\n   523→    modal_body: `\n   524→        <form id=\"formulario-experiencia-laboral\" class=\"px-4\" action=\"/experiencia-laboral\">\n   525→            @csrf\n   526→            <div class=\"row\">\n   527→                <div class=\"col-12\">\n   528→                    ${crearInput({\n   529→                        id: 'cargo',\n   530→                        name: 'cargo',\n   531→                        maxlength: 50,\n   532→                        required: true,\n   533→                        autocomplete: 'off',\n   534→                        label: 'Cargo',\n   535→                    })}\n   536→                </div>\n   537→                <div class=\"col-12\">\n   538→                    ${crearInput({\n   539→                        id: 'empresa',\n   540→                        name: 'empresa',\n   541→                        maxlength: 50,\n   542→                        required: true,\n   543→                        autocomplete: 'off',\n   544→                        label: 'Empresa u organización',\n   545→                    })}\n   546→                </div>\n   547→                <div class=\"col-12\">\n   548→                    ${crearSelect2({\n   549→                        opciones: [\n   550→                            {id: 1, nombre: 'Presencial'},\n   551→                            {id: 2, nombre: 'Híbrido'},\n   552→                            {id: 3, nombre: 'Remoto'}\n   553→                        ],\n   554→                        id: 'modalidad_trabajo_id',\n   555→                        name: 'modalidad_trabajo_id',\n   556→                        label: 'Modalidad de trabajo',\n   557→                        placeholder: 'Seleccionar modalidad',\n   558→                        required: false,\n   559→                    })}\n   560→                </div>\n   561→                <div class=\"col-5 text-headline-6 fw-semibold\">\n   562→                    Actualmente tengo este trabajo\n   563→                </div>\n   564→                <div class=\"col-7 mb-5\">\n   565→                    ${crearToggle({\n   566→                        id: 'actualmente_trabajo',\n   567→                        name: 'actualmente_trabajo',\n   568→                        value: true,\n   569→                        checked: false,\n   570→                        onchange: 'seleccionarActualmenteTrabajo(this.checked)',\n   571→                    })}\n   572→                </div>\n   573→                <div class=\"col-12\">\n   574→                    <div class=\"row mt-2\" id=\"fechas-trabajo-experiencia\">\n   575→                        <div class=\"col-12 col-md-6 mt-3\">\n   576→                            ${crearSelectorMesAnio({\n   577→                                id: 'fecha_inicio_experiencia',\n   578→                                name: 'fecha_inicio_experiencia',\n   579→                                placeholder: 'mm/yyyy',\n   580→                                disabled: false,\n   581→                                required: true,\n   582→                                input_container_class: 'mb-2',\n   583→                                label: 'Fecha de inicio',\n   584→                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n   585→                            })}\n   586→                        </div>\n   587→                        <div class=\"col-12 col-md-6 mt-3\">\n   588→                            ${crearSelectorMesAnio({\n   589→                                id: 'fecha_fin_experiencia',\n   590→                                name: 'fecha_fin_experiencia',\n   591→                                placeholder: 'mm/yyyy',\n   592→                                disabled: false,\n   593→                                required: true,\n   594→                                input_container_class: 'mb-2',\n   595→                                label: 'Fecha de finalización',\n   596→                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n   597→                            })}\n   598→                        </div>\n   599→                    </div>\n   600→                </div>\n   601→                <div class=\"col-12 mt-3\">\n   602→                    ${crearTextarea({\n   603→                        id: 'funciones',\n   604→                        name: 'funciones',\n   605→                        label: 'Funciones y responsabilidades',\n   606→                        placeholder: 'Describe las principales funciones y responsabilidades del cargo...',\n   607→                        maxlength: 1000,\n   608→                        rows: 4,\n   609→                        required: false,\n   610→                    })}\n   611→                </div>\n   612→            </div>\n   613→        </form>\n   614→    `\n   615→})}\n   616→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"18a4e56d-0547-42e1-bcc3-54c697baba43","timestamp":"2026-01-08T21:31:25.232Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\resources\\views\\mis-pruebas\\aplicantes\\modales\\modal-aplicacion-revision-hv.blade.php","content":"${crearModal({\n    id: 'modal-aplicacion-revision-hv',\n    titulo_header: 'Completar y verificar hoja de vida',\n    dialog_class: 'modal-xl modal-dialog-centered modal-dialog-scrollable',\n    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n    modal_body: `\n        <div class=\"mb-3 d-none\" id=\"alerta-ia-revision-hv\">\n            ${crearAlerta('info', 'Ahora crearás tu perfil laboral, puedes agregar una hoja de vida para que se completen tus datos automáticamente con IA o puedes completarlos manualmente.')}\n        </div>\n\n        <form id=\"formulario-revision-hv\" action=\"/perfiles-laborales\">\n            @csrf\n            <input type=\"hidden\" id=\"id\" name=\"id\">\n            <input type=\"hidden\" id=\"revision_hv_usuario_id\" name=\"usuario_id\" value=\"{{ auth()->user()->id }}\">\n            <input type=\"hidden\" id=\"revision_hv_etapa_vacante_usuario_id\" name=\"etapa_vacante_usuario_id\">\n            <input type=\"hidden\" id=\"revision_hv_vacante_id\">\n            <input type=\"hidden\" id=\"revision_hv_etapa_id\">\n            <input type=\"hidden\" id=\"revision_hv_habilidades\" name=\"habilidades\">\n            <input type=\"hidden\" id=\"revision_hv_herramientas_tecnologicas\" name=\"herramientas_tecnologicas\">\n            <input type=\"hidden\" id=\"revision_hv_idiomas\" name=\"idiomas\">\n            <input type=\"hidden\" id=\"revision_hv_estudios\" name=\"estudios\">\n            <input type=\"hidden\" id=\"revision_hv_experiencias_laborales\" name=\"experiencias_laborales\">\n            <input type=\"hidden\" id=\"revision_hv_discapacidades\" name=\"discapacidades\">\n\n            <div class=\"col-12 mb-4\">\n                <div class=\"row align-items-end\">\n                    <div class=\"col-12 mt-3 mb-1\">\n                        Adjuntar hoja de vida (Opcional)\n                    </div>\n                    <div class=\"col-12 mt-1\">\n                        ${crearInputFile({\n                            id: 'hv_archivo',\n                            name: 'hoja_vida',\n                            placeholder: '',\n                            required: false,\n                            accept: 'application/pdf, image/jpeg, image/png',\n                        })}\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"col-12 d-none\" id=\"contenedor-campos-perfil-revision\">\n                <div class=\"row\">\n                    <div class=\"col-12 ps-3 py-2\">\n                        <div class=\"col-12 p-4 border rounded-3\">\n                            <div class=\"row align-items-center\">\n                                <div class=\"col fw-semibold text-headline-5 text-gray-10\">\n                                    Nivel educativo\n                                </div>\n                                <div class=\"col-auto\">\n                                    ${crearBoton({\n                                        clases: 'btn-tonal-primary justify-content-center px-7',\n                                        texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar nivel educativo`,\n                                        type: 'button',\n                                        onclick: `abrirModalNivelEducativoRevision()`\n                                    })}\n                                </div>\n                                <div class=\"col-12\">\n                                    <div class=\"row m-0 w-100\" id=\"contenedor-niveles-educativos-revision\"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12 ps-3 py-2\">\n                        <div class=\"col-12 p-4 border rounded-3\">\n                            <div class=\"row align-items-center\">\n                                <div class=\"col\">\n                                    <div class=\"row align-items-center\">\n                                        <div class=\"col-12 fw-semibold text-headline-5 text-gray-10\">\n                                            Experiencia laboral\n                                        </div>\n                                        <div class=\"col-auto text-label-1 mt-2\">\n                                            No tengo experiencia laboral\n                                        </div>\n                                        <div class=\"col fw-bold mt-2\">\n                                            ${crearToggle({\n                                                id: 'revision_no_experiencia',\n                                                name: 'no_experiencia',\n                                                value: '0',\n                                                checked: false,\n                                                onchange: 'seleccionarNoTengoExperienciaRevision(this.checked)',\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                                <div class=\"col-auto\">\n                                    ${crearBoton({\n                                        id: 'btn-agregar-experiencia-laboral-revision',\n                                        clases: 'btn-tonal-primary justify-content-center',\n                                        texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar experiencia laboral`,\n                                        onclick: `abrirModalExperienciaLaboralRevision();`\n                                    })}\n                                </div>\n                                <div class=\"col-12\">\n                                    <div class=\"row m-0 w-100\" id=\"contenedor-experiencias-laborales-revision\"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12 ps-3 py-2\">\n                        <div class=\"card shadow-sm\">\n                            <div class=\"card-body\">\n                                <div class=\"text-headline-6 text-gray-10 fw-semibold\">Modalidad de trabajo</div>\n                                <div class=\"row mt-2\">\n                                    @foreach ($modalidades_trabajos as $item)\n                                        <div class=\"col-auto\">\n                                            ${crearRadioButton({\n                                                id: 'modalidad_trabajo_id_{{ $item->id }}',\n                                                name: 'modalidad_trabajo_id',\n                                                value: '{{ $item->id }}',\n                                                label: '{{ $item->nombre }}',\n                                                @if (isset($vacante))\n                                                    @if ($vacante->modalidad_trabajo_id == $item->id)\n                                                        checked: true,\n                                                    @endif\n                                                @else\n                                                    @if ($item->id == 1)\n                                                        checked: true,\n                                                    @endif\n                                                @endif\n                                            })}\n                                        </div>\n                                    @endforeach\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12 mb-5 mt-2\">\n                        <div class=\"rounded-3 p-3 border\">\n                            <div class=\"col-12 pb-2\">\n                                <div class=\"row\">\n                                    <div class=\"col-12\">\n                                        <label class=\"form-label text-gray-10 fw-semibold\">Salario</label>\n                                    </div>\n                                    <div class=\"col-auto\">\n                                        ${crearRadioButton({\n                                            id: 'revision_salario_especifico',\n                                            name: 'tipo_salario',\n                                            class: 'input-dinamico',\n                                            value: 'especifico',\n                                            label: 'Específico',\n                                            checked: false,\n                                            onchange: `seleccionarSalarioRevision(this.value)`,\n                                        })}\n                                    </div>\n                                    <div class=\"col-auto\">\n                                        ${crearRadioButton({\n                                            id: 'revision_salario_rango',\n                                            name: 'tipo_salario',\n                                            class: 'input-dinamico',\n                                            value: 'rango',\n                                            label: 'Rango',\n                                            checked: true,\n                                            onchange: `seleccionarSalarioRevision(this.value)`,\n                                        })}\n                                    </div>\n                                </div>\n                                <div class=\"col-12\">\n                                    <div class=\"row mt-3\" id=\"contenedor-campos-salario-revision\">\n                                        <div class=\"col-12 col-md-6\">\n                                            ${crearInput({\n                                                id: 'revision_salario',\n                                                name: 'salario',\n                                                class: 'cleave',\n                                                input_container_class: 'mb-0',\n                                                label: 'Desde',\n                                                placeholder: '',\n                                                step: 0.01,\n                                                required: true,\n                                                minlength: 3,\n                                                maxlength: 10,\n                                                onkeyup: `validarRangoSalarioRevision()`,\n                                                data: [{\n                                                    texto: 'simbolo-cleave',\n                                                    value: ''\n                                                }],\n                                                icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                                            })}\n                                        </div>\n                                        <div class=\"col-12 col-md-6\">\n                                            ${crearInput({\n                                                id: 'revision_salario_maximo',\n                                                name: 'salario_maximo',\n                                                class: 'cleave',\n                                                input_container_class: 'mb-0',\n                                                label: 'Hasta',\n                                                placeholder: '',\n                                                min: 0,\n                                                step: 0.01,\n                                                required: true,\n                                                minlength: 3,\n                                                maxlength: 10,\n                                                onkeyup: `validarRangoSalarioRevision()`,\n                                                data: [{\n                                                    texto: 'simbolo-cleave',\n                                                    value: ''\n                                                }],\n                                                icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12\">\n                        <div class=\"d-flex align-items-center gap-2 mb-1\">\n                            <label for=\"revision_select_habilidades\" class=\"text-headline-5 text-gray-10 fw-semibold mb-0\">Habilidades</label>\n                            <i class=\"bi bi-info-circle pointer\" role=\"button\" tabindex=\"0\"\n                                ${crearTooltip({\n                                    placement: 'top',\n                                    content: 'Menciona las habilidades que te destacan profesionalmente, como tus fortalezas técnicas, creativas o interpersonales.'\n                                })}></i>\n                        </div>\n                        <p class=\"text-body-3 text-gray-30 mb-3\">Añade tus habilidades o herramientas escribiéndolas y presionando enter para crear la etiqueta.</p>\n                        ${crearSelect2({\n                            id: 'revision_select_habilidades',\n                            name: 'revision_select_habilidades',\n                            class: 'crear-chips input-dinamico',\n                            opciones: [],\n                            multiple: true,\n                            required: true,\n                            adicional: 'data-placeholder=\"Escribe y presiona Enter\"'\n                        })}\n                    </div>\n\n                    <div class=\"col-12\">\n                        <div class=\"d-flex align-items-center gap-2 mb-1\">\n                            <label for=\"revision_select_herramientas_tecnologicas\" class=\"text-headline-5 text-gray-10 fw-semibold mb-0\">Herramientas tecnológicas</label>\n                            <i class=\"bi bi-info-circle pointer\" role=\"button\" tabindex=\"0\"\n                                ${crearTooltip({\n                                    placement: 'top',\n                                    content: 'Menciona los programas, plataformas o lenguajes que utilizas con frecuencia.'\n                                })}></i>\n                        </div>\n                        ${crearSelect2({\n                            id: 'revision_select_herramientas_tecnologicas',\n                            name: 'revision_select_herramientas_tecnologicas',\n                            class: 'crear-chips input-dinamico',\n                            opciones: [],\n                            multiple: true,\n                            required: true,\n                            adicional: 'data-placeholder=\"Escribe y presiona Enter\"'\n                        })}\n                    </div>\n\n                    <label class=\"text-headline-5 text-gray-10 fw-semibold mb-0 mt-4\">Información adicional</label>\n                    <div class=\"col-12 my-3\">\n                        ${crearAlerta('info', 'Esta sección es opcional. Puedes completarla si deseas incluir información adicional')}\n                    </div>\n\n                    <div class=\"col-12 mb-5\">\n                        <div class=\"rounded-2 p-3 border\">\n                            <div class=\"text-headline-6 text-gray-10 fw-semibold\">Idioma</div>\n                            <div class=\"row mt-2 pb-2\">\n                                <div class=\"col-12\">\n                                    ${crearMultiselect({\n                                        opciones: [\n                                            {'id': 1, 'nombre': 'Inglés'},\n                                            {'id': 2, 'nombre': 'Portugués'},\n                                            {'id': 3, 'nombre': 'Francés'},\n                                            {'id': 4, 'nombre': 'Alemán'},\n                                            {'id': 5, 'nombre': 'Mandarín'},\n                                            {'id': 6, 'nombre': 'Italiano'},\n                                            {'id': 7, 'nombre': 'Ruso'},\n                                            {'id': 8, 'nombre': 'Árabe'},\n                                        ],\n                                        id: 'revision_idiomas_seleccionados',\n                                        name: 'revision_idiomas_seleccionados',\n                                        class: 'input-dinamico',\n                                        input_container_class: 'mb-0',\n                                        placeholder: 'Idiomas',\n                                        onchange: 'seleccionarIdiomaRevision(this)',\n                                    })}\n                                </div>\n                                <div class=\"col-12\">\n                                    <div class=\"row mt-2\" id=\"contenedor-idiomas-revision\">\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-12 mt-3\">\n                        <div class=\"row align-items-center\">\n                            <div class=\"col-8 col-lg-5 col-xl-4 fw-semibold\">\n                                Licencia de conducir\n                            </div>\n                            <div class=\"col-4 col-lg-3\">\n                                ${crearToggle({\n                                    id: 'revision_opcion_licencia_conducir',\n                                    name: 'opcion_licencia_conducir',\n                                    class: 'input-dinamico',\n                                    value: true,\n                                    checked: false,\n                                    onchange: 'seleccionarLicenciaConducirRevision(this)',\n                                })}\n                            </div>\n                            <div class=\"col-12 col-lg-4 col-xl-5\">\n                                ${crearSelect2({\n                                    opciones: [\n                                        {id: 'A1', nombre: 'A1'},\n                                        {id: 'A2', nombre: 'A2'},\n                                        {id: 'B1', nombre: 'B1'},\n                                        {id: 'B2', nombre: 'B2'},\n                                        {id: 'B3', nombre: 'B3'},\n                                        {id: 'C1', nombre: 'C1'},\n                                        {id: 'C2', nombre: 'C2'},\n                                        {id: 'C3', nombre: 'C3'},\n                                    ],\n                                    id: 'revision_tipo_licencia',\n                                    name: 'licencia_conducir',\n                                    input_container_class: 'mb-0',\n                                    label: 'Tipo',\n                                    required: true,\n                                    disabled: true,\n                                })}\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-8 col-lg-5 col-xl-4 mt-5 fw-semibold\">\n                        Tengo una discapacidad\n                    </div>\n                    <div class=\"col-4 col-lg-7 col-xl-8 mt-5 mb-5\">\n                        ${crearToggle({\n                            id: 'revision_vacante_apta_discapacitados',\n                            name: 'vacante_apta_discapacitados',\n                            class: 'input-dinamico',\n                            value: true,\n                            checked: false,\n                            onchange: `seleccionarTengoDiscapacidadRevision(this.checked)`\n                        })}\n                    </div>\n                    <div class=\"col-12\">\n                        <div class=\"row w-100 mx-0\" id=\"contenedor-discapacidad-revision\"></div>\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"col-12\" id=\"contenedor-opciones-crear-ia-revision\">\n                <div class=\"row\">\n                    <div class=\"col-12\">\n                        <div class=\"row align-itens-center\">\n                            <div class=\"col py-5\"><hr class=\"m-0 border-3\"></div>\n                            <div class=\"col-auto pt-3 text-label-1 text-black\">O</div>\n                            <div class=\"col py-5\"><hr class=\"m-0 border-3\"></div>\n                        </div>\n                    </div>\n                    <div class=\"col-12 mt-3\">\n                        ${crearBoton({\n                            id: 'btn-crear-perfil-ia-revision',\n                            clases: 'btn-tonal-primary justify-content-center w-100',\n                            texto: `<i class=\"bi bi-plus text-headline-3\"></i> Agregar manualmente`,\n                            disabled: false,\n                            type: 'button',\n                            onclick: 'crearPerfilManualmenteRevision()',\n                        })}\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"col-12 mt-5\">\n                <div class=\"row justify-content-center gap-3\">\n                    <div class=\"col-auto\">\n                        ${crearBoton({\n                            type: 'button',\n                            texto: 'Cancelar',\n                            clases: 'btn-outline-primary justify-content-center px-7',\n                            onclick: 'cerrarModalRevisionHV()',\n                        })}\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearBoton({\n                            id: 'btn-guardar-hv',\n                            type: 'submit',\n                            texto: 'Guardar y enviar',\n                            clases: 'btn-primary justify-content-center px-7',\n                        })}\n                    </div>\n                </div>\n            </div>\n        </form>\n    `\n})}\n\n${crearModal({\n    id: 'modal-generando-ia-revision',\n    dialog_class: 'modal-md modal-dialog-centered',\n    adiconales_modals_header: `data-bs-backdrop=\"static\"`,\n    header_cerrar: 'd-none',\n    titulo_header: 'Generando...',\n    modal_body: `\n        <div class=\"col-12\">\n            <div class=\"row justify-content-center\">\n                <div class=\"col-4\">\n                    <img class=\"w-100\" src=\"{{ asset('/imagenes/gifs/cargue-ia.gif') }}\">\n                </div>\n            </div>\n        </div>\n    `\n})}\n\n${crearModal({\n    id: 'modal-agregar-nivel-educativo',\n    dialog_class: 'modal-lg modal-dialog-centered',\n    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n    titulo_header: '<span class=\"text-gray-10 fw-semibold\">Agregar nivel educativo</span>',\n    boton_footer1: {\n        type: 'button',\n        texto: 'Cancelar',\n        class: 'btn-outline-primary',\n        cerrar_modal: true,\n    },\n    boton_footer2: {\n        type: 'submit',\n        texto: 'Agregar nivel educativo',\n        class: 'btn-primary',\n        form: 'formulario-nivel-educativo',\n    },\n    modal_body: `\n        <form id=\"formulario-nivel-educativo\" class=\"px-4\" action=\"/nivel-educativo\">\n            @csrf\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    ${crearInput({\n                        id: 'titulo',\n                        name: 'titulo',\n                        maxlength: 50,\n                        required: true,\n                        autocomplete: 'off',\n                        label: 'Título',\n                    })}\n                </div>\n                <div class=\"col-12 col-lg-6\">\n                    ${crearInput({\n                        id: 'institucion_educativa',\n                        name: 'institucion_educativa',\n                        input_container_class: 'mb-6',\n                        maxlength: 50,\n                        required: true,\n                        autocomplete: 'off',\n                        label: 'Institución educativa',\n                    })}\n                </div>\n                <div class=\"col-12 col-lg-6\">\n                    ${crearSelect2({\n                        id: 'nivel_educativo_id',\n                        opciones: @json($niveles_educativos),\n                        name: 'nivel_educativo_id',\n                        label: 'Nivel educativo',\n                        placeholder: 'Nivel educativo',\n                        required: true,\n                        buscador: false\n                    })}\n                </div>\n                <div class=\"col-5 text-headline-6 fw-semibold\">\n                    Estoy cursando estos estudios\n                </div>\n                <div class=\"col-7 mb-5\">\n                    ${crearToggle({\n                        id: 'cursando_estudios',\n                        name: 'graduado_cursando_estudios',\n                        value: 'cursando',\n                        checked: false,\n                        onchange: 'seleccionarGraduadoCursando(this.checked)',\n                    })}\n                </div>\n                <div class=\"col-12\" id=\"fechas-cursando-estudios\">\n                    <div class=\"row align-items-center\">\n                        <div class=\"col-12 col-md-6 mt-2\">\n                            ${crearSelectorMesAnio({\n                                id: 'fecha_inicio_estudio',\n                                name: 'fecha_inicio_estudio',\n                                placeholder: 'mm/yyyy',\n                                disabled: false,\n                                required: true,\n                                input_container_class: 'mb-4',\n                                label: 'Fecha de inicio',\n                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n                            })}\n                        </div>\n                        <div class=\"col-12 col-md-6 mt-2\">\n                            ${crearSelectorMesAnio({\n                                id: 'fecha_fin_estudio',\n                                name: 'fecha_fin_estudio',\n                                placeholder: 'mm/yyyy',\n                                disabled: false,\n                                required: true,\n                                input_container_class: 'mb-4',\n                                label: 'Fecha de finalización',\n                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n                            })}\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </form>\n    `\n})}\n\n${crearModal({\n    id: 'modal-agregar-experiencia-laboral',\n    dialog_class: 'modal-lg modal-dialog-centered',\n    adiconales_modals_header: 'data-bs-backdrop=\"static\" data-bs-keyboard=\"false\"',\n    titulo_header: '<span class=\"text-gray-10 fw-semibold\">Agregar experiencia laboral</span>',\n    boton_footer1: {\n        type: 'button',\n        texto: 'Cancelar',\n        class: 'btn-outline-primary',\n        cerrar_modal: true,\n    },\n    boton_footer2: {\n        type: 'submit',\n        texto: 'Agregar experiencia laboral',\n        class: 'btn-primary',\n        form: 'formulario-experiencia-laboral',\n    },\n    modal_body: `\n        <form id=\"formulario-experiencia-laboral\" class=\"px-4\" action=\"/experiencia-laboral\">\n            @csrf\n            <div class=\"row\">\n                <div class=\"col-12\">\n                    ${crearInput({\n                        id: 'cargo',\n                        name: 'cargo',\n                        maxlength: 50,\n                        required: true,\n                        autocomplete: 'off',\n                        label: 'Cargo',\n                    })}\n                </div>\n                <div class=\"col-12\">\n                    ${crearInput({\n                        id: 'empresa',\n                        name: 'empresa',\n                        maxlength: 50,\n                        required: true,\n                        autocomplete: 'off',\n                        label: 'Empresa u organización',\n                    })}\n                </div>\n                <div class=\"col-12\">\n                    ${crearSelect2({\n                        opciones: [\n                            {id: 1, nombre: 'Presencial'},\n                            {id: 2, nombre: 'Híbrido'},\n                            {id: 3, nombre: 'Remoto'}\n                        ],\n                        id: 'modalidad_trabajo_id',\n                        name: 'modalidad_trabajo_id',\n                        label: 'Modalidad de trabajo',\n                        placeholder: 'Seleccionar modalidad',\n                        required: false,\n                    })}\n                </div>\n                <div class=\"col-5 text-headline-6 fw-semibold\">\n                    Actualmente tengo este trabajo\n                </div>\n                <div class=\"col-7 mb-5\">\n                    ${crearToggle({\n                        id: 'actualmente_trabajo',\n                        name: 'actualmente_trabajo',\n                        value: true,\n                        checked: false,\n                        onchange: 'seleccionarActualmenteTrabajo(this.checked)',\n                    })}\n                </div>\n                <div class=\"col-12\">\n                    <div class=\"row mt-2\" id=\"fechas-trabajo-experiencia\">\n                        <div class=\"col-12 col-md-6 mt-3\">\n                            ${crearSelectorMesAnio({\n                                id: 'fecha_inicio_experiencia',\n                                name: 'fecha_inicio_experiencia',\n                                placeholder: 'mm/yyyy',\n                                disabled: false,\n                                required: true,\n                                input_container_class: 'mb-2',\n                                label: 'Fecha de inicio',\n                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n                            })}\n                        </div>\n                        <div class=\"col-12 col-md-6 mt-3\">\n                            ${crearSelectorMesAnio({\n                                id: 'fecha_fin_experiencia',\n                                name: 'fecha_fin_experiencia',\n                                placeholder: 'mm/yyyy',\n                                disabled: false,\n                                required: true,\n                                input_container_class: 'mb-2',\n                                label: 'Fecha de finalización',\n                                icono2: '<i class=\"bi bi-calendar4 input-icono2 pointer\"></i>',\n                            })}\n                        </div>\n                    </div>\n                </div>\n                <div class=\"col-12 mt-3\">\n                    ${crearTextarea({\n                        id: 'funciones',\n                        name: 'funciones',\n                        label: 'Funciones y responsabilidades',\n                        placeholder: 'Describe las principales funciones y responsabilidades del cargo...',\n                        maxlength: 1000,\n                        rows: 4,\n                        required: false,\n                    })}\n                </div>\n            </div>\n        </form>\n    `\n})}\n","numLines":616,"startLine":1,"totalLines":616}}}
{"parentUuid":"18a4e56d-0547-42e1-bcc3-54c697baba43","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T21:31:29.192Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01ARxaxznXgrBbDvXEup6oyo","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora déjame buscar el archivo JavaScript que maneja la lógica de este modal para entender cómo se cargan los datos del backend:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":9803,"cache_read_input_tokens":53015,"cache_creation":{"ephemeral_5m_input_tokens":9803,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvdCMvBfkGutt9bzZVdR","uuid":"8db53f2a-8a0a-428c-8eb9-b6b6cf93ee89"}
{"parentUuid":"8db53f2a-8a0a-428c-8eb9-b6b6cf93ee89","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T21:31:29.698Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01ARxaxznXgrBbDvXEup6oyo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HqsyzukY5PM8FDa5dZqdcX","name":"Glob","input":{"pattern":"**/*revision*hv*.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":9803,"cache_read_input_tokens":53015,"cache_creation":{"ephemeral_5m_input_tokens":9803,"ephemeral_1h_input_tokens":0},"output_tokens":95,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvdCMvBfkGutt9bzZVdR","uuid":"bf9ab45e-435b-4282-8568-f74e24e10a23"}
{"parentUuid":"bf9ab45e-435b-4282-8568-f74e24e10a23","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HqsyzukY5PM8FDa5dZqdcX","type":"tool_result","content":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\vacantes\\modals-movimientos\\modal-revision-hv.js\nc:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js"}]},"uuid":"5d98a829-2125-4ea7-b568-3c13450c43dc","timestamp":"2026-01-08T21:31:33.048Z","toolUseResult":{"filenames":["c:\\laragon\\www\\psicoalianza-2\\public\\js\\vacantes\\modals-movimientos\\modal-revision-hv.js","c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js"],"durationMs":2224,"numFiles":2,"truncated":false}}
{"parentUuid":"5d98a829-2125-4ea7-b568-3c13450c43dc","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T21:31:35.735Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TyZb5J8qkpFKgUx3DvUfLS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01G3QPVwcdppcWoYb3FvsLod","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":181,"cache_read_input_tokens":62818,"cache_creation":{"ephemeral_5m_input_tokens":181,"ephemeral_1h_input_tokens":0},"output_tokens":89,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvdCvzGQuDP6GhG6CZ5a","uuid":"c5f1bfda-1989-4226-948e-c7fba93a82fe"}
{"parentUuid":"c5f1bfda-1989-4226-948e-c7fba93a82fe","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01G3QPVwcdppcWoYb3FvsLod","type":"tool_result","content":"     1→var revision_hv_ia_activa = false;\n     2→\n     3→const TIEMPO_MODAL_APERTURA = 300;\n     4→const TIEMPO_INICIALIZACION_COMPONENTES = 300;\n     5→const TIEMPO_TRIGGER_SELECT = 200;\n     6→const TIEMPO_FORMULARIO_MANUAL = 100;\n     7→\n     8→let niveles_idiomas = [\n     9→    {\n    10→        id: 'A1',\n    11→        nombre: 'A1'\n    12→    },\n    13→    {\n    14→        id: 'A2',\n    15→        nombre: 'A2'\n    16→    },\n    17→    {\n    18→        id: 'B1',\n    19→        nombre: 'B1'\n    20→    },\n    21→    {\n    22→        id: 'B2',\n    23→        nombre: 'B2'\n    24→    },\n    25→    {\n    26→        id: 'C1',\n    27→        nombre: 'C1'\n    28→    },\n    29→    {\n    30→        id: 'C2',\n    31→        nombre: 'C2'\n    32→    },\n    33→];\n    34→\n    35→$(document).ready(function() {\n    36→    $(document).on('change', '#hv_archivo', function() {\n    37→        if (revision_hv_ia_activa && this.files && this.files[0]) {\n    38→            generarPerfilHVPorIARevision(this);\n    39→        }\n    40→    });\n    41→});\n    42→\n    43→/**\n    44→ * Cierra el modal de revisión de hoja de vida\n    45→ *\n    46→ * @returns {void}\n    47→ * @author Andres Gonzalez\n    48→ */\n    49→function cerrarModalRevisionHV() {\n    50→    $('#modal-aplicacion-revision-hv').modal('hide');\n    51→}\n    52→\n    53→/**\n    54→ * Abre el modal de revisión de hoja de vida\n    55→ *\n    56→ * @param {Object} datos_etapa - Datos de la etapa\n    57→ * @returns {void}\n    58→ * @author Andres Gonzalez\n    59→ */\n    60→function abrirModalRevisionHV(datos_etapa) {\n    61→    estudios = [];\n    62→    experiencias = [];\n    63→    indice_editar = null;\n    64→\n    65→    revision_hv_ia_activa = datos_etapa.configuracion_ia_hv == 1;\n    66→\n    67→    if (revision_hv_ia_activa) {\n    68→        $('#alerta-ia-revision-hv').removeClass('d-none');\n    69→    } else {\n    70→        $('#alerta-ia-revision-hv').addClass('d-none');\n    71→\n    72→        setTimeout(() => {\n    73→            crearPerfilManualmenteRevision();\n    74→        }, TIEMPO_FORMULARIO_MANUAL);\n    75→    }\n    76→\n    77→    // Limpiar contenedores\n    78→    $('#contenedor-niveles-educativos-revision').empty();\n    79→    $('#contenedor-experiencias-laborales-revision').empty();\n    80→    $('#contenedor-campos-perfil-revision').addClass('d-none');\n    81→    $('#contenedor-opciones-crear-ia-revision').removeClass('d-none');\n    82→\n    83→    // Sobreescribir temporalmente las funciones para este contexto\n    84→    window.validacionAdicional = validacionAdicionalRevisionHV;\n    85→    window.postSuccess = postSuccessRevisionHV;\n    86→\n    87→    configurarFormulario('formulario-revision-hv');\n    88→    configurarFormulario('formulario-nivel-educativo');\n    89→    configurarFormulario('formulario-experiencia-laboral');\n    90→\n    91→    $('#titulo-revision-hv').text(`Completa tu hoja de vida para: ${datos_etapa.vacante_nombre}`);\n    92→\n    93→    $('#revision_hv_etapa_vacante_usuario_id').val(datos_etapa.etapa_vacante_usuario_id || '');\n    94→    $('#revision_hv_vacante_id').val(datos_etapa.vacante_id || '');\n    95→    $('#revision_hv_etapa_id').val(datos_etapa.etapa_id || '');\n    96→\n    97→    let usuario_id = datos_etapa.usuario_id || $('#revision_hv_usuario_id').val();\n    98→    $('#revision_hv_usuario_id').val(usuario_id);\n    99→\n   100→    $('#modal-aplicacion-revision-hv').modal('show');\n   101→\n   102→    consultarPerfilLaboralUsuario();\n   103→\n   104→    // Inicializar componentes\n   105→    setTimeout(() => {\n   106→        inputsCleave();\n   107→        actualizarSelect2();\n   108→        inizializarMultiselect();\n   109→        inicializarTooltips();\n   110→        inicializarIputsFile();\n   111→\n   112→        // Limpiar espacios en blanco de habilidades y herramientas en tiempo real\n   113→        $('#revision_select_habilidades, #revision_select_herramientas_tecnologicas').on('change', function() {\n   114→            let valores = $(this).val();\n   115→            if (Array.isArray(valores)) {\n   116→                // Filtrar y limpiar espacios vacíos\n   117→                let valores_limpios = valores.filter(v => v && v.trim() !== '').map(v => v.trim());\n   118→                if (JSON.stringify(valores) !== JSON.stringify(valores_limpios)) {\n   119→                    $(this).val(valores_limpios).trigger('change.select2');\n   120→                }\n   121→            }\n   122→        });\n   123→\n   124→        configurarOverridesRevision();\n   125→    }, TIEMPO_INICIALIZACION_COMPONENTES);\n   126→}\n   127→\n   128→/**\n   129→ * Consulta el perfil laboral existente del usuario y pre-rellena el formulario\n   130→ *\n   131→ * @returns {void}\n   132→ * @author Andres Gonzalez\n   133→ */\n   134→function consultarPerfilLaboralUsuario() {\n   135→    let usuario_id = $('#revision_hv_usuario_id').val();\n   136→\n   137→    if (!usuario_id) {\n   138→        return;\n   139→    }\n   140→\n   141→    $.ajax({\n   142→        url: `/perfiles-laborales-consultar-usuario/${usuario_id}`,\n   143→        type: 'GET',\n   144→        success: function(respuesta) {\n   145→            if (respuesta.data) {\n   146→                preRellenarFormularioRevisionHV(respuesta.data);\n   147→            }\n   148→        },\n   149→        error: function(error) {}\n   150→    });\n   151→}\n   152→\n   153→/**\n   154→ * Pre-rellena el formulario de revisión HV con datos existentes\n   155→ *\n   156→ * @param {Object} perfil - Datos del perfil laboral\n   157→ * @returns {void}\n   158→ * @author Andres Gonzalez\n   159→ */\n   160→function preRellenarFormularioRevisionHV(perfil) {\n   161→    crearPerfilManualmenteRevision();\n   162→\n   163→    $('#id').val(perfil.id);\n   164→\n   165→    if (perfil.salario) {\n   166→        if (perfil.salario_maximo) {\n   167→            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n   168→            setTimeout(() => {\n   169→                $('#revision_salario').val(perfil.salario);\n   170→                $('#revision_salario_maximo').val(perfil.salario_maximo);\n   171→            }, 200);\n   172→        } else {\n   173→            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n   174→            setTimeout(() => {\n   175→                $('#revision_salario').val(perfil.salario);\n   176→            }, 200);\n   177→        }\n   178→    }\n   179→\n   180→    if (perfil.habilidades) {\n   181→        let habilidades_array = perfil.habilidades.split(',')\n   182→            .map(h => h.trim())\n   183→            .filter(h => h !== ''); // Filtrar elementos vacíos\n   184→        habilidades_array.forEach(habilidad => {\n   185→            if (habilidad) {\n   186→                let opcion = new Option(habilidad, habilidad, true, true);\n   187→                $('#revision_select_habilidades').append(opcion);\n   188→            }\n   189→        });\n   190→        $('#revision_select_habilidades').trigger('change');\n   191→    }\n   192→\n   193→    if (perfil.herramientas_tecnologicas) {\n   194→        let herramientas_array = perfil.herramientas_tecnologicas.split(',')\n   195→            .map(h => h.trim())\n   196→            .filter(h => h !== ''); // Filtrar elementos vacíos\n   197→        herramientas_array.forEach(herramienta => {\n   198→            if (herramienta) {\n   199→                let opcion = new Option(herramienta, herramienta, true, true);\n   200→                $('#revision_select_herramientas_tecnologicas').append(opcion);\n   201→            }\n   202→        });\n   203→        $('#revision_select_herramientas_tecnologicas').trigger('change');\n   204→    }\n   205→\n   206→    if (perfil.licencia_conducir) {\n   207→        $('#revision_opcion_licencia_conducir').prop('checked', true).trigger('change');\n   208→        setTimeout(() => {\n   209→            $('#revision_tipo_licencia').val(perfil.licencia_conducir).trigger('change');\n   210→        }, 100);\n   211→    }\n   212→\n   213→    if (perfil.estudios && perfil.estudios.length > 0) {\n   214→        estudios = perfil.estudios.map(estudio => ({\n   215→            nivel_educativo_id: estudio.nivel_educativo_id,\n   216→            nivel_educativo: estudio.nivel_educativo?.nombre || '',\n   217→            titulo: estudio.titulo,\n   218→            institucion_educativa: estudio.institucion_educativa,\n   219→            fecha_inicio: estudio.fecha_inicio,\n   220→            fecha_fin: estudio.fecha_fin,\n   221→            jornada: estudio.jornada,\n   222→            graduado: estudio.fecha_fin ? true : false\n   223→        }));\n   224→        mostrarNivelesEducativosRevision();\n   225→    }\n   226→\n   227→    if (perfil.experiencias_laborales && perfil.experiencias_laborales.length > 0) {\n   228→        experiencias = perfil.experiencias_laborales.map(exp => ({\n   229→            empresa: exp.empresa,\n   230→            cargo: exp.cargo,\n   231→            fecha_inicio: exp.fecha_inicio,\n   232→            fecha_fin: exp.fecha_fin,\n   233→            actualmente_trabajo: exp.fecha_fin ? 0 : 1,\n   234→            modalidad_trabajo_id: exp.modalidad_trabajo_id || null,\n   235→            funciones: exp.funciones || ''\n   236→        }));\n   237→        mostrarExperienciasLaboralesRevision();\n   238→        $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n   239→    } else {\n   240→        $('#revision_no_experiencia').prop('checked', true).trigger('change');\n   241→    }\n   242→\n   243→    if (perfil.idiomas && perfil.idiomas.length > 0) {\n   244→        let idiomas_ids = perfil.idiomas.map(idioma => idioma.idioma_id);\n   245→        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n   246→        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n   247→\n   248→        setTimeout(() => {\n   249→            perfil.idiomas.forEach(idioma => {\n   250→                $(`#nivel_idioma_${idioma.idioma_id}`).val(idioma.nivel).trigger('change');\n   251→            });\n   252→        }, 200);\n   253→    }\n   254→\n   255→    if (perfil.usuario && perfil.usuario.discapacidades && perfil.usuario.discapacidades.length > 0) {\n   256→        $('#revision_vacante_apta_discapacitados').prop('checked', true).trigger('change');\n   257→\n   258→        setTimeout(() => {\n   259→            let discapacidades_ids = perfil.usuario.discapacidades.map(disc => disc.id);\n   260→            $('#revision_select_discapacidades').val(discapacidades_ids).multiselect('refresh');\n   261→            seleccionarDiscapacidadRevision({name: 'revision_select_discapacidades'});\n   262→\n   263→            perfil.usuario.discapacidades.forEach(discapacidad => {\n   264→                if (discapacidad.id === 5 && discapacidad.pivot.otra_discapacidad) { // ID 5 = \"Otra\"\n   265→                    $('#revision_otra_discapacidad').val(discapacidad.pivot.otra_discapacidad);\n   266→                }\n   267→            });\n   268→        }, 200);\n   269→    }\n   270→\n   271→    // Reinicializar componentes después de rellenar\n   272→    setTimeout(() => {\n   273→        inputsCleave();\n   274→        actualizarSelect2();\n   275→    }, 300);\n   276→}\n   277→\n   278→/**\n   279→ * Configura los overrides de funciones globales para el contexto de revisión\n   280→ *\n   281→ * @returns {void}\n   282→ * @author Andres Gonzalez\n   283→ */\n   284→function configurarOverridesRevision() {\n   285→    if (!window.mostrarNivelesEducativos_original_revision) {\n   286→        window.mostrarNivelesEducativos_original_revision = window.mostrarNivelesEducativos;\n   287→    }\n   288→    if (!window.mostrarExperienciasLaborales_original_revision) {\n   289→        window.mostrarExperienciasLaborales_original_revision = window.mostrarExperienciasLaborales;\n   290→    }\n   291→\n   292→    window.mostrarNivelesEducativos = function() {\n   293→        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-niveles-educativos-revision').length > 0) {\n   294→            mostrarNivelesEducativosRevision();\n   295→        } else if (typeof window.mostrarNivelesEducativos_original_revision === 'function') {\n   296→            window.mostrarNivelesEducativos_original_revision();\n   297→        }\n   298→    };\n   299→\n   300→    window.mostrarExperienciasLaborales = function() {\n   301→        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-experiencias-laborales-revision').length > 0) {\n   302→            mostrarExperienciasLaboralesRevision();\n   303→        } else if (typeof window.mostrarExperienciasLaborales_original_revision === 'function') {\n   304→            window.mostrarExperienciasLaborales_original_revision();\n   305→        }\n   306→    };\n   307→}\n   308→\n   309→/**\n   310→ * Genera el perfil de HV usando IA (versión para revisión)\n   311→ *\n   312→ * @param {HTMLElement} input_archivo - Input de archivo\n   313→ * @returns {void}\n   314→ * @author Andres Gonzalez\n   315→ */\n   316→function generarPerfilHVPorIARevision(input_archivo) {\n   317→    if (!input_archivo.files || !input_archivo.files[0]) {\n   318→        return;\n   319→    }\n   320→\n   321→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   322→\n   323→    $('#modal-generando-ia-revision').modal('show');\n   324→\n   325→    $('#modal-generando-ia-revision').off('hidden.bs.modal.restaurar-ia').on('hidden.bs.modal.restaurar-ia', function() {\n   326→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   327→    });\n   328→\n   329→    let formulario = new FormData();\n   330→    formulario.append('archivo', input_archivo.files[0]);\n   331→    formulario.append('_method', 'POST');\n   332→    formulario.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n   333→\n   334→    const vacanteId = $('#revision_hv_vacante_id').val()\n   335→        || new URLSearchParams(window.location.search).get('vacante_id')\n   336→        || '';\n   337→    if (vacanteId) {\n   338→        formulario.append('vacante_id', vacanteId);\n   339→    }\n   340→\n   341→    $.ajax({\n   342→        url: '/perfiles-laborales-leer-hv-ia',\n   343→        type: 'POST',\n   344→        data: formulario,\n   345→        processData: false,\n   346→        contentType: false,\n   347→        success: function(respuesta) {\n   348→            $('#modal-generando-ia-revision').modal('hide');\n   349→            // Esperar a que se cierre el modal de IA antes de mostrar el principal\n   350→            setTimeout(() => {\n   351→                $('#modal-aplicacion-revision-hv').css('display', 'block');\n   352→            }, TIEMPO_MODAL_APERTURA);\n   353→\n   354→            if (respuesta.data) {\n   355→                // Mostrar formulario\n   356→                crearPerfilManualmenteRevision();\n   357→\n   358→                // Llenar habilidades desde la IA\n   359→                if (respuesta.data.habilidades) {\n   360→                    $('#revision_select_habilidades').val([]);\n   361→                    let habilidades_array = respuesta.data.habilidades.split(',').map(habilidad => habilidad.trim()).filter(habilidad => habilidad !== '');\n   362→                    habilidades_array.forEach(habilidad => {\n   363→                        if (habilidad) {\n   364→                            let opcion = new Option(habilidad, habilidad, true, true);\n   365→                            $('#revision_select_habilidades').append(opcion);\n   366→                        }\n   367→                    });\n   368→                    $('#revision_select_habilidades').trigger('change');\n   369→                }\n   370→\n   371→                // Llenar herramientas tecnológicas desde la IA\n   372→                if (respuesta.data.herramientas_tecnologicas) {\n   373→                    $('#revision_select_herramientas_tecnologicas').val([]);\n   374→                    let herramientas_array = respuesta.data.herramientas_tecnologicas.split(',').map(herramienta => herramienta.trim()).filter(herramienta => herramienta !== '');\n   375→                    herramientas_array.forEach(herramienta => {\n   376→                        if (herramienta) {\n   377→                            let opcion = new Option(herramienta, herramienta, true, true);\n   378→                            $('#revision_select_herramientas_tecnologicas').append(opcion);\n   379→                        }\n   380→                    });\n   381→                    $('#revision_select_herramientas_tecnologicas').trigger('change');\n   382→                }\n   383→\n   384→                // Llenar salario si existe\n   385→                if (respuesta.data.salario) {\n   386→                    $('#revision_salario').val(respuesta.data.salario);\n   387→                }\n   388→\n   389→                // Procesar estudios\n   390→                if (respuesta.data.estudios && Array.isArray(respuesta.data.estudios)) {\n   391→                    estudios = [];\n   392→                    respuesta.data.estudios.forEach(estudio => {\n   393→                        // Buscar el nivel educativo por nombre\n   394→                        let nivel_educativo_encontrado = niveles_educativos.find(function(nivel) {\n   395→                            return nivel.nombre.toLowerCase() === estudio.nivel_educativo.toLowerCase();\n   396→                        });\n   397→\n   398→                        estudios.push({\n   399→                            titulo: estudio.titulo,\n   400→                            institucion_educativa: estudio.institucion_educativa,\n   401→                            nivel_educativo_id: nivel_educativo_encontrado ? nivel_educativo_encontrado.id : null,\n   402→                            nivel_educativo: estudio.nivel_educativo,\n   403→                            fecha_inicio: estudio.fecha_inicio,\n   404→                            fecha_fin: estudio.fecha_fin || null,\n   405→                            jornada: estudio.jornada || 'Diurna',\n   406→                            graduado: estudio.fecha_fin ? true : false\n   407→                        });\n   408→                    });\n   409→                    mostrarNivelesEducativosRevision();\n   410→                }\n   411→\n   412→                // Procesar experiencias laborales\n   413→                if (respuesta.data.experiencias_laborales && Array.isArray(respuesta.data.experiencias_laborales)) {\n   414→                    experiencias = [];\n   415→                    respuesta.data.experiencias_laborales.forEach(experiencia => {\n   416→                        experiencias.push({\n   417→                            empresa: experiencia.empresa,\n   418→                            cargo: experiencia.cargo,\n   419→                            fecha_inicio: experiencia.fecha_inicio,\n   420→                            fecha_fin: experiencia.fecha_fin || null,\n   421→                            actualmente_trabajo: experiencia.fecha_fin ? 0 : 1,\n   422→                            modalidad_trabajo_id: experiencia.modalidad_trabajo_id || null,\n   423→                            funciones: experiencia.funciones || ''\n   424→                        });\n   425→                    });\n   426→                    mostrarExperienciasLaboralesRevision();\n   427→                    $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n   428→                }\n   429→\n   430→                // Procesar idiomas\n   431→                if (respuesta.data.idiomas && Array.isArray(respuesta.data.idiomas)) {\n   432→                    // Mapear nombres de idiomas de la IA a IDs del sistema\n   433→                    let idiomas_mapa = {\n   434→                        'Inglés': 1,\n   435→                        'Portugués': 2,\n   436→                        'Francés': 3,\n   437→                        'Alemán': 4,\n   438→                        'Mandarín': 5,\n   439→                        'Italiano': 6,\n   440→                        'Ruso': 7,\n   441→                        'Árabe': 8\n   442→                    };\n   443→\n   444→                    let idiomas_ids = [];\n   445→                    respuesta.data.idiomas.forEach(idioma_ia => {\n   446→                        let idioma_id = idiomas_mapa[idioma_ia.idioma];\n   447→                        if (idioma_id) {\n   448→                            idiomas_ids.push(idioma_id);\n   449→                        }\n   450→                    });\n   451→\n   452→                    if (idiomas_ids.length > 0) {\n   453→                        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n   454→                        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n   455→\n   456→                        setTimeout(() => {\n   457→                            respuesta.data.idiomas.forEach(idioma_ia => {\n   458→                                let idioma_id = idiomas_mapa[idioma_ia.idioma];\n   459→                                if (idioma_id) {\n   460→                                    $(`#nivel_idioma_${idioma_id}`).val(idioma_ia.nivel).trigger('change');\n   461→                                }\n   462→                            });\n   463→                        }, TIEMPO_TRIGGER_SELECT);\n   464→                    }\n   465→                }\n   466→\n   467→                revision_hv_ia_activa = false;\n   468→                mostrarToast('success', 'Datos extraídos correctamente. Por favor verifica y completa la información.');\n   469→            }\n   470→        },\n   471→        error: function(error) {\n   472→            $('#modal-generando-ia-revision').modal('hide');\n   473→\n   474→            setTimeout(() => {\n   475→                $('#modal-aplicacion-revision-hv').css('display', 'block');\n   476→            }, TIEMPO_MODAL_APERTURA);\n   477→            mostrarToast('danger', error.responseJSON?.message || 'Error al procesar el archivo con IA');\n   478→            console.error(error);\n   479→        }\n   480→    });\n   481→}\n   482→\n   483→/**\n   484→ * Muestra el formulario de perfil manualmente\n   485→ *\n   486→ * @returns {void}\n   487→ * @author Andres Gonzalez\n   488→ */\n   489→function crearPerfilManualmenteRevision() {\n   490→    $('#contenedor-campos-perfil-revision').removeClass('d-none');\n   491→    $('#contenedor-opciones-crear-ia-revision').addClass('d-none');\n   492→}\n   493→\n   494→/**\n   495→ * Abre el modal para agregar un nivel educativo\n   496→ *\n   497→ * @returns {void}\n   498→ * @author Andres Gonzalez\n   499→ */\n   500→function abrirModalNivelEducativoRevision() {\n   501→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   502→\n   503→    $('#modal-agregar-nivel-educativo').modal('show');\n   504→    limpiarFormulario('formulario-nivel-educativo');\n   505→    indice_editar = null;\n   506→\n   507→    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n   508→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   509→        limpiarFormulario('formulario-nivel-educativo');\n   510→        indice_editar = null;\n   511→    });\n   512→}\n   513→\n   514→/**\n   515→ * Abre el modal para agregar una experiencia laboral\n   516→ *\n   517→ * @returns {void}\n   518→ * @author Andres Gonzalez\n   519→ */\n   520→function abrirModalExperienciaLaboralRevision() {\n   521→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   522→\n   523→    $('#modal-agregar-experiencia-laboral').modal('show');\n   524→    limpiarFormulario('formulario-experiencia-laboral');\n   525→    indice_editar = null;\n   526→\n   527→    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n   528→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   529→        limpiarFormulario('formulario-experiencia-laboral');\n   530→        indice_editar = null;\n   531→    });\n   532→}\n   533→\n   534→/**\n   535→ * Maneja el toggle de \"no tengo experiencia\"\n   536→ *\n   537→ * @param {boolean} marcado - Estado del toggle\n   538→ * @returns {void}\n   539→ * @author Andres Gonzalez\n   540→ * @author Andres Morales\n   541→ */\n   542→function seleccionarNoTengoExperienciaRevision(marcado) {\n   543→    if (marcado) {\n   544→        $('#btn-agregar-experiencia-laboral-revision').addClass('d-none');\n   545→        experiencias = [];\n   546→        mostrarExperienciasLaboralesRevision();\n   547→    } else {\n   548→        $('#btn-agregar-experiencia-laboral-revision').removeClass('d-none');\n   549→    }\n   550→}\n   551→\n   552→/**\n   553→ * Cambia los campos de salario según el tipo seleccionado\n   554→ *\n   555→ * @param {string} tipo - Tipo de salario ('especifico' o 'rango')\n   556→ * @returns {void}\n   557→ * @author Andres Gonzalez\n   558→ */\n   559→function seleccionarSalarioRevision(tipo) {\n   560→    $('#contenedor-campos-salario-revision').empty();\n   561→    if (tipo == 'especifico') {\n   562→        $('#contenedor-campos-salario-revision').append(`\n   563→            <div class=\"col-12 col-md-6\">\n   564→                ${crearInput({\n   565→                    id: 'revision_salario',\n   566→                    name: 'salario',\n   567→                    class: 'cleave',\n   568→                    input_container_class: 'mb-0',\n   569→                    label: 'Cantidad',\n   570→                    placeholder: '',\n   571→                    min: 0,\n   572→                    step: 0.01,\n   573→                    required: true,\n   574→                    minlength: 3,\n   575→                    maxlength: 10,\n   576→                    data: [{\n   577→                        texto: 'simbolo-cleave',\n   578→                        value: ''\n   579→                    }],\n   580→                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   581→                })}\n   582→            </div>\n   583→        `);\n   584→    } else if (tipo == 'rango') {\n   585→        $('#contenedor-campos-salario-revision').append(`\n   586→            <div class=\"col-12 col-md-6\">\n   587→                ${crearInput({\n   588→                    id: 'revision_salario',\n   589→                    name: 'salario',\n   590→                    class: 'cleave',\n   591→                    input_container_class: 'mb-0',\n   592→                    label: 'Desde',\n   593→                    placeholder: '',\n   594→                    step: 0.01,\n   595→                    required: true,\n   596→                    minlength: 3,\n   597→                    maxlength: 10,\n   598→                    onkeyup: 'validarRangoSalarioRevision()',\n   599→                    data: [{\n   600→                        texto: 'simbolo-cleave',\n   601→                        value: ''\n   602→                    }],\n   603→                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   604→                })}\n   605→            </div>\n   606→            <div class=\"col-12 col-md-6\">\n   607→                ${crearInput({\n   608→                    id: 'revision_salario_maximo',\n   609→                    name: 'salario_maximo',\n   610→                    class: 'cleave',\n   611→                    input_container_class: 'mb-0',\n   612→                    label: 'Hasta',\n   613→                    placeholder: '',\n   614→                    min: 0,\n   615→                    step: 0.01,\n   616→                    required: true,\n   617→                    minlength: 3,\n   618→                    maxlength: 10,\n   619→                    onkeyup: 'validarRangoSalarioRevision()',\n   620→                    data: [{\n   621→                        texto: 'simbolo-cleave',\n   622→                        value: ''\n   623→                    }],\n   624→                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n   625→                })}\n   626→            </div>\n   627→        `);\n   628→    }\n   629→    setTimeout(() => {\n   630→        inputsCleave();\n   631→        actualizarSelect2();\n   632→        configurarFormulario('formulario-revision-hv');\n   633→    }, 100);\n   634→}\n   635→\n   636→/**\n   637→ * Maneja la selección de idiomas\n   638→ *\n   639→ * @param {HTMLElement} elemento - Elemento del multiselect\n   640→ * @returns {void}\n   641→ * @author Andres Gonzalez\n   642→ */\n   643→function seleccionarIdiomaRevision(elemento) {\n   644→    let niveles = [];\n   645→    $('input[name=\"multiselect_' + elemento.name + '\"]:checked').each(function () {\n   646→        niveles.push({\n   647→            id: parseInt($(this).val()),\n   648→            nombre: $(this).closest('label').find('span').text().trim(),\n   649→        });\n   650→    });\n   651→    let campos_idiomas = '';\n   652→    for (let i = 0; i < niveles.length; i++) {\n   653→        campos_idiomas += `\n   654→            <div class=\"col-12 col-lg-6 mt-3\">\n   655→                <div class=\"text-headline-6 text-gray-10\">${niveles[i].nombre}</div>\n   656→                ${crearSelect2({\n   657→                    opciones: niveles_idiomas,\n   658→                    id: 'nivel_idioma_' + niveles[i].id,\n   659→                    name: 'nivel_idioma_' + niveles[i].id,\n   660→                    class: 'input-dinamico nivel-idioma',\n   661→                    input_container_class: 'mt-2 mb-0',\n   662→                    label: 'Nivel',\n   663→                    value: $('#nivel_idioma_' + niveles[i].id).val(),\n   664→                    required: true,\n   665→                })}\n   666→            </div>\n   667→            <input type=\"hidden\" value=\"${niveles[i].id}\" class=\"input-dinamico idioma\">\n   668→        `;\n   669→    }\n   670→    $('#contenedor-idiomas-revision').empty();\n   671→    $('#contenedor-idiomas-revision').append(campos_idiomas);\n   672→    actualizarSelect2();\n   673→}\n   674→\n   675→/**\n   676→ * Maneja el toggle de licencia de conducir\n   677→ *\n   678→ * @param {HTMLElement} elemento - Elemento del toggle\n   679→ * @returns {void}\n   680→ * @author Andres Gonzalez\n   681→ */\n   682→function seleccionarLicenciaConducirRevision(elemento) {\n   683→    let marcado = $(elemento).prop('checked');\n   684→    if (!marcado) {\n   685→        $('#revision_tipo_licencia').val('').trigger('change').trigger('select2:select');\n   686→    }\n   687→    $('#revision_tipo_licencia').prop('disabled', !marcado);\n   688→}\n   689→\n   690→/**\n   691→ * Maneja el toggle de discapacidad\n   692→ *\n   693→ * @param {boolean} posee_discapacidad - Si tiene discapacidad\n   694→ * @returns {void}\n   695→ * @author Andres Gonzalez\n   696→ */\n   697→function seleccionarTengoDiscapacidadRevision(posee_discapacidad) {\n   698→    $('#contenedor-discapacidad-revision').empty();\n   699→    if (posee_discapacidad) {\n   700→        $('#contenedor-discapacidad-revision').append(`\n   701→            <div class=\"col-12 p-4 border rounded-3\">\n   702→                <div class=\"row align-items-center pb-2\">\n   703→                    <div class=\"col-12\">\n   704→                        <label class=\"form-label fw-semibold\">Discapacidad</label>\n   705→                    </div>\n   706→                    <div class=\"col-6\">\n   707→                        ${crearMultiselect({\n   708→                            opciones: discapacidades,\n   709→                            id: 'revision_select_discapacidades',\n   710→                            name: 'revision_select_discapacidades',\n   711→                            class: 'input-dinamico',\n   712→                            input_container_class: 'mb-0',\n   713→                            placeholder: 'Discapacidad',\n   714→                            onchange: 'seleccionarDiscapacidadRevision(this.value)',\n   715→                            required: true,\n   716→                        })}\n   717→                    </div>\n   718→                    <div class=\"col-6\" id=\"contenedor-otra-discapacidad-revision\"></div>\n   719→                </div>\n   720→            </div>\n   721→        `);\n   722→        inizializarMultiselect();\n   723→    }\n   724→}\n   725→\n   726→/**\n   727→ * Maneja la selección de tipo de discapacidad\n   728→ *\n   729→ * @param {string} discapacidad_id - ID de la discapacidad\n   730→ * @returns {void}\n   731→ * @author Andres Gonzalez\n   732→ */\n   733→function seleccionarDiscapacidadRevision(discapacidad_id) {\n   734→    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val() || [];\n   735→    if (discapacidades_seleccionadas.includes('5')) {\n   736→        let otra_discapacidad_existente = $('#revision_otra_discapacidad').length > 0;\n   737→        if (!otra_discapacidad_existente) {\n   738→            $('#contenedor-otra-discapacidad-revision').append(`\n   739→                ${crearInput({\n   740→                    id: 'revision_otra_discapacidad',\n   741→                    name: 'revision_otra_discapacidad',\n   742→                    class: 'input-dinamico',\n   743→                    input_container_class: 'mb-0',\n   744→                    label: '¿Cuál?',\n   745→                    required: true,\n   746→                })}\n   747→            `);\n   748→        }\n   749→    } else {\n   750→        $('#contenedor-otra-discapacidad-revision').empty();\n   751→    }\n   752→}\n   753→\n   754→/**\n   755→ * Muestra los niveles educativos agregados (reutiliza lógica de crear.js)\n   756→ *\n   757→ * @returns {void}\n   758→ * @author Andres Gonzalez\n   759→ * @author Jair Carvajal\n   760→ */\n   761→function mostrarNivelesEducativosRevision() {\n   762→    $('#contenedor-niveles-educativos-revision').empty();\n   763→    if (estudios.length > 0) {\n   764→        // Ordenar estudios usando función global reutilizable\n   765→        let estudios_ordenados = ordenarEstudiosPorFecha(estudios);\n   766→\n   767→        estudios_ordenados.forEach((estudio) => {\n   768→            $('#contenedor-niveles-educativos-revision').append(`\n   769→                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"nivel-educativo-revision-${estudio.indice_original}\">\n   770→                    <div class=\"row mb-2\">\n   771→                        <div class=\"col-12 col-lg\">\n   772→                            <p class=\"mb-1 fw-bold text-gray-20\">${estudio.titulo}</p>\n   773→                            <p class=\"text-body-3 mb-1\">\n   774→                                ${estudio.fecha_inicio || estudio.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n   775→                                ${estudio.fecha_inicio ? moment(estudio.fecha_inicio).format(\"MMM YYYY\") : ''}\n   776→                                ${estudio.fecha_inicio && !estudio.fecha_fin ? ' - Actualmente' : estudio.fecha_fin ? ` - ${moment(estudio.fecha_fin).format(\"MMM YYYY\")}` : ''}\n   777→                                ${estudio.jornada ? ` - ${estudio.jornada}` : ''}\n   778→                            </p>\n   779→                            <p class=\"text-body-3 mb-1\"><i class=\"bi bi-buildings text-headline-5 me-2\"></i> ${estudio.institucion_educativa}</p>\n   780→                        </div>\n   781→                        <div class=\"col-auto\">\n   782→                            <div class=\"row justify-content-end\">\n   783→                                <div class=\"col-auto ps-0\">\n   784→                                    ${crearBoton({\n   785→                                        clases: 'btn-outline-primary btn-circle',\n   786→                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n   787→                                        onclick: `editarNivelEducativoRevision(${estudio.indice_original})`\n   788→                                    })}\n   789→                                </div>\n   790→                                <div class=\"col-auto ps-0\">\n   791→                                    ${crearBoton({\n   792→                                        clases: 'btn-outline-danger btn-circle',\n   793→                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n   794→                                        onclick: `eliminarNivelEducativoRevision(${estudio.indice_original})`\n   795→                                    })}\n   796→                                </div>\n   797→                            </div>\n   798→                        </div>\n   799→                        <div class=\"col-12 mt-3\">\n   800→                            <div class=\"row justify-content-between\">\n   801→                                <div class=\"col-auto\">\n   802→                                    <p class=\"text-body-3 text-gray-10 mb-0\">${estudio.nivel_educativo || ''}</p>\n   803→                                </div>\n   804→                                <div class=\"col-auto\">\n   805→                                    <div class=\"row justify-content-end align-items-center\">\n   806→                                        ${estudio.graduado ? `\n   807→                                            <div class=\"col-auto pe-0\">\n   808→                                                <i class=\"bi bi-mortarboard text-headline-5 text-cta-blue\"></i>\n   809→                                            </div>\n   810→                                            <div class=\"col-auto text-body-3 text-gray-10\">\n   811→                                                Graduado\n   812→                                            </div>\n   813→                                        ` : `\n   814→                                            <div class=\"col-auto pe-0\">\n   815→                                                <i class=\"bi ${estudio.jornada == 'Diurna' ? 'bi-sun' : estudio.jornada == 'Nocturna' ? 'bi-moon' : ''} text-headline-5 text-cta-blue\"></i>\n   816→                                            </div>\n   817→                                            <div class=\"col-auto text-body-3 text-gray-10\">\n   818→                                                ${estudio.jornada ? 'Modalidad:' : ''} ${estudio.jornada || ''}\n   819→                                            </div>\n   820→                                        `}\n   821→                                    </div>\n   822→                                </div>\n   823→                            </div>\n   824→                        </div>\n   825→                    </div>\n   826→                </div>\n   827→            `);\n   828→        });\n   829→    }\n   830→}\n   831→\n   832→/**\n   833→ * Muestra las experiencias laborales agregadas\n   834→ *\n   835→ * @returns {void}\n   836→ * @author Andres Gonzalez\n   837→ */\n   838→function mostrarExperienciasLaboralesRevision() {\n   839→    $('#contenedor-experiencias-laborales-revision').empty();\n   840→    if (experiencias.length > 0) {\n   841→        $('#revision_no_experiencia').prop('disabled', true);\n   842→        // Ordenar experiencias usando función global reutilizable\n   843→        let experiencias_ordenadas = ordenarExperienciasPorFecha(experiencias);\n   844→\n   845→        experiencias_ordenadas.forEach((experiencia) => {\n   846→            let modalidades = {1: 'Presencial', 2: 'Híbrido', 3: 'Remoto'};\n   847→            let html_modalidad = experiencia.modalidad_trabajo_id ? `\n   848→                <div class=\"mt-2\">\n   849→                    <small class=\"text-gray-30\">Modalidad:</small>\n   850→                    <span class=\"badge bg-primary ms-2\">${modalidades[experiencia.modalidad_trabajo_id]}</span>\n   851→                </div>\n   852→            ` : '';\n   853→            let html_funciones = experiencia.funciones ? `\n   854→                <div class=\"mt-2\">\n   855→                    <small class=\"text-gray-30 d-block\">Funciones:</small>\n   856→                    <p class=\"text-body-3 mb-0\">${experiencia.funciones}</p>\n   857→                </div>\n   858→            ` : '';\n   859→            $('#contenedor-experiencias-laborales-revision').append(`\n   860→                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"experiencia-laboral-revision-${experiencia.indice_original}\">\n   861→                    <div class=\"row mb-2\">\n   862→                        <div class=\"col-lg\">\n   863→                            <p class=\"mb-1 fw-bold text-gray-20\">${experiencia.cargo}</p>\n   864→                            <p class=\"text-body-3 mb-2\">\n   865→                                ${experiencia.fecha_inicio || experiencia.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n   866→                                ${experiencia.fecha_inicio ? moment(experiencia.fecha_inicio).format(\"MMM YYYY\") + (experiencia.fecha_fin ? ` - ${moment(experiencia.fecha_fin).format(\"MMM YYYY\")}` : \" - Actualmente\") : \"\"}\n   867→                                ${experiencia.fecha_inicio && experiencia.fecha_fin ? (() => {\n   868→                                    let inicio = moment(experiencia.fecha_inicio);\n   869→                                    let fin = moment(experiencia.fecha_fin);\n   870→                                    let anios = fin.diff(inicio, 'years');\n   871→                                    let meses = fin.diff(inicio.add(anios, 'years'), 'months');\n   872→                                    let texto = '';\n   873→                                    if (anios > 0) texto += `${anios} año${anios > 1 ? 's' : ''}`;\n   874→                                    if (meses > 0) texto += `${anios > 0 ? ' y ' : ''}${meses} mes${meses > 1 ? 'es' : ''}`;\n   875→                                    return texto ? ` | ${texto}` : '';\n   876→                                })() : ''}\n   877→                            </p>\n   878→                            <p class=\"text-body-3 mb-1 fw-semibold text-gray-10\">${experiencia.empresa}</p>\n   879→                            ${html_modalidad}\n   880→                            ${html_funciones}\n   881→                        </div>\n   882→                        <div class=\"col-auto\">\n   883→                            <div class=\"row justify-content-end\">\n   884→                                <div class=\"col-auto ps-0\">\n   885→                                    ${crearBoton({\n   886→                                        clases: 'btn-outline-primary btn-circle',\n   887→                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n   888→                                        onclick: `editarExperienciaLaboralRevision(${experiencia.indice_original})`\n   889→                                    })}\n   890→                                </div>\n   891→                                <div class=\"col-auto ps-0\">\n   892→                                    ${crearBoton({\n   893→                                        clases: 'btn-outline-danger btn-circle',\n   894→                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n   895→                                        onclick: `eliminarExperienciaLaboralRevision(${experiencia.indice_original})`\n   896→                                    })}\n   897→                                </div>\n   898→                            </div>\n   899→                        </div>\n   900→                    </div>\n   901→                </div>\n   902→            `);\n   903→        });\n   904→    } else {\n   905→        $('#revision_no_experiencia').prop('disabled', false);\n   906→    }\n   907→}\n   908→\n   909→/**\n   910→ * Edita un nivel educativo existente (reutiliza variables de crear.js)\n   911→ *\n   912→ * @param {number} indice - Índice del nivel educativo a editar\n   913→ * @returns {void}\n   914→ * @author Andres Gonzalez\n   915→ */\n   916→function editarNivelEducativoRevision(indice) {\n   917→    indice_editar = indice;\n   918→    let estudio = estudios[indice];\n   919→    $('#titulo').val(estudio.titulo);\n   920→    $('#institucion_educativa').val(estudio.institucion_educativa);\n   921→    $('#cursando_estudios').prop('checked', !estudio.graduado).trigger('change');\n   922→    $('#nivel_educativo_id').val(estudio.nivel_educativo_id).trigger('change');\n   923→    $('#fecha_inicio_estudio')[0]._flatpickr.setDate(estudio.fecha_inicio);\n   924→    if ($('#fecha_fin_estudio').length > 0) {\n   925→        $('#fecha_fin_estudio')[0]._flatpickr.setDate(estudio.fecha_fin || '');\n   926→    }\n   927→\n   928→    // Ocultar el modal principal temporalmente sin destruirlo\n   929→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   930→\n   931→    // Abrir el modal secundario\n   932→    $('#modal-agregar-nivel-educativo').modal('show');\n   933→\n   934→    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n   935→    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n   936→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   937→        limpiarFormulario('formulario-nivel-educativo');\n   938→        indice_editar = null;\n   939→    });\n   940→}\n   941→\n   942→/**\n   943→ * Elimina un nivel educativo (reutiliza array de crear.js)\n   944→ *\n   945→ * @param {number} indice - Índice del nivel educativo a eliminar\n   946→ * @returns {void}\n   947→ * @author Andres Gonzalez\n   948→ */\n   949→function eliminarNivelEducativoRevision(indice) {\n   950→    estudios.splice(indice, 1);\n   951→    mostrarNivelesEducativosRevision();\n   952→    mostrarToast('success', 'Nivel educativo eliminado exitosamente');\n   953→}\n   954→\n   955→/**\n   956→ * Edita una experiencia laboral existente (reutiliza variables de crear.js)\n   957→ *\n   958→ * @param {number} indice - Índice de la experiencia laboral a editar\n   959→ * @returns {void}\n   960→ * @author Andres Gonzalez\n   961→ */\n   962→function editarExperienciaLaboralRevision(indice) {\n   963→    indice_editar = indice;\n   964→    let experiencia = experiencias[indice];\n   965→    $('#cargo').val(experiencia.cargo);\n   966→    $('#empresa').val(experiencia.empresa);\n   967→    $('#actualmente_trabajo').prop('checked', experiencia.actualmente_trabajo).trigger('change');\n   968→    $('#fecha_inicio_experiencia')[0]._flatpickr.setDate(experiencia.fecha_inicio);\n   969→    if ($('#fecha_fin_experiencia').length) {\n   970→        $('#fecha_fin_experiencia')[0]._flatpickr.setDate(experiencia.fecha_fin || '');\n   971→    }\n   972→    $('#modalidad_trabajo_id').val(experiencia.modalidad_trabajo_id || '').trigger('change');\n   973→    $('#funciones').val(experiencia.funciones || '');\n   974→\n   975→    // Ocultar el modal principal temporalmente sin destruirlo\n   976→    $('#modal-aplicacion-revision-hv').css('display', 'none');\n   977→\n   978→    // Abrir el modal secundario\n   979→    $('#modal-agregar-experiencia-laboral').modal('show');\n   980→\n   981→    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n   982→    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n   983→        $('#modal-aplicacion-revision-hv').css('display', 'block');\n   984→        limpiarFormulario('formulario-experiencia-laboral');\n   985→        indice_editar = null;\n   986→    });\n   987→}\n   988→\n   989→/**\n   990→ * Elimina una experiencia laboral (reutiliza array de crear.js)\n   991→ *\n   992→ * @param {number} indice - Índice de la experiencia laboral a eliminar\n   993→ * @returns {void}\n   994→ * @author Andres Gonzalez\n   995→ */\n   996→function eliminarExperienciaLaboralRevision(indice) {\n   997→    experiencias.splice(indice, 1);\n   998→    mostrarExperienciasLaboralesRevision();\n   999→    mostrarToast('success', 'Experiencia laboral eliminada exitosamente');\n  1000→}\n  1001→\n  1002→/**\n  1003→ * Validación adicional para formularios de revisión de HV\n  1004→ * Esta función es llamada automáticamente por configurarFormulario()\n  1005→ * Maneja: formulario-revision-hv, formulario-nivel-educativo, formulario-experiencia-laboral\n  1006→ *\n  1007→ * @param {string} formulario - ID del formulario a validar\n  1008→ * @returns {boolean}\n  1009→ * @author Andres Gonzalez\n  1010→ */\n  1011→function validacionAdicionalRevisionHV(formulario) {\n  1012→    let valido = true;\n  1013→\n  1014→    if (formulario == 'formulario-nivel-educativo') {\n  1015→        let errores = $('#formulario-nivel-educativo').find('input.error , select.error , textarea.error');\n  1016→        if (errores.length == 0) {\n  1017→            let fecha_inicio = $('#fecha_inicio_estudio').val() ? moment($('#fecha_inicio_estudio').val(), 'YYYY-MM-DD') : null;\n  1018→            let fecha_fin = $('#fecha_fin_estudio').val() ? moment($('#fecha_fin_estudio').val(), 'YYYY-MM-DD') : null;\n  1019→            let fecha_actual = moment();\n  1020→\n  1021→            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n  1022→                mostrarToast('danger', 'La fecha de inicio del estudio no puede ser una fecha futura.');\n  1023→                valido = false;\n  1024→            }\n  1025→            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n  1026→                mostrarToast('danger', 'La fecha de finalización del estudio no puede ser una fecha futura.');\n  1027→                valido = false;\n  1028→            }\n  1029→            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n  1030→                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n  1031→                valido = false;\n  1032→            }\n  1033→\n  1034→            if (valido) {\n  1035→                let estudio = {\n  1036→                    titulo: $('#titulo').val(),\n  1037→                    institucion_educativa: $('#institucion_educativa').val(),\n  1038→                    nivel_educativo_id: parseInt($('#nivel_educativo_id').val()),\n  1039→                    nivel_educativo: $('#nivel_educativo_id option:selected').text().trim(),\n  1040→                    graduado: $('#cursando_estudios').prop('checked') ? false : true,\n  1041→                    fecha_inicio: $('#fecha_inicio_estudio').val(),\n  1042→                    fecha_fin: $('#fecha_fin_estudio').val() || null,\n  1043→                    jornada: $('#jornada').val() || null,\n  1044→                }\n  1045→                if (indice_editar == null) {\n  1046→                    estudios.push(estudio);\n  1047→                } else {\n  1048→                    estudios[indice_editar] = estudio;\n  1049→                    indice_editar = null;\n  1050→                }\n  1051→                mostrarNivelesEducativosRevision();\n  1052→                $('#modal-agregar-nivel-educativo').modal('hide');\n  1053→                mostrarToast('success', 'Nivel educativo guardado exitosamente');\n  1054→            }\n  1055→        }\n  1056→        return false;\n  1057→    }\n  1058→\n  1059→    if (formulario == 'formulario-experiencia-laboral') {\n  1060→        let errores = $('#formulario-experiencia-laboral').find('input.error , select.error , textarea.error');\n  1061→        if (errores.length == 0) {\n  1062→            let fecha_inicio = $('#fecha_inicio_experiencia').val() ? moment($('#fecha_inicio_experiencia').val(), 'YYYY-MM-DD') : null;\n  1063→            let fecha_fin = $('#fecha_fin_experiencia').val() ? moment($('#fecha_fin_experiencia').val(), 'YYYY-MM-DD') : null;\n  1064→            let fecha_actual = moment();\n  1065→\n  1066→            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n  1067→                mostrarToast('danger', 'La fecha de inicio de la experiencia no puede ser una fecha futura.');\n  1068→                valido = false;\n  1069→            }\n  1070→            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n  1071→                mostrarToast('danger', 'La fecha de finalización de la experiencia no puede ser una fecha futura.');\n  1072→                valido = false;\n  1073→            }\n  1074→            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n  1075→                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n  1076→                valido = false;\n  1077→            }\n  1078→\n  1079→            if (valido) {\n  1080→                let modalidad_trabajo_id = $('#modalidad_trabajo_id').val();\n  1081→                let experiencia = {\n  1082→                    cargo: $('#cargo').val(),\n  1083→                    empresa: $('#empresa').val(),\n  1084→                    actualmente_trabajo: $('#actualmente_trabajo').prop('checked') ? 1 : 0,\n  1085→                    fecha_inicio: $('#fecha_inicio_experiencia').val(),\n  1086→                    fecha_fin: $('#fecha_fin_experiencia').val() || null,\n  1087→                    modalidad_trabajo_id: modalidad_trabajo_id ? parseInt(modalidad_trabajo_id) : null,\n  1088→                    funciones: $('#funciones').val() || '',\n  1089→                }\n  1090→                if (indice_editar == null) {\n  1091→                    experiencias.push(experiencia);\n  1092→                } else {\n  1093→                    experiencias[indice_editar] = experiencia;\n  1094→                    indice_editar = null;\n  1095→                }\n  1096→                mostrarExperienciasLaboralesRevision();\n  1097→                $('#modal-agregar-experiencia-laboral').modal('hide');\n  1098→                mostrarToast('success', 'Experiencia laboral guardada exitosamente');\n  1099→            }\n  1100→        }\n  1101→        return false;\n  1102→    }\n  1103→\n  1104→    if (formulario !== 'formulario-revision-hv') {\n  1105→        return true;\n  1106→    }\n  1107→\n  1108→    let errores = $('#formulario-revision-hv').find('input.error , select.error , textarea.error');\n  1109→    if (errores.length > 0) {\n  1110→        mostrarToast('danger', 'Faltan algunos datos obligatorios. Por favor, revisa la información e intenta nuevamente');\n  1111→        return false;\n  1112→    }\n  1113→\n  1114→    let salario = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n  1115→    if (salario < 0) {\n  1116→        mostrarToast('danger', 'El salario no puede ser un valor negativo.');\n  1117→        valido = false;\n  1118→    }\n  1119→\n  1120→    if ($('#revision_salario_maximo').length > 0) {\n  1121→        let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n  1122→        if (salario_maximo < 0) {\n  1123→            mostrarToast('danger', 'El salario máximo no puede ser un valor negativo.');\n  1124→            valido = false;\n  1125→        }\n  1126→        if (salario_maximo < salario) {\n  1127→            if (salario_maximo > 0) {\n  1128→                mostrarToast('danger', 'El salario máximo no puede ser menor que el salario mínimo.');\n  1129→            }\n  1130→            valido = false;\n  1131→        }\n  1132→    }\n  1133→\n  1134→    validarRangoSalarioRevision();\n  1135→\n  1136→    let habilidades_seleccionadas = $('#revision_select_habilidades').val();\n  1137→    $('#revision_hv_habilidades').val(Array.isArray(habilidades_seleccionadas) ? habilidades_seleccionadas.join(', ') : '');\n  1138→\n  1139→    let herramientas_seleccionadas = $('#revision_select_herramientas_tecnologicas').val();\n  1140→    $('#revision_hv_herramientas_tecnologicas').val(Array.isArray(herramientas_seleccionadas) ? herramientas_seleccionadas.join(', ') : '');    \n  1141→    $('#revision_hv_estudios').val(JSON.stringify(estudios.map(({ nivel_educativo, graduado, ...estudio }) => estudio)));\n  1142→\n  1143→    if (experiencias.length > 0) {\n  1144→        $('#revision_hv_experiencias_laborales').val(JSON.stringify(experiencias.map(({ actualmente_trabajo, ...experiencia }) => experiencia)));\n  1145→    } else {\n  1146→        $('#revision_hv_experiencias_laborales').val('');\n  1147→    }\n  1148→\n  1149→    let elementos_idiomas = $('.idioma');\n  1150→    let niveles = $('.nivel-idioma');\n  1151→    let idiomas_seleccionados = [];\n  1152→    for (let i = 0; i < elementos_idiomas.length; i++) {\n  1153→        idiomas_seleccionados.push({\n  1154→            idioma_id: parseInt($(elementos_idiomas[i]).val()),\n  1155→            nivel: $(niveles[i]).val()\n  1156→        });\n  1157→    }\n  1158→    if (idiomas_seleccionados.length == 0) {\n  1159→        $('#revision_hv_idiomas').val('');\n  1160→    } else {\n  1161→        $('#revision_hv_idiomas').val(JSON.stringify(idiomas_seleccionados));\n  1162→    }\n  1163→\n  1164→    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val();\n  1165→    let discapacidades_finales = [];\n  1166→    let usuario_id = parseInt($('#revision_hv_usuario_id').val());\n  1167→    if (discapacidades_seleccionadas) {\n  1168→        discapacidades_seleccionadas.forEach(discapacidad_id => {\n  1169→            let discapacidad = discapacidades.find(d => d.id == discapacidad_id);\n  1170→            if (discapacidad) {\n  1171→                let otra_discapacidad = null;\n  1172→                if (discapacidad.id == '5') {\n  1173→                    otra_discapacidad = $('#revision_otra_discapacidad').val().trim();\n  1174→                }\n  1175→                discapacidades_finales.push({\n  1176→                    usuario_id: usuario_id,\n  1177→                    discapacidad_id: parseInt(discapacidad_id),\n  1178→                    otra_discapacidad: otra_discapacidad\n  1179→                });\n  1180→            }\n  1181→        });\n  1182→        $('#revision_hv_discapacidades').val(JSON.stringify(discapacidades_finales));\n  1183→    } else {\n  1184→        $('#revision_hv_discapacidades').val('');\n  1185→    }\n  1186→\n  1187→    if (estudios.length == 0) {\n  1188→        mostrarToast('danger', 'Debes agregar al menos un nivel educativo para continuar.');\n  1189→        valido = false;\n  1190→    }\n  1191→\n  1192→    valido = validarFechasInicio(estudios);\n  1193→\n  1194→    if (experiencias.length == 0 && !$('#revision_no_experiencia').prop('checked')) {\n  1195→        mostrarToast('danger', 'Debes agregar al menos una experiencia laboral para continuar.');\n  1196→        valido = false;\n  1197→    }\n  1198→\n  1199→    return valido;\n  1200→}\n  1201→\n  1202→/**\n  1203→ * Callback después de enviar exitosamente el formulario de revisión HV\n  1204→ *\n  1205→ * @param {Object} respuesta - Respuesta del servidor\n  1206→ * @returns {void}\n  1207→ * @author Andres Gonzalez\n  1208→ */\n  1209→function postSuccessRevisionHV(respuesta) {\n  1210→    $('#modal-aplicacion-revision-hv').modal('hide');\n  1211→    limpiarFormularioRevisionHV();\n  1212→\n  1213→    // Recargar la tabla de tareas pendientes\n  1214→    actualizarDatatables('tabla-tareas-pendientes');\n  1215→}\n  1216→\n  1217→/**\n  1218→ * Función para validar las fechas de inicio\n  1219→ *\n  1220→ * @param {Object} estudios - estudios del aplicante\n  1221→ * @returns {boolean}\n  1222→ * @author Jair Carvajal\n  1223→ */\n  1224→function validarFechasInicio(estudios) {\n  1225→    let error = true;\n  1226→    for (const ESTUDIO of estudios) {\n  1227→        if (ESTUDIO.fecha_inicio === null) {\n  1228→            mostrarToast('danger', `El título ${ESTUDIO.titulo}. le hace falta la fecha de inicio para continuar.`);\n  1229→            error = false;\n  1230→        }\n  1231→    }\n  1232→    return error;\n  1233→}\n  1234→\n  1235→/**\n  1236→ * Valida el rango de salario\n  1237→ *\n  1238→ * @returns {boolean}\n  1239→ * @author Andres Gonzalez\n  1240→ */\n  1241→function validarRangoSalarioRevision() {\n  1242→    if ($('input[name=\"tipo_salario\"]:checked').val() !== 'rango') {\n  1243→        return true;\n  1244→    }\n  1245→    let salario_desde = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n  1246→    let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n  1247→    let campo_hasta = $('#revision_salario_maximo');\n  1248→    let contenedor_hasta = campo_hasta.closest('.input-container');\n  1249→    campo_hasta.removeClass('error');\n  1250→    contenedor_hasta.siblings('label[for=\"revision_salario_maximo\"].error').remove();\n  1251→    if (salario_desde > 99 && salario_maximo > 99 && salario_desde >= salario_maximo) {\n  1252→        setTimeout(() => {\n  1253→            campo_hasta.addClass('error');\n  1254→            contenedor_hasta.after('<label for=\"revision_salario_maximo\" class=\"error text-red-cta\">El salario hasta no debe ser menor o igual al salario desde</label>');\n  1255→            return false;\n  1256→        }, 100);\n  1257→    }\n  1258→    return true;\n  1259→}\n  1260→\n  1261→/**\n  1262→ * Limpiar formulario\n  1263→ *\n  1264→ * @returns {void}\n  1265→ * @author Andres Gonzalez\n  1266→ */\n  1267→function limpiarFormularioRevisionHV() {\n  1268→    let formulario = $('#formulario-revision-hv');\n  1269→    formulario[0].reset();\n  1270→    formulario.find('.input-dinamico').removeClass('error');\n  1271→    formulario.find('label.error').remove();\n  1272→\n  1273→    $('#contenedor-idiomas-revision').empty();\n  1274→    $('#contenedor-discapacidad-revision').empty();\n  1275→    $('#contenedor-niveles-educativos-revision').empty();\n  1276→    $('#contenedor-experiencias-laborales-revision').empty();\n  1277→\n  1278→    $('#revision_select_habilidades').val('').trigger('change');\n  1279→    $('#revision_select_herramientas_tecnologicas').val('').trigger('change');\n  1280→    $('#revision_idiomas_seleccionados').val([]).multiselect('refresh');\n  1281→    $('#revision_select_discapacidades').val([]).multiselect('refresh');\n  1282→\n  1283→    $('#revision_opcion_licencia_conducir').prop('checked', false);\n  1284→    $('#revision_tipo_licencia').val('').prop('disabled', true).trigger('change');\n  1285→    $('#revision_vacante_apta_discapacitados').prop('checked', false);\n  1286→\n  1287→    estudios = [];\n  1288→    experiencias = [];\n  1289→    indice_editar = null;\n  1290→\n  1291→    inputsCleave();\n  1292→    actualizarSelect2();\n  1293→}\n  1294→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"12f32a61-b737-4ebb-98c5-59bae964d3a9","timestamp":"2026-01-08T21:31:37.535Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js","content":"var revision_hv_ia_activa = false;\n\nconst TIEMPO_MODAL_APERTURA = 300;\nconst TIEMPO_INICIALIZACION_COMPONENTES = 300;\nconst TIEMPO_TRIGGER_SELECT = 200;\nconst TIEMPO_FORMULARIO_MANUAL = 100;\n\nlet niveles_idiomas = [\n    {\n        id: 'A1',\n        nombre: 'A1'\n    },\n    {\n        id: 'A2',\n        nombre: 'A2'\n    },\n    {\n        id: 'B1',\n        nombre: 'B1'\n    },\n    {\n        id: 'B2',\n        nombre: 'B2'\n    },\n    {\n        id: 'C1',\n        nombre: 'C1'\n    },\n    {\n        id: 'C2',\n        nombre: 'C2'\n    },\n];\n\n$(document).ready(function() {\n    $(document).on('change', '#hv_archivo', function() {\n        if (revision_hv_ia_activa && this.files && this.files[0]) {\n            generarPerfilHVPorIARevision(this);\n        }\n    });\n});\n\n/**\n * Cierra el modal de revisión de hoja de vida\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction cerrarModalRevisionHV() {\n    $('#modal-aplicacion-revision-hv').modal('hide');\n}\n\n/**\n * Abre el modal de revisión de hoja de vida\n *\n * @param {Object} datos_etapa - Datos de la etapa\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalRevisionHV(datos_etapa) {\n    estudios = [];\n    experiencias = [];\n    indice_editar = null;\n\n    revision_hv_ia_activa = datos_etapa.configuracion_ia_hv == 1;\n\n    if (revision_hv_ia_activa) {\n        $('#alerta-ia-revision-hv').removeClass('d-none');\n    } else {\n        $('#alerta-ia-revision-hv').addClass('d-none');\n\n        setTimeout(() => {\n            crearPerfilManualmenteRevision();\n        }, TIEMPO_FORMULARIO_MANUAL);\n    }\n\n    // Limpiar contenedores\n    $('#contenedor-niveles-educativos-revision').empty();\n    $('#contenedor-experiencias-laborales-revision').empty();\n    $('#contenedor-campos-perfil-revision').addClass('d-none');\n    $('#contenedor-opciones-crear-ia-revision').removeClass('d-none');\n\n    // Sobreescribir temporalmente las funciones para este contexto\n    window.validacionAdicional = validacionAdicionalRevisionHV;\n    window.postSuccess = postSuccessRevisionHV;\n\n    configurarFormulario('formulario-revision-hv');\n    configurarFormulario('formulario-nivel-educativo');\n    configurarFormulario('formulario-experiencia-laboral');\n\n    $('#titulo-revision-hv').text(`Completa tu hoja de vida para: ${datos_etapa.vacante_nombre}`);\n\n    $('#revision_hv_etapa_vacante_usuario_id').val(datos_etapa.etapa_vacante_usuario_id || '');\n    $('#revision_hv_vacante_id').val(datos_etapa.vacante_id || '');\n    $('#revision_hv_etapa_id').val(datos_etapa.etapa_id || '');\n\n    let usuario_id = datos_etapa.usuario_id || $('#revision_hv_usuario_id').val();\n    $('#revision_hv_usuario_id').val(usuario_id);\n\n    $('#modal-aplicacion-revision-hv').modal('show');\n\n    consultarPerfilLaboralUsuario();\n\n    // Inicializar componentes\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n        inizializarMultiselect();\n        inicializarTooltips();\n        inicializarIputsFile();\n\n        // Limpiar espacios en blanco de habilidades y herramientas en tiempo real\n        $('#revision_select_habilidades, #revision_select_herramientas_tecnologicas').on('change', function() {\n            let valores = $(this).val();\n            if (Array.isArray(valores)) {\n                // Filtrar y limpiar espacios vacíos\n                let valores_limpios = valores.filter(v => v && v.trim() !== '').map(v => v.trim());\n                if (JSON.stringify(valores) !== JSON.stringify(valores_limpios)) {\n                    $(this).val(valores_limpios).trigger('change.select2');\n                }\n            }\n        });\n\n        configurarOverridesRevision();\n    }, TIEMPO_INICIALIZACION_COMPONENTES);\n}\n\n/**\n * Consulta el perfil laboral existente del usuario y pre-rellena el formulario\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction consultarPerfilLaboralUsuario() {\n    let usuario_id = $('#revision_hv_usuario_id').val();\n\n    if (!usuario_id) {\n        return;\n    }\n\n    $.ajax({\n        url: `/perfiles-laborales-consultar-usuario/${usuario_id}`,\n        type: 'GET',\n        success: function(respuesta) {\n            if (respuesta.data) {\n                preRellenarFormularioRevisionHV(respuesta.data);\n            }\n        },\n        error: function(error) {}\n    });\n}\n\n/**\n * Pre-rellena el formulario de revisión HV con datos existentes\n *\n * @param {Object} perfil - Datos del perfil laboral\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }\n\n    if (perfil.habilidades) {\n        let habilidades_array = perfil.habilidades.split(',')\n            .map(h => h.trim())\n            .filter(h => h !== ''); // Filtrar elementos vacíos\n        habilidades_array.forEach(habilidad => {\n            if (habilidad) {\n                let opcion = new Option(habilidad, habilidad, true, true);\n                $('#revision_select_habilidades').append(opcion);\n            }\n        });\n        $('#revision_select_habilidades').trigger('change');\n    }\n\n    if (perfil.herramientas_tecnologicas) {\n        let herramientas_array = perfil.herramientas_tecnologicas.split(',')\n            .map(h => h.trim())\n            .filter(h => h !== ''); // Filtrar elementos vacíos\n        herramientas_array.forEach(herramienta => {\n            if (herramienta) {\n                let opcion = new Option(herramienta, herramienta, true, true);\n                $('#revision_select_herramientas_tecnologicas').append(opcion);\n            }\n        });\n        $('#revision_select_herramientas_tecnologicas').trigger('change');\n    }\n\n    if (perfil.licencia_conducir) {\n        $('#revision_opcion_licencia_conducir').prop('checked', true).trigger('change');\n        setTimeout(() => {\n            $('#revision_tipo_licencia').val(perfil.licencia_conducir).trigger('change');\n        }, 100);\n    }\n\n    if (perfil.estudios && perfil.estudios.length > 0) {\n        estudios = perfil.estudios.map(estudio => ({\n            nivel_educativo_id: estudio.nivel_educativo_id,\n            nivel_educativo: estudio.nivel_educativo?.nombre || '',\n            titulo: estudio.titulo,\n            institucion_educativa: estudio.institucion_educativa,\n            fecha_inicio: estudio.fecha_inicio,\n            fecha_fin: estudio.fecha_fin,\n            jornada: estudio.jornada,\n            graduado: estudio.fecha_fin ? true : false\n        }));\n        mostrarNivelesEducativosRevision();\n    }\n\n    if (perfil.experiencias_laborales && perfil.experiencias_laborales.length > 0) {\n        experiencias = perfil.experiencias_laborales.map(exp => ({\n            empresa: exp.empresa,\n            cargo: exp.cargo,\n            fecha_inicio: exp.fecha_inicio,\n            fecha_fin: exp.fecha_fin,\n            actualmente_trabajo: exp.fecha_fin ? 0 : 1,\n            modalidad_trabajo_id: exp.modalidad_trabajo_id || null,\n            funciones: exp.funciones || ''\n        }));\n        mostrarExperienciasLaboralesRevision();\n        $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n    } else {\n        $('#revision_no_experiencia').prop('checked', true).trigger('change');\n    }\n\n    if (perfil.idiomas && perfil.idiomas.length > 0) {\n        let idiomas_ids = perfil.idiomas.map(idioma => idioma.idioma_id);\n        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n\n        setTimeout(() => {\n            perfil.idiomas.forEach(idioma => {\n                $(`#nivel_idioma_${idioma.idioma_id}`).val(idioma.nivel).trigger('change');\n            });\n        }, 200);\n    }\n\n    if (perfil.usuario && perfil.usuario.discapacidades && perfil.usuario.discapacidades.length > 0) {\n        $('#revision_vacante_apta_discapacitados').prop('checked', true).trigger('change');\n\n        setTimeout(() => {\n            let discapacidades_ids = perfil.usuario.discapacidades.map(disc => disc.id);\n            $('#revision_select_discapacidades').val(discapacidades_ids).multiselect('refresh');\n            seleccionarDiscapacidadRevision({name: 'revision_select_discapacidades'});\n\n            perfil.usuario.discapacidades.forEach(discapacidad => {\n                if (discapacidad.id === 5 && discapacidad.pivot.otra_discapacidad) { // ID 5 = \"Otra\"\n                    $('#revision_otra_discapacidad').val(discapacidad.pivot.otra_discapacidad);\n                }\n            });\n        }, 200);\n    }\n\n    // Reinicializar componentes después de rellenar\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n    }, 300);\n}\n\n/**\n * Configura los overrides de funciones globales para el contexto de revisión\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction configurarOverridesRevision() {\n    if (!window.mostrarNivelesEducativos_original_revision) {\n        window.mostrarNivelesEducativos_original_revision = window.mostrarNivelesEducativos;\n    }\n    if (!window.mostrarExperienciasLaborales_original_revision) {\n        window.mostrarExperienciasLaborales_original_revision = window.mostrarExperienciasLaborales;\n    }\n\n    window.mostrarNivelesEducativos = function() {\n        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-niveles-educativos-revision').length > 0) {\n            mostrarNivelesEducativosRevision();\n        } else if (typeof window.mostrarNivelesEducativos_original_revision === 'function') {\n            window.mostrarNivelesEducativos_original_revision();\n        }\n    };\n\n    window.mostrarExperienciasLaborales = function() {\n        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-experiencias-laborales-revision').length > 0) {\n            mostrarExperienciasLaboralesRevision();\n        } else if (typeof window.mostrarExperienciasLaborales_original_revision === 'function') {\n            window.mostrarExperienciasLaborales_original_revision();\n        }\n    };\n}\n\n/**\n * Genera el perfil de HV usando IA (versión para revisión)\n *\n * @param {HTMLElement} input_archivo - Input de archivo\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction generarPerfilHVPorIARevision(input_archivo) {\n    if (!input_archivo.files || !input_archivo.files[0]) {\n        return;\n    }\n\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-generando-ia-revision').modal('show');\n\n    $('#modal-generando-ia-revision').off('hidden.bs.modal.restaurar-ia').on('hidden.bs.modal.restaurar-ia', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n    });\n\n    let formulario = new FormData();\n    formulario.append('archivo', input_archivo.files[0]);\n    formulario.append('_method', 'POST');\n    formulario.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n\n    const vacanteId = $('#revision_hv_vacante_id').val()\n        || new URLSearchParams(window.location.search).get('vacante_id')\n        || '';\n    if (vacanteId) {\n        formulario.append('vacante_id', vacanteId);\n    }\n\n    $.ajax({\n        url: '/perfiles-laborales-leer-hv-ia',\n        type: 'POST',\n        data: formulario,\n        processData: false,\n        contentType: false,\n        success: function(respuesta) {\n            $('#modal-generando-ia-revision').modal('hide');\n            // Esperar a que se cierre el modal de IA antes de mostrar el principal\n            setTimeout(() => {\n                $('#modal-aplicacion-revision-hv').css('display', 'block');\n            }, TIEMPO_MODAL_APERTURA);\n\n            if (respuesta.data) {\n                // Mostrar formulario\n                crearPerfilManualmenteRevision();\n\n                // Llenar habilidades desde la IA\n                if (respuesta.data.habilidades) {\n                    $('#revision_select_habilidades').val([]);\n                    let habilidades_array = respuesta.data.habilidades.split(',').map(habilidad => habilidad.trim()).filter(habilidad => habilidad !== '');\n                    habilidades_array.forEach(habilidad => {\n                        if (habilidad) {\n                            let opcion = new Option(habilidad, habilidad, true, true);\n                            $('#revision_select_habilidades').append(opcion);\n                        }\n                    });\n                    $('#revision_select_habilidades').trigger('change');\n                }\n\n                // Llenar herramientas tecnológicas desde la IA\n                if (respuesta.data.herramientas_tecnologicas) {\n                    $('#revision_select_herramientas_tecnologicas').val([]);\n                    let herramientas_array = respuesta.data.herramientas_tecnologicas.split(',').map(herramienta => herramienta.trim()).filter(herramienta => herramienta !== '');\n                    herramientas_array.forEach(herramienta => {\n                        if (herramienta) {\n                            let opcion = new Option(herramienta, herramienta, true, true);\n                            $('#revision_select_herramientas_tecnologicas').append(opcion);\n                        }\n                    });\n                    $('#revision_select_herramientas_tecnologicas').trigger('change');\n                }\n\n                // Llenar salario si existe\n                if (respuesta.data.salario) {\n                    $('#revision_salario').val(respuesta.data.salario);\n                }\n\n                // Procesar estudios\n                if (respuesta.data.estudios && Array.isArray(respuesta.data.estudios)) {\n                    estudios = [];\n                    respuesta.data.estudios.forEach(estudio => {\n                        // Buscar el nivel educativo por nombre\n                        let nivel_educativo_encontrado = niveles_educativos.find(function(nivel) {\n                            return nivel.nombre.toLowerCase() === estudio.nivel_educativo.toLowerCase();\n                        });\n\n                        estudios.push({\n                            titulo: estudio.titulo,\n                            institucion_educativa: estudio.institucion_educativa,\n                            nivel_educativo_id: nivel_educativo_encontrado ? nivel_educativo_encontrado.id : null,\n                            nivel_educativo: estudio.nivel_educativo,\n                            fecha_inicio: estudio.fecha_inicio,\n                            fecha_fin: estudio.fecha_fin || null,\n                            jornada: estudio.jornada || 'Diurna',\n                            graduado: estudio.fecha_fin ? true : false\n                        });\n                    });\n                    mostrarNivelesEducativosRevision();\n                }\n\n                // Procesar experiencias laborales\n                if (respuesta.data.experiencias_laborales && Array.isArray(respuesta.data.experiencias_laborales)) {\n                    experiencias = [];\n                    respuesta.data.experiencias_laborales.forEach(experiencia => {\n                        experiencias.push({\n                            empresa: experiencia.empresa,\n                            cargo: experiencia.cargo,\n                            fecha_inicio: experiencia.fecha_inicio,\n                            fecha_fin: experiencia.fecha_fin || null,\n                            actualmente_trabajo: experiencia.fecha_fin ? 0 : 1,\n                            modalidad_trabajo_id: experiencia.modalidad_trabajo_id || null,\n                            funciones: experiencia.funciones || ''\n                        });\n                    });\n                    mostrarExperienciasLaboralesRevision();\n                    $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n                }\n\n                // Procesar idiomas\n                if (respuesta.data.idiomas && Array.isArray(respuesta.data.idiomas)) {\n                    // Mapear nombres de idiomas de la IA a IDs del sistema\n                    let idiomas_mapa = {\n                        'Inglés': 1,\n                        'Portugués': 2,\n                        'Francés': 3,\n                        'Alemán': 4,\n                        'Mandarín': 5,\n                        'Italiano': 6,\n                        'Ruso': 7,\n                        'Árabe': 8\n                    };\n\n                    let idiomas_ids = [];\n                    respuesta.data.idiomas.forEach(idioma_ia => {\n                        let idioma_id = idiomas_mapa[idioma_ia.idioma];\n                        if (idioma_id) {\n                            idiomas_ids.push(idioma_id);\n                        }\n                    });\n\n                    if (idiomas_ids.length > 0) {\n                        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n                        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n\n                        setTimeout(() => {\n                            respuesta.data.idiomas.forEach(idioma_ia => {\n                                let idioma_id = idiomas_mapa[idioma_ia.idioma];\n                                if (idioma_id) {\n                                    $(`#nivel_idioma_${idioma_id}`).val(idioma_ia.nivel).trigger('change');\n                                }\n                            });\n                        }, TIEMPO_TRIGGER_SELECT);\n                    }\n                }\n\n                revision_hv_ia_activa = false;\n                mostrarToast('success', 'Datos extraídos correctamente. Por favor verifica y completa la información.');\n            }\n        },\n        error: function(error) {\n            $('#modal-generando-ia-revision').modal('hide');\n\n            setTimeout(() => {\n                $('#modal-aplicacion-revision-hv').css('display', 'block');\n            }, TIEMPO_MODAL_APERTURA);\n            mostrarToast('danger', error.responseJSON?.message || 'Error al procesar el archivo con IA');\n            console.error(error);\n        }\n    });\n}\n\n/**\n * Muestra el formulario de perfil manualmente\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction crearPerfilManualmenteRevision() {\n    $('#contenedor-campos-perfil-revision').removeClass('d-none');\n    $('#contenedor-opciones-crear-ia-revision').addClass('d-none');\n}\n\n/**\n * Abre el modal para agregar un nivel educativo\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalNivelEducativoRevision() {\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-agregar-nivel-educativo').modal('show');\n    limpiarFormulario('formulario-nivel-educativo');\n    indice_editar = null;\n\n    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-nivel-educativo');\n        indice_editar = null;\n    });\n}\n\n/**\n * Abre el modal para agregar una experiencia laboral\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalExperienciaLaboralRevision() {\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-agregar-experiencia-laboral').modal('show');\n    limpiarFormulario('formulario-experiencia-laboral');\n    indice_editar = null;\n\n    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-experiencia-laboral');\n        indice_editar = null;\n    });\n}\n\n/**\n * Maneja el toggle de \"no tengo experiencia\"\n *\n * @param {boolean} marcado - Estado del toggle\n * @returns {void}\n * @author Andres Gonzalez\n * @author Andres Morales\n */\nfunction seleccionarNoTengoExperienciaRevision(marcado) {\n    if (marcado) {\n        $('#btn-agregar-experiencia-laboral-revision').addClass('d-none');\n        experiencias = [];\n        mostrarExperienciasLaboralesRevision();\n    } else {\n        $('#btn-agregar-experiencia-laboral-revision').removeClass('d-none');\n    }\n}\n\n/**\n * Cambia los campos de salario según el tipo seleccionado\n *\n * @param {string} tipo - Tipo de salario ('especifico' o 'rango')\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarSalarioRevision(tipo) {\n    $('#contenedor-campos-salario-revision').empty();\n    if (tipo == 'especifico') {\n        $('#contenedor-campos-salario-revision').append(`\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario',\n                    name: 'salario',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Cantidad',\n                    placeholder: '',\n                    min: 0,\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n        `);\n    } else if (tipo == 'rango') {\n        $('#contenedor-campos-salario-revision').append(`\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario',\n                    name: 'salario',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Desde',\n                    placeholder: '',\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    onkeyup: 'validarRangoSalarioRevision()',\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario_maximo',\n                    name: 'salario_maximo',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Hasta',\n                    placeholder: '',\n                    min: 0,\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    onkeyup: 'validarRangoSalarioRevision()',\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n        `);\n    }\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n        configurarFormulario('formulario-revision-hv');\n    }, 100);\n}\n\n/**\n * Maneja la selección de idiomas\n *\n * @param {HTMLElement} elemento - Elemento del multiselect\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarIdiomaRevision(elemento) {\n    let niveles = [];\n    $('input[name=\"multiselect_' + elemento.name + '\"]:checked').each(function () {\n        niveles.push({\n            id: parseInt($(this).val()),\n            nombre: $(this).closest('label').find('span').text().trim(),\n        });\n    });\n    let campos_idiomas = '';\n    for (let i = 0; i < niveles.length; i++) {\n        campos_idiomas += `\n            <div class=\"col-12 col-lg-6 mt-3\">\n                <div class=\"text-headline-6 text-gray-10\">${niveles[i].nombre}</div>\n                ${crearSelect2({\n                    opciones: niveles_idiomas,\n                    id: 'nivel_idioma_' + niveles[i].id,\n                    name: 'nivel_idioma_' + niveles[i].id,\n                    class: 'input-dinamico nivel-idioma',\n                    input_container_class: 'mt-2 mb-0',\n                    label: 'Nivel',\n                    value: $('#nivel_idioma_' + niveles[i].id).val(),\n                    required: true,\n                })}\n            </div>\n            <input type=\"hidden\" value=\"${niveles[i].id}\" class=\"input-dinamico idioma\">\n        `;\n    }\n    $('#contenedor-idiomas-revision').empty();\n    $('#contenedor-idiomas-revision').append(campos_idiomas);\n    actualizarSelect2();\n}\n\n/**\n * Maneja el toggle de licencia de conducir\n *\n * @param {HTMLElement} elemento - Elemento del toggle\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarLicenciaConducirRevision(elemento) {\n    let marcado = $(elemento).prop('checked');\n    if (!marcado) {\n        $('#revision_tipo_licencia').val('').trigger('change').trigger('select2:select');\n    }\n    $('#revision_tipo_licencia').prop('disabled', !marcado);\n}\n\n/**\n * Maneja el toggle de discapacidad\n *\n * @param {boolean} posee_discapacidad - Si tiene discapacidad\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarTengoDiscapacidadRevision(posee_discapacidad) {\n    $('#contenedor-discapacidad-revision').empty();\n    if (posee_discapacidad) {\n        $('#contenedor-discapacidad-revision').append(`\n            <div class=\"col-12 p-4 border rounded-3\">\n                <div class=\"row align-items-center pb-2\">\n                    <div class=\"col-12\">\n                        <label class=\"form-label fw-semibold\">Discapacidad</label>\n                    </div>\n                    <div class=\"col-6\">\n                        ${crearMultiselect({\n                            opciones: discapacidades,\n                            id: 'revision_select_discapacidades',\n                            name: 'revision_select_discapacidades',\n                            class: 'input-dinamico',\n                            input_container_class: 'mb-0',\n                            placeholder: 'Discapacidad',\n                            onchange: 'seleccionarDiscapacidadRevision(this.value)',\n                            required: true,\n                        })}\n                    </div>\n                    <div class=\"col-6\" id=\"contenedor-otra-discapacidad-revision\"></div>\n                </div>\n            </div>\n        `);\n        inizializarMultiselect();\n    }\n}\n\n/**\n * Maneja la selección de tipo de discapacidad\n *\n * @param {string} discapacidad_id - ID de la discapacidad\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarDiscapacidadRevision(discapacidad_id) {\n    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val() || [];\n    if (discapacidades_seleccionadas.includes('5')) {\n        let otra_discapacidad_existente = $('#revision_otra_discapacidad').length > 0;\n        if (!otra_discapacidad_existente) {\n            $('#contenedor-otra-discapacidad-revision').append(`\n                ${crearInput({\n                    id: 'revision_otra_discapacidad',\n                    name: 'revision_otra_discapacidad',\n                    class: 'input-dinamico',\n                    input_container_class: 'mb-0',\n                    label: '¿Cuál?',\n                    required: true,\n                })}\n            `);\n        }\n    } else {\n        $('#contenedor-otra-discapacidad-revision').empty();\n    }\n}\n\n/**\n * Muestra los niveles educativos agregados (reutiliza lógica de crear.js)\n *\n * @returns {void}\n * @author Andres Gonzalez\n * @author Jair Carvajal\n */\nfunction mostrarNivelesEducativosRevision() {\n    $('#contenedor-niveles-educativos-revision').empty();\n    if (estudios.length > 0) {\n        // Ordenar estudios usando función global reutilizable\n        let estudios_ordenados = ordenarEstudiosPorFecha(estudios);\n\n        estudios_ordenados.forEach((estudio) => {\n            $('#contenedor-niveles-educativos-revision').append(`\n                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"nivel-educativo-revision-${estudio.indice_original}\">\n                    <div class=\"row mb-2\">\n                        <div class=\"col-12 col-lg\">\n                            <p class=\"mb-1 fw-bold text-gray-20\">${estudio.titulo}</p>\n                            <p class=\"text-body-3 mb-1\">\n                                ${estudio.fecha_inicio || estudio.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n                                ${estudio.fecha_inicio ? moment(estudio.fecha_inicio).format(\"MMM YYYY\") : ''}\n                                ${estudio.fecha_inicio && !estudio.fecha_fin ? ' - Actualmente' : estudio.fecha_fin ? ` - ${moment(estudio.fecha_fin).format(\"MMM YYYY\")}` : ''}\n                                ${estudio.jornada ? ` - ${estudio.jornada}` : ''}\n                            </p>\n                            <p class=\"text-body-3 mb-1\"><i class=\"bi bi-buildings text-headline-5 me-2\"></i> ${estudio.institucion_educativa}</p>\n                        </div>\n                        <div class=\"col-auto\">\n                            <div class=\"row justify-content-end\">\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-primary btn-circle',\n                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n                                        onclick: `editarNivelEducativoRevision(${estudio.indice_original})`\n                                    })}\n                                </div>\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-danger btn-circle',\n                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n                                        onclick: `eliminarNivelEducativoRevision(${estudio.indice_original})`\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-12 mt-3\">\n                            <div class=\"row justify-content-between\">\n                                <div class=\"col-auto\">\n                                    <p class=\"text-body-3 text-gray-10 mb-0\">${estudio.nivel_educativo || ''}</p>\n                                </div>\n                                <div class=\"col-auto\">\n                                    <div class=\"row justify-content-end align-items-center\">\n                                        ${estudio.graduado ? `\n                                            <div class=\"col-auto pe-0\">\n                                                <i class=\"bi bi-mortarboard text-headline-5 text-cta-blue\"></i>\n                                            </div>\n                                            <div class=\"col-auto text-body-3 text-gray-10\">\n                                                Graduado\n                                            </div>\n                                        ` : `\n                                            <div class=\"col-auto pe-0\">\n                                                <i class=\"bi ${estudio.jornada == 'Diurna' ? 'bi-sun' : estudio.jornada == 'Nocturna' ? 'bi-moon' : ''} text-headline-5 text-cta-blue\"></i>\n                                            </div>\n                                            <div class=\"col-auto text-body-3 text-gray-10\">\n                                                ${estudio.jornada ? 'Modalidad:' : ''} ${estudio.jornada || ''}\n                                            </div>\n                                        `}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `);\n        });\n    }\n}\n\n/**\n * Muestra las experiencias laborales agregadas\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction mostrarExperienciasLaboralesRevision() {\n    $('#contenedor-experiencias-laborales-revision').empty();\n    if (experiencias.length > 0) {\n        $('#revision_no_experiencia').prop('disabled', true);\n        // Ordenar experiencias usando función global reutilizable\n        let experiencias_ordenadas = ordenarExperienciasPorFecha(experiencias);\n\n        experiencias_ordenadas.forEach((experiencia) => {\n            let modalidades = {1: 'Presencial', 2: 'Híbrido', 3: 'Remoto'};\n            let html_modalidad = experiencia.modalidad_trabajo_id ? `\n                <div class=\"mt-2\">\n                    <small class=\"text-gray-30\">Modalidad:</small>\n                    <span class=\"badge bg-primary ms-2\">${modalidades[experiencia.modalidad_trabajo_id]}</span>\n                </div>\n            ` : '';\n            let html_funciones = experiencia.funciones ? `\n                <div class=\"mt-2\">\n                    <small class=\"text-gray-30 d-block\">Funciones:</small>\n                    <p class=\"text-body-3 mb-0\">${experiencia.funciones}</p>\n                </div>\n            ` : '';\n            $('#contenedor-experiencias-laborales-revision').append(`\n                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"experiencia-laboral-revision-${experiencia.indice_original}\">\n                    <div class=\"row mb-2\">\n                        <div class=\"col-lg\">\n                            <p class=\"mb-1 fw-bold text-gray-20\">${experiencia.cargo}</p>\n                            <p class=\"text-body-3 mb-2\">\n                                ${experiencia.fecha_inicio || experiencia.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n                                ${experiencia.fecha_inicio ? moment(experiencia.fecha_inicio).format(\"MMM YYYY\") + (experiencia.fecha_fin ? ` - ${moment(experiencia.fecha_fin).format(\"MMM YYYY\")}` : \" - Actualmente\") : \"\"}\n                                ${experiencia.fecha_inicio && experiencia.fecha_fin ? (() => {\n                                    let inicio = moment(experiencia.fecha_inicio);\n                                    let fin = moment(experiencia.fecha_fin);\n                                    let anios = fin.diff(inicio, 'years');\n                                    let meses = fin.diff(inicio.add(anios, 'years'), 'months');\n                                    let texto = '';\n                                    if (anios > 0) texto += `${anios} año${anios > 1 ? 's' : ''}`;\n                                    if (meses > 0) texto += `${anios > 0 ? ' y ' : ''}${meses} mes${meses > 1 ? 'es' : ''}`;\n                                    return texto ? ` | ${texto}` : '';\n                                })() : ''}\n                            </p>\n                            <p class=\"text-body-3 mb-1 fw-semibold text-gray-10\">${experiencia.empresa}</p>\n                            ${html_modalidad}\n                            ${html_funciones}\n                        </div>\n                        <div class=\"col-auto\">\n                            <div class=\"row justify-content-end\">\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-primary btn-circle',\n                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n                                        onclick: `editarExperienciaLaboralRevision(${experiencia.indice_original})`\n                                    })}\n                                </div>\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-danger btn-circle',\n                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n                                        onclick: `eliminarExperienciaLaboralRevision(${experiencia.indice_original})`\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `);\n        });\n    } else {\n        $('#revision_no_experiencia').prop('disabled', false);\n    }\n}\n\n/**\n * Edita un nivel educativo existente (reutiliza variables de crear.js)\n *\n * @param {number} indice - Índice del nivel educativo a editar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction editarNivelEducativoRevision(indice) {\n    indice_editar = indice;\n    let estudio = estudios[indice];\n    $('#titulo').val(estudio.titulo);\n    $('#institucion_educativa').val(estudio.institucion_educativa);\n    $('#cursando_estudios').prop('checked', !estudio.graduado).trigger('change');\n    $('#nivel_educativo_id').val(estudio.nivel_educativo_id).trigger('change');\n    $('#fecha_inicio_estudio')[0]._flatpickr.setDate(estudio.fecha_inicio);\n    if ($('#fecha_fin_estudio').length > 0) {\n        $('#fecha_fin_estudio')[0]._flatpickr.setDate(estudio.fecha_fin || '');\n    }\n\n    // Ocultar el modal principal temporalmente sin destruirlo\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    // Abrir el modal secundario\n    $('#modal-agregar-nivel-educativo').modal('show');\n\n    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-nivel-educativo');\n        indice_editar = null;\n    });\n}\n\n/**\n * Elimina un nivel educativo (reutiliza array de crear.js)\n *\n * @param {number} indice - Índice del nivel educativo a eliminar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction eliminarNivelEducativoRevision(indice) {\n    estudios.splice(indice, 1);\n    mostrarNivelesEducativosRevision();\n    mostrarToast('success', 'Nivel educativo eliminado exitosamente');\n}\n\n/**\n * Edita una experiencia laboral existente (reutiliza variables de crear.js)\n *\n * @param {number} indice - Índice de la experiencia laboral a editar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction editarExperienciaLaboralRevision(indice) {\n    indice_editar = indice;\n    let experiencia = experiencias[indice];\n    $('#cargo').val(experiencia.cargo);\n    $('#empresa').val(experiencia.empresa);\n    $('#actualmente_trabajo').prop('checked', experiencia.actualmente_trabajo).trigger('change');\n    $('#fecha_inicio_experiencia')[0]._flatpickr.setDate(experiencia.fecha_inicio);\n    if ($('#fecha_fin_experiencia').length) {\n        $('#fecha_fin_experiencia')[0]._flatpickr.setDate(experiencia.fecha_fin || '');\n    }\n    $('#modalidad_trabajo_id').val(experiencia.modalidad_trabajo_id || '').trigger('change');\n    $('#funciones').val(experiencia.funciones || '');\n\n    // Ocultar el modal principal temporalmente sin destruirlo\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    // Abrir el modal secundario\n    $('#modal-agregar-experiencia-laboral').modal('show');\n\n    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-experiencia-laboral');\n        indice_editar = null;\n    });\n}\n\n/**\n * Elimina una experiencia laboral (reutiliza array de crear.js)\n *\n * @param {number} indice - Índice de la experiencia laboral a eliminar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction eliminarExperienciaLaboralRevision(indice) {\n    experiencias.splice(indice, 1);\n    mostrarExperienciasLaboralesRevision();\n    mostrarToast('success', 'Experiencia laboral eliminada exitosamente');\n}\n\n/**\n * Validación adicional para formularios de revisión de HV\n * Esta función es llamada automáticamente por configurarFormulario()\n * Maneja: formulario-revision-hv, formulario-nivel-educativo, formulario-experiencia-laboral\n *\n * @param {string} formulario - ID del formulario a validar\n * @returns {boolean}\n * @author Andres Gonzalez\n */\nfunction validacionAdicionalRevisionHV(formulario) {\n    let valido = true;\n\n    if (formulario == 'formulario-nivel-educativo') {\n        let errores = $('#formulario-nivel-educativo').find('input.error , select.error , textarea.error');\n        if (errores.length == 0) {\n            let fecha_inicio = $('#fecha_inicio_estudio').val() ? moment($('#fecha_inicio_estudio').val(), 'YYYY-MM-DD') : null;\n            let fecha_fin = $('#fecha_fin_estudio').val() ? moment($('#fecha_fin_estudio').val(), 'YYYY-MM-DD') : null;\n            let fecha_actual = moment();\n\n            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de inicio del estudio no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de finalización del estudio no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n                valido = false;\n            }\n\n            if (valido) {\n                let estudio = {\n                    titulo: $('#titulo').val(),\n                    institucion_educativa: $('#institucion_educativa').val(),\n                    nivel_educativo_id: parseInt($('#nivel_educativo_id').val()),\n                    nivel_educativo: $('#nivel_educativo_id option:selected').text().trim(),\n                    graduado: $('#cursando_estudios').prop('checked') ? false : true,\n                    fecha_inicio: $('#fecha_inicio_estudio').val(),\n                    fecha_fin: $('#fecha_fin_estudio').val() || null,\n                    jornada: $('#jornada').val() || null,\n                }\n                if (indice_editar == null) {\n                    estudios.push(estudio);\n                } else {\n                    estudios[indice_editar] = estudio;\n                    indice_editar = null;\n                }\n                mostrarNivelesEducativosRevision();\n                $('#modal-agregar-nivel-educativo').modal('hide');\n                mostrarToast('success', 'Nivel educativo guardado exitosamente');\n            }\n        }\n        return false;\n    }\n\n    if (formulario == 'formulario-experiencia-laboral') {\n        let errores = $('#formulario-experiencia-laboral').find('input.error , select.error , textarea.error');\n        if (errores.length == 0) {\n            let fecha_inicio = $('#fecha_inicio_experiencia').val() ? moment($('#fecha_inicio_experiencia').val(), 'YYYY-MM-DD') : null;\n            let fecha_fin = $('#fecha_fin_experiencia').val() ? moment($('#fecha_fin_experiencia').val(), 'YYYY-MM-DD') : null;\n            let fecha_actual = moment();\n\n            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de inicio de la experiencia no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de finalización de la experiencia no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n                valido = false;\n            }\n\n            if (valido) {\n                let modalidad_trabajo_id = $('#modalidad_trabajo_id').val();\n                let experiencia = {\n                    cargo: $('#cargo').val(),\n                    empresa: $('#empresa').val(),\n                    actualmente_trabajo: $('#actualmente_trabajo').prop('checked') ? 1 : 0,\n                    fecha_inicio: $('#fecha_inicio_experiencia').val(),\n                    fecha_fin: $('#fecha_fin_experiencia').val() || null,\n                    modalidad_trabajo_id: modalidad_trabajo_id ? parseInt(modalidad_trabajo_id) : null,\n                    funciones: $('#funciones').val() || '',\n                }\n                if (indice_editar == null) {\n                    experiencias.push(experiencia);\n                } else {\n                    experiencias[indice_editar] = experiencia;\n                    indice_editar = null;\n                }\n                mostrarExperienciasLaboralesRevision();\n                $('#modal-agregar-experiencia-laboral').modal('hide');\n                mostrarToast('success', 'Experiencia laboral guardada exitosamente');\n            }\n        }\n        return false;\n    }\n\n    if (formulario !== 'formulario-revision-hv') {\n        return true;\n    }\n\n    let errores = $('#formulario-revision-hv').find('input.error , select.error , textarea.error');\n    if (errores.length > 0) {\n        mostrarToast('danger', 'Faltan algunos datos obligatorios. Por favor, revisa la información e intenta nuevamente');\n        return false;\n    }\n\n    let salario = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n    if (salario < 0) {\n        mostrarToast('danger', 'El salario no puede ser un valor negativo.');\n        valido = false;\n    }\n\n    if ($('#revision_salario_maximo').length > 0) {\n        let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n        if (salario_maximo < 0) {\n            mostrarToast('danger', 'El salario máximo no puede ser un valor negativo.');\n            valido = false;\n        }\n        if (salario_maximo < salario) {\n            if (salario_maximo > 0) {\n                mostrarToast('danger', 'El salario máximo no puede ser menor que el salario mínimo.');\n            }\n            valido = false;\n        }\n    }\n\n    validarRangoSalarioRevision();\n\n    let habilidades_seleccionadas = $('#revision_select_habilidades').val();\n    $('#revision_hv_habilidades').val(Array.isArray(habilidades_seleccionadas) ? habilidades_seleccionadas.join(', ') : '');\n\n    let herramientas_seleccionadas = $('#revision_select_herramientas_tecnologicas').val();\n    $('#revision_hv_herramientas_tecnologicas').val(Array.isArray(herramientas_seleccionadas) ? herramientas_seleccionadas.join(', ') : '');    \n    $('#revision_hv_estudios').val(JSON.stringify(estudios.map(({ nivel_educativo, graduado, ...estudio }) => estudio)));\n\n    if (experiencias.length > 0) {\n        $('#revision_hv_experiencias_laborales').val(JSON.stringify(experiencias.map(({ actualmente_trabajo, ...experiencia }) => experiencia)));\n    } else {\n        $('#revision_hv_experiencias_laborales').val('');\n    }\n\n    let elementos_idiomas = $('.idioma');\n    let niveles = $('.nivel-idioma');\n    let idiomas_seleccionados = [];\n    for (let i = 0; i < elementos_idiomas.length; i++) {\n        idiomas_seleccionados.push({\n            idioma_id: parseInt($(elementos_idiomas[i]).val()),\n            nivel: $(niveles[i]).val()\n        });\n    }\n    if (idiomas_seleccionados.length == 0) {\n        $('#revision_hv_idiomas').val('');\n    } else {\n        $('#revision_hv_idiomas').val(JSON.stringify(idiomas_seleccionados));\n    }\n\n    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val();\n    let discapacidades_finales = [];\n    let usuario_id = parseInt($('#revision_hv_usuario_id').val());\n    if (discapacidades_seleccionadas) {\n        discapacidades_seleccionadas.forEach(discapacidad_id => {\n            let discapacidad = discapacidades.find(d => d.id == discapacidad_id);\n            if (discapacidad) {\n                let otra_discapacidad = null;\n                if (discapacidad.id == '5') {\n                    otra_discapacidad = $('#revision_otra_discapacidad').val().trim();\n                }\n                discapacidades_finales.push({\n                    usuario_id: usuario_id,\n                    discapacidad_id: parseInt(discapacidad_id),\n                    otra_discapacidad: otra_discapacidad\n                });\n            }\n        });\n        $('#revision_hv_discapacidades').val(JSON.stringify(discapacidades_finales));\n    } else {\n        $('#revision_hv_discapacidades').val('');\n    }\n\n    if (estudios.length == 0) {\n        mostrarToast('danger', 'Debes agregar al menos un nivel educativo para continuar.');\n        valido = false;\n    }\n\n    valido = validarFechasInicio(estudios);\n\n    if (experiencias.length == 0 && !$('#revision_no_experiencia').prop('checked')) {\n        mostrarToast('danger', 'Debes agregar al menos una experiencia laboral para continuar.');\n        valido = false;\n    }\n\n    return valido;\n}\n\n/**\n * Callback después de enviar exitosamente el formulario de revisión HV\n *\n * @param {Object} respuesta - Respuesta del servidor\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction postSuccessRevisionHV(respuesta) {\n    $('#modal-aplicacion-revision-hv').modal('hide');\n    limpiarFormularioRevisionHV();\n\n    // Recargar la tabla de tareas pendientes\n    actualizarDatatables('tabla-tareas-pendientes');\n}\n\n/**\n * Función para validar las fechas de inicio\n *\n * @param {Object} estudios - estudios del aplicante\n * @returns {boolean}\n * @author Jair Carvajal\n */\nfunction validarFechasInicio(estudios) {\n    let error = true;\n    for (const ESTUDIO of estudios) {\n        if (ESTUDIO.fecha_inicio === null) {\n            mostrarToast('danger', `El título ${ESTUDIO.titulo}. le hace falta la fecha de inicio para continuar.`);\n            error = false;\n        }\n    }\n    return error;\n}\n\n/**\n * Valida el rango de salario\n *\n * @returns {boolean}\n * @author Andres Gonzalez\n */\nfunction validarRangoSalarioRevision() {\n    if ($('input[name=\"tipo_salario\"]:checked').val() !== 'rango') {\n        return true;\n    }\n    let salario_desde = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n    let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n    let campo_hasta = $('#revision_salario_maximo');\n    let contenedor_hasta = campo_hasta.closest('.input-container');\n    campo_hasta.removeClass('error');\n    contenedor_hasta.siblings('label[for=\"revision_salario_maximo\"].error').remove();\n    if (salario_desde > 99 && salario_maximo > 99 && salario_desde >= salario_maximo) {\n        setTimeout(() => {\n            campo_hasta.addClass('error');\n            contenedor_hasta.after('<label for=\"revision_salario_maximo\" class=\"error text-red-cta\">El salario hasta no debe ser menor o igual al salario desde</label>');\n            return false;\n        }, 100);\n    }\n    return true;\n}\n\n/**\n * Limpiar formulario\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction limpiarFormularioRevisionHV() {\n    let formulario = $('#formulario-revision-hv');\n    formulario[0].reset();\n    formulario.find('.input-dinamico').removeClass('error');\n    formulario.find('label.error').remove();\n\n    $('#contenedor-idiomas-revision').empty();\n    $('#contenedor-discapacidad-revision').empty();\n    $('#contenedor-niveles-educativos-revision').empty();\n    $('#contenedor-experiencias-laborales-revision').empty();\n\n    $('#revision_select_habilidades').val('').trigger('change');\n    $('#revision_select_herramientas_tecnologicas').val('').trigger('change');\n    $('#revision_idiomas_seleccionados').val([]).multiselect('refresh');\n    $('#revision_select_discapacidades').val([]).multiselect('refresh');\n\n    $('#revision_opcion_licencia_conducir').prop('checked', false);\n    $('#revision_tipo_licencia').val('').prop('disabled', true).trigger('change');\n    $('#revision_vacante_apta_discapacitados').prop('checked', false);\n\n    estudios = [];\n    experiencias = [];\n    indice_editar = null;\n\n    inputsCleave();\n    actualizarSelect2();\n}\n","numLines":1294,"startLine":1,"totalLines":1294}}}
{"parentUuid":"12f32a61-b737-4ebb-98c5-59bae964d3a9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T21:31:45.447Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LAEbTuF2aGwKoBkAiKNBb9","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto, ahora entiendo el problema. El backend envía `modalidad_trabajo_id` con un valor (en tu ejemplo es `3`), pero en el modal de revisión HV (líneas 102-129 del archivo Blade) hay radio buttons para seleccionar la modalidad de trabajo del **perfil laboral del usuario**, no de cada experiencia laboral individual.\n\nEl problema es que cuando se pre-rellena el formulario con los datos existentes (función `preRellenarFormularioRevisionHV` en el JS), **no se está seleccionando el radio button de modalidad de trabajo** según el `modalidad_trabajo_id` que viene del backend.\n\nVoy a corregir esto:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":20108,"cache_read_input_tokens":62999,"cache_creation":{"ephemeral_5m_input_tokens":20108,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvdDG9wcKsFuvaLSzcb2","uuid":"9368f086-d4ec-4c09-bc11-0e49df8bfce3"}
{"parentUuid":"9368f086-d4ec-4c09-bc11-0e49df8bfce3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T21:31:53.087Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LAEbTuF2aGwKoBkAiKNBb9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YQrNWD7p1EKrVivux9W5aP","name":"Edit","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js","old_string":"function preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }","new_string":"function preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    // Pre-seleccionar modalidad de trabajo\n    if (perfil.modalidad_trabajo_id) {\n        setTimeout(() => {\n            $(`input[name=\"modalidad_trabajo_id\"][value=\"${perfil.modalidad_trabajo_id}\"]`).prop('checked', true);\n        }, 100);\n    }\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":20108,"cache_read_input_tokens":62999,"cache_creation":{"ephemeral_5m_input_tokens":20108,"ephemeral_1h_input_tokens":0},"output_tokens":802,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvdDG9wcKsFuvaLSzcb2","uuid":"c2c9e3e3-ea06-4257-87df-9a11edcf49f9"}
{"parentUuid":"c2c9e3e3-ea06-4257-87df-9a11edcf49f9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YQrNWD7p1EKrVivux9W5aP","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   156→ * @param {Object} perfil - Datos del perfil laboral\n   157→ * @returns {void}\n   158→ * @author Andres Gonzalez\n   159→ */\n   160→function preRellenarFormularioRevisionHV(perfil) {\n   161→    crearPerfilManualmenteRevision();\n   162→\n   163→    $('#id').val(perfil.id);\n   164→\n   165→    // Pre-seleccionar modalidad de trabajo\n   166→    if (perfil.modalidad_trabajo_id) {\n   167→        setTimeout(() => {\n   168→            $(`input[name=\"modalidad_trabajo_id\"][value=\"${perfil.modalidad_trabajo_id}\"]`).prop('checked', true);\n   169→        }, 100);\n   170→    }\n   171→\n   172→    if (perfil.salario) {\n   173→        if (perfil.salario_maximo) {\n   174→            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n   175→            setTimeout(() => {\n   176→                $('#revision_salario').val(perfil.salario);\n   177→                $('#revision_salario_maximo').val(perfil.salario_maximo);\n   178→            }, 200);\n   179→        } else {\n   180→            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n   181→            setTimeout(() => {\n   182→                $('#revision_salario').val(perfil.salario);\n   183→            }, 200);\n   184→        }\n   185→    }\n   186→\n   187→    if (perfil.habilidades) {\n   188→        let habilidades_array = perfil.habilidades.split(',')\n   189→            .map(h => h.trim())"}]},"uuid":"968db7ea-0757-425c-9771-caee23ad1454","timestamp":"2026-01-08T21:32:13.283Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js","oldString":"function preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }","newString":"function preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    // Pre-seleccionar modalidad de trabajo\n    if (perfil.modalidad_trabajo_id) {\n        setTimeout(() => {\n            $(`input[name=\"modalidad_trabajo_id\"][value=\"${perfil.modalidad_trabajo_id}\"]`).prop('checked', true);\n        }, 100);\n    }\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }","originalFile":"var revision_hv_ia_activa = false;\n\nconst TIEMPO_MODAL_APERTURA = 300;\nconst TIEMPO_INICIALIZACION_COMPONENTES = 300;\nconst TIEMPO_TRIGGER_SELECT = 200;\nconst TIEMPO_FORMULARIO_MANUAL = 100;\n\nlet niveles_idiomas = [\n    {\n        id: 'A1',\n        nombre: 'A1'\n    },\n    {\n        id: 'A2',\n        nombre: 'A2'\n    },\n    {\n        id: 'B1',\n        nombre: 'B1'\n    },\n    {\n        id: 'B2',\n        nombre: 'B2'\n    },\n    {\n        id: 'C1',\n        nombre: 'C1'\n    },\n    {\n        id: 'C2',\n        nombre: 'C2'\n    },\n];\n\n$(document).ready(function() {\n    $(document).on('change', '#hv_archivo', function() {\n        if (revision_hv_ia_activa && this.files && this.files[0]) {\n            generarPerfilHVPorIARevision(this);\n        }\n    });\n});\n\n/**\n * Cierra el modal de revisión de hoja de vida\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction cerrarModalRevisionHV() {\n    $('#modal-aplicacion-revision-hv').modal('hide');\n}\n\n/**\n * Abre el modal de revisión de hoja de vida\n *\n * @param {Object} datos_etapa - Datos de la etapa\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalRevisionHV(datos_etapa) {\n    estudios = [];\n    experiencias = [];\n    indice_editar = null;\n\n    revision_hv_ia_activa = datos_etapa.configuracion_ia_hv == 1;\n\n    if (revision_hv_ia_activa) {\n        $('#alerta-ia-revision-hv').removeClass('d-none');\n    } else {\n        $('#alerta-ia-revision-hv').addClass('d-none');\n\n        setTimeout(() => {\n            crearPerfilManualmenteRevision();\n        }, TIEMPO_FORMULARIO_MANUAL);\n    }\n\n    // Limpiar contenedores\n    $('#contenedor-niveles-educativos-revision').empty();\n    $('#contenedor-experiencias-laborales-revision').empty();\n    $('#contenedor-campos-perfil-revision').addClass('d-none');\n    $('#contenedor-opciones-crear-ia-revision').removeClass('d-none');\n\n    // Sobreescribir temporalmente las funciones para este contexto\n    window.validacionAdicional = validacionAdicionalRevisionHV;\n    window.postSuccess = postSuccessRevisionHV;\n\n    configurarFormulario('formulario-revision-hv');\n    configurarFormulario('formulario-nivel-educativo');\n    configurarFormulario('formulario-experiencia-laboral');\n\n    $('#titulo-revision-hv').text(`Completa tu hoja de vida para: ${datos_etapa.vacante_nombre}`);\n\n    $('#revision_hv_etapa_vacante_usuario_id').val(datos_etapa.etapa_vacante_usuario_id || '');\n    $('#revision_hv_vacante_id').val(datos_etapa.vacante_id || '');\n    $('#revision_hv_etapa_id').val(datos_etapa.etapa_id || '');\n\n    let usuario_id = datos_etapa.usuario_id || $('#revision_hv_usuario_id').val();\n    $('#revision_hv_usuario_id').val(usuario_id);\n\n    $('#modal-aplicacion-revision-hv').modal('show');\n\n    consultarPerfilLaboralUsuario();\n\n    // Inicializar componentes\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n        inizializarMultiselect();\n        inicializarTooltips();\n        inicializarIputsFile();\n\n        // Limpiar espacios en blanco de habilidades y herramientas en tiempo real\n        $('#revision_select_habilidades, #revision_select_herramientas_tecnologicas').on('change', function() {\n            let valores = $(this).val();\n            if (Array.isArray(valores)) {\n                // Filtrar y limpiar espacios vacíos\n                let valores_limpios = valores.filter(v => v && v.trim() !== '').map(v => v.trim());\n                if (JSON.stringify(valores) !== JSON.stringify(valores_limpios)) {\n                    $(this).val(valores_limpios).trigger('change.select2');\n                }\n            }\n        });\n\n        configurarOverridesRevision();\n    }, TIEMPO_INICIALIZACION_COMPONENTES);\n}\n\n/**\n * Consulta el perfil laboral existente del usuario y pre-rellena el formulario\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction consultarPerfilLaboralUsuario() {\n    let usuario_id = $('#revision_hv_usuario_id').val();\n\n    if (!usuario_id) {\n        return;\n    }\n\n    $.ajax({\n        url: `/perfiles-laborales-consultar-usuario/${usuario_id}`,\n        type: 'GET',\n        success: function(respuesta) {\n            if (respuesta.data) {\n                preRellenarFormularioRevisionHV(respuesta.data);\n            }\n        },\n        error: function(error) {}\n    });\n}\n\n/**\n * Pre-rellena el formulario de revisión HV con datos existentes\n *\n * @param {Object} perfil - Datos del perfil laboral\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction preRellenarFormularioRevisionHV(perfil) {\n    crearPerfilManualmenteRevision();\n\n    $('#id').val(perfil.id);\n\n    if (perfil.salario) {\n        if (perfil.salario_maximo) {\n            $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n                $('#revision_salario_maximo').val(perfil.salario_maximo);\n            }, 200);\n        } else {\n            $('input[name=\"tipo_salario\"][value=\"especifico\"]').prop('checked', true).trigger('change');\n            setTimeout(() => {\n                $('#revision_salario').val(perfil.salario);\n            }, 200);\n        }\n    }\n\n    if (perfil.habilidades) {\n        let habilidades_array = perfil.habilidades.split(',')\n            .map(h => h.trim())\n            .filter(h => h !== ''); // Filtrar elementos vacíos\n        habilidades_array.forEach(habilidad => {\n            if (habilidad) {\n                let opcion = new Option(habilidad, habilidad, true, true);\n                $('#revision_select_habilidades').append(opcion);\n            }\n        });\n        $('#revision_select_habilidades').trigger('change');\n    }\n\n    if (perfil.herramientas_tecnologicas) {\n        let herramientas_array = perfil.herramientas_tecnologicas.split(',')\n            .map(h => h.trim())\n            .filter(h => h !== ''); // Filtrar elementos vacíos\n        herramientas_array.forEach(herramienta => {\n            if (herramienta) {\n                let opcion = new Option(herramienta, herramienta, true, true);\n                $('#revision_select_herramientas_tecnologicas').append(opcion);\n            }\n        });\n        $('#revision_select_herramientas_tecnologicas').trigger('change');\n    }\n\n    if (perfil.licencia_conducir) {\n        $('#revision_opcion_licencia_conducir').prop('checked', true).trigger('change');\n        setTimeout(() => {\n            $('#revision_tipo_licencia').val(perfil.licencia_conducir).trigger('change');\n        }, 100);\n    }\n\n    if (perfil.estudios && perfil.estudios.length > 0) {\n        estudios = perfil.estudios.map(estudio => ({\n            nivel_educativo_id: estudio.nivel_educativo_id,\n            nivel_educativo: estudio.nivel_educativo?.nombre || '',\n            titulo: estudio.titulo,\n            institucion_educativa: estudio.institucion_educativa,\n            fecha_inicio: estudio.fecha_inicio,\n            fecha_fin: estudio.fecha_fin,\n            jornada: estudio.jornada,\n            graduado: estudio.fecha_fin ? true : false\n        }));\n        mostrarNivelesEducativosRevision();\n    }\n\n    if (perfil.experiencias_laborales && perfil.experiencias_laborales.length > 0) {\n        experiencias = perfil.experiencias_laborales.map(exp => ({\n            empresa: exp.empresa,\n            cargo: exp.cargo,\n            fecha_inicio: exp.fecha_inicio,\n            fecha_fin: exp.fecha_fin,\n            actualmente_trabajo: exp.fecha_fin ? 0 : 1,\n            modalidad_trabajo_id: exp.modalidad_trabajo_id || null,\n            funciones: exp.funciones || ''\n        }));\n        mostrarExperienciasLaboralesRevision();\n        $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n    } else {\n        $('#revision_no_experiencia').prop('checked', true).trigger('change');\n    }\n\n    if (perfil.idiomas && perfil.idiomas.length > 0) {\n        let idiomas_ids = perfil.idiomas.map(idioma => idioma.idioma_id);\n        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n\n        setTimeout(() => {\n            perfil.idiomas.forEach(idioma => {\n                $(`#nivel_idioma_${idioma.idioma_id}`).val(idioma.nivel).trigger('change');\n            });\n        }, 200);\n    }\n\n    if (perfil.usuario && perfil.usuario.discapacidades && perfil.usuario.discapacidades.length > 0) {\n        $('#revision_vacante_apta_discapacitados').prop('checked', true).trigger('change');\n\n        setTimeout(() => {\n            let discapacidades_ids = perfil.usuario.discapacidades.map(disc => disc.id);\n            $('#revision_select_discapacidades').val(discapacidades_ids).multiselect('refresh');\n            seleccionarDiscapacidadRevision({name: 'revision_select_discapacidades'});\n\n            perfil.usuario.discapacidades.forEach(discapacidad => {\n                if (discapacidad.id === 5 && discapacidad.pivot.otra_discapacidad) { // ID 5 = \"Otra\"\n                    $('#revision_otra_discapacidad').val(discapacidad.pivot.otra_discapacidad);\n                }\n            });\n        }, 200);\n    }\n\n    // Reinicializar componentes después de rellenar\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n    }, 300);\n}\n\n/**\n * Configura los overrides de funciones globales para el contexto de revisión\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction configurarOverridesRevision() {\n    if (!window.mostrarNivelesEducativos_original_revision) {\n        window.mostrarNivelesEducativos_original_revision = window.mostrarNivelesEducativos;\n    }\n    if (!window.mostrarExperienciasLaborales_original_revision) {\n        window.mostrarExperienciasLaborales_original_revision = window.mostrarExperienciasLaborales;\n    }\n\n    window.mostrarNivelesEducativos = function() {\n        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-niveles-educativos-revision').length > 0) {\n            mostrarNivelesEducativosRevision();\n        } else if (typeof window.mostrarNivelesEducativos_original_revision === 'function') {\n            window.mostrarNivelesEducativos_original_revision();\n        }\n    };\n\n    window.mostrarExperienciasLaborales = function() {\n        if ($('#modal-aplicacion-revision-hv').hasClass('show') && $('#contenedor-experiencias-laborales-revision').length > 0) {\n            mostrarExperienciasLaboralesRevision();\n        } else if (typeof window.mostrarExperienciasLaborales_original_revision === 'function') {\n            window.mostrarExperienciasLaborales_original_revision();\n        }\n    };\n}\n\n/**\n * Genera el perfil de HV usando IA (versión para revisión)\n *\n * @param {HTMLElement} input_archivo - Input de archivo\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction generarPerfilHVPorIARevision(input_archivo) {\n    if (!input_archivo.files || !input_archivo.files[0]) {\n        return;\n    }\n\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-generando-ia-revision').modal('show');\n\n    $('#modal-generando-ia-revision').off('hidden.bs.modal.restaurar-ia').on('hidden.bs.modal.restaurar-ia', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n    });\n\n    let formulario = new FormData();\n    formulario.append('archivo', input_archivo.files[0]);\n    formulario.append('_method', 'POST');\n    formulario.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n\n    const vacanteId = $('#revision_hv_vacante_id').val()\n        || new URLSearchParams(window.location.search).get('vacante_id')\n        || '';\n    if (vacanteId) {\n        formulario.append('vacante_id', vacanteId);\n    }\n\n    $.ajax({\n        url: '/perfiles-laborales-leer-hv-ia',\n        type: 'POST',\n        data: formulario,\n        processData: false,\n        contentType: false,\n        success: function(respuesta) {\n            $('#modal-generando-ia-revision').modal('hide');\n            // Esperar a que se cierre el modal de IA antes de mostrar el principal\n            setTimeout(() => {\n                $('#modal-aplicacion-revision-hv').css('display', 'block');\n            }, TIEMPO_MODAL_APERTURA);\n\n            if (respuesta.data) {\n                // Mostrar formulario\n                crearPerfilManualmenteRevision();\n\n                // Llenar habilidades desde la IA\n                if (respuesta.data.habilidades) {\n                    $('#revision_select_habilidades').val([]);\n                    let habilidades_array = respuesta.data.habilidades.split(',').map(habilidad => habilidad.trim()).filter(habilidad => habilidad !== '');\n                    habilidades_array.forEach(habilidad => {\n                        if (habilidad) {\n                            let opcion = new Option(habilidad, habilidad, true, true);\n                            $('#revision_select_habilidades').append(opcion);\n                        }\n                    });\n                    $('#revision_select_habilidades').trigger('change');\n                }\n\n                // Llenar herramientas tecnológicas desde la IA\n                if (respuesta.data.herramientas_tecnologicas) {\n                    $('#revision_select_herramientas_tecnologicas').val([]);\n                    let herramientas_array = respuesta.data.herramientas_tecnologicas.split(',').map(herramienta => herramienta.trim()).filter(herramienta => herramienta !== '');\n                    herramientas_array.forEach(herramienta => {\n                        if (herramienta) {\n                            let opcion = new Option(herramienta, herramienta, true, true);\n                            $('#revision_select_herramientas_tecnologicas').append(opcion);\n                        }\n                    });\n                    $('#revision_select_herramientas_tecnologicas').trigger('change');\n                }\n\n                // Llenar salario si existe\n                if (respuesta.data.salario) {\n                    $('#revision_salario').val(respuesta.data.salario);\n                }\n\n                // Procesar estudios\n                if (respuesta.data.estudios && Array.isArray(respuesta.data.estudios)) {\n                    estudios = [];\n                    respuesta.data.estudios.forEach(estudio => {\n                        // Buscar el nivel educativo por nombre\n                        let nivel_educativo_encontrado = niveles_educativos.find(function(nivel) {\n                            return nivel.nombre.toLowerCase() === estudio.nivel_educativo.toLowerCase();\n                        });\n\n                        estudios.push({\n                            titulo: estudio.titulo,\n                            institucion_educativa: estudio.institucion_educativa,\n                            nivel_educativo_id: nivel_educativo_encontrado ? nivel_educativo_encontrado.id : null,\n                            nivel_educativo: estudio.nivel_educativo,\n                            fecha_inicio: estudio.fecha_inicio,\n                            fecha_fin: estudio.fecha_fin || null,\n                            jornada: estudio.jornada || 'Diurna',\n                            graduado: estudio.fecha_fin ? true : false\n                        });\n                    });\n                    mostrarNivelesEducativosRevision();\n                }\n\n                // Procesar experiencias laborales\n                if (respuesta.data.experiencias_laborales && Array.isArray(respuesta.data.experiencias_laborales)) {\n                    experiencias = [];\n                    respuesta.data.experiencias_laborales.forEach(experiencia => {\n                        experiencias.push({\n                            empresa: experiencia.empresa,\n                            cargo: experiencia.cargo,\n                            fecha_inicio: experiencia.fecha_inicio,\n                            fecha_fin: experiencia.fecha_fin || null,\n                            actualmente_trabajo: experiencia.fecha_fin ? 0 : 1,\n                            modalidad_trabajo_id: experiencia.modalidad_trabajo_id || null,\n                            funciones: experiencia.funciones || ''\n                        });\n                    });\n                    mostrarExperienciasLaboralesRevision();\n                    $('#revision_no_experiencia').prop('checked', false).prop('disabled', true);\n                }\n\n                // Procesar idiomas\n                if (respuesta.data.idiomas && Array.isArray(respuesta.data.idiomas)) {\n                    // Mapear nombres de idiomas de la IA a IDs del sistema\n                    let idiomas_mapa = {\n                        'Inglés': 1,\n                        'Portugués': 2,\n                        'Francés': 3,\n                        'Alemán': 4,\n                        'Mandarín': 5,\n                        'Italiano': 6,\n                        'Ruso': 7,\n                        'Árabe': 8\n                    };\n\n                    let idiomas_ids = [];\n                    respuesta.data.idiomas.forEach(idioma_ia => {\n                        let idioma_id = idiomas_mapa[idioma_ia.idioma];\n                        if (idioma_id) {\n                            idiomas_ids.push(idioma_id);\n                        }\n                    });\n\n                    if (idiomas_ids.length > 0) {\n                        $('#revision_idiomas_seleccionados').val(idiomas_ids).multiselect('refresh');\n                        seleccionarIdiomaRevision({name: 'revision_idiomas_seleccionados'});\n\n                        setTimeout(() => {\n                            respuesta.data.idiomas.forEach(idioma_ia => {\n                                let idioma_id = idiomas_mapa[idioma_ia.idioma];\n                                if (idioma_id) {\n                                    $(`#nivel_idioma_${idioma_id}`).val(idioma_ia.nivel).trigger('change');\n                                }\n                            });\n                        }, TIEMPO_TRIGGER_SELECT);\n                    }\n                }\n\n                revision_hv_ia_activa = false;\n                mostrarToast('success', 'Datos extraídos correctamente. Por favor verifica y completa la información.');\n            }\n        },\n        error: function(error) {\n            $('#modal-generando-ia-revision').modal('hide');\n\n            setTimeout(() => {\n                $('#modal-aplicacion-revision-hv').css('display', 'block');\n            }, TIEMPO_MODAL_APERTURA);\n            mostrarToast('danger', error.responseJSON?.message || 'Error al procesar el archivo con IA');\n            console.error(error);\n        }\n    });\n}\n\n/**\n * Muestra el formulario de perfil manualmente\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction crearPerfilManualmenteRevision() {\n    $('#contenedor-campos-perfil-revision').removeClass('d-none');\n    $('#contenedor-opciones-crear-ia-revision').addClass('d-none');\n}\n\n/**\n * Abre el modal para agregar un nivel educativo\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalNivelEducativoRevision() {\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-agregar-nivel-educativo').modal('show');\n    limpiarFormulario('formulario-nivel-educativo');\n    indice_editar = null;\n\n    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-nivel-educativo');\n        indice_editar = null;\n    });\n}\n\n/**\n * Abre el modal para agregar una experiencia laboral\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction abrirModalExperienciaLaboralRevision() {\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    $('#modal-agregar-experiencia-laboral').modal('show');\n    limpiarFormulario('formulario-experiencia-laboral');\n    indice_editar = null;\n\n    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-experiencia-laboral');\n        indice_editar = null;\n    });\n}\n\n/**\n * Maneja el toggle de \"no tengo experiencia\"\n *\n * @param {boolean} marcado - Estado del toggle\n * @returns {void}\n * @author Andres Gonzalez\n * @author Andres Morales\n */\nfunction seleccionarNoTengoExperienciaRevision(marcado) {\n    if (marcado) {\n        $('#btn-agregar-experiencia-laboral-revision').addClass('d-none');\n        experiencias = [];\n        mostrarExperienciasLaboralesRevision();\n    } else {\n        $('#btn-agregar-experiencia-laboral-revision').removeClass('d-none');\n    }\n}\n\n/**\n * Cambia los campos de salario según el tipo seleccionado\n *\n * @param {string} tipo - Tipo de salario ('especifico' o 'rango')\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarSalarioRevision(tipo) {\n    $('#contenedor-campos-salario-revision').empty();\n    if (tipo == 'especifico') {\n        $('#contenedor-campos-salario-revision').append(`\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario',\n                    name: 'salario',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Cantidad',\n                    placeholder: '',\n                    min: 0,\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n        `);\n    } else if (tipo == 'rango') {\n        $('#contenedor-campos-salario-revision').append(`\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario',\n                    name: 'salario',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Desde',\n                    placeholder: '',\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    onkeyup: 'validarRangoSalarioRevision()',\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n            <div class=\"col-12 col-md-6\">\n                ${crearInput({\n                    id: 'revision_salario_maximo',\n                    name: 'salario_maximo',\n                    class: 'cleave',\n                    input_container_class: 'mb-0',\n                    label: 'Hasta',\n                    placeholder: '',\n                    min: 0,\n                    step: 0.01,\n                    required: true,\n                    minlength: 3,\n                    maxlength: 10,\n                    onkeyup: 'validarRangoSalarioRevision()',\n                    data: [{\n                        texto: 'simbolo-cleave',\n                        value: ''\n                    }],\n                    icono: '<i class=\"bi bi-currency-dollar input-icono1\"></i>',\n                })}\n            </div>\n        `);\n    }\n    setTimeout(() => {\n        inputsCleave();\n        actualizarSelect2();\n        configurarFormulario('formulario-revision-hv');\n    }, 100);\n}\n\n/**\n * Maneja la selección de idiomas\n *\n * @param {HTMLElement} elemento - Elemento del multiselect\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarIdiomaRevision(elemento) {\n    let niveles = [];\n    $('input[name=\"multiselect_' + elemento.name + '\"]:checked').each(function () {\n        niveles.push({\n            id: parseInt($(this).val()),\n            nombre: $(this).closest('label').find('span').text().trim(),\n        });\n    });\n    let campos_idiomas = '';\n    for (let i = 0; i < niveles.length; i++) {\n        campos_idiomas += `\n            <div class=\"col-12 col-lg-6 mt-3\">\n                <div class=\"text-headline-6 text-gray-10\">${niveles[i].nombre}</div>\n                ${crearSelect2({\n                    opciones: niveles_idiomas,\n                    id: 'nivel_idioma_' + niveles[i].id,\n                    name: 'nivel_idioma_' + niveles[i].id,\n                    class: 'input-dinamico nivel-idioma',\n                    input_container_class: 'mt-2 mb-0',\n                    label: 'Nivel',\n                    value: $('#nivel_idioma_' + niveles[i].id).val(),\n                    required: true,\n                })}\n            </div>\n            <input type=\"hidden\" value=\"${niveles[i].id}\" class=\"input-dinamico idioma\">\n        `;\n    }\n    $('#contenedor-idiomas-revision').empty();\n    $('#contenedor-idiomas-revision').append(campos_idiomas);\n    actualizarSelect2();\n}\n\n/**\n * Maneja el toggle de licencia de conducir\n *\n * @param {HTMLElement} elemento - Elemento del toggle\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarLicenciaConducirRevision(elemento) {\n    let marcado = $(elemento).prop('checked');\n    if (!marcado) {\n        $('#revision_tipo_licencia').val('').trigger('change').trigger('select2:select');\n    }\n    $('#revision_tipo_licencia').prop('disabled', !marcado);\n}\n\n/**\n * Maneja el toggle de discapacidad\n *\n * @param {boolean} posee_discapacidad - Si tiene discapacidad\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarTengoDiscapacidadRevision(posee_discapacidad) {\n    $('#contenedor-discapacidad-revision').empty();\n    if (posee_discapacidad) {\n        $('#contenedor-discapacidad-revision').append(`\n            <div class=\"col-12 p-4 border rounded-3\">\n                <div class=\"row align-items-center pb-2\">\n                    <div class=\"col-12\">\n                        <label class=\"form-label fw-semibold\">Discapacidad</label>\n                    </div>\n                    <div class=\"col-6\">\n                        ${crearMultiselect({\n                            opciones: discapacidades,\n                            id: 'revision_select_discapacidades',\n                            name: 'revision_select_discapacidades',\n                            class: 'input-dinamico',\n                            input_container_class: 'mb-0',\n                            placeholder: 'Discapacidad',\n                            onchange: 'seleccionarDiscapacidadRevision(this.value)',\n                            required: true,\n                        })}\n                    </div>\n                    <div class=\"col-6\" id=\"contenedor-otra-discapacidad-revision\"></div>\n                </div>\n            </div>\n        `);\n        inizializarMultiselect();\n    }\n}\n\n/**\n * Maneja la selección de tipo de discapacidad\n *\n * @param {string} discapacidad_id - ID de la discapacidad\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction seleccionarDiscapacidadRevision(discapacidad_id) {\n    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val() || [];\n    if (discapacidades_seleccionadas.includes('5')) {\n        let otra_discapacidad_existente = $('#revision_otra_discapacidad').length > 0;\n        if (!otra_discapacidad_existente) {\n            $('#contenedor-otra-discapacidad-revision').append(`\n                ${crearInput({\n                    id: 'revision_otra_discapacidad',\n                    name: 'revision_otra_discapacidad',\n                    class: 'input-dinamico',\n                    input_container_class: 'mb-0',\n                    label: '¿Cuál?',\n                    required: true,\n                })}\n            `);\n        }\n    } else {\n        $('#contenedor-otra-discapacidad-revision').empty();\n    }\n}\n\n/**\n * Muestra los niveles educativos agregados (reutiliza lógica de crear.js)\n *\n * @returns {void}\n * @author Andres Gonzalez\n * @author Jair Carvajal\n */\nfunction mostrarNivelesEducativosRevision() {\n    $('#contenedor-niveles-educativos-revision').empty();\n    if (estudios.length > 0) {\n        // Ordenar estudios usando función global reutilizable\n        let estudios_ordenados = ordenarEstudiosPorFecha(estudios);\n\n        estudios_ordenados.forEach((estudio) => {\n            $('#contenedor-niveles-educativos-revision').append(`\n                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"nivel-educativo-revision-${estudio.indice_original}\">\n                    <div class=\"row mb-2\">\n                        <div class=\"col-12 col-lg\">\n                            <p class=\"mb-1 fw-bold text-gray-20\">${estudio.titulo}</p>\n                            <p class=\"text-body-3 mb-1\">\n                                ${estudio.fecha_inicio || estudio.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n                                ${estudio.fecha_inicio ? moment(estudio.fecha_inicio).format(\"MMM YYYY\") : ''}\n                                ${estudio.fecha_inicio && !estudio.fecha_fin ? ' - Actualmente' : estudio.fecha_fin ? ` - ${moment(estudio.fecha_fin).format(\"MMM YYYY\")}` : ''}\n                                ${estudio.jornada ? ` - ${estudio.jornada}` : ''}\n                            </p>\n                            <p class=\"text-body-3 mb-1\"><i class=\"bi bi-buildings text-headline-5 me-2\"></i> ${estudio.institucion_educativa}</p>\n                        </div>\n                        <div class=\"col-auto\">\n                            <div class=\"row justify-content-end\">\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-primary btn-circle',\n                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n                                        onclick: `editarNivelEducativoRevision(${estudio.indice_original})`\n                                    })}\n                                </div>\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-danger btn-circle',\n                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n                                        onclick: `eliminarNivelEducativoRevision(${estudio.indice_original})`\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-12 mt-3\">\n                            <div class=\"row justify-content-between\">\n                                <div class=\"col-auto\">\n                                    <p class=\"text-body-3 text-gray-10 mb-0\">${estudio.nivel_educativo || ''}</p>\n                                </div>\n                                <div class=\"col-auto\">\n                                    <div class=\"row justify-content-end align-items-center\">\n                                        ${estudio.graduado ? `\n                                            <div class=\"col-auto pe-0\">\n                                                <i class=\"bi bi-mortarboard text-headline-5 text-cta-blue\"></i>\n                                            </div>\n                                            <div class=\"col-auto text-body-3 text-gray-10\">\n                                                Graduado\n                                            </div>\n                                        ` : `\n                                            <div class=\"col-auto pe-0\">\n                                                <i class=\"bi ${estudio.jornada == 'Diurna' ? 'bi-sun' : estudio.jornada == 'Nocturna' ? 'bi-moon' : ''} text-headline-5 text-cta-blue\"></i>\n                                            </div>\n                                            <div class=\"col-auto text-body-3 text-gray-10\">\n                                                ${estudio.jornada ? 'Modalidad:' : ''} ${estudio.jornada || ''}\n                                            </div>\n                                        `}\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `);\n        });\n    }\n}\n\n/**\n * Muestra las experiencias laborales agregadas\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction mostrarExperienciasLaboralesRevision() {\n    $('#contenedor-experiencias-laborales-revision').empty();\n    if (experiencias.length > 0) {\n        $('#revision_no_experiencia').prop('disabled', true);\n        // Ordenar experiencias usando función global reutilizable\n        let experiencias_ordenadas = ordenarExperienciasPorFecha(experiencias);\n\n        experiencias_ordenadas.forEach((experiencia) => {\n            let modalidades = {1: 'Presencial', 2: 'Híbrido', 3: 'Remoto'};\n            let html_modalidad = experiencia.modalidad_trabajo_id ? `\n                <div class=\"mt-2\">\n                    <small class=\"text-gray-30\">Modalidad:</small>\n                    <span class=\"badge bg-primary ms-2\">${modalidades[experiencia.modalidad_trabajo_id]}</span>\n                </div>\n            ` : '';\n            let html_funciones = experiencia.funciones ? `\n                <div class=\"mt-2\">\n                    <small class=\"text-gray-30 d-block\">Funciones:</small>\n                    <p class=\"text-body-3 mb-0\">${experiencia.funciones}</p>\n                </div>\n            ` : '';\n            $('#contenedor-experiencias-laborales-revision').append(`\n                <div class=\"col-12 pt-3 px-3 mt-4 border rounded-3\" id=\"experiencia-laboral-revision-${experiencia.indice_original}\">\n                    <div class=\"row mb-2\">\n                        <div class=\"col-lg\">\n                            <p class=\"mb-1 fw-bold text-gray-20\">${experiencia.cargo}</p>\n                            <p class=\"text-body-3 mb-2\">\n                                ${experiencia.fecha_inicio || experiencia.fecha_fin ? `<i class=\"bi bi-calendar4 text-headline-5 me-2\"></i>` : ''}\n                                ${experiencia.fecha_inicio ? moment(experiencia.fecha_inicio).format(\"MMM YYYY\") + (experiencia.fecha_fin ? ` - ${moment(experiencia.fecha_fin).format(\"MMM YYYY\")}` : \" - Actualmente\") : \"\"}\n                                ${experiencia.fecha_inicio && experiencia.fecha_fin ? (() => {\n                                    let inicio = moment(experiencia.fecha_inicio);\n                                    let fin = moment(experiencia.fecha_fin);\n                                    let anios = fin.diff(inicio, 'years');\n                                    let meses = fin.diff(inicio.add(anios, 'years'), 'months');\n                                    let texto = '';\n                                    if (anios > 0) texto += `${anios} año${anios > 1 ? 's' : ''}`;\n                                    if (meses > 0) texto += `${anios > 0 ? ' y ' : ''}${meses} mes${meses > 1 ? 'es' : ''}`;\n                                    return texto ? ` | ${texto}` : '';\n                                })() : ''}\n                            </p>\n                            <p class=\"text-body-3 mb-1 fw-semibold text-gray-10\">${experiencia.empresa}</p>\n                            ${html_modalidad}\n                            ${html_funciones}\n                        </div>\n                        <div class=\"col-auto\">\n                            <div class=\"row justify-content-end\">\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-primary btn-circle',\n                                        texto: '<i class=\"bi bi-pencil-fill\"></i>',\n                                        onclick: `editarExperienciaLaboralRevision(${experiencia.indice_original})`\n                                    })}\n                                </div>\n                                <div class=\"col-auto ps-0\">\n                                    ${crearBoton({\n                                        clases: 'btn-outline-danger btn-circle',\n                                        texto: '<i class=\"bi bi-trash-fill\"></i>',\n                                        onclick: `eliminarExperienciaLaboralRevision(${experiencia.indice_original})`\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `);\n        });\n    } else {\n        $('#revision_no_experiencia').prop('disabled', false);\n    }\n}\n\n/**\n * Edita un nivel educativo existente (reutiliza variables de crear.js)\n *\n * @param {number} indice - Índice del nivel educativo a editar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction editarNivelEducativoRevision(indice) {\n    indice_editar = indice;\n    let estudio = estudios[indice];\n    $('#titulo').val(estudio.titulo);\n    $('#institucion_educativa').val(estudio.institucion_educativa);\n    $('#cursando_estudios').prop('checked', !estudio.graduado).trigger('change');\n    $('#nivel_educativo_id').val(estudio.nivel_educativo_id).trigger('change');\n    $('#fecha_inicio_estudio')[0]._flatpickr.setDate(estudio.fecha_inicio);\n    if ($('#fecha_fin_estudio').length > 0) {\n        $('#fecha_fin_estudio')[0]._flatpickr.setDate(estudio.fecha_fin || '');\n    }\n\n    // Ocultar el modal principal temporalmente sin destruirlo\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    // Abrir el modal secundario\n    $('#modal-agregar-nivel-educativo').modal('show');\n\n    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n    $('#modal-agregar-nivel-educativo').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-nivel-educativo');\n        indice_editar = null;\n    });\n}\n\n/**\n * Elimina un nivel educativo (reutiliza array de crear.js)\n *\n * @param {number} indice - Índice del nivel educativo a eliminar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction eliminarNivelEducativoRevision(indice) {\n    estudios.splice(indice, 1);\n    mostrarNivelesEducativosRevision();\n    mostrarToast('success', 'Nivel educativo eliminado exitosamente');\n}\n\n/**\n * Edita una experiencia laboral existente (reutiliza variables de crear.js)\n *\n * @param {number} indice - Índice de la experiencia laboral a editar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction editarExperienciaLaboralRevision(indice) {\n    indice_editar = indice;\n    let experiencia = experiencias[indice];\n    $('#cargo').val(experiencia.cargo);\n    $('#empresa').val(experiencia.empresa);\n    $('#actualmente_trabajo').prop('checked', experiencia.actualmente_trabajo).trigger('change');\n    $('#fecha_inicio_experiencia')[0]._flatpickr.setDate(experiencia.fecha_inicio);\n    if ($('#fecha_fin_experiencia').length) {\n        $('#fecha_fin_experiencia')[0]._flatpickr.setDate(experiencia.fecha_fin || '');\n    }\n    $('#modalidad_trabajo_id').val(experiencia.modalidad_trabajo_id || '').trigger('change');\n    $('#funciones').val(experiencia.funciones || '');\n\n    // Ocultar el modal principal temporalmente sin destruirlo\n    $('#modal-aplicacion-revision-hv').css('display', 'none');\n\n    // Abrir el modal secundario\n    $('#modal-agregar-experiencia-laboral').modal('show');\n\n    // Configurar evento para restaurar el modal principal y limpiar formulario al cerrar\n    $('#modal-agregar-experiencia-laboral').off('hidden.bs.modal.restaurar').on('hidden.bs.modal.restaurar', function() {\n        $('#modal-aplicacion-revision-hv').css('display', 'block');\n        limpiarFormulario('formulario-experiencia-laboral');\n        indice_editar = null;\n    });\n}\n\n/**\n * Elimina una experiencia laboral (reutiliza array de crear.js)\n *\n * @param {number} indice - Índice de la experiencia laboral a eliminar\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction eliminarExperienciaLaboralRevision(indice) {\n    experiencias.splice(indice, 1);\n    mostrarExperienciasLaboralesRevision();\n    mostrarToast('success', 'Experiencia laboral eliminada exitosamente');\n}\n\n/**\n * Validación adicional para formularios de revisión de HV\n * Esta función es llamada automáticamente por configurarFormulario()\n * Maneja: formulario-revision-hv, formulario-nivel-educativo, formulario-experiencia-laboral\n *\n * @param {string} formulario - ID del formulario a validar\n * @returns {boolean}\n * @author Andres Gonzalez\n */\nfunction validacionAdicionalRevisionHV(formulario) {\n    let valido = true;\n\n    if (formulario == 'formulario-nivel-educativo') {\n        let errores = $('#formulario-nivel-educativo').find('input.error , select.error , textarea.error');\n        if (errores.length == 0) {\n            let fecha_inicio = $('#fecha_inicio_estudio').val() ? moment($('#fecha_inicio_estudio').val(), 'YYYY-MM-DD') : null;\n            let fecha_fin = $('#fecha_fin_estudio').val() ? moment($('#fecha_fin_estudio').val(), 'YYYY-MM-DD') : null;\n            let fecha_actual = moment();\n\n            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de inicio del estudio no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de finalización del estudio no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n                valido = false;\n            }\n\n            if (valido) {\n                let estudio = {\n                    titulo: $('#titulo').val(),\n                    institucion_educativa: $('#institucion_educativa').val(),\n                    nivel_educativo_id: parseInt($('#nivel_educativo_id').val()),\n                    nivel_educativo: $('#nivel_educativo_id option:selected').text().trim(),\n                    graduado: $('#cursando_estudios').prop('checked') ? false : true,\n                    fecha_inicio: $('#fecha_inicio_estudio').val(),\n                    fecha_fin: $('#fecha_fin_estudio').val() || null,\n                    jornada: $('#jornada').val() || null,\n                }\n                if (indice_editar == null) {\n                    estudios.push(estudio);\n                } else {\n                    estudios[indice_editar] = estudio;\n                    indice_editar = null;\n                }\n                mostrarNivelesEducativosRevision();\n                $('#modal-agregar-nivel-educativo').modal('hide');\n                mostrarToast('success', 'Nivel educativo guardado exitosamente');\n            }\n        }\n        return false;\n    }\n\n    if (formulario == 'formulario-experiencia-laboral') {\n        let errores = $('#formulario-experiencia-laboral').find('input.error , select.error , textarea.error');\n        if (errores.length == 0) {\n            let fecha_inicio = $('#fecha_inicio_experiencia').val() ? moment($('#fecha_inicio_experiencia').val(), 'YYYY-MM-DD') : null;\n            let fecha_fin = $('#fecha_fin_experiencia').val() ? moment($('#fecha_fin_experiencia').val(), 'YYYY-MM-DD') : null;\n            let fecha_actual = moment();\n\n            if (fecha_inicio && fecha_inicio.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de inicio de la experiencia no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_fin && fecha_fin.isAfter(fecha_actual)) {\n                mostrarToast('danger', 'La fecha de finalización de la experiencia no puede ser una fecha futura.');\n                valido = false;\n            }\n            if (fecha_inicio && fecha_fin && fecha_fin.isBefore(fecha_inicio)) {\n                mostrarToast('danger', 'La fecha de finalización no puede ser menor a la fecha de inicio.');\n                valido = false;\n            }\n\n            if (valido) {\n                let modalidad_trabajo_id = $('#modalidad_trabajo_id').val();\n                let experiencia = {\n                    cargo: $('#cargo').val(),\n                    empresa: $('#empresa').val(),\n                    actualmente_trabajo: $('#actualmente_trabajo').prop('checked') ? 1 : 0,\n                    fecha_inicio: $('#fecha_inicio_experiencia').val(),\n                    fecha_fin: $('#fecha_fin_experiencia').val() || null,\n                    modalidad_trabajo_id: modalidad_trabajo_id ? parseInt(modalidad_trabajo_id) : null,\n                    funciones: $('#funciones').val() || '',\n                }\n                if (indice_editar == null) {\n                    experiencias.push(experiencia);\n                } else {\n                    experiencias[indice_editar] = experiencia;\n                    indice_editar = null;\n                }\n                mostrarExperienciasLaboralesRevision();\n                $('#modal-agregar-experiencia-laboral').modal('hide');\n                mostrarToast('success', 'Experiencia laboral guardada exitosamente');\n            }\n        }\n        return false;\n    }\n\n    if (formulario !== 'formulario-revision-hv') {\n        return true;\n    }\n\n    let errores = $('#formulario-revision-hv').find('input.error , select.error , textarea.error');\n    if (errores.length > 0) {\n        mostrarToast('danger', 'Faltan algunos datos obligatorios. Por favor, revisa la información e intenta nuevamente');\n        return false;\n    }\n\n    let salario = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n    if (salario < 0) {\n        mostrarToast('danger', 'El salario no puede ser un valor negativo.');\n        valido = false;\n    }\n\n    if ($('#revision_salario_maximo').length > 0) {\n        let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n        if (salario_maximo < 0) {\n            mostrarToast('danger', 'El salario máximo no puede ser un valor negativo.');\n            valido = false;\n        }\n        if (salario_maximo < salario) {\n            if (salario_maximo > 0) {\n                mostrarToast('danger', 'El salario máximo no puede ser menor que el salario mínimo.');\n            }\n            valido = false;\n        }\n    }\n\n    validarRangoSalarioRevision();\n\n    let habilidades_seleccionadas = $('#revision_select_habilidades').val();\n    $('#revision_hv_habilidades').val(Array.isArray(habilidades_seleccionadas) ? habilidades_seleccionadas.join(', ') : '');\n\n    let herramientas_seleccionadas = $('#revision_select_herramientas_tecnologicas').val();\n    $('#revision_hv_herramientas_tecnologicas').val(Array.isArray(herramientas_seleccionadas) ? herramientas_seleccionadas.join(', ') : '');    \n    $('#revision_hv_estudios').val(JSON.stringify(estudios.map(({ nivel_educativo, graduado, ...estudio }) => estudio)));\n\n    if (experiencias.length > 0) {\n        $('#revision_hv_experiencias_laborales').val(JSON.stringify(experiencias.map(({ actualmente_trabajo, ...experiencia }) => experiencia)));\n    } else {\n        $('#revision_hv_experiencias_laborales').val('');\n    }\n\n    let elementos_idiomas = $('.idioma');\n    let niveles = $('.nivel-idioma');\n    let idiomas_seleccionados = [];\n    for (let i = 0; i < elementos_idiomas.length; i++) {\n        idiomas_seleccionados.push({\n            idioma_id: parseInt($(elementos_idiomas[i]).val()),\n            nivel: $(niveles[i]).val()\n        });\n    }\n    if (idiomas_seleccionados.length == 0) {\n        $('#revision_hv_idiomas').val('');\n    } else {\n        $('#revision_hv_idiomas').val(JSON.stringify(idiomas_seleccionados));\n    }\n\n    let discapacidades_seleccionadas = $('#revision_select_discapacidades').val();\n    let discapacidades_finales = [];\n    let usuario_id = parseInt($('#revision_hv_usuario_id').val());\n    if (discapacidades_seleccionadas) {\n        discapacidades_seleccionadas.forEach(discapacidad_id => {\n            let discapacidad = discapacidades.find(d => d.id == discapacidad_id);\n            if (discapacidad) {\n                let otra_discapacidad = null;\n                if (discapacidad.id == '5') {\n                    otra_discapacidad = $('#revision_otra_discapacidad').val().trim();\n                }\n                discapacidades_finales.push({\n                    usuario_id: usuario_id,\n                    discapacidad_id: parseInt(discapacidad_id),\n                    otra_discapacidad: otra_discapacidad\n                });\n            }\n        });\n        $('#revision_hv_discapacidades').val(JSON.stringify(discapacidades_finales));\n    } else {\n        $('#revision_hv_discapacidades').val('');\n    }\n\n    if (estudios.length == 0) {\n        mostrarToast('danger', 'Debes agregar al menos un nivel educativo para continuar.');\n        valido = false;\n    }\n\n    valido = validarFechasInicio(estudios);\n\n    if (experiencias.length == 0 && !$('#revision_no_experiencia').prop('checked')) {\n        mostrarToast('danger', 'Debes agregar al menos una experiencia laboral para continuar.');\n        valido = false;\n    }\n\n    return valido;\n}\n\n/**\n * Callback después de enviar exitosamente el formulario de revisión HV\n *\n * @param {Object} respuesta - Respuesta del servidor\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction postSuccessRevisionHV(respuesta) {\n    $('#modal-aplicacion-revision-hv').modal('hide');\n    limpiarFormularioRevisionHV();\n\n    // Recargar la tabla de tareas pendientes\n    actualizarDatatables('tabla-tareas-pendientes');\n}\n\n/**\n * Función para validar las fechas de inicio\n *\n * @param {Object} estudios - estudios del aplicante\n * @returns {boolean}\n * @author Jair Carvajal\n */\nfunction validarFechasInicio(estudios) {\n    let error = true;\n    for (const ESTUDIO of estudios) {\n        if (ESTUDIO.fecha_inicio === null) {\n            mostrarToast('danger', `El título ${ESTUDIO.titulo}. le hace falta la fecha de inicio para continuar.`);\n            error = false;\n        }\n    }\n    return error;\n}\n\n/**\n * Valida el rango de salario\n *\n * @returns {boolean}\n * @author Andres Gonzalez\n */\nfunction validarRangoSalarioRevision() {\n    if ($('input[name=\"tipo_salario\"]:checked').val() !== 'rango') {\n        return true;\n    }\n    let salario_desde = parseFloat(limpiarCleave($('#revision_salario').val())) || 0;\n    let salario_maximo = parseFloat(limpiarCleave($('#revision_salario_maximo').val())) || 0;\n    let campo_hasta = $('#revision_salario_maximo');\n    let contenedor_hasta = campo_hasta.closest('.input-container');\n    campo_hasta.removeClass('error');\n    contenedor_hasta.siblings('label[for=\"revision_salario_maximo\"].error').remove();\n    if (salario_desde > 99 && salario_maximo > 99 && salario_desde >= salario_maximo) {\n        setTimeout(() => {\n            campo_hasta.addClass('error');\n            contenedor_hasta.after('<label for=\"revision_salario_maximo\" class=\"error text-red-cta\">El salario hasta no debe ser menor o igual al salario desde</label>');\n            return false;\n        }, 100);\n    }\n    return true;\n}\n\n/**\n * Limpiar formulario\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction limpiarFormularioRevisionHV() {\n    let formulario = $('#formulario-revision-hv');\n    formulario[0].reset();\n    formulario.find('.input-dinamico').removeClass('error');\n    formulario.find('label.error').remove();\n\n    $('#contenedor-idiomas-revision').empty();\n    $('#contenedor-discapacidad-revision').empty();\n    $('#contenedor-niveles-educativos-revision').empty();\n    $('#contenedor-experiencias-laborales-revision').empty();\n\n    $('#revision_select_habilidades').val('').trigger('change');\n    $('#revision_select_herramientas_tecnologicas').val('').trigger('change');\n    $('#revision_idiomas_seleccionados').val([]).multiselect('refresh');\n    $('#revision_select_discapacidades').val([]).multiselect('refresh');\n\n    $('#revision_opcion_licencia_conducir').prop('checked', false);\n    $('#revision_tipo_licencia').val('').prop('disabled', true).trigger('change');\n    $('#revision_vacante_apta_discapacitados').prop('checked', false);\n\n    estudios = [];\n    experiencias = [];\n    indice_editar = null;\n\n    inputsCleave();\n    actualizarSelect2();\n}\n","structuredPatch":[{"oldStart":162,"oldLines":6,"newStart":162,"newLines":13,"lines":[" ","     $('#id').val(perfil.id);"," ","+    // Pre-seleccionar modalidad de trabajo","+    if (perfil.modalidad_trabajo_id) {","+        setTimeout(() => {","+            $(`input[name=\"modalidad_trabajo_id\"][value=\"${perfil.modalidad_trabajo_id}\"]`).prop('checked', true);","+        }, 100);","+    }","+","     if (perfil.salario) {","         if (perfil.salario_maximo) {","             $('input[name=\"tipo_salario\"][value=\"rango\"]').prop('checked', true).trigger('change');"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"968db7ea-0757-425c-9771-caee23ad1454","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"assistant","timestamp":"2026-01-08T21:32:30.268Z","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PwE3v6T9H1EAZ1hVwWJQFF","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. He agregado el código para pre-seleccionar la modalidad de trabajo cuando se carga el perfil laboral existente del usuario.\n\n## Resumen de los cambios realizados:\n\n### 1. **Servicio Backend** ([EtapaVacanteUsuarioService.php](c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php:541))\n- Agregué el parámetro `$forzar_actualizacion` (por defecto `false`) a la función `guardarPuntajeAdecuacionReclutador`\n- Modificada la validación para omitir el chequeo de `is_null($etapa_usuario->puntaje)` cuando `$forzar_actualizacion = true`\n\n### 2. **Frontend JavaScript** ([aplicacion-revision-hv.js](c:\\laragon\\www\\psicoalianza-2\\public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js:166-170))\n- Agregué código en la función `preRellenarFormularioRevisionHV` para seleccionar automáticamente el radio button de modalidad de trabajo según el valor `modalidad_trabajo_id` que viene del backend\n\n## Cómo funciona:\n\nCuando el backend devuelve:\n```json\n{\n    \"data\": {\n        \"id\": 6,\n        \"usuario_id\": 25,\n        \"modalidad_trabajo_id\": 3,\n        \"salario\": 3541545,\n        ...\n    }\n}\n```\n\nAhora el frontend:\n1. Detecta que `perfil.modalidad_trabajo_id` existe y tiene valor `3`\n2. Selecciona automáticamente el radio button con `value=\"3\"` (que sería \"Remoto\")\n3. Lo hace con un pequeño timeout de 100ms para asegurar que los componentes estén renderizados\n\nEl radio button correspondiente quedará marcado correctamente en el modal."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":3368,"cache_read_input_tokens":83107,"cache_creation":{"ephemeral_5m_input_tokens":3368,"ephemeral_1h_input_tokens":0},"output_tokens":506,"service_tier":"standard"},"context_management":null},"requestId":"req_011CWvdG4trTxgi74rQw7BWb","uuid":"6cd7e5a9-098b-44c3-b874-866eab6d740f"}
{"parentUuid":"6cd7e5a9-098b-44c3-b874-866eab6d740f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 631 to 633 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php:\nif ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n                \n                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"tengo esto asi if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n                \n                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) { quiro unificar el segundo if con el primero"}]},"uuid":"ce6b53f8-8f47-434a-a7b7-4f08de5ab95e","timestamp":"2026-01-09T16:20:36.096Z"}
{"parentUuid":"ce6b53f8-8f47-434a-a7b7-4f08de5ab95e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01NUyzyvT2pVkZMumhLD8Gcn","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a leer el contexto completo de esa sección para entender mejor la estructura y unificar los condicionales correctamente:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":85647,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":85647,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWx7JZugbx8a2avprYTSD","type":"assistant","uuid":"c847deb5-767f-44a4-bb62-19b970fa3b04","timestamp":"2026-01-09T16:20:41.847Z"}
{"parentUuid":"c847deb5-767f-44a4-bb62-19b970fa3b04","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01NUyzyvT2pVkZMumhLD8Gcn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GXVF2oH5ufH28DUUF293wZ","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","offset":610,"limit":50}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":85647,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":85647,"ephemeral_1h_input_tokens":0},"output_tokens":158,"service_tier":"standard"}},"requestId":"req_011CWx7JZugbx8a2avprYTSD","type":"assistant","uuid":"57f69f6e-7e2e-4184-8b8e-aff3b02c8317","timestamp":"2026-01-09T16:20:44.026Z"}
{"parentUuid":"57f69f6e-7e2e-4184-8b8e-aff3b02c8317","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GXVF2oH5ufH28DUUF293wZ","type":"tool_result","content":"   610→\n   611→    /**\n   612→     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n   613→     *\n   614→     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n   615→     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n   616→     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n   617→     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n   618→     * @author Daniel Beltrán\n   619→     */\n   620→    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n   621→        $formato_diligenciado = false;\n   622→        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n   623→            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n   624→            'movimiento_vacante_id'   => $movimiento_vacante_id,\n   625→            'incluir_configuraciones' => true\n   626→        ]));\n   627→\n   628→        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n   629→\n   630→        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n   631→            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n   632→                \n   633→                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n   634→\n   635→            } else {\n   636→                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n   637→            }\n   638→        } else {\n   639→            $formato_diligenciado = true;\n   640→        }\n   641→\n   642→        return $formato_diligenciado;\n   643→    }\n   644→\n   645→    /**\n   646→     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n   647→     *\n   648→     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n   649→     * @param int $usuario_id ID del usuario (aplicante).\n   650→     * @return void\n   651→     * @author Daniel Beltrán\n   652→     */\n   653→    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n   654→        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n   655→            'etapa_vacante_id' => $etapa_vacante_id,\n   656→            'usuario_id'       => $usuario_id\n   657→        ]));\n   658→\n   659→        if ($etapa_usuario->activo) {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fcbc72d2-a53d-489e-8e1c-b80c50dbfb16","timestamp":"2026-01-09T16:20:45.310Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","content":"\n    /**\n     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n     * @author Daniel Beltrán\n     */\n    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n        $formato_diligenciado = false;\n        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n            'movimiento_vacante_id'   => $movimiento_vacante_id,\n            'incluir_configuraciones' => true\n        ]));\n\n        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n                \n                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n\n            } else {\n                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n            }\n        } else {\n            $formato_diligenciado = true;\n        }\n\n        return $formato_diligenciado;\n    }\n\n    /**\n     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n     *\n     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n     * @param int $usuario_id ID del usuario (aplicante).\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id' => $etapa_vacante_id,\n            'usuario_id'       => $usuario_id\n        ]));\n\n        if ($etapa_usuario->activo) {","numLines":50,"startLine":610,"totalLines":1323}},"sourceToolAssistantUUID":"57f69f6e-7e2e-4184-8b8e-aff3b02c8317"}
{"parentUuid":"fcbc72d2-a53d-489e-8e1c-b80c50dbfb16","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BCkSf4wFN6uAo8ogg8ABU5","type":"message","role":"assistant","content":[{"type":"text","text":"Veo que el código está incompleto. Parece que falta lógica dentro del if de la línea 633 y también falta definir la variable `$formato_entrevista`. Déjame ver un poco más arriba y abajo para entender mejor:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1168,"cache_read_input_tokens":85647,"cache_creation":{"ephemeral_5m_input_tokens":1168,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWx7KEtxrsNcxELt23s6b","type":"assistant","uuid":"0b51ba4c-1cc8-4c1c-958a-3b83da4cf12d","timestamp":"2026-01-09T16:20:50.378Z"}
{"parentUuid":"0b51ba4c-1cc8-4c1c-958a-3b83da4cf12d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01BCkSf4wFN6uAo8ogg8ABU5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WmoxSW282oeG1qqJ6LgmRk","name":"Grep","input":{"pattern":"formato_entrevista","path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","output_mode":"content","-B":2,"-A":2}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1168,"cache_read_input_tokens":85647,"cache_creation":{"ephemeral_5m_input_tokens":1168,"ephemeral_1h_input_tokens":0},"output_tokens":230,"service_tier":"standard"}},"requestId":"req_011CWx7KEtxrsNcxELt23s6b","type":"assistant","uuid":"c987b180-57f7-4603-af99-19fc0e6b1d45","timestamp":"2026-01-09T16:20:51.747Z"}
{"parentUuid":"c987b180-57f7-4603-af99-19fc0e6b1d45","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WmoxSW282oeG1qqJ6LgmRk","type":"tool_result","content":"91-     * @param ResultadoAgendaService $resultado_agenda_servicio Servicio de resultados de agendas.\n92-     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n93:     * @param FormatoEntrevistaRepository $formato_entrevista_repositorio Repositorio de formatos de entrevista.\n94-     * @return void\n95-     * @author Daniel Beltrán\n--\n116-        protected ResultadoAgendaService $resultado_agenda_servicio,\n117-        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n118:        protected FormatoEntrevistaRepository $formato_entrevista_repositorio\n119-    ) {\n120-        parent::__construct($repositorio);\n--\n556-                } else {\n557-                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n558:                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n559-                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n560-                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n--\n626-        ]));\n627-\n628:        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n629-\n630:        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n631-            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n632-                \n633:                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n634-\n635-            } else {\n--\n855-\n856-        if ($etapa_usuario->etapa->nombre === EtapaVacante::ENTREVISTA_NOMBRE) {\n857:            if ($this->configuracion_modelo_servicio->obtenerValorLlaveConfiguracion(app(VacanteService::class)->obtenerConfiguracionesEtapaAplicante($etapa_usuario->etapa_vacante_id), 'solicitar_formato_entrevista')) {\n858:                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n859-\n860:                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n861-                    $etapa_completada = true;\n862-                }"}]},"uuid":"195b428b-5540-45ae-a662-d350912a86a6","timestamp":"2026-01-09T16:20:54.234Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"91-     * @param ResultadoAgendaService $resultado_agenda_servicio Servicio de resultados de agendas.\n92-     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n93:     * @param FormatoEntrevistaRepository $formato_entrevista_repositorio Repositorio de formatos de entrevista.\n94-     * @return void\n95-     * @author Daniel Beltrán\n--\n116-        protected ResultadoAgendaService $resultado_agenda_servicio,\n117-        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n118:        protected FormatoEntrevistaRepository $formato_entrevista_repositorio\n119-    ) {\n120-        parent::__construct($repositorio);\n--\n556-                } else {\n557-                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n558:                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n559-                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n560-                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n--\n626-        ]));\n627-\n628:        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n629-\n630:        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n631-            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n632-                \n633:                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n634-\n635-            } else {\n--\n855-\n856-        if ($etapa_usuario->etapa->nombre === EtapaVacante::ENTREVISTA_NOMBRE) {\n857:            if ($this->configuracion_modelo_servicio->obtenerValorLlaveConfiguracion(app(VacanteService::class)->obtenerConfiguracionesEtapaAplicante($etapa_usuario->etapa_vacante_id), 'solicitar_formato_entrevista')) {\n858:                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n859-\n860:                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n861-                    $etapa_completada = true;\n862-                }","numLines":37},"sourceToolAssistantUUID":"c987b180-57f7-4603-af99-19fc0e6b1d45"}
{"parentUuid":"195b428b-5540-45ae-a662-d350912a86a6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01S2qnjwo9KUHpFxqkx8oJ7w","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto, ahora entiendo. En la función `verificarFormatoEntrevista`, para el caso de VIDEOENTREVISTA, falta obtener el `$formato_entrevista` y el código está incompleto. Voy a corregir esta función unificando los condicionales y completando la lógica basándome en el patrón que se usa en la línea 858:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1016,"cache_read_input_tokens":86815,"cache_creation":{"ephemeral_5m_input_tokens":1016,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWx7KtoGWYiFNxgQoCxqL","type":"assistant","uuid":"bffd2df2-ef81-4360-8223-43d4ff7895f7","timestamp":"2026-01-09T16:20:59.551Z"}
{"parentUuid":"bffd2df2-ef81-4360-8223-43d4ff7895f7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01S2qnjwo9KUHpFxqkx8oJ7w","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WWug8jFFiZS9KwwC8Puep8","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","old_string":"        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n                \n                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n\n            } else {\n                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n            }\n        } else {\n            $formato_diligenciado = true;\n        }","new_string":"        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n\n                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n                    $formato_diligenciado = true;\n                }\n            } else {\n                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n            }\n        } else {\n            $formato_diligenciado = true;\n        }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1016,"cache_read_input_tokens":86815,"cache_creation":{"ephemeral_5m_input_tokens":1016,"ephemeral_1h_input_tokens":0},"output_tokens":714,"service_tier":"standard"}},"requestId":"req_011CWx7KtoGWYiFNxgQoCxqL","type":"assistant","uuid":"0e37d2f0-4bb7-49a8-bde5-2c69830985d1","timestamp":"2026-01-09T16:21:04.727Z"}
{"parentUuid":"0e37d2f0-4bb7-49a8-bde5-2c69830985d1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WWug8jFFiZS9KwwC8Puep8","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   624→            'movimiento_vacante_id'   => $movimiento_vacante_id,\n   625→            'incluir_configuraciones' => true\n   626→        ]));\n   627→\n   628→        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n   629→\n   630→        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n   631→            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n   632→                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n   633→\n   634→                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n   635→                    $formato_diligenciado = true;\n   636→                }\n   637→            } else {\n   638→                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n   639→            }\n   640→        } else {\n   641→            $formato_diligenciado = true;\n   642→        }\n   643→\n   644→        return $formato_diligenciado;\n   645→    }\n   646→"}]},"uuid":"cea29813-4805-4c75-b485-751f4221746a","timestamp":"2026-01-09T16:21:12.963Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","oldString":"        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n                \n                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n\n            } else {\n                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n            }\n        } else {\n            $formato_diligenciado = true;\n        }","newString":"        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n\n                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n                    $formato_diligenciado = true;\n                }\n            } else {\n                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n            }\n        } else {\n            $formato_diligenciado = true;\n        }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Vacantes;\n\nuse App\\Traits\\IATrait;\nuse App\\Traits\\StringTrait;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Vacantes\\Vacante;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Agendas\\EstadoAgenda;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Support\\Facades\\Mail;\nuse App\\Models\\Vacantes\\EtapaVacante;\nuse App\\Models\\Vacantes\\EstadoVacante;\nuse App\\Models\\Vacantes\\MovimientoVacante;\nuse App\\Mail\\NotificarFinalizacionEtapaMail;\nuse App\\Mail\\NotificarPostulanteVacanteMail;\nuse App\\Models\\Vacantes\\EtapaVacanteUsuario;\nuse Illuminate\\Http\\Client\\RequestException;\nuse App\\Http\\Services\\Vacantes\\VacanteService;\nuse App\\Models\\Configuraciones\\PlantillaCorreo;\nuse Illuminate\\Http\\Client\\ConnectionException;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Services\\Usuarios\\TokenAccesoService;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Services\\Vacantes\\EtapaVacanteService;\nuse App\\Jobs\\Vacantes\\ProcesarVideoentrevistaIAJob;\nuse App\\Http\\Repositories\\Procesos\\ProcesoRepository;\nuse App\\Http\\Repositories\\Vacantes\\VacanteRepository;\nuse App\\Http\\Services\\Agendas\\ResultadoAgendaService;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse App\\Notifications\\NotificarAvanceProcesoNotification;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteRepository;\nuse App\\Http\\Repositories\\Vacantes\\TranscripcionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Vacantes\\AspectoPuntajeRepository;\nuse App\\Http\\Services\\Configuraciones\\PlantillaCorreoService;\nuse App\\Http\\Repositories\\Vacantes\\FormatoEntrevistaRepository;\nuse App\\Http\\Repositories\\Vacantes\\EtapaVacanteUsuarioRepository;\nuse App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\nuse App\\Http\\Repositories\\Vacantes\\EtapaMovimientoVacanteRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PreguntaOfertaLaboralRepository;\nuse App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\nuse App\\Http\\Repositories\\OfertasLaborales\\PuntajePreguntaOfertaLaboralRepository;\n\n/**\n * @property EtapaVacanteUsuarioRepository $repositorio\n */\nclass EtapaVacanteUsuarioService extends BaseService\n{\n    use ArchivoTrait, IATrait, StringTrait;\n\n    /**\n     * @var float|int $puntaje_total Puntaje total, utilizado para la adecuación de HV.\n     */\n    private $puntaje_total = 0;\n\n    /**\n     * @var float $puntaje Puntaje de aspecto, utilizado para la adecuación de HV.\n     */\n    private $puntaje = 0;\n\n    /**\n     * @var bool $cumple Indica si cumple con el aspecto, utilizada para la adecuación de HV.\n     */\n    private $cumple = false;\n\n    /**\n     * Constructor.\n     *\n     * @param EtapaVacanteUsuarioRepository $repositorio Repositorio de etapas de vacantes de usuarios.\n     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n     * @param EtapaVacanteRepository $etapa_vacante_repositorio Repositorio de etapas de vacantes.\n     * @param AspectoPuntajeRepository $aspecto_puntaje_repositorio Repositorio de puntajes de aspectos.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio Repositorio de preguntas de ofertas laborales.\n     * @param PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio Repositorio de puntajes de preguntas de ofertas laborales.\n     * @param EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio Repositorio de movimientos de etapas de vacantes.\n     * @param ProcesoRepository $proceso_repositorio Repositorio de procesos.\n     * @param TranscripcionRepository $transcripcion_repositorio Repositorio de transcripciones.\n     * @param PlantillaCorreoService $plantilla_correo_servicio Servicio de plantillas de correo.\n     * @param TokenAccesoService $token_acceso_servicio Servicio de tokens de acceso.\n     * @param UserRepository $usuario_repositorio Servicio de usuarios.\n     * @param VacanteRepository $vacante_repositorio Repositorio de vacantes.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param ResultadoAgendaService $resultado_agenda_servicio Servicio de resultados de agendas.\n     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n     * @param FormatoEntrevistaRepository $formato_entrevista_repositorio Repositorio de formatos de entrevista.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function __construct(\n        EtapaVacanteUsuarioRepository $repositorio,\n        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n        protected EtapaVacanteRepository $etapa_vacante_repositorio,\n        protected AspectoPuntajeRepository $aspecto_puntaje_repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected PreguntaOfertaLaboralRepository $pregunta_oferta_laboral_repositorio,\n        protected PuntajePreguntaOfertaLaboralRepository $puntaje_pregunta_oferta_laboral_repositorio,\n        protected EtapaMovimientoVacanteRepository $etapa_movimiento_vacante_repositorio,\n        protected ProcesoRepository $proceso_repositorio,\n        protected TranscripcionRepository $transcripcion_repositorio,\n        protected PlantillaCorreoService $plantilla_correo_servicio,\n        protected TokenAccesoService $token_acceso_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected VacanteRepository $vacante_repositorio,\n        protected AgendaRepository $agenda_repositorio,\n        protected ResultadoAgendaService $resultado_agenda_servicio,\n        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n        protected FormatoEntrevistaRepository $formato_entrevista_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar documento solicitado de una etapa de vacante de usuario.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function guardarDocumentoSolicitado(Request $request): void {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n        if ($request->hasFile('archivo')) {\n            $this->archivo_servicio->guardarVarios(EtapaVacanteUsuario::class, $request->etapa_vacante_usuario_id, [$request->nombre_documento => $request->file('archivo')], 'empresas/' . $empresa->id . '/documentos-solicitados', true);\n        }\n    }\n\n    /**\n     * Establecer valores para puntaje y cumplimiento de un aspecto.\n     *\n     * @param float $puntaje Puntaje obtenido.\n     * @param bool $cumple Indica si cumple.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function establecerPuntajeCumplimiento(float $puntaje = 0, bool $cumple = false): void {\n        $this->puntaje = $puntaje;\n        $this->cumple  = $cumple;\n    }\n\n    /**\n     * Guardar puntaje de un aspecto evaluado.\n     *\n     * @param int $etapa_vacante_usuario_id ID de la etapa del usuario en la vacante.\n     * @param string $categoria Categoría del aspecto.\n     * @param string $aspecto Aspecto evaluado.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    private function guardarAspectoPuntaje(int $etapa_vacante_usuario_id, string $categoria, string $aspecto): void {\n        $this->aspecto_puntaje_repositorio->crearOActualizar([\n            'etapa_vacante_usuario_id' => $etapa_vacante_usuario_id,\n            'categoria'                => $categoria,\n            'aspecto'                  => $aspecto\n        ], [\n            'puntaje'                  => $this->puntaje,\n            'cumple'                   => $this->cumple\n        ]);\n\n        $this->puntaje_total += $this->puntaje;\n        $this->establecerPuntajeCumplimiento();\n    }\n\n    /**\n     * Generar adecuación de hoja de vida.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionHV(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::REVISION_HV_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $perfil_laboral = $this->perfil_laboral_repositorio->getUnoAvanzado(new Request([\n                'usuario_id'                     => $etapa_usuario->usuario_id,\n                'incluir_experiencias_laborales' => true,\n                'incluir_estudios'               => true,\n                'incluir_idiomas'                => true,\n                'incluir_usuario'                => true\n            ]));\n\n            // Generar y guardar la adecuación del perfil de candidato (habilidades y herramientas tecnológicas)\n            $categoria            = 'perfil';\n            $puntaje_aspecto      = 100 / 2;\n            $datos_vacante        = $etapa_usuario->vacante->datos;\n            $habilidades_vacante  = $datos_vacante->where('llave', 'habilidades')->first();\n            $herramientas_vacante = $datos_vacante->where('llave', 'herramientas_tecnologicas')->first();\n\n            // Validar coincidencia para las habilidades\n            if (!is_null($habilidades_vacante->valor) && !empty($habilidades_vacante->valor)) {\n                $habilidades_vacante        = array_map(fn($item) => trim($item), explode(',', $habilidades_vacante->valor));\n                $habilidades_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->habilidades));\n                $coincidencias              = count(array_uintersect($habilidades_vacante, $habilidades_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($habilidades_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'habilidades');\n\n            // Validar coincidencia para las herramientas tecnológicas\n            if (!is_null($herramientas_vacante->valor) && !empty($herramientas_vacante->valor)) {\n                $herramientas_vacante        = array_map(fn($item) => trim($item), explode(',', $herramientas_vacante->valor));\n                $herramientas_perfil_laboral = array_map(fn($item) => trim($item), explode(',', $perfil_laboral->herramientas_tecnologicas));\n                $coincidencias               = count(array_uintersect($herramientas_vacante, $herramientas_perfil_laboral, 'strcasecmp'));\n\n                if ($coincidencias >= count($herramientas_vacante)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'herramientas');\n\n            // Generar y guardar la adecuación de requisitos del candidato (género, edad, nivel educativo, modalidad de trabajo, salario, experiencia, idiomas, licencia de conducir)\n            $categoria       = 'requisito';\n            $puntaje_aspecto = 100 / 8;\n\n            // Validar coincidencia de género\n            $genero_vacante = $datos_vacante->where('llave', 'genero')->first();\n\n            if (!is_null($genero_vacante) && !empty($genero_vacante)) {\n                if ($genero_vacante->valor === mb_convert_case($perfil_laboral->usuario->genero->nombre, MB_CASE_LOWER)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                } elseif ($genero_vacante->valor === 'indiferente') {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'genero');\n\n            // Validar coincidencia de edad\n            $edad_minima_vacante = $datos_vacante->where('llave', 'edad_minima')->first();\n            $edad_maxima_vacante = $datos_vacante->where('llave', 'edad_maxima')->first();\n\n            if (empty($edad_minima_vacante->valor) || empty($edad_maxima_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($perfil_laboral->usuario->edad >= $edad_minima_vacante->valor && $perfil_laboral->usuario->edad <= $edad_maxima_vacante->valor) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'edad');\n\n            // Validar coincidencia de nivel educativo\n            $nivel_educativo_vacante = $datos_vacante->where('llave', 'nivel_educativo')->first();\n            $escala_estudios         = [\n                'Preescolar'                      => 1,\n                'Primaria'                        => 2,\n                'Secundaria básica'               => 3,\n                'Secundaria superior'             => 4,\n                'Educación continua y permanente' => 5,\n                'Técnico'                         => 6,\n                'Tecnólogo'                       => 7,\n                'Profesional'                     => 8,\n                'Especialización (postgrado)'     => 9,\n                'Maestría (postgrado)'            => 10,\n                'Doctorado (postgrado)'           => 11\n            ];\n\n            if (empty($nivel_educativo_vacante->valor) || $nivel_educativo_vacante->valor === 'indiferente') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (count($perfil_laboral->estudios) > 0) {\n                $cumple_nivel_educativo = false;\n\n                foreach ($perfil_laboral->estudios as $estudio) {\n                    if ($escala_estudios[$nivel_educativo_vacante->valor] <= $escala_estudios[$estudio->nivelEducativo->nombre]) {\n                        $cumple_nivel_educativo = true;\n                        break;\n                    }\n                }\n\n                if ($cumple_nivel_educativo) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'estudios');\n\n            // Validar coincidencia de modalidad de trabajo\n            if (!is_null($etapa_usuario->vacante->modalidad_trabajo_id)) {\n                if ($etapa_usuario->vacante->modalidad_trabajo_id === $perfil_laboral->modalidad_trabajo_id) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'modalidad_trabajo');\n\n            // Validar coincidencia de salario\n            if (is_null($etapa_usuario->vacante->salario)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (!is_null($etapa_usuario->vacante->salario) && is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Salario fijo\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario de la vacante es fijo pero el del usuario es rango\n                    if (($etapa_usuario->vacante->salario >= $perfil_laboral->salario && $etapa_usuario->vacante->salario <= $perfil_laboral->salario_maximo) || ($perfil_laboral->salario <= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } elseif ($perfil_laboral->salario <= $etapa_usuario->vacante->salario) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (!is_null($etapa_usuario->vacante->salario) && !is_null($etapa_usuario->vacante->salario_maximo)) {\n                // Rango de salario\n                if (!is_null($perfil_laboral->salario_maximo)) {\n                    // Validar cuando el salario del usuario y de la vacante son rangos\n                    if (($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) || ($perfil_laboral->salario_maximo >= $etapa_usuario->vacante->salario && $perfil_laboral->salario_maximo <= $etapa_usuario->vacante->salario_maximo)) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                } else {\n                    if ($perfil_laboral->salario >= $etapa_usuario->vacante->salario && $perfil_laboral->salario <= $etapa_usuario->vacante->salario_maximo) {\n                        $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                    }\n                }\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'salario');\n\n            // Validar coincidencia de experiencia\n            $experiencia_vacante   = $datos_vacante->where('llave', 'experiencia_laboral')->first();\n            $experiencia_aplicante = $perfil_laboral->experienciasLaborales->sum('tiempo');\n            $experiencias          = [\n                '1 año'        => 1,\n                '2 años'       => 2,\n                '3 años'       => 3,\n                '4 años'       => 4,\n                '5 años o más' => 5\n            ];\n\n            if (empty($experiencia_vacante->valor) || $experiencia_vacante->valor === 'Sin experiencia') {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif ($experiencia_vacante->valor === 'Menos de 1 año') {\n                if ($experiencia_aplicante > 0 && $experiencia_aplicante < 365) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif (($experiencias[$experiencia_vacante->valor] * 365) <= $experiencia_aplicante) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'experiencia');\n\n            // Validar coincidencia de idiomas\n            $idiomas_vacante = $etapa_usuario->vacante->idiomas;\n            $escala_idiomas  = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'C1' => 5,\n                'C2' => 6\n            ];\n\n            if ($idiomas_vacante->count() > 0) {\n                $coincidencias_idiomas = 0;\n\n                if ($perfil_laboral->idiomas->count() > 0) {\n                    foreach ($idiomas_vacante as $idioma) {\n                        foreach ($perfil_laboral->idiomas as $idioma_perfil) {\n                            if ($idioma->idioma_id === $idioma_perfil->idioma_id && $escala_idiomas[$idioma->nivel] <= $escala_idiomas[$idioma_perfil->nivel]) {\n                                $coincidencias_idiomas++;\n                            }\n                        }\n                    }\n                }\n\n                if ($coincidencias_idiomas >= $idiomas_vacante->count()) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } else {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'idiomas');\n\n            // Validar coincidencia de licencia de conducir\n            $licencia_conducir_vacante = $datos_vacante->where('llave', 'licencia_conducir')->first();\n            $escala_licencias          = [\n                'A1' => 1,\n                'A2' => 2,\n                'B1' => 3,\n                'B2' => 4,\n                'B3' => 5,\n                'C1' => 6,\n                'C2' => 7,\n                'C3' => 8\n            ];\n\n            if (empty($licencia_conducir_vacante->valor)) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            } elseif (is_null($perfil_laboral->licencia_conducir)) {\n                if (empty($licencia_conducir_vacante->valor)) {\n                    $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n                }\n            } elseif ($escala_licencias[$licencia_conducir_vacante->valor] <= $escala_licencias[$perfil_laboral->licencia_conducir]) {\n                $this->establecerPuntajeCumplimiento($puntaje_aspecto, true);\n            }\n\n            $this->guardarAspectoPuntaje($etapa_usuario->id, $categoria, 'licencia_conducir');\n\n            $puntaje_total = round($this->puntaje_total / 2); // Se divide entre las dos categorías existentes\n            $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::REVISION_HV_ID, $puntaje_total, 'descartar_candidatos_adecuaciones_bajas_hv', 'descartar_candidatos_adecuaciones_medias_hv');\n        }\n    }\n\n    /**\n     * Generar adecuación para preguntas prefiltro.\n     *\n     * Califica las respuestas del aplicante en cada una de las preguntas y calcula la adecuación en base a sus resultados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPrefiltro(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'   => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'         => $etapa_usuario->usuario_id,\n                'incluir_respuestas' => true\n            ]));\n\n            $porcentaje_pregunta  = 100 / $preguntas->count();\n            $respuestas_correctas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                $puntaje    = null;\n                $puntaje_ia = null;\n\n                if ($pregunta->es_abierta) {\n                    $respuesta = $opcion_seleccionada = $pregunta->respuestas->first();\n\n                    if (!is_null($respuesta)) {\n                        try {\n                            $peticion_ia = $this->realizarPeticionIA(\n                                ruta: 'calificar-pregunta-abierta',\n                                parametros: [\n                                    'pregunta'  => $pregunta->enunciado,\n                                    'respuesta' => $respuesta->respuesta,\n                                ],\n                                contexto_tracking: [\n                                    'vacante_id' => $etapa_usuario->etapa->vacante_id ?? null,\n                                    'agenda_id' => null,\n                                ]\n                            );\n\n                            if (!is_null($peticion_ia) && $peticion_ia['status_code'] === 200) {\n                                $puntaje_ia = $peticion_ia['calificacion'];\n                            }\n                        } catch (RequestException|ConnectionException $error) {}\n                    }\n                } else {\n                    $opciones_correctas = $pregunta->opciones->where('es_correcta', true);\n\n                    // Selección única\n                    if ($opciones_correctas->count() === 1) {\n                        $opcion_correcta     = $opciones_correctas->first();\n                        $opcion_seleccionada = $pregunta->respuestas->first();\n                        $puntaje             = (int) (!is_null($opcion_seleccionada) && $opcion_correcta->id === $opcion_seleccionada->opcion_pregunta_id);\n                    } else { // Selección múltiple\n                        $opciones_correctas     = $opciones_correctas->pluck('id')->toArray();\n                        $opciones_seleccionadas = $pregunta->respuestas->pluck('opcion_pregunta_id')->toArray();\n                        $aciertos               = count(array_intersect($opciones_seleccionadas, $opciones_correctas));\n                        $fallos                 = count(array_diff($opciones_seleccionadas, $opciones_correctas));\n                        $puntaje                = (int) ($aciertos - $fallos === count($opciones_correctas));\n                    }\n                }\n\n                // Guardar el puntaje obtenido en cada pregunta\n                $this->puntaje_pregunta_oferta_laboral_repositorio->crearSiNoExiste([\n                    'pregunta_id' => $pregunta->id,\n                    'usuario_id'  => $etapa_usuario->usuario_id\n                ], [\n                    'puntaje'     => $puntaje,\n                    'puntaje_ia'  => $puntaje_ia\n                ]);\n\n                // Sumar el puntaje total\n                if (is_null($puntaje) && !is_null($puntaje_ia)) {\n                    $respuestas_correctas += $puntaje_ia;\n                } else {\n                    $respuestas_correctas += $puntaje;\n                }\n            }\n\n            $puntaje_etapa = $respuestas_correctas * $porcentaje_pregunta;\n\n            if ($etapa_usuario->vacante->automatizar_etapas) {\n                // Obtener el movimiento de la etapa con sus configuraciones\n                $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                    'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                    'movimiento_vacante_id'   => MovimientoVacante::PREGUNTAS_PREFILTRO_ID,\n                    'incluir_configuraciones' => true\n                ]));\n\n                $configuracion_preguntas_correctas = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', 'descartar_candidatos_respondieron_menos_preguntas_prefiltro')->first();\n\n                // Avanzar al aplicante de etapa o descartarlo según la configuración de la etapa\n                if (!is_null($configuracion_preguntas_correctas) && $configuracion_preguntas_correctas->valor <= $respuestas_correctas) {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa);\n                } else {\n                    $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje_etapa, descartar: true);\n                }\n            } else {\n                $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_etapa]);\n            }\n        }\n    }\n\n    /**\n     * Guardar el puntaje de adecuación dado por el reclutador.\n     *\n     * Guarda la adecuación para las etapas de prueba técnica, videoentrevista y entrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @param int $puntaje Puntaje dado por el reclutador.\n     * @param bool $forzar_actualizacion Si es true, omite la validación de puntaje nulo.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {\n            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n            }\n\n            if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::VIDEO_ENTREVISTA_NOMBRE, EtapaVacante::ENTREVISTA_NOMBRE])) {\n                if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE) {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_videoentrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_videoentrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_videoentrevista';\n                } else {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n                }\n\n                if ($this->verificarFormatoEntrevista($etapa_usuario, $movimiento_vacante_id, $llave_configuracion_formato)) {\n                    $this->gestionarContinuidadAplicante($etapa_usuario, $movimiento_vacante_id, $puntaje, $llave_configuracion_adecuaciones_bajas, $llave_configuracion_adecuaciones_medias);\n                } else {\n                    $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n                }\n\n                // TODO: Invocar esta función al momento de completar el formato de entrevista\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para pruebas psicométricas.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPruebasPsicometricas(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $indice_talento = $this->proceso_repositorio->obtenerIndiceTalento($etapa_usuario->vacante->proceso->id, $etapa_usuario->usuario_id)->indice_talento;\n\n            if ($indice_talento >= 0) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBAS_PSICOMETRICAS_ID, $indice_talento, 'descartar_candidatos_puntuaciones_bajas', 'descartar_candidatos_puntuaciones_medias', true);\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para videoentrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function generarAdecuacionVideoentrevista(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje_ia)) {\n            ProcesarVideoentrevistaIAJob::dispatch($etapa_usuario);\n        }\n    }\n\n    /**\n     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n     * @author Daniel Beltrán\n     */\n    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n        $formato_diligenciado = false;\n        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n            'movimiento_vacante_id'   => $movimiento_vacante_id,\n            'incluir_configuraciones' => true\n        ]));\n\n        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n                \n                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n\n            } else {\n                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n            }\n        } else {\n            $formato_diligenciado = true;\n        }\n\n        return $formato_diligenciado;\n    }\n\n    /**\n     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n     *\n     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n     * @param int $usuario_id ID del usuario (aplicante).\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id' => $etapa_vacante_id,\n            'usuario_id'       => $usuario_id\n        ]));\n\n        if ($etapa_usuario->activo) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id' => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'       => $etapa_usuario->usuario_id,\n                'incluir_puntajes' => true\n            ]));\n\n            $puntaje            = 0;\n            $puntaje_individual = 100 / $preguntas->count();\n\n            foreach ($preguntas as $pregunta) {\n                if (is_null($pregunta->puntajes[0]->puntaje) && !is_null($pregunta->puntajes[0]->puntaje_ia)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje_ia;\n                } elseif (!is_null($pregunta->puntajes[0]->puntaje)) {\n                    $puntaje += $pregunta->puntajes[0]->puntaje;\n                }\n            }\n\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje_individual * $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar el puntaje de la etapa actual y gestionar la continuidad del aplicante en la vacante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param int $puntaje Puntaje obtenido en la etapa actual.\n     * @param string $llave_puntajes_bajos Llave de configuración para puntajes bajos.\n     * @param string $llave_puntajes_medios Llave de configuración para puntajes medios.\n     * @param bool $escala_pruebas_psicometricas Indica si debe utilizar la escala de puntajes de pruebas psicométricas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function gestionarContinuidadAplicante(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, int $puntaje, string $llave_puntajes_bajos, string $llave_puntajes_medios, bool $escala_pruebas_psicometricas = false) {\n        if ($etapa_usuario->vacante->automatizar_etapas) {\n            $calificacion_baja  = 40;\n            $calificacion_media = 70;\n\n            if ($escala_pruebas_psicometricas) {\n                $calificacion_baja  = 59;\n                $calificacion_media = 75;\n            }\n\n            // Obtener el movimiento de la etapa con sus configuraciones\n            $etapa_movimiento = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n                'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n                'movimiento_vacante_id'   => $movimiento_vacante_id,\n                'incluir_configuraciones' => true\n            ]));\n\n            $configuracion_adecuaciones_bajas  = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_bajos)->first();\n            $configuracion_adecuaciones_medias = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_puntajes_medios)->first();\n\n            if (!is_null($configuracion_adecuaciones_medias) && filter_var($configuracion_adecuaciones_medias->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_media) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            } elseif (!is_null($configuracion_adecuaciones_bajas) && filter_var($configuracion_adecuaciones_bajas->valor, FILTER_VALIDATE_BOOLEAN) && $puntaje <= $calificacion_baja) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje, descartar: true);\n                return;\n            }\n\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $puntaje);\n        } else {\n            $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n        }\n    }\n\n    /**\n     * Guardar puntaje de la etapa actual y mover al aplicante a la siguiente etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param ?int $puntaje Puntaje obtenido en la etapa actual.\n     * @param ?int $puntaje_ia Puntaje obtenido por la IA en la etapa actual.\n     * @param ?string $notas_ia Notas dadas por la IA para la etapa actual.\n     * @param bool $descartar Indica si la etapa a la que se debe cambiar es 'descartados'.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     * @author Esperanza Olivo\n     */\n    public function guardarPuntajeYCambiarDeEtapa(EtapaVacanteUsuario $etapa_usuario, ?int $puntaje = null, ?int $puntaje_ia = null, ?string $notas_ia = null, bool $descartar = false): void {\n        if ($descartar) {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->getUnoAvanzado(new Request(['vacante_id' => $etapa_usuario->vacante->id, 'nombre' => EtapaVacante::DESCARTADOS_NOMBRE]));\n        } else {\n            $etapa_siguiente = $this->etapa_vacante_repositorio->obtenerEtapaSiguiente($etapa_usuario->vacante->id, $etapa_usuario->etapa->orden);\n        }\n\n        $etapa_actual_activa = true;\n\n        if ($etapa_siguiente->nombre !== EtapaVacante::CONTRATADOS_NOMBRE) {\n            $etapa_actual_activa = false;\n            $this->guardarEtapa($etapa_usuario, $etapa_siguiente);\n        } elseif (!$etapa_usuario->vacante->automatizar_etapas) {\n            $etapa_actual_activa = false;\n            $this->guardarEtapa($etapa_usuario, $etapa_siguiente);\n        }\n\n        $this->repositorio->actualizar($etapa_usuario->id, [\n            'puntaje'    => $puntaje,\n            'puntaje_ia' => $puntaje_ia,\n            'notas_ia'   => $notas_ia,\n            'activo'     => $etapa_actual_activa\n        ]);\n\n        // Cuando la etapa es contratado, se valida si ya se han completado las vacantes requeridas para cerrar la vacante\n        if ($etapa_siguiente->nombre === EtapaVacante::CONTRATADOS_NOMBRE) {\n            if ($etapa_usuario->vacante->cantidad_vacantes === $this->repositorio->contarContratados($etapa_usuario->etapa->vacante_id)) {\n                $this->vacante_repositorio->actualizar($etapa_usuario->etapa->vacante_id, ['estado_id' => EstadoVacante::COMPLETADA_ID]);\n\n                $aplicantes_activos_restantes_ids = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'excluir_etapas'         => [EtapaVacante::DESCARTADOS_NOMBRE, EtapaVacante::CONTRATADOS_NOMBRE]\n                ]))->pluck('id')->toArray();\n\n                // Descartar a los aplicantes que quedan activos en la vacante\n                $this->descartarAplicantesManual($aplicantes_activos_restantes_ids);\n\n                $aplicantes_activos_sin_notificar = $this->repositorio->getTodo(new Request([\n                    'vacante_id'             => $etapa_usuario->etapa->vacante_id,\n                    'activo'                 => true,\n                    'sin_fecha_notificacion' => true\n                ]));\n\n                foreach ($aplicantes_activos_sin_notificar as $aplicante) {\n                    $this->notificarCambioEtapa($aplicante, false);\n                }\n            }\n        }\n    }\n    \n    /**\n     * Crear y activar la siguiente etapa del aplicante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param EtapaVacante $etapa_siguiente Etapa siguiente a crear.\n     * @return ?EtapaVacanteUsuario\n     * @author Esperanza Olivo\n     */\n    public function guardarEtapa(EtapaVacanteUsuario $etapa_usuario, EtapaVacante $etapa_siguiente): ?EtapaVacanteUsuario {\n        $nueva_etapa_usuario = $this->repositorio->crear([\n            'usuario_id'       => $etapa_usuario->usuario_id,\n            'etapa_vacante_id' => $etapa_siguiente->id,\n            'activo'           => true\n        ]);\n\n        app(VacanteService::class)->crearAgendasPruebasPsicometricas($etapa_usuario, $etapa_siguiente->id);\n\n        if ($nueva_etapa_usuario) {\n            $this->notificarCambioEtapa($nueva_etapa_usuario);\n        }\n\n        return $nueva_etapa_usuario;\n    }\n\n    /**\n     * Obtener la adecuación actual del usuario en la vacante.\n     *\n     * @param int $usuario_id ID del usuario.\n     * @param int $vacante_id ID de la vacante.\n     * @return ?int\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function obtenerAdecuacionUsuario(int $usuario_id, int $vacante_id): ?int {\n        $etapas     = $this->repositorio->obtenerEtapasCompletadasUsuario($usuario_id, $vacante_id);\n        $adecuacion = 0;\n\n        foreach ($etapas as $etapa) {\n            if (!is_null($etapa->puntaje)) {\n                $adecuacion += $etapa->puntaje;\n            } elseif (is_null($etapa->puntaje) && !is_null($etapa->puntaje_ia)) {\n                $adecuacion += $etapa->puntaje_ia;\n            }\n        }\n\n        return ($etapas->count() > 0) ? $adecuacion / $etapas->count() : null;\n    }\n\n    /**\n     * Verificar si una etapa ya ha sido completada por el aplicante.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante (etapa_vacante_usuario_id).\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function verificarEtapaCompletada(int $id): bool {\n        $etapa_usuario    = $this->repositorio->getUno($id);\n        $etapa_completada = false;\n\n        // Verificar si la etapa de revisión de hoja de vida ya fue completada\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::REVISION_HV_NOMBRE, EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE]) && !is_null($etapa_usuario->puntaje) || !is_null($etapa_usuario->puntaje_ia)) {\n            $etapa_completada = true;\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::ENTREVISTA_NOMBRE) {\n            if ($this->configuracion_modelo_servicio->obtenerValorLlaveConfiguracion(app(VacanteService::class)->obtenerConfiguracionesEtapaAplicante($etapa_usuario->etapa_vacante_id), 'solicitar_formato_entrevista')) {\n                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n\n                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n                    $etapa_completada = true;\n                }\n            } else {\n                $etapa_completada = true;\n            }\n        }\n\n        // Verificar si las etapas de preguntas prefiltro o videoentrevista ya han sido completadas\n        if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE, EtapaVacante::VIDEO_ENTREVISTA_NOMBRE])) {\n            $preguntas = $this->pregunta_oferta_laboral_repositorio->getTodo(new Request([\n                'etapa_vacante_id'                      => $etapa_usuario->etapa_vacante_id,\n                'usuario_id'                            => $etapa_usuario->usuario_id,\n                'incluir_cantidad_respuestas_aplicante' => true\n            ]));\n\n            $preguntas_contestadas = 0;\n\n            foreach ($preguntas as $pregunta) {\n                if ($pregunta['respuestas_count'] > 0) {\n                    $preguntas_contestadas++;\n                }\n            }\n\n            // Validar que todas las preguntas hayan sido contestadas\n            if (count($preguntas) === $preguntas_contestadas) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n            if ((!is_null($etapa_usuario->pruebaTecnica?->enlace) && !empty($etapa_usuario->pruebaTecnica?->enlace) || $etapa_usuario->pruebaTecnica?->archivos->count() > 0) && $etapa_usuario->pruebaTecnica?->borrador == false) {\n                $etapa_completada = true;\n            }\n        }\n\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE) {\n            $documentos_contratacion = app(EtapaVacanteService::class)->obtenerDocumentosContratacion(\n                $etapa_usuario->etapa_vacante_id,\n                new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id])\n            );\n\n            $documentos_solicitados     = collect($documentos_contratacion['documentos']);\n            $archivos_guardados         = collect($documentos_contratacion['archivos_guardados']);\n            $archivos_guardados_nombres = $archivos_guardados->pluck('nombre')->toArray();\n\n            $todos_cargados = true;\n            foreach ($documentos_solicitados as $documento) {\n                $nombre_normalizado = $this->normalizarNombreDocumento($documento['nombre']);\n\n                if (!in_array($nombre_normalizado, $archivos_guardados_nombres)) {\n                    $todos_cargados = false;\n                    break;\n                }\n            }\n\n            if ($todos_cargados && $documentos_solicitados->count() > 0) {\n                $etapa_completada = true;\n            }\n        }\n\n        return $etapa_completada;\n    }\n\n    /**\n     * Notificar documentos solicitados.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function notificarDocumentosSolicitados(int $id): void {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_vacante_usuario) {\n            $this->enviarCorreoFinalizacionEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->vacante);\n        }\n    }\n\n    /**\n     * Descartar uno o varios aplicantes manualmente y moverlos a la etapa de descartados.\n     *\n     * @param array $ids IDs de las etapas de usuarios en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function descartarAplicantesManual(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_vacante_usuario = $this->repositorio->getUno($id);\n\n            if ($etapa_vacante_usuario) {\n                $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n            }\n        }\n    }\n\n    /**\n     * Revertir descarte de aplicantes.\n     *\n     * @param array $ids IDs de las etapas de los usuarios descartados en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function revertirDescarteAplicantes(array $ids): void {\n        foreach ($ids as $id) {\n            $etapa_descartado = $this->repositorio->getUno($id);\n\n            if ($etapa_descartado && $etapa_descartado->etapa->nombre === EtapaVacante::DESCARTADOS_NOMBRE && $etapa_descartado->activo) {\n                $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $etapa_descartado->vacante->id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n                $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n                $etapa_previa          = $this->repositorio->obtenerEtapaPrevia($etapa_descartado->usuario_id, $etapas_ids);\n\n                if ($etapa_previa) {\n                    $this->repositorio->eliminar($etapa_descartado->id);\n                    $this->repositorio->actualizar($etapa_previa->id, ['activo' => true]);\n                }\n            }\n        }\n    }\n\n    /**\n     * Mover manualmente al aplicante a la siguiente etapa.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function moverAplicanteEtapaManual(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n        $this->guardarPuntajeYCambiarDeEtapa($etapa_usuario, $etapa_usuario->puntaje ?? 0);\n    }\n\n    /**\n     * Marcar la vacante como abandonada por el aplicante.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Andres Gonzalez\n     * @author Daniel Beltrán\n     */\n    public function abandonarVacante(Request $request): void {\n        $etapas_no_descartados = $this->etapa_vacante_repositorio->getTodo(new Request(['vacante_id' => $request->vacante_id]))->where('nombre', '!=', EtapaVacante::DESCARTADOS_NOMBRE);\n        $etapas_ids            = $etapas_no_descartados->pluck('id')->toArray();\n        $etapa_vacante_usuario = $this->repositorio->obtenerEtapaPrevia($request->usuario_id, $etapas_ids);\n\n        if ($etapa_vacante_usuario) {\n            $this->repositorio->actualizar($etapa_vacante_usuario->id, ['motivo_abandono' => $request->motivo_abandono]);\n            $this->guardarPuntajeYCambiarDeEtapa($etapa_vacante_usuario, $etapa_vacante_usuario->puntaje ?? 0, descartar: true);\n        }\n    }\n\n    /**\n     * Notificar al aplicante sobre el cambio de etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa actual del usuario.\n     * @param bool $aplicar_validacion_fin_proceso Indica si se debe aplicar la validación de fin de proceso.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    public function notificarCambioEtapa(EtapaVacanteUsuario $etapa_usuario, bool $aplicar_validacion_fin_proceso = true): void {\n        $etapa_usuario->load(['etapa', 'vacante', 'usuario']);\n        $etapa = $etapa_usuario->etapa;\n\n        $plantilla_correo_id = [\n            EtapaVacante::PREGUNTAS_PREFILTRO_NOMBRE     => PlantillaCorreo::PREGUNTAS_PRE_FILTRO_ID,\n            EtapaVacante::PRUEBA_TECNICA_NOMBRE          => PlantillaCorreo::ENVIO_PRUEBA_TECNICA_ID,\n            EtapaVacante::VIDEO_ENTREVISTA_NOMBRE        => PlantillaCorreo::SOLICITUD_VIDEOENTREVISTAS_ID,\n            EtapaVacante::ENTREVISTA_NOMBRE              => PlantillaCorreo::NOTIFICACION_ENTREVISTA_ID,\n            EtapaVacante::DOCUMENTOS_CONTRATACION_NOMBRE => PlantillaCorreo::SOLICITUD_DOCUMENTOS_ID,\n            EtapaVacante::CONTRATADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_CONTRATADOS_ID,\n            EtapaVacante::DESCARTADOS_NOMBRE             => PlantillaCorreo::NOTIFICACION_DESCARTADOS_ID\n        ][$etapa->nombre] ?? null;\n\n        if (isset($plantilla_correo_id)) {\n            $plantilla_correo_etapa = $this->plantilla_correo_servicio->obtenerUno(new Request([\n                'plantilla_correo_id' => $plantilla_correo_id,\n                'empresa_id'          => $etapa_usuario->vacante->empresa_id\n            ]));\n\n            if (!is_null($plantilla_correo_etapa)) {\n                $es_etapa_fin_proceso = in_array($etapa->nombre, [\n                    EtapaVacante::CONTRATADOS_NOMBRE,\n                    EtapaVacante::DESCARTADOS_NOMBRE\n                ]);\n\n                // Si es etapa de fin de proceso y notificar_fin_proceso es true, no enviar notificación\n                if ($aplicar_validacion_fin_proceso && $es_etapa_fin_proceso && $plantilla_correo_etapa->notificar_fin_proceso) {\n                    return;\n                }\n\n                $usuario            = $etapa_usuario->usuario;\n                $vacante            = $etapa_usuario->vacante;\n                $token_acceso       = $this->token_acceso_servicio->generar($usuario->id);\n                $enlace             = request()->getSchemeAndHttpHost() . \"/control-acceso/{$token_acceso->token}?vacante_id={$vacante->id}\";\n                $usuario_informador = null;\n\n                Mail::to($usuario->email)->queue(new NotificarPostulanteVacanteMail(\n                    $usuario,\n                    $enlace,\n                    $vacante,\n                    $plantilla_correo_etapa->titulo,\n                    $plantilla_correo_etapa->contenido,\n                    $plantilla_correo_etapa->con_logo_empresa,\n                    $etapa->nombre,\n                    $usuario_informador\n                ));\n\n                // Enviar notificación de avance en el proceso\n                $usuario->notify(new NotificarAvanceProcesoNotification(\n                    $vacante->id,\n                    $vacante->nombre_vacante,\n                    $etapa->nombre,\n                    $vacante->empresa->nombre ?? 'la empresa'\n                ));\n\n                $this->repositorio->actualizar($etapa_usuario->id, ['fecha_notificacion' => now()]);\n            }\n        }\n    }\n\n    /**\n     * Enviar correo de notificación al finalizar una etapa.\n     *\n     * @param EtapaVacanteUsuario $etapa_vacante_usuario Etapa del usuario en la vacante.\n     * @param Vacante $vacante Vacante.\n     * @return void\n     * @author Jair Carvajal\n     */\n    private function enviarCorreoFinalizacionEtapa(EtapaVacanteUsuario $etapa_vacante_usuario, Vacante $vacante): void {\n        $usuario     = Auth::user();\n        $maneja_logo = file_exists(public_path('empresas-logo/' . $vacante->empresa->id)) ? '1' : null;\n\n        Mail::send(new NotificarFinalizacionEtapaMail(\n            $usuario,\n            $vacante,\n            $etapa_vacante_usuario->etapa,\n            $maneja_logo\n        ));\n    }\n\n    /**\n     * Obtener candidatos recomendados con IA.\n     *\n     * Obtiene los 3 mejores candidatos para la vacante, entre varios candidatos seleccionados por el reclutador.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function obtenerCandidatosRecomendadosIA(Request $request): array {\n        $vacante       = $this->vacante_repositorio->getUno($request->vacante_id);\n        $candidatos    = $this->usuario_repositorio->obtenerCandidatosSeleccionadosVacante($request->usuarios_ids, $request->vacante_id);\n        $candidatos_ia = [];\n        $vacante_ia    = [\n            ...Arr::only($vacante->toArray(), ['nombre_vacante', 'salario', 'salario_maximo']),\n            'habilidades'               => $vacante->datos->first(fn($item) => $item->llave === 'habilidades')->valor,\n            'herramientas_tecnologicas' => $vacante->datos->first(fn($item) => $item->llave === 'herramientas_tecnologicas')->valor,\n            'experiencia_laboral'       => $vacante->datos->first(fn($item) => $item->llave === 'experiencia_laboral')->valor,\n            'nivel_educativo'           => $vacante->datos->first(fn($item) => $item->llave === 'nivel_educativo')->valor\n        ];\n\n        if (!is_null($vacante->ciudad_id)) {\n            $direccion_trabajo = $vacante->datos->first(fn($item) => $item->llave === 'direccion_trabajo')->valor;\n            $ubicacion_empresa = \"{$vacante->ciudad->departamento->pais->nombre}, {$vacante->ciudad->departamento->nombre} - {$vacante->ciudad->nombre}, {$direccion_trabajo}\";\n        } elseif (!is_null($vacante->empresa->ciudad_id)) {\n            $ubicacion_empresa = \"{$vacante->empresa->ciudad->departamento->pais->nombre}, {$vacante->empresa->ciudad->departamento->nombre} - {$vacante->empresa->ciudad->nombre}, {$vacante->empresa->direccion}\";\n        }\n\n        if (isset($ubicacion_empresa)) {\n            $vacante_ia['ubicacion'] = $ubicacion_empresa;\n        }\n\n        foreach ($candidatos as $candidato) {\n            if (!is_null($candidato->ciudad_id) && !is_null($candidato->direccion)) {\n                $ubicacion = \"{$candidato->ciudad->departamento->pais->nombre}, {$candidato->ciudad->departamento->nombre} - {$candidato->ciudad->nombre}, {$candidato->direccion}\";\n            }\n\n            $usuario = [\n                ...Arr::only($candidato->toArray(), ['id', 'nombre_completo', 'email', 'telefono', 'edad']),\n                'adecuacion' => $this->obtenerAdecuacionUsuario($candidato->id, $request->vacante_id)\n            ];\n\n            if (isset($ubicacion)) {\n                $usuario['ubicacion'] = $ubicacion;\n            }\n\n            if (!is_null($candidato->perfilLaboral)) {\n                $usuario['salario']                   = $candidato->perfilLaboral->salario;\n                $usuario['salario_maximo']            = $candidato->perfilLaboral->salario_maximo;\n                $usuario['habilidades']               = $candidato->perfilLaboral->habilidades;\n                $usuario['herramientas_tecnologicas'] = $candidato->perfilLaboral->herramientas_tecnologicas;\n                $usuario['estudios']                  = [];\n                $usuario['experiencias_laborales']    = [];\n                $usuario['idiomas']                   = [];\n                $usuario['etapas']                    = [];\n\n                foreach ($candidato->perfilLaboral->estudios as $item) {\n                    array_push($usuario['estudios'], [\n                        ...Arr::only($item->toArray(), ['titulo', 'fecha_inicio', 'fecha_fin']),\n                        'nivel_educativo' => $item->nivelEducativo->nombre,\n                    ]);\n                }\n\n                foreach ($candidato->perfilLaboral->experienciasLaborales as $item) {\n                    array_push($usuario['experiencias_laborales'], [...Arr::only($item->toArray(), ['empresa', 'cargo', 'fecha_inicio', 'fecha_fin', 'tiempo'])]);\n                }\n\n                foreach ($candidato->perfilLaboral->idiomas as $item) {\n                    array_push($usuario['idiomas'], [\n                        'idioma' => $item->idioma->nombre,\n                        'nivel'  => $item->nivel\n                    ]);\n                }\n\n                foreach ($candidato->etapasUsuarios as $item) {\n                    $datos_etapas = [\n                        'nombre'      => $item->etapa->nombre,\n                        'puntaje'     => $item->puntaje,\n                        'puntaje_ia'  => $item->puntaje_ia,\n                        'comentarios' => $item->comentarios->pluck('comentario')->values()->toArray()\n                    ];\n\n                    if ($item->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE) {\n                        $agendas = $this->agenda_repositorio->getTodo(new Request([\n                            'proceso_id'         => $vacante->proceso->id,\n                            'evaluado_id'        => $item->usuario_id,\n                            'estado_id'          => EstadoAgenda::FINALIZADA_ID,\n                            'incluir_resultados' => true\n                        ]));\n\n                        $datos_etapas['pruebas_psicometricas'] = [];\n\n                        foreach ($agendas as $agenda) {\n                            array_push($datos_etapas['pruebas_psicometricas'], [\n                                'prueba'     => $agenda->prueba->nombre,\n                                'ajuste'     => $agenda->ajuste,\n                                'resultados' => $agenda->resultados->map(function ($resultado) {\n                                    return [\n                                        'dimension' => $resultado->dimension->nombre,\n                                        'puntaje'   => $resultado->puntaje_transformado\n                                    ];\n                                })->values()->toArray()\n                            ]);\n                        }\n\n                        if (count($datos_etapas['pruebas_psicometricas']) === 0) {\n                            unset($datos_etapas['pruebas_psicometricas']);\n                        }\n                    }\n\n                    array_push($usuario['etapas'], $datos_etapas);\n                }\n            }\n\n            array_push($candidatos_ia, $usuario);\n        }\n\n        return $this->realizarPeticionIA('obtener-candidatos-recomendados', [\n            'vacante_id' => $request->vacante_id,\n            'vacante'    => json_encode($vacante_ia, JSON_UNESCAPED_UNICODE),\n            'candidatos' => json_encode($candidatos_ia, JSON_UNESCAPED_UNICODE)\n        ]);\n    }\n\n    /**\n     * Obtener competencias por mejorar para usuario que será contratado.\n     * SOLO Buscar agendas de TenDisc Plus (12) y Potencial Comercial (7)\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return array\n     * @author Sergio Vargas\n     */\n    public function obtenerCompetenciasPorMejorar(int $id): array {\n        $etapa_vacante_usuario = $this->repositorio->getUno($id);\n        $usuario_id = $etapa_vacante_usuario->usuario_id;\n        $proceso = $etapa_vacante_usuario->vacante->proceso;\n\n        if (is_null($proceso)) {\n            return ['pruebas' => []];\n        }\n\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id' => $proceso->id,\n            'evaluado_id' => $usuario_id,\n            'pruebas_ids' => [12, 7],\n            'estado_id' => 3,\n            'con_evaluado' => true\n        ]));\n\n        $resultado = ['pruebas' => []];\n\n        foreach ($agendas as $agenda) {\n            $competencias_bajas = $this->extraerCompetenciasBajas($agenda);\n\n            if (!empty($competencias_bajas)) {\n                $resultado['pruebas'][] = [\n                    'prueba_id' => $agenda->prueba_id,\n                    'nombre_prueba' => $agenda->prueba->nombre,\n                    'competencias' => $competencias_bajas\n                ];\n            }\n        }\n\n        return $resultado;\n    }\n\n    /**\n     * Extraer las 2 competencias más bajas de una agenda según su prueba.\n     *\n     * @param \\App\\Models\\Agendas\\Agenda $agenda Agenda finalizada.\n     * @return array\n     * @author Sergio Vargas\n     */\n    private function extraerCompetenciasBajas($agenda): array {\n        $resultados = $this->resultado_agenda_servicio->gestionarResultados($agenda);\n\n        if (empty($resultados)) {\n            return [];\n        }\n\n        $competencias_todas = [];\n\n        // TenDisc Plus (prueba_id = 12)\n        if ($agenda->prueba_id === 12) {\n            $factor_especificas = collect($resultados)->firstWhere('nombre', 'Competencias Específicas');\n            $factor_transversales = collect($resultados)->firstWhere('nombre', 'Competencias Transversales');\n\n            if ($factor_especificas) {\n                $competencias_todas = array_merge($competencias_todas, $factor_especificas['dimensiones']);\n            }\n            if ($factor_transversales) {\n                $competencias_todas = array_merge($competencias_todas, $factor_transversales['dimensiones']);\n            }\n        }\n\n        // Potencial Comercial (prueba_id = 7)\n        if ($agenda->prueba_id === 7) {\n            $factor_caracter = collect($resultados)->firstWhere('nombre', 'Carácter');\n            $factor_habilidades = collect($resultados)->firstWhere('nombre', 'Habilidades');\n\n            if ($factor_caracter) {\n                $competencias_todas = array_merge($competencias_todas, $factor_caracter['dimensiones']);\n            }\n            if ($factor_habilidades) {\n                $competencias_todas = array_merge($competencias_todas, $factor_habilidades['dimensiones']);\n            }\n        }\n\n        // Ordenar por puntaje ascendente y tomar las 2 más bajas\n        return collect($competencias_todas)\n            ->sortBy('puntaje_transformado')\n            ->take(2)\n            ->map(fn($c) => [\n                'nombre' => $c['nombre'],\n                'puntaje' => round($c['puntaje_transformado'], 0)\n            ])\n            ->values()\n            ->toArray();\n    }\n}\n","structuredPatch":[{"oldStart":629,"oldLines":9,"newStart":629,"newLines":11,"lines":[" ","         if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {","             if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {","-                ","-                if (!is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {","+                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));"," ","+                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {","+                    $formato_diligenciado = true;","+                }","             } else {","                 $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);","             }"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"0e37d2f0-4bb7-49a8-bde5-2c69830985d1"}
{"parentUuid":"cea29813-4805-4c75-b485-751f4221746a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_015wS4RjTh9uDKdFAYBBmm24","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto. He corregido y completado la función `verificarFormatoEntrevista`. Los cambios realizados fueron:\n\n## Correcciones aplicadas:\n\n1. **Agregada la obtención del formato de entrevista** (línea 632):\n   - Se obtiene el formato de entrevista desde el repositorio usando el `etapa_vacante_usuario_id`\n\n2. **Unificado el condicional** (línea 634):\n   - Se combinó la validación de `!is_null($formato_entrevista)` con las validaciones de `descripcion_vacante`\n   - Ahora verifica que el formato exista, que `descripcion_vacante` no sea null Y que no esté vacío\n\n3. **Agregada la asignación correcta** (línea 635):\n   - Cuando se cumple la condición, se marca `$formato_diligenciado = true`\n\n## Lógica de la función:\n\nLa función ahora maneja correctamente ambos casos:\n- **VIDEOENTREVISTA**: Busca el formato de entrevista y verifica si tiene `descripcion_vacante` completado\n- **ENTREVISTA**: Usa el método `verificarEtapaCompletada` existente\n\nEn ambos casos, si la configuración no existe o está deshabilitada, retorna `true` por defecto."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1216,"cache_read_input_tokens":87831,"cache_creation":{"ephemeral_5m_input_tokens":1216,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWx7MPwF5s6fsYc3Zc25h","type":"assistant","uuid":"5ff8e4a9-e453-497b-abc4-a3c56e554643","timestamp":"2026-01-09T16:21:25.323Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-09T16:22:12.155Z","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8"}
{"type":"file-history-snapshot","messageId":"9279a884-4037-4089-9dfe-f1aed185a392","snapshot":{"messageId":"9279a884-4037-4089-9dfe-f1aed185a392","trackedFileBackups":{"app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php":{"backupFileName":"5419cff174eb966b@v4","version":4,"backupTime":"2026-01-09T16:22:12.894Z"},"public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js":{"backupFileName":"0a63c33c166bea46@v2","version":2,"backupTime":"2026-01-09T16:20:36.153Z"}},"timestamp":"2026-01-09T16:22:12.865Z"},"isSnapshotUpdate":false}
{"parentUuid":"5ff8e4a9-e453-497b-abc4-a3c56e554643","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"tengo este ero [{\n\t\"resource\": \"/c:/laragon/www/psicoalianza-2/app/Http/Services/Vacantes/EtapaVacanteUsuarioService.php\",\n\t\"owner\": \"_generated_diagnostic_collection_name_#0\",\n\t\"severity\": 8,\n\t\"message\": \"syntax error, unexpected token \\\"public\\\"\",\n\t\"startLineNumber\": 653,\n\t\"startColumn\": 1,\n\t\"endLineNumber\": 653,\n\t\"endColumn\": 2147483648,\n\t\"origin\": \"extHost1\"\n}]"}]},"uuid":"9279a884-4037-4089-9dfe-f1aed185a392","timestamp":"2026-01-09T16:22:12.862Z"}
{"parentUuid":"9279a884-4037-4089-9dfe-f1aed185a392","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01ViPLukmsZHFa9PR2L5i8qb","type":"message","role":"assistant","content":[{"type":"text","text":"Hay un error de sintaxis. Parece que falta cerrar una llave o hay algún problema de estructura. Déjame revisar el código alrededor de la línea 645-653:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":3689,"cache_read_input_tokens":89047,"cache_creation":{"ephemeral_5m_input_tokens":3689,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWx7Rgvon4D9uja1WewnB","type":"assistant","uuid":"937a39a9-71f5-4cdd-9da3-3b48832ff44f","timestamp":"2026-01-09T16:22:17.554Z"}
{"parentUuid":"937a39a9-71f5-4cdd-9da3-3b48832ff44f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01ViPLukmsZHFa9PR2L5i8qb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AHkyxtEyaGfnf3EaHYNjZe","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","offset":640,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":3689,"cache_read_input_tokens":89047,"cache_creation":{"ephemeral_5m_input_tokens":3689,"ephemeral_1h_input_tokens":0},"output_tokens":172,"service_tier":"standard"}},"requestId":"req_011CWx7Rgvon4D9uja1WewnB","type":"assistant","uuid":"0139d8ed-7481-48b1-8154-b03dacd6fd14","timestamp":"2026-01-09T16:22:18.650Z"}
{"parentUuid":"0139d8ed-7481-48b1-8154-b03dacd6fd14","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AHkyxtEyaGfnf3EaHYNjZe","type":"tool_result","content":"   640→        } else {\n   641→            $formato_diligenciado = true;\n   642→        }\n   643→\n   644→        return $formato_diligenciado;\n   645→    }\n   646→\n   647→    /**\n   648→     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n   649→     *\n   650→     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n   651→     * @param int $usuario_id ID del usuario (aplicante).\n   652→     * @return void\n   653→     * @author Daniel Beltrán\n   654→     */\n   655→    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n   656→        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n   657→            'etapa_vacante_id' => $etapa_vacante_id,\n   658→            'usuario_id'       => $usuario_id\n   659→        ]));\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"81e80bcc-c671-420a-8a7d-18eb8c72d2dc","timestamp":"2026-01-09T16:22:19.893Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","content":"        } else {\n            $formato_diligenciado = true;\n        }\n\n        return $formato_diligenciado;\n    }\n\n    /**\n     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n     *\n     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n     * @param int $usuario_id ID del usuario (aplicante).\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id' => $etapa_vacante_id,\n            'usuario_id'       => $usuario_id\n        ]));","numLines":20,"startLine":640,"totalLines":1325}},"sourceToolAssistantUUID":"0139d8ed-7481-48b1-8154-b03dacd6fd14"}
{"parentUuid":"81e80bcc-c671-420a-8a7d-18eb8c72d2dc","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LiiH5e8B4Lt4uw8YMN1ctn","type":"message","role":"assistant","content":[{"type":"text","text":"El código se ve correcto alrededor de esa área. El problema debe estar antes. Déjame verificar la función `guardarPuntajeAdecuacionReclutador` completa para asegurarme de que esté bien cerrada:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":544,"cache_read_input_tokens":92736,"cache_creation":{"ephemeral_5m_input_tokens":544,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWx7SD2JRJ9JCgP5zhd2Y","type":"assistant","uuid":"97ed8a6d-12bc-4f72-909f-1b182115ae56","timestamp":"2026-01-09T16:22:25.839Z"}
{"parentUuid":"97ed8a6d-12bc-4f72-909f-1b182115ae56","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LiiH5e8B4Lt4uw8YMN1ctn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U3R7LZotHpgjtFzkR7ZhBv","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","offset":542,"limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":544,"cache_read_input_tokens":92736,"cache_creation":{"ephemeral_5m_input_tokens":544,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWx7SD2JRJ9JCgP5zhd2Y","type":"assistant","uuid":"dcc06122-398b-4a90-9cc3-8acd94aa02b7","timestamp":"2026-01-09T16:22:26.380Z"}
{"parentUuid":"dcc06122-398b-4a90-9cc3-8acd94aa02b7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U3R7LZotHpgjtFzkR7ZhBv","type":"tool_result","content":"   542→    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {\n   543→        $etapa_usuario = $this->repositorio->getUno($id);\n   544→\n   545→        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {\n   546→            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n   547→                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n   548→            }\n   549→\n   550→            if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::VIDEO_ENTREVISTA_NOMBRE, EtapaVacante::ENTREVISTA_NOMBRE])) {\n   551→                if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE) {\n   552→                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID;\n   553→                    $llave_configuracion_formato             = 'solicitar_formato_videoentrevista';\n   554→                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_videoentrevista';\n   555→                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_videoentrevista';\n   556→                } else {\n   557→                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n   558→                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n   559→                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n   560→                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n   561→                }\n   562→\n   563→                if ($this->verificarFormatoEntrevista($etapa_usuario, $movimiento_vacante_id, $llave_configuracion_formato)) {\n   564→                    $this->gestionarContinuidadAplicante($etapa_usuario, $movimiento_vacante_id, $puntaje, $llave_configuracion_adecuaciones_bajas, $llave_configuracion_adecuaciones_medias);\n   565→                } else {\n   566→                    $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n   567→                }\n   568→\n   569→                // TODO: Invocar esta función al momento de completar el formato de entrevista\n   570→            }\n   571→        }\n   572→    }\n   573→\n   574→    /**\n   575→     * Generar adecuación para pruebas psicométricas.\n   576→     *\n   577→     * @param int $id ID de la etapa del usuario en la vacante.\n   578→     * @return void\n   579→     * @author Daniel Beltrán\n   580→     */\n   581→    public function generarAdecuacionPruebasPsicometricas(int $id): void {\n   582→        $etapa_usuario = $this->repositorio->getUno($id);\n   583→\n   584→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   585→        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n   586→            $indice_talento = $this->proceso_repositorio->obtenerIndiceTalento($etapa_usuario->vacante->proceso->id, $etapa_usuario->usuario_id)->indice_talento;\n   587→\n   588→            if ($indice_talento >= 0) {\n   589→                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBAS_PSICOMETRICAS_ID, $indice_talento, 'descartar_candidatos_puntuaciones_bajas', 'descartar_candidatos_puntuaciones_medias', true);\n   590→            }\n   591→        }\n   592→    }\n   593→\n   594→    /**\n   595→     * Generar adecuación para videoentrevista.\n   596→     *\n   597→     * @param int $id ID de la etapa del usuario en la vacante.\n   598→     * @return void\n   599→     * @author Daniel Beltrán\n   600→     * @author Andres Gonzalez\n   601→     */\n   602→    public function generarAdecuacionVideoentrevista(int $id): void {\n   603→        $etapa_usuario = $this->repositorio->getUno($id);\n   604→\n   605→        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n   606→        if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje_ia)) {\n   607→            ProcesarVideoentrevistaIAJob::dispatch($etapa_usuario);\n   608→        }\n   609→    }\n   610→\n   611→    /**\n   612→     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n   613→     *\n   614→     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n   615→     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n   616→     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n   617→     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n   618→     * @author Daniel Beltrán\n   619→     */\n   620→    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n   621→        $formato_diligenciado = false;\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3f91356b-6d93-416b-9efa-d7932bfb5601","timestamp":"2026-01-09T16:22:27.613Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","content":"    public function guardarPuntajeAdecuacionReclutador(int $id, int $puntaje, bool $forzar_actualizacion = false): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        if ($etapa_usuario->activo && ($forzar_actualizacion || is_null($etapa_usuario->puntaje))) {\n            if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBA_TECNICA_NOMBRE) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBA_TECNICA_ID, $puntaje, 'descartar_candidatos_adecuaciones_bajas_prueba_tecnica', 'descartar_candidatos_adecuaciones_medias_prueba_tecnica');\n            }\n\n            if (in_array($etapa_usuario->etapa->nombre, [EtapaVacante::VIDEO_ENTREVISTA_NOMBRE, EtapaVacante::ENTREVISTA_NOMBRE])) {\n                if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE) {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_videoentrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_videoentrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_videoentrevista';\n                } else {\n                    $movimiento_vacante_id                   = MovimientoVacante::SOLICITUD_ENTREVISTA_ID;\n                    $llave_configuracion_formato             = 'solicitar_formato_entrevista';\n                    $llave_configuracion_adecuaciones_bajas  = 'descartar_candidatos_adecuaciones_bajas_entrevista';\n                    $llave_configuracion_adecuaciones_medias = 'descartar_candidatos_adecuaciones_medias_entrevista';\n                }\n\n                if ($this->verificarFormatoEntrevista($etapa_usuario, $movimiento_vacante_id, $llave_configuracion_formato)) {\n                    $this->gestionarContinuidadAplicante($etapa_usuario, $movimiento_vacante_id, $puntaje, $llave_configuracion_adecuaciones_bajas, $llave_configuracion_adecuaciones_medias);\n                } else {\n                    $this->repositorio->actualizar($etapa_usuario->id, ['puntaje' => $puntaje]);\n                }\n\n                // TODO: Invocar esta función al momento de completar el formato de entrevista\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para pruebas psicométricas.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function generarAdecuacionPruebasPsicometricas(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::PRUEBAS_PSICOMETRICAS_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje)) {\n            $indice_talento = $this->proceso_repositorio->obtenerIndiceTalento($etapa_usuario->vacante->proceso->id, $etapa_usuario->usuario_id)->indice_talento;\n\n            if ($indice_talento >= 0) {\n                $this->gestionarContinuidadAplicante($etapa_usuario, MovimientoVacante::PRUEBAS_PSICOMETRICAS_ID, $indice_talento, 'descartar_candidatos_puntuaciones_bajas', 'descartar_candidatos_puntuaciones_medias', true);\n            }\n        }\n    }\n\n    /**\n     * Generar adecuación para videoentrevista.\n     *\n     * @param int $id ID de la etapa del usuario en la vacante.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function generarAdecuacionVideoentrevista(int $id): void {\n        $etapa_usuario = $this->repositorio->getUno($id);\n\n        // Validar que sea la etapa actual del aplicante y no que tenga puntaje\n        if ($etapa_usuario->etapa->nombre === EtapaVacante::VIDEO_ENTREVISTA_NOMBRE && $etapa_usuario->activo && is_null($etapa_usuario->puntaje_ia)) {\n            ProcesarVideoentrevistaIAJob::dispatch($etapa_usuario);\n        }\n    }\n\n    /**\n     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n     * @author Daniel Beltrán\n     */\n    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n        $formato_diligenciado = false;","numLines":80,"startLine":542,"totalLines":1325}},"sourceToolAssistantUUID":"dcc06122-398b-4a90-9cc3-8acd94aa02b7"}
{"parentUuid":"3f91356b-6d93-416b-9efa-d7932bfb5601","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_0165gA2vVSmFnnKbWLM4zLLo","type":"message","role":"assistant","content":[{"type":"text","text":"Todo se ve bien estructuralmente. El error debe estar en otro lugar del archivo. Déjame buscar si hay alguna función sin cerrar correctamente antes de la línea 542:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2215,"cache_read_input_tokens":93280,"cache_creation":{"ephemeral_5m_input_tokens":2215,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWx7Sn59TpZtyq5Z1F1ez","type":"assistant","uuid":"1b287c0e-e1a3-4fcc-bba9-d9ef9a259776","timestamp":"2026-01-09T16:22:31.898Z"}
{"parentUuid":"1b287c0e-e1a3-4fcc-bba9-d9ef9a259776","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_0165gA2vVSmFnnKbWLM4zLLo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016uznnijDWot3pmqYAdN9NP","name":"Bash","input":{"command":"php -l \"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php\"","description":"Check PHP syntax errors"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2215,"cache_read_input_tokens":93280,"cache_creation":{"ephemeral_5m_input_tokens":2215,"ephemeral_1h_input_tokens":0},"output_tokens":157,"service_tier":"standard"}},"requestId":"req_011CWx7Sn59TpZtyq5Z1F1ez","type":"assistant","uuid":"2097e2c8-5fcb-41c1-8071-32b81d4cd881","timestamp":"2026-01-09T16:22:32.808Z"}
{"parentUuid":"2097e2c8-5fcb-41c1-8071-32b81d4cd881","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016uznnijDWot3pmqYAdN9NP","type":"tool_result","content":"No syntax errors detected in c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","is_error":false}]},"uuid":"ac5aff5b-fde9-4b1d-8863-86bff5d17e29","timestamp":"2026-01-09T16:22:43.987Z","toolUseResult":{"stdout":"No syntax errors detected in c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php\r","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"2097e2c8-5fcb-41c1-8071-32b81d4cd881"}
{"parentUuid":"ac5aff5b-fde9-4b1d-8863-86bff5d17e29","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01VBP1w1KSR9x9FSL2YXXqj9","type":"message","role":"assistant","content":[{"type":"text","text":"Excelente. El archivo PHP no tiene errores de sintaxis según el parser de PHP. El error que estás viendo en el IDE (VSCode) es probablemente un falso positivo o un problema de caché del analizador del IDE.\n\nPara solucionarlo, puedes intentar:\n\n1. **Recargar la ventana de VSCode**: Presiona `Ctrl+Shift+P` y escribe \"Reload Window\"\n2. **Guardar el archivo nuevamente**: `Ctrl+S`\n3. **Cerrar y reabrir el archivo**\n\nEl código está sintácticamente correcto según el parser oficial de PHP. El IDE a veces se desincroniza cuando se hacen múltiples ediciones rápidas.\n\n## Resumen de todos los cambios realizados en esta sesión:\n\n### 1. **EtapaVacanteUsuarioService.php**\n- ✅ Agregado parámetro `$forzar_actualizacion` en `guardarPuntajeAdecuacionReclutador()`\n- ✅ Corregida y completada la función `verificarFormatoEntrevista()` para manejar correctamente el caso de videoentrevista\n\n### 2. **aplicacion-revision-hv.js**\n- ✅ Agregada lógica para pre-seleccionar la modalidad de trabajo cuando se carga un perfil laboral existente\n\nTodo está funcionando correctamente desde el punto de vista sintáctico de PHP."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":212,"cache_read_input_tokens":95495,"cache_creation":{"ephemeral_5m_input_tokens":212,"ephemeral_1h_input_tokens":0},"output_tokens":364,"service_tier":"standard"}},"requestId":"req_011CWx7Tz7Dwn7NB1VUJCg9Q","type":"assistant","uuid":"1df8adab-cfe4-4ba1-8627-c7413385dbc8","timestamp":"2026-01-09T16:22:54.175Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-09T16:23:16.812Z","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8"}
{"type":"file-history-snapshot","messageId":"f3c27858-1d73-46ec-acde-c66dcb08cf4a","snapshot":{"messageId":"f3c27858-1d73-46ec-acde-c66dcb08cf4a","trackedFileBackups":{"app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php":{"backupFileName":"5419cff174eb966b@v4","version":4,"backupTime":"2026-01-09T16:22:12.894Z"},"public\\js\\mis-pruebas\\aplicante\\aplicacion-revision-hv.js":{"backupFileName":"0a63c33c166bea46@v2","version":2,"backupTime":"2026-01-09T16:20:36.153Z"}},"timestamp":"2026-01-09T16:23:17.489Z"},"isSnapshotUpdate":false}
{"parentUuid":"1df8adab-cfe4-4ba1-8627-c7413385dbc8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"text","text":"es que el eoro me losalta en la linea 655"}]},"uuid":"f3c27858-1d73-46ec-acde-c66dcb08cf4a","timestamp":"2026-01-09T16:23:17.485Z"}
{"parentUuid":"f3c27858-1d73-46ec-acde-c66dcb08cf4a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01GAPdoqGUky7CA5Xaf5ayFZ","type":"message","role":"assistant","content":[{"type":"text","text":"Déjame revisar específicamente la línea 655 y su contexto:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":3518,"cache_read_input_tokens":95707,"cache_creation":{"ephemeral_5m_input_tokens":3518,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWx7WSrN3M9SJsWjFCzTV","type":"assistant","uuid":"ed4e61f3-7274-4651-9fb8-162e88755825","timestamp":"2026-01-09T16:23:23.609Z"}
{"parentUuid":"ed4e61f3-7274-4651-9fb8-162e88755825","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01GAPdoqGUky7CA5Xaf5ayFZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0176dMp9mDmfwcsUVZYs3iDu","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","offset":645,"limit":15}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":3518,"cache_read_input_tokens":95707,"cache_creation":{"ephemeral_5m_input_tokens":3518,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWx7WSrN3M9SJsWjFCzTV","type":"assistant","uuid":"6119b357-ac57-4f03-9236-d64aa61703eb","timestamp":"2026-01-09T16:23:25.015Z"}
{"parentUuid":"6119b357-ac57-4f03-9236-d64aa61703eb","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0176dMp9mDmfwcsUVZYs3iDu","type":"tool_result","content":"   645→    }\n   646→\n   647→    /**\n   648→     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n   649→     *\n   650→     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n   651→     * @param int $usuario_id ID del usuario (aplicante).\n   652→     * @return void\n   653→     * @author Daniel Beltrán\n   654→     */\n   655→    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n   656→        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n   657→            'etapa_vacante_id' => $etapa_vacante_id,\n   658→            'usuario_id'       => $usuario_id\n   659→        ]));\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7f3b85e7-6bf9-4f56-bc9d-891608fe151f","timestamp":"2026-01-09T16:23:26.396Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","content":"    }\n\n    /**\n     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n     *\n     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n     * @param int $usuario_id ID del usuario (aplicante).\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function recalcularAdecuacionPrefiltro(int $etapa_vacante_id, int $usuario_id): void {\n        $etapa_usuario = $this->repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id' => $etapa_vacante_id,\n            'usuario_id'       => $usuario_id\n        ]));","numLines":15,"startLine":645,"totalLines":1325}},"sourceToolAssistantUUID":"6119b357-ac57-4f03-9236-d64aa61703eb"}
{"parentUuid":"7f3b85e7-6bf9-4f56-bc9d-891608fe151f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01VLSNreVZ6pz2RQHRCrgd73","type":"message","role":"assistant","content":[{"type":"text","text":"El problema es que hay un DocBlock (comentario) después del cierre de la función `verificarFormatoEntrevista()` (línea 645), pero el IDE probablemente está esperando que la función anterior esté correctamente cerrada. Déjame verificar las líneas anteriores para ver si falta algo:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":469,"cache_read_input_tokens":99225,"cache_creation":{"ephemeral_5m_input_tokens":469,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWx7X7Prn7APrBpHBQeEu","type":"assistant","uuid":"724b118a-defc-4a46-b61a-26a7f8f1b7db","timestamp":"2026-01-09T16:23:31.257Z"}
{"parentUuid":"724b118a-defc-4a46-b61a-26a7f8f1b7db","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01VLSNreVZ6pz2RQHRCrgd73","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01946VpcZzi3wvYJyNki4PgJ","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","offset":610,"limit":45}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":469,"cache_read_input_tokens":99225,"cache_creation":{"ephemeral_5m_input_tokens":469,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWx7X7Prn7APrBpHBQeEu","type":"assistant","uuid":"0ac198b1-991d-447a-bf66-1b214a6f298b","timestamp":"2026-01-09T16:23:32.002Z"}
{"parentUuid":"0ac198b1-991d-447a-bf66-1b214a6f298b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01946VpcZzi3wvYJyNki4PgJ","type":"tool_result","content":"   610→\n   611→    /**\n   612→     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n   613→     *\n   614→     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n   615→     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n   616→     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n   617→     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n   618→     * @author Daniel Beltrán\n   619→     */\n   620→    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n   621→        $formato_diligenciado = false;\n   622→        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n   623→            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n   624→            'movimiento_vacante_id'   => $movimiento_vacante_id,\n   625→            'incluir_configuraciones' => true\n   626→        ]));\n   627→\n   628→        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n   629→\n   630→        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n   631→            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n   632→                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n   633→\n   634→                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n   635→                    $formato_diligenciado = true;\n   636→                }\n   637→            } else {\n   638→                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n   639→            }\n   640→        } else {\n   641→            $formato_diligenciado = true;\n   642→        }\n   643→\n   644→        return $formato_diligenciado;\n   645→    }\n   646→\n   647→    /**\n   648→     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n   649→     *\n   650→     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n   651→     * @param int $usuario_id ID del usuario (aplicante).\n   652→     * @return void\n   653→     * @author Daniel Beltrán\n   654→     */\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3c763d7e-029b-41dd-b191-b38abc762b7c","timestamp":"2026-01-09T16:23:33.227Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php","content":"\n    /**\n     * Verificar si la etapa tiene activado el formato de entrevista y si ya está diligenciado por parte del aplicante.\n     *\n     * @param EtapaVacanteUsuario $etapa_usuario Etapa del usuario en la vacante.\n     * @param int $movimiento_vacante_id ID del movimiento de la vacante.\n     * @param string $llave_configuracion Llave de configuración para formato de entrevista.\n     * @return bool Devuelve true cuando no existe la configuración, está deshabilitada o ya haya sido completada por el aplicante, false en caso de estar habilitada pero no completada por el aplicante.\n     * @author Daniel Beltrán\n     */\n    public function verificarFormatoEntrevista(EtapaVacanteUsuario $etapa_usuario, int $movimiento_vacante_id, string $llave_configuracion): bool {\n        $formato_diligenciado = false;\n        $etapa_movimiento     = $this->etapa_movimiento_vacante_repositorio->getUnoAvanzado(new Request([\n            'etapa_vacante_id'        => $etapa_usuario->etapa_vacante_id,\n            'movimiento_vacante_id'   => $movimiento_vacante_id,\n            'incluir_configuraciones' => true\n        ]));\n\n        $configuracion_formato_entrevista = $etapa_movimiento->configuraciones->where('movimientoConfiguracion.llave', $llave_configuracion)->first();\n\n        if (!is_null($configuracion_formato_entrevista) && (bool) $configuracion_formato_entrevista->valor) {\n            if ($movimiento_vacante_id == MovimientoVacante::SOLICITUD_VIDEOENTREVISTA_ID) {\n                $formato_entrevista = $this->formato_entrevista_repositorio->getUnoAvanzado(new Request(['etapa_vacante_usuario_id' => $etapa_usuario->id]));\n\n                if (!is_null($formato_entrevista) && !is_null($formato_entrevista->descripcion_vacante) && !empty($formato_entrevista->descripcion_vacante)) {\n                    $formato_diligenciado = true;\n                }\n            } else {\n                $formato_diligenciado = $this->verificarEtapaCompletada($etapa_usuario->id);\n            }\n        } else {\n            $formato_diligenciado = true;\n        }\n\n        return $formato_diligenciado;\n    }\n\n    /**\n     * Recalcular adecuación para preguntas prefiltro sin utilizar IA.\n     *\n     * @param int $etapa_vacante_id ID de la etapa de la vacante.\n     * @param int $usuario_id ID del usuario (aplicante).\n     * @return void\n     * @author Daniel Beltrán\n     */","numLines":45,"startLine":610,"totalLines":1325}},"sourceToolAssistantUUID":"0ac198b1-991d-447a-bf66-1b214a6f298b"}
{"parentUuid":"3c763d7e-029b-41dd-b191-b38abc762b7c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XZLFCT9k2sir48A4ydP33f","type":"message","role":"assistant","content":[{"type":"text","text":"El código se ve perfectamente bien estructurado. Todas las llaves están correctamente cerradas. El error del IDE es un falso positivo. \n\nVoy a ejecutar un script para contar las llaves y verificar que estén balanceadas:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1163,"cache_read_input_tokens":99694,"cache_creation":{"ephemeral_5m_input_tokens":1163,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWx7XcyLrv7HqY3KVUGp7","type":"assistant","uuid":"ec5b1021-53e3-49f2-a3eb-8013c6c4a0cd","timestamp":"2026-01-09T16:23:39.393Z"}
{"parentUuid":"ec5b1021-53e3-49f2-a3eb-8013c6c4a0cd","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01XZLFCT9k2sir48A4ydP33f","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PRjihiYXt9i6sBWLvdiois","name":"Bash","input":{"command":"php -r \"\n\\$file = file_get_contents('c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php');\n\\$lines = explode('\\n', \\$file);\n\\$balance = 0;\n\\$errors = [];\n\nforeach (\\$lines as \\$num => \\$line) {\n    \\$lineNum = \\$num + 1;\n    \\$open = substr_count(\\$line, '{');\n    \\$close = substr_count(\\$line, '}');\n    \\$balance += \\$open - \\$close;\n    \n    if (\\$lineNum >= 620 && \\$lineNum <= 660) {\n        echo \\\"Line \\$lineNum: Balance = \\$balance (Open: \\$open, Close: \\$close)\\n\\\";\n    }\n    \n    if (\\$balance < 0) {\n        \\$errors[] = \\\"Line \\$lineNum: More closing braces than opening (balance: \\$balance)\\\";\n    }\n}\n\necho \\\"\\nFinal balance: \\$balance (should be 0)\\n\\\";\nif (!empty(\\$errors)) {\n    echo \\\"Errors found:\\n\\\";\n    foreach (\\$errors as \\$error) {\n        echo \\$error . \\\"\\n\\\";\n    }\n}\n\"","description":"Check brace balance in the file"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":1163,"cache_read_input_tokens":99694,"cache_creation":{"ephemeral_5m_input_tokens":1163,"ephemeral_1h_input_tokens":0},"output_tokens":469,"service_tier":"standard"}},"requestId":"req_011CWx7XcyLrv7HqY3KVUGp7","type":"assistant","uuid":"43b4ddb6-297f-42f0-a921-500ca9ae16e6","timestamp":"2026-01-09T16:23:43.813Z"}
{"parentUuid":"43b4ddb6-297f-42f0-a921-500ca9ae16e6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). STOP what you are doing and wait for the user to tell you how to proceed.","is_error":true,"tool_use_id":"toolu_01PRjihiYXt9i6sBWLvdiois"}]},"uuid":"eac89460-5934-4cd5-b394-d7bb1d82087a","timestamp":"2026-01-09T16:23:49.746Z","toolUseResult":"Error: The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). STOP what you are doing and wait for the user to tell you how to proceed.","sourceToolAssistantUUID":"43b4ddb6-297f-42f0-a921-500ca9ae16e6"}
{"parentUuid":"eac89460-5934-4cd5-b394-d7bb1d82087a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"1c251161-433d-44a7-b56a-ed2aaa0e64f8","version":"2.1.1","gitBranch":"PS-1127","slug":"parsed-frolicking-candle","type":"user","message":{"role":"user","content":[{"type":"text","text":"[Request interrupted by user for tool use]"}]},"uuid":"72e3c4c4-c71d-440f-9bf7-83610e22d8d8","timestamp":"2026-01-09T16:23:49.871Z"}
{"type":"summary","summary":"API Error: 500 {\"type\":\"error\",\"error\":{\"type\":\"api_error\",\"message\":\"Internal server error\"},\"request_id\":\"req_011CXmQ9mrRur2ysHkuizGcX\"}","leafUuid":"72e3c4c4-c71d-440f-9bf7-83610e22d8d8"}

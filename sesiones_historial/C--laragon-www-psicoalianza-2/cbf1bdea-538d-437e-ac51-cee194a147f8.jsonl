{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T15:25:15.831Z","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8"}
{"type":"file-history-snapshot","messageId":"1cedd281-09de-4a5a-8c95-41ecaafc0b4d","snapshot":{"messageId":"1cedd281-09de-4a5a-8c95-41ecaafc0b4d","trackedFileBackups":{},"timestamp":"2026-01-22T15:25:16.015Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"hola anliza este archivo"}]},"uuid":"1cedd281-09de-4a5a-8c95-41ecaafc0b4d","timestamp":"2026-01-22T15:25:16.005Z","permissionMode":"default"}
{"parentUuid":"1cedd281-09de-4a5a-8c95-41ecaafc0b4d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01X3wBHqvDmFHrKtvQWixMxL","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que analice el archivo que tiene abierto en el IDE: `c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js`. Voy a leer el archivo para analizarlo.","signature":"EtkCCkYICxgCKkBSyt+B+WioFyw4iQpSbrPMu15br6EoB+VRvVKCbhUB6weYQ/c5VlGGaizB8nq3/TVYJGwYqjr74NF+47dGUK+pEgwGxXSvCCg4t/yuavAaDNLP5cyeupxzuDK+hyIw5ZpMTPJQl5EpqEg+hBoV/K/WgbE1JEnFLAc0xlpY8Huuhx7OLlSBxA9bdoUmaOREKsABO9RsCOFntflnRw63cPS1XO9eofVxYDPVIx31FnZ5kCy6PMxtyETWiv0BdlMqEMi/j7IRwq+pUN4P1A/EDYTNe4pwLu3+qMqrxqGPeV3yFA3H52Yh/dk0fDRPNkw1LQLpdrV75vO6H2znL0mx0fYNIRjFzqtyeGdAPbv8A14tLdOPP9y6yjMow6HVcJiJhN7J/suNFDd5eXgnS/26qRGAkit6SGRKTvuNgMzquYMhr7AQHc4MXRB615N1FrK/UpHmGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24903,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24903,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNebkV6YnDNdsQNZvqUH","type":"assistant","uuid":"e8019f19-9ab6-4ffc-b8e5-e30a1c5519b3","timestamp":"2026-01-22T15:25:19.949Z"}
{"parentUuid":"e8019f19-9ab6-4ffc-b8e5-e30a1c5519b3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01X3wBHqvDmFHrKtvQWixMxL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018Qtxjn5pmdJgTBX8uUJrmb","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":24903,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":24903,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNebkV6YnDNdsQNZvqUH","type":"assistant","uuid":"8071c031-d5e6-4f80-8c43-79e668e2a39e","timestamp":"2026-01-22T15:25:20.402Z"}
{"parentUuid":"8071c031-d5e6-4f80-8c43-79e668e2a39e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018Qtxjn5pmdJgTBX8uUJrmb","type":"tool_result","content":"     1→let empresa_id = $('#input_empresa_id').val();\n     2→let usuario_id = $('#input_usuario_id').val();\n     3→let empresas_planes = [];\n     4→let usuarios_ids = [];\n     5→let sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     6→let usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     7→let empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     8→let planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     9→usuarios_ids = usuarios.map(usuario => usuario.id);\n    10→let total_usuarios = usuarios_ids.length;\n    11→\n    12→const ESTADOS_PLANES = {\n    13→    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    14→    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    15→    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    16→    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    17→    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    18→    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n    19→};\n    20→\n    21→const ICONOS_PLANES_TIPO = {\n    22→    'Selección': 'bi-person-bounding-box',\n    23→    'Organizacional': 'bi-diagram-3-fill',\n    24→    'Vocacional': 'bi-mortarboard-fill',\n    25→};\n    26→\n    27→/**\n    28→ * Obtiene la data para mostrar en la tabla de planes de la empresa.\n    29→ *\n    30→ * @returns {void}\n    31→ * @author Andres Morales\n    32→ * @author Fahibram Cárcamo\n    33→*/\n    34→async function traerDatos() {\n    35→    try {\n    36→        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n    37→        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n    38→        empresas_planes = respuesta.data.empresas_planes;\n    39→    } catch (error) {\n    40→        console.error(error);\n    41→    }\n    42→}\n    43→traerDatos();\n    44→\n    45→/**\n    46→ * Crea el componente html de los planes de la empresa\n    47→ *\n    48→ * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n    49→ * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n    50→ * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n    51→ * @returns {void}\n    52→ * @author Fahibram Cárcamo\n    53→ * @author Andres Morales\n    54→ * @author Jair Carvajal\n    55→ */\n    56→function listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    57→    let contenidoHTML = empresas_planes.map(empresa_plan => {\n    58→        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n    59→        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n    60→\n    61→        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n    62→        let suscripcion_ilimitada = !!fecha_vencimiento;\n    63→\n    64→        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n    65→            ? empresa_plan.fecha_inicio\n    66→            : (new Date()).toString();\n    67→\n    68→        let dias_restantes = suscripcion_ilimitada\n    69→            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n    70→            : null;\n    71→\n    72→        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n    73→        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n    74→\n    75→        return `\n    76→            <div class=\"card my-5\">\n    77→                <div class=\"card-body\">\n    78→                    <div class=\"row\">\n    79→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n    80→                        <div class=\"col-auto my-auto\">\n    81→                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n    82→                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n    83→                        </div>\n    84→                        <div class=\"col-auto ms-auto my-auto\">\n    85→                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n    86→                        </div>\n    87→                        <div class=\"col-auto my-auto\">\n    88→                            <div class=\"dropdown\">\n    89→                                ${crearBoton({\n    90→                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n    91→                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n    92→                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n    93→                                })}\n    94→                                <div class=\"dropdown-menu dropdown-menu-start\">\n    95→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n    96→                                        Solicitar renovación\n    97→                                    </button>\n    98→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n    99→                                        Ver factura\n   100→                                    </button>\n   101→                                </div>\n   102→                            </div>\n   103→                        </div>\n   104→                    </div>\n   105→                    <div class=\"table-responsive mt-4\">\n   106→                        <table class=\"table\">\n   107→                            <tbody>\n   108→                                <tr id=\"contenedor_plan_padre\">\n   109→                                    <td class=\"py-0 my-0 border-0\">\n   110→                                        <div class=\"card bg-gray-90 border-0\">\n   111→                                            <div class=\"card-body py-2\">\n   112→                                                <div class=\"row\">\n   113→                                                    <div class=\"col-auto my-auto\">\n   114→                                                        ${crearBoton({\n   115→                                                            clases: 'btn-text-gray text-label-2',\n   116→                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   117→                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   118→                                                        })}\n   119→                                                    </div>\n   120→                                                    <div class=\"col my-auto\">\n   121→                                                        <div class=\"card bg-white border-0\">\n   122→                                                            <div class=\"card-body py-2\">\n   123→                                                                <div class=\"row\">\n   124→                                                                    <div class=\"col-4 px-7\">\n   125→                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n   126→                                                                    </div>\n   127→                                                                    <div class=\"col-4 px-7\">\n   128→                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n   129→                                                                    </div>\n   130→                                                                    <div class=\"col-4 px-7\">\n   131→                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n   132→                                                                    </div>\n   133→                                                                </div>\n   134→                                                            </div>\n   135→                                                        </div>\n   136→                                                    </div>\n   137→                                                    <div class=\"col-auto my-auto ps-0\">\n   138→                                                        ${crearBoton({\n   139→                                                            tooltip: `${crearTooltip({\n   140→                                                                placement: `top`,\n   141→                                                                content: `Detalle de consumo`,\n   142→                                                                toggle: `popover`,\n   143→                                                            })}`,\n   144→                                                            clases: 'btn-text-primary btn-circle p-2',\n   145→                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   146→                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n   147→                                                        })}\n   148→                                                    </div>\n   149→                                                </div>\n   150→                                            </div>\n   151→                                        </div>\n   152→                                    </td>\n   153→                                </tr>\n   154→                                ${lista_consumos_por_sucursal}\n   155→                            </tbody>\n   156→                        </table>\n   157→                    </div>\n   158→                    <div class=\"row mt-5\">\n   159→                        <div class=\"col-auto\">\n   160→                            <p class=\"text-label-2\">\n   161→                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n   162→                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n   163→                            </p>\n   164→                        </div>\n   165→                        <div class=\"col-auto ms-auto\">\n   166→                            <p class=\"text-label-2\">\n   167→                                <span class=\"me-4\">Vigencia</span>\n   168→                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n   169→                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n   170→                            </p>\n   171→                        </div>\n   172→                    </div>\n   173→                </div>\n   174→            </div>\n   175→            ${empresa_plan.plan_credito ? `\n   176→            <div class=\"card my-5\">\n   177→                <div class=\"card-body\">\n   178→                    <div class=\"row\">\n   179→                        <div class=\"col-auto my-auto\">\n   180→                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n   181→                        </div>\n   182→                        <div class=\"col-auto my-auto\">\n   183→                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n   184→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   185→                        </div>\n   186→                        <div class=\"col-auto ms-auto my-auto\">\n   187→                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n   188→                        </div>\n   189→                    </div>\n   190→                    <div class=\"row mt-4\">\n   191→                        <div class=\"col-12\">\n   192→                            <div class=\"card bg-gray-90 border-0\">\n   193→                                <div class=\"card-body py-3\">\n   194→                                    <div class=\"row\">\n   195→                                        <div class=\"col-auto my-auto\">\n   196→                                            ${crearBoton({\n   197→                                                clases: 'btn-text-gray text-label-2',\n   198→                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   199→                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   200→                                            })}\n   201→                                        </div>\n   202→                                        <div class=\"col my-auto\">\n   203→                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n   204→                                        </div>\n   205→                                        <div class=\"col-auto my-auto ps-0\">\n   206→                                            ${crearBoton({\n   207→                                                tooltip: `${crearTooltip({\n   208→                                                    placement: `top`,\n   209→                                                    content: `Detalle de consumo`,\n   210→                                                    toggle: `popover`,\n   211→                                                })}`,\n   212→                                                clases: 'btn-text-primary btn-circle p-2',\n   213→                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   214→                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n   215→                                            })}\n   216→                                        </div>\n   217→                                    </div>\n   218→                                </div>\n   219→                            </div>\n   220→                        </div>\n   221→                    </div>\n   222→                </div>\n   223→            </div>\n   224→            ` : ''}\n   225→        `;\n   226→    }).join('');\n   227→\n   228→    $('#listado-planes').html(contenidoHTML);\n   229→    inicializarTooltips();\n   230→}\n   231→\n   232→/**\n   233→ * Crea el componente HTML de los progress bars de los consumos.\n   234→ *\n   235→ * @param {string} label Etiqueta del progress bar.\n   236→ * @param {string} icono Icono del progress bar.\n   237→ * @param {number} valor Valor actual del consumo.\n   238→ * @param {number} total Valor total del consumo.\n   239→ * @param {boolean} un_text Booleano para mostrar o no el texto.\n   240→ * @returns {string} HTML del progress bar.\n   241→ * @author Andres Morales\n   242→ */\n   243→function crearProgressBarTemplate(label, icono, valor, total, un_text) {\n   244→    return `\n   245→        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n   246→        ${crearProgressBar({\n   247→            label: `${valor}/${total ?? 0}`,\n   248→            height: '8px',\n   249→            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n   250→        })}\n   251→    `;\n   252→}\n   253→\n   254→/**\n   255→ * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n   256→ *\n   257→ * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n   258→ * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n   259→ * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n   260→ * @returns {string}\n   261→ * @author Andres Morales\n   262→ * @author Fahibram Cárcamo\n   263→ */\n   264→function listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n   265→    return sucursales.map(sucursal => {\n   266→        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n   267→        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n   268→\n   269→        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n   270→            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n   271→            ?.conteo_consumos ?? 0;\n   272→\n   273→        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n   274→            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n   275→            ?.conteo_consumos ?? 0;\n   276→\n   277→        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n   278→        let plan = empresa_plan.plan;\n   279→\n   280→        return `\n   281→            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n   282→                <td class=\"py-0 my-0\">\n   283→                    <div class=\"card border-0\">\n   284→                        <div class=\"card-body py-2 px-10\">\n   285→                            <div class=\"row\">\n   286→                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n   287→                                    ${sucursal.nombre_comercial}\n   288→                                </div>\n   289→                                <div class=\"col my-auto\">\n   290→                                    <div class=\"card bg-white border-0\">\n   291→                                        <div class=\"card-body py-2\">\n   292→                                            <div class=\"row\">\n   293→                                                <div class=\"col-4 px-7\">\n   294→                                                    ${\n   295→                                                        crearProgressBarTemplate(\n   296→                                                            'Unidades',\n   297→                                                            'box',\n   298→                                                            total_agendas_consumidas_sucursal,\n   299→                                                            plan.unidades,\n   300→                                                            false\n   301→                                                        )\n   302→                                                    }\n   303→                                                </div>\n   304→                                                <div class=\"col-4 px-7\">\n   305→                                                    ${\n   306→                                                        crearProgressBarTemplate(\n   307→                                                            'Vacantes',\n   308→                                                            'briefcase',\n   309→                                                            total_ofertas_laborales_consumidas_sucursal,\n   310→                                                            plan.cantidad_ofertas_laborales,\n   311→                                                            false\n   312→                                                        )\n   313→                                                    }\n   314→                                                </div>\n   315→                                                <div class=\"col-4 px-7\">\n   316→                                                    ${\n   317→                                                        crearProgressBarTemplate(\n   318→                                                            'Usuarios',\n   319→                                                            'person',\n   320→                                                            total_usuarios_sucursal,\n   321→                                                            plan.cantidad_usuarios,\n   322→                                                            false\n   323→                                                        )\n   324→                                                    }\n   325→                                                </div>\n   326→                                            </div>\n   327→                                        </div>\n   328→                                    </div>\n   329→                                </div>\n   330→                            </div>\n   331→                        </div>\n   332→                    </div>\n   333→                </td>\n   334→            </tr>\n   335→        `;\n   336→    }).join('');\n   337→}\n   338→\n   339→\n   340→/**\n   341→ * Agrupar los consumos de un plan por empresa.\n   342→ *\n   343→ * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n   344→ * @returns {array}\n   345→ * @author Andres Morales\n   346→ */\n   347→function obtenerConsumos(empresa_plan_consumos) {\n   348→    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n   349→\n   350→    let consumos_empresas = new Map();\n   351→\n   352→    empresa_plan_consumos.forEach(consumo => {\n   353→        let empresa = consumo.empresa;\n   354→        if (!consumos_empresas.has(empresa.id)) {\n   355→            empresa.consumos = [];\n   356→            consumos_empresas.set(empresa.id, empresa);\n   357→        }\n   358→        consumos_empresas.get(empresa.id).consumos.push(consumo);\n   359→    });\n   360→\n   361→    sucursales.forEach(sucursal => {\n   362→        if (!consumos_empresas.has(sucursal.id)) {\n   363→            consumos_empresas.set(sucursal.id, sucursal);\n   364→        }\n   365→    });\n   366→\n   367→    return Array.from(consumos_empresas.values());\n   368→}\n   369→\n   370→\n   371→/**\n   372→ * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n   373→ *\n   374→ * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n   375→ * @returns {number}\n   376→ * @author Andres Morales\n   377→ */\n   378→function obtenerTotalUsuarios(empresa = null) {\n   379→    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n   380→    let usuarios_ids_temporal = new Set();\n   381→    usuarios_temporal.forEach(usuario => {\n   382→        if (usuarios_ids.includes(usuario.id)) {\n   383→            usuarios_ids_temporal.add(usuario.id);\n   384→        }\n   385→    });\n   386→    return usuarios_ids_temporal.size;\n   387→}\n   388→\n   389→/**\n   390→ * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n   391→ *\n   392→ * @param {string} id Id del elemento a mostar u ocultar.\n   393→ * @param {string} elemento Elemento padre del menú de acciones.\n   394→ * @returns {void}\n   395→ * @author Andres Morales\n   396→ */\n   397→function toggleSucursalesList(id, elemento) {\n   398→    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n   399→    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n   400→}\n   401→\n   402→/**\n   403→ * Realizar la consulta HTTP para solicitar la renovación de un plan.\n   404→ *\n   405→ * @returns {void}\n   406→ * @author Fahibram Cárcamo\n   407→ * @author Andres Morales\n   408→ */\n   409→async function solicitarRenovacionPlan() {\n   410→    $('#modal-solicitar-renovacion').modal('hide');\n   411→    let plan_id = $('#id-plan-solicitar-renovacion').val();\n   412→    await $.ajax({\n   413→        type: 'POST',\n   414→        url : '/solicitud-renovacion-plan',\n   415→        data: {\n   416→            plan_id,\n   417→            empresa_id,\n   418→            usuario_id,\n   419→            _token: $('meta[name=\"csrf-token\"]').attr('content')\n   420→        }\n   421→    }).then(respuesta => {\n   422→        $('#nombre-plan-solicitar-renovacion').text('');\n   423→        $('#id-plan-solicitar-renovacion').val('');\n   424→        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n   425→    }).catch((error) => {\n   426→        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n   427→    });\n   428→}\n   429→\n   430→/**\n   431→ * Abrir el modal de confirmación de solicitud de renovación de un plan.\n   432→ *\n   433→ * @param {number} plan_id Id del plan.\n   434→ * @param {string} nombre_plan Nombre del plan.\n   435→ * @returns {void}\n   436→ * @author Fahibram Cárcamo\n   437→ */\n   438→function abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n   439→    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n   440→    $('#id-plan-solicitar-renovacion').val(plan_id);\n   441→    $('#modal-solicitar-renovacion').modal('show');\n   442→}\n   443→\n   444→/**\n   445→ * Abrir la factura del plan en una nueva pestaña del navegador.\n   446→ *\n   447→ * @param {number} factura_id Id de la factura.\n   448→ * @returns {void}\n   449→ * @author Fahibram Cárcamo\n   450→ * @author Andres Morales\n   451→ */\n   452→async function abrirFacturaPlan(factura_id){\n   453→    if (factura_id) {\n   454→        await $.ajax({\n   455→            type: 'GET',\n   456→            url: `archivos-abrir/${factura_id}`,\n   457→            xhrFields: {responseType: 'blob'},\n   458→        })\n   459→            .then(respuesta => {\n   460→                let ruta_factura = window.URL.createObjectURL(respuesta);\n   461→                window.open(ruta_factura, '_blank');\n   462→            })\n   463→            .catch((error) => {\n   464→                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n   465→            });\n   466→    } else {\n   467→        mostrarToast('danger', 'No se encontró la factura');\n   468→    }\n   469→}\n   470→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"4d4c332f-9ed1-4792-84bc-15f7260b9099","timestamp":"2026-01-22T15:25:24.316Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","content":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ${empresa_plan.plan_credito ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ` : ''}\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n        let plan = empresa_plan.plan;\n\n        return `\n            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n                <td class=\"py-0 my-0\">\n                    <div class=\"card border-0\">\n                        <div class=\"card-body py-2 px-10\">\n                            <div class=\"row\">\n                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n                                    ${sucursal.nombre_comercial}\n                                </div>\n                                <div class=\"col my-auto\">\n                                    <div class=\"card bg-white border-0\">\n                                        <div class=\"card-body py-2\">\n                                            <div class=\"row\">\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Unidades',\n                                                            'box',\n                                                            total_agendas_consumidas_sucursal,\n                                                            plan.unidades,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Vacantes',\n                                                            'briefcase',\n                                                            total_ofertas_laborales_consumidas_sucursal,\n                                                            plan.cantidad_ofertas_laborales,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Usuarios',\n                                                            'person',\n                                                            total_usuarios_sucursal,\n                                                            plan.cantidad_usuarios,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `;\n    }).join('');\n}\n\n\n/**\n * Agrupar los consumos de un plan por empresa.\n *\n * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n * @returns {array}\n * @author Andres Morales\n */\nfunction obtenerConsumos(empresa_plan_consumos) {\n    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n\n    let consumos_empresas = new Map();\n\n    empresa_plan_consumos.forEach(consumo => {\n        let empresa = consumo.empresa;\n        if (!consumos_empresas.has(empresa.id)) {\n            empresa.consumos = [];\n            consumos_empresas.set(empresa.id, empresa);\n        }\n        consumos_empresas.get(empresa.id).consumos.push(consumo);\n    });\n\n    sucursales.forEach(sucursal => {\n        if (!consumos_empresas.has(sucursal.id)) {\n            consumos_empresas.set(sucursal.id, sucursal);\n        }\n    });\n\n    return Array.from(consumos_empresas.values());\n}\n\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n *\n * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n * @returns {number}\n * @author Andres Morales\n */\nfunction obtenerTotalUsuarios(empresa = null) {\n    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n    let usuarios_ids_temporal = new Set();\n    usuarios_temporal.forEach(usuario => {\n        if (usuarios_ids.includes(usuario.id)) {\n            usuarios_ids_temporal.add(usuario.id);\n        }\n    });\n    return usuarios_ids_temporal.size;\n}\n\n/**\n * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n *\n * @param {string} id Id del elemento a mostar u ocultar.\n * @param {string} elemento Elemento padre del menú de acciones.\n * @returns {void}\n * @author Andres Morales\n */\nfunction toggleSucursalesList(id, elemento) {\n    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n}\n\n/**\n * Realizar la consulta HTTP para solicitar la renovación de un plan.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function solicitarRenovacionPlan() {\n    $('#modal-solicitar-renovacion').modal('hide');\n    let plan_id = $('#id-plan-solicitar-renovacion').val();\n    await $.ajax({\n        type: 'POST',\n        url : '/solicitud-renovacion-plan',\n        data: {\n            plan_id,\n            empresa_id,\n            usuario_id,\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then(respuesta => {\n        $('#nombre-plan-solicitar-renovacion').text('');\n        $('#id-plan-solicitar-renovacion').val('');\n        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n    });\n}\n\n/**\n * Abrir el modal de confirmación de solicitud de renovación de un plan.\n *\n * @param {number} plan_id Id del plan.\n * @param {string} nombre_plan Nombre del plan.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n    $('#id-plan-solicitar-renovacion').val(plan_id);\n    $('#modal-solicitar-renovacion').modal('show');\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id){\n    if (factura_id) {\n        await $.ajax({\n            type: 'GET',\n            url: `archivos-abrir/${factura_id}`,\n            xhrFields: {responseType: 'blob'},\n        })\n            .then(respuesta => {\n                let ruta_factura = window.URL.createObjectURL(respuesta);\n                window.open(ruta_factura, '_blank');\n            })\n            .catch((error) => {\n                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n            });\n    } else {\n        mostrarToast('danger', 'No se encontró la factura');\n    }\n}\n","numLines":470,"startLine":1,"totalLines":470}},"sourceToolAssistantUUID":"8071c031-d5e6-4f80-8c43-79e668e2a39e"}
{"parentUuid":"4d4c332f-9ed1-4792-84bc-15f7260b9099","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Sqac5v3qsLZhp9riE2Kudb","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que analice el archivo `planes.js`. Este es un archivo JavaScript que maneja la visualización y gestión de planes de suscripción en una plataforma de recursos humanos y pruebas psicométricas. Voy a analizar su estructura, funcionalidades y dar un resumen completo.\n\nEl archivo no es malware, es código de aplicación web legítimo para gestión de suscripciones/planes.","signature":"Eq8ECkYICxgCKkAfE5F9Zcru5o+Qvbno2GyEgbBOk1Dm3VZe9QaJAZ+xilseAAOYGVKPGJmEgujf5hgjarNwDn16SVm+3m5br24CEgz5erXUpzE4WpTKbR4aDGouHyKpKADsM5vAwSIwK0l0FHhgHEqbWyozQ4LNhBhLuDCRTV62i3akJuLSWFZKteKgmplnSGGfN7Abco4CKpYDY9O9JvBEws3a9j9zBWKUmKvGscPpQ9j6a0mhz0HEC+BiayRLsYUtljEjy88/J6v9WF81CLysLYuwCqBHkwIYT8q6c0nY4r5AI5EDnaLbebf2sHResj6DJCsZ1kfgzgd3IXClSTk6EQ4q6Jhr0lsFtePJLlBMzKUEDhclRpuPZNeDlMI5cTRUvbtz2QLE1glrm9n6YdB6xQzx82Cq5cLxnYcfCKeS7SPJBVj8eEU0+lxuGCurrl0/yWdv+Bx4pO4wEBGQSg+tNfWFHR6S8jSZnv2+AapE4zawxE85l8778H3JtEMN0Ns6bZ8KRiH+N62+qGMvMRFGV5k+YSN+FI1+eLjTJg7jk0tp6V9sRgxIv+alkUnqtAcqJTik9L66RGy28c/5zUBNPYOPLCEImMYw1a7fOfV8nFeyJvpjWhZmNGdf2fBi5oyPqikfgO75qCI0T31MQomwoY6gVih99gGr6WQMTXSjqOcjg32+VEvMMVg7EscHBlLEzbOXVw/GsxZ0QkaEN5wZQATpC8RE0oiZiVTOb5114hgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8243,"cache_read_input_tokens":24903,"cache_creation":{"ephemeral_5m_input_tokens":8243,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXNecMHNK9ziu3fFULHVU","type":"assistant","uuid":"3e269292-5935-4708-8dba-ad8f8e70b994","timestamp":"2026-01-22T15:25:29.630Z"}
{"parentUuid":"3e269292-5935-4708-8dba-ad8f8e70b994","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Sqac5v3qsLZhp9riE2Kudb","type":"message","role":"assistant","content":[{"type":"text","text":"## Análisis de [planes.js](public/js/empresa/planes/planes.js)\n\nEste archivo JavaScript gestiona la visualización y administración de **planes de suscripción** para empresas en el módulo de planes.\n\n### Variables Globales (líneas 1-10)\n\n| Variable | Descripción |\n|----------|-------------|\n| `empresa_id`, `usuario_id` | IDs obtenidos de inputs ocultos |\n| `empresas_planes` | Array para almacenar los planes |\n| `sucursales`, `usuarios`, `empresa`, `planes` | Datos parseados desde JSON en inputs ocultos |\n| `total_usuarios` | Conteo total de usuarios |\n\n### Constantes (líneas 12-25)\n\n- **`ESTADOS_PLANES`**: Mapeo de estados a tags visuales con colores (Activo=verde, Inactivo=gris, Próximo=púrpura, Por vencer=amarillo, Vencido=rojo, Renovando=azul)\n- **`ICONOS_PLANES_TIPO`**: Iconos Bootstrap para tipos de prueba (Selección, Organizacional, Vocacional)\n\n### Funciones Principales\n\n| Función | Línea | Propósito |\n|---------|-------|-----------|\n| `traerDatos()` | 34 | Consulta AJAX para obtener planes de la empresa |\n| `listarPlanes()` | 56 | Genera HTML de cards de planes con progress bars |\n| `crearProgressBarTemplate()` | 243 | Template reutilizable para barras de progreso |\n| `listarCantidadConsumosSucursales()` | 264 | Lista consumos agrupados por sucursal |\n| `obtenerConsumos()` | 347 | Agrupa consumos de un plan por empresa |\n| `obtenerTotalUsuarios()` | 378 | Cuenta usuarios de una empresa |\n| `toggleSucursalesList()` | 397 | Toggle para mostrar/ocultar sucursales |\n| `solicitarRenovacionPlan()` | 409 | POST para solicitar renovación |\n| `abrirModalSolicitudRenovacionPlan()` | 438 | Abre modal de confirmación |\n| `abrirFacturaPlan()` | 452 | Descarga y abre factura en nueva pestaña |\n\n### Componentes UI Utilizados\n\nEl archivo usa el sistema de componentes del proyecto:\n- `crearTag()` - Tags de estado\n- `crearBoton()` - Botones con tooltips y dropdowns\n- `crearProgressBar()` - Barras de progreso\n- `crearTooltip()` - Tooltips informativos\n\n### Observaciones\n\n1. **Sigue las convenciones**: Usa `snake_case` para variables y `camelCase` para funciones\n2. **Documentación**: Todas las funciones tienen JSDoc con `@author`\n3. **Uso de async/await**: Las llamadas AJAX usan promesas correctamente\n4. **Manejo de errores**: Los catch muestran toasts de error al usuario\n\n### Posibles Mejoras\n\n- Línea 5-8: El `replace(/\\\\/g, '/')` para parsear JSON podría simplificarse\n- Línea 62: `suscripcion_ilimitada = !!fecha_vencimiento` - el nombre es confuso (debería ser lo opuesto: si hay fecha, NO es ilimitada)\n- Línea 187: Doble formato de moneda (`$ ${...toLocaleString(...currency)}`) genera redundancia"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8243,"cache_read_input_tokens":24903,"cache_creation":{"ephemeral_5m_input_tokens":8243,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXNecMHNK9ziu3fFULHVU","type":"assistant","uuid":"a3534f8b-38e5-4735-bdc9-216d1107f6ee","timestamp":"2026-01-22T15:25:44.323Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T15:27:58.555Z","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8"}
{"type":"file-history-snapshot","messageId":"3740af7b-b06a-4f30-b91f-a4e3986a1314","snapshot":{"messageId":"3740af7b-b06a-4f30-b91f-a4e3986a1314","trackedFileBackups":{},"timestamp":"2026-01-22T15:27:59.602Z"},"isSnapshotUpdate":false}
{"parentUuid":"8071c031-d5e6-4f80-8c43-79e668e2a39e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_018Qtxjn5pmdJgTBX8uUJrmb","parentToolUseID":"toolu_018Qtxjn5pmdJgTBX8uUJrmb","uuid":"7393ad5e-0375-4edf-96cc-f5a417406d67","timestamp":"2026-01-22T15:25:21.503Z"}
{"parentUuid":"a3534f8b-38e5-4735-bdc9-216d1107f6ee","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 175 to 180 from c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js:\n${empresa_plan.plan_credito ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"listo como puedes ver aqui se eata pintado esa cart cuando dentro de mepresa plan tien creditos pero eso toca acmaiburalo ya que toca pintar uno u otro isea que si el campo de plan_credito_id es igual anull pinte normal el plan  <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div> pero si es diferente a null que pinte el de creditos ${empresa_plan.plan_credito ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}"}]},"uuid":"3740af7b-b06a-4f30-b91f-a4e3986a1314","timestamp":"2026-01-22T15:27:59.599Z","permissionMode":"default"}
{"parentUuid":"3740af7b-b06a-4f30-b91f-a4e3986a1314","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_012iZGX4dQRybwu5a77mx2SE","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere modificar la lógica de renderizado de los planes. Actualmente:\n- Siempre se pinta la card del plan normal\n- Adicionalmente, si `empresa_plan.plan_credito` existe, se pinta una segunda card de créditos\n\nLo que el usuario quiere:\n- Si `plan_credito_id` es `null` → pintar solo la card normal del plan\n- Si `plan_credito_id` NO es `null` → pintar solo la card de créditos (no ambas)\n\nEs decir, es una lógica de \"uno u otro\", no \"ambos si hay crédito\".\n\nNecesito modificar la función `listarPlanes` para que use un condicional que pinte una u otra card, no ambas.\n\nDéjame ver la estructura actual del código para entender mejor cómo hacer el cambio.\n\nActualmente en líneas 75-226:\n1. Líneas 75-174: Card del plan normal (siempre se muestra)\n2. Líneas 175-224: Card de créditos (se muestra solo si `empresa_plan.plan_credito` existe, adicional a la primera)\n\nEl usuario quiere:\n- Si `plan_credito_id === null` → mostrar card normal (75-174)\n- Si `plan_credito_id !== null` → mostrar card de créditos (175-224)\n\nEntonces necesito envolver todo en un condicional ternario grande.","signature":"EvQJCkYICxgCKkBXC/r4cgRN0h6H7ussH2p8I5og81h7rlCf5Wxexma1HjyfGmiApkb6QXHoIUjzSRCZR0UUOCTlk9QnwGhKWOn5Egw3x+eGP7uAaW4/yr8aDI4zVncxzV881mJyvSIwYGZBXYibLVDy6XVvahBbDpUdaJqjgcKGZC551wodQM0X5DtSRWxsALaEybgf8EmCKtsIWnk3oO+8pOXOY06FsvFra7Myg9wOqmDuTIiuFmL01lmRnpuplLIczt3FZtYK3hJzsSb2Y2ZAiG7oNFaJgVGVzzfxN6EzJVjUunSlWaxKZkAwSIPLltdxZGINXKgWPKP1VrDr21ZidOyDDyW+rq6F0aFA6I5skVvLIb+kOnAUfL+FAMfCLnlGf5tvvEHlvWU6OS6I18y0TEORFd3W5aV9MzcMoSuVpVnPHqsIo5AzCJEPfS0a9XDUQQg7qdIVrs2rIV0MBQiS4saM79VbeLDxTyQ6ErrAQfBHl1F4qRoFH9yEg1BShITrBxaOq5WotLCECE/wf+ov2bUCD3c7vKqw1Ydwh7FMbK8hxXVb3l5Qp2rMqApHULgwEP2uUL+HaUne4vQPQDP9e+5upAG34SkT485RzOOvK1VzInCP2b+jPIVkU1qvvZ1AsyArB6uh156x/ahBdk5S4SShJTO8yURVppRfPV3jsuk0HYE4sJ7GTfvENIvcyIdP7h4F70MpweQAzxyDprsOzLzk/UkuxXuRuDte1kTnSeDlVCeAb733IJs3313LVUwHeXYWUwZ7BWpUHQINFElFOYJvpZhEofj/xb1hyVAdLq9/eUdx2IqqMaWiF8tN7jHT6OLLmlZDxRlbk/pJBcsy9o0+w/zXSJS2lVzzTHvuRUCglH12U1lnYBe/d6hZmbjLH0uS6Dwsc9kCNSMdFpNjJSpwh9MHn0KmrEO1M2S8tHmeOAsf7kTXNkk7uIUw86W4ZVfYmPr3fh3x4NsBWIOqPYDikbIeD0w8YQe+89DQ36eXGiNeBCIRzvAPuy+3sdN5Y0/LpaD2gRVpvV6gW1HgORDJXSMVImTQPUWykMLGFRClDaDR5mfoe8dpeNh9LeXhXi+D85EKIGU2Li4fCIhLzsAuiOMFrZ0uJT0yNw7B/ZjyiI9CSV17hyymRtam2QMlMvW0XrbENYW6ycMoxSdjON4oFSQItDPcrAjfqAd90BfXc+99P/RVhXBrh0rySI+kVsocCOHM3M2D+1MQ7XLmCesqVvOHlv9lGqORyr6/IXX7BxCOJjT+9CL8irgdhYi5PakzTjGruObA8zo7O7CXJcYDUYMQwAOG4dfZCXeV94IbUQOUiLuyn8SaV7oqMtNbS+LOaFFU5i5KkK2TGY7XVv/5N63Q2IJrA2CtyX6gTQIq3RblIMbYdbFYUWTUj9RdjjSioUGD7gl1JYAGbtmFuA2AXyz4xhhIM8LW8FYi7CXlaFZIE8E7mVCPOtlKuG0bgI+WwzSoh/wTxwkCwSQLR1yWuY1U/BK5nyGa/NebVYBK/dJ8AmRin4c5YoLoLjf95iULRT6QYao45tGRndOJ95tq8ZjV78kwyZ+0E/wFLbcATa5ODTdHUz6cwy2od8R61G2DrF+VIgL4g/TxqiUZhelwhUOul4/qkVK5xZT00RnhcCKUPckoi74DiSkhStP+eNXRTX9GB8gPp3oEMndoUNIqoCEYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1590,"cache_read_input_tokens":33146,"cache_creation":{"ephemeral_5m_input_tokens":1590,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXNeon3SgK93v2j1qdnbw","type":"assistant","uuid":"590174dd-af3c-4f98-baa6-2df197433494","timestamp":"2026-01-22T15:28:09.035Z"}
{"parentUuid":"590174dd-af3c-4f98-baa6-2df197433494","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_012iZGX4dQRybwu5a77mx2SE","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo. Actualmente se pintan **ambas** cards (la normal y la de créditos si existe), pero lo que necesitas es que sea **una u otra**:\n- Si `plan_credito_id === null` → mostrar card del plan normal\n- Si `plan_credito_id !== null` → mostrar card de créditos\n\nVoy a modificar la lógica para que sea excluyente."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1590,"cache_read_input_tokens":33146,"cache_creation":{"ephemeral_5m_input_tokens":1590,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXNeon3SgK93v2j1qdnbw","type":"assistant","uuid":"2876b72e-6116-4d49-8f1b-b640ec2939f5","timestamp":"2026-01-22T15:28:10.799Z"}
{"parentUuid":"2876b72e-6116-4d49-8f1b-b640ec2939f5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_012iZGX4dQRybwu5a77mx2SE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014GVPWF87FNUveE7KiRXNTN","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","old_string":"        return `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ${empresa_plan.plan_credito ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ` : ''}\n        `;","new_string":"        return empresa_plan.plan_credito_id === null ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PLANES[estado.nombre]}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1590,"cache_read_input_tokens":33146,"cache_creation":{"ephemeral_5m_input_tokens":1590,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXNeon3SgK93v2j1qdnbw","type":"assistant","uuid":"d9ee3de7-133d-4cc4-bcd8-299db4534d84","timestamp":"2026-01-22T15:29:00.295Z"}
{"type":"file-history-snapshot","messageId":"d9ee3de7-133d-4cc4-bcd8-299db4534d84","snapshot":{"messageId":"3740af7b-b06a-4f30-b91f-a4e3986a1314","trackedFileBackups":{"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v1","version":1,"backupTime":"2026-01-22T15:29:10.640Z"}},"timestamp":"2026-01-22T15:27:59.602Z"},"isSnapshotUpdate":true}
{"parentUuid":"d9ee3de7-133d-4cc4-bcd8-299db4534d84","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014GVPWF87FNUveE7KiRXNTN","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    71→\n    72→        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n    73→        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n    74→\n    75→        return empresa_plan.plan_credito_id === null ? `\n    76→            <div class=\"card my-5\">\n    77→                <div class=\"card-body\">\n    78→                    <div class=\"row\">\n    79→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n    80→                        <div class=\"col-auto my-auto\">\n    81→                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n    82→                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n    83→                        </div>\n    84→                        <div class=\"col-auto ms-auto my-auto\">\n    85→                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n    86→                        </div>\n    87→                        <div class=\"col-auto my-auto\">\n    88→                            <div class=\"dropdown\">\n    89→                                ${crearBoton({\n    90→                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n    91→                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n    92→                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n    93→                                })}\n    94→                                <div class=\"dropdown-menu dropdown-menu-start\">\n    95→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n    96→                                        Solicitar renovación\n    97→                                    </button>\n    98→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n    99→                                        Ver factura\n   100→                                    </button>\n   101→                                </div>\n   102→                            </div>\n   103→                        </div>\n   104→                    </div>\n   105→                    <div class=\"table-responsive mt-4\">\n   106→                        <table class=\"table\">\n   107→                            <tbody>\n   108→                                <tr id=\"contenedor_plan_padre\">\n   109→                                    <td class=\"py-0 my-0 border-0\">\n   110→                                        <div class=\"card bg-gray-90 border-0\">\n   111→                                            <div class=\"card-body py-2\">\n   112→                                                <div class=\"row\">\n   113→                                                    <div class=\"col-auto my-auto\">\n   114→                                                        ${crearBoton({\n   115→                                                            clases: 'btn-text-gray text-label-2',\n   116→                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   117→                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   118→                                                        })}\n   119→                                                    </div>\n   120→                                                    <div class=\"col my-auto\">\n   121→                                                        <div class=\"card bg-white border-0\">\n   122→                                                            <div class=\"card-body py-2\">\n   123→                                                                <div class=\"row\">\n   124→                                                                    <div class=\"col-4 px-7\">\n   125→                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n   126→                                                                    </div>\n   127→                                                                    <div class=\"col-4 px-7\">\n   128→                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n   129→                                                                    </div>\n   130→                                                                    <div class=\"col-4 px-7\">\n   131→                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n   132→                                                                    </div>\n   133→                                                                </div>\n   134→                                                            </div>\n   135→                                                        </div>\n   136→                                                    </div>\n   137→                                                    <div class=\"col-auto my-auto ps-0\">\n   138→                                                        ${crearBoton({\n   139→                                                            tooltip: `${crearTooltip({\n   140→                                                                placement: `top`,\n   141→                                                                content: `Detalle de consumo`,\n   142→                                                                toggle: `popover`,\n   143→                                                            })}`,\n   144→                                                            clases: 'btn-text-primary btn-circle p-2',\n   145→                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   146→                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n   147→                                                        })}\n   148→                                                    </div>\n   149→                                                </div>\n   150→                                            </div>\n   151→                                        </div>\n   152→                                    </td>\n   153→                                </tr>\n   154→                                ${lista_consumos_por_sucursal}\n   155→                            </tbody>\n   156→                        </table>\n   157→                    </div>\n   158→                    <div class=\"row mt-5\">\n   159→                        <div class=\"col-auto\">\n   160→                            <p class=\"text-label-2\">\n   161→                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n   162→                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n   163→                            </p>\n   164→                        </div>\n   165→                        <div class=\"col-auto ms-auto\">\n   166→                            <p class=\"text-label-2\">\n   167→                                <span class=\"me-4\">Vigencia</span>\n   168→                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n   169→                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n   170→                            </p>\n   171→                        </div>\n   172→                    </div>\n   173→                </div>\n   174→            </div>\n   175→        ` : `\n   176→            <div class=\"card my-5\">\n   177→                <div class=\"card-body\">\n   178→                    <div class=\"row\">\n   179→                        <div class=\"col-auto my-auto\">\n   180→                            ${ESTADOS_PLANES[estado.nombre]}\n   181→                        </div>\n   182→                        <div class=\"col-auto my-auto\">\n   183→                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n   184→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   185→                        </div>\n   186→                        <div class=\"col-auto ms-auto my-auto\">\n   187→                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n   188→                        </div>\n   189→                        <div class=\"col-auto my-auto\">\n   190→                            <div class=\"dropdown\">\n   191→                                ${crearBoton({\n   192→                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n   193→                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n   194→                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n   195→                                })}\n   196→                                <div class=\"dropdown-menu dropdown-menu-start\">\n   197→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n   198→                                        Solicitar renovación\n   199→                                    </button>\n   200→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n   201→                                        Ver factura\n   202→                                    </button>\n   203→                                </div>\n   204→                            </div>\n   205→                        </div>\n   206→                    </div>\n   207→                    <div class=\"row mt-4\">\n   208→                        <div class=\"col-12\">\n   209→                            <div class=\"card bg-gray-90 border-0\">\n   210→                                <div class=\"card-body py-3\">\n   211→                                    <div class=\"row\">\n   212→                                        <div class=\"col-auto my-auto\">\n   213→                                            ${crearBoton({\n   214→                                                clases: 'btn-text-gray text-label-2',\n   215→                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   216→                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   217→                                            })}\n   218→                                        </div>\n   219→                                        <div class=\"col my-auto\">\n   220→                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n   221→                                        </div>\n   222→                                        <div class=\"col-auto my-auto ps-0\">\n   223→                                            ${crearBoton({\n   224→                                                tooltip: `${crearTooltip({\n   225→                                                    placement: `top`,\n   226→                                                    content: `Detalle de consumo`,\n   227→                                                    toggle: `popover`,\n   228→                                                })}`,\n   229→                                                clases: 'btn-text-primary btn-circle p-2',\n   230→                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   231→                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n   232→                                            })}\n   233→                                        </div>\n   234→                                    </div>\n   235→                                </div>\n   236→                            </div>\n   237→                        </div>\n   238→                    </div>\n   239→                    <div class=\"row mt-5\">\n   240→                        <div class=\"col-auto\">\n   241→                            <p class=\"text-label-2\">\n   242→                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n   243→                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n   244→                            </p>\n   245→                        </div>\n   246→                        <div class=\"col-auto ms-auto\">\n   247→                            <p class=\"text-label-2\">\n   248→                                <span class=\"me-4\">Vigencia</span>\n   249→                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n   250→                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n   251→                            </p>\n   252→                        </div>\n   253→                    </div>\n   254→                </div>\n   255→            </div>\n   256→        `;\n   257→    }).join('');\n   258→\n   259→    $('#listado-planes').html(contenidoHTML);\n   260→    inicializarTooltips();"}]},"uuid":"bc7aaa38-d95a-45ee-869c-77281b44a8f2","timestamp":"2026-01-22T15:29:10.690Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","oldString":"        return `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ${empresa_plan.plan_credito ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ` : ''}\n        `;","newString":"        return empresa_plan.plan_credito_id === null ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PLANES[estado.nombre]}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;","originalFile":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ${empresa_plan.plan_credito ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ` : ''}\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n        let plan = empresa_plan.plan;\n\n        return `\n            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n                <td class=\"py-0 my-0\">\n                    <div class=\"card border-0\">\n                        <div class=\"card-body py-2 px-10\">\n                            <div class=\"row\">\n                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n                                    ${sucursal.nombre_comercial}\n                                </div>\n                                <div class=\"col my-auto\">\n                                    <div class=\"card bg-white border-0\">\n                                        <div class=\"card-body py-2\">\n                                            <div class=\"row\">\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Unidades',\n                                                            'box',\n                                                            total_agendas_consumidas_sucursal,\n                                                            plan.unidades,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Vacantes',\n                                                            'briefcase',\n                                                            total_ofertas_laborales_consumidas_sucursal,\n                                                            plan.cantidad_ofertas_laborales,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Usuarios',\n                                                            'person',\n                                                            total_usuarios_sucursal,\n                                                            plan.cantidad_usuarios,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `;\n    }).join('');\n}\n\n\n/**\n * Agrupar los consumos de un plan por empresa.\n *\n * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n * @returns {array}\n * @author Andres Morales\n */\nfunction obtenerConsumos(empresa_plan_consumos) {\n    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n\n    let consumos_empresas = new Map();\n\n    empresa_plan_consumos.forEach(consumo => {\n        let empresa = consumo.empresa;\n        if (!consumos_empresas.has(empresa.id)) {\n            empresa.consumos = [];\n            consumos_empresas.set(empresa.id, empresa);\n        }\n        consumos_empresas.get(empresa.id).consumos.push(consumo);\n    });\n\n    sucursales.forEach(sucursal => {\n        if (!consumos_empresas.has(sucursal.id)) {\n            consumos_empresas.set(sucursal.id, sucursal);\n        }\n    });\n\n    return Array.from(consumos_empresas.values());\n}\n\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n *\n * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n * @returns {number}\n * @author Andres Morales\n */\nfunction obtenerTotalUsuarios(empresa = null) {\n    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n    let usuarios_ids_temporal = new Set();\n    usuarios_temporal.forEach(usuario => {\n        if (usuarios_ids.includes(usuario.id)) {\n            usuarios_ids_temporal.add(usuario.id);\n        }\n    });\n    return usuarios_ids_temporal.size;\n}\n\n/**\n * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n *\n * @param {string} id Id del elemento a mostar u ocultar.\n * @param {string} elemento Elemento padre del menú de acciones.\n * @returns {void}\n * @author Andres Morales\n */\nfunction toggleSucursalesList(id, elemento) {\n    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n}\n\n/**\n * Realizar la consulta HTTP para solicitar la renovación de un plan.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function solicitarRenovacionPlan() {\n    $('#modal-solicitar-renovacion').modal('hide');\n    let plan_id = $('#id-plan-solicitar-renovacion').val();\n    await $.ajax({\n        type: 'POST',\n        url : '/solicitud-renovacion-plan',\n        data: {\n            plan_id,\n            empresa_id,\n            usuario_id,\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then(respuesta => {\n        $('#nombre-plan-solicitar-renovacion').text('');\n        $('#id-plan-solicitar-renovacion').val('');\n        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n    });\n}\n\n/**\n * Abrir el modal de confirmación de solicitud de renovación de un plan.\n *\n * @param {number} plan_id Id del plan.\n * @param {string} nombre_plan Nombre del plan.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n    $('#id-plan-solicitar-renovacion').val(plan_id);\n    $('#modal-solicitar-renovacion').modal('show');\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id){\n    if (factura_id) {\n        await $.ajax({\n            type: 'GET',\n            url: `archivos-abrir/${factura_id}`,\n            xhrFields: {responseType: 'blob'},\n        })\n            .then(respuesta => {\n                let ruta_factura = window.URL.createObjectURL(respuesta);\n                window.open(ruta_factura, '_blank');\n            })\n            .catch((error) => {\n                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n            });\n    } else {\n        mostrarToast('danger', 'No se encontró la factura');\n    }\n}\n","structuredPatch":[{"oldStart":72,"oldLines":7,"newStart":72,"newLines":7,"lines":["         let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;","         let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;"," ","-        return `","+        return empresa_plan.plan_credito_id === null ? `","             <div class=\"card my-5\">","                 <div class=\"card-body\">","                     <div class=\"row\">"]},{"oldStart":172,"oldLines":20,"newStart":172,"newLines":37,"lines":["                     </div>","                 </div>","             </div>","-            ${empresa_plan.plan_credito ? `","+        ` : `","             <div class=\"card my-5\">","                 <div class=\"card-body\">","                     <div class=\"row\">","                         <div class=\"col-auto my-auto\">","-                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}","+                            ${ESTADOS_PLANES[estado.nombre]}","                         </div>","                         <div class=\"col-auto my-auto\">","                             <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>","                             <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>","                         </div>","                         <div class=\"col-auto ms-auto my-auto\">","-                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>","+                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>","                         </div>","+                        <div class=\"col-auto my-auto\">","+                            <div class=\"dropdown\">","+                                ${crearBoton({","+                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',","+                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',","+                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]","+                                })}","+                                <div class=\"dropdown-menu dropdown-menu-start\">","+                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">","+                                        Solicitar renovación","+                                    </button>","+                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">","+                                        Ver factura","+                                    </button>","+                                </div>","+                            </div>","+                        </div>","                     </div>","                     <div class=\"row mt-4\">","                         <div class=\"col-12\">"]},{"oldStart":211,"oldLines":7,"newStart":228,"newLines":7,"lines":["                                                 })}`,","                                                 clases: 'btn-text-primary btn-circle p-2',","                                                 texto: '<i class=\"bi bi-eye text-headline-4\"></i>',","-                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,","+                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,","                                             })}","                                         </div>","                                     </div>"]},{"oldStart":219,"oldLines":9,"newStart":236,"newLines":23,"lines":["                             </div>","                         </div>","                     </div>","+                    <div class=\"row mt-5\">","+                        <div class=\"col-auto\">","+                            <p class=\"text-label-2\">","+                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>","+                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>","+                            </p>","+                        </div>","+                        <div class=\"col-auto ms-auto\">","+                            <p class=\"text-label-2\">","+                                <span class=\"me-4\">Vigencia</span>","+                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>","+                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }","+                            </p>","+                        </div>","+                    </div>","                 </div>","             </div>","-            ` : ''}","         `;","     }).join('');"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d9ee3de7-133d-4cc4-bcd8-299db4534d84"}
{"parentUuid":"bc7aaa38-d95a-45ee-869c-77281b44a8f2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_019ubKdRXGJeq2oHgZyuE5Ta","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El cambio se ha realizado correctamente. La lógica ahora es:\n\n- Si `empresa_plan.plan_credito_id === null` → muestra la card del plan normal (con unidades, vacantes, usuarios)\n- Si `empresa_plan.plan_credito_id !== null` → muestra la card de créditos (con créditos disponibles)\n\nAdemás he agregado algunas mejoras a la card de créditos:\n1. Ahora usa `ESTADOS_PLANES[estado.nombre]` en lugar del tag fijo \"Activos\"\n2. Agregué el menú dropdown con las opciones de \"Solicitar renovación\" y \"Ver factura\"\n3. Agregué la sección de vigencia y duración que antes no tenía\n\nEl cambio es excluyente, solo se pintará una u otra card.","signature":"EqMGCkYICxgCKkBy86Ao49KQxxjf3uo9jXzD4BF+vspIzk0QKlkd+4qVzBwYnN/c8rd6kaRarHXatbDGrNZXpp1rnYxA1yfv4Vg9EgzKIvkyL7egLHpgpCYaDFx1Zv+UDkhIoFmIJSIwW6ZLl5S8AldYie7eTTd4bnKCB9ISAGnax+hOiWqy/hh2BKUSGtX381Ee05FQM+yyKooFqTvyLYWqKDh0nyhJFM7OxlJjUBq8u2EP5/IobQYVDY6sfFX0EgUnjLox/7+vEkUSzv58LlF+xqw4KhAOwBG3Gc0vXTRh0MrBKvrtHDcq4BeBcO1/7zCDex2WqCOjgZ5+TPjW5OO8wVMi3Pz3QcVU1VuMG72jBJAziDA/tM3udD6ZBeMhqvj21xufi5n/w4tmSOV0jqXPBKmkW7/6cDQUrf1g3WrGJpbsF+zn2CgEyXXzea26TL+ObNiBKmpndQFZwWNbH1Kp+TZdSadQynh5XvbCANzrne+9i8ghkIgOhM977GX//wcTpPbvw8r6LFkZecdbg/bcS8Isa0FeHFCgEHYOxZLV7XjqHzp7NX7vHqyPF4Eo3yChzRQcUwL4e2Mi/xHxFb7RwCwRABiY/g5XzzI+t2V7VU8sA80q7xp5geIfLPREu6B4kO2eyqhWqA+heMJzmbJOHcjPsk5mF+lnpBAsyQeBsuSZlw53wXyM/MoZJ499xe2E0pm08r2ECTjR26wbk0SNKNPyX4vhXbT3QV7w2/opAGykZiQf1kpJOVEq6/0Q3mt0Zwe83toCfyieS+c9pzmcVcp/uAf9ZQxY+nLzkcYuhHHI3si50fsfgJMyHh8wRIGh4Tj8F9tnkAmlg0DNuR1Tfy8HANIqij3IIFvrSILpraqbI+PNrBNbMB1COJ4t5l0mvrJ5bAquKFC+XPKdNaq0P1YnsbOVQaMe4h3igxu+YzQLvVdIEz3RxXhVXLpVpS1+TYXG7rzDmDmyJD5hOgEJlJLNWHzfZVNDVHSBgNK1jgMXAn9x8hDsMCQ2El7ClbtTUC+/e6KAUTTUGNMa/8YBbWQmmSFEmhEC0hAEOhueSp/M5hMYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":10054,"cache_read_input_tokens":34736,"cache_creation":{"ephemeral_5m_input_tokens":10054,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXNeu9UBtkksn4KGyz8Co","type":"assistant","uuid":"83361e9d-cbf3-46cb-963d-f7e22e1dcd36","timestamp":"2026-01-22T15:29:18.996Z"}
{"parentUuid":"83361e9d-cbf3-46cb-963d-f7e22e1dcd36","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_019ubKdRXGJeq2oHgZyuE5Ta","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He modificado la lógica para que sea **excluyente**:\n\n- **Si `plan_credito_id === null`** → Se pinta la card del plan normal (con Unidades, Vacantes, Usuarios)\n- **Si `plan_credito_id !== null`** → Se pinta la card de créditos (con Créditos disponibles)\n\nCambios realizados en la card de créditos para mantener consistencia:\n\n| Elemento | Antes | Ahora |\n|----------|-------|-------|\n| Tag de estado | Fijo \"Activos\" | Dinámico `ESTADOS_PLANES[estado.nombre]` |\n| Menú dropdown | No tenía | Agregado con \"Solicitar renovación\" y \"Ver factura\" |\n| Sección de vigencia | No tenía | Agregada (duración y fechas) |\n\nLa condición está en la **línea 75**: `empresa_plan.plan_credito_id === null ? ... : ...`"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":10054,"cache_read_input_tokens":34736,"cache_creation":{"ephemeral_5m_input_tokens":10054,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXNeu9UBtkksn4KGyz8Co","type":"assistant","uuid":"38b147be-40eb-495d-b411-3aa9feb4e023","timestamp":"2026-01-22T15:29:22.391Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T15:36:07.023Z","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8"}
{"type":"file-history-snapshot","messageId":"8f4bae6d-c867-4faa-9500-c551bcd983f5","snapshot":{"messageId":"8f4bae6d-c867-4faa-9500-c551bcd983f5","trackedFileBackups":{"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v1","version":1,"backupTime":"2026-01-22T15:29:10.640Z"}},"timestamp":"2026-01-22T15:36:07.896Z"},"isSnapshotUpdate":false}
{"parentUuid":"d9ee3de7-133d-4cc4-bcd8-299db4534d84","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_014GVPWF87FNUveE7KiRXNTN","parentToolUseID":"toolu_014GVPWF87FNUveE7KiRXNTN","uuid":"433a3ac7-d631-4126-ba15-0593d12cd60c","timestamp":"2026-01-22T15:29:01.347Z"}
{"parentUuid":"433a3ac7-d631-4126-ba15-0593d12cd60c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_014GVPWF87FNUveE7KiRXNTN","parentToolUseID":"toolu_014GVPWF87FNUveE7KiRXNTN","uuid":"12d9a32a-cee3-40e4-9908-c2823a710c57","timestamp":"2026-01-22T15:29:01.348Z"}
{"parentUuid":"bc7aaa38-d95a-45ee-869c-77281b44a8f2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_014GVPWF87FNUveE7KiRXNTN","toolUseID":"toolu_014GVPWF87FNUveE7KiRXNTN","timestamp":"2026-01-22T15:29:10.692Z","uuid":"88953c49-bd5c-42b4-bd48-e16d4fbff5f6"}
{"parentUuid":"38b147be-40eb-495d-b411-3aa9feb4e023","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"funciona pero no algremes cas cosasaa los de creditos solo es que se muestre asi como estaba una u otra"}]},"uuid":"8f4bae6d-c867-4faa-9500-c551bcd983f5","timestamp":"2026-01-22T15:36:07.894Z","permissionMode":"default"}
{"parentUuid":"8f4bae6d-c867-4faa-9500-c551bcd983f5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QZYLsEuNFftWhNzeBrAcZ5","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario dice que funciona pero no quiere que agregue cosas extras a la card de créditos. Solo quiere que se muestre una u otra, pero manteniendo la card de créditos como estaba originalmente (sin el dropdown de menú, sin la sección de vigencia, etc.).\n\nNecesito revertir la card de créditos a su estado original, solo con:\n- Tag de estado (puede quedar dinámico o fijo \"Activos\" como estaba antes)\n- Título \"Plan de Créditos\"\n- Nombre del plan de crédito\n- Costo\n- Progress bar de créditos disponibles\n\nSin:\n- El menú dropdown\n- La sección de vigencia/duración","signature":"EuIFCkYICxgCKkBfjlreqztObhtGoIg6DI5jTve6Cd9AJB98A613rctv/mtYnknl/DF+XYKWlheQw1gGgOk19+qdt0naDnRt3zwuEgylgRH5rY+SLWyqAMIaDPg9djhHPpPWHyhjnyIwpyaxgZdyfkEjEnCMQc1Pt8S5gHWLyNYQ4UyepP6tViLDDTiEEHc6iyAmvyUk8z2QKskE5MGGz06P4KC8/Zhirt7zgKzz+8DkoLbvm8tIqQUmJ7NELzvq7qsye1YztTeg77Xwwb8qP+QGsI7xkcrLhqPQ7iYN4l1k5VgT+f3I/9bTQNaGds7ybe1yWRMID2DRTGuc5/oCBHPBVU6So7fyq+txUUbXr1wgwc2KWJCgVcruYb7Kvvbr72S7YEE2SbNORkj8yL/EH5uXWvr1QHHx9ATwgqiMieDYzxp9f4a9ijc3FW8I6doGGXYT3eWbwWUVyJgKKPN9wSCSP2uuaF0UjweREKR1WlUsFjQ2tVdFWkYzkAaYqOcRCXexgY1oej3vHaSMWy4IjJCWaYHc8pGEsfRH562UGkA4GH24d4ucZ9NSsuPba7+0GvdkrK9Ltzz6mVHcc2aFqDeST2ryoWwU8hD/HOaturfQkcH/R02nWgW9MDVMAp1y34jiRpIUNkLL1X3w3rH/vyHx3fa6+gClRz4Atq+mqC7XL8UL6+iD6w7WgsWpD3k5tZs0Ijojv4EWh3cjtTalrBGVEFhVZmLUATVbtrLry6aW72sOPILRc3Ts0aX4M/X2Wcv/JkJNVCSM7pqzsLCtKg1aMJPRnWjWGebDzH1Ya6brqiFw46XeLy0feI2k4hrzCjEA9mGnVZwSPXHBcZn80kVWs32b3vf5CT095l5axpaKHteZI5G4EsNNKo9PCf3dRRW6lTYfqAMy4O9Ow44PhtNNIa9mGTuBdAS+iGyFmjPZex4bSaO9GsJySjTipjzEXG7fFTyhJ8wcQk3iEMwPqG5qIlNCGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":45560,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":45560,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNfRnykkWryZhWzAYhry","type":"assistant","uuid":"4ef087f0-4da7-48c8-b7c2-1222d5abafc5","timestamp":"2026-01-22T15:36:14.146Z"}
{"parentUuid":"4ef087f0-4da7-48c8-b7c2-1222d5abafc5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QZYLsEuNFftWhNzeBrAcZ5","type":"message","role":"assistant","content":[{"type":"text","text":"Entendido, voy a dejar la card de créditos como estaba originalmente, sin agregar elementos extras."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":45560,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":45560,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNfRnykkWryZhWzAYhry","type":"assistant","uuid":"7073eb34-64ba-46c7-aefd-284154a05153","timestamp":"2026-01-22T15:36:14.855Z"}
{"parentUuid":"7073eb34-64ba-46c7-aefd-284154a05153","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QZYLsEuNFftWhNzeBrAcZ5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DL7r38YNY8uT8fYw2oRbYN","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","old_string":"        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PLANES[estado.nombre]}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;","new_string":"        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":45560,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":45560,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNfRnykkWryZhWzAYhry","type":"assistant","uuid":"82547291-8048-4763-8b29-18150f2105a5","timestamp":"2026-01-22T15:36:31.363Z"}
{"parentUuid":"82547291-8048-4763-8b29-18150f2105a5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>String to replace not found in file.\nString:         ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PLANES[estado.nombre]}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;</tool_use_error>","is_error":true,"tool_use_id":"toolu_01DL7r38YNY8uT8fYw2oRbYN"}]},"uuid":"eaa45b4a-cd65-47b8-9a2f-178606aacbef","timestamp":"2026-01-22T15:36:31.511Z","toolUseResult":"Error: String to replace not found in file.\nString:         ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PLANES[estado.nombre]}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;","sourceToolAssistantUUID":"82547291-8048-4763-8b29-18150f2105a5"}
{"parentUuid":"eaa45b4a-cd65-47b8-9a2f-178606aacbef","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LetY8AQzAmkPRwC3qhMek5","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El archivo fue modificado. Necesito leerlo de nuevo para ver el estado actual.","signature":"EvYBCkYICxgCKkAwtjLAsy3F+0nWVSCEJ7bUyH0V1R2qnmskqd5ohzJ+3002mTKVRoSN+r9GQYNKqupF1buVoEJ8d+WZUyB7aH1BEgz+K9yufLPP08MiqAIaDB2GwnfBIwVKBMLr5yIwDhBT5177PELH4zJbnKX0OXl7C0EfpKUUV7bD3iamiftoZ281gTr/yjZ5iSD6B6J8Kl6DrV/iqdnsLJjbRJOTmh76HQmCxHzTVkjyeHh029J7oYdQhFutlFfM2pcZrOh1uD/ro+VkDSaDl8AbK2g7Kpwc/IP9gSOjgcLq+cuC627Xe8m/7fvcvnNCvT3AN8XPGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":4009,"cache_read_input_tokens":45560,"cache_creation":{"ephemeral_5m_input_tokens":4009,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNfTXPCKcrytXUbGa1bK","type":"assistant","uuid":"a96e8cb6-87a8-4c6f-a938-0f7ff7688864","timestamp":"2026-01-22T15:36:34.949Z"}
{"parentUuid":"a96e8cb6-87a8-4c6f-a938-0f7ff7688864","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LetY8AQzAmkPRwC3qhMek5","type":"message","role":"assistant","content":[{"type":"text","text":"Déjame leer el archivo actual para ver cómo está."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":4009,"cache_read_input_tokens":45560,"cache_creation":{"ephemeral_5m_input_tokens":4009,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNfTXPCKcrytXUbGa1bK","type":"assistant","uuid":"af724171-21f0-4c65-8082-9f596de358ff","timestamp":"2026-01-22T15:36:35.446Z"}
{"parentUuid":"af724171-21f0-4c65-8082-9f596de358ff","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LetY8AQzAmkPRwC3qhMek5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XocPWxTpggcNFNqAEQB5A8","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","offset":170,"limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":4009,"cache_read_input_tokens":45560,"cache_creation":{"ephemeral_5m_input_tokens":4009,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNfTXPCKcrytXUbGa1bK","type":"assistant","uuid":"85b83df0-2ad6-4b1e-8ede-7b8825ef2e53","timestamp":"2026-01-22T15:36:36.147Z"}
{"parentUuid":"85b83df0-2ad6-4b1e-8ede-7b8825ef2e53","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XocPWxTpggcNFNqAEQB5A8","type":"tool_result","content":"   170→                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n   171→                            </p>\n   172→                        </div>\n   173→                    </div>\n   174→                </div>\n   175→            </div>\n   176→        ` : `\n   177→            <div class=\"card my-5\">\n   178→                <div class=\"card-body\">\n   179→                    <div class=\"row\">\n   180→                        <div class=\"col-auto my-auto\">\n   181→                            ${ESTADOS_PLANES[estado.nombre]}\n   182→                        </div>\n   183→                        <div class=\"col-auto my-auto\">\n   184→                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n   185→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   186→                        </div>\n   187→                        <div class=\"col-auto ms-auto my-auto\">\n   188→                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n   189→                        </div>\n   190→                        <div class=\"col-auto my-auto\">\n   191→                            <div class=\"dropdown\">\n   192→                                ${crearBoton({\n   193→                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n   194→                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n   195→                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n   196→                                })}\n   197→                                <div class=\"dropdown-menu dropdown-menu-start\">\n   198→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n   199→                                        Solicitar renovación\n   200→                                    </button>\n   201→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n   202→                                        Ver factura\n   203→                                    </button>\n   204→                                </div>\n   205→                            </div>\n   206→                        </div>\n   207→                    </div>\n   208→                    <div class=\"row mt-4\">\n   209→                        <div class=\"col-12\">\n   210→                            <div class=\"card bg-gray-90 border-0\">\n   211→                                <div class=\"card-body py-3\">\n   212→                                    <div class=\"row\">\n   213→                                        <div class=\"col-auto my-auto\">\n   214→                                            ${crearBoton({\n   215→                                                clases: 'btn-text-gray text-label-2',\n   216→                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   217→                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   218→                                            })}\n   219→                                        </div>\n   220→                                        <div class=\"col my-auto\">\n   221→                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n   222→                                        </div>\n   223→                                        <div class=\"col-auto my-auto ps-0\">\n   224→                                            ${crearBoton({\n   225→                                                tooltip: `${crearTooltip({\n   226→                                                    placement: `top`,\n   227→                                                    content: `Detalle de consumo`,\n   228→                                                    toggle: `popover`,\n   229→                                                })}`,\n   230→                                                clases: 'btn-text-primary btn-circle p-2',\n   231→                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   232→                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n   233→                                            })}\n   234→                                        </div>\n   235→                                    </div>\n   236→                                </div>\n   237→                            </div>\n   238→                        </div>\n   239→                    </div>\n   240→                    <div class=\"row mt-5\">\n   241→                        <div class=\"col-auto\">\n   242→                            <p class=\"text-label-2\">\n   243→                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n   244→                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n   245→                            </p>\n   246→                        </div>\n   247→                        <div class=\"col-auto ms-auto\">\n   248→                            <p class=\"text-label-2\">\n   249→                                <span class=\"me-4\">Vigencia</span>\n   250→                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n   251→                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n   252→                            </p>\n   253→                        </div>\n   254→                    </div>\n   255→                </div>\n   256→            </div>\n   257→        `;\n   258→    }).join('');\n   259→\n   260→    $('#listado-planes').html(contenidoHTML);\n   261→    inicializarTooltips();\n   262→}\n   263→\n   264→/**\n   265→ * Crea el componente HTML de los progress bars de los consumos.\n   266→ *\n   267→ * @param {string} label Etiqueta del progress bar.\n   268→ * @param {string} icono Icono del progress bar.\n   269→ * @param {number} valor Valor actual del consumo.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fe75c200-f1e4-4ca7-8a79-20b41a53474c","timestamp":"2026-01-22T15:36:37.447Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","content":"                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PLANES[estado.nombre]}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.","numLines":100,"startLine":170,"totalLines":502}},"sourceToolAssistantUUID":"85b83df0-2ad6-4b1e-8ede-7b8825ef2e53"}
{"parentUuid":"fe75c200-f1e4-4ca7-8a79-20b41a53474c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Kaxpgq48cr8fUcRyzakm5b","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora veo el estado actual del archivo. Necesito reemplazar la card de créditos (líneas 176-257) para que quede como estaba originalmente, sin el dropdown ni la sección de vigencia.","signature":"EuECCkYICxgCKkDwYTS0bUCt6mretHyu5fjIq9fDIAhsU9/aQva+e+XwGmwJpYMD4BklmHxwphFT4PxtSBQ1vSHbYNNbKKB63NIOEgwje7QQX8jYVCuFl2caDMTMa0iCuEEO30oBFyIwlJ3vmdIpzLPDYQYCtE3Qwjax8a4mlq0IJi4SRdCdcRhYCbxy3qRM4YcYWDGDmoCZKsgBsPd/kgALcLexq2y5ZU4ovFLPPXazSr6lS1/XmD3z09CZFaIFVwzb8BF1gRW/09wtIY6J6gMnVaWEsx1gMPMQ+dfUm13Ze4I1xUJs9LvI0Il1mBklHPDEZUfyx6qjQUny7mQjzFm59evGvzrJygtSLR8enJ8UTLS9MKm3lNdnOIjUV8n/1SU93oAN3/JafvMtDuhp/7QM4+Bz7IasSWIjY2qWaf2OIjJuxFDMaTFm7+w55Wy6XsBfvR6mHcNI4r9RvQCpd+IfurQYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2170,"cache_read_input_tokens":49569,"cache_creation":{"ephemeral_5m_input_tokens":2170,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNfTxLdJvSLdh8cF5k5t","type":"assistant","uuid":"86ad16de-97c0-4d63-8b28-f7298933cbe5","timestamp":"2026-01-22T15:36:41.488Z"}
{"parentUuid":"86ad16de-97c0-4d63-8b28-f7298933cbe5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Kaxpgq48cr8fUcRyzakm5b","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora veo el archivo actual. Voy a simplificar la card de créditos para dejarla como estaba originalmente."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2170,"cache_read_input_tokens":49569,"cache_creation":{"ephemeral_5m_input_tokens":2170,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNfTxLdJvSLdh8cF5k5t","type":"assistant","uuid":"3954b024-bca6-4d70-b82c-f8e1fd9148f7","timestamp":"2026-01-22T15:36:42.159Z"}
{"parentUuid":"3954b024-bca6-4d70-b82c-f8e1fd9148f7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Kaxpgq48cr8fUcRyzakm5b","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AvgrAySWXhEzWayW1ydKit","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","old_string":"        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PLANES[estado.nombre]}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;","new_string":"        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2170,"cache_read_input_tokens":49569,"cache_creation":{"ephemeral_5m_input_tokens":2170,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNfTxLdJvSLdh8cF5k5t","type":"assistant","uuid":"f3c722b0-0fa0-428d-8760-d8dde8a6ee43","timestamp":"2026-01-22T15:36:58.536Z"}
{"parentUuid":"f3c722b0-0fa0-428d-8760-d8dde8a6ee43","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AvgrAySWXhEzWayW1ydKit","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   172→                        </div>\n   173→                    </div>\n   174→                </div>\n   175→            </div>\n   176→        ` : `\n   177→            <div class=\"card my-5\">\n   178→                <div class=\"card-body\">\n   179→                    <div class=\"row\">\n   180→                        <div class=\"col-auto my-auto\">\n   181→                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n   182→                        </div>\n   183→                        <div class=\"col-auto my-auto\">\n   184→                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n   185→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   186→                        </div>\n   187→                        <div class=\"col-auto ms-auto my-auto\">\n   188→                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n   189→                        </div>\n   190→                    </div>\n   191→                    <div class=\"row mt-4\">\n   192→                        <div class=\"col-12\">\n   193→                            <div class=\"card bg-gray-90 border-0\">\n   194→                                <div class=\"card-body py-3\">\n   195→                                    <div class=\"row\">\n   196→                                        <div class=\"col-auto my-auto\">\n   197→                                            ${crearBoton({\n   198→                                                clases: 'btn-text-gray text-label-2',\n   199→                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   200→                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   201→                                            })}\n   202→                                        </div>\n   203→                                        <div class=\"col my-auto\">\n   204→                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n   205→                                        </div>\n   206→                                        <div class=\"col-auto my-auto ps-0\">\n   207→                                            ${crearBoton({\n   208→                                                tooltip: `${crearTooltip({\n   209→                                                    placement: `top`,\n   210→                                                    content: `Detalle de consumo`,\n   211→                                                    toggle: `popover`,\n   212→                                                })}`,\n   213→                                                clases: 'btn-text-primary btn-circle p-2',\n   214→                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   215→                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n   216→                                            })}\n   217→                                        </div>\n   218→                                    </div>\n   219→                                </div>\n   220→                            </div>\n   221→                        </div>\n   222→                    </div>\n   223→                </div>\n   224→            </div>\n   225→        `;\n   226→    }).join('');\n   227→\n   228→    $('#listado-planes').html(contenidoHTML);\n   229→    inicializarTooltips();"}]},"uuid":"3c11a159-a80c-4516-a06a-48fafcb4411d","timestamp":"2026-01-22T15:37:05.189Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","oldString":"        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PLANES[estado.nombre]}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;","newString":"        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;","originalFile":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n * @author Andres González\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return empresa_plan.plan_credito_id === null ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${ESTADOS_PLANES[estado.nombre]}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 50, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n        let plan = empresa_plan.plan;\n\n        return `\n            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n                <td class=\"py-0 my-0\">\n                    <div class=\"card border-0\">\n                        <div class=\"card-body py-2 px-10\">\n                            <div class=\"row\">\n                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n                                    ${sucursal.nombre_comercial}\n                                </div>\n                                <div class=\"col my-auto\">\n                                    <div class=\"card bg-white border-0\">\n                                        <div class=\"card-body py-2\">\n                                            <div class=\"row\">\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Unidades',\n                                                            'box',\n                                                            total_agendas_consumidas_sucursal,\n                                                            plan.unidades,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Vacantes',\n                                                            'briefcase',\n                                                            total_ofertas_laborales_consumidas_sucursal,\n                                                            plan.cantidad_ofertas_laborales,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Usuarios',\n                                                            'person',\n                                                            total_usuarios_sucursal,\n                                                            plan.cantidad_usuarios,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `;\n    }).join('');\n}\n\n\n/**\n * Agrupar los consumos de un plan por empresa.\n *\n * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n * @returns {array}\n * @author Andres Morales\n */\nfunction obtenerConsumos(empresa_plan_consumos) {\n    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n\n    let consumos_empresas = new Map();\n\n    empresa_plan_consumos.forEach(consumo => {\n        let empresa = consumo.empresa;\n        if (!consumos_empresas.has(empresa.id)) {\n            empresa.consumos = [];\n            consumos_empresas.set(empresa.id, empresa);\n        }\n        consumos_empresas.get(empresa.id).consumos.push(consumo);\n    });\n\n    sucursales.forEach(sucursal => {\n        if (!consumos_empresas.has(sucursal.id)) {\n            consumos_empresas.set(sucursal.id, sucursal);\n        }\n    });\n\n    return Array.from(consumos_empresas.values());\n}\n\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n *\n * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n * @returns {number}\n * @author Andres Morales\n */\nfunction obtenerTotalUsuarios(empresa = null) {\n    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n    let usuarios_ids_temporal = new Set();\n    usuarios_temporal.forEach(usuario => {\n        if (usuarios_ids.includes(usuario.id)) {\n            usuarios_ids_temporal.add(usuario.id);\n        }\n    });\n    return usuarios_ids_temporal.size;\n}\n\n/**\n * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n *\n * @param {string} id Id del elemento a mostar u ocultar.\n * @param {string} elemento Elemento padre del menú de acciones.\n * @returns {void}\n * @author Andres Morales\n */\nfunction toggleSucursalesList(id, elemento) {\n    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n}\n\n/**\n * Realizar la consulta HTTP para solicitar la renovación de un plan.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function solicitarRenovacionPlan() {\n    $('#modal-solicitar-renovacion').modal('hide');\n    let plan_id = $('#id-plan-solicitar-renovacion').val();\n    await $.ajax({\n        type: 'POST',\n        url : '/solicitud-renovacion-plan',\n        data: {\n            plan_id,\n            empresa_id,\n            usuario_id,\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then(respuesta => {\n        $('#nombre-plan-solicitar-renovacion').text('');\n        $('#id-plan-solicitar-renovacion').val('');\n        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n    });\n}\n\n/**\n * Abrir el modal de confirmación de solicitud de renovación de un plan.\n *\n * @param {number} plan_id Id del plan.\n * @param {string} nombre_plan Nombre del plan.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n    $('#id-plan-solicitar-renovacion').val(plan_id);\n    $('#modal-solicitar-renovacion').modal('show');\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id){\n    if (factura_id) {\n        await $.ajax({\n            type: 'GET',\n            url: `archivos-abrir/${factura_id}`,\n            xhrFields: {responseType: 'blob'},\n        })\n            .then(respuesta => {\n                let ruta_factura = window.URL.createObjectURL(respuesta);\n                window.open(ruta_factura, '_blank');\n            })\n            .catch((error) => {\n                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n            });\n    } else {\n        mostrarToast('danger', 'No se encontró la factura');\n    }\n}\n","structuredPatch":[{"oldStart":178,"oldLines":32,"newStart":178,"newLines":15,"lines":["                 <div class=\"card-body\">","                     <div class=\"row\">","                         <div class=\"col-auto my-auto\">","-                            ${ESTADOS_PLANES[estado.nombre]}","+                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}","                         </div>","                         <div class=\"col-auto my-auto\">","                             <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>","                             <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>","                         </div>","                         <div class=\"col-auto ms-auto my-auto\">","-                            <p class=\"m-0 text-body-3\">Costo: ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>","+                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>","                         </div>","-                        <div class=\"col-auto my-auto\">","-                            <div class=\"dropdown\">","-                                ${crearBoton({","-                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',","-                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',","-                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]","-                                })}","-                                <div class=\"dropdown-menu dropdown-menu-start\">","-                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${empresa_plan.plan_credito.id}, '${empresa_plan.plan_credito.nombre}')\">","-                                        Solicitar renovación","-                                    </button>","-                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">","-                                        Ver factura","-                                    </button>","-                                </div>","-                            </div>","-                        </div>","                     </div>","                     <div class=\"row mt-4\">","                         <div class=\"col-12\">"]},{"oldStart":229,"oldLines":7,"newStart":212,"newLines":7,"lines":["                                                 })}`,","                                                 clases: 'btn-text-primary btn-circle p-2',","                                                 texto: '<i class=\"bi bi-eye text-headline-4\"></i>',","-                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}', 'Créditos')`,","+                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,","                                             })}","                                         </div>","                                     </div>"]},{"oldStart":237,"oldLines":21,"newStart":220,"newLines":6,"lines":["                             </div>","                         </div>","                     </div>","-                    <div class=\"row mt-5\">","-                        <div class=\"col-auto\">","-                            <p class=\"text-label-2\">","-                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>","-                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>","-                            </p>","-                        </div>","-                        <div class=\"col-auto ms-auto\">","-                            <p class=\"text-label-2\">","-                                <span class=\"me-4\">Vigencia</span>","-                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>","-                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }","-                            </p>","-                        </div>","-                    </div>","                 </div>","             </div>","         `;"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"f3c722b0-0fa0-428d-8760-d8dde8a6ee43"}
{"parentUuid":"3c11a159-a80c-4516-a06a-48fafcb4411d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01U3QDjBDN9dVxfCKxqCiG9g","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El archivo ha sido actualizado correctamente. Ahora la card de créditos está como estaba originalmente:\n- Tag fijo \"Activos\" con estilo verde\n- Título \"Plan de Créditos\"\n- Nombre del plan de crédito\n- Costo con formato de moneda\n- Progress bar de créditos disponibles\n- Sin el menú dropdown\n- Sin la sección de vigencia/duración\n\nLa lógica sigue siendo excluyente: una u otra card según el valor de plan_credito_id.","signature":"EswECkYICxgCKkAEJXMxMGWa4a4koULDQC3XIlVPQt52Znw9GOAZ3fd8PfagEcu21DqIHoJkVJwiZy1JQfWJeZeD0A3bHedqiZrPEgzOGKj4mIAtlQWRAb4aDPuKbOEjjHAcsFQL+CIwtVK7rN+loWnD2dJjhA574oKXxYxGfwFolJ40wG95LccNnGgxxdXOTcp12ODwsd7UKrMDPzdb2QSuDI0+vM6QS5EwgFunfEU7lX0Hmutng9HzMD9+WojR5AkDEo8UDt3UTkQHOb//C2koZX3X1b/BVNFTZ9qhlEtZX7r6+ceSdRO6a2hOXYv8Oc2sbnm2hZ5y+ZNMtTGk9UPMQL+Gcpfx5DD4sf3k/GmoP3xMFLZTBXItqcOu7sg60KM2A9RqPS+YPIJVlmd0Ek6b9hUIe2+ezh48CVej9fnoc9CoOxJh8ypz4xMENuvX5pDFlsNGmrb+xWQ+j69XCQrmc8l5ifsEFk8/9ACIOisvayVgihnSTCeLvs5m0FrPoxXeZGWJctoEXSr7m2FmTMuSTzczcKakhm1xhiQKGn/s8wto5xgIimd2K38+Obh9IUT+oITNf9ZJwy5opRK2TErDPIBHf9kYqp1JAaVWMnxPU+g4kD9i9jzr9c3X8Oh5neRsbzAiLoBPn5BVNfrLjdPwdD4eLefwPo2P9DDCBaXmaPcp3vfKoP1ZbD3bA/gjPdCNDTGjcti34HvCbWjXoydsjOss2ierb+udXh+mzL5s+kmP4F7uApNNa2N628At7Gplltv8vIxfvAZCrPQRGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3629,"cache_read_input_tokens":51739,"cache_creation":{"ephemeral_5m_input_tokens":3629,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXNfW83bA5TvGfQ4DVqPe","type":"assistant","uuid":"c32881c3-1bad-4de8-95b8-e809311e2a9c","timestamp":"2026-01-22T15:37:11.408Z"}
{"parentUuid":"c32881c3-1bad-4de8-95b8-e809311e2a9c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01U3QDjBDN9dVxfCKxqCiG9g","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Ahora la card de créditos está exactamente como estaba originalmente:\n\n- Tag fijo \"Activos\" (verde)\n- Título \"Plan de Créditos\" con icono de moneda\n- Nombre del plan y costo\n- Progress bar de créditos disponibles\n- Sin menú dropdown\n- Sin sección de vigencia\n\nLa lógica sigue funcionando: **si `plan_credito_id === null`** muestra plan normal, **si no** muestra card de créditos."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3629,"cache_read_input_tokens":51739,"cache_creation":{"ephemeral_5m_input_tokens":3629,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXNfW83bA5TvGfQ4DVqPe","type":"assistant","uuid":"a2e7cd5f-58f8-464f-92e1-69b6aff06a38","timestamp":"2026-01-22T15:37:13.100Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T15:54:01.186Z","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8"}
{"type":"file-history-snapshot","messageId":"d6af0453-9331-4f2a-b159-0251f793678c","snapshot":{"messageId":"d6af0453-9331-4f2a-b159-0251f793678c","trackedFileBackups":{"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v2","version":2,"backupTime":"2026-01-22T15:54:02.706Z"}},"timestamp":"2026-01-22T15:54:02.693Z"},"isSnapshotUpdate":false}
{"parentUuid":"85b83df0-2ad6-4b1e-8ede-7b8825ef2e53","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01XocPWxTpggcNFNqAEQB5A8","parentToolUseID":"toolu_01XocPWxTpggcNFNqAEQB5A8","uuid":"251b20dc-4956-4106-8c2e-a54e14385b55","timestamp":"2026-01-22T15:36:36.294Z"}
{"parentUuid":"f3c722b0-0fa0-428d-8760-d8dde8a6ee43","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01AvgrAySWXhEzWayW1ydKit","parentToolUseID":"toolu_01AvgrAySWXhEzWayW1ydKit","uuid":"c2f246a6-3f95-4b57-ba7a-b15e1db4e6e7","timestamp":"2026-01-22T15:36:59.796Z"}
{"parentUuid":"c2f246a6-3f95-4b57-ba7a-b15e1db4e6e7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01AvgrAySWXhEzWayW1ydKit","parentToolUseID":"toolu_01AvgrAySWXhEzWayW1ydKit","uuid":"04eee530-82df-4b79-b732-11f1c136d31b","timestamp":"2026-01-22T15:36:59.797Z"}
{"parentUuid":"3c11a159-a80c-4516-a06a-48fafcb4411d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01AvgrAySWXhEzWayW1ydKit","toolUseID":"toolu_01AvgrAySWXhEzWayW1ydKit","timestamp":"2026-01-22T15:37:05.191Z","uuid":"06b4f981-c3c6-4fd9-954a-7333dca1435a"}
{"parentUuid":"a2e7cd5f-58f8-464f-92e1-69b6aff06a38","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 78 to 85 from c:\\laragon\\www\\psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php:\n/**\n     * Obtener el atributo creditos_restantes.\n     *\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getCreditosRestantesAttribute(): int {\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"esto que hace? /**\n     * Obtener el atributo creditos_restantes.\n     *\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getCreditosRestantesAttribute(): int {"}]},"uuid":"d6af0453-9331-4f2a-b159-0251f793678c","timestamp":"2026-01-22T15:54:02.691Z","permissionMode":"default"}
{"parentUuid":"d6af0453-9331-4f2a-b159-0251f793678c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_015kmxM3p9x88FvFc952vggw","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere saber qué hace este método. Es un \"accessor\" de Laravel (Eloquent). Necesito leer el archivo completo para ver la implementación del método.","signature":"EssCCkYICxgCKkDeFQbc/MRDEmqvChEYOHOebN0uKyt5tbUC0JpCxazuU8sXC3nfwyKZse+bKrR+iUu6+LJe8JOiVJiTFfh4y7fgEgylELA5FNl6VbSalagaDC8RGX8DWj00yyhNPCIw+PMlXw+6MQsrFrGb08N9XsQHHTh9ZT15lkdctUiOrZjhWztYCSrLO7sKyqFyhm3HKrIB6LEjwXT3aZOlVnn63PSObFlaW3Wd1WXeltJq7pNRw9IBKbk4fJ6V+RiZ1DrDZ6yOWVHADqisi2PHP7U6BceRIFroLi6BaIWIWM6L1vrFY4e6rXVd9xpBFupEYG77l3YqwBUjCc0sGXvo97QWSxDpILMqMZ8HBXb52PlkGKdfiLedgXBGrLS0IL4TPLOvgyb00vHAg3c9IEfcNCdPBCjw72wXmlHPytB/WJMTsUBlUkb+QRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":57692,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":57692,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXNgo2X3gHCL6CNMS4mRM","type":"assistant","uuid":"330906e3-9c5f-4f1a-8d1b-89784834ce7b","timestamp":"2026-01-22T15:54:07.917Z"}
{"parentUuid":"330906e3-9c5f-4f1a-8d1b-89784834ce7b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_015kmxM3p9x88FvFc952vggw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011gQxRmyn7jd21WMvUzRGj8","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php","offset":78,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":57692,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":57692,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXNgo2X3gHCL6CNMS4mRM","type":"assistant","uuid":"0c495e93-550e-4fe5-9314-02eacc598980","timestamp":"2026-01-22T15:54:08.839Z"}
{"parentUuid":"0c495e93-550e-4fe5-9314-02eacc598980","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011gQxRmyn7jd21WMvUzRGj8","type":"tool_result","content":"    78→    /**\n    79→     * Obtener el atributo creditos_restantes.\n    80→     *\n    81→     * @return int\n    82→     * @author Sergio Vargas\n    83→     * @author Daniel Beltrán\n    84→     */\n    85→    public function getCreditosRestantesAttribute(): int {\n    86→        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    87→    }\n    88→\n    89→    /**\n    90→     * Relación de muchos a uno con empresas.\n    91→     *\n    92→     * @return BelongsTo\n    93→     * @author Daniel Beltrán\n    94→     */\n    95→    public function empresa(): BelongsTo {\n    96→        return $this->belongsTo(Empresa::class);\n    97→    }\n    98→\n    99→    /**\n   100→     * Relación de muchos a uno con planes.\n   101→     *\n   102→     * @return BelongsTo\n   103→     * @author Daniel Beltrán\n   104→     */\n   105→    public function plan(): BelongsTo {\n   106→        return $this->belongsTo(Plan::class);\n   107→    }\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"451fbbb3-4b94-4dc1-b484-9c78f0c877f9","timestamp":"2026-01-22T15:54:10.104Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php","content":"    /**\n     * Obtener el atributo creditos_restantes.\n     *\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getCreditosRestantesAttribute(): int {\n        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    }\n\n    /**\n     * Relación de muchos a uno con empresas.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function empresa(): BelongsTo {\n        return $this->belongsTo(Empresa::class);\n    }\n\n    /**\n     * Relación de muchos a uno con planes.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function plan(): BelongsTo {\n        return $this->belongsTo(Plan::class);\n    }","numLines":30,"startLine":78,"totalLines":192}},"sourceToolAssistantUUID":"0c495e93-550e-4fe5-9314-02eacc598980"}
{"parentUuid":"451fbbb3-4b94-4dc1-b484-9c78f0c877f9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01939zEPycmxwf6yj8MLMNXv","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora puedo explicar qué hace este método.","signature":"EtQBCkYICxgCKkC4d0Ty5JJldwMI/RFZhSkAy4Vvi06OlUWyO9dzHw2j6usrmi3XnG07U+nPNelvEYXG7hPo3hPEYVWEWhvptsT6EgwJ8Woz7jRyHn8xjJMaDGjjnp+uHMWryVqCxCIwssiZdbKAb2A0RRz5EUAyQANGFyXeCpRYEa3wG251d6jfga5qLlpf+l8jx0yrKWhyKjxceZ7xgEXTwWYc+nskhtXj8n9iV1GiexToQnLJ0ieqW7nL32rXlZhwLvc2DJJKpYOOVZ7f+wKqltcwlDkYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":597,"cache_read_input_tokens":57692,"cache_creation":{"ephemeral_5m_input_tokens":597,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNgoZDWBbPDxx4Tunq6r","type":"assistant","uuid":"075ec6ad-69db-4959-92b6-ae6ca033d571","timestamp":"2026-01-22T15:54:13.662Z"}
{"parentUuid":"075ec6ad-69db-4959-92b6-ae6ca033d571","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"cbf1bdea-538d-437e-ac51-cee194a147f8","version":"2.1.15","gitBranch":"D26-260","slug":"deep-humming-lantern","message":{"model":"claude-opus-4-5-20251101","id":"msg_01939zEPycmxwf6yj8MLMNXv","type":"message","role":"assistant","content":[{"type":"text","text":"Es un **Accessor de Laravel** (atributo computado). Permite acceder a `$empresa_plan->creditos_restantes` como si fuera un campo de la base de datos, pero su valor se calcula dinámicamente.\n\n### Qué hace (línea 86):\n\n```php\nreturn max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n```\n\n| Parte | Descripción |\n|-------|-------------|\n| `$this->creditos` | Créditos totales asignados al plan |\n| `$this->consumosCreditos()->sum('creditos')` | Suma de créditos ya consumidos (relación con tabla de consumos) |\n| `max(0, ...)` | Asegura que nunca retorne un número negativo |\n\n### Ejemplo:\n- Plan tiene **100 créditos** asignados\n- Se han **consumido 75** créditos\n- `creditos_restantes` retorna **25**\n\n### Uso:\n```php\n$empresa_plan = EmpresaPlan::find(1);\necho $empresa_plan->creditos_restantes; // Ej: 25\n```\n\nLa convención de Laravel para accessors es `get{NombreAtributo}Attribute`, donde `NombreAtributo` en snake_case (`creditos_restantes`) se convierte a PascalCase (`CreditosRestantes`)."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":597,"cache_read_input_tokens":57692,"cache_creation":{"ephemeral_5m_input_tokens":597,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNgoZDWBbPDxx4Tunq6r","type":"assistant","uuid":"b4d8863b-ab80-4c7a-9339-af6f019e4f45","timestamp":"2026-01-22T15:54:19.334Z"}

{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-27T13:58:07.137Z","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a"}
{"type":"file-history-snapshot","messageId":"53c505dd-56fe-43d2-810b-4de2d470722a","snapshot":{"messageId":"53c505dd-56fe-43d2-810b-4de2d470722a","trackedFileBackups":{},"timestamp":"2026-01-27T13:58:07.256Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 799 to 799 from c:\\laragon\\www\\psicoalianza-2\\routes\\web.php:\nEmpresas\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"analiza este archo y dem en donde puedo colar una ruta que pueda aceeder todoe l mundo"}]},"uuid":"53c505dd-56fe-43d2-810b-4de2d470722a","timestamp":"2026-01-27T13:58:07.250Z","permissionMode":"default"}
{"parentUuid":"53c505dd-56fe-43d2-810b-4de2d470722a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LybjumBSSfRaQWrCByDSGm","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que analice el archivo de rutas web.php y le indique dónde puede colocar una ruta que sea accesible para todos (sin autenticación).\n\nPrimero necesito leer el archivo completo para entender su estructura.","signature":"EoYDCkYICxgCKkA8zngMZbwTogPUeInnGW22Xp1BgW3OvA2knuCKg+dK9HFVUOVIU5OH7nsx3xUtPxpYhR92B6VG693NN4kWP6vgEgzvfYksWsBO3leZNA0aDGC0dyc3qYpkmQPC+yIwNHBWBDWZFXdXsO6d+vXHQ+DfCPc1rC4GCYL7u0WE0n5p6m269rDg5YhpNxagB2ZhKu0B6phLWMNVzQsqwintrWGjf9XkNjC3JJq4F7kOI4xLhSnBqnQWdU6xE94FgyTfDSL/G/Nu5mtNq/rd4tcLEFfrsObaUyiLX4NtindRDhRll5OBhD393c4ZGsKVoBOjy5K7IiDCTJFosokq6RpHpLDIVO5epgKQV97tEf92J41Vcviu9p0MYGCgOcX+rQkppDDGkDTpMkpgqXuAWlv69DSBjD079Byu1a849HWqJuyP/p65HcRMu3SHggao6gsT3NPD7EFyQdu3aFrOPc3FM89HvEl+BTWFDDDhpkeqDJpU9u0ZsRTeFjAQ9kWZMK8nGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":25099,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25099,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXXzzsw5GVxL1WYaWZipi","type":"assistant","uuid":"2ab6d1cb-cbf1-4018-be54-85e8dd276b5d","timestamp":"2026-01-27T13:58:11.121Z"}
{"parentUuid":"2ab6d1cb-cbf1-4018-be54-85e8dd276b5d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LybjumBSSfRaQWrCByDSGm","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a leer el archivo de rutas para analizar su estructura."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":25099,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25099,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXXzzsw5GVxL1WYaWZipi","type":"assistant","uuid":"f1095caf-a0ba-4f73-af40-10641fc42749","timestamp":"2026-01-27T13:58:11.600Z"}
{"parentUuid":"f1095caf-a0ba-4f73-af40-10641fc42749","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LybjumBSSfRaQWrCByDSGm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019ovHMKfecjqPfUfZsi1yVQ","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\routes\\web.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":25099,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25099,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXXzzsw5GVxL1WYaWZipi","type":"assistant","uuid":"5924d748-fc78-4c3b-90f5-51d6c28c245c","timestamp":"2026-01-27T13:58:12.086Z"}
{"parentUuid":"5924d748-fc78-4c3b-90f5-51d6c28c245c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019ovHMKfecjqPfUfZsi1yVQ","type":"tool_result","content":"     1→<?php\n     2→\n     3→use Illuminate\\Support\\Str;\n     4→use Illuminate\\Http\\Request;\n     5→use Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n     6→\n     7→Route::get('/', function () {\n     8→    return redirect()->route('login');\n     9→});\n    10→\n    11→Auth::routes(['register' => false]);\n    12→\n    13→// Rutas de acceso para aplicante.\n    14→Route::group([\n    15→    'prefix'    => 'control-acceso',\n    16→    'namespace' => 'App\\Http\\Controllers\\Auth'\n    17→], function ($ruta) {\n    18→    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    19→    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    20→    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n    21→});\n    22→\n    23→// Rutas de migración de usuarios desde la base de datos antigua.\n    24→Route::group([\n    25→    'prefix'    => 'migrar-usuario-app-antigua',\n    26→    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n    27→], function ($ruta) {\n    28→    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    29→    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n    30→});\n    31→\n    32→// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\n    33→Route::group([\n    34→    'prefix'     => 'rol-empresa',\n    35→    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    36→    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n    37→], function ($ruta) {\n    38→    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    39→    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n    40→});\n    41→\n    42→// Rutas protegidas por autenticación y selección de rol y empresa.\n    43→Route::group([\n    44→    'middleware' => ['auth', 'auth.rol-empresa'],\n    45→    'namespace'  => 'App\\Http\\Controllers'\n    46→], function ($ruta) {\n    47→    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n    48→\n    49→    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n    50→        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n    51→        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n    52→\n    53→        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n    54→            // Usuarios\n    55→            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n    56→            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n    57→            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n    58→            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n    59→            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n    60→            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n    61→            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n    62→            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n    63→            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n    64→            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n    65→            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n    66→            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n    67→            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n    68→            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n    69→\n    70→            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n    71→            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n    72→            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n    73→        });\n    74→    });\n    75→\n    76→    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n    77→        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n    78→            // Pruebas\n    79→            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n    80→            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n    81→            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n    82→            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n    83→            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n    84→            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n    85→            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n    86→            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n    87→        });\n    88→\n    89→        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n    90→            // Carga masiva de pruebas\n    91→            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n    92→            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n    93→            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n    94→            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n    95→        });\n    96→\n    97→        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n    98→            // Baremos\n    99→            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n   100→            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n   101→            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n   102→            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n   103→        });\n   104→\n   105→        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n   106→            // Dimensiones\n   107→            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n   108→            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n   109→            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n   110→            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n   111→            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n   112→        });\n   113→\n   114→        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n   115→            // Factores\n   116→            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n   117→            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n   118→            $ruta->resource('factores', 'Pruebas\\FactorController');\n   119→            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n   120→        });\n   121→\n   122→        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n   123→            // Reactivos\n   124→            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n   125→            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n   126→            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n   127→\n   128→            // Opciones\n   129→            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n   130→        });\n   131→\n   132→        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n   133→            // Calificaciones\n   134→            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n   135→            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n   136→            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n   137→        });\n   138→\n   139→        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n   140→            // Grupos de opciones\n   141→            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n   142→            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n   143→            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n   144→        });\n   145→\n   146→        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n   147→            // Secciones de texto\n   148→            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n   149→            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n   150→            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n   151→        });\n   152→\n   153→        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n   154→    });\n   155→\n   156→    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n   157→        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n   158→            // Perfiles\n   159→            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n   160→            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n   161→            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n   162→        });\n   163→\n   164→        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n   165→            // Módulos de preguntas\n   166→            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n   167→            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n   168→            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n   169→            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n   170→            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n   171→        });\n   172→\n   173→        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n   174→            // Demográficas\n   175→            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n   176→            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n   177→            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n   178→        });\n   179→    });\n   180→\n   181→    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n   182→        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n   183→            // Listado de empresas\n   184→            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n   185→            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n   186→            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n   187→            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n   188→            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n   189→            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n   190→            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n   191→            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n   192→            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n   193→            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n   194→            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n   195→            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n   196→            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n   197→            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n   198→            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n   199→        });\n   200→\n   201→        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n   202→            // Gestionar empresas\n   203→            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n   204→            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n   205→            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n   206→            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n   207→\n   208→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n   209→                // Usuarios\n   210→                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n   211→                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n   212→            });\n   213→\n   214→            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n   215→                // Planes\n   216→                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n   217→                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n   218→            });\n   219→        });\n   220→\n   221→        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n   222→            // Archivo de empresas\n   223→            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n   224→            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n   225→            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n   226→        });\n   227→\n   228→        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n   229→            // Migración de empresas\n   230→            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n   231→            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n   232→            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n   233→            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n   234→        });\n   235→\n   236→        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n   237→            // Portales de empleo\n   238→            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   239→            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n   240→            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n   241→            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n   242→\n   243→            // Premios destacados\n   244→            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n   245→            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n   246→\n   247→            // Motivadores\n   248→            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n   249→        });\n   250→\n   251→        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n   252→        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n   253→        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n   254→    });\n   255→\n   256→    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n   257→        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n   258→        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n   259→        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n   260→        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n   261→    });\n   262→\n   263→    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n   264→        // Planes\n   265→        $ruta->resource('planes', 'Planes\\PlanController');\n   266→        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n   267→        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n   268→        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n   269→        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n   270→        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n   271→        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n   272→        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n   273→        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n   274→        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n   275→        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n   276→        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n   277→        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n   278→        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n   279→        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n   280→        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n   281→\n   282→        // Planes de Créditos - Vista de creación\n   283→        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n   284→        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   285→        $ruta->get('servicios-ia/{id}/creditos', 'IA\\ServicioIAController@creditos');\n   286→        $ruta->post('servicios-ia/{id}/activar', 'IA\\ServicioIAController@activar');\n   287→        $ruta->post('servicios-ia/{id}/desactivar', 'IA\\ServicioIAController@desactivar');\n   288→        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n   289→        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n   290→        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n   291→\n   292→        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n   293→            // Consumos\n   294→            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n   295→            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n   296→            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n   297→            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n   298→            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n   299→            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n   300→            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n   301→            $ruta->post('consumos-creditos-ia-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelConsumosCreditosIA');\n   302→            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n   303→            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n   304→            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n   305→            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n   306→            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n   307→            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n   308→        });\n   309→\n   310→        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n   311→            // Archivo\n   312→            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n   313→            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n   314→        });\n   315→    });\n   316→\n   317→    // Perfiles laborales\n   318→    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n   319→    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n   320→    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n   321→    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n   322→\n   323→    // Preguntas de ofertas laborales\n   324→    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n   325→    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n   326→    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n   327→    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n   328→    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n   329→    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n   330→\n   331→    // Preguntas de videoentrevista\n   332→    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n   333→    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n   334→    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n   335→    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n   336→\n   337→    // Vacantes\n   338→    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n   339→    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n   340→    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n   341→    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n   342→    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n   343→    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n   344→    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n   345→    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n   346→    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n   347→    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n   348→    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n   349→    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n   350→\n   351→    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n   352→\n   353→    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n   354→    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n   355→\n   356→    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n   357→        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n   358→            // Ajustes - General\n   359→            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n   360→        });\n   361→\n   362→        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n   363→            // Ajustes - Roles y permisos\n   364→            $ruta->get('roles', 'Auth\\RolController@index');\n   365→        });\n   366→\n   367→        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n   368→            // Ajustes - Deshacer acciones\n   369→            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n   370→            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n   371→            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n   372→            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n   373→        });\n   374→\n   375→        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n   376→            // Ajustes - Ofertas y anuncios\n   377→            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n   378→            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n   379→            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n   380→            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n   381→            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n   382→        });\n   383→\n   384→        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n   385→            // Webinars\n   386→            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n   387→            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n   388→            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n   389→            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n   390→            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n   391→            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n   392→\n   393→            // Eventos\n   394→            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n   395→            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n   396→            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n   397→            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n   398→            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n   399→            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n   400→\n   401→            // Guías\n   402→            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n   403→            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n   404→            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n   405→            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n   406→            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n   407→            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n   408→\n   409→            // Tutoriales\n   410→            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n   411→            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n   412→            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n   413→            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n   414→            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n   415→\n   416→            // Podcast\n   417→            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n   418→            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n   419→            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n   420→            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n   421→            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n   422→\n   423→            // Capacitación\n   424→            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n   425→            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n   426→            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n   427→            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n   428→            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n   429→\n   430→            // Certificación\n   431→            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n   432→            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n   433→            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n   434→            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n   435→            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n   436→            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n   437→        });\n   438→    });\n   439→\n   440→    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n   441→        // Soportes\n   442→        $ruta->resource('soportes', 'Soportes\\SoporteController');\n   443→        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n   444→        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n   445→        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n   446→        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n   447→        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n   448→        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n   449→        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n   450→        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n   451→        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n   452→\n   453→        // Manuales\n   454→        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n   455→        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n   456→\n   457→        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n   458→            // Aplicantes\n   459→            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n   460→        });\n   461→\n   462→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n   463→            // Preguntas frecuentes\n   464→            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n   465→            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n   466→            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n   467→            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n   468→            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n   469→        });\n   470→\n   471→        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n   472→            // Preguntas frecuentes reacciónes\n   473→            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n   474→        });\n   475→    });\n   476→\n   477→    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n   478→    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n   479→    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n   480→\n   481→    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n   482→        // Módulos\n   483→        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n   484→        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n   485→\n   486→        // Auditorías\n   487→        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n   488→\n   489→        // Accesos\n   490→        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n   491→\n   492→        // Registros de actividad\n   493→        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n   494→\n   495→        // Novedades\n   496→        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n   497→        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n   498→        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n   499→\n   500→        // Países\n   501→        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n   502→        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n   503→        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n   504→        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n   505→        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n   506→\n   507→        // Reportes\n   508→        $ruta->resource('reportes', 'Reportes\\ReporteController');\n   509→        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n   510→        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n   511→\n   512→        // Minería de datos.\n   513→        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n   514→        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n   515→\n   516→        // Pruebas completas\n   517→        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n   518→        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n   519→        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n   520→        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n   521→        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n   522→    });\n   523→\n   524→    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n   525→        // Ordenes de servicio\n   526→        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n   527→        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n   528→        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n   529→\n   530→        // Ofertas laborales\n   531→        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n   532→        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n   533→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n   534→        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n   535→        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n   536→        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n   537→        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n   538→        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n   539→        ->name('sin-disponibilidad-ofertas-laborales');\n   540→        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n   541→        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n   542→        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n   543→        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n   544→        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n   545→        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n   546→        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n   547→\n   548→        // Vacantes\n   549→        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n   550→        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n   551→\n   552→        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n   553→            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n   554→            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n   555→            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n   556→            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n   557→            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n   558→            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n   559→            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n   560→            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n   561→            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n   562→        });\n   563→\n   564→        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n   565→        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n   566→        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n   567→        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n   568→        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n   569→        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n   570→        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n   571→        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n   572→        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n   573→        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n   574→        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n   575→        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n   576→        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n   577→        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n   578→        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n   579→        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n   580→        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n   581→        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n   582→        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n   583→        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n   584→        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n   585→        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n   586→\n   587→        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n   588→        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n   589→        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n   590→\n   591→        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n   592→        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n   593→        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n   594→\n   595→        // Etapas\n   596→        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n   597→        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n   598→        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n   599→        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n   600→        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n   601→        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n   602→\n   603→        // Movimientos\n   604→        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n   605→        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n   606→        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n   607→        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n   608→\n   609→        // Novedades\n   610→        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n   611→\n   612→        $ruta->get('feedback', 'DashboardController@enConstruccion');\n   613→        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n   614→\n   615→        // Procesos\n   616→        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n   617→        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n   618→        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n   619→        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n   620→        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n   621→        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n   622→        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n   623→        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n   624→        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n   625→        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n   626→        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n   627→        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n   628→        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n   629→        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n   630→        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n   631→        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n   632→        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n   633→        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n   634→        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n   635→        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n   636→        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n   637→        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n   638→        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n   639→        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n   640→        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n   641→        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n   642→        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n   643→        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n   644→        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n   645→        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n   646→        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n   647→        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n   648→\n   649→        // Firmas de rutas\n   650→        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n   651→\n   652→        // Perfiles pruebas\n   653→        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n   654→\n   655→        // Agendas\n   656→        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n   657→        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n   658→        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n   659→        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n   660→\n   661→        // Comentarios\n   662→        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n   663→\n   664→        // Usuarios\n   665→        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n   666→    });\n   667→\n   668→    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n   669→        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n   670→\n   671→        // Debug de calificaciones de agendas\n   672→        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n   673→        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n   674→        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n   675→        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n   676→    });\n   677→\n   678→    // Suplantación de rol Administrador general\n   679→    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n   680→        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n   681→    });\n   682→\n   683→    // Suplantación de rol Administrador sucursal\n   684→    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n   685→        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n   686→    });\n   687→\n   688→    // Restablecimiento de la sesión original que había antes de la suplantación\n   689→    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n   690→        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n   691→    });\n   692→\n   693→    // Ruta para completar los datos de un usuario aplicante\n   694→    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n   695→        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n   696→        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n   697→        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n   698→        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n   699→    });\n   700→\n   701→    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n   702→    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n   703→        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n   704→        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n   705→        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n   706→        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n   707→        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n   708→        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n   709→        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n   710→        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n   711→        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n   712→        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n   713→        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n   714→        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n   715→        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n   716→        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n   717→        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n   718→        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n   719→        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n   720→        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n   721→        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n   722→        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   723→        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n   724→            ->name('ofertas-laborales.detalles-aplicante');\n   725→        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n   726→        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n   727→\n   728→        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n   729→    });\n   730→\n   731→    // Ofertas laborales\n   732→    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n   733→\n   734→    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n   735→    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n   736→    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n   737→    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n   738→    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n   739→    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n   740→    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n   741→\n   742→    // Usuarios\n   743→    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n   744→    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n   745→\n   746→    // Perfiles\n   747→    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n   748→    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n   749→    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n   750→    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n   751→    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n   752→\n   753→    // Archivos\n   754→    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n   755→    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n   756→    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n   757→\n   758→    // Menú clientes\n   759→    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n   760→    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n   761→    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n   762→\n   763→    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n   764→    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n   765→    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n   766→    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n   767→    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n   768→\n   769→    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n   770→    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n   771→    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n   772→    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n   773→    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n   774→    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n   775→    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n   776→    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n   777→    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n   778→\n   779→    // Agendas - Accesible para aplicantes y usuarios de empresa\n   780→    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n   781→\n   782→    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n   783→    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n   784→    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n   785→    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n   786→    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n   787→\n   788→    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n   789→    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n   790→\n   791→    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n   792→    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n   793→    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n   794→\n   795→    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n   796→    $ruta->get('novedades', 'DashboardController@enConstruccion');\n   797→\n   798→    // Áreas\n   799→    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n   800→    $ruta->post('areas', 'Empresas\\AreaController@store');\n   801→\n   802→    // Cargos\n   803→    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n   804→    $ruta->post('cargos', 'Empresas\\CargoController@store');\n   805→\n   806→    // Niveles educativos\n   807→    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n   808→\n   809→    // Áreas de estudio\n   810→    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n   811→\n   812→    // Idiomas\n   813→    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n   814→\n   815→    // Autenticación del websoket\n   816→    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n   817→\n   818→    $ruta->get('/botones', function () {\n   819→        return view('botones');\n   820→    })->name('botones');\n   821→\n   822→    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n   823→    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n   824→    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n   825→\n   826→    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n   827→    $ruta->get('analiticas', 'DashboardController@index');\n   828→    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n   829→    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n   830→    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n   831→    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n   832→    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n   833→\n   834→    // Rutas de componentes de desarrollo\n   835→    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n   836→    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n   837→\n   838→    // TODO: ruta de prueba, eliminarla próximamente\n   839→    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n   840→    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n   841→    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n   842→    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n   843→    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n   844→\n   845→    // Rutas para las encuestas\n   846→    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n   847→    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n   848→});\n   849→\n   850→// Rutas no protegidas por autenticación\n   851→Route::group([\n   852→    'namespace' => 'App\\Http\\Controllers'\n   853→], function ($ruta) {\n   854→    // Contraseñas\n   855→    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n   856→\n   857→    // Empresas\n   858→    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n   859→    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n   860→    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n   861→    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n   862→    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n   863→\n   864→    // Ordenes de servicio\n   865→    $ruta->group([\n   866→        'middleware' => 'orden-servicio-enlace-publico'\n   867→    ], function ($ruta) {\n   868→        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n   869→        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n   870→    });\n   871→\n   872→    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n   873→\n   874→    // Países\n   875→    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n   876→    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n   877→\n   878→    // Departamentos\n   879→    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n   880→\n   881→    // Ciudades\n   882→    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n   883→\n   884→    // Portales de empleo\n   885→    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n   886→    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n   887→    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n   888→    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n   889→    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n   890→    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n   891→    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n   892→\n   893→    // Firmas de rutas\n   894→    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n   895→    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n   896→    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n   897→    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n   898→\n   899→    // Archivos\n   900→    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n   901→\n   902→    // Imagen de usuarios\n   903→    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n   904→\n   905→    // Consultar reportes con firma\n   906→    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n   907→});\n   908→\n   909→/**\n   910→ * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n   911→ *\n   912→ * @author Fahibram Cárcamo\n   913→ */\n   914→Route::group([\n   915→    'prefix'     => 'rutas-firmadas',\n   916→    'middleware' => ['ruta-firmada'],\n   917→    'namespace'  => 'App\\Http\\Controllers'\n   918→], function ($ruta) {\n   919→    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n   920→    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n   921→});\n   922→\n   923→/**\n   924→ * Genera un token SSO firmado y redirige a WordPress.\n   925→ *\n   926→ * Flujo:\n   927→ *  - Requiere un usuario autenticado (será el admin en WP).\n   928→ *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n   929→ *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n   930→ *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n   931→ *  - Redirige al callback configurado en WordPress.\n   932→ *\n   933→ * @author Sergio Vargas\n   934→ */\n   935→Route::get('/sso/wordpress', function (Request $request) {\n   936→    $user = $request->user();\n   937→    $empresa = $user->empresa;\n   938→\n   939→    $studentId = $request->input('student_id');\n   940→    $etapaVacanteUsuarioId = $request->input('etapa_vacante_usuario_id');\n   941→    $studentData = null;\n   942→\n   943→    if ($studentId) {\n   944→        $student = App\\Models\\Usuarios\\User::find($studentId);\n   945→\n   946→        if ($student && $student->id !== $user->id) {\n   947→            $studentData = [\n   948→                'id'    => (string) $student->id,\n   949→                'email' => $student->email,\n   950→                'name'  => $student->getNombreCompletoAttribute(),\n   951→            ];\n   952→\n   953→            // Agregar competencias si se pasa etapa_vacante_usuario_id\n   954→            if ($etapaVacanteUsuarioId) {\n   955→                $studentData['competencias'] = sso_obtener_competencias((int) $etapaVacanteUsuarioId);\n   956→            }\n   957→        }\n   958→    }\n   959→\n   960→    $nonce = (string) Str::uuid();\n   961→    $exp   = now()->addSeconds(60)->timestamp;\n   962→\n   963→    Cache::put(\"sso_nonce:{$nonce}\", [\n   964→        'user_id' => $user->id,\n   965→        'exp'     => $exp,\n   966→    ], now()->addMinutes(5));\n   967→\n   968→    $payload = [\n   969→        'sub'              => (string) $user->id,\n   970→        'email'            => $user->email,\n   971→        'name'             => $user->getNombreCompletoAttribute(),\n   972→        'nombre_comercial' => $empresa?->nombre_comercial ?? $empresa?->razon_social,\n   973→        'documento'        => $empresa?->documento,\n   974→        'nonce'            => $nonce,\n   975→        'exp'              => $exp,\n   976→        'student'          => $studentData,\n   977→    ];\n   978→\n   979→    $token    = sso_sign_token($payload, config('services.sso.secret'));\n   980→    $wp       = rtrim(config('services.sso.wp_url'), '/');\n   981→    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n   982→    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n   983→\n   984→    return redirect()->away(\n   985→        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n   986→    );\n   987→})->middleware('auth');\n   988→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2defc124-4a96-41d3-91f0-930e97aa4165","timestamp":"2026-01-27T13:58:14.821Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\routes\\web.php","content":"<?php\n\nuse Illuminate\\Support\\Str;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Facades\\{Auth, Cache, Route};\n\nRoute::get('/', function () {\n    return redirect()->route('login');\n});\n\nAuth::routes(['register' => false]);\n\n// Rutas de acceso para aplicante.\nRoute::group([\n    'prefix'    => 'control-acceso',\n    'namespace' => 'App\\Http\\Controllers\\Auth'\n], function ($ruta) {\n    $ruta->get('/acceso-expirado', 'LoginController@accesoExpirado')->name('control-acceso.token-expirado');\n    $ruta->get('/{token}', 'LoginController@controlarAcceso')->name('control-acceso');\n    $ruta->post('/login-automatico/{token}', 'LoginController@loginAutomatico')->name('control-acceso.login-automatico');\n});\n\n// Rutas de migración de usuarios desde la base de datos antigua.\nRoute::group([\n    'prefix'    => 'migrar-usuario-app-antigua',\n    'namespace' => 'App\\Http\\Controllers\\Usuarios'\n], function ($ruta) {\n    $ruta->get('/', 'UserController@migrarUsuario')->name('migrar-usuario-app-antigua')->middleware('validar-usuario-app-antigua');\n    $ruta->get('/error', 'UserController@migrarUsuarioError')->name('migrar-usuario-app-antigua.error');\n});\n\n// Rutas protegidas por autenticación y cambio de selección de rol y empresa.\nRoute::group([\n    'prefix'     => 'rol-empresa',\n    'namespace'  => 'App\\Http\\Controllers\\Auth',\n    'middleware' => ['auth', 'auth.cambio-rol-empresa']\n], function ($ruta) {\n    $ruta->get('/', 'RolController@formularioRolEmpresa')->name('rol-empresa');\n    $ruta->post('/sesion', 'RolController@guardarRolEmpresaSesion')->name('rol-empresa.guardar-en-sesion');\n});\n\n// Rutas protegidas por autenticación y selección de rol y empresa.\nRoute::group([\n    'middleware' => ['auth', 'auth.rol-empresa'],\n    'namespace'  => 'App\\Http\\Controllers'\n], function ($ruta) {\n    $ruta->get('usuario-validar-informacion-basica', 'Usuarios\\UserController@validarInformacionBasica');\n\n    $ruta->group(['middleware' => 'can:tablero'], function ($ruta) {\n        $ruta->get('inicio', 'DashboardController@index')->middleware('validar-datos-completados-usuario')->name('inicio');\n        $ruta->get('inicio-datos-panel', 'DashboardController@obtenerDatosPanel');\n\n        $ruta->group(['middleware' => 'can:tablero.usuarios'], function ($ruta) {\n            // Usuarios\n            $ruta->resource('usuarios', 'Usuarios\\UserController')->except(['index']);\n            $ruta->patch('usuarios-actualizar-multiples', 'Usuarios\\UserController@actualizarMultiples');\n            $ruta->post('usuarios-eliminar-multiples', 'Usuarios\\UserController@eliminarMultiples');\n            $ruta->post('usuarios-generar-acceso', 'Usuarios\\UserController@generarAcceso');\n            $ruta->get('usuarios-historial-cambios/{id}', 'Usuarios\\UserController@historialCambios');\n            $ruta->post('usuarios-historial-cambios-exportar/{id}', 'Usuarios\\UserController@exportarExcelHistorialCambios');\n            $ruta->get('usuarios-listado', 'Usuarios\\UserController@listado');\n            $ruta->get('usuarios-listado-empresa', 'Usuarios\\UserController@listadoAsociadosEmpresa');\n            $ruta->get('usuario', 'Usuarios\\UserController@obtenerUsuario');\n            $ruta->get('aplicante-informacion-personal/{id}', 'Usuarios\\UserController@informacionPersonalAplicante');\n            $ruta->post('usuario-actualizar-imagen', 'Usuarios\\UserController@actualizarImagenUsuario');\n            $ruta->get('usuario-notificaciones', 'Usuarios\\UserController@notificaciones');\n            $ruta->post('usuario-marcar-notificaciones-leidas', 'Usuarios\\UserController@marcarNotificacionesLeidas');\n            $ruta->post('exportar-excel-usuarios-empresa', 'Usuarios\\UserController@exportarExcelUsuariosEmpresa');\n\n            $ruta->post('usuarios-generar-qr-google', 'Usuarios\\UserController@obtenerQrGoogle');\n            $ruta->post('usuarios-validar-codigo-otp-google', 'Usuarios\\UserController@validarCodigoOtp');\n            $ruta->delete('usuarios-eliminar-clave-secreta-google/{id}', 'Usuarios\\UserController@eliminarClaveSecreta');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:pruebas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:pruebas.pruebas'], function ($ruta) {\n            // Pruebas\n            $ruta->get('pruebas/lista', 'Pruebas\\PruebaController@lista');\n            $ruta->resource('pruebas', 'Pruebas\\PruebaController');\n            $ruta->get('pruebas-listado', 'Pruebas\\PruebaController@listado');\n            $ruta->get('pruebas/{id}/factores', 'Pruebas\\PruebaController@getFactores');\n            $ruta->get('pruebas/{id}/reactivos', 'Pruebas\\PruebaController@getReactivos');\n            $ruta->post('pruebas-exportar', 'Pruebas\\PruebaController@exportarExcel');\n            $ruta->get('pruebas-conteo/{tipo_prueba_id}', 'Pruebas\\PruebaController@contarPruebasPorTipo');\n            $ruta->put('pruebas-archivar', 'Pruebas\\PruebaController@archivar');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.carga-masiva'], function ($ruta) {\n            // Carga masiva de pruebas\n            $ruta->get('carga-masiva', 'Pruebas\\PruebaController@cargaMasiva');\n            $ruta->post('carga-masiva-exportar', 'Pruebas\\PruebaController@exportarExcelCargaMasiva');\n            $ruta->post('carga-masiva-importar', 'Pruebas\\PruebaController@importarExcelCargaMasiva');\n            $ruta->post('pruebas-completas-exportar', 'Pruebas\\PruebaController@descargarPruebasCompletas');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.baremos'], function ($ruta) {\n            // Baremos\n            $ruta->get('baremos/lista', 'Pruebas\\BaremoController@lista');\n            $ruta->resource('baremos', 'Pruebas\\BaremoController');\n            $ruta->post('baremos-exportar', 'Pruebas\\BaremoController@exportarExcel');\n            $ruta->post('baremos-calcular', 'Pruebas\\BaremoController@calcularBaremos');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.dimensiones'], function ($ruta) {\n            // Dimensiones\n            $ruta->get('dimensiones/lista', 'Pruebas\\DimensionController@lista');\n            $ruta->get('dimensiones-listado', 'Pruebas\\DimensionController@listado');\n            $ruta->resource('dimensiones', 'Pruebas\\DimensionController');\n            $ruta->get('dimensiones-prueba/{id_prueba}', 'Pruebas\\DimensionController@getDimensionesPrueba');\n            $ruta->post('dimensiones-exportar', 'Pruebas\\DimensionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.factores'], function ($ruta) {\n            // Factores\n            $ruta->get('factores/lista', 'Pruebas\\FactorController@lista');\n            $ruta->get('factores-listado', 'Pruebas\\FactorController@listado');\n            $ruta->resource('factores', 'Pruebas\\FactorController');\n            $ruta->post('factores-exportar', 'Pruebas\\FactorController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.reactivos'], function ($ruta) {\n            // Reactivos\n            $ruta->get('reactivos-listado', 'Pruebas\\ReactivoController@listado');\n            $ruta->resource('reactivos', 'Pruebas\\ReactivoController');\n            $ruta->post('reactivos-exportar', 'Pruebas\\ReactivoController@exportarExcel');\n\n            // Opciones\n            $ruta->get('opciones-reactivo/{id_reactivo}', 'Pruebas\\OpcionController@getOpcionesReactivo');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.calificaciones'], function ($ruta) {\n            // Calificaciones\n            $ruta->get('calificaciones/lista', 'Pruebas\\CalificacionController@lista');\n            $ruta->resource('calificaciones', 'Pruebas\\CalificacionController');\n            $ruta->post('calificaciones-exportar', 'Pruebas\\CalificacionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.grupos-opciones'], function ($ruta) {\n            // Grupos de opciones\n            $ruta->get('grupos-opciones/lista', 'Pruebas\\GrupoOpcionController@lista');\n            $ruta->resource('grupos-opciones', 'Pruebas\\GrupoOpcionController');\n            $ruta->post('grupos-opciones-exportar', 'Pruebas\\GrupoOpcionController@exportarExcel');\n        });\n\n        $ruta->group(['middleware' => 'can:pruebas.secciones-textos'], function ($ruta) {\n            // Secciones de texto\n            $ruta->get('secciones-textos/lista', 'Reportes\\SeccionTextoController@lista');\n            $ruta->resource('secciones-textos', 'Reportes\\SeccionTextoController');\n            $ruta->post('secciones-textos-exportar', 'Reportes\\SeccionTextoController@exportarExcel');\n        });\n\n        $ruta->get('resultados-proceso-prueba-usuario', 'Pruebas\\PruebaController@obtenerResultadosProcesoPruebaUsuario');\n    });\n\n    $ruta->group(['middleware' => 'can:adicional-pruebas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:adicional-pruebas.perfiles'], function ($ruta) {\n            // Perfiles\n            $ruta->get('perfiles-listado-tabla', 'Pruebas\\PerfilController@getDatatable');\n            $ruta->post('perfiles-exportar', 'Pruebas\\PerfilController@exportarExcel');\n            $ruta->get('perfiles-agrupados-por-prueba', 'Pruebas\\PerfilController@agrupadosPorPrueba');\n        });\n\n        $ruta->group(['middleware' => 'can:adicional-pruebas.modulos-preguntas'], function ($ruta) {\n            // Módulos de preguntas\n            $ruta->resource('modulos-preguntas', 'Pruebas\\ModuloPreguntaController');\n            $ruta->get('modulos-preguntas-listado-tabla', 'Pruebas\\ModuloPreguntaController@getDatatable');\n            $ruta->get('modulos-preguntas-grupos/{prueba_id}', 'Pruebas\\ModuloPreguntaController@getGruposPorPrueba');\n            $ruta->post('modulos-preguntas-exportar', 'Pruebas\\ModuloPreguntaController@exportarExcel');\n            $ruta->post('ckeditor-upload-image', 'Pruebas\\ModuloPreguntaController@uploadImageCKEditor');\n        });\n\n        $ruta->group(['middleware' => 'can:adicional-pruebas.demograficas'], function ($ruta) {\n            // Demográficas\n            $ruta->resource('demograficas', 'Pruebas\\DemograficaController');\n            $ruta->get('demograficas-listado-tabla', 'Pruebas\\DemograficaController@getDatatable');\n            $ruta->post('demograficas-exportar', 'Pruebas\\DemograficaController@exportarExcel');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:empresas'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:empresas.listado-empresas'], function ($ruta) {\n            // Listado de empresas\n            $ruta->resource('empresas', 'Empresas\\EmpresaController');\n            $ruta->get('empresas-archivadas', 'Empresas\\EmpresaController@index');\n            $ruta->get('empresas-listado', 'Empresas\\EmpresaController@listado');\n            $ruta->get('empresas-listado-tabla', 'Empresas\\EmpresaController@getDatatable');\n            $ruta->get('empresas-listado-sucursales', 'Empresas\\EmpresaController@listadoSucursales');\n            $ruta->get('sucursales/create', 'Empresas\\EmpresaController@create')->name('crear.sucursal');\n            $ruta->get('sucursales/{id}/edit', 'Empresas\\EmpresaController@edit')->name('editar.sucursal');\n            $ruta->get('empresas-historial-cambios/{id}', 'Empresas\\EmpresaController@historialCambios');\n            $ruta->post('empresas-historial-cambios-exportar/{id}', 'Empresas\\EmpresaController@exportarExcelHistorialCambios');\n            $ruta->delete('empresas-eliminar-logo/{id}', 'Empresas\\EmpresaController@eliminarLogo');\n            $ruta->post('generar-enlace-creacion/{empresa_plan_id?}', 'Empresas\\EmpresaEnlaceCreacionController@generar');\n            $ruta->post('empresas-exportar', 'Empresas\\EmpresaController@exportarExcel');\n            $ruta->post('sucursales-exportar', 'Empresas\\EmpresaController@exportarExcelSucursales');\n            $ruta->get('empresas-propietario/{id}', 'Empresas\\EmpresaController@obtenerPropietario');\n            $ruta->get('sucursales', 'Empresas\\EmpresaController@sucursales');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.gestionar-empresas'], function ($ruta) {\n            // Gestionar empresas\n            $ruta->get('empresas-gestionar/{id?}/{submenu_vista?}', 'Empresas\\EmpresaController@gestionar');\n            $ruta->get('empresas-gestionar-datos/{id}', 'Empresas\\EmpresaController@datosGestionar');\n            $ruta->get('empresas-gestionar-sucursal/{id}', 'Empresas\\EmpresaController@gestionarSucursal');\n            $ruta->patch('empresas-contactos/{id}', 'Empresas\\EmpresaController@guardarContactos');\n\n            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.usuarios'], function ($ruta) {\n                // Usuarios\n                $ruta->get('usuarios-clientes', 'Usuarios\\UserController@index');\n                $ruta->get('usuarios-clientes-listado', 'Usuarios\\UserController@usuariosClientesListado');\n            });\n\n            $ruta->group(['middleware' => 'can:empresas.gestionar-empresas.planes'], function ($ruta) {\n                // Planes\n                $ruta->get('planes-clientes', 'Planes\\PlanController@planesClientes');\n                $ruta->get('listado-planes-cliente', 'Planes\\PlanController@listadoPlanesEmpresa');\n            });\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.archivo-empresas'], function ($ruta) {\n            // Archivo de empresas\n            $ruta->patch('empresas-archivos/{id}', 'Empresas\\EmpresaController@guardarArchivos');\n            $ruta->post('empresas-archivar/{id}', 'Empresas\\EmpresaController@archivar');\n            $ruta->get('empresas-detalle-archivado/{id}', 'Empresas\\EmpresaController@detalleArchivado');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.migracion-empresas'], function ($ruta) {\n            // Migración de empresas\n            $ruta->get('empresas-migracion', 'Empresas\\MigracionEmpresaController@index');\n            $ruta->post('empresas-migracion/buscar', 'Empresas\\MigracionEmpresaController@buscarEmpresa');\n            $ruta->post('empresas-migracion/validar-tamano', 'Empresas\\MigracionEmpresaController@validarTamanoEmpresa');\n            $ruta->post('empresas-migracion/iniciar', 'Empresas\\MigracionEmpresaController@iniciarMigracion');\n        });\n\n        $ruta->group(['middleware' => 'can:empresas.portales-empleo'], function ($ruta) {\n            // Portales de empleo\n            $ruta->get('portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n            $ruta->get('empresa-portales-empleos', 'Empresas\\PortalEmpleoController@crearEditar');\n            $ruta->post('portales-empleos', 'Empresas\\PortalEmpleoController@store')->name('portales-empleos.store');\n            $ruta->patch('portales-empleos/{id}', 'Empresas\\PortalEmpleoController@update')->name('portales-empleos.update');\n\n            // Premios destacados\n            $ruta->post('premios-destacados', 'Empresas\\PremioDestacadoController@store')->name('premios-destacados.store');\n            $ruta->delete('premios-destacados/{id}', 'Empresas\\PremioDestacadoController@destroy')->name('premios-destacados.destroy');\n\n            // Motivadores\n            $ruta->post('motivadores', 'Empresas\\MotivadorController@store');\n        });\n\n        $ruta->get('datos-empresa', 'Empresas\\EmpresaController@obtenerDatosEmpresa');\n        $ruta->get('empresa', 'DashboardController@paginaEmpresa');\n        $ruta->get('empresa-cambiar-logo', 'Empresas\\EmpresaController@paginaEmpresaCambiarImagen');\n    });\n\n    $ruta->group(['middleware' => 'can:ajustes-sistema.general.plantillas'], function ($ruta) {\n        $ruta->resource('plantillas-correos', 'Configuraciones\\PlantillaCorreoController')->except(['create', 'store', 'edit', 'destroy']);\n        $ruta->get('listado-plantillas-correos', 'Configuraciones\\PlantillaCorreoController@listado');\n        $ruta->put('plantillas-correos-restablecer/{id}', 'Configuraciones\\PlantillaCorreoController@restablecerPorDefecto');\n        $ruta->get('variables', 'Configuraciones\\VariableController@listado');\n    });\n\n    $ruta->group(['middleware' => 'can:planes-consumo'], function ($ruta) {\n        // Planes\n        $ruta->resource('planes', 'Planes\\PlanController');\n        $ruta->get('planes-listado', 'Planes\\PlanController@listado');\n        $ruta->post('planes-exportar', 'Planes\\PlanController@exportarExcel');\n        $ruta->get('datos-empresas-planes', 'Empresas\\EmpresaPlanController@planesEmpresas');\n        $ruta->post('exportar-datos-empresas-planes', 'Empresas\\EmpresaPlanController@exportarExcelEmpresasPlanesEmpresas');\n        $ruta->get('empresas-planes-listado-tabla/{empresa_id}', 'Empresas\\EmpresaPlanController@datosTabla');\n        $ruta->resource('empresas-planes', 'Empresas\\EmpresaPlanController', ['only' => ['show', 'store', 'update', 'edit']]);\n        $ruta->get('asignar-plan/{empresa_id}', 'Empresas\\EmpresaPlanController@formularioAsignar');\n        $ruta->patch('empresas-planes-actualizar/{id}', 'Empresas\\EmpresaPlanController@actualizarInformacion');\n        $ruta->post('planes-clonar/{id}', 'Planes\\PlanController@clonar');\n        $ruta->get('planes-historial-cambios/{id}', 'Planes\\PlanController@historialCambios');\n        $ruta->get('funcionalidades-planes-historial-cambios/{plan_id}', 'Planes\\FuncionalidadPlanController@historialCambiosPorPlan');\n        $ruta->get('funcionalidades-listado', 'Planes\\FuncionalidadController@listado');\n        $ruta->get('empresas-planes-funcionalidades-listado', 'Empresas\\EmpresaPlanFuncionalidadController@listado');\n        $ruta->post('solicitud-renovacion-plan', 'Empresas\\EmpresaPlanController@solicitudRenovacionPlan');\n        $ruta->post('empresas-planes-descargar-factura/{archivo_id}', 'Empresas\\EmpresaPlanController@descargarFactura');\n\n        // Planes de Créditos - Vista de creación\n        $ruta->resource('planes-creditos', 'Planes\\PlanCreditoController');\n        $ruta->resource('servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n        $ruta->get('servicios-ia/{id}/creditos', 'IA\\ServicioIAController@creditos');\n        $ruta->post('servicios-ia/{id}/activar', 'IA\\ServicioIAController@activar');\n        $ruta->post('servicios-ia/{id}/desactivar', 'IA\\ServicioIAController@desactivar');\n        $ruta->get('empresas/{empresa_id}/creditos', 'Empresas\\EmpresaPlanController@creditosDisponiblesEmpresa');\n        $ruta->get('empresas/{empresa_id}/consumos-creditos', 'Empresas\\EmpresaPlanController@historialConsumosCreditos');\n        $ruta->resource('categorias-servicios-ia', 'IA\\ServicioIAController')->only(['index', 'store', 'update']);\n\n        $ruta->group(['middleware' => 'can:planes-consumo.consumo'], function ($ruta) {\n            // Consumos\n            $ruta->get('consumos', 'Empresas\\EmpresaPlanController@index');\n            $ruta->get('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@formularioFacturar');\n            $ruta->put('facturar-plan/{id}', 'Empresas\\EmpresaPlanController@facturar');\n            $ruta->get('planes-historial-recompras/{empresa_id?}', 'Empresas\\EmpresaPlanController@historialRecompras');\n            $ruta->get('planes-historial-recompras-creditos/{empresa_id}', 'Empresas\\EmpresaPlanController@historialComprasCreditos');\n            $ruta->post('planes-historial-recompras-exportar', 'Empresas\\EmpresaPlanController@exportarExcelHistorialRecompras');\n            $ruta->post('planes-historial-creditos-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelHistorialCreditos');\n            $ruta->post('consumos-creditos-ia-exportar/{empresa_id}', 'Empresas\\EmpresaPlanController@exportarExcelConsumosCreditosIA');\n            $ruta->get('consumos-agendas-empresa-plan', 'Planes\\ConsumoController@consumosAgendasDeEmpresaPlan');\n            $ruta->get('consumos-ofertas-laborales-empresa-plan', 'Planes\\ConsumoController@consumosOfertasLaboralesDeEmpresaPlan');\n            $ruta->get('consumos-usuarios-empresa', 'Planes\\ConsumoController@consumosUsuariosEmpresa');\n            $ruta->post('consumos-plan-prueba-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanPrueba');\n            $ruta->post('consumos-plan-oferta-laboral-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanOfertaLaboral');\n            $ruta->post('consumos-plan-usuarios-exportar', 'Planes\\ConsumoController@exportarExcelConsumosPlanUsuarios');\n        });\n\n        $ruta->group(['middleware' => 'can:planes-consumo.archivo-planes'], function ($ruta) {\n            // Archivo\n            $ruta->get('planes-archivados', 'Planes\\PlanController@index');\n            $ruta->post('planes-archivar/{id}', 'Planes\\PlanController@archivar');\n        });\n    });\n\n    // Perfiles laborales\n    $ruta->post('perfiles-laborales', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@store');\n    $ruta->post('perfiles-laborales-leer-hv-ia', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@obtenerInformacionHVConIA');\n    $ruta->get('perfiles-laborales-consultar-usuario/{usuario_id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@consultarPerfilLaboralUsuario');\n    $ruta->put('perfiles-laborales/{id}', 'Usuarios\\PerfilesLaborales\\PerfilLaboralController@update');\n\n    // Preguntas de ofertas laborales\n    $ruta->get('preguntas-ofertas-laborales', 'OfertasLaborales\\PreguntaOfertaLaboralController@index');\n    $ruta->get('bienvenida-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasPrefiltro');\n    $ruta->get('responder-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasPrefiltro');\n    $ruta->get('finalizacion-preguntas-prefiltro', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasPrefiltro');\n    $ruta->post('respuestas-preguntas-ofertas-laborales', 'OfertasLaborales\\RespuestaPreguntaOfertaLaboralController@store');\n    $ruta->get('verificar-etapa-completada/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@verificarEtapaCompletada');\n\n    // Preguntas de videoentrevista\n    $ruta->get('bienvenida-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@bienvenidaPreguntasVideoentrevista');\n    $ruta->get('responder-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@responderPreguntasvideoentrevista');\n    $ruta->get('previsualizacion-prueba-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@previsualizacionPruebaVideoentrevista');\n    $ruta->get('finalizacion-preguntas-videoentrevista', 'OfertasLaborales\\PreguntaOfertaLaboralController@finalizacionPreguntasVideoentrevista');\n\n    // Vacantes\n    $ruta->post('generar-adecuacion-hv/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionHV');\n    $ruta->post('generar-adecuacion-prefiltro/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPrefiltro');\n    $ruta->post('generar-adecuacion-pruebas-psicometricas/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionPruebasPsicometricas');\n    $ruta->post('generar-adecuacion-videoentrevista/{etapa_vacante_usuario_id}', 'Vacantes\\EtapaVacanteUsuarioController@generarAdecuacionVideoentrevista');\n    $ruta->post('guardar-puntaje-adecuacion-reclutador', 'Vacantes\\EtapaVacanteUsuarioController@guardarPuntajeAdecuacionReclutador');\n    $ruta->post('guardar-puntaje-pregunta-reclutador', 'OfertasLaborales\\PuntajePreguntaOfertaLaboralController@guardarPuntajeReclutador');\n    $ruta->resource('etapas-usuarios-comentarios', 'Vacantes\\EtapaUsuarioComentarioController')->only(['index', 'store']);\n    $ruta->get('obtener-adecuacion-usuario', 'Vacantes\\EtapaVacanteUsuarioController@obtenerAdecuacionUsuario');\n    $ruta->get('obtener-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCandidatosRecomendadosIA');\n    $ruta->post('preguntar-candidatos-recomendados', 'Vacantes\\EtapaVacanteUsuarioController@preguntarSobreCandidatosRecomendados');\n    $ruta->post('vacantes-descargar-reporte-respuesta-ia', 'Vacantes\\VacanteController@descargarReporteRespuestaIA');\n    $ruta->post('vacantes-clonar-aplicante', 'Vacantes\\VacanteController@clonarAplicante');\n\n    $ruta->resource('formatos-entrevistas', 'Vacantes\\FormatoEntrevistaController')->except(['destroy']);\n\n    $ruta->patch('roles/actualizar-permisos/{rol}', 'Auth\\RolController@actualizarPermisos');\n    $ruta->patch('roles/restablecer-permisos/{rol}', 'Auth\\RolController@restablecerPermisos');\n\n    $ruta->group(['middleware' => 'can:ajustes-sistema'], function ($ruta) {\n        $ruta->group(['middleware' => 'can:ajustes-sistema.general'], function ($ruta) {\n            // Ajustes - General\n            $ruta->get('ajustes', 'Configuraciones\\ConfiguracionController@paginaAjustesGenerales');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.roles-permisos'], function ($ruta) {\n            // Ajustes - Roles y permisos\n            $ruta->get('roles', 'Auth\\RolController@index');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.deshacer-acciones'], function ($ruta) {\n            // Ajustes - Deshacer acciones\n            $ruta->post('agendas-restablecer/{id}', 'Agendas\\AgendaController@restablecerAgenda');\n            $ruta->post('agendas-validar-exportacion', 'Configuraciones\\ConfiguracionController@validarAgendaExportacion');\n            $ruta->post('agendas-exportar-respuestas', 'Configuraciones\\ConfiguracionController@exportarRespuestasAgenda');\n            $ruta->get('deshacer-acciones', 'Configuraciones\\ConfiguracionController@deshacerAcciones');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.anuncios-novedades'], function ($ruta) {\n            // Ajustes - Ofertas y anuncios\n            $ruta->resource('anuncios', 'Configuraciones\\AnuncioController');\n            $ruta->get('anuncios-listado-tabla', 'Configuraciones\\AnuncioController@datosTabla');\n            $ruta->get('anuncios-disponibilidad-fechas', 'Configuraciones\\AnuncioController@validarDisponibilidadFechas');\n            $ruta->delete('anuncios-eliminar-varios', 'Configuraciones\\AnuncioController@eliminarVarios');\n            $ruta->put('anuncios-cambiar-estado/{id}', 'Configuraciones\\AnuncioController@cambiarEstado');\n        });\n\n        $ruta->group(['middleware' => 'can:ajustes-sistema.psicoacademy'], function ($ruta) {\n            // Webinars\n            $ruta->resource('webinars', 'PsicoAcademy\\WebinarController')->except(['show']);\n            $ruta->get('webinars-listado-tabla', 'PsicoAcademy\\WebinarController@datosTabla');\n            $ruta->get('webinars-borrador/{tipo}', 'PsicoAcademy\\WebinarController@borrador');\n            $ruta->post('webinars-borrador', 'PsicoAcademy\\WebinarController@guardarBorrador');\n            $ruta->put('webinars-modificar-masivo/{tipo}', 'PsicoAcademy\\WebinarController@modificarMasivo');\n            $ruta->get('webinars-filtros', 'PsicoAcademy\\WebinarController@filtrosAplicados');\n\n            // Eventos\n            $ruta->resource('eventos', 'PsicoAcademy\\EventoController');\n            $ruta->get('eventos-listado-tabla', 'PsicoAcademy\\EventoController@datosTabla');\n            $ruta->get('eventos-borrador/{tipo}', 'PsicoAcademy\\EventoController@borrador');\n            $ruta->post('eventos-borrador', 'PsicoAcademy\\EventoController@guardarBorrador');\n            $ruta->get('eventos-filtros', 'PsicoAcademy\\EventoController@filtrosAplicados');\n            $ruta->get('eventos-listado', 'PsicoAcademy\\EventoController@listado');\n\n            // Guías\n            $ruta->resource('guias', 'PsicoAcademy\\GuiaController');\n            $ruta->get('guias-listado-tabla', 'PsicoAcademy\\GuiaController@datosTabla');\n            $ruta->get('guias-borrador/{tipo}', 'PsicoAcademy\\GuiaController@borrador');\n            $ruta->post('guias-borrador', 'PsicoAcademy\\GuiaController@guardarBorrador');\n            $ruta->delete('guias-borrar-archivo/{id}', 'PsicoAcademy\\GuiaController@borrarArchivo');\n            $ruta->get('guias-filtros', 'PsicoAcademy\\GuiaController@filtrosAplicados');\n\n            // Tutoriales\n            $ruta->resource('tutoriales', 'PsicoAcademy\\TutorialController');\n            $ruta->get('tutoriales-listado-tabla', 'PsicoAcademy\\TutorialController@datosTabla');\n            $ruta->get('tutoriales-borrador/{tipo}', 'PsicoAcademy\\TutorialController@borrador');\n            $ruta->post('tutoriales-borrador', 'PsicoAcademy\\TutorialController@guardarBorrador');\n            $ruta->get('tutoriales-filtros', 'PsicoAcademy\\TutorialController@filtrosAplicados');\n\n            // Podcast\n            $ruta->resource('podcast', 'PsicoAcademy\\PodcastController');\n            $ruta->get('podcast-listado-tabla', 'PsicoAcademy\\PodcastController@datosTabla');\n            $ruta->get('podcast-borrador/{tipo}', 'PsicoAcademy\\PodcastController@borrador');\n            $ruta->post('podcast-borrador', 'PsicoAcademy\\PodcastController@guardarBorrador');\n            $ruta->get('podcast-filtros', 'PsicoAcademy\\PodcastController@filtrosAplicados');\n\n            // Capacitación\n            $ruta->resource('capacitaciones', 'PsicoAcademy\\CapacitacionController');\n            $ruta->get('capacitaciones-listado-tabla', 'PsicoAcademy\\CapacitacionController@datosTabla');\n            $ruta->get('capacitaciones-borrador/{tipo}', 'PsicoAcademy\\CapacitacionController@borrador');\n            $ruta->post('capacitaciones-borrador', 'PsicoAcademy\\CapacitacionController@guardarBorrador');\n            $ruta->get('capacitaciones-filtros', 'PsicoAcademy\\CapacitacionController@filtrosAplicados');\n\n            // Certificación\n            $ruta->resource('certificaciones', 'PsicoAcademy\\CertificacionController');\n            $ruta->get('certificaciones-listado-tabla', 'PsicoAcademy\\CertificacionController@datosTabla');\n            $ruta->put('certificaciones-modificar-masivo/{tipo}', 'PsicoAcademy\\CertificacionController@modificarMasivo');\n            $ruta->get('certificaciones-borrador/{tipo}', 'PsicoAcademy\\CertificacionController@borrador');\n            $ruta->post('certificaciones-borrador', 'PsicoAcademy\\CertificacionController@guardarBorrador');\n            $ruta->get('certificaciones-filtros', 'PsicoAcademy\\CertificacionController@filtrosAplicados');\n        });\n    });\n\n    $ruta->group(['middleware' => 'can:soporte'], function ($ruta) {\n        // Soportes\n        $ruta->resource('soportes', 'Soportes\\SoporteController');\n        $ruta->post('soportes/subida-imagenes', 'Soportes\\SoporteController@subidaImagenes');\n        $ruta->get('soportes-listado-tabla', 'Soportes\\SoporteController@datosTabla');\n        $ruta->patch('soportes-actualizar/{id}', 'Soportes\\SoporteController@actualizarInformacion');\n        $ruta->get('soportes-contiguo/{id}', 'Soportes\\SoporteController@soporteContiguo');\n        $ruta->post('soportes-exportar', 'Soportes\\SoporteController@exportarExcel');\n        $ruta->resource('mensajes-soportes', 'Soportes\\MensajeSoporteController', ['only' => ['store', 'update', 'destroy']]);\n        $ruta->patch('mensajes-soportes-leidos/{id}', 'Soportes\\MensajeSoporteController@marcarMensajesLeidos');\n        $ruta->get('mensajes-soportes-listado-tabla', 'Soportes\\MensajeSoporteController@datosTabla');\n        $ruta->put('soportes-cambiar-estado', 'Soportes\\SoporteController@cambiarEstado');\n\n        // Manuales\n        $ruta->resource('manuales', 'Tutoriales\\ManualController');\n        $ruta->get('manuales-listado-tabla', 'Tutoriales\\ManualController@datosTabla');\n\n        $ruta->group(['middleware' => 'can:soporte.soporte-aplicantes'], function ($ruta) {\n            // Aplicantes\n            $ruta->get('soportes-aplicantes', 'Soportes\\SoporteController@index')->name('soportes.aplicantes');\n        });\n\n        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes'], function ($ruta) {\n            // Preguntas frecuentes\n            $ruta->resource('preguntas-frecuentes', 'Soportes\\PreguntaFrecuenteController');\n            $ruta->patch('preguntas-frecuentes-actualizar/{id}', 'Soportes\\PreguntaFrecuenteController@actualizarInformacion');\n            $ruta->patch('preguntas-frecuentes-ordenar/{id}/{orden}', 'Soportes\\PreguntaFrecuenteController@cambiarOrden');\n            $ruta->get('preguntas-frecuentes-listado-tabla', 'Soportes\\PreguntaFrecuenteController@listado');\n            $ruta->patch('preguntas-frecuentes-visualizaciones/{id}', 'Soportes\\PreguntaFrecuenteController@incrementarVisualizaciones');\n        });\n\n        $ruta->group(['middleware' => 'can:soporte.preguntas-frecuentes.reaccionar'], function ($ruta) {\n            // Preguntas frecuentes reacciónes\n            $ruta->post('preguntas-frecuentes-reacciones', 'Soportes\\PreguntaFrecuenteReaccionController@guardarReaccion');\n        });\n    });\n\n    // Esta ruta debe ser asequible para los usuarios de todos los roles.\n    $ruta->post('configuraciones-modelos', 'Configuraciones\\ConfiguracionModeloController@store');\n    $ruta->get('configuraciones-obtener', 'Configuraciones\\ConfiguracionModeloController@obtenerConfiguracion');\n\n    $ruta->group(['middleware' => 'auth.rol-tipo-superadmin'], function ($ruta) {\n        // Módulos\n        $ruta->get('modulos/{id}', 'Planes\\ModuloController@show');\n        $ruta->get('modulos-listado', 'Planes\\ModuloController@listado');\n\n        // Auditorías\n        $ruta->get('auditorias-ultimo', 'Auditorias\\AuditController@obtenerUltimo');\n\n        // Accesos\n        $ruta->get('accesos-datos-mapa', 'Accesos\\AccesoController@datosMapa');\n\n        // Registros de actividad\n        $ruta->get('actividades-datos-mapa', 'Configuraciones\\ActividadController@datosMapa');\n\n        // Novedades\n        $ruta->resource('novedades', 'Configuraciones\\NovedadController')->except(['index', 'show', 'create', 'store', 'destroy']);\n        $ruta->post('novedades-restablecer/{id}', 'Configuraciones\\NovedadController@restablecer');\n        $ruta->post('novedades-pdf/{id}', 'Configuraciones\\NovedadController@descargarPDF');\n\n        // Países\n        $ruta->resource('paises', 'Configuraciones\\PaisController')->except(['show', 'destroy']);\n        $ruta->resource('departamentos', 'Configuraciones\\DepartamentoController')->except(['show', 'destroy']);\n        $ruta->get('departamentos-listado-tabla', 'Configuraciones\\DepartamentoController@datosTabla');\n        $ruta->resource('ciudades', 'Configuraciones\\CiudadController')->except(['show', 'destroy']);\n        $ruta->get('ciudades-listado-tabla', 'Configuraciones\\CiudadController@datosTabla');\n\n        // Reportes\n        $ruta->resource('reportes', 'Reportes\\ReporteController');\n        $ruta->resource('reportes-secciones', 'Reportes\\ReporteSeccionController')->only(['index']);\n        $ruta->resource('reportes-secciones-textos', 'Reportes\\ReporteSeccionTextoController')->only(['index']);\n\n        // Minería de datos.\n        $ruta->get('sesiones-listado', 'Auth\\SesionController@datosTabla');\n        $ruta->get('mineria-datos', 'DashboardController@indexAnaliticaMineriaDatos');\n\n        // Pruebas completas\n        $ruta->post('pruebas-completas-crear', 'Pruebas\\PruebaController@crearPruebaCompleta');\n        $ruta->get('pruebas-completas/{id}', 'Pruebas\\PruebaController@pruebaCompleta');\n        $ruta->get('pruebas-completas', 'Pruebas\\PruebaController@vistaPruebaCompleta');\n        $ruta->get('pruebas-completas-pagina-crear', 'Pruebas\\PruebaController@crearPrueba');\n        $ruta->get('pruebas-completas/{id}/editar', 'Pruebas\\PruebaController@editarPrueba');\n    });\n\n    $ruta->group(['middleware' => 'auth.rol-tipo-empresa'], function ($ruta) {\n        // Ordenes de servicio\n        // $ruta->resource('ordenes-servicio', 'OrdenesServicios\\OrdenServicioController'); // Se deja comentada temporalmente hasta que se retome ATS\n        $ruta->get('ordenes-servicio-generar-enlace-publico', 'OrdenesServicios\\OrdenServicioEnlaceCreacionController@generar');\n        $ruta->get('ordenes-servicio-listado-tabla', 'OrdenesServicios\\OrdenServicioController@datosTabla');\n\n        // Ofertas laborales\n        $ruta->get('ofertas-laborales/sin-disponibilidad', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles');\n        $ruta->get('ofertas-laborales/sin-plan-seleccion', 'OfertasLaborales\\OfertaLaboralController@sinPlanSeleccion');\n        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->only(['create', 'store'])->middleware('disponibilidad-ofertas-laborales');\n        $ruta->resource('ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController')->except(['create', 'store']);\n        $ruta->post('exportar-excel-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@exportarExcelOfertasLaborales');\n        $ruta->get('ofertas-laborales-listado-tabla', 'OfertasLaborales\\OfertaLaboralController@datosTabla');\n        $ruta->get('ofertas-laborales-detalles/{id}', 'OfertasLaborales\\OfertaLaboralController@detalles');\n        $ruta->get('sin-disponibilidad-ofertas-laborales', 'OfertasLaborales\\OfertaLaboralController@sinOfertasLaboralesDisponibles')\n        ->name('sin-disponibilidad-ofertas-laborales');\n        $ruta->put('ofertas-laborales-cambiar-tipo-publicacion', 'OfertasLaborales\\OfertaLaboralController@cambiarTipoPublicacion');\n        $ruta->post('ofertas-laborales-compartir', 'OfertasLaborales\\OfertaLaboralController@compartirPorCorreo');\n        $ruta->get('ofertas-laborales-generar-qr/{id}', 'OfertasLaborales\\OfertaLaboralController@generarQR');\n        $ruta->get('ofertas-laborales/{id}/aplicantes', 'OfertasLaborales\\OfertaLaboralController@aplicantes');\n        $ruta->get('ofertas-laborales/{id}/aplicantes/{aplicante_id}', 'OfertasLaborales\\OfertaLaboralController@detallesAplicante');\n        $ruta->post('ofertas-laborales/generar-informacion-ia', 'OfertasLaborales\\OfertaLaboralController@generarInformacionIA');\n        $ruta->post('ofertas-laborales/generar-pruebas-ia', 'OfertasLaborales\\OfertaLaboralController@generarPruebasConIA');\n\n        // Vacantes\n        $ruta->resource('vacantes', 'Vacantes\\VacanteController')->except(['show', 'edit', 'update']);\n        $ruta->get('vacantes-listado-tabla', 'Vacantes\\VacanteController@datosTabla');\n\n        $ruta->group(['middleware' => 'validar-acceso-vacante'], function ($ruta) {\n            $ruta->get('vacantes-detalle/{id}', 'Vacantes\\VacanteController@paginaDetalle');\n            $ruta->resource('vacantes', 'Vacantes\\VacanteController')->only(['show', 'edit', 'update']);\n            $ruta->post('vacantes-completar/{id}', 'Vacantes\\VacanteController@completar');\n            $ruta->put('vacantes-cambiar-estado', 'Vacantes\\VacanteController@cambiarEstado');\n            $ruta->put('vacantes-archivar', 'Vacantes\\VacanteController@archivarVacante');\n            $ruta->get('etapas-vacantes-aplicantes/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerEtapasAplicantes');\n            $ruta->get('vacantes-detalle-aplicante/{vacante_id}/{usuario_id}', 'Vacantes\\VacanteController@obtenerDetalleAplicante');\n            $ruta->get('vacantes-listado-aplicantes/{vacante_id}', 'Vacantes\\VacanteController@obtenerListadoAplicantes');\n            $ruta->get('vacantes-calcular-dias-duracion-proceso/{vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDiasDuracionProceso');\n        });\n\n        $ruta->get('configuraciones-etapa-movimiento/{id}', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@index');\n        $ruta->post('etapas-movimientos-vacantes-configuraciones', 'Vacantes\\EtapaMovimientoVacanteConfiguracionController@store');\n        $ruta->get('etapas-vacantes', 'Vacantes\\EtapaVacanteController@index');\n        $ruta->put('etapas-vacantes/{id}', 'Vacantes\\EtapaVacanteController@update');\n        $ruta->get('vacantes-habilidades-herramientas', 'Vacantes\\VacanteController@obtenerHabilidadesHerramientas');\n        $ruta->put('etapas-vacantes-cambiar-orden', 'Vacantes\\EtapaVacanteController@cambiarOrden');\n        $ruta->post('vacantes-postular-aplicantes', 'Vacantes\\VacanteController@postularAplicantes');\n        $ruta->resource('documentos-solicitables', 'Vacantes\\DocumentoSolicitableController');\n        $ruta->post('vacantes-preguntas', 'Vacantes\\VacanteController@guardarPreguntas');\n        $ruta->post('etapas-vacantes-adjuntar-archivos', 'Vacantes\\EtapaVacanteController@adjuntarArchivosPruebaTecnica');\n        $ruta->delete('etapas-vacantes/{etapa_vacante_id}/eliminar-etapa-prueba-tecnica', 'Vacantes\\EtapaVacanteController@eliminarEtapaPruebaTecnica');\n        $ruta->get('etapas-vacantes/{etapa_vacante_id}/obtener-configuraciones-prueba-tecnica', 'Vacantes\\EtapaVacanteController@obtenerConfiguracionesPruebaTecnica');\n        $ruta->post('generar-vacante', 'Vacantes\\VacanteController@generarConIA');\n        $ruta->post('generar-preguntas-prefiltro', 'Vacantes\\VacanteController@generarPreguntasPrefiltro');\n        $ruta->post('generar-preguntas-videoentrevista', 'Vacantes\\VacanteController@generarPreguntasVideoentrevista');\n        $ruta->post('generar-pruebas-psicometricas', 'Vacantes\\VacanteController@generarPruebasPsicometricas');\n        $ruta->post('vacantes-duplicar', 'Vacantes\\VacanteController@duplicar');\n        $ruta->post('vacantes-descartar-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@descartarAplicantesManual');\n        $ruta->post('vacantes-mover-etapa-aplicante/{id}', 'Vacantes\\EtapaVacanteUsuarioController@moverAplicanteEtapaManual');\n        $ruta->get('vacantes-competencias-mejorar/{id}', 'Vacantes\\EtapaVacanteUsuarioController@obtenerCompetenciasPorMejorar');\n        $ruta->post('vacantes-revertir-descarte-aplicantes', 'Vacantes\\EtapaVacanteUsuarioController@revertirDescarteAplicantes');\n        $ruta->post('vacantes-comparativo-basico-aplicantes', 'Vacantes\\VacanteController@generarReporteComparativoVacantes');\n\n        // TODO: Estos dos endpoints no están completos, el primero funciona pero no es lo que se necesita, hay que hacer que el segundo funcione como el primero\n        $ruta->get('resultados-coincidencia-oferta-laboral/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\MovimientoController@resultadosCoincidenciaUsuario');\n        $ruta->get('resultados-coincidencia-oferta-laboral-test/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\CategoriaAdecuacionController@resultadosCoincidenciaUsuario');\n\n        // TODO: Falta definir la ruta. No se sabe si existirá una ruta genérica que cambie a un aplicante de una etapa a otra dentro de una oferta laboral o\n        // si habrán varios end-points para cada una de las etapas que existirán dentro del proceso de contratación en una oferta laboral...\n        $ruta->post('ofertas-laborales-cambiar-usuario-etapa', 'OfertasLaborales\\OfertaLaboralController@cambiarUsuarioEtapa');\n\n        // Etapas\n        $ruta->resource('etapas', 'OfertasLaborales\\EtapaController')->only(['show', 'store', 'update', 'destroy']);\n        $ruta->get('etapas-listado', 'OfertasLaborales\\EtapaController@listado');\n        $ruta->post('movimientos-configuraciones', 'OfertasLaborales\\EtapaMovimientoConfiguracionController@store');\n        $ruta->put('descartar-candidatos-etapa', 'OfertasLaborales\\EtapaController@descartarCandidatosEtapa');\n        $ruta->get('etapas-verificar-nombre-repetido/{oferta_laboral_id}/{nombre}', 'OfertasLaborales\\EtapaController@validarNombreRepetido');\n        $ruta->post('etapas-mover/{id}/{orden}', 'OfertasLaborales\\EtapaController@cambiarOrden');\n\n        // Movimientos\n        $ruta->get('movimientos-listado', 'OfertasLaborales\\MovimientoController@listado');\n        $ruta->get('movimientos-configuraciones-listado', 'OfertasLaborales\\MovimientoConfiguracionController@listado');\n        $ruta->get('movimientos-configuraciones/{id}', 'OfertasLaborales\\MovimientoConfiguracionController@show');\n        $ruta->post('movimientos-configuraciones-preguntas', 'OfertasLaborales\\MovimientoConfiguracionController@guardarPreguntasVideoEntrevista');\n\n        // Novedades\n        $ruta->get('novedades', 'Configuraciones\\NovedadController@index');\n\n        $ruta->get('feedback', 'DashboardController@enConstruccion');\n        $ruta->get('planes-accion', 'DashboardController@enConstruccion');\n\n        // Procesos\n        $ruta->resource('procesos', 'Procesos\\ProcesoController');\n        $ruta->get('procesos-listado', 'Procesos\\ProcesoController@listado');\n        $ruta->get('procesos-listado-tabla', 'Procesos\\ProcesoController@datosTabla');\n        $ruta->patch('procesos-actualizar/{id}', 'Procesos\\ProcesoController@actualizarInformacion');\n        $ruta->post('procesos-duplicar/{id}', 'Procesos\\ProcesoController@duplicar');\n        $ruta->post('procesos-suspender/{id}', 'Procesos\\ProcesoController@suspender');\n        $ruta->post('procesos-activar/{id}', 'Procesos\\ProcesoController@activar');\n        $ruta->put('procesos-archivar', 'Procesos\\ProcesoController@archivarProceso');\n        $ruta->post('procesos-exportar', 'Procesos\\ProcesoController@exportarExcel');\n        $ruta->post('procesos-compartir/{id}', 'Procesos\\ProcesoController@compartir');\n        $ruta->post('procesos-compartir-resultados-aplicante', 'Procesos\\ProcesoController@compartirResultadosAplicante');\n        $ruta->get('participantes-proceso/{id}', 'Usuarios\\UserController@participantesProceso');\n        $ruta->post('procesos-exportar-participantes', 'Usuarios\\UserController@exportarParticipantesProcesoExcel');\n        $ruta->post('participantes-descartar', 'Procesos\\ProcesoController@descartarParticipantes');\n        $ruta->post('participante-seleccionar', 'Procesos\\ProcesoController@seleccionarParticipante');\n        $ruta->post('participantes-cambiar-proceso', 'Procesos\\ProcesoController@moverDeProceso');\n        $ruta->delete('participantes-eliminar/{proceso_id}/{usuario_id}', 'Procesos\\ProcesoController@eliminarParticipante');\n        $ruta->post('procesos-participantes/{id}', 'Procesos\\ProcesoController@agregarParticipantes');\n        $ruta->post('participantes-reagendar', 'Procesos\\ProcesoController@reagendarParticipantes');\n        $ruta->get('participante/{id}', 'Usuarios\\UserController@obtenerParticipanteProceso');\n        $ruta->get('procesos-detalles-participante', 'Usuarios\\UserController@detallesParticipanteProceso');\n        $ruta->post('agendas-participante', 'Agendas\\AgendaController@agendasParticipante');\n        $ruta->delete('agendas/{id}', 'Agendas\\AgendaController@destroy');\n        $ruta->post('agendas-reprocesar/{id}', 'Agendas\\AgendaController@reprocesarAgenda');\n        $ruta->post('procesos-reporte-resultados-excel', 'Procesos\\ProcesoController@exportarReporteResultadosExcel');\n        $ruta->get('procesos-indice-talento/{proceso_id}/{aplicante_id}', 'Procesos\\ProcesoController@obtenerIndiceTalento');\n        $ruta->get('agendas-copiar-resultados', 'Agendas\\AgendaController@copiarAgenda');\n        $ruta->post('procesos-mejores-candidatos', 'Procesos\\ProcesoController@mejoresCandidatosIA');\n        $ruta->post('procesos-validar-agendas-expiradas/{id}', 'Procesos\\ProcesoController@validarAgendasExpiradas');\n        $ruta->get('plantilla-correo', 'Configuraciones\\PlantillaCorreoController@obtenerPlantilla');\n        $ruta->get('procesos-descargar-guia-agendamiento-masivo', 'Procesos\\ProcesoController@descargarGuiaAgendamientoMasivo');\n        $ruta->post('procesos-extraer-datos-participantes', 'Procesos\\ProcesoController@extraerDatosParticipantes');\n\n        // Firmas de rutas\n        $ruta->get('firmas-rutas-por-proceso/{proceso_id}', 'Accesos\\FirmaRutaController@porProceso');\n\n        // Perfiles pruebas\n        $ruta->get('perfiles-pruebas', 'Pruebas\\PerfilController@perfilesPruebas');\n\n        // Agendas\n        $ruta->get('pruebas-empresas/{id}', 'Pruebas\\PruebaController@obtenerPruebasEmpresa');\n        $ruta->get('candidatos', 'Agendas\\AgendaController@historialAgendamientos');\n        $ruta->get('listado-historial-agendamientos', 'Agendas\\AgendaController@listadoHistorialAgendamientos');\n        $ruta->post('exportar-excel-historial-agendamientos', 'Agendas\\AgendaController@exportarExcelHistorialAgendamientos');\n\n        // Comentarios\n        $ruta->resource('comentarios', 'OfertasLaborales\\ComentarioController')->only(['store']);\n\n        // Usuarios\n        $ruta->post('generar-acceso-usuario/{usuario_id}', 'Usuarios\\TokenAccesoController@generarAcceso');\n    });\n\n    $ruta->group(['middleware' => 'auth.es-superadmin'], function ($ruta) {\n        $ruta->get('empresa-sucursales', 'Empresas\\EmpresaController@empresaSucursales');\n\n        // Debug de calificaciones de agendas\n        $ruta->get('debug/calificacion/{agenda_id}', 'Debug\\DebugCalificacionController@mostrar')->name('debug.calificacion.mostrar');\n        $ruta->get('debug/calificacion/{agenda_id}/calcular', 'Debug\\DebugCalificacionController@obtenerCalificacion')->name('debug.calificacion.calcular');\n        $ruta->post('debug/calificacion/{agenda_id}/simular', 'Debug\\DebugCalificacionController@simularCalificacion')->name('debug.calificacion.simular');\n        $ruta->post('debug/calificacion/{agenda_id}/actualizar', 'Debug\\DebugCalificacionController@actualizarRespuestas')->name('debug.calificacion.actualizar');\n    });\n\n    // Suplantación de rol Administrador general\n    $ruta->group(['middleware' => 'auth.suplantar-admin-general'], function ($ruta) {\n        $ruta->post('suplantar-rol-admin-general', 'Auth\\RolController@suplantarRolAdministradorGeneral')->name('suplantar-rol-admin-general');\n    });\n\n    // Suplantación de rol Administrador sucursal\n    $ruta->group(['middleware' => 'auth.suplantar-admin-sucursal'], function ($ruta) {\n        $ruta->post('suplantar-rol-admin-sucursal', 'Auth\\RolController@suplantarRolAdministradorSucursal')->name('suplantar-rol-admin-sucursal');\n    });\n\n    // Restablecimiento de la sesión original que había antes de la suplantación\n    $ruta->group(['middleware' => 'auth.rol-suplantado'], function ($ruta) {\n        $ruta->post('restablecer-sesion-original', 'Auth\\RolController@restablecerSesionOriginal')->name('restablecer-sesion-original');\n    });\n\n    // Ruta para completar los datos de un usuario aplicante\n    $ruta->group(['middleware' => 'auth.rol-tipo-evaluado'], function ($ruta) {\n        $ruta->put('completar-datos-usuario/datos-generales/{id}', 'Usuarios\\UserController@completarDatosGenerales');\n        $ruta->put('completar-datos-usuario/datos-acceso/{id}', 'Usuarios\\UserController@completarDatosAcceso');\n        $ruta->get('completar-datos-usuario/{id}', 'Usuarios\\UserController@paginaCompletarDatos')->name('usuarios.completar-datos');\n        $ruta->get('recomendaciones', 'Usuarios\\UserController@vistaRecomendaciones');\n    });\n\n    // Rutas de usuario aplicante que requieren que este haya completados sus datos\n    $ruta->group(['middleware' => ['validar-datos-completados-usuario', 'auth.rol-tipo-evaluado']], function ($ruta) {\n        $ruta->get('ofertas-laborales-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantes')->name('ofertas-laborales-aplicantes');\n        $ruta->get('ofertas-guardadas-aplicantes', 'OfertasLaborales\\OfertaLaboralController@paginaAplicantesGuardados');\n        $ruta->post('ofertas-laborales-postular-aplicante/{oferta_laboral_id}/{perfil_laboral_id?}', 'OfertasLaborales\\OfertaLaboralController@postularAplicante');\n        $ruta->post('ofertas-laborales-abandonar-postulacion-aplicante/{oferta_laboral_id}', 'OfertasLaborales\\OfertaLaboralController@abandonarPostulacionAplicante');\n        $ruta->get('ofertas-laborales-postular-aplicante-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@postularAplicanteSinAutenticar');\n        $ruta->post('ofertas-laborales-guardar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardar');\n        $ruta->get('ofertas-laborales-guardar-sin-autenticar/{id}', 'OfertasLaborales\\OfertaLaboralController@guardarSinAutenticar');\n        $ruta->post('ofertas-laborales-quitar-guardado/{id}', 'OfertasLaborales\\OfertaLaboralController@quitarGuardado');\n        $ruta->get('soportes-aplicante', 'DashboardController@enConstruccion');\n        $ruta->get('preguntas-frecuentes-aplicante', 'DashboardController@enConstruccion');\n        $ruta->get('completar-demograficas/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@formularioDemograficas');\n        $ruta->get('demograficas-ajax/{agenda_id}/{prueba_id}', 'Pruebas\\DemograficaController@obtenerDemograficasAjax');\n        $ruta->post('agendas-demograficas-opciones', 'Agendas\\AgendaController@guardarRespuestasDemograficas');\n        $ruta->get('realizar-prueba/{agenda_id}', 'Agendas\\AgendaController@paginaRealizarPrueba')->name('prueba.realizar');\n        $ruta->get('agendas-reactivos/{agenda_id}', 'Agendas\\AgendaReactivoController@listado');\n        $ruta->put('descontar-tiempo-agenda', 'Agendas\\AgendaTiempoController@descontarTiempo');\n        $ruta->post('agendas-reactivos-respuestas', 'Agendas\\AgendaReactivoController@guardarRespuestasReactivos');\n        $ruta->get('agendas-reactivos-respondidos/{agenda_id}', 'Agendas\\AgendaReactivoController@obtenerReactivosRespondidos');\n        $ruta->post('agendas-procesar-resultados', 'Agendas\\AgendaController@procesarResultados');\n        $ruta->post('agendas-guardar-foto', 'Agendas\\AgendaController@guardarArchivoAgenda');\n        $ruta->get('ofertas-laborales-detalles-aplicante/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesParaAplicante')\n            ->name('ofertas-laborales.detalles-aplicante');\n        $ruta->post('agendas-guardar-archivo', 'Agendas\\AgendaController@guardarArchivoAgenda');\n        $ruta->get('agendas_validar_pendientes/{agenda_id}', 'Agendas\\AgendaController@validarAgendasPendientes');\n\n        $ruta->resource('experiencias-laborales', 'Usuarios\\PerfilesLaborales\\ExperienciaLaboralController')->only(['store', 'update', 'destroy']);\n    });\n\n    // Ofertas laborales\n    $ruta->post('ofertas-laborales-descartar-aplicante/{oferta_laboral_id}/{usuario_id}', 'OfertasLaborales\\OfertaLaboralController@descartarAplicante');\n\n    // Perfiles - Rutas específicas primero para evitar conflictos con resource\n    $ruta->get('perfiles/prueba/{id}/factores-dimensiones', 'Pruebas\\PerfilController@getFactoresDimensiones');\n    $ruta->post('perfiles/generar-ia', 'Pruebas\\PerfilController@generarConIA');\n    $ruta->get('perfiles/datos-adicionales', 'Pruebas\\PerfilController@getDatosAdicionales');\n    $ruta->post('perfiles/crear-desde-ia', 'Pruebas\\PerfilController@crearDesdeIA');\n    $ruta->resource('perfiles', 'Pruebas\\PerfilController');\n    $ruta->get('factores-pruebas/{prueba_id}', 'Pruebas\\FactorController@obtenerTodoPorPrueba');\n\n    // Usuarios\n    $ruta->post('enviar-codigo-autorizacion', 'Usuarios\\UserController@enviarCodigoAutorizacion');\n    $ruta->post('verificar-codigo-autorizacion', 'Usuarios\\UserController@verificarCodigoAutorizacion');\n\n    // Perfiles\n    $ruta->get('perfiles-listado', 'Pruebas\\PerfilController@listado');\n    $ruta->get('perfiles-listado-empresa', 'Pruebas\\PerfilController@listadoEmpresa');\n    $ruta->post('perfiles-archivar/{id}', 'Pruebas\\PerfilController@archivar');\n    $ruta->post('perfiles-clonar', 'Pruebas\\PerfilController@clonar');\n    $ruta->post('perfiles-pdf/{id}', 'Pruebas\\PerfilController@descargarPDF');\n\n    // Archivos\n    $ruta->get('archivos', 'Configuraciones\\ArchivoController@listado');\n    $ruta->get('archivos-obtener-uno', 'Configuraciones\\ArchivoController@obtenerUno');\n    $ruta->delete('archivos/{id}', 'Configuraciones\\ArchivoController@destroy');\n\n    // Menú clientes\n    $ruta->get('psicoacademy-cliente', 'DashboardController@paginaPsycoAcademyCliente');\n    $ruta->get('uso-experiencia', 'DashboardController@paginaUsoExperiencia');\n    $ruta->get('mis-pruebas', 'DashboardController@paginaMisPruebas')->middleware('validar-datos-completados-usuario');\n\n    $ruta->get('tareas-pendientes-aplicantes', 'DashboardController@paginaMisPruebasAplicante')->name('tareas-pendientes-aplicantes');\n    $ruta->get('tareas-pendientes-aplicantes-data', 'DashboardController@tareasPendientesData');\n    $ruta->get('tareas-completadas-aplicantes', 'DashboardController@paginaMisPruebasAplicanteCompletadas')->name('tareas-completadas-aplicantes');\n    $ruta->get('resultados-evaluacion-aplicantes', 'DashboardController@paginaFeedbackAplicante');\n    $ruta->get('planes-accion-aplicantes', 'DashboardController@paginaPlanesAccionAplicante');\n\n    $ruta->get('vacantes-aplicante', 'Vacantes\\VacanteController@obtenerVacantesAplicante');\n    $ruta->resource('pruebas-tecnicas', 'Vacantes\\PruebaTecnicaController');\n    $ruta->post('vacantes-guardar-documentos-solicitados', 'Vacantes\\EtapaVacanteUsuarioController@guardarDocumentoSolicitado');\n    $ruta->get('vacantes-documentos-solicitados/{etapa_vacante_id}', 'Vacantes\\EtapaVacanteController@obtenerDocumentosContratacion');\n    $ruta->post('vacantes-exportar-archivos-etapa/{etapa_id}', 'Vacantes\\EtapaVacanteController@exportarArchivosZip');\n    $ruta->post('vacantes-notificar-documentos-solicitados/{id}', 'Vacantes\\EtapaVacanteUsuarioController@notificarDocumentosSolicitados');\n    $ruta->post('vacantes-abandonar-vacante', 'Vacantes\\EtapaVacanteUsuarioController@abandonarVacante');\n    $ruta->get('vacantes-listado-postulaciones-aplicante', 'Vacantes\\VacanteController@listadoPostulacionesAplicanteEspecifico');\n    $ruta->get('vacantes-postulaciones-aplicantes', 'Vacantes\\VacanteController@vistaPostulacionesAplicante');\n\n    // Agendas - Accesible para aplicantes y usuarios de empresa\n    $ruta->get('agendas-aplicante', 'Procesos\\ProcesoController@obtenerPruebasAplicante');\n\n    // Rutas para servir imágenes - accesibles para aplicantes Y Superadmin\n    $ruta->get('modulos-preguntas-imagen/{nombre_archivo}', 'Pruebas\\ModuloPreguntaController@getImagen');\n    $ruta->get('reactivos-imagen-por-id/{reactivo_id}', 'Pruebas\\ReactivoController@getImagenPorId');\n    $ruta->get('opciones-imagen-por-id/{opcion_id}', 'Pruebas\\OpcionController@getImagenPorId');\n    $ruta->get('preguntas-frecuentes-imagen/{nombre_archivo}', 'Soportes\\PreguntaFrecuenteController@getImagen');\n\n    $ruta->get('psicometricas', 'DashboardController@enConstruccion');\n    $ruta->get('ordenes', 'DashboardController@enConstruccion');\n\n    $ruta->get('consumo-clientes', 'DashboardController@paginaEmpresa');\n    $ruta->get('configuraciones-clientes', 'Configuraciones\\ConfiguracionController@paginaConfiguraciones');\n    $ruta->get('roles-permisos', 'Auth\\RolController@rolesPermisosMiEmpresa');\n\n    $ruta->get('propuestas', 'DashboardController@enConstruccion');\n    $ruta->get('novedades', 'DashboardController@enConstruccion');\n\n    // Áreas\n    $ruta->get('areas-listado', 'Empresas\\AreaController@listado');\n    $ruta->post('areas', 'Empresas\\AreaController@store');\n\n    // Cargos\n    $ruta->get('cargos-listado', 'Empresas\\CargoController@listado');\n    $ruta->post('cargos', 'Empresas\\CargoController@store');\n\n    // Niveles educativos\n    $ruta->get('niveles-educativos', 'OfertasLaborales\\NivelEducativoController@index');\n\n    // Áreas de estudio\n    $ruta->get('areas-estudios', 'Usuarios\\PerfilesLaborales\\AreaEstudioController@index');\n\n    // Idiomas\n    $ruta->get('idiomas', 'Usuarios\\PerfilesLaborales\\IdiomaController@index');\n\n    // Autenticación del websoket\n    $ruta->post('/broadcasting-auth', 'Broadcasting\\BroadcastingController@autenticar');\n\n    $ruta->get('/botones', function () {\n        return view('botones');\n    })->name('botones');\n\n    $ruta->get('pruebas-plantillas', 'DashboardController@plantillasPruebas');\n    $ruta->get('componentes/index', 'ComponenteController@index')->name('componentes');\n    $ruta->get('componentes/lista', 'ComponenteController@getLista')->name('componentes-lista');\n\n    // Rutas temporales (hay que eliminarlas cuando se desarrollen sus respectivos módulos)\n    $ruta->get('analiticas', 'DashboardController@index');\n    $ruta->get('en-construccion', 'DashboardController@enConstruccion');\n    $ruta->get('uso-panel-demografico', 'DashboardController@indexAnaliticaUsoPanelDemografico');\n    $ruta->get('panel-demografico', 'DashboardController@indexAnaliticaPanelDemografico');\n    $ruta->get('uso', 'DashboardController@indexAnaliticaUso');\n    $ruta->get('experiencia', 'DashboardController@indexAnaliticaExperiencia');\n\n    // Rutas de componentes de desarrollo\n    $ruta->get('/componentes/{menu}/{modulo}', 'ComponenteController@componentes');\n    $ruta->post('/componentes/prueba', 'ComponenteController@pruebaComponentes');\n\n    // TODO: ruta de prueba, eliminarla próximamente\n    $ruta->get('visualizar-reporte', 'DashboardController@enConstruccion');\n    $ruta->get('reportes-generar/{agenda_id}', 'Reportes\\ReporteController@generar');\n    $ruta->get('reporte-agenda/{agenda_id}', 'Reportes\\ReporteController@mostrarReporteAgenda');\n    $ruta->post('reportes-agendas-zip', 'Reportes\\ReporteController@descargarReportesZip');\n    $ruta->get('reportes-generar-comparativo', 'Reportes\\ReporteController@generarComparativo');\n\n    // Rutas para las encuestas\n    $ruta->get('validar-encuesta/{id}', 'Encuestas\\EncuestaController@obtenerUnoDeUsuario');\n    $ruta->post('encuestas-guardar-respuestas', 'Encuestas\\EncuestaController@guardarRespuestas');\n});\n\n// Rutas no protegidas por autenticación\nRoute::group([\n    'namespace' => 'App\\Http\\Controllers'\n], function ($ruta) {\n    // Contraseñas\n    $ruta->post('contrasenas/verificar-uso', 'Usuarios\\ContrasenaController@verificarUso');\n\n    // Empresas\n    $ruta->get('empresas-parametrizar/{hash}/{id?}', 'Empresas\\EmpresaEnlaceCreacionController@index');\n    $ruta->post('empresas-parametrizar', 'Empresas\\EmpresaEnlaceCreacionController@crearEmpresa');\n    $ruta->post('empresas-parametrizar-archivos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarArchivosEmpresa');\n    $ruta->post('empresas-parametrizar-contactos/{empresa_id}', 'Empresas\\EmpresaEnlaceCreacionController@guardarContactosEmpresa');\n    $ruta->get('empresas-logo/{id}', 'Empresas\\EmpresaController@getLogo');\n\n    // Ordenes de servicio\n    $ruta->group([\n        'middleware' => 'orden-servicio-enlace-publico'\n    ], function ($ruta) {\n        $ruta->get('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@crearPorEnlacePublico');\n        $ruta->post('/ordenes-servicio-enlace-publico', 'OrdenesServicios\\OrdenServicioController@guardarDesdeEnlacePublico');\n    });\n\n    $ruta->get('/ordenes-servicio-enlace-publico/error', 'OrdenesServicios\\OrdenServicioController@errorEnlacePublico');\n\n    // Países\n    $ruta->get('paises-listado', 'Configuraciones\\PaisController@listado');\n    $ruta->get('paises-listado-completo', 'Configuraciones\\PaisController@listadoCompleto');\n\n    // Departamentos\n    $ruta->get('departamentos-listado', 'Configuraciones\\DepartamentoController@listado');\n\n    // Ciudades\n    $ruta->get('ciudades-listado', 'Configuraciones\\CiudadController@listado');\n\n    // Portales de empleo\n    $ruta->get('portales-empleo', 'Empresas\\PortalEmpleoController@portalesEmpleo');\n    $ruta->get('portales-empleo/oferta-laboral/{id}', 'OfertasLaborales\\OfertaLaboralController@detallesPortalEmpleo');\n    $ruta->get('portales-empleo/{portal_empleo_uuid}', 'Empresas\\PortalEmpleoController@portalEmpleoEmpresa');\n    $ruta->get('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@crearAplicante');\n    $ruta->post('portales-empleo/crear/aplicante', 'Empresas\\PortalEmpleoController@guardarUsuarioAplicante');\n    $ruta->post('portales-empleo-enviar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@enviarCodigoAutorizacionCrearAplicante');\n    $ruta->post('portales-empleo-verificar-codigo-autorizacion', 'Empresas\\PortalEmpleoController@verificarCodigoAutorizacionCrearAplicante');\n\n    // Firmas de rutas\n    $ruta->get('firmas-rutas-expirada', 'Accesos\\FirmaRutaController@firmaRutaExpirada')->name('firma-ruta-expirada');\n    $ruta->get('firmas-rutas-formulario-acceso/{id}', 'Accesos\\FirmaRutaController@formularioAcceso')->name('formulario-acceso-ruta-firmada');\n    $ruta->post('firmas-rutas-validar-formulario-acceso', 'Accesos\\FirmaRutaController@validarFormularioAcceso')->name('validar-formulario-acceso-ruta-firmada');\n    $ruta->post('firmas-rutas-revocar-acceso/{id}', 'Accesos\\FirmaRutaController@revocarAcceso');\n\n    // Archivos\n    $ruta->get('archivos-abrir/{id}', 'Configuraciones\\ArchivoController@abrir');\n\n    // Imagen de usuarios\n    $ruta->get('usuarios-imagen/{id}', 'Usuarios\\UserController@getImagen');\n\n    // Consultar reportes con firma\n    $ruta->get('reporte-agenda-firmado/{id}/{firma}', 'Reportes\\ReporteController@mostrarReporteAgendaValidacion');\n});\n\n/**\n * Rutas protegidas por firma: El acceso a estas rutas está limitado por la vigencia de la firma con la que se accede a la ruta.\n *\n * @author Fahibram Cárcamo\n */\nRoute::group([\n    'prefix'     => 'rutas-firmadas',\n    'middleware' => ['ruta-firmada'],\n    'namespace'  => 'App\\Http\\Controllers'\n], function ($ruta) {\n    $ruta->get('procesos/{id}', 'Procesos\\ProcesoController@showFirmada');\n    $ruta->get('procesos-resultados-aplicante/{proceso_id}/{participante_id}', 'Procesos\\ProcesoController@showResultadosAplicanteFirmada');\n});\n\n/**\n * Genera un token SSO firmado y redirige a WordPress.\n *\n * Flujo:\n *  - Requiere un usuario autenticado (será el admin en WP).\n *  - Opcionalmente recibe un student_id para crear un estudiante en WP.\n *  - Crea un nonce de un solo uso y lo guarda en cache con expiración corta.\n *  - Firma un payload con los datos de ambos usuarios y la expiración del token.\n *  - Redirige al callback configurado en WordPress.\n *\n * @author Sergio Vargas\n */\nRoute::get('/sso/wordpress', function (Request $request) {\n    $user = $request->user();\n    $empresa = $user->empresa;\n\n    $studentId = $request->input('student_id');\n    $etapaVacanteUsuarioId = $request->input('etapa_vacante_usuario_id');\n    $studentData = null;\n\n    if ($studentId) {\n        $student = App\\Models\\Usuarios\\User::find($studentId);\n\n        if ($student && $student->id !== $user->id) {\n            $studentData = [\n                'id'    => (string) $student->id,\n                'email' => $student->email,\n                'name'  => $student->getNombreCompletoAttribute(),\n            ];\n\n            // Agregar competencias si se pasa etapa_vacante_usuario_id\n            if ($etapaVacanteUsuarioId) {\n                $studentData['competencias'] = sso_obtener_competencias((int) $etapaVacanteUsuarioId);\n            }\n        }\n    }\n\n    $nonce = (string) Str::uuid();\n    $exp   = now()->addSeconds(60)->timestamp;\n\n    Cache::put(\"sso_nonce:{$nonce}\", [\n        'user_id' => $user->id,\n        'exp'     => $exp,\n    ], now()->addMinutes(5));\n\n    $payload = [\n        'sub'              => (string) $user->id,\n        'email'            => $user->email,\n        'name'             => $user->getNombreCompletoAttribute(),\n        'nombre_comercial' => $empresa?->nombre_comercial ?? $empresa?->razon_social,\n        'documento'        => $empresa?->documento,\n        'nonce'            => $nonce,\n        'exp'              => $exp,\n        'student'          => $studentData,\n    ];\n\n    $token    = sso_sign_token($payload, config('services.sso.secret'));\n    $wp       = rtrim(config('services.sso.wp_url'), '/');\n    $cb       = ltrim(config('services.sso.wp_callback'), '/');\n    $redirect = $request->input('redirect', '/course-filter-sidebar-left/');\n\n    return redirect()->away(\n        $wp . '/' . $cb . '?token=' . urlencode($token) . '&redirect=' . urlencode($redirect)\n    );\n})->middleware('auth');\n","numLines":988,"startLine":1,"totalLines":988}},"sourceToolAssistantUUID":"5924d748-fc78-4c3b-90f5-51d6c28c245c"}
{"parentUuid":"2defc124-4a96-41d3-91f0-930e97aa4165","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_016XWbxEBvf5vR8EqyMJ2zHq","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora entiendo la estructura del archivo de rutas. Voy a analizar las secciones principales:\n\n1. **Líneas 7-11**: Ruta raíz y autenticación (públicas, pero la raíz redirige al login)\n\n2. **Líneas 14-21**: Rutas de `control-acceso` - **PÚBLICAS** (sin middleware de autenticación). Estas son para tokens de acceso de aplicantes.\n\n3. **Líneas 24-30**: Rutas de migración de usuarios - Parcialmente públicas, con middleware especial.\n\n4. **Líneas 33-40**: Rutas de `rol-empresa` - **PROTEGIDAS** por `auth` y `auth.cambio-rol-empresa`\n\n5. **Líneas 43-848**: El gran grupo protegido por `['auth', 'auth.rol-empresa']` - **PROTEGIDAS**\n\n6. **Líneas 851-907**: Rutas NO protegidas por autenticación - **PÚBLICAS**\n   - Contraseñas\n   - Empresas (parametrizar)\n   - Ordenes de servicio (enlace público)\n   - Países, departamentos, ciudades\n   - Portales de empleo\n   - Firmas de rutas\n   - Archivos\n   - Imagen de usuarios\n   - Reportes con firma\n\n7. **Líneas 914-921**: Rutas firmadas - con middleware `ruta-firmada`\n\n8. **Líneas 935-987**: SSO WordPress - protegida por `auth`\n\nEntonces, para colocar una ruta accesible a todo el mundo (sin autenticación), el lugar ideal es **dentro del grupo de rutas no protegidas** que comienza en la línea **851**.\n\nLa sección relevante es:\n```php\n// Rutas no protegidas por autenticación\n\n\nRoute::group([\n    'namespace' => 'App\\Http\\Controllers'\n], function ($ruta) {\n```\n\nEste grupo se extiende desde la línea 851 hasta la 907, conteniendo todas las rutas públicas sin requerimientos de autenticación.","signature":"EuUMCkYICxgCKkBAo4YAloCZnX835w+run4XF2sfs9kQqFVvEDhWRLItg8jQ80KEON18HGUBLYHyCPhy3ksGa9CEe7KjzJ0NjN7EEgzGfv2c60A2J2sIaLwaDPsLyw4Fyx02ijFICyIweMF16cClFZfzD9576AlRZngrl1YU6Ae9dKt4TXlB8TWupU4fdfHuV1TN/afuj+qeKswLhelme2wNyXYJUKec4UV066JwcMu8On7qf4q0YGdkQ61GZbqWr5Guly5VpRfPBxz9IFpBtwGaq/V2s4KDUPWe4Cd2pXl4cx9oxfNuDaajEPNurvjQndnomVRbYDGdx5YVM74qGK4/9DAAfKJ/rnbkDAmjwHLT3qecCpfHrME1hxGAxrvw6NToECVB11nbOzF2mn8iPE72wAK+pAApXlbWm92oLYSya/qZBa42WEJ1LsYsybWOtoowP9f9xYHPcSKVpDmimEwO0oLsbqsjYMOunqL/K5GuzNN8cjPrR79100QJ9qBonjurY79I23bHU+zBq1dPd/l204Gw110O/2sMyBWT52mhAMT2ZlbHMzi0A8arYxV49Ljt5A1ZosL5z2ccA5OKjyMIydWCN9KilW2OKF+N6XjW6svSHPWxmZg6Laq1ECBXlPqBWdkLmVF/1ej0RNUOAVUVsHVkJg19BQNXf8gVbOER6s+kq+eUCgChA3vabWQjRuT2EyRxoFJMGCi4+Z+VXnIPapsDVd2c4dnLaVkss5B2ANA1QNb8LA34WG/9HU7AevA/PHW5GSYoQVOdHRZm3bjC0EJyV3N/FO4yyivfoTb7mQqBmfsS3IvSLt22JCQ2lhYUnOJjzuVe8HexRjbeJ+N0Hc+Hj6F3qRyupBPACNsA2Ku97tYLVVZ6coKJQx6zSCivsbaPNbOzuOChhL3zN3JZHEpo7SFBHdKDbVJKQDbxW2ddR7jWyuJrUuI03HfMrO/KYorBw+4JJFaK8JwXPf7rgbJ9hBMKsB3yQGLhea34QLe7Utjs915VHMXltjDKhJSaZIEkp8+aEaz017pX8KCdhCu3VWZzd8rNcGDwwnT7DbG/0YkbDgOX3T6vJofCNqITI+vdaVDGms3qsj1b/iiFNMv836rLPAMwqGjnQ3761WoRuUzD6gw46QMn8WE64hu6Aw6viFuxEXtMToodfjo8WVBwLSQo8J2uKOXBFyiXXZS/v8f139xz0ayOO09RBU9PTfrFasFdshBEmm0BizJhJLDfFkO2cPVYonyb8703j84EuVcaFwgV6j+CAigHsm4dqdObu0+oJTvS2I1jTQkQqrtvJ1rq2fTtQQzp94XOU4FUdgkfytLEE3yXZMNuzqZulf3EEKqZSF5oMkeY7JNrPFOs9duU4wJhFsepHoAM7V1yKKhQf3xd0sR+bAdfYAJz/WlH0zUqX0ZUZNDaoHipucc56SONbAdKHh5yueB9/PT4N+qYzLXwOw87atnV5RyAo3tsnsd7sl3vuBCbm7EMAifVnFnrNDHiu0aPOF9b2sth/6YwOlgPmY8dGiL3+7cIYPGERJxHXNB7iO9ihXOKeuJBlK/QAJ8HdxN7BX8Yayu6juvg6orDNSbMSbCiNqWhGtYiHpfY5hW0+5Gw6G71NU+0YbSrNWEZ/x3SNN8cqHlkjizfkXPoaI9+kUIjgr7jvu3SWoK65xRXfSqY67WrUA1d1vnjbh+ZjyA3hijISbQ+Qy+IyXovzf9CwLXOPhQMM0rI0epN+nEYtywoAeKdSL0hMR/PolBvExOkLt0TYfRh87OBgxZgvtyoqMRXli0APbLV01tDy8cTG+YVI32ErtKhyvmeL3OwLfW4b78+Wn0clxL4fjfiQ2W6C54ApeJSOzqYdO3FKtwBN/h18ezp7eo13IjhtIcW90/cgGN5/Q4cGb3CqrYjBjBITPvKmSBm6KXnPojtYKU8kuIcAA1sZvGlTqMVcjCFnq1iIu/jdsSsWJghhzQVeisaL4P5wZFJiyDBo3o3+JvPAK5suRxshbkJn4tClx/Tn8tWjWusvjY60YaZiYUnrc3ci8lr8az7w2+lSJdscjXdN0ZxQqHY3sXiZxFQ1LzlE6XP/QUBheGO9E20zOTVcEMhKPPsVh3+16qB8snlhRD3Pv49rBUOVrmmimBLx2Sc2jPy5OXqUjqWGxr+m4vtsDssQdadxEPhaDhH9QwYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":27225,"cache_read_input_tokens":25099,"cache_creation":{"ephemeral_5m_input_tokens":27225,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXY11RLhiFExp4EX9hHz6","type":"assistant","uuid":"9033aaec-18a6-413e-aced-8edc0ec6ccf3","timestamp":"2026-01-27T13:58:26.726Z"}
{"parentUuid":"9033aaec-18a6-413e-aced-8edc0ec6ccf3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_016XWbxEBvf5vR8EqyMJ2zHq","type":"message","role":"assistant","content":[{"type":"text","text":"## Análisis del archivo de rutas\n\nEl archivo [web.php](routes/web.php) está organizado en varios grupos con diferentes niveles de acceso:\n\n### Estructura principal:\n\n| Líneas | Grupo | Acceso |\n|--------|-------|--------|\n| 7-11 | Ruta raíz y Auth::routes | Público (redirige a login) |\n| 14-21 | `control-acceso` | **Público** - tokens de aplicantes |\n| 24-30 | `migrar-usuario-app-antigua` | Middleware especial |\n| 33-40 | `rol-empresa` | Protegido (auth) |\n| 43-848 | Grupo principal | **Protegido** (auth + rol-empresa) |\n| **851-907** | **Sin autenticación** | **PÚBLICO - Aquí puedes agregar** |\n| 914-921 | Rutas firmadas | Middleware `ruta-firmada` |\n| 935-987 | SSO WordPress | Protegido (auth) |\n\n### Lugar para rutas públicas:\n\nEl lugar indicado para agregar una ruta accesible para **todo el mundo (sin autenticación)** es dentro del grupo que inicia en la **línea 851**:\n\n```php\n// Rutas no protegidas por autenticación\nRoute::group([\n    'namespace' => 'App\\Http\\Controllers'\n], function ($ruta) {\n    // ... rutas existentes ...\n    \n    // AQUÍ puedes agregar tu nueva ruta pública\n    $ruta->get('mi-ruta-publica', 'MiController@miMetodo');\n});\n```\n\nEste grupo ya contiene rutas públicas como:\n- Países, departamentos, ciudades (líneas 875-882)\n- Portales de empleo (líneas 884-891)\n- Imagen de usuarios (línea 903)\n- Logo de empresas (línea 862)\n\n**Recomendación**: Agrega tu ruta pública entre las líneas **902-907**, antes del cierre del grupo, organizándola según su funcionalidad."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":27225,"cache_read_input_tokens":25099,"cache_creation":{"ephemeral_5m_input_tokens":27225,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXY11RLhiFExp4EX9hHz6","type":"assistant","uuid":"89bb8bdf-00f2-44e1-af99-87049e560bb3","timestamp":"2026-01-27T13:58:34.317Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-27T15:34:25.211Z","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a"}
{"type":"file-history-snapshot","messageId":"e4e943cd-5acf-479a-a6a9-27d3ed7629d6","snapshot":{"messageId":"e4e943cd-5acf-479a-a6a9-27d3ed7629d6","trackedFileBackups":{},"timestamp":"2026-01-27T15:34:28.052Z"},"isSnapshotUpdate":false}
{"parentUuid":"5924d748-fc78-4c3b-90f5-51d6c28c245c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_019ovHMKfecjqPfUfZsi1yVQ","parentToolUseID":"toolu_019ovHMKfecjqPfUfZsi1yVQ","uuid":"49d45c15-d043-4d39-839f-4bcb3d4fc65a","timestamp":"2026-01-27T13:58:12.703Z"}
{"parentUuid":"2defc124-4a96-41d3-91f0-930e97aa4165","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_019ovHMKfecjqPfUfZsi1yVQ","toolUseID":"toolu_019ovHMKfecjqPfUfZsi1yVQ","timestamp":"2026-01-27T13:58:14.822Z","uuid":"4a6f2437-e91c-460c-b840-d05b884e72a2"}
{"parentUuid":"89bb8bdf-00f2-44e1-af99-87049e560bb3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 766 to 766 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php:\npublic function FuncionalidadesActivas(Request $request): array {\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"aqui alludam econ la dovmentacion d ela funcion public function FuncionalidadesActivas(Request $request): array {"}]},"uuid":"e4e943cd-5acf-479a-a6a9-27d3ed7629d6","timestamp":"2026-01-27T15:34:28.047Z","permissionMode":"default"}
{"parentUuid":"e4e943cd-5acf-479a-a6a9-27d3ed7629d6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_0142ta7G3HqLU6c7LpdeKtwy","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere ayuda con la documentación de la función `FuncionalidadesActivas`. Necesito leer el archivo del servicio para ver el contenido completo de la función y poder documentarla correctamente.","signature":"EvcCCkYICxgCKkAK+tCG6GmhCmEI6HKrE8N20qJ/0L3fx6lpYKoLnm2PYkxeK/epa9zus46MHOfXx/0dSbH0cQ0PSwUZS/HVQuT4EgyF0rbL4lPq35syDGEaDFcNSfZHZVCb+cSnzSIwl9BPZlYPfKD1taMX+scg+LQleWUuWqQT2AidyNYPVxkTdHTN078eqODsn45AnzOIKt4Bnyn7nJ3q77uGqSTyt8gdumQEbONDEEHRu7reMzxSv4qKodYG9xiswTcBe39OmQyCp7tfcm7dDoDi9reDwVA8/aotAY7EXVEEv+ndnat07ClCEhJ0a1G17medexTLYvgcKYR9e/lzxz++T6NEkRp09RVlWAQPQIa45tFqpx+Kka75ggrEQ3xAO4ekBk/EEqudgqKCJeyoS8kEeBjbHxRb4G7ej45VaPRNOiJb6aOQMNQdao8g4+F7f8f58fc1iwab2ol8d1hkLmsGPAfnITZF8pG8Qm5quKMpsLgjuGH3GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":54047,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":54047,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXY8LzSN51CvSmH2sLdzN","type":"assistant","uuid":"5ff861fd-cbfe-4c14-ab72-ace04861f14c","timestamp":"2026-01-27T15:34:32.342Z"}
{"parentUuid":"5ff861fd-cbfe-4c14-ab72-ace04861f14c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_0142ta7G3HqLU6c7LpdeKtwy","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a leer la función para poder documentarla correctamente."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":54047,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":54047,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXY8LzSN51CvSmH2sLdzN","type":"assistant","uuid":"fa549bc1-c60e-46be-be65-3b01251079b5","timestamp":"2026-01-27T15:34:32.879Z"}
{"parentUuid":"fa549bc1-c60e-46be-be65-3b01251079b5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_0142ta7G3HqLU6c7LpdeKtwy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014ZnfV6MsPmGVGRzgRXY7YQ","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","offset":760,"limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":54047,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":54047,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXY8LzSN51CvSmH2sLdzN","type":"assistant","uuid":"8c908c57-30c1-488c-b322-10bce3be95ff","timestamp":"2026-01-27T15:34:34.051Z"}
{"parentUuid":"8c908c57-30c1-488c-b322-10bce3be95ff","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014ZnfV6MsPmGVGRzgRXY7YQ","type":"tool_result","content":"   760→     * Validar si hay creditos suficientes.\n   761→     *\n   762→     * @param int $empresa_plan_id ID del plan de empresa.\n   763→     * @return array\n   764→     * @author Andres Gonzalez\n   765→     */\n   766→    public function FuncionalidadesActivas(Request $request): array {\n   767→        $tipo_prueba_id  = $request->filled('tipo_prueba_id') ? (int) $request->tipo_prueba_id : TipoPrueba::SELECCION_ID;\n   768→        $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   769→        $empresa_plan    = $this->repositorio->planActivo($empresa_usuario->id, $tipo_prueba_id);\n   770→        $funcionlidades  = $this->empresa_plan_funcionalidad_repositorio->getTodo(new Request(['empresa_plan_id' => $empresa_plan->id]));\n   771→        return $funcionlidades->toArray() ?? [];\n   772→    }\n   773→}\n   774→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b7430ff8-7262-4690-af91-9563e38b4171","timestamp":"2026-01-27T15:34:35.294Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","content":"     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): array {\n        $tipo_prueba_id  = $request->filled('tipo_prueba_id') ? (int) $request->tipo_prueba_id : TipoPrueba::SELECCION_ID;\n        $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n        $empresa_plan    = $this->repositorio->planActivo($empresa_usuario->id, $tipo_prueba_id);\n        $funcionlidades  = $this->empresa_plan_funcionalidad_repositorio->getTodo(new Request(['empresa_plan_id' => $empresa_plan->id]));\n        return $funcionlidades->toArray() ?? [];\n    }\n}\n","numLines":15,"startLine":760,"totalLines":774}},"sourceToolAssistantUUID":"8c908c57-30c1-488c-b322-10bce3be95ff"}
{"parentUuid":"b7430ff8-7262-4690-af91-9563e38b4171","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GtnHNk9bFoUsfnCgNDSJdg","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora tengo el contenido de la función. Necesito crear una documentación PHPDoc apropiada. La función:\n\n1. Recibe un Request\n2. Obtiene el tipo_prueba_id del request (por defecto SELECCION_ID)\n3. Obtiene la empresa del usuario actual\n4. Obtiene el plan activo de esa empresa\n5. Obtiene las funcionalidades del plan\n6. Retorna un array con las funcionalidades\n\nVoy a crear la documentación correcta para esta función.","signature":"EskECkYICxgCKkCe4FzMsF05pWiPvI2fLCIOuTfH4JaRkS4ZrhFw678vzrs4J0T8h9Mu1xvCFvzjJw4UykYGCDPRY7ghwL6fJUo0Egwe4DFgqvShekiO/nAaDBQGF1FnanudayjwjSIwth21zuG1qlPNI7rV0QqKMqlM5OC2tP5AhKoQQSpuRrnat2ItsVb/6fggrMlwQCTaKrADivJ/ykHHBJOhvDv0SLpzqy5w5JF2MyJkPm1qlwsimVzjicwQ9H26CAFhDREPYiCZHAAMLjCSLynh5BYylou0qKQOzjtNcw2KndM/5UBEwRQMnzk64RoRV1PuwnwWdOLZya4h/N0B8kucO6UR8lDFJBkt1OAvtNhgL/ZzGU822RmrjERWR1tnpMFMNdpTZNxyWhr3oqGjydmt2ecbbzuTItoEpIH8gTm/zLQR6Ebfb7sk+4+tSOWI+X4BvaTTg9bsZYH8N2wJ4ZrUgpT7FGFVJSbIqpaQw120Mplf8VuDS4EaLE6rooEmcSzo9f9pN6xWJw/hnrSv0qL77QlyWcUStLl4Fk/3bfOgdMXcARyEK3Jr14kymah+uGUgzPefyjTazSofl/q3lBag9jKUxrqpOeM13qAfW7Kh4zS/Dsdek8MvFmXAuB2UGEbsCqn4IYSQYwryy7nn21qNNqhoLhetoVSiA8fAwuAnk3WdpBRCDv+cXy4wh3GfUemTXpEAARrQOR6ed6pJEws8AvOGegLP59D7lYmOhVNkPaF4Yeh3lLczIeq8Iw3TnnDB4OIUxGvDGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":587,"cache_read_input_tokens":54047,"cache_creation":{"ephemeral_5m_input_tokens":587,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXY8MXfa8ahWYpdHgTKaG","type":"assistant","uuid":"206aa2fa-fcf5-4ab0-bfd6-90d35ecb439c","timestamp":"2026-01-27T15:34:39.328Z"}
{"parentUuid":"206aa2fa-fcf5-4ab0-bfd6-90d35ecb439c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GtnHNk9bFoUsfnCgNDSJdg","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora puedo ver la función completa. La documentación actual está incorrecta (dice \"Validar si hay creditos suficientes\" que no corresponde). Aquí está la documentación correcta:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":587,"cache_read_input_tokens":54047,"cache_creation":{"ephemeral_5m_input_tokens":587,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXY8MXfa8ahWYpdHgTKaG","type":"assistant","uuid":"ee53a845-3cfc-4434-8e00-569ebeb0c90a","timestamp":"2026-01-27T15:34:40.592Z"}
{"parentUuid":"ee53a845-3cfc-4434-8e00-569ebeb0c90a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GtnHNk9bFoUsfnCgNDSJdg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0163ow2LBH8M7ro5N2aQYZiL","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): array {","new_string":"    /**\n     * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.\n     *\n     * Busca el plan activo de la empresa asociada al usuario autenticado según el tipo de prueba\n     * especificado y retorna todas las funcionalidades habilitadas para ese plan.\n     *\n     * @param Request $request Objeto request que puede contener:\n     *                         - tipo_prueba_id (int, opcional): ID del tipo de prueba. Por defecto usa TipoPrueba::SELECCION_ID.\n     * @return array Lista de funcionalidades activas del plan. Retorna array vacío si no hay funcionalidades.\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): array {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":587,"cache_read_input_tokens":54047,"cache_creation":{"ephemeral_5m_input_tokens":587,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXY8MXfa8ahWYpdHgTKaG","type":"assistant","uuid":"0d175ced-bfde-4bd8-a1b1-5481f2208ff9","timestamp":"2026-01-27T15:34:44.581Z"}
{"type":"file-history-snapshot","messageId":"0d175ced-bfde-4bd8-a1b1-5481f2208ff9","snapshot":{"messageId":"e4e943cd-5acf-479a-a6a9-27d3ed7629d6","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v1","version":1,"backupTime":"2026-01-27T15:35:06.775Z"}},"timestamp":"2026-01-27T15:34:28.052Z"},"isSnapshotUpdate":true}
{"parentUuid":"0d175ced-bfde-4bd8-a1b1-5481f2208ff9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0163ow2LBH8M7ro5N2aQYZiL","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   755→    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n   756→        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n   757→    }\n   758→\n   759→    /**\n   760→     * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.\n   761→     *\n   762→     * Busca el plan activo de la empresa asociada al usuario autenticado según el tipo de prueba\n   763→     * especificado y retorna todas las funcionalidades habilitadas para ese plan.\n   764→     *\n   765→     * @param Request $request Objeto request que puede contener:\n   766→     *                         - tipo_prueba_id (int, opcional): ID del tipo de prueba. Por defecto usa TipoPrueba::SELECCION_ID.\n   767→     * @return array Lista de funcionalidades activas del plan. Retorna array vacío si no hay funcionalidades.\n   768→     * @author Andres Gonzalez\n   769→     */\n   770→    public function FuncionalidadesActivas(Request $request): array {\n   771→        $tipo_prueba_id  = $request->filled('tipo_prueba_id') ? (int) $request->tipo_prueba_id : TipoPrueba::SELECCION_ID;\n   772→        $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   773→        $empresa_plan    = $this->repositorio->planActivo($empresa_usuario->id, $tipo_prueba_id);\n   774→        $funcionlidades  = $this->empresa_plan_funcionalidad_repositorio->getTodo(new Request(['empresa_plan_id' => $empresa_plan->id]));"}]},"uuid":"c127f907-5175-4aa0-8918-084d95fc25a7","timestamp":"2026-01-27T15:35:06.817Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): array {","newString":"    /**\n     * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.\n     *\n     * Busca el plan activo de la empresa asociada al usuario autenticado según el tipo de prueba\n     * especificado y retorna todas las funcionalidades habilitadas para ese plan.\n     *\n     * @param Request $request Objeto request que puede contener:\n     *                         - tipo_prueba_id (int, opcional): ID del tipo de prueba. Por defecto usa TipoPrueba::SELECCION_ID.\n     * @return array Lista de funcionalidades activas del plan. Retorna array vacío si no hay funcionalidades.\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): array {","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse App\\Models\\Planes\\Plan;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanFuncionalidadRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param EmpresaPlanFuncionalidadRepository $empresa_plan_funcionalidad_repositorio Repositorio de funcionalidades de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected EmpresaPlanFuncionalidadRepository $empresa_plan_funcionalidad_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $tiene_plan_seleccion = $request->filled('plan_id');\n        $tiene_plan_creditos  = $request->filled('plan_credito_id');\n        $plan_asignado        = null;\n\n        // Si tiene plan de selección, crear/actualizar ese plan\n        if ($tiene_plan_seleccion) {\n            $plan_asignado = $this->guardarPlanSeleccion($request);\n        }\n\n        // Si tiene plan de créditos, crear ese plan por separado\n        if ($tiene_plan_creditos) {\n            $plan_creditos = $this->guardarPlanCreditos($request);\n\n            // Si no había plan de selección, retornar el de créditos\n            if (!$tiene_plan_seleccion) {\n                $plan_asignado = $plan_creditos;\n            }\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Guardar un plan de selección.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Andres Gonzalez\n     */\n    protected function guardarPlanSeleccion(Request $request): EmpresaPlan {\n        $enviar_correo    = false;\n        $campos_excluidos = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades', 'precio_creditos', 'porcentaje_descuento_creditos', 'plan_credito_id', 'creditos'];\n        $plan             = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo      = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia         = $plan->vigencia;\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia_seleccion;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia_seleccion;\n                }\n            }\n\n            // Poner el nuevo plan como proximo\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia_seleccion:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n            $titulo       = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Guardar un plan de créditos.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Andres Gonzalez\n     */\n    protected function guardarPlanCreditos(Request $request): EmpresaPlan {\n        $enviar_correo = false;\n        $plan_credito  = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n        $plan_activo   = $this->repositorio->planCreditosActivo($request->empresa_id);\n\n        // Preparar datos para el plan de créditos\n        $datos_creditos = [\n            'empresa_id'            => $request->empresa_id,\n            'plan_id'               => null,\n            'plan_credito_id'       => $request->plan_credito_id,\n            'creditos'              => $plan_credito->creditos ?? 0,\n            'precio'                => $request->precio_creditos ?? $plan_credito->precio ?? null,\n            'porcentaje_descuento'  => $request->porcentaje_descuento_creditos ?? null,\n            'numero_factura'        => $request->numero_factura,\n            'comentario'            => $request->comentario,\n            'fecha_inicio'          => null,\n            'fecha_vencimiento'     => null,\n            'usuario_id'            => auth()->user()->id,\n        ];\n\n        // Si es edición de un plan de créditos existente\n        if ($request->filled('id')) {\n            // Eliminar la factura actual si se sube una nueva\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $datos_creditos);\n        } else {\n            // Determinar estado para nuevo plan\n            if (!is_null($plan_activo) && $plan_activo->id != $request->id) {\n                $datos_creditos['estado_id'] = Plan::ESTADO_PROXIMO_ID;\n            } else {\n                $datos_creditos['estado_id'] = Plan::ESTADO_ACTIVO_ID;\n            }\n\n            $enviar_correo = true;\n            $plan_asignado = $this->repositorio->crear($datos_creditos);\n        }\n\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === Plan::ESTADO_PROXIMO_ID) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [Plan::ESTADO_ACTIVO_ID, Plan::ESTADO_POR_VENCER_ID])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => Plan::ESTADO_PROXIMO_ID]);\n        } elseif (in_array($empresa_plan->estado_id, [Plan::ESTADO_INACTIVO_ID, Plan::ESTADO_VENCIDO_ID])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => Plan::ESTADO_ACTIVO_ID]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy = now();\n\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses = $vigencia / 30;\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio' => $fecha_inicio->format('Y-m-d'),\n\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n\n        $this->generarDirectorios(\"app/{$ruta}\");\n\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo' => 'App\\Models\\Empresas\\EmpresaPlan',\n\n            'modelo_id' => $id,\n\n            'nombre' => 'factura',\n\n            'ruta' => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n\n            RolRepository::ROL_PROPIETARIO_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n\n            $plan->creditos_consumidos = $creditos_consumidos;\n\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener todos los planes de créditos activos de la empresa (donde plan_id es NULL).\n     * Incluye la propiedad plan_proximo_id si existe un plan de créditos próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function obtenerPlanesCreditosActivos(int $empresa_id): Collection {\n        $planes = $this->repositorio->planesCreditosActivos($empresa_id);\n        $plan_proximo = $this->repositorio->planCreditosProximo($empresa_id);\n\n        return $planes->map(function ($plan) use ($plan_proximo) {\n            $plan->plan_proximo_id = $plan_proximo?->id ?? null;\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     * @author Andres González\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $tipo_plan = $request->tipo_plan ?? 'plan';\n\n        if ($tipo_plan === 'plan_credito') {\n            $plan = $this->plan_credito_repositorio->getUno($request->plan_id);\n        } else {\n            $plan = $this->plan_repositorio->getUno($request->plan_id);\n        }\n\n        $empresa = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     * @author José Manuel Jiménez\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planCreditosActivo($empresa_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null,\n            'estado'               => $empresa_plan->estado ? [\n                'id'     => $empresa_plan->estado->id,\n                'nombre' => $empresa_plan->estado->nombre,\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): array {\n        $tipo_prueba_id  = $request->filled('tipo_prueba_id') ? (int) $request->tipo_prueba_id : TipoPrueba::SELECCION_ID;\n        $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n        $empresa_plan    = $this->repositorio->planActivo($empresa_usuario->id, $tipo_prueba_id);\n        $funcionlidades  = $this->empresa_plan_funcionalidad_repositorio->getTodo(new Request(['empresa_plan_id' => $empresa_plan->id]));\n        return $funcionlidades->toArray() ?? [];\n    }\n}\n","structuredPatch":[{"oldStart":757,"oldLines":10,"newStart":757,"newLines":14,"lines":["     }"," ","     /**","-     * Validar si hay creditos suficientes.","+     * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.","      *","-     * @param int $empresa_plan_id ID del plan de empresa.","-     * @return array","+     * Busca el plan activo de la empresa asociada al usuario autenticado según el tipo de prueba","+     * especificado y retorna todas las funcionalidades habilitadas para ese plan.","+     *","+     * @param Request $request Objeto request que puede contener:","+     *                         - tipo_prueba_id (int, opcional): ID del tipo de prueba. Por defecto usa TipoPrueba::SELECCION_ID.","+     * @return array Lista de funcionalidades activas del plan. Retorna array vacío si no hay funcionalidades.","      * @author Andres Gonzalez","      */","     public function FuncionalidadesActivas(Request $request): array {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"0d175ced-bfde-4bd8-a1b1-5481f2208ff9"}
{"parentUuid":"c127f907-5175-4aa0-8918-084d95fc25a7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01X4Zv3jep95wy47TvhUNfnB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"La documentación ha sido actualizada correctamente. Ahora la función tiene una documentación precisa que describe:\n\n1. Qué hace la función (obtener funcionalidades activas del plan)\n2. Cómo funciona (busca el plan activo según tipo de prueba)\n3. Los parámetros que recibe (Request con tipo_prueba_id opcional)\n4. Lo que retorna (array de funcionalidades)\n\nLa documentación anterior era incorrecta ya que decía \"Validar si hay creditos suficientes\" y el parámetro era \"empresa_plan_id\" cuando en realidad la función recibe un Request.","signature":"EsoFCkYICxgCKkDUTmf+mNcARwJJIYm3UaMNE0V3Hp/H2XiFCoqEp5xbdg0nqdO3cn5RhLZKcxlhP4lz3Pg3//lR/cBZBN3aVwwjEgxKQ/Ia5bDcCJqoRXcaDKJKlJEXcKK4XTzztCIwcx7MCIpURSAU6d04bXY9RXGnydS32Cf6JFUEqSoogjqOmdNnF7kdynbnnKWzrkq1KrEEFclQ9u/WkwQ7TB6+CjuOGgEYLEPLqP/5y7zjbQJi2e53tBQDTvWOmIg4XHtE3mwoOZt/dVIBDxHHvPr0PJLjzF1K3jb/XnK55/473kcTOiXHzXlEav3rfoZKoPjey6zEmIEjwQ6VSiIN9/chCSchOJ3OtsoEQunTYAlHWEXgZSVHrEGsa4xREs11w7QbAy44VWYJ0tuRZbcMV1v8Nz82t1pqEX0BT4cMD1jpOSzceg8DPLbfUvdTr2HjPy/OuHg3ran/iugA5+5ENFZ8lpbEHefVISnPh5ng5xsVbJfttaXxL705HUdFQ8yN7TF4pBJOACP3c5ycPRRcxPdHnEDvoipQ3CC9bIvG9o/QWehgiMdDC0f0NCOjgUrIjr0cGJRMYCC/SgY3idJxbTQl5N0MPzFg3fUbFj5YAq8vHkfsP6B7R4ZsE98Bzg2AgbcstDLD6GPwzFN43PkWdtSsKsgotuIjx+geDeRGeKd9TcdyZDoOQVPau1HIwxPD2Banoi75TZnTXSfEnE2AvAKbhzcGWxJh/OZT6qPlbG8nVh3hnm+C6T1amCle22DjumL+SUP2jIA8Z8ceorspGg+dcIKAukkHAEs79IuICl08u2Bt4//tpMs0elLHmb2gIw7T6Anj2MywCdJMc8jEdrXiY+IkupyUch7L67Z9c8/FL/EfDwWYgU41FPTUQHHjOalKZWxP5qIA8+ya3hrmBVRxoB6XKi5g1q3e4hA4prXjtkMKiE3UGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1148,"cache_read_input_tokens":54634,"cache_creation":{"ephemeral_5m_input_tokens":1148,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXY8PyqV2M2WZSXnUUWxy","type":"assistant","uuid":"e148292c-b39f-4206-ad14-dda6e35fb590","timestamp":"2026-01-27T15:35:12.460Z"}
{"parentUuid":"e148292c-b39f-4206-ad14-dda6e35fb590","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01X4Zv3jep95wy47TvhUNfnB","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He corregido la documentación de la función. La documentación anterior era incorrecta (decía \"Validar si hay creditos suficientes\" y mencionaba un parámetro `empresa_plan_id` que no existía).\n\nLa nueva documentación describe correctamente:\n\n- **Propósito**: Obtener las funcionalidades activas del plan vigente\n- **Funcionamiento**: Busca el plan activo de la empresa del usuario autenticado\n- **Parámetro**: `Request` con `tipo_prueba_id` opcional (por defecto `TipoPrueba::SELECCION_ID`)\n- **Retorno**: Array con las funcionalidades activas del plan"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1148,"cache_read_input_tokens":54634,"cache_creation":{"ephemeral_5m_input_tokens":1148,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXY8PyqV2M2WZSXnUUWxy","type":"assistant","uuid":"8bba53e6-aa7e-4c69-81f8-c23d593c34e4","timestamp":"2026-01-27T15:35:14.557Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-27T15:35:59.633Z","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a"}
{"type":"file-history-snapshot","messageId":"06e48f91-98c4-4990-97c2-5f5aef50d407","snapshot":{"messageId":"06e48f91-98c4-4990-97c2-5f5aef50d407","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v2","version":2,"backupTime":"2026-01-27T15:36:02.362Z"}},"timestamp":"2026-01-27T15:36:02.333Z"},"isSnapshotUpdate":false}
{"parentUuid":"8c908c57-30c1-488c-b322-10bce3be95ff","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_014ZnfV6MsPmGVGRzgRXY7YQ","parentToolUseID":"toolu_014ZnfV6MsPmGVGRzgRXY7YQ","uuid":"72c719a5-dbf8-41e9-b482-a388f8b365db","timestamp":"2026-01-27T15:34:34.232Z"}
{"parentUuid":"b7430ff8-7262-4690-af91-9563e38b4171","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_014ZnfV6MsPmGVGRzgRXY7YQ","toolUseID":"toolu_014ZnfV6MsPmGVGRzgRXY7YQ","timestamp":"2026-01-27T15:34:35.295Z","uuid":"020bf58c-1125-4548-ab12-f9f169b38be8"}
{"parentUuid":"0d175ced-bfde-4bd8-a1b1-5481f2208ff9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_0163ow2LBH8M7ro5N2aQYZiL","parentToolUseID":"toolu_0163ow2LBH8M7ro5N2aQYZiL","uuid":"eb39eaeb-3948-413b-aa98-c4c56ea8f4a6","timestamp":"2026-01-27T15:34:44.733Z"}
{"parentUuid":"eb39eaeb-3948-413b-aa98-c4c56ea8f4a6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_0163ow2LBH8M7ro5N2aQYZiL","parentToolUseID":"toolu_0163ow2LBH8M7ro5N2aQYZiL","uuid":"84f91a07-52f3-48c8-8e3b-2a8b838b6cf9","timestamp":"2026-01-27T15:34:44.733Z"}
{"parentUuid":"c127f907-5175-4aa0-8918-084d95fc25a7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_0163ow2LBH8M7ro5N2aQYZiL","toolUseID":"toolu_0163ow2LBH8M7ro5N2aQYZiL","timestamp":"2026-01-27T15:35:06.818Z","uuid":"864e682d-adbb-4f4b-b943-b72114969749"}
{"parentUuid":"8bba53e6-aa7e-4c69-81f8-c23d593c34e4","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 542 to 542 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php:\npublic function FuncionalidadesActivas(Request $request): JsonResponse {\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"aqui tambien public function FuncionalidadesActivas(Request $request): JsonResponse {"}]},"uuid":"06e48f91-98c4-4990-97c2-5f5aef50d407","timestamp":"2026-01-27T15:36:02.331Z","permissionMode":"default"}
{"parentUuid":"06e48f91-98c4-4990-97c2-5f5aef50d407","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01F8EhcfNPxCEyVSQgKdzv6n","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que documente también la función `FuncionalidadesActivas` en el controlador `EmpresaPlanController`. Necesito leer esa función para ver su contenido y documentarla correctamente.","signature":"EvACCkYICxgCKkBwXUDr668JSwt0ecGaNYKzC51gtPi1qrw+20rLFhsOXYlihTpL9boJzXxEFM1spOanvKyzBUyOPw6Rs5uwdTSQEgxG39Stl0G733RCPCoaDF4yDjI7z+KgtnqvQSIwImfkRPQRA6vcKw02EfPtKghQfTQcp3wHbqtZtxZZdtnSa6ZnYIzwAfjqhrsW9afIKtcB2j1g5xa6fnMczIuMVPGsEqS9GjUKGmisVu1nGmAtpUZiDMcj96OE/aQJ+YavnEeKSuDwedZaqpoW+RXSc84mH46st3tFjKO+SUOWTU5J8SlqW+wxr0oROYNdTNp526OPSBrki5gSlXEdbuBhGXUJF/DGqsB6a3uye3o58qXcxm3Qj5cfAXMaawz7OAcQ1FsTYzMdD4aSgqCsz4GF6TNWMISYvrAgfa2yTNvETjWK7uP/ibRPo/VSPfPq++3SxhIQmBJNSYP8K/w9UNW3slZ17EXUwSYR0wwYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1013,"cache_read_input_tokens":55782,"cache_creation":{"ephemeral_5m_input_tokens":1013,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXY8Txt3eobUcAiXmaVfJ","type":"assistant","uuid":"33004ae3-3b5d-433a-acb9-dcb2077ae42a","timestamp":"2026-01-27T15:36:05.693Z"}
{"parentUuid":"33004ae3-3b5d-433a-acb9-dcb2077ae42a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01F8EhcfNPxCEyVSQgKdzv6n","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a leer la función en el controlador para documentarla."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1013,"cache_read_input_tokens":55782,"cache_creation":{"ephemeral_5m_input_tokens":1013,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXY8Txt3eobUcAiXmaVfJ","type":"assistant","uuid":"ce872855-1a80-4276-93a6-addd4bd2b3ab","timestamp":"2026-01-27T15:36:05.989Z"}
{"parentUuid":"ce872855-1a80-4276-93a6-addd4bd2b3ab","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01F8EhcfNPxCEyVSQgKdzv6n","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FPHVN3bZEo4NSh5vpSGWtY","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","offset":535,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":1013,"cache_read_input_tokens":55782,"cache_creation":{"ephemeral_5m_input_tokens":1013,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXY8Txt3eobUcAiXmaVfJ","type":"assistant","uuid":"9e9ecc10-2d3c-4059-ae92-d8cbe7b45534","timestamp":"2026-01-27T15:36:06.656Z"}
{"parentUuid":"9e9ecc10-2d3c-4059-ae92-d8cbe7b45534","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FPHVN3bZEo4NSh5vpSGWtY","type":"tool_result","content":"   535→    /**\n   536→     * Datos de empresas_planes de todas las empresas como respuesta json.\n   537→     *\n   538→     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.\n   539→     * @return JsonResponse\n   540→     * @author Andres Gonzalez\n   541→     */\n   542→    public function FuncionalidadesActivas(Request $request): JsonResponse {\n   543→        return new JsonResponse([\n   544→            'data' => $this->servicio->FuncionalidadesActivas($request)\n   545→        ], JsonResponse::HTTP_OK);\n   546→    }\n   547→}\n   548→    \n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"13054502-ca3d-41a1-bbcb-ee43f8d02f32","timestamp":"2026-01-27T15:36:07.903Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","content":"    /**\n     * Datos de empresas_planes de todas las empresas como respuesta json.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.\n     * @return JsonResponse\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->FuncionalidadesActivas($request)\n        ], JsonResponse::HTTP_OK);\n    }\n}\n    ","numLines":14,"startLine":535,"totalLines":548}},"sourceToolAssistantUUID":"9e9ecc10-2d3c-4059-ae92-d8cbe7b45534"}
{"parentUuid":"13054502-ca3d-41a1-bbcb-ee43f8d02f32","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CbC8f3PAXrGsPLRgHcUy3n","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora puedo ver la función en el controlador. La documentación actual también está incorrecta (dice \"Datos de empresas_planes de todas las empresas\" y menciona un parámetro `DescargarEmpresasPlanesRequest` cuando en realidad recibe un `Request` normal).\n\nVoy a corregir la documentación para que sea precisa.","signature":"EuEDCkYICxgCKkAI6sEL++pXsDCnhanhqMNWtQJu/7/h1lnOQuBijwQCJUzguG9ylFGmAsl0cg20sAyyfsLVoWeZ1oHWYFMJtYDcEgwBG9MIl0pkSqTt7mYaDMAxCNkMTrptY/IOWiIwOeZ+mv4N6CfNqOfvtk3pfJ5CmwbzN/Ht4h4oR/m9LegJ3gjL9VzEvHfM05AfZv+2KsgC8f2051STBUXznshzU1h9T0GjfWITuVKNnMZApmBJH92Hy96eeIfG6a6KU+qk5LDfuJH4+/lF2oYWDDzBhWEMw4NVCC6+mfgBQEb78/eMZydlVXDN1tIwax2vuA17tR2JCiWFvgNWiUtJQvhLBLpX0CSR19d+sM3oDSwb+Dv5q02arrPoUfXVPBEpTzP35TBX9lPTth+kzaGy/KoiB7Or4h48UNEmup74EKHm/EcDj1auuv+uD+BnZSqVkI+4J+BGeRer6R0ES4ZZbPkxvRPGKLqtahjCj4ppYU+OzDnCxgd9F7/5g0V1UEPVGi+ugfAMIaexZyLk+MTJvHWmjV0JpivJKAras9gwJx19TP+74eF4CZhxtxoa9bQuGs85np4k+504L9tw8d75bdmj5JiCVZiQ+iAArdiFwOUUeP2GWd5ZS9QqDiheRBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":584,"cache_read_input_tokens":56795,"cache_creation":{"ephemeral_5m_input_tokens":584,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXY8UNV7nYTmHxudPcgPo","type":"assistant","uuid":"19dbdebf-58de-44f9-bdb2-ab67a9f04740","timestamp":"2026-01-27T15:36:12.622Z"}
{"parentUuid":"19dbdebf-58de-44f9-bdb2-ab67a9f04740","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CbC8f3PAXrGsPLRgHcUy3n","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015R2UKspFTLdAMLpkCMBmkK","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","old_string":"    /**\n     * Datos de empresas_planes de todas las empresas como respuesta json.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.\n     * @return JsonResponse\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): JsonResponse {","new_string":"    /**\n     * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.\n     *\n     * Endpoint público que retorna la lista de funcionalidades habilitadas para el plan\n     * activo de la empresa, según el tipo de prueba especificado.\n     *\n     * @param Request $request Objeto request que puede contener:\n     *                         - tipo_prueba_id (int, opcional): ID del tipo de prueba.\n     * @return JsonResponse Respuesta JSON con la estructura:\n     *                      - data (array): Lista de funcionalidades activas del plan.\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): JsonResponse {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":584,"cache_read_input_tokens":56795,"cache_creation":{"ephemeral_5m_input_tokens":584,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXY8UNV7nYTmHxudPcgPo","type":"assistant","uuid":"963da673-373c-4cf1-82fd-8275152a4c44","timestamp":"2026-01-27T15:36:15.615Z"}
{"type":"file-history-snapshot","messageId":"963da673-373c-4cf1-82fd-8275152a4c44","snapshot":{"messageId":"06e48f91-98c4-4990-97c2-5f5aef50d407","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v2","version":2,"backupTime":"2026-01-27T15:36:02.362Z"},"app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php":{"backupFileName":"71d1198be92c5143@v1","version":1,"backupTime":"2026-01-27T15:36:47.237Z"}},"timestamp":"2026-01-27T15:36:02.333Z"},"isSnapshotUpdate":true}
{"parentUuid":"963da673-373c-4cf1-82fd-8275152a4c44","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015R2UKspFTLdAMLpkCMBmkK","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   531→            'consumos-creditos-ia.xlsx'\n   532→        );\n   533→    }\n   534→\n   535→    /**\n   536→     * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.\n   537→     *\n   538→     * Endpoint público que retorna la lista de funcionalidades habilitadas para el plan\n   539→     * activo de la empresa, según el tipo de prueba especificado.\n   540→     *\n   541→     * @param Request $request Objeto request que puede contener:\n   542→     *                         - tipo_prueba_id (int, opcional): ID del tipo de prueba.\n   543→     * @return JsonResponse Respuesta JSON con la estructura:\n   544→     *                      - data (array): Lista de funcionalidades activas del plan.\n   545→     * @author Andres Gonzalez\n   546→     */\n   547→    public function FuncionalidadesActivas(Request $request): JsonResponse {\n   548→        return new JsonResponse([\n   549→            'data' => $this->servicio->FuncionalidadesActivas($request)\n   550→        ], JsonResponse::HTTP_OK);\n   551→    }"}]},"uuid":"c37c3319-5577-4243-af64-3b4d597bd24b","timestamp":"2026-01-27T15:36:47.287Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","oldString":"    /**\n     * Datos de empresas_planes de todas las empresas como respuesta json.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.\n     * @return JsonResponse\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): JsonResponse {","newString":"    /**\n     * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.\n     *\n     * Endpoint público que retorna la lista de funcionalidades habilitadas para el plan\n     * activo de la empresa, según el tipo de prueba especificado.\n     *\n     * @param Request $request Objeto request que puede contener:\n     *                         - tipo_prueba_id (int, opcional): ID del tipo de prueba.\n     * @return JsonResponse Respuesta JSON con la estructura:\n     *                      - data (array): Lista de funcionalidades activas del plan.\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): JsonResponse {","originalFile":"<?php\n\nnamespace App\\Http\\Controllers\\Empresas;\n\nuse Exception;\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\Request;\nuse App\\Exports\\GlobalExport;\nuse Illuminate\\Http\\JsonResponse;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse Illuminate\\Support\\Facades\\Storage;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Requests\\Empresas\\AsignarPlanRequest;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Pruebas\\PerfilRepository;\nuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\nuse App\\Http\\Requests\\Empresas\\FacturarPlanRequest;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse Symfony\\Component\\HttpFoundation\\StreamedResponse;\nuse App\\Http\\Services\\IA\\ConsumoCreditoService;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\nuse App\\Http\\Repositories\\Configuraciones\\RutaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Requests\\Empresas\\DescargarEmpresasPlanesRequest;\n\nclass EmpresaPlanController extends Controller\n{\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanService $servicio Servicio de planes de empresa.\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresa.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(\n        private EmpresaPlanService $servicio,\n        private EmpresaPlanRepository $repositorio,\n        private TipoPruebaRepository $tipo_prueba_repositorio,\n        private RutaRepository $ruta_repositorio,\n        private EmpresaRepository $empresa_repositorio,\n        private UserRepository $usuario_repositorio,\n        private PruebaRepository $prueba_repositorio,\n        private PerfilRepository $perfil_repositorio,\n        private ArchivoRepository $archivo_repositorio,\n        private ConsumoCreditoService $consumo_credito_servicio\n    ) {}\n\n    /**\n     * Retornar la vista principal de los empresas_planes de todas las empresas.\n     *\n     * @return View\n     * @author Fahibram Cárcamo\n     */\n    public function index(): View {\n        // FIXME: Esta vista no debería estar en este controlador, debe estar en el controlador de consumos al igual que todo lo relacionado con ello\n        return view('empresas.empresas-planes.index')->with([\n            'rutas_menu'      => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresas_planes' => $this->repositorio->datosConsumosEmpresas(new Request()),\n            'ejecutivos'      => $this->usuario_repositorio->getEjecutivos(),\n            'pruebas'         => $this->prueba_repositorio->getTodo(new Request()),\n            'perfiles'        => $this->perfil_repositorio->getTodo(new Request())\n        ]);\n    }\n\n    /**\n     * Datos de empresas_planes de todas las empresas como respuesta json.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.\n     * @return JsonResponse\n     * @author Fahibram Cárcamo\n     * @author Daniel Beltrán\n     */\n    public function planesEmpresas(DescargarEmpresasPlanesRequest $request): JsonResponse {\n        return datatables()->of($this->repositorio->datosConsumosEmpresas($request))->toJson();\n    }\n\n    /**\n     * Exportar Excel de los datos de empresas_planes de todas las empresas.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la solicitud HTTP.\n     * @return BinaryFileResponse\n     * @author Fahibram Cárcamo\n     */\n    public function exportarExcelEmpresasPlanesEmpresas(DescargarEmpresasPlanesRequest $request): BinaryFileResponse {\n        return Excel::download(\n            new GlobalExport(\n                ['ID', 'Número de sucursales', 'Empresa', 'Ejecutivo de cuenta', 'Plan', 'Pruebas', 'Unidades', 'Ofertas laborales', 'Tiempo', 'Usuarios', 'Vigencia', 'Estado', 'Costo', 'Descuento', 'Valor de venta'],\n                $this->repositorio->datosConsumosEmpresas($request),\n                'Empresas-planes de todas las empresas',\n                'excel.empresas-planes.empresas-planes'\n            ),\n            'consumos-pruebas.xlsx'\n        );\n    }\n\n    /**\n     * Obtener los planes de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function datosTabla(int $empresa_id, Request $request): JsonResponse {\n        $request->merge([\n            'empresa_id'                            => $empresa_id,\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true,\n            'con_conteo_consumos_creditos'          => true\n        ]);\n\n        return new JsonResponse([\n            'data' => [\n                'empresas_planes'             => $this->repositorio->getTodo($request),\n                'sucursales_consumos_agendas' => $this->empresa_repositorio\n                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n                        'empresa_id'       => $empresa_id,\n                        'consumos_agendas' => true\n                    ])),\n                'sucursales_consumos_ofertas_laborales' => $this->empresa_repositorio\n                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n                        'empresa_id'                 => $empresa_id,\n                        'consumos_ofertas_laborales' => true\n                    ]))\n            ]\n        ], 200);\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function show(int $id): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->obtenerUnoConProximo($id)\n        ]);\n    }\n\n    /**\n     * Cargar la página para asignar un plan a una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function formularioAsignar(int $empresa_id): View {\n        return view('empresas.paginas.asignar-plan')->with([\n            'empresa_id'    => $empresa_id,\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresa'       => $this->empresa_repositorio->getUno($empresa_id),\n            'opcion'        => 'asignar'\n        ]);\n    }\n\n    /**\n     * Cargar la página para editar un plan de empresa.\n     *\n     * @param int $id ID de el plan de empresa.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function edit(int $id): View {\n        $empresa_plan = $this->repositorio->getUno($id);\n        return view('empresas.paginas.asignar-plan')->with([\n            'empresa_id'    => $empresa_plan->empresa_id,\n            'empresa_plan'  => $empresa_plan,\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresa'       => $this->empresa_repositorio->getUno($empresa_plan->empresa_id),\n            'opcion'        => 'editar'\n        ]);\n    }\n\n    /**\n     * Asignar plan a una empresa.\n     *\n     * @param AsignarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function store(AsignarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan asignado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Cargar página para facturar un plan.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function formularioFacturar(int $id): View {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        return view('empresas.paginas.asignar-plan')->with([\n            'empresa_plan'  => $empresa_plan,\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresa'       => $this->empresa_repositorio->getUno($empresa_plan->empresa_id),\n            'opcion'        => 'facturar'\n        ]);\n    }\n\n    /**\n     * Facturar plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param FacturarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, FacturarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan facturado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->facturar($id, $request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por plan.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @param int|null $empresa_id Id de la empresa.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function historialRecompras(Request $request, int $empresa_id = null): JsonResponse {\n        if (!is_null($empresa_id)) {\n            $request->merge(compact('empresa_id'));\n        }\n\n        return datatables()->of($this->servicio->historialRecompras($request))->toJson();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->historialComprasCreditos($empresa_id, $request)\n        ], JsonResponse::HTTP_OK);\n    }\n\n    /**\n     * Exportar Excel del historial de recompras.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return BinaryFileResponse\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function exportarExcelHistorialRecompras(Request $request): BinaryFileResponse {\n        return Excel::download(\n            // Por el momento no se mostrará el conteo de consumos ni nada relacionado con ofertas laborales.\n            new GlobalExport(\n                ['Plan', 'Plan modificado', 'Creación', 'Activación', 'Vencimiento', 'Duración', 'Uso de unidades/agendas', /* 'Consumo de ofertas laborales', */ 'Uso de usuarios', 'Uso de tiempo', 'Número de factura', 'Costo', 'Descuento', 'Valor de venta', 'Detalle de uso'],\n                $this->servicio->historialRecompras($request),\n                'Historial de recompras',\n                'excel.empresas.historial-recompras'\n            ),\n            'historial-recompras.xlsx'\n        );\n    }\n\n    /**\n     * Exportar Excel del historial de compras de créditos de IA.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @author Jair Carvajal\n     */\n    public function exportarExcelHistorialCreditos(int $empresa_id, Request $request): BinaryFileResponse {\n        return Excel::download(\n            new GlobalExport(\n                ['Plan', 'Creación', 'Activación', 'Vencimiento', 'Duración', 'Créditos totales', 'Créditos consumidos', 'Créditos restantes', 'Uso de créditos', 'Uso de tiempo', 'Número de factura', 'Costo', 'Descuento', 'Valor de venta', 'Estado', 'Detalle de uso'],\n                $this->servicio->historialComprasCreditos($empresa_id, $request),\n                'Historial de créditos IA',\n                'excel.empresas.historial-creditos'\n            ),\n            'historial-creditos-ia.xlsx'\n        );\n    }\n\n    /**\n     * Inactivar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function inactivar(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan inactivado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, ['estado_id' => 2]);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param AsignarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function update(int $id, AsignarPlanRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['id' => $id]);\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function actualizarInformacion(int $id, Request $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, $request->except('_token', '_method'));\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Envíar la notificación de solicitud de renovación de plan.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return JsonResponse\n     * @author Fahibram Cárcamo\n     */\n    public function solicitudRenovacionPlan(Request $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = ['message' => 'Solicitud de renovación de plan enviada correctamente'];\n\n        try {\n            $this->servicio->solicitarRenovacionPlan($request);\n        } catch (Exception $error) {\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage(),\n                'trace'   => $error->getTrace()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Descargar archivo de factura de plan.\n     *\n     * @param int $id Id del archivo de la factura.\n     * @return StreamedResponse\n     * @author Fahibram Cárcamo\n     */\n    public function descargarFactura(int $archivo_id): StreamedResponse {\n        $archivo_factura = $this->archivo_repositorio->getUno($archivo_id);\n        return Storage::download($archivo_factura->ruta);\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): JsonResponse {\n        $datos = $this->servicio->creditosDisponiblesEmpresa($empresa_id, $request);\n\n        if (!$datos) {\n            return new JsonResponse([\n                'message' => 'Plan de empresa no encontrado'\n            ], JsonResponse::HTTP_NOT_FOUND);\n        }\n\n        return new JsonResponse([\n            'data' => $datos\n        ], JsonResponse::HTTP_OK);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author José Manuel Jiménez\n     * @author Jair Carvajal\n     */\n    public function historialConsumosCreditos(int $empresa_id, Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->consumo_credito_servicio->historialConsumosEmpresa(\n                $empresa_id,\n                $request->only(['desde', 'hasta', 'servicio_ia_id', 'usuario_id'])\n            )\n        ], JsonResponse::HTTP_OK);\n    }\n\n     /**\n     * Exportar Excel del consumo de créditos IA.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return BinaryFileResponse\n     * @author Esperanza Olivo\n     * @author Jair Carvajal\n     */\n    public function exportarExcelConsumosCreditosIA(int $empresa_id, Request $request): BinaryFileResponse {\n\n        return Excel::download(\n            new GlobalExport(\n                ['Usuario', 'Servicio', 'Créditos', 'Fecha consumo'],\n                $this->consumo_credito_servicio->historialConsumosEmpresa($empresa_id,  $request->only(['desde', 'hasta', 'servicio_ia_id', 'usuario_id', 'ids_consumos'])),\n                'Consumos Créditos IA',\n                'excel.empresas.consumos-creditos-ia'\n            ),\n            'consumos-creditos-ia.xlsx'\n        );\n    }\n\n    /**\n     * Datos de empresas_planes de todas las empresas como respuesta json.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.\n     * @return JsonResponse\n     * @author Andres Gonzalez\n     */\n    public function FuncionalidadesActivas(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->FuncionalidadesActivas($request)\n        ], JsonResponse::HTTP_OK);\n    }\n}\n    ","structuredPatch":[{"oldStart":533,"oldLines":10,"newStart":533,"newLines":15,"lines":["     }"," ","     /**","-     * Datos de empresas_planes de todas las empresas como respuesta json.","+     * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.","      *","-     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.","-     * @return JsonResponse","+     * Endpoint público que retorna la lista de funcionalidades habilitadas para el plan","+     * activo de la empresa, según el tipo de prueba especificado.","+     *","+     * @param Request $request Objeto request que puede contener:","+     *                         - tipo_prueba_id (int, opcional): ID del tipo de prueba.","+     * @return JsonResponse Respuesta JSON con la estructura:","+     *                      - data (array): Lista de funcionalidades activas del plan.","      * @author Andres Gonzalez","      */","     public function FuncionalidadesActivas(Request $request): JsonResponse {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"963da673-373c-4cf1-82fd-8275152a4c44"}
{"parentUuid":"c37c3319-5577-4243-af64-3b4d597bd24b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SyYZvo6AhQEgDYUvfKnddZ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"La documentación del controlador ha sido actualizada correctamente. Ahora tanto el servicio como el controlador tienen documentación precisa y consistente.","signature":"EsYCCkYICxgCKkBYJ/Sg/aO5Lz68qx2v5ySoWVgNRtbd4RWX3xH0TM+1zepnHZ6yyvc+2XZ5l2dfuoPQ3DaOmoCd+sh/QEYQfKENEgwrg/iundHUDOtKqBEaDId2ktUgk1f1BErGkSIwcoAHEDdgP8FH+a/3t6F8ZV3PKq2ddYiPLvMbGQNycOVmea3nwp/0o+vHQQmRsw14Kq0B63rSQxUomxpaVf7ASyecHRE2ICJnAuryj6iImrmUDLjHD3BUa+vq0g0O2WAREcfUCRbH3hzLX6Kx1H/54NwTMQzetRYT9E7nJcGnxvTQtHzgD1EqNuj3/wWInRvgbniw+JPz6EiURb7vsxHNg3DnMutRVacDExXJW+Q0P/OJbnRLOROCqIMLeEMGD59w+f6hVV6yGlBnRz7HtRD9R4a+0SGV5KQ8sChTUegNdKMYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":898,"cache_read_input_tokens":57379,"cache_creation":{"ephemeral_5m_input_tokens":898,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXY8XQ7gTphBaxSUH1vkE","type":"assistant","uuid":"a21bd92c-013d-4f91-b534-5ec200a5f833","timestamp":"2026-01-27T15:36:51.729Z"}
{"parentUuid":"a21bd92c-013d-4f91-b534-5ec200a5f833","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SyYZvo6AhQEgDYUvfKnddZ","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He corregido la documentación en el controlador también. La documentación anterior era incorrecta (mencionaba \"Datos de empresas_planes de todas las empresas\" y un parámetro `DescargarEmpresasPlanesRequest` que no correspondía).\n\nAhora ambas funciones tienen documentación consistente:\n\n| Archivo | Descripción |\n|---------|-------------|\n| [EmpresaPlanController.php:547](app/Http/Controllers/Empresas/EmpresaPlanController.php#L547) | Endpoint que retorna JSON con las funcionalidades |\n| [EmpresaPlanService.php:770](app/Http/Services/Empresas/EmpresaPlanService.php#L770) | Lógica de negocio que obtiene las funcionalidades |"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":898,"cache_read_input_tokens":57379,"cache_creation":{"ephemeral_5m_input_tokens":898,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXY8XQ7gTphBaxSUH1vkE","type":"assistant","uuid":"271f8458-7fb0-49d1-8d51-69ce9b7479a8","timestamp":"2026-01-27T15:36:54.082Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-27T16:00:42.566Z","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a"}
{"type":"file-history-snapshot","messageId":"2ed7136f-5991-4724-8d33-27bdf8f2c922","snapshot":{"messageId":"2ed7136f-5991-4724-8d33-27bdf8f2c922","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v3","version":3,"backupTime":"2026-01-27T16:00:46.237Z"},"app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php":{"backupFileName":"71d1198be92c5143@v2","version":2,"backupTime":"2026-01-27T16:00:46.251Z"}},"timestamp":"2026-01-27T16:00:46.219Z"},"isSnapshotUpdate":false}
{"parentUuid":"9e9ecc10-2d3c-4059-ae92-d8cbe7b45534","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01FPHVN3bZEo4NSh5vpSGWtY","parentToolUseID":"toolu_01FPHVN3bZEo4NSh5vpSGWtY","uuid":"6f08209e-ffa4-4b8e-a0d0-949a43674617","timestamp":"2026-01-27T15:36:06.828Z"}
{"parentUuid":"13054502-ca3d-41a1-bbcb-ee43f8d02f32","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01FPHVN3bZEo4NSh5vpSGWtY","toolUseID":"toolu_01FPHVN3bZEo4NSh5vpSGWtY","timestamp":"2026-01-27T15:36:07.903Z","uuid":"6ad98f3c-eb44-452c-ac68-b44187d8e32a"}
{"parentUuid":"963da673-373c-4cf1-82fd-8275152a4c44","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_015R2UKspFTLdAMLpkCMBmkK","parentToolUseID":"toolu_015R2UKspFTLdAMLpkCMBmkK","uuid":"4c5c0197-07f0-47ae-892f-e7c21808b04f","timestamp":"2026-01-27T15:36:15.770Z"}
{"parentUuid":"4c5c0197-07f0-47ae-892f-e7c21808b04f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_015R2UKspFTLdAMLpkCMBmkK","parentToolUseID":"toolu_015R2UKspFTLdAMLpkCMBmkK","uuid":"35ed6af7-9341-4650-9ad8-526d050f7973","timestamp":"2026-01-27T15:36:15.771Z"}
{"parentUuid":"c37c3319-5577-4243-af64-3b4d597bd24b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_015R2UKspFTLdAMLpkCMBmkK","toolUseID":"toolu_015R2UKspFTLdAMLpkCMBmkK","timestamp":"2026-01-27T15:36:47.288Z","uuid":"22ab4dde-bbcb-4c13-a825-3d61d775bbfa"}
{"parentUuid":"271f8458-7fb0-49d1-8d51-69ce9b7479a8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"hola naliza este js public\\js\\plantillas-correos\\index.js"}]},"uuid":"2ed7136f-5991-4724-8d33-27bdf8f2c922","timestamp":"2026-01-27T16:00:46.214Z","permissionMode":"default"}
{"parentUuid":"2ed7136f-5991-4724-8d33-27bdf8f2c922","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GE3akhzWpkheN7N2Hdcw6h","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que analice el archivo JavaScript de plantillas de correos. Voy a leerlo.","signature":"EoMCCkYICxgCKkDyxQTeS2pAzxRw2PcxEBrajTdEW3f92v0vyJZjXWFPb+/RsAf6BB7hd1QaLrg6Ianstc97JlRn5j42HbMPf/N3EgwdHezTc9ldSQDeiEUaDCJHy4A4zhI7Xv0/JSIwL5lIPhjBpwV79kWNxs2yF+mCRhJ+gtIDf4Hz4rTSkD0FWVtRoMe6IVXk1Z+RwAVLKmuziocFNtViKKMKQDfPQvytcM2v98+FVJ6rTFtM9vdnI4lTi6lm1gY8q7y5k7/0bVQJoI3JLr6ConasKjXZevYvv/T4dj0DBShP9iaz4wpVS0KqKvexCw6Fq/HbLQrhBIj+i2MgaQ5QcgaX3RgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":59174,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":59174,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CXYAMLtfQ8gmFTZu1HkNb","type":"assistant","uuid":"f2c07e36-090a-451b-818f-cbeb77e9612a","timestamp":"2026-01-27T16:00:49.562Z"}
{"parentUuid":"f2c07e36-090a-451b-818f-cbeb77e9612a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GE3akhzWpkheN7N2Hdcw6h","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a leer el archivo para analizarlo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":59174,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":59174,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CXYAMLtfQ8gmFTZu1HkNb","type":"assistant","uuid":"6e4b4923-0949-4064-9509-ca83b651ad0c","timestamp":"2026-01-27T16:00:49.895Z"}
{"parentUuid":"6e4b4923-0949-4064-9509-ca83b651ad0c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GE3akhzWpkheN7N2Hdcw6h","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WDvYTwXsZBV3m7BHYAZd6x","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":59174,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":59174,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CXYAMLtfQ8gmFTZu1HkNb","type":"assistant","uuid":"28668294-89c8-4f87-a27b-aa752ff8a7a9","timestamp":"2026-01-27T16:00:50.271Z"}
{"parentUuid":"28668294-89c8-4f87-a27b-aa752ff8a7a9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WDvYTwXsZBV3m7BHYAZd6x","type":"tool_result","content":"     1→var datos_ids = [];\n     2→var nombre_tabla = 'tabla-plantillas';\n     3→var plantillaSeleccionada = [];\n     4→\n     5→$(`#${nombre_tabla}`).DataTable({\n     6→    ...configuracion_tablas,\n     7→    ajax: {\n     8→        url : `/listado-plantillas-correos`,\n     9→        data: function (datos) {\n    10→            datos.grupo_id = $('#listado_grupos_plantillas button.active').val();\n    11→            datos.empresa_id = EMPRESA_ID_PLANTILLAS;\n    12→        },\n    13→        dataSrc: function (json) {\n    14→            return Object.values(json.data);\n    15→        }\n    16→    },\n    17→    columns: [\n    18→        {\n    19→            data: null,\n    20→            orderable : false,\n    21→            render: (dato) => {\n    22→                return `\n    23→                    <div class=\"card rounded tarjeta-plantilla\">\n    24→                        <div class=\"card-body p-0 pointer rounded-top cuerpo-tarjeta-plantilla\" data-value=\"${dato.id}\">\n    25→                            <div class=\"position-relative\">\n    26→                                <img src=\"/imagenes/plantilla/encabezado_header.svg\" alt=\"Logo Plantilla\" class=\"rounded-top imagen-encabezado-plantilla\">\n    27→                                <img src=\"/imagenes/plantilla/logo_plataformas_evaluacion.svg\" alt=\"Logo Plantilla\" class=\"position-absolute imagen-logo-plantilla\">\n    28→                            </div>\n    29→                            <div class=\"px-3 contenido-plantilla\">\n    30→                                <p class=\"text-center\">Empresa</p>\n    31→                                <p class=\"fw-bold\">${dato.titulo}</p>\n    32→                                <p class=\"\">${dato.contenido}</p>\n    33→                            </div>\n    34→                        </div>\n    35→                        <div class=\"card-footer pie-tarjeta-plantilla\">\n    36→                            <div class=\"d-flex\">\n    37→                                <div class=\"col-10 my-auto\">\n    38→                                    <span class=\"text-headline-5 text-gray-10 my-auto\">${dato.nombre}</span>\n    39→                                </div>\n    40→                                <div class=\"col-auto\">\n    41→                                    ${crearBoton({\n    42→                                        adicional: `data-value=\"${dato.id}\"`,\n    43→                                        clases: 'btn-primary btn-circle boton-editar-modal',\n    44→                                        texto: `\n    45→                                            <svg width=\"19\" height=\"19\" viewBox=\"0 0 19 19\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n    46→                                                <path d=\"M18.2695 2.59877C18.5768 2.9061 18.5768 3.40438 18.2695 3.71171L16.628 5.35315L13.4801 2.20527L15.1216 0.56383C15.4289 0.256499 15.9272 0.256499 16.2345 0.563831L18.2695 2.59877Z\" fill=\"white\"/>\n    47→                                                <path d=\"M15.5151 6.46609L12.3672 3.31821L1.64394 14.0415C1.55755 14.1279 1.49246 14.2332 1.45383 14.3491L0.187499 18.1481C0.0849619 18.4557 0.377613 18.7483 0.685223 18.6458L4.48422 17.3795C4.60012 17.3408 4.70544 17.2757 4.79183 17.1893L15.5151 6.46609Z\" fill=\"white\"/>\n    48→                                            </svg>\n    49→                                        `\n    50→                                    })}\n    51→                                </div>\n    52→                            </div>\n    53→                        </div>\n    54→                    </div>\n    55→                `;\n    56→            }\n    57→        }\n    58→    ],\n    59→    drawCallback: function(settings) {\n    60→        datos_ids = $(`#${nombre_tabla}`).DataTable().data().toArray();\n    61→        inicializarTooltips();\n    62→    },\n    63→    initComplete: function(settings, json) {\n    64→        datos_ids = $(`#${nombre_tabla}`).DataTable().data().toArray();\n    65→\n    66→        $(`#${nombre_tabla}`).find('tbody').addClass('tabla-cards-horizontal');\n    67→        $(`[aria-describedby=\"${nombre_tabla}_info\"] .thead-componente`).hide();\n    68→        inicializarTooltips();\n    69→    }\n    70→});\n    71→\n    72→$(document).ready(function() {\n    73→    console.log(configuraciones_disponibles_empresa);\n    74→    console.log(lugar);\n    75→    configurarFormulario('form-editar-plantilla');\n    76→    $(document).on('click', '.botones-grupo', function(){\n    77→        $('.botones-grupo').removeClass('active');\n    78→        $(this).addClass('active');\n    79→        actualizarDatatables(`${nombre_tabla}`);\n    80→    });\n    81→\n    82→    $(document).on('click', '.boton-editar-modal', function(){\n    83→        let id = $(this).data('value');\n    84→        $('#restablecer_texto').data('value', id);\n    85→        plantillaSeleccionada = datos_ids.find(plantilla => plantilla.id == id);\n    86→        $('#contenedor_editor_texto').html(`\n    87→            ${crearEditorTexto({\n    88→                adicional: `data-botonadicional=\"botonAdicionalCkeditor\"`,\n    89→                class: 'classic-editor-opciones',\n    90→                id: 'descripcion_mensaje',\n    91→                input_container_class: 'mb-4',\n    92→                maxlength: 16350,\n    93→                name: 'descripcion_mensaje',\n    94→                required: true\n    95→            })}\n    96→            `);\n    97→            inicializarClassicEditor();\n    98→        $('#titulo-plantilla-modal').html(plantillaSeleccionada.nombre);\n    99→        $('#titulo_mensaje_plantilla').val(plantillaSeleccionada.titulo);\n   100→        $('#id').val(plantillaSeleccionada.id);\n   101→        $('#grupo_id').val(plantillaSeleccionada.grupo_id);\n   102→        if (plantillaSeleccionada.con_logo_empresa == '1') $('#con_logo').prop('checked', true);\n   103→        else $('#con_logo').prop('checked', false);\n   104→        $('#texto_boton').val(plantillaSeleccionada.texto_boton);\n   105→        $('#enlace_boton').val(plantillaSeleccionada.enlace_boton);\n   106→        $('#modal-editar-plantilla').modal('show');\n   107→\n   108→        // Agregar el ID de la empresa y de la plantilla de correo, el segundo se envía solo cuando la empresa actual es diferente a Psicoalianza\n   109→        $('#empresa_id').val(EMPRESA_ID_PLANTILLAS);\n   110→\n   111→        if (EMPRESA_ID_PLANTILLAS !== PSICOALIANZA_ID) {\n   112→            const PLANTILLA_CORREO_ID = plantillaSeleccionada.plantilla_correo_id !== null ? plantillaSeleccionada.plantilla_correo_id : plantillaSeleccionada.id;\n   113→            $('#plantilla_correo_id').val(PLANTILLA_CORREO_ID);\n   114→        }\n   115→    });\n   116→\n   117→    $(document).on('click', '.cuerpo-tarjeta-plantilla', function(){\n   118→        let id = $(this).data('value');\n   119→        let previsualiazcion_plantilla = datos_ids.find(plantilla => plantilla.id == id);\n   120→\n   121→        $('#titulo_previsualizar').html(previsualiazcion_plantilla.titulo);\n   122→        $('#contenido_previsualizar').html(previsualiazcion_plantilla.contenido);\n   123→        $('#modal-previsualizacion').modal('show');\n   124→    });\n   125→\n   126→    $(document).on('click', '#restablecer_texto', function () {\n   127→        let id = $(this).data('value');\n   128→\n   129→        $.ajax({\n   130→            url: `/plantillas-correos-restablecer/${id}`,\n   131→            type: 'PUT',\n   132→            headers: {\n   133→                'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n   134→            },\n   135→            success: function(response) {\n   136→                actualizarDatatables(`${nombre_tabla}`);\n   137→                mostrarToast('success', response.message);\n   138→                $('#modal-editar-plantilla').modal('hide');\n   139→            },\n   140→            error: function(xhr) {\n   141→                mostrarToast('danger', 'Error al restablecer la plantilla');\n   142→            }\n   143→        });\n   144→    });\n   145→});\n   146→\n   147→/**\n   148→ * Validar campos de enlace.\n   149→ *\n   150→ * Si el campo de texto_boton está diligenciado, el campo enlace_boton se vuelve obligatorio y viceversa.\n   151→ *\n   152→ * @returns {void}\n   153→ * @author Daniel Beltrán\n   154→ */\n   155→function validarCamposEnlace() {\n   156→    if (!['', null].includes($('#texto_boton').val().trim()) || !['', null].includes($('#enlace_boton').val().trim())) {\n   157→        $('#texto_boton').prop('required', true).trigger('change');\n   158→        $('#enlace_boton').prop('required', true).trigger('change');\n   159→    } else {\n   160→        $('#texto_boton').prop('required', false).trigger('change');\n   161→        $('#enlace_boton').prop('required', false).trigger('change');\n   162→    }\n   163→}\n   164→\n   165→/**\n   166→ * Validar el formulario antes de enviarlo.\n   167→ *\n   168→ * @returns {boolean}\n   169→ * @author Andres Morales\n   170→ */\n   171→function validacionAdicional(formulario) {\n   172→    $('#contenido').val($(`#descripcion_mensaje`).data('editor').getData());\n   173→    $('#con_logo_empresa').val($(`#con_logo`).is(':checked') ? 1 : 0);\n   174→    return true;\n   175→}\n   176→\n   177→/**\n   178→ * función para ejecutar algo después de enviar el formulario.\n   179→ *\n   180→ * @param {object} respuesta Respuesta del servidor.\n   181→ * @returns {void}\n   182→ * @autor Andres Morales\n   183→ */\n   184→\n   185→function postSuccess(respuesta) {\n   186→    actualizarDatatables(`${nombre_tabla}`);\n   187→    $('#modal-editar-plantilla').modal('hide');\n   188→    mostrarToast('success', respuesta.message);\n   189→}\n   190→\n   191→/**\n   192→ * Crear boton adicional para ckeditor.\n   193→ *\n   194→ * @returns {html} botón adicional para ckeditor.\n   195→ * @author Andres Morales\n   196→ */\n   197→function botonAdicionalCkeditor(id) {\n   198→    $(`#${id}`).data('editor').setData(plantillaSeleccionada.contenido);\n   199→    if (!plantillaSeleccionada?.variables?.length) return '';\n   200→\n   201→    const opcionesVariables = plantillaSeleccionada.variables\n   202→        .map(variable => `<button type=\"button\" class=\"dropdown-item-ckeditor p-2\" onclick=\"agregarVariable('${id}', '__${variable.llave}__')\">${variable.valor}</button>`)\n   203→        .join('');\n   204→\n   205→    return `\n   206→        <div class=\"border-start border-black border-2 px-2 my-0 dropdown\">\n   207→            ${crearBoton({\n   208→                clases: 'dropdown-toggle text-body-3 btn-dropdown-ckeditor',\n   209→                texto: 'Agregar variable<i class=\"bi bi-chevron-down text-body-3 ms-2\"></i>',\n   210→                data: [{texto: 'bs-toggle', value: 'dropdown'},{texto: 'bs-auto-close', value: 'outside'},]\n   211→            })}\n   212→            <div class=\"dropdown-menu bg-white\">${opcionesVariables}</div>\n   213→        </div>\n   214→    `;\n   215→}\n   216→\n   217→/**\n   218→ * Agrega la variable en cuestion en el ckeditor.\n   219→ *\n   220→ * @returns {void}\n   221→ * @author Andres Morales\n   222→ */\n   223→function agregarVariable(id, variable) {\n   224→    let texto = $(`#${id}`).data('editor').getData()\n   225→    $(`#${id}`).data('editor').setData(texto + variable);\n   226→}\n   227→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0c1bfff6-a5ab-487d-95c8-d9d2fc1f2451","timestamp":"2026-01-27T16:00:51.533Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js","content":"var datos_ids = [];\nvar nombre_tabla = 'tabla-plantillas';\nvar plantillaSeleccionada = [];\n\n$(`#${nombre_tabla}`).DataTable({\n    ...configuracion_tablas,\n    ajax: {\n        url : `/listado-plantillas-correos`,\n        data: function (datos) {\n            datos.grupo_id = $('#listado_grupos_plantillas button.active').val();\n            datos.empresa_id = EMPRESA_ID_PLANTILLAS;\n        },\n        dataSrc: function (json) {\n            return Object.values(json.data);\n        }\n    },\n    columns: [\n        {\n            data: null,\n            orderable : false,\n            render: (dato) => {\n                return `\n                    <div class=\"card rounded tarjeta-plantilla\">\n                        <div class=\"card-body p-0 pointer rounded-top cuerpo-tarjeta-plantilla\" data-value=\"${dato.id}\">\n                            <div class=\"position-relative\">\n                                <img src=\"/imagenes/plantilla/encabezado_header.svg\" alt=\"Logo Plantilla\" class=\"rounded-top imagen-encabezado-plantilla\">\n                                <img src=\"/imagenes/plantilla/logo_plataformas_evaluacion.svg\" alt=\"Logo Plantilla\" class=\"position-absolute imagen-logo-plantilla\">\n                            </div>\n                            <div class=\"px-3 contenido-plantilla\">\n                                <p class=\"text-center\">Empresa</p>\n                                <p class=\"fw-bold\">${dato.titulo}</p>\n                                <p class=\"\">${dato.contenido}</p>\n                            </div>\n                        </div>\n                        <div class=\"card-footer pie-tarjeta-plantilla\">\n                            <div class=\"d-flex\">\n                                <div class=\"col-10 my-auto\">\n                                    <span class=\"text-headline-5 text-gray-10 my-auto\">${dato.nombre}</span>\n                                </div>\n                                <div class=\"col-auto\">\n                                    ${crearBoton({\n                                        adicional: `data-value=\"${dato.id}\"`,\n                                        clases: 'btn-primary btn-circle boton-editar-modal',\n                                        texto: `\n                                            <svg width=\"19\" height=\"19\" viewBox=\"0 0 19 19\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                                                <path d=\"M18.2695 2.59877C18.5768 2.9061 18.5768 3.40438 18.2695 3.71171L16.628 5.35315L13.4801 2.20527L15.1216 0.56383C15.4289 0.256499 15.9272 0.256499 16.2345 0.563831L18.2695 2.59877Z\" fill=\"white\"/>\n                                                <path d=\"M15.5151 6.46609L12.3672 3.31821L1.64394 14.0415C1.55755 14.1279 1.49246 14.2332 1.45383 14.3491L0.187499 18.1481C0.0849619 18.4557 0.377613 18.7483 0.685223 18.6458L4.48422 17.3795C4.60012 17.3408 4.70544 17.2757 4.79183 17.1893L15.5151 6.46609Z\" fill=\"white\"/>\n                                            </svg>\n                                        `\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                `;\n            }\n        }\n    ],\n    drawCallback: function(settings) {\n        datos_ids = $(`#${nombre_tabla}`).DataTable().data().toArray();\n        inicializarTooltips();\n    },\n    initComplete: function(settings, json) {\n        datos_ids = $(`#${nombre_tabla}`).DataTable().data().toArray();\n\n        $(`#${nombre_tabla}`).find('tbody').addClass('tabla-cards-horizontal');\n        $(`[aria-describedby=\"${nombre_tabla}_info\"] .thead-componente`).hide();\n        inicializarTooltips();\n    }\n});\n\n$(document).ready(function() {\n    console.log(configuraciones_disponibles_empresa);\n    console.log(lugar);\n    configurarFormulario('form-editar-plantilla');\n    $(document).on('click', '.botones-grupo', function(){\n        $('.botones-grupo').removeClass('active');\n        $(this).addClass('active');\n        actualizarDatatables(`${nombre_tabla}`);\n    });\n\n    $(document).on('click', '.boton-editar-modal', function(){\n        let id = $(this).data('value');\n        $('#restablecer_texto').data('value', id);\n        plantillaSeleccionada = datos_ids.find(plantilla => plantilla.id == id);\n        $('#contenedor_editor_texto').html(`\n            ${crearEditorTexto({\n                adicional: `data-botonadicional=\"botonAdicionalCkeditor\"`,\n                class: 'classic-editor-opciones',\n                id: 'descripcion_mensaje',\n                input_container_class: 'mb-4',\n                maxlength: 16350,\n                name: 'descripcion_mensaje',\n                required: true\n            })}\n            `);\n            inicializarClassicEditor();\n        $('#titulo-plantilla-modal').html(plantillaSeleccionada.nombre);\n        $('#titulo_mensaje_plantilla').val(plantillaSeleccionada.titulo);\n        $('#id').val(plantillaSeleccionada.id);\n        $('#grupo_id').val(plantillaSeleccionada.grupo_id);\n        if (plantillaSeleccionada.con_logo_empresa == '1') $('#con_logo').prop('checked', true);\n        else $('#con_logo').prop('checked', false);\n        $('#texto_boton').val(plantillaSeleccionada.texto_boton);\n        $('#enlace_boton').val(plantillaSeleccionada.enlace_boton);\n        $('#modal-editar-plantilla').modal('show');\n\n        // Agregar el ID de la empresa y de la plantilla de correo, el segundo se envía solo cuando la empresa actual es diferente a Psicoalianza\n        $('#empresa_id').val(EMPRESA_ID_PLANTILLAS);\n\n        if (EMPRESA_ID_PLANTILLAS !== PSICOALIANZA_ID) {\n            const PLANTILLA_CORREO_ID = plantillaSeleccionada.plantilla_correo_id !== null ? plantillaSeleccionada.plantilla_correo_id : plantillaSeleccionada.id;\n            $('#plantilla_correo_id').val(PLANTILLA_CORREO_ID);\n        }\n    });\n\n    $(document).on('click', '.cuerpo-tarjeta-plantilla', function(){\n        let id = $(this).data('value');\n        let previsualiazcion_plantilla = datos_ids.find(plantilla => plantilla.id == id);\n\n        $('#titulo_previsualizar').html(previsualiazcion_plantilla.titulo);\n        $('#contenido_previsualizar').html(previsualiazcion_plantilla.contenido);\n        $('#modal-previsualizacion').modal('show');\n    });\n\n    $(document).on('click', '#restablecer_texto', function () {\n        let id = $(this).data('value');\n\n        $.ajax({\n            url: `/plantillas-correos-restablecer/${id}`,\n            type: 'PUT',\n            headers: {\n                'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n            },\n            success: function(response) {\n                actualizarDatatables(`${nombre_tabla}`);\n                mostrarToast('success', response.message);\n                $('#modal-editar-plantilla').modal('hide');\n            },\n            error: function(xhr) {\n                mostrarToast('danger', 'Error al restablecer la plantilla');\n            }\n        });\n    });\n});\n\n/**\n * Validar campos de enlace.\n *\n * Si el campo de texto_boton está diligenciado, el campo enlace_boton se vuelve obligatorio y viceversa.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction validarCamposEnlace() {\n    if (!['', null].includes($('#texto_boton').val().trim()) || !['', null].includes($('#enlace_boton').val().trim())) {\n        $('#texto_boton').prop('required', true).trigger('change');\n        $('#enlace_boton').prop('required', true).trigger('change');\n    } else {\n        $('#texto_boton').prop('required', false).trigger('change');\n        $('#enlace_boton').prop('required', false).trigger('change');\n    }\n}\n\n/**\n * Validar el formulario antes de enviarlo.\n *\n * @returns {boolean}\n * @author Andres Morales\n */\nfunction validacionAdicional(formulario) {\n    $('#contenido').val($(`#descripcion_mensaje`).data('editor').getData());\n    $('#con_logo_empresa').val($(`#con_logo`).is(':checked') ? 1 : 0);\n    return true;\n}\n\n/**\n * función para ejecutar algo después de enviar el formulario.\n *\n * @param {object} respuesta Respuesta del servidor.\n * @returns {void}\n * @autor Andres Morales\n */\n\nfunction postSuccess(respuesta) {\n    actualizarDatatables(`${nombre_tabla}`);\n    $('#modal-editar-plantilla').modal('hide');\n    mostrarToast('success', respuesta.message);\n}\n\n/**\n * Crear boton adicional para ckeditor.\n *\n * @returns {html} botón adicional para ckeditor.\n * @author Andres Morales\n */\nfunction botonAdicionalCkeditor(id) {\n    $(`#${id}`).data('editor').setData(plantillaSeleccionada.contenido);\n    if (!plantillaSeleccionada?.variables?.length) return '';\n\n    const opcionesVariables = plantillaSeleccionada.variables\n        .map(variable => `<button type=\"button\" class=\"dropdown-item-ckeditor p-2\" onclick=\"agregarVariable('${id}', '__${variable.llave}__')\">${variable.valor}</button>`)\n        .join('');\n\n    return `\n        <div class=\"border-start border-black border-2 px-2 my-0 dropdown\">\n            ${crearBoton({\n                clases: 'dropdown-toggle text-body-3 btn-dropdown-ckeditor',\n                texto: 'Agregar variable<i class=\"bi bi-chevron-down text-body-3 ms-2\"></i>',\n                data: [{texto: 'bs-toggle', value: 'dropdown'},{texto: 'bs-auto-close', value: 'outside'},]\n            })}\n            <div class=\"dropdown-menu bg-white\">${opcionesVariables}</div>\n        </div>\n    `;\n}\n\n/**\n * Agrega la variable en cuestion en el ckeditor.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction agregarVariable(id, variable) {\n    let texto = $(`#${id}`).data('editor').getData()\n    $(`#${id}`).data('editor').setData(texto + variable);\n}\n","numLines":227,"startLine":1,"totalLines":227}},"sourceToolAssistantUUID":"28668294-89c8-4f87-a27b-aa752ff8a7a9"}
{"parentUuid":"0c1bfff6-a5ab-487d-95c8-d9d2fc1f2451","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PotD3P7zvTnYgdKFv6haYo","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora tengo el archivo completo. Voy a analizarlo y proporcionar un resumen detallado de su estructura y funcionalidad.","signature":"EqACCkYICxgCKkBFl4tZR+wOtD6KIvWEkUDH3Z/mguFrJhIU0KCBlXDl65hpXvXcsF/J6lmcrWYT28J2ldnfZc+vZXoIBBE8w8DVEgy2qtQcwStffLu0Wm4aDKKRwFjDyOoY42NGuyIwzPuTtEZNmmwrqhGAK48UQ2cMNWpam95Y+PjRjsxIkJCxmCL8r8OTrIZhPaTE2YU6KocBDF9v0MX2XnbVtx5efv0i7u4Mzf78CC7/oFpjAlYf3ktTqu76G/hzQvaQ2JhL8zKbdGL1DP0HJtA8IFt3G4PJZuGHPti+WKf8+g2imKGYmqKodCfsq+a3+yH4+rZS1xronue/sF36T/fmW5jwJ0xs1rU4Z7OkN2TylDmzc36NLgQc0JvWwEelGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3900,"cache_read_input_tokens":59174,"cache_creation":{"ephemeral_5m_input_tokens":3900,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXYAMjZRYAVwiV958rym6","type":"assistant","uuid":"b4637622-5991-4bc4-b060-44fa7e384e52","timestamp":"2026-01-27T16:00:54.660Z"}
{"parentUuid":"b4637622-5991-4bc4-b060-44fa7e384e52","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PotD3P7zvTnYgdKFv6haYo","type":"message","role":"assistant","content":[{"type":"text","text":"## Análisis de `public/js/plantillas-correos/index.js`\n\n### Resumen General\nEste archivo maneja el módulo de **gestión de plantillas de correo electrónico**, permitiendo visualizar, editar y restablecer plantillas con un editor de texto enriquecido (CKEditor).\n\n---\n\n### Estructura del Código\n\n#### 1. Variables Globales (líneas 1-3)\n```javascript\nvar datos_ids = [];              // Almacena los datos de la tabla\nvar nombre_tabla = 'tabla-plantillas';  // ID de la tabla DataTable\nvar plantillaSeleccionada = [];  // Plantilla actualmente seleccionada\n```\n\n#### 2. Configuración DataTable (líneas 5-70)\n- **AJAX**: Obtiene datos de `/listado-plantillas-correos`\n- **Filtros**: `grupo_id` y `empresa_id`\n- **Renderizado**: Tarjetas visuales con preview de la plantilla\n- **Callbacks**: Inicializa tooltips al cargar/redibujar\n\n#### 3. Event Handlers (líneas 72-145)\n\n| Evento | Selector | Acción |\n|--------|----------|--------|\n| click | `.botones-grupo` | Filtra por grupo de plantillas |\n| click | `.boton-editar-modal` | Abre modal de edición con CKEditor |\n| click | `.cuerpo-tarjeta-plantilla` | Abre modal de previsualización |\n| click | `#restablecer_texto` | Restablece plantilla a valores por defecto |\n\n#### 4. Funciones Auxiliares\n\n| Función | Líneas | Descripción |\n|---------|--------|-------------|\n| `validarCamposEnlace()` | 155-163 | Valida que texto_boton y enlace_boton sean ambos requeridos si uno tiene valor |\n| `validacionAdicional()` | 171-175 | Prepara datos del formulario antes de enviar (contenido CKEditor, logo) |\n| `postSuccess()` | 185-189 | Actualiza tabla y muestra toast de éxito |\n| `botonAdicionalCkeditor()` | 197-215 | Crea dropdown de variables dinámicas para insertar en el editor |\n| `agregarVariable()` | 223-226 | Inserta variable seleccionada en el CKEditor |\n\n---\n\n### Flujo de Edición\n1. Usuario hace clic en botón editar → `boton-editar-modal`\n2. Se carga el CKEditor con `crearEditorTexto()`\n3. Se poblan los campos del formulario con datos de la plantilla\n4. Si la empresa no es PsicoAlianza, se maneja `plantilla_correo_id`\n5. Al guardar, `validacionAdicional()` extrae datos del CKEditor\n6. `postSuccess()` actualiza la tabla y cierra el modal\n\n---\n\n### Observaciones\n\n**Posible mejora**: La variable `plantillaSeleccionada` está declarada como array `[]` pero se usa como objeto. Debería ser:\n```javascript\nvar plantillaSeleccionada = null;  // o {}\n```\n\n**Console.log en producción** (líneas 73-74): Hay logs de debug que deberían eliminarse:\n```javascript\nconsole.log(configuraciones_disponibles_empresa);\nconsole.log(lugar);\n```"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3900,"cache_read_input_tokens":59174,"cache_creation":{"ephemeral_5m_input_tokens":3900,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXYAMjZRYAVwiV958rym6","type":"assistant","uuid":"e8408a8c-02d7-405b-977c-aed04c08aa6b","timestamp":"2026-01-27T16:01:07.195Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-27T16:04:21.482Z","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a"}
{"type":"file-history-snapshot","messageId":"81a7c172-5e13-4d36-ab7f-afb0a45547de","snapshot":{"messageId":"81a7c172-5e13-4d36-ab7f-afb0a45547de","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v3","version":3,"backupTime":"2026-01-27T16:00:46.237Z"},"app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php":{"backupFileName":"71d1198be92c5143@v2","version":2,"backupTime":"2026-01-27T16:00:46.251Z"}},"timestamp":"2026-01-27T16:04:24.831Z"},"isSnapshotUpdate":false}
{"parentUuid":"28668294-89c8-4f87-a27b-aa752ff8a7a9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01WDvYTwXsZBV3m7BHYAZd6x","parentToolUseID":"toolu_01WDvYTwXsZBV3m7BHYAZd6x","uuid":"459fad8b-ac6f-4a20-8f9e-7f353578f49d","timestamp":"2026-01-27T16:00:50.427Z"}
{"parentUuid":"0c1bfff6-a5ab-487d-95c8-d9d2fc1f2451","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01WDvYTwXsZBV3m7BHYAZd6x","toolUseID":"toolu_01WDvYTwXsZBV3m7BHYAZd6x","timestamp":"2026-01-27T16:00:51.533Z","uuid":"7597f517-abd7-45b3-b117-289212b4d8da"}
{"parentUuid":"e8408a8c-02d7-405b-977c-aed04c08aa6b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 38 to 38 from c:\\laragon\\www\\psicoalianza-2\\public\\js\\globales.js:\nlet configuraciones_disponibles_empresa = null;\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"aquie en globales nececito crear una funcion paraobtenr las configuraciones y sobre escribir esta funcion let configuraciones_disponibles_empresa = null; y la ruta es la siguiente http://localhost/funcionalidades-activas-plan"}]},"uuid":"81a7c172-5e13-4d36-ab7f-afb0a45547de","timestamp":"2026-01-27T16:04:24.829Z","permissionMode":"default"}
{"parentUuid":"81a7c172-5e13-4d36-ab7f-afb0a45547de","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_015iWxf7XCQ3gw9TVnLQg91N","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere crear una función en el archivo globales.js que:\n1. Haga una petición AJAX a `/funcionalidades-activas-plan`\n2. Obtenga las configuraciones/funcionalidades activas del plan\n3. Sobrescriba la variable `configuraciones_disponibles_empresa`\n\nNecesito leer el archivo globales.js para entender su estructura y agregar la función de manera apropiada.","signature":"EpQECkYICxgCKkBxPpSej3FAoKve2Lk2niBCeqHnVQtd4F7dMughsa/LO9N2M8hyFAP1pszTYa7YK+Xuwcq+8zLbWpVBOvW8SfFtEgyCHAcsRGdkuKdWJmcaDCJUW7zcbTDCgA6/+SIwuhNt52Fq57oG/LBUQ9k6W16/OAOIUOc7rilweg75tmIac/eM7smQfr+c0UKaiDCLKvsCq64lRYGhjDc8p65dSw0SUYy5yB98xu814KwLy+/PsTkkxe5oo8SXX7FW4wA70dUXjx7IXS+Qtl2qPysK7Zc1fORVkR4Oxn99wgrjxkTfVVs6mXorhvG7D9f195uaiOIOmYRmAiM+tkIRU/+hEZL+3rmFvJNWC0oG4ibe5hkCHt5caACN6hnxGSTU2rq4p/K9Epx/z7tlO/r2zJwY90ojJC5T3Tc8poL1vMXwVkS2kxrtyX9rdj+l6Fk4ekjj1AbRF7ANd+AbA4wPXDFy+lgabUwskLciRiY6d9p3v5MZBpLU61FEP6eweik3QDMBdlgmb0eHmlcEgPHd3m4nxhT8TRu8pQeRUDbVPCggiSUQ/cHTNdeZcqmbCNq5KgZxpBFDSCG6wIFgJP3QdE1oyprWt76jVGTz1nlWzGBGPlD8DsSZ8roz7we/YiphSE7SMUNztcde276aEdzYhSFfhgPFgtuXNmn2U9enjufjqXzn6yTo/r/bxYZzuUOhWBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2082,"cache_read_input_tokens":63074,"cache_creation":{"ephemeral_5m_input_tokens":2082,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXYAdT6fWVp9ZMcibcwBi","type":"assistant","uuid":"fc98433f-f8e7-4e99-a788-4519057b4744","timestamp":"2026-01-27T16:04:28.428Z"}
{"parentUuid":"fc98433f-f8e7-4e99-a788-4519057b4744","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_015iWxf7XCQ3gw9TVnLQg91N","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a leer el archivo globales.js para entender su estructura y agregar la función correctamente."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2082,"cache_read_input_tokens":63074,"cache_creation":{"ephemeral_5m_input_tokens":2082,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXYAdT6fWVp9ZMcibcwBi","type":"assistant","uuid":"b93d188b-b209-4b14-87d9-f8bdc15a372f","timestamp":"2026-01-27T16:04:28.844Z"}
{"parentUuid":"b93d188b-b209-4b14-87d9-f8bdc15a372f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_015iWxf7XCQ3gw9TVnLQg91N","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LBCuPr1xiqJ1eAURVWtu6d","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\globales.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2082,"cache_read_input_tokens":63074,"cache_creation":{"ephemeral_5m_input_tokens":2082,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXYAdT6fWVp9ZMcibcwBi","type":"assistant","uuid":"ed11d322-698f-439d-89dd-93577347bfcf","timestamp":"2026-01-27T16:04:29.303Z"}
{"parentUuid":"ed11d322-698f-439d-89dd-93577347bfcf","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LBCuPr1xiqJ1eAURVWtu6d","type":"tool_result","content":"     1→// Mensajes en español para el plugin Select2\n     2→const mensajes_select2 = {\n     3→    'noResults'              : () => { return 'No hay resultados para la búsqueda.'; },\n     4→    'searching'              : () => { return 'Buscando...'; },\n     5→    'Loading'                : () => { return 'Cargando...'; },\n     6→    'loadingMore'            : () => { return 'Cargando más resultados...'; },\n     7→    'dropdownFooter'         : (texto) => { return `Mostrando ${texto} resultados`; },\n     8→    'emptyOptions'           : () => { return 'No hay opciones disponibles.'; },\n     9→    'appendItems'            : (items) => { return `Agregando ${items.length} elementos.`; },\n    10→    'maximumSelectionReached': () => { return 'Se ha alcanzado el número máximo de selecciones.'; },\n    11→    'selectOnClose'          : () => { return 'Seleccione una opción al cerrar el menú.'; },\n    12→    'escapeKeyUp'            : () => { return 'Presione \\'Escape\\' para cerrar el menú.'; },\n    13→    'errorLoading'           : () => { return 'Error al cargar datos. Inténtalo de nuevo más tarde.'; },\n    14→    'inputTooShort'          : (elemento) => { return `Ingresa al menos ${elemento.minimum} caracteres para iniciar una búsqueda.`; },\n    15→    'noMatches'              : () => { return 'No se encontraron coincidencias para tu búsqueda.'; },\n    16→    'allowClear'             : () => { return 'Borrar selección'; },\n    17→    'SelectionTooLong'       : (conteo, maximo) => { return `Solo puedes seleccionar ${maximo} opciones.`; },\n    18→    'loadMore'               : () => { return 'Cargando más resultados...'; },\n    19→    'removing'               : (seleccion) => { return 'Eliminando...'; },\n    20→    'matches'                : (coincidencias, total) => {\n    21→        if (coincidencias === 0) {\n    22→            return 'No hay coincidencias.';\n    23→        } else if (coincidencias === 1) {\n    24→            return 'Se encontró 1 coincidencia.';\n    25→        } else {\n    26→            return `Se encontraron ${coincidencias} coincidencias entre ${total}.`;\n    27→        }\n    28→    }\n    29→};\n    30→\n    31→// audios\n    32→var audio_notificacion = new Audio('/audios/notificacion.mp3');\n    33→\n    34→let mostro_modal_creditos_ia = false;\n    35→let funcion_ejecucion_ia = null;\n    36→let modals_abiertos_ia = null;\n    37→\n    38→let configuraciones_disponibles_empresa = null;\n    39→\n    40→/**\n    41→ * Mostrar modal de créditos IA\n    42→ *\n    43→ * @return void\n    44→ * @author José Manuel Jiménez\n    45→ */\n    46→function mostrarModalCreditosIA(servicio_ia_id) {\n    47→    $.ajax({\n    48→        url: `/empresas/${$('#empresa_sesion_id').val()}/creditos`,\n    49→        method: 'GET',\n    50→        dataType: 'json',\n    51→        success: function(respuesta_empresa) {\n    52→            if (respuesta_empresa?.data?.creditos_disponibles > 0) {\n    53→                $.ajax({\n    54→                    url: `/servicios-ia/${servicio_ia_id}/creditos`,\n    55→                    method: 'GET',\n    56→                    dataType: 'json',\n    57→                    success: function(respuesta) {\n    58→                        if (respuesta?.data?.consume_creditos && respuesta?.data?.consume_creditos <= respuesta_empresa.data.creditos_disponibles) {\n    59→                            $('#cantidad-creditos-descontar-modal').text(respuesta.data.consume_creditos);\n    60→                            $('#modal-consumo-creditos-ia').modal('show');\n    61→                            mostro_modal_creditos_ia = true;\n    62→                            modals_abiertos_ia = $('.modal.show').not('#modal-consumo-creditos-ia').not('#modal-generando-ia');\n    63→                            $(modals_abiertos_ia).addClass('d-none');\n    64→                        } else {\n    65→                            mostrarToastSolicitarCreditosIA();\n    66→                        }\n    67→                    }\n    68→                });\n    69→            } else {\n    70→                mostrarToastSolicitarCreditosIA();\n    71→            }\n    72→        }\n    73→    });\n    74→}\n    75→\n    76→/**\n    77→ * Mostrar toast para solicitar créditos IA\n    78→ *\n    79→ * @return void\n    80→ * @author José Manuel Jiménez\n    81→ */\n    82→function mostrarToastSolicitarCreditosIA() {\n    83→    $.ajax({\n    84→        url: `/empresas/${$('#empresa_sesion_id').val()}`,\n    85→        method: 'GET',\n    86→        dataType: 'json',\n    87→        success: function(respuesta) {\n    88→            let adicional_toast = '';\n    89→            if (respuesta?.data?.ejecutivo?.telefono) {\n    90→                adicional_toast = `<a href=\"https://wa.me/${respuesta.data.ejecutivo.telefono.replace(/\\D/g, '')}?text=Hola,%20me%20gustar%C3%ADa%20solicitar%20cr%C3%A9ditos%20adicionales%20para%20mi%20empresa.\" target=\"_blank\">\n    91→                    <p class=\"text-label-1 text-white no-visited text-decoration-none mb-0\">Solicitar</p>\n    92→                </a>`;\n    93→            }\n    94→            setTimeout(() => {\n    95→                $('#modal-generando-ia').modal('hide');\n    96→                $('#modal-cargue-ia').modal('hide');\n    97→                mostrarToast('danger', 'No cuentas con créditos. Solicita créditos adicionales.', '', adicional_toast);\n    98→            }, 300);\n    99→        }\n   100→    });\n   101→}\n   102→\n   103→/**\n   104→ * Continuar ejecución IA luego del modal de créditos\n   105→ *\n   106→ * @return void\n   107→ * @author José Manuel Jiménez\n   108→ */\n   109→function continuarEjecucionIA() {\n   110→    if (funcion_ejecucion_ia) {\n   111→        funcion_ejecucion_ia();\n   112→        funcion_ejecucion_ia = null;\n   113→    }\n   114→    mostro_modal_creditos_ia = false;\n   115→    $('#modal-consumo-creditos-ia').modal('hide');\n   116→}\n   117→\n   118→/**\n   119→ * Solicitar más créditos IA\n   120→ *\n   121→ * @return void\n   122→ * @author José Manuel Jiménez\n   123→ */\n   124→function solicitarMasCreditosIA() {\n   125→    $.ajax({\n   126→        url: `/empresas/${$('#empresa_sesion_id').val()}`,\n   127→        method: 'GET',\n   128→        dataType: 'json',\n   129→        success: function(respuesta) {\n   130→            if (respuesta?.data?.ejecutivo?.telefono) {\n   131→                window.open(`https://wa.me/${respuesta.data.ejecutivo.telefono.replace(/\\D/g, '')}?text=Hola,%20me%20gustar%C3%ADa%20solicitar%20cr%C3%A9ditos%20adicionales%20para%20mi%20empresa.`, '_blank');\n   132→            } else {\n   133→                mostrarToast('danger', 'No se encontró un ejecutivo asignado a la empresa. Por favor, comunícate con soporte para recargar créditos.');\n   134→            }\n   135→            $('#modal-solicitar-mas-creditos-ia').modal('hide');\n   136→        }\n   137→    });\n   138→}\n   139→\n   140→/**\n   141→ * Validar respuesta de créditos IA\n   142→ *\n   143→ * @return void\n   144→ * @author José Manuel Jiménez\n   145→ */\n   146→function validarRespuestaCreditosIA(error_ia) {\n   147→    if (error_ia == 'No tienes créditos disponibles en este momento. Renueva tu plan o adquiere más créditos para continuar.') {\n   148→        mostrarToastSolicitarCreditosIA();\n   149→        return true;\n   150→    }\n   151→    return false;\n   152→}\n   153→\n   154→/**\n   155→ * Ajustar el ancho de los elementos select2 asincrono multiple.\n   156→ *\n   157→ * @returns {void}\n   158→ * @author Andres Morales\n   159→ */\n   160→$(document).ready(function () {\n   161→    cargarNotificiacionesHeader();\n   162→    if (window.configuracion_reverbg && window.configuracion_reverbg.activar_websocket) {\n   163→        configurarWebSocketNotificaciones();\n   164→    }\n   165→    setTimeout(() => {\n   166→        $(\".input-container\").each(function () {\n   167→            let $container = $(this);\n   168→            let $select = $container.find(\"select[multiple]\");\n   169→            let $icon = $container.find(\".input-icono1\");\n   170→            if ($select.length && $icon.length) {\n   171→                $(this).find('.select2-selection--multiple').addClass('ps-5')\n   172→            }\n   173→        });\n   174→    }, 1000);\n   175→    $('#modal-consumo-creditos-ia').on('hidden.bs.modal', function () {\n   176→        if (mostro_modal_creditos_ia) {\n   177→            $(modals_abiertos_ia).removeClass('d-none');\n   178→        }\n   179→        mostro_modal_creditos_ia = false;\n   180→    });\n   181→\n   182→    // Cargar créditos disponibles si existe el contenedor y el ID de empresa\n   183→    if ($('#contenedor-tag-creditos').length && $('#empresa_sesion_id').length) {\n   184→        obtenerCreditosDisponiblesEmpresa($('#empresa_sesion_id').val());\n   185→    }\n   186→});\n   187→\n   188→/**\n   189→ * Formatear fecha a formato dd/mm/yyyy - hh:mm AM/PM.  Ejemplo: 01/Feb/2022 - 12:00 PM\n   190→ *\n   191→ * @param {string} fecha_entrada fecha en formato ISO\n   192→ * @returns {string} fecha y hora formateada\n   193→ * @author Andres Morales\n   194→ */\n   195→function formatearFecha(fecha_entrada) {\n   196→    var fecha = new Date(fecha_entrada);\n   197→    var dia = fecha.getDate();\n   198→    var mes = fecha.toLocaleString('es-ES', { month: 'short' });\n   199→    var anio = fecha.getFullYear();\n   200→    let hora = fecha.getHours();\n   201→    let minuto = fecha.getMinutes();\n   202→    let ampm = hora >= 12 ? 'PM' : 'AM';\n   203→    hora = hora % 12 || 12;\n   204→    minuto = minuto.toString().padStart(2, '0');\n   205→    return `${dia}/${mes}/${anio} - ${hora}:${minuto} ${ampm}`;\n   206→}\n   207→\n   208→function formatearFecha2(fecha_entrada) {\n   209→    let partes = fecha_entrada.split(' ');\n   210→    let fecha = partes[0].split('-');\n   211→    let hora = partes[1];\n   212→    let fechaISO = `${fecha[2]}-${fecha[1]}-${fecha[0]}T${hora}`;\n   213→\n   214→    let date = new Date(fechaISO);\n   215→\n   216→    if (isNaN(date.getTime())) {\n   217→        return 'Fecha inválida';\n   218→    }\n   219→\n   220→    let dia = date.getDate();\n   221→    let mes = date.toLocaleString('eu-EU', { month: 'short' });\n   222→    let anio = date.getFullYear();\n   223→    return `${dia}/${mes}/${anio}`;\n   224→}\n   225→\n   226→/**\n   227→ * Opción para contraer o agrandar el menú principal\n   228→ *\n   229→ * @returns {void}\n   230→ * @author José Manuel Jiménez\n   231→ * @author Andres Morales\n   232→ */\n   233→function contraerMenu() {\n   234→    if ($('.sidebar-menu').hasClass('close')) {\n   235→        $('.sidebar-menu').removeClass('d-none');\n   236→        localStorage.setItem('opcion_menu_storage', 'abierto');\n   237→        $('#btn-collapse').attr('data-bs-original-title', 'Contraer');\n   238→        $('#btn-collapse').attr('data-bs-title', 'Contraer');\n   239→        $(\".menu-bar\").each(function() {\n   240→            $(this).removeClass(\"px-2\").addClass(\"px-5\");\n   241→        });\n   242→        $('[data-bs-toggle=\"tooltip\"]').each(function () { new bootstrap.Tooltip(this); });\n   243→        $('.lista-primary[data-bs-toggle=\"tooltip\"]').each(function () {\n   244→            var tooltip_instancia = bootstrap.Tooltip.getInstance(this);\n   245→            if (tooltip_instancia) {\n   246→                tooltip_instancia.dispose();\n   247→            }\n   248→        });\n   249→    } else {\n   250→        $('.sidebar-menu').addClass('d-none');\n   251→        localStorage.setItem('opcion_menu_storage', 'cerrado');\n   252→        $('#btn-collapse').attr('data-bs-original-title', 'Expandir');\n   253→        $('#btn-collapse').attr('data-bs-title', 'Expandir');\n   254→        $(\".menu-bar\").each(function() {\n   255→            $(this).removeClass(\"px-5\").addClass(\"px-2\");\n   256→        });\n   257→        $('[data-bs-toggle=\"tooltip\"]').each(function () { new bootstrap.Tooltip(this); });\n   258→    }\n   259→    $('.tooltip.bs-tooltip-auto').remove();\n   260→    $('.sidebar-menu').toggleClass('close');\n   261→    $('.contenedor-vista').toggleClass('close');\n   262→    $('#btn-collapse').toggleClass('close');\n   263→    $('.nombre-usuario-empresa').toggle();\n   264→    $('.menu-bar .text-menu').toggle();\n   265→}\n   266→\n   267→/**\n   268→ * Opción para abrir o cerrar el menu segun la elección guardada\n   269→ *\n   270→ * @returns {void}\n   271→ * @author José Manuel Jiménez\n   272→ * @author Andres Morales\n   273→ */\n   274→function mostrarMenuStorage() {\n   275→    $(document).ready(function() {\n   276→        $('.lista-primary[data-bs-toggle=\"tooltip\"]').each(function () {\n   277→            var tooltip_instancia = bootstrap.Tooltip.getInstance(this);\n   278→            if (tooltip_instancia) {\n   279→                tooltip_instancia.dispose();\n   280→            }\n   281→        });\n   282→\n   283→        if (window.innerWidth < 768) {\n   284→            localStorage.setItem('opcion_menu_storage', 'cerrado');\n   285→        }\n   286→\n   287→        if (localStorage.getItem('opcion_menu_storage') === 'cerrado') {\n   288→            contraerMenu();\n   289→        }\n   290→        let $active = $('.menu-bar .active');\n   291→\n   292→        if ($active.length) {\n   293→            $('.menu-bar').scrollTop($active.position().top);\n   294→        }\n   295→    });\n   296→}\n   297→mostrarMenuStorage();\n   298→\n   299→/**\n   300→ * Funcion para hacer el slug de un texto desde jquery.\n   301→ *\n   302→ * @returns {void}\n   303→ * @author Andres Morales\n   304→ */\n   305→function slugify(text) {\n   306→    return $.trim(text)\n   307→        .toLowerCase()\n   308→        .normalize(\"NFD\")\n   309→        .replace(/[\\u0300-\\u036f]/g, \"\")\n   310→        .replace(/[^a-z0-9 -]/g, \"\")\n   311→        .replace(/\\s+/g, \"-\")\n   312→        .replace(/-+/g, \"-\");\n   313→}\n   314→\n   315→/**\n   316→ * Función generica para mostrar mensajes de respuesta\n   317→ *\n   318→ * @param {string} tipo_alerta define el color de la alerta segun alerts de botstrap.\n   319→ * @param {string} texto_1 Texto que mostrara la alerta.\n   320→ * @param {string} texto_2 Texto secundario en la alerta.\n   321→ * @param {string} accion Acción adicional(por definir).\n   322→ * @returns {void}\n   323→ * @author José Manuel Jiménez\n   324→ * @author Andres Gonzalez\n   325→ */\n   326→function mostrarToast(tipo_alerta, texto_1, texto_2 = '', accion = '', icono2 = '') {\n   327→    let icono = '';\n   328→    let texto_color = 'text-white';\n   329→    if (accion != '') {\n   330→        accion = `<div class=\"col-auto p-0 text-label-1\">${accion}</div>`;\n   331→    }\n   332→\n   333→    if (tipo_alerta == 'success') {\n   334→        icono = 'bi bi-check-circle';\n   335→    }\n   336→\n   337→    if (tipo_alerta == 'neutral') {\n   338→        icono = 'bi bi-info-circle';\n   339→    }\n   340→\n   341→    if (tipo_alerta == 'warning') {\n   342→        icono = 'bi bi-info-circle';\n   343→        texto_color = \"text-red-letras\";\n   344→    }\n   345→\n   346→    if (tipo_alerta == 'danger') {\n   347→        icono = 'bi bi-x-circle';\n   348→    }\n   349→\n   350→    if (icono2 != '') {\n   351→        icono = icono2;\n   352→    }\n   353→\n   354→    if (texto_2 != '') {\n   355→        texto_2 = `<div class=\"col-12 p-0 text-label-1 ${texto_color}\">${texto_2}</div>`;\n   356→    }\n   357→\n   358→    let alert_toast = $(`\n   359→        <div class=\"alert toast-${tipo_alerta} alert-dismissible fade show d-flex align-items-center pe-3 py-3 me-3\" role=\"alert\" style=\"display:none\">\n   360→            <div class=\"col-auto\">\n   361→                <span class=\"${icono} ${texto_color}\"></span>\n   362→            </div>\n   363→            <div class=\"col px-3\">\n   364→                <div class=\"row m-0 ${texto_color}\">\n   365→                    <div class=\"col-12 p-0 text-label-1 ${texto_color}\">\n   366→                        ${texto_1}\n   367→                    </div>\n   368→                    ${texto_2}\n   369→                </div>\n   370→            </div>\n   371→            ${accion}\n   372→            <div class=\"col-auto ms-3 pointer\" data-bs-dismiss=\"alert\">\n   373→                <span class=\"bi bi-x ${texto_color}\"></span>\n   374→            </div>\n   375→        </div>\n   376→    `);\n   377→    $('#contenedor-alert-toast').append(alert_toast);\n   378→    alert_toast.fadeIn();\n   379→    setTimeout(function() {\n   380→        alert_toast.fadeOut();\n   381→        alert_toast.alert('close');\n   382→    }, 5000);\n   383→}\n   384→\n   385→/**\n   386→ * Formatear número.\n   387→ *\n   388→ * @param {number} numero número a formatear\n   389→ * @author Andres Morales\n   390→ */\n   391→function formatearNumero(numero) {\n   392→    return parseInt(numero).toLocaleString('es-ES');\n   393→}\n   394→\n   395→/**\n   396→ * Formatear fecha.\n   397→ *\n   398→ * @param {*} fecha Fecha a formatear.\n   399→ * @param {boolean} incluir_segundos Indica si se debe incluir los segundos en la hora.\n   400→ * @param {string} formato Formato en el que se retornará la fecha.\n   401→ * @param {string} separador Símbolo que se usará para separar días, meses y años.\n   402→ * @returns {Object} Objeto con la fecha y hora formateada.\n   403→ * @author Daniel Beltrán\n   404→ */\n   405→function formatearFechaConceptual(fecha, incluir_segundos = false, formato = 'Ymd', separador = '-') {\n   406→    const NUEVA_FECHA = new Date(fecha);\n   407→    const ANO         = NUEVA_FECHA.getFullYear();\n   408→    const MES         = String(NUEVA_FECHA.getMonth() + 1).padStart(2, '0');\n   409→    const DIA         = String(NUEVA_FECHA.getDate()).padStart(2, '0');\n   410→    const HORAS       = String(NUEVA_FECHA.getHours()).padStart(2, '0');\n   411→    const MINUTOS     = String(NUEVA_FECHA.getMinutes()).padStart(2, '0');\n   412→    const SEGUNDOS    = String(NUEVA_FECHA.getSeconds()).padStart(2, '0');\n   413→\n   414→    let fecha_formateada = `${ANO}${separador}${MES}${separador}${DIA}`;\n   415→\n   416→    if (formato === 'dmY') {\n   417→        fecha_formateada = `${DIA}${separador}${MES}${separador}${ANO}`;\n   418→    }\n   419→\n   420→    return {\n   421→        fecha: fecha_formateada,\n   422→        hora : incluir_segundos ? `${HORAS}:${MINUTOS}:${SEGUNDOS}` : `${HORAS}:${MINUTOS}`\n   423→    };\n   424→}\n   425→\n   426→/**\n   427→ * Formatear fecha a May. 2023.\n   428→ *\n   429→ * @param {string} fechaISO Fecha a formatear.\n   430→ * @returns {string} Objeto con la fecha y hora formateada.\n   431→ * @author Andres Morales\n   432→ */\n   433→function formatearFechaAnioMes(fechaISO) {\n   434→    const fecha = new Date(fechaISO);\n   435→    const opciones = { month: 'short', year: 'numeric' };\n   436→    let fecha_formateada = fecha.toLocaleDateString('es-ES', opciones);\n   437→\n   438→    fecha_formateada = fecha_formateada.replace(\n   439→        /^([a-zñ]+)(\\s\\d{4})$/,\n   440→        (_, mes, anio) => `${mes.charAt(0).toUpperCase() + mes.slice(1)}. ${anio.trim()}`\n   441→    );\n   442→\n   443→    return fecha_formateada;\n   444→}\n   445→\n   446→/**\n   447→ * Formatear un numero a moneda.\n   448→ *\n   449→ * @param {string} valor Numero.\n   450→ * @returns {string} Numero formateado.\n   451→ * @author Andres Morales\n   452→ */\n   453→function formatearMonedaCOP(valor) {\n   454→    return new Intl.NumberFormat('es-CO', {\n   455→        style: 'currency',\n   456→        currency: 'COP',\n   457→        minimumFractionDigits: 0,\n   458→        maximumFractionDigits: 0\n   459→    }).format(valor);\n   460→}\n   461→\n   462→/**\n   463→ * Formatear fecha a un formato d/m/Y hh:mm:ss entendible para el usuario.\n   464→ *\n   465→ * @param {*} fecha_inicial Fecha a formatear.\n   466→ * @returns {String} String con la fecha y hora formateada.\n   467→ * @author José Manuel Jiménez\n   468→ */\n   469→function fechaMostrar(fecha_inicial) {\n   470→    if (!fecha_inicial) {\n   471→        return \"\";\n   472→    }\n   473→    const fecha = new Date(fecha_inicial);\n   474→    if (isNaN(fecha.getTime())) {\n   475→        return \"\";\n   476→    }\n   477→    const dia = String(fecha.getUTCDate()).padStart(2, '0');\n   478→    const mes = String(fecha.getUTCMonth() + 1).padStart(2, '0');\n   479→    const anio = fecha.getUTCFullYear();\n   480→    if (!fecha_inicial.includes(\" \")) {\n   481→        return `${dia}/${mes}/${anio}`;\n   482→    }\n   483→    const horas = String(fecha.getUTCHours()).padStart(2, '0');\n   484→    const minutos = String(fecha.getUTCMinutes()).padStart(2, '0');\n   485→    const segundos = String(fecha.getUTCSeconds()).padStart(2, '0');\n   486→    return `${dia}/${mes}/${anio} ${horas}:${minutos}:${segundos}`;\n   487→}\n   488→\n   489→/**\n   490→ * Descargar Excel.\n   491→ *\n   492→ * @param {string} ruta Ruta desde donde se descarga el archivo.\n   493→ * @param {string} nombre_archivo Nombre del archivo descargado.\n   494→ * @param {boolean} marca_tiempo Indica si el nombre del archivo debe llevar marca de tiempo.\n   495→ * @param {Object} parametros Parámetros a enviar en la petición.\n   496→ * @returns {void}\n   497→ * @author Daniel Beltrán\n   498→ */\n   499→async function descargarExcel(ruta, nombre_archivo, marca_tiempo = true, parametros = {}) {\n   500→    parametros._token = $('meta[name=\"csrf-token\"]').attr('content');\n   501→\n   502→    await $.ajax({\n   503→        type     : 'POST',\n   504→        url      : `/${ruta}`,\n   505→        data     : parametros,\n   506→        xhrFields: {\n   507→            responseType: 'blob'\n   508→        },\n   509→        success: function (respuesta) {\n   510→            // Crear una URL para el Blob\n   511→            let url = window.URL.createObjectURL(respuesta); // 'respuesta' es el Blob\n   512→            let a   = document.createElement('a'); // Crea un nuevo elemento <a> para iniciar la descarga\n   513→            a.href  = url;\n   514→            const fecha_actual     = new Date();\n   515→            const dia              = fecha_actual.getDate();\n   516→            const mes              = fecha_actual.getMonth() + 1;\n   517→            const ano              = fecha_actual.getFullYear();\n   518→            const hora             = fecha_actual.getHours();\n   519→            const minutos          = fecha_actual.getMinutes();\n   520→            const segundos         = fecha_actual.getSeconds();\n   521→            const fecha_formateada = `${dia}${mes}${ano}${hora}${minutos}${segundos}`;\n   522→\n   523→            a.download = marca_tiempo ? `${nombre_archivo}-${fecha_formateada}.xlsx` : `${nombre_archivo}.xlsx`;\n   524→            document.body.appendChild(a);\n   525→            a.click();\n   526→            window.URL.revokeObjectURL(url);\n   527→            document.body.removeChild(a);\n   528→        }\n   529→    }).then(() => {\n   530→        mostrarToast('success', 'Archivo descargado correctamente.');\n   531→    }).catch((error) => {\n   532→        mostrarToast('danger', 'Ocurrió un error al descargar el archivo.');\n   533→    });\n   534→}\n   535→\n   536→/**\n   537→ * Convierte un string a slug.\n   538→ *\n   539→ * @param {string} str\n   540→ * @returns {string}\n   541→ * @author Fahibram Cárcamo\n   542→ */\n   543→function slug(str) {\n   544→\n   545→    // Quita espacios en blanco\n   546→    str = str.replace(/^\\s+|\\s+$/g, \"\")\n   547→\n   548→    // Convierte el string a minusculas\n   549→    str = str.toLowerCase()\n   550→\n   551→    // Quita los caracteres no alfanuméricos\n   552→    str = str.replace(/[^a-z0-9 -]/g, \"\")\n   553→\n   554→    // Reemplaza los espacio con guiones\n   555→    str = str.replace(/\\s+/g, \"-\")\n   556→\n   557→    // Remueve los guiones consecutivos\n   558→    str = str.replace(/-+/g, \"-\")\n   559→\n   560→    return str\n   561→}\n   562→\n   563→/**\n   564→ * Compara los elementos de dos arreglos y retorna `true` si son iguales y `false` en caso contrario\n   565→ * (Este función está pensada para comparar arreglos unidimensionales).\n   566→ *\n   567→ * @param {array} primer_arreglo\n   568→ * @param {array} segundo_arreglo\n   569→ * @param {boolean} comparar_orden\n   570→ * @return {boolean}\n   571→ * @author Fahibram Cárcamo\n   572→ */\n   573→function sonArreglosIguales(primer_arreglo, segundo_arreglo, comparar_orden = false) {\n   574→\n   575→    if (!comparar_orden) {\n   576→        primer_arreglo.sort()\n   577→        segundo_arreglo.sort()\n   578→    }\n   579→\n   580→    if (primer_arreglo.length !== segundo_arreglo.length) return false\n   581→\n   582→    for (let i = 0; i < primer_arreglo.length; i++) {\n   583→        if (primer_arreglo[i] !== segundo_arreglo[i]) return false\n   584→    }\n   585→\n   586→    return true\n   587→}\n   588→\n   589→/**\n   590→ * Función para cambiar de empresa.\n   591→ *\n   592→ * @param {number} empresa_id ID de la empresa a la que se va a cambiar.\n   593→ * @returns {void}\n   594→ * @author José Manuel Jiménez\n   595→ * @author Daniel Beltrán\n   596→ */\n   597→function cambiarEmpresa(empresa_id) {\n   598→    $.ajax({\n   599→        type: 'POST',\n   600→        url: '/suplantar-rol-admin-general',\n   601→        data: {\n   602→            _token    : $('meta[name=\"csrf-token\"]').attr('content'),\n   603→            empresa_id: empresa_id\n   604→        },\n   605→        success: function (respuesta) {\n   606→            localStorage.setItem('notificacionToast', JSON.stringify({\n   607→                tipo_alerta: 'success',\n   608→                texto_1    : 'Cambio de empresa exitoso'\n   609→            }));\n   610→\n   611→            window.location.reload();\n   612→        },\n   613→        error: function (error) {\n   614→            mostrarToast('danger', 'Ocurrió un error al cambiar de empresa');\n   615→        }\n   616→    });\n   617→}\n   618→\n   619→/**\n   620→ * Enviar la solucitud de suplantación de rol y empresa al Back-end.\n   621→ *\n   622→ * @param {function|null} callback_exito Callback ejecutado en caso de éxito.\n   623→ * @param {string} url URL de suplantación.\n   624→ * @param {string} _token Token CSRF del formulario.\n   625→ * @param {number} empresa_id Id de la empresa a suplantar.\n   626→ * @param {number|null} rol_id Id del rol a suplantar.\n   627→ * @param {function|null} callback_error Callback ejecutado en caso de error.\n   628→ * @returns {void}\n   629→ * @author Fahibram Cárcamo\n   630→ */\n   631→async function enviarOrdenSuplantacionRolEmpresa (callback_exito, url, _token, empresa_id = null, rol_id = null, callback_error = null) {\n   632→\n   633→    let condicion_suplantacion = rol_id === null\n   634→        ? empresa_id === null\n   635→            ? true\n   636→            : parseInt($('#empresa_sesion_id').val()) !== parseInt(empresa_id)\n   637→        : parseInt($('#rol_sesion_id').val()) !== parseInt(rol_id) && parseInt($('#empresa_sesion_id').val()) !== parseInt(empresa_id);\n   638→\n   639→    if (condicion_suplantacion) {\n   640→        let data = { _token };\n   641→        if (empresa_id !== null) data.empresa_id = empresa_id;\n   642→        if (rol_id !== null) data.rol_id = rol_id;\n   643→\n   644→        await $.ajax({ type: 'POST', url, data })\n   645→            .then((respuesta, status, xhr) => {\n   646→                if (xhr.status >= 200 && xhr.status < 300 && callback_exito !== null) callback_exito();\n   647→            })\n   648→            .catch(error => {\n   649→                let swal_titulo, swal_texto;\n   650→\n   651→                if (error.status === 404) {\n   652→                    if (error.responseJSON.mensaje) {\n   653→                        swal_titulo = 'Algo salió mal';\n   654→                        if (error.responseJSON.mensaje === 'no existe rol_suplantar') {\n   655→                            swal_texto = 'El rol no existe.';\n   656→                        } else if (error.responseJSON.mensaje === 'no existe empresa_suplantar') {\n   657→                            swal_texto = 'La empresa no existe.';\n   658→                        } else if (error.responseJSON.mensaje === 'no existe usuario_suplantar') {\n   659→                            swal_texto = 'El usuario no existe.';\n   660→                        } else {\n   661→                            swal_texto = '';\n   662→                        }\n   663→                    } else if (error.responseJSON.empresa && error.responseJSON.rol) {\n   664→                        swal_titulo = 'No fué posible cambiar de empresa';\n   665→                        swal_texto = error.responseJSON.rol === 'Administrador general' || error.responseJSON.rol === 'Propietario'\n   666→                            ? `La empresa ${error.responseJSON.empresa} no tiene ningún usuario con el rol Administrador general o Propietario.`\n   667→                            : `La empresa ${error.responseJSON.empresa} no tiene ningún usuario con el rol ${error.responseJSON.rol}.`;\n   668→                    } else {\n   669→                        swal_titulo = 'Algo salió mal';\n   670→                        swal_texto = error.responseJSON.errors;\n   671→                    }\n   672→                } else {\n   673→                    swal_titulo = 'Algo salió mal';\n   674→                    swal_texto = '';\n   675→                }\n   676→\n   677→                if (callback_error !== null) callback_error();\n   678→\n   679→                Swal.fire({\n   680→                    title: swal_titulo,\n   681→                    text: swal_texto,\n   682→                    icon: \"error\",\n   683→                    confirmButtonText: \"Aceptar\"\n   684→                });\n   685→            });\n   686→    }\n   687→}\n   688→\n   689→/**\n   690→ * Mostrar tooltip según el div que lo contenga.\n   691→ *\n   692→ * @param {div} div Elemento en donde se va a mostrar el tooltip.\n   693→ * @returns {void}\n   694→ * @author Sol Espitia\n   695→ */\n   696→function mostrarTooltip(div) {\n   697→    const TOOLTIP         = div.querySelector('.tooltip-x');\n   698→    TOOLTIP.style.display = 'block';\n   699→}\n   700→\n   701→/**\n   702→ * Ocultar tooltip según el div que lo contenga.\n   703→ *\n   704→ * @param {div} div Elemento en donde se va a mostrar el tooltip.\n   705→ * @returns {void}\n   706→ * @author Sol Espitia\n   707→ */\n   708→function ocultarTooltip(div) {\n   709→    const TOOLTIP         = div.querySelector('.tooltip-x');\n   710→    TOOLTIP.style.display = 'none';\n   711→}\n   712→\n   713→/**\n   714→ * Retornar la diferencia en días de dos fechas dadas.\n   715→ *\n   716→ * @param {string} fecha_inicial Fecha inicial\n   717→ * @param {string} fecha_final Fecha final\n   718→ * @param {bool} valor_absoluto Retorna la diferencia en valor absoluto\n   719→ * @returns {number}\n   720→ * @author Fahibram Cárcamo\n   721→ * @author Andres Morales\n   722→ */\n   723→function diferenciaFechasDias(fecha_inicial, fecha_final, valor_absoluto = false, sumar_dia = true) {\n   724→    let fecha1 = new Date(fecha_inicial);\n   725→    let fecha2 = new Date(fecha_final);\n   726→\n   727→    fecha1.setHours(0, 0, 0, 0);\n   728→    fecha2.setHours(0, 0, 0, 0);\n   729→\n   730→    let diferencia_milisegundos = fecha2.getTime() - fecha1.getTime();\n   731→\n   732→    let diferencia_dias = diferencia_milisegundos / (1000 * 60 * 60 * 24);\n   733→    let resultado = diferencia_dias;\n   734→    if (sumar_dia) {\n   735→        resultado = diferencia_dias + 1;\n   736→    }\n   737→\n   738→    return valor_absoluto ? Math.abs(resultado) : resultado;\n   739→}\n   740→\n   741→/**\n   742→ * Retornar `true` si una fecha dada está dentro de un rango de fechas dadas, `false` en otro caso.\n   743→ *\n   744→ * @param {string} fecha Fecha dada\n   745→ * @param {string} fecha_desde Fecha inicial del rango\n   746→ * @param {string} fecha_hasta Fecha final del rango\n   747→ * @returns {boolean}\n   748→ * @author Fahibram Cárcamo\n   749→ */\n   750→function fechaDentroDelRango(fecha, fecha_desde, fecha_hasta) {\n   751→    fecha = new Date(fecha);\n   752→    fecha_desde = new Date(fecha_desde);\n   753→    fecha_hasta = new Date(fecha_hasta);\n   754→\n   755→    if (isNaN(fecha) || isNaN(fecha_desde) || isNaN(fecha_hasta)) {\n   756→        throw new Error('Una o más fechas no son válidas.');\n   757→    }\n   758→\n   759→    return fecha >= fecha_desde && fecha <= fecha_hasta;\n   760→}\n   761→\n   762→/**\n   763→ * Descuenta el tiempo para las respuestas.\n   764→ *\n   765→ * @param id - ID del elemento HTML donde mostrar el tiempo\n   766→ * @param tiempo - Tiempo inicial en segundos\n   767→ * @author Jair Carvajal\n   768→ */\n   769→var tiempos_usados = {};\n   770→\n   771→function descuentoTiempo(id, tiempo, callback, onTick) {\n   772→    var $elemento = $('#' + id);\n   773→    if ($elemento.length === 0) {\n   774→        console.error('Elemento con id \"' + id + '\" no encontrado.');\n   775→        return;\n   776→    }\n   777→    if (tiempos_usados[id]) {\n   778→        clearInterval(tiempos_usados[id]);\n   779→    }\n   780→    let tiempoTotal = tiempo;\n   781→    tiempos_usados[id] = setInterval(function() {\n   782→        if (tiempo <= 0) {\n   783→            clearInterval(tiempos_usados[id]);\n   784→            delete tiempos_usados[id];\n   785→            $elemento.text('Tiempo finalizado');\n   786→            if (window.tiempoFinalizado()) {\n   787→                tiempoFinalizado();\n   788→            }\n   789→            if (typeof callback === 'function') {\n   790→                callback();\n   791→            }\n   792→            return;\n   793→        }\n   794→\n   795→        var minutos = Math.floor(tiempo / 60);\n   796→        var segundos = tiempo % 60;\n   797→\n   798→        var textoTiempo = minutos + ':' + (segundos < 10 ? '0' : '') + segundos + '<i class=\"bi bi-alarm ms-2\"></i>';\n   799→\n   800→        if (tiempo <= 15) {\n   801→            $elemento.addClass('text-state-red');\n   802→            $elemento.removeClass('text-state-green');\n   803→        } else {\n   804→            $elemento.addClass('text-state-green');\n   805→            $elemento.removeClass('text-state-red');\n   806→        }\n   807→\n   808→        $elemento.html(textoTiempo);\n   809→\n   810→        var tiempoUsado = tiempoTotal - tiempo;\n   811→\n   812→        if (typeof onTick === 'function') {\n   813→            onTick((tiempoUsado % 5));\n   814→        }\n   815→        tiempo--;\n   816→    }, 1000);\n   817→}\n   818→\n   819→/**\n   820→ * Detengo el tiempo para las respuestas.\n   821→ *\n   822→ * @param id - ID del elemento HTML donde mostrar el tiempo\n   823→ * @param tiempo - Tiempo inicial en segundos\n   824→ * @author Jair Carvajal\n   825→ */\n   826→function detenerDescuentoTiempo(id) {\n   827→    if (tiempos_usados[id]) {\n   828→        clearInterval(tiempos_usados[id]);\n   829→        delete tiempos_usados[id];\n   830→    }\n   831→}\n   832→\n   833→/**\n   834→ * Genera un SVG de la imagen de usuario.\n   835→ *\n   836→ * @param id ID del usuario.\n   837→ * @param nombres Nombres del usuario.\n   838→ * @param apellidos Apellidos del usuario.\n   839→ * @return image\n   840→ * @author Andres Morales\n   841→ */\n   842→function crearImagenUsuarioLetras(id, nombres, apellidos) {\n   843→    var tamano = 200;\n   844→    var iniciales = (nombres[0] + apellidos[0]).toUpperCase();\n   845→    var hash = md5(id);\n   846→\n   847→    var r = parseInt(hash.substring(0, 2), 16);\n   848→    var g = parseInt(hash.substring(2, 4), 16);\n   849→    var b = parseInt(hash.substring(4, 6), 16);\n   850→    var colorFondo = `rgb(${r},${g},${b})`;\n   851→\n   852→    var luminancia = 0.299 * r + 0.587 * g + 0.114 * b;\n   853→    var colorTexto = luminancia > 150 ? \"#000000\" : \"#FFFFFF\";\n   854→\n   855→    // SVG como texto\n   856→    var svg = `\n   857→    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${tamano}\" height=\"${tamano}\">\n   858→        <rect width=\"100%\" height=\"100%\" fill=\"${colorFondo}\" />\n   859→        <text x=\"50%\" y=\"50%\" dy=\".35em\"\n   860→            text-anchor=\"middle\"\n   861→            font-family=\"Lato, sans-serif\"\n   862→            font-size=\"${tamano * 0.4}\"\n   863→            fill=\"${colorTexto}\">\n   864→            ${iniciales}\n   865→        </text>\n   866→    </svg>`;\n   867→    var svgEncoded = encodeURIComponent(svg)\n   868→        .replace(/'/g, \"%27\")\n   869→        .replace(/\"/g, \"%22\");\n   870→\n   871→    var dataUri = `data:image/svg+xml,${svgEncoded}`;\n   872→    return dataUri;\n   873→}\n   874→\n   875→/**\n   876→ * Carga las notificaciones\n   877→ *\n   878→ * @return void\n   879→ * @author Andres Morales\n   880→ * @author Andres Gonzalez\n   881→ * @author Esperanza Olivo\n   882→ */\n   883→function cargarNotificiacionesHeader() {\n   884→    $.ajax({\n   885→        url: '/usuario-notificaciones',\n   886→        type: 'GET',\n   887→        dataType: 'json',\n   888→        success: function(respuesta) {\n   889→            let datos = respuesta.data;\n   890→            let notificaciones_noleidas = datos?.unread_notifications?.length ?? 0;\n   891→\n   892→            // Siempre remover el badge existente\n   893→            $('#dropdownNotificaciones #badge-notificaciones').remove();\n   894→\n   895→            // Solo agregar el badge si hay notificaciones no leídas\n   896→            if (notificaciones_noleidas > 0) {\n   897→                $('#dropdownNotificaciones').append(`<span id=\"badge-notificaciones\" class=\"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-white\">${notificaciones_noleidas}</span>`);\n   898→                $('#contador-notificaciones-abierto').append(`<span id=\"badge-notificaciones\" class=\"badge rounded-pill bg-danger border border-white\">${notificaciones_noleidas}</span>`);\n   899→\n   900→                $('#contenedor-boton-marcar-todas').html(`\n   901→                    <button class=\"btn btn-link text-primary w-100 d-flex justify-content-center\" onclick=\"marcarNotificacionesLeidas('all')\">\n   902→                        Marcar todo como leído\n   903→                    </button>\n   904→                `);\n   905→            }\n   906→\n   907→            const NO_LEIDOS_IDS = new Set(Array.isArray(datos?.unread_notifications) ? datos.unread_notifications.map(notificacion => notificacion.id) : []);\n   908→\n   909→            if (Array.isArray(datos?.notifications) && datos.notifications.length > 0) {\n   910→                $('#notificacion-sinnotificaciones').hide();\n   911→                $('.notificaciones-listado').remove();\n   912→                datos.notifications.forEach(notificacion => {\n   913→                    const { id, data, updated_at } = notificacion;\n   914→\n   915→                    const NO_LEIDO = NO_LEIDOS_IDS.has(id);\n   916→                    const MENSAJE = (data?.mensaje || '').slice(0, 120) + '...';\n   917→                    const HORA = new Date(updated_at).toLocaleTimeString('es-CO', {\n   918→                        hour: '2-digit',\n   919→                        minute: '2-digit',\n   920→                        hour12: false\n   921→                    });\n   922→\n   923→                    const notificaciones = `\n   924→                        <li class=\"${NO_LEIDO ? '' : 'bg-gray-90'} notificaciones-listado py-0\" id=\"notificacion-${id}\">\n   925→                            <a class=\"dropdown-item text-gray-10 text-decoration-none border-top pt-0 pb-1\" href=\"javascript:void(0)\" onclick=\"marcarNotificacionesLeidas('${id}','${data?.ruta}')\">\n   926→                                <div class=\"d-flex justify-content-between\">\n   927→                                    <div class=\"w-auto flex-grow-1 pe-3\">\n   928→                                        <p class=\"mt-1 mb-0 text-headline-6 text-gray-10\">${data?.titulo}</p>\n   929→                                        <p class=\"mb-0 text-body-3 text-gray-30 notificacion-mensaje\">${MENSAJE}</p>\n   930→                                    </div>\n   931→                                    <div class=\"w-auto my-auto ${NO_LEIDO ? 'text-cta-azul' : 'text-gray-10'} text-label-2 flex-shrink-0\">\n   932→                                        ${HORA}${NO_LEIDO ? `<i class=\"bi bi-circle-fill text-cta-azul my-auto texto-notificacion-icono ms-3\"></i>` : ''}\n   933→                                    </div>\n   934→                                </div>\n   935→                            </a>\n   936→                        </li>\n   937→                    `;\n   938→\n   939→                    $(notificaciones).insertBefore('#contenedor-boton-marcar-todas');\n   940→                });\n   941→\n   942→            } else {\n   943→                $('#notificacion-sinnotificaciones').hide();\n   944→                $('.notificaciones-listado').remove();\n   945→            }\n   946→\n   947→        },\n   948→        error: function(xhr, status, error) {\n   949→            console.error('Error al cargar notificaciones:', error);\n   950→        }\n   951→    });\n   952→}\n   953→\n   954→/**\n   955→ * Marcar las notificaciones leídas.\n   956→ *\n   957→ * @param {array} notificaciones_ids ids de las notificaciones\n   958→ * @param {string} ruta_destino ruta donde se va ha actualizar la pagina\n   959→ * @returns {void}\n   960→ * @author Andres Gonzalez\n   961→ * @author Esperanza Olivo\n   962→ */\n   963→function marcarNotificacionesLeidas(notificaciones_ids = null, ruta_destino = null, soporte_id = null) {\n   964→\n   965→    let data = {\n   966→        _token: $('meta[name=\"csrf-token\"]').attr('content')\n   967→    };\n   968→\n   969→    if (notificaciones_ids === 'all') {\n   970→        data.marcar_todo = true;\n   971→    } else if (soporte_id) {\n   972→        data.soporte_id = soporte_id;\n   973→    } else if (notificaciones_ids) {\n   974→        data.notificaciones_ids = Array.isArray(notificaciones_ids)\n   975→            ? notificaciones_ids\n   976→            : [notificaciones_ids];\n   977→    }\n   978→\n   979→    $.ajax({\n   980→        url: '/usuario-marcar-notificaciones-leidas',\n   981→        type: 'POST',\n   982→        data: data,\n   983→        success: function(respuesta) {\n   984→            cargarNotificiacionesHeader();\n   985→\n   986→            if (notificaciones_ids && notificaciones_ids !== 'all' && ruta_destino) {\n   987→                window.location.href = \"/\" + ruta_destino;\n   988→            }\n   989→\n   990→            if (notificaciones_ids === 'all') {\n   991→                $('#badge-notificaciones').remove();\n   992→                $('#contenedor-boton-marcar-todas').empty();\n   993→                $('.notificaciones-listado').addClass('bg-gray-90');\n   994→                $('.bi-circle-fill').remove();\n   995→            }\n   996→        },\n   997→        error: function(xhr, estatus, error) {\n   998→            console.error('Error al cargar notificaciones:', error);\n   999→        }\n  1000→    });\n  1001→}\n  1002→\n  1003→/**\n  1004→ * Configurar WebSocket para notificaciones en tiempo real\n  1005→ *\n  1006→ * @return void\n  1007→ * @author Andres Gonzalez\n  1008→ */\n  1009→function configurarWebSocketNotificaciones() {\n  1010→    try {\n  1011→        if (!window.configuracion_reverbg) {\n  1012→            return;\n  1013→        }\n  1014→\n  1015→        const PUSHER = new Pusher(window.configuracion_reverbg.appKey, {\n  1016→            wsHost: window.configuracion_reverbg.host,\n  1017→            wsPort: window.configuracion_reverbg.port,\n  1018→            wssPort: window.configuracion_reverbg.port,\n  1019→            cluster: 'mt1',\n  1020→            forceTLS: false,\n  1021→            enabledTransports: ['ws', 'wss'],\n  1022→            authEndpoint: '/broadcasting-auth',\n  1023→            auth: {\n  1024→                headers: {\n  1025→                    'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n  1026→                }\n  1027→            }\n  1028→        });\n  1029→\n  1030→        PUSHER.connection.bind('failed', function() {\n  1031→            console.error('❌ Conexión WebSocket falló');\n  1032→        });\n  1033→\n  1034→        PUSHER.connection.bind('error', function(error) {\n  1035→            console.error('❌ Error de WebSocket:', error);\n  1036→        });\n  1037→\n  1038→        let usuario_id = window.configuracion_reverbg.usuario_id;\n  1039→\n  1040→        if (!usuario_id) {\n  1041→            return;\n  1042→        }\n  1043→\n  1044→        const NOMBRE_CANAL = `private-App.Models.Usuarios.User.${usuario_id}`;\n  1045→        const CANAL = PUSHER.subscribe(NOMBRE_CANAL);\n  1046→\n  1047→        CANAL.bind('pusher:subscription_error', function(error) {\n  1048→            console.error('❌ Error al suscribirse al canal:', error);\n  1049→        });\n  1050→\n  1051→        // Escuchar eventos específicos de notificaciones\n  1052→        CANAL.bind('Illuminate\\\\Notifications\\\\Events\\\\BroadcastNotificationCreated', function(data) {\n  1053→            if (data.tipo === 'nueva_notificacion') {\n  1054→                audio_notificacion.play();\n  1055→                cargarNotificiacionesHeader();\n  1056→            }\n  1057→\n  1058→            if (data.tipo === 'nuevo_mensaje') {\n  1059→                if (($('#soporte-guardado-id').val() == data.soporte_id) || ($('#soporte_empresa_id').val() == data.soporte_id)) {\n  1060→                    audio_notificacion.play();\n  1061→                    consultarChat(data.soporte_id);\n  1062→                }\n  1063→            }\n  1064→        });\n  1065→    } catch (error) {\n  1066→        console.error('💥 Error en configurarWebSocketNotificaciones:', error);\n  1067→        console.error('Stack trace:', error.stack);\n  1068→    }\n  1069→}\n  1070→\n  1071→/**\n  1072→ * Retornar el string entrante en formato title case.\n  1073→ *\n  1074→ * @param {string} texto\n  1075→ * @returns {string}\n  1076→ * @author Fahibram Cárcamo\n  1077→ */\n  1078→function titleCase(texto) {\n  1079→    return texto.toLowerCase().replace(/\\b\\w/g, caracter => caracter.toUpperCase());\n  1080→}\n  1081→\n  1082→/**\n  1083→ * Número de horas que durará el almacenamiento de la variable `ulitmas_empresas` en el\n  1084→ * almacenamiento local **LocalStorage**.\n  1085→ *\n  1086→ * @var {number}\n  1087→ * @author Fahibram Cárcamo\n  1088→ */\n  1089→const CANTIDAD_HORAS_VENCIMIENTO_ULTIMAS_EMPRESAS_LOCALSTORAGE = 6;\n  1090→\n  1091→/**\n  1092→ * Validar si ya debe removerse la variable `ultimas_empresas` del alamacenamiento local\n  1093→ * **LocalStorage**, si no es tiempo de eliminarla entonces se reinicia el tiempo de vigencia de la\n  1094→ * variable.\n  1095→ *\n  1096→ * @returns {void}\n  1097→ * @author Fahibram Cárcamo\n  1098→ */\n  1099→function validarYActualizarUltimasEmpresasLocalStorage() {\n  1100→    let fecha_hora_actuales = moment();\n  1101→    let fecha_hora_vencimiento_ultimas_empresas = fecha_hora_actuales.clone().add(CANTIDAD_HORAS_VENCIMIENTO_ULTIMAS_EMPRESAS_LOCALSTORAGE, 'hours');\n  1102→    let fecha_hora_vencimiento_ultimas_empresas_localstorage = localStorage.getItem('vencimiento_ultimas_empresas');\n  1103→    let ultimas_empresas = localStorage.getItem('ultimas_empresas');\n  1104→\n  1105→    if (\n  1106→        ultimas_empresas != null &&\n  1107→        fecha_hora_vencimiento_ultimas_empresas_localstorage != null &&\n  1108→        fecha_hora_actuales.clone().isBefore(moment(fecha_hora_vencimiento_ultimas_empresas_localstorage).clone())\n  1109→    ) {\n  1110→        localStorage.setItem('vencimiento_ultimas_empresas', fecha_hora_vencimiento_ultimas_empresas.format('YYYY-MM-DD HH:mm:ss'));\n  1111→        return;\n  1112→    }\n  1113→\n  1114→    localStorage.removeItem('vencimiento_ultimas_empresas');\n  1115→    localStorage.removeItem('ultimas_empresas');\n  1116→}\n  1117→\n  1118→/**\n  1119→ * Obtener la edad actual de un usuario según su fecha de nacimiento.\n  1120→ *\n  1121→ * @param {string} fecha_nacimiento\n  1122→ * @returns {string}\n  1123→ * @author José Manuel Jiménez\n  1124→ * @author Fahibram Cárcamo\n  1125→ * @author Andres Morales\n  1126→ */\n  1127→function obtenerEdad(fecha_nacimiento) {\n  1128→    if (!fecha_nacimiento) return \"N/A\";\n  1129→    let hoy = new Date();\n  1130→    let nacimiento = new Date(fecha_nacimiento);\n  1131→    let edad = hoy.getFullYear() - nacimiento.getFullYear();\n  1132→    let mes = hoy.getMonth() - nacimiento.getMonth();\n  1133→    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) edad--;\n  1134→    return edad + \" años\";\n  1135→}\n  1136→\n  1137→/**\n  1138→ * Restablecer un input de tipo file.\n  1139→ *\n  1140→ * @param {html} elemento_input_html Elemento input html.\n  1141→ * @param {html} label_elemento_input_html Label del elemento input html.\n  1142→ * @param {html} boton_eliminar_elemento_input_html Botón para eliminar archivo del elemento input html.\n  1143→ * @author Fahibram Cárcamo\n  1144→ */\n  1145→function reiniciarCampoArchivo(elemento_input_html, label_elemento_input_html, boton_eliminar_elemento_input_html) {\n  1146→    elemento_input_html.val('');\n  1147→    elemento_input_html.removeAttr('data-base64');\n  1148→    label_elemento_input_html.text('Ningún archivo seleccionado');\n  1149→    boton_eliminar_elemento_input_html.hide();\n  1150→\n  1151→    if (elemento_input_html.data('imagen')) {\n  1152→        $('#' + elemento_input_html.data('imagen')).val('');\n  1153→        $('#' + elemento_input_html.data('imagen') + '_previsualizacion').attr('src', '');\n  1154→        $('#' + elemento_input_html.data('imagen') + '_fondo_previsualizacion').removeClass('d-none');\n  1155→    }\n  1156→}\n  1157→\n  1158→/**\n  1159→ * Definir un campo destinado a recibir un número de teléfono celular.\n  1160→ *\n  1161→ * Esta función debe llamarse en el evento ready del objeto global document:\n  1162→ * `$(document).ready(...)`. Ademas debe incluirse un pequeño fragmento de código en la función\n  1163→ * `validacionAdicional` para que se agregué el código del número de celular al valor de campo\n  1164→ * cuando se envíe el formulario donde se encutra el campo.\n  1165→ *\n  1166→ * ```\n  1167→ * if (\n  1168→ *   $('#input_celular_id').length &&\n  1169→ *   $('#input_celular_id').val() !== '' &&\n  1170→ *   input_celular.getNumber() !== ''\n  1171→ * ) {\n  1172→ *   $('#input_celular_id').val(input_celular.getNumber().slice(1));\n  1173→ * }\n  1174→ * ```\n  1175→ *\n  1176→ * Donde `input_celular` es el objeto retornado por esta función.\n  1177→ *\n  1178→ * @param {string} input_celular_id Id del campo.\n  1179→ * @param {string} nombre_input_celular Nombre del campo.\n  1180→ * @param {string} placeholder_input_celular Placeholder del campo.\n  1181→ * @param {boolean} obligatorio El campo es obligatorio en el formulario.\n  1182→ * @returns {object}\n  1183→ * @author Fahibram Cárcamo\n  1184→ */\n  1185→function definirInputTipoCelular(input_celular_id, nombre_input_celular, placeholder_input_celular, obligatorio = true) {\n  1186→    /**\n  1187→     * 🌎 Campo para ingresar un número de telefono con selectór de código de país con banderas.\n  1188→     * Este componente se creó con la librería International Telephone Input\n  1189→     * (https://intl-tel-input.com).\n  1190→     *\n  1191→     * La linea hiddenInput: () => ({ phone: 'celular_contacto' }) tiene como función establecer el\n  1192→     * nombre del campo, es decir, la llave del par llave-valor que se adjuntará en los datos del\n  1193→     * formulario cuando se envíe, en este caso 'celular_contacto'.\n  1194→     *\n  1195→     * Las lienas autoPlaceholder: 'aggressive' y\n  1196→     * customPlaceholder: (placeholder, country) => 'Celular*' se usan para definir el placeholder\n  1197→     * del campo.\n  1198→     *\n  1199→     * Con $('#celular_contacto').attr('required', true); se establece el campo como requerido\n  1200→     * dentro del formulario, se hace de esta forma porque la librería no admite el atributo\n  1201→     * required directamente en el componente html.\n  1202→     *\n  1203→     * @author Fahibram Cárcamo\n  1204→     */\n  1205→    if (document.querySelector(`#${input_celular_id}`)) {\n  1206→        const dropdown_dinamico = document.createElement('div');\n  1207→        document.body.appendChild(dropdown_dinamico);\n  1208→\n  1209→        let campo_celular = window.intlTelInput(document.querySelector(`#${input_celular_id}`), {\n  1210→            nationalMode: true,\n  1211→            initialCountry: 'co',\n  1212→            separateDialCode: true,\n  1213→            autoInsertDialCode: false,\n  1214→            autoPlaceholder: 'aggressive',\n  1215→            dropdownContainer: dropdown_dinamico,\n  1216→            customPlaceholder: (placeholder, country) => placeholder_input_celular,\n  1217→            loadUtils: () => import('https://cdn.jsdelivr.net/npm/intl-tel-input@25.4.2/build/js/utils.js'),\n  1218→            onlyCountries: [\n  1219→                'CO', // Colombia\n  1220→                'EC', // Ecuador\n  1221→                'AR', // Argentina\n  1222→                'CL', // Chile\n  1223→                'VE', // Venezuela\n  1224→                'PE', // Perú\n  1225→                'BO', // Bolivia\n  1226→                'UY', // Uruguay\n  1227→                'PY', // Paraguay\n  1228→                'PA', // Panamá\n  1229→                'MX', // México\n  1230→                'CR', // Costa Rica\n  1231→                // 'PR', // Puerto Rico\n  1232→                'CU', // Cuba\n  1233→                // 'DO', // República Dominicana\n  1234→                'SV', // El Salvador\n  1235→                'GT', // Guatemala\n  1236→                'HN', // Honduras\n  1237→                'NI', // Nicaragua\n  1238→                'ES', // España\n  1239→                'US', // Estados Unidos\n  1240→                'GQ'  // Guinea Ecuatorial\n  1241→            ]\n  1242→        });\n  1243→\n  1244→        if (obligatorio) $(`#${input_celular_id}`).attr('required', true);\n  1245→\n  1246→        return campo_celular;\n  1247→    }\n  1248→\n  1249→    return null;\n  1250→}\n  1251→\n  1252→/**\n  1253→ * Establece la validación adicional que se aplica a un campo de tipo celular antes de enviar sus\n  1254→ * datos en un formulario.\n  1255→ *\n  1256→ * @param {HTMLInputElement} input Elemento HTML del campo de tipo celular.\n  1257→ * @param {string} input_id Id del elemento HTML del campo de tipo celular.\n  1258→ * @author Fahibram Cárcamo\n  1259→ * @author Jair Carvajal\n  1260→ */\n  1261→function validacionAdicionalInputTipoCelular(input, input_id) {\n  1262→    let numero_completo = input.getNumber();\n  1263→    let indicativo = '+' + input.getSelectedCountryData().dialCode;\n  1264→    let codigo_iso2_pais = input.getSelectedCountryData().iso2;\n  1265→    let numero_sin_indicativo = numero_completo.replace(indicativo, '');\n  1266→    $(`#indicativo_${input_id}`).val(indicativo);\n  1267→    $(`#codigo_iso2_pais_${input_id}`).val(codigo_iso2_pais);\n  1268→    $(`#${input_id}`).val(numero_sin_indicativo);\n  1269→}\n  1270→\n  1271→/**\n  1272→ * Rellenar un input de tipo celular.\n  1273→ *\n  1274→ * @param {string} indicativo_celular Código del país del número de celular.\n  1275→ * @param {string} codigo_pais_iso2 Código ISO2 del país del número de celular.\n  1276→ * @param {string} numero_celular Número de celular sin código de país.\n  1277→ * @param {string} input_celular_id ID del input de tipo celular.\n  1278→ * @param {HTMLInputElement} input_celular Input de tipo celular.\n  1279→ * @returns {void}\n  1280→ * @author Daniel Beltrán\n  1281→ * @author Fahibram Cárcamo\n  1282→ */\n  1283→function rellenarInputCelular(indicativo_celular, codigo_pais_iso2, numero_celular, input_celular_id, input_celular) {\n  1284→    $(`#${input_celular_id}`).val(numero_celular);\n  1285→    if (![null, undefined].includes(codigo_pais_iso2)) input_celular.setCountry(codigo_pais_iso2);\n  1286→}\n  1287→\n  1288→/**\n  1289→ * Convierte imágenes de base64 a Blob.\n  1290→ *\n  1291→ * @param {string} cadena_base_64 Base 64 de la imagen.\n  1292→ * @returns {Promise<Array>}\n  1293→ * @author Andres Gonzalez\n  1294→ */\n  1295→function imagenBase64Blob(cadena_base_64) {\n  1296→    if (!cadena_base_64 || !cadena_base_64.startsWith('data:image')) return null;\n  1297→    let datos_base_64 = cadena_base_64.split(',')[1];\n  1298→    let tipo_mime = cadena_base_64.match(/data:(.*?);base64/)[1];\n  1299→    let caracteres_binarios = atob(datos_base_64);\n  1300→    let arreglo_bytes = new Array(caracteres_binarios.length).fill(0).map((_, i) => caracteres_binarios.charCodeAt(i));\n  1301→    let bytes_uint8 = new Uint8Array(arreglo_bytes);\n  1302→    return new Blob([bytes_uint8], { type: tipo_mime });\n  1303→}\n  1304→\n  1305→\n  1306→/**\n  1307→ * Limpiar estructuras html innecesarias en el check editor.\n  1308→ *\n  1309→ * @param {string} html - Cadena HTML generada por CKEditor a limpiar\n  1310→ * @returns {string} HTML limpio sin elementos específicos de CKEditor\n  1311→ * @author Andres Gonzalez\n  1312→ * @author Jair Carvajal\n  1313→ */\n  1314→function limpiarHTMLCKEditor(html) {\n  1315→    // Remover todos los elementos con clases de CKEditor\n  1316→    html = html.replace(/<div class=\"ck[^\"]*\"[^>]*>.*?<\\/div>/gs, '');\n  1317→    html = html.replace(/<span class=\"[^\"]*ck[^\"]*\"[^>]*>/gi, '<span>');\n  1318→\n  1319→    // Limpiar spans de imagen inline\n  1320→    html = html.replace(/<span class=\"image-inline[^\"]*\"[^>]*>/gi, '');\n  1321→    html = html.replace(/<\\/span>/g, '');\n  1322→\n  1323→    // Remover elementos de upload y widgets\n  1324→    html = html.replace(/<div class=\"ck-image-upload[^\"]*\"[^>]*>.*?<\\/div>/gs, '');\n  1325→    html = html.replace(/<div class=\"ck-fake-selection[^\"]*\"[^>]*>.*?<\\/div>/gs, '');\n  1326→\n  1327→    // Remover atributos innecesarios\n  1328→    html = html.replace(/contenteditable=\"[^\"]*\"/gi, '');\n  1329→    html = html.replace(/data-cke-filler=\"[^\"]*\"/gi, '');\n  1330→\n  1331→    // Limpiar párrafos vacíos con br\n  1332→    html = html.replace(/<p><br[^>]*><\\/p>/gi, '');\n  1333→    html = html.replace(/<br data-cke[^>]*>/gi, '');\n  1334→\n  1335→    // Limpiar espacios múltiples y saltos de línea\n  1336→    html = html.replace(/\\s+/g, ' ');\n  1337→    html = html.replace(/>\\s+</g, '><');\n  1338→\n  1339→    return html.trim();\n  1340→}\n  1341→\n  1342→/**\n  1343→ * Ordena estudios por fecha_inicio más reciente (de más nueva a más antigua).\n  1344→ * Preserva los índices originales para permitir edición y eliminación correcta.\n  1345→ *\n  1346→ * @param {Array} estudios - Array de objetos con estudios\n  1347→ * @returns {Array} Array de estudios ordenados con propiedad indice_original\n  1348→ * @author Jair Carvajal\n  1349→ */\n  1350→function ordenarEstudiosPorFecha(estudios) {\n  1351→    // Mapear con índice original\n  1352→    let estudios_con_indice = estudios.map((estudio, indice_original) => ({\n  1353→        ...estudio,\n  1354→        indice_original: indice_original\n  1355→    }));\n  1356→\n  1357→    // Ordenar estudios por fecha_inicio (más reciente primero)\n  1358→    let estudios_ordenados = estudios_con_indice.sort((a, b) => {\n  1359→        // Si ambos tienen fecha_inicio, ordenar por más reciente\n  1360→        if (a.fecha_inicio && b.fecha_inicio) {\n  1361→            return moment(b.fecha_inicio).diff(moment(a.fecha_inicio));\n  1362→        }\n  1363→        // Si solo uno tiene fecha_inicio, ese va primero\n  1364→        if (a.fecha_inicio && !b.fecha_inicio) return -1;\n  1365→        if (!a.fecha_inicio && b.fecha_inicio) return 1;\n  1366→        // Si ninguno tiene fecha_inicio, mantener orden original\n  1367→        return 0;\n  1368→    });\n  1369→\n  1370→    return estudios_ordenados;\n  1371→}\n  1372→\n  1373→/**\n  1374→ * Ordena experiencias laborales por fecha: primero las que está trabajando actualmente (sin fecha_fin),\n  1375→ * luego por fecha_fin más reciente.\n  1376→ * Preserva los índices originales para permitir edición y eliminación correcta.\n  1377→ *\n  1378→ * @param {Array} experiencias - Array de objetos con experiencias laborales\n  1379→ * @returns {Array} Array de experiencias ordenadas con propiedad indice_original\n  1380→ * @author Jair Carvajal\n  1381→ */\n  1382→function ordenarExperienciasPorFecha(experiencias) {\n  1383→    // Mapear con índice original\n  1384→    let experiencias_con_indice = experiencias.map((experiencia, indice_original) => ({\n  1385→        ...experiencia,\n  1386→        indice_original: indice_original\n  1387→    }));\n  1388→\n  1389→    // Ordenar experiencias\n  1390→    let experiencias_ordenadas = experiencias_con_indice.sort((a, b) => {\n  1391→        // Si 'a' no tiene fecha_fin (trabaja actualmente), va primero\n  1392→        if (!a.fecha_fin && b.fecha_fin) return -1;\n  1393→        // Si 'b' no tiene fecha_fin (trabaja actualmente), va primero\n  1394→        if (a.fecha_fin && !b.fecha_fin) return 1;\n  1395→        // Si ambos están trabajando actualmente (sin fecha_fin), mantener el orden actual\n  1396→        if (!a.fecha_fin && !b.fecha_fin) return 0;\n  1397→        // Si ambos tienen fecha_fin, ordenar por fecha más reciente primero (descendente)\n  1398→        return moment(b.fecha_fin).diff(moment(a.fecha_fin));\n  1399→    });\n  1400→\n  1401→    return experiencias_ordenadas;\n  1402→}\n  1403→\n  1404→/**\n  1405→ * Obtener créditos disponibles de la empresa y actualizar el tag.\n  1406→ * - Si tiene créditos >= 20% del plan: tag azul\n  1407→ * - Si tiene créditos < 20% del plan: tag amarillo\n  1408→ * - Si no tiene créditos: tag gris \"Sin créditos\"\n  1409→ *\n  1410→ * @param {number} empresa_id ID de la empresa\n  1411→ * @param {string} contenedor_id ID del contenedor donde se mostrará el tag\n  1412→ * @returns {void}\n  1413→ * @author Andres Gonzalez\n  1414→ */\n  1415→function obtenerCreditosDisponiblesEmpresa(empresa_id, contenedor_id = 'contenedor-tag-creditos') {\n  1416→    if (!empresa_id || !$(`#${contenedor_id}`).length) {\n  1417→        return;\n  1418→    }\n  1419→\n  1420→    $.ajax({\n  1421→        url: `/empresas/${empresa_id}/creditos`,\n  1422→        method: 'GET',\n  1423→        dataType: 'json',\n  1424→        success: function(respuesta) {\n  1425→            let creditos_disponibles = respuesta?.data?.creditos_disponibles ?? 0;\n  1426→            let creditos_plan = respuesta?.data?.creditos_plan ?? 0;\n  1427→            let plan_credito = respuesta?.data?.plan_credito;\n  1428→            let porcentaje_disponible = creditos_plan > 0 ? (creditos_disponibles / creditos_plan) * 100 : 0;\n  1429→\n  1430→            let texto_tag = '';\n  1431→            let clase_tag = '';\n  1432→            let icono_final = '';\n  1433→\n  1434→            if (creditos_disponibles <= 0 || plan_credito === null) {\n  1435→                texto_tag = 'Sin créditos';\n  1436→                clase_tag = 'tag-tonal-gray';\n  1437→                icono_final = `<i class=\"bi bi-info-circle ms-1\" role=\"button\" tabindex=\"0\" ${crearTooltip({ placement: 'right', content: 'No tienes créditos disponibles en este momento. Renueva tu plan o adquiere más créditos para continuar.' })}></i>`;\n  1438→            } else if (porcentaje_disponible < 20) {\n  1439→                texto_tag = `Créditos disponibles: ${formatearNumero(creditos_disponibles)}`;\n  1440→                clase_tag = 'tag-filled-yellow';\n  1441→                icono_final = `<i class=\"bi bi-info-circle ms-1\" role=\"button\" tabindex=\"0\" ${crearTooltip({ placement: 'right', content: 'Estás cerca de agotar tus créditos. Te queda menos del 20% del total disponible. Considera recargar o revisar tu consumo para evitar interrupciones.' })}></i>`;\n  1442→            } else {\n  1443→                texto_tag = `Créditos disponibles: ${formatearNumero(creditos_disponibles)}`;\n  1444→                clase_tag = 'tag-tonal-blue';\n  1445→            }\n  1446→\n  1447→            $(`#${contenedor_id}`).html(crearTag({\n  1448→                texto: texto_tag,\n  1449→                class: clase_tag,\n  1450→                icono_final: icono_final,\n  1451→            }));\n  1452→\n  1453→            inicializarTooltips();\n  1454→        },\n  1455→        error: function (error) {\n  1456→            $(`#${contenedor_id}`).html(crearTag({\n  1457→                texto: error.status === 404 ? 'No tienes plan de créditos' : 'Error al cargar créditos',\n  1458→                class: 'tag-tonal-gray'\n  1459→            }));\n  1460→        }\n  1461→    });\n  1462→}\n  1463→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2a42571b-eeda-4885-bb28-9243f31b005a","timestamp":"2026-01-27T16:04:32.864Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\globales.js","content":"// Mensajes en español para el plugin Select2\nconst mensajes_select2 = {\n    'noResults'              : () => { return 'No hay resultados para la búsqueda.'; },\n    'searching'              : () => { return 'Buscando...'; },\n    'Loading'                : () => { return 'Cargando...'; },\n    'loadingMore'            : () => { return 'Cargando más resultados...'; },\n    'dropdownFooter'         : (texto) => { return `Mostrando ${texto} resultados`; },\n    'emptyOptions'           : () => { return 'No hay opciones disponibles.'; },\n    'appendItems'            : (items) => { return `Agregando ${items.length} elementos.`; },\n    'maximumSelectionReached': () => { return 'Se ha alcanzado el número máximo de selecciones.'; },\n    'selectOnClose'          : () => { return 'Seleccione una opción al cerrar el menú.'; },\n    'escapeKeyUp'            : () => { return 'Presione \\'Escape\\' para cerrar el menú.'; },\n    'errorLoading'           : () => { return 'Error al cargar datos. Inténtalo de nuevo más tarde.'; },\n    'inputTooShort'          : (elemento) => { return `Ingresa al menos ${elemento.minimum} caracteres para iniciar una búsqueda.`; },\n    'noMatches'              : () => { return 'No se encontraron coincidencias para tu búsqueda.'; },\n    'allowClear'             : () => { return 'Borrar selección'; },\n    'SelectionTooLong'       : (conteo, maximo) => { return `Solo puedes seleccionar ${maximo} opciones.`; },\n    'loadMore'               : () => { return 'Cargando más resultados...'; },\n    'removing'               : (seleccion) => { return 'Eliminando...'; },\n    'matches'                : (coincidencias, total) => {\n        if (coincidencias === 0) {\n            return 'No hay coincidencias.';\n        } else if (coincidencias === 1) {\n            return 'Se encontró 1 coincidencia.';\n        } else {\n            return `Se encontraron ${coincidencias} coincidencias entre ${total}.`;\n        }\n    }\n};\n\n// audios\nvar audio_notificacion = new Audio('/audios/notificacion.mp3');\n\nlet mostro_modal_creditos_ia = false;\nlet funcion_ejecucion_ia = null;\nlet modals_abiertos_ia = null;\n\nlet configuraciones_disponibles_empresa = null;\n\n/**\n * Mostrar modal de créditos IA\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction mostrarModalCreditosIA(servicio_ia_id) {\n    $.ajax({\n        url: `/empresas/${$('#empresa_sesion_id').val()}/creditos`,\n        method: 'GET',\n        dataType: 'json',\n        success: function(respuesta_empresa) {\n            if (respuesta_empresa?.data?.creditos_disponibles > 0) {\n                $.ajax({\n                    url: `/servicios-ia/${servicio_ia_id}/creditos`,\n                    method: 'GET',\n                    dataType: 'json',\n                    success: function(respuesta) {\n                        if (respuesta?.data?.consume_creditos && respuesta?.data?.consume_creditos <= respuesta_empresa.data.creditos_disponibles) {\n                            $('#cantidad-creditos-descontar-modal').text(respuesta.data.consume_creditos);\n                            $('#modal-consumo-creditos-ia').modal('show');\n                            mostro_modal_creditos_ia = true;\n                            modals_abiertos_ia = $('.modal.show').not('#modal-consumo-creditos-ia').not('#modal-generando-ia');\n                            $(modals_abiertos_ia).addClass('d-none');\n                        } else {\n                            mostrarToastSolicitarCreditosIA();\n                        }\n                    }\n                });\n            } else {\n                mostrarToastSolicitarCreditosIA();\n            }\n        }\n    });\n}\n\n/**\n * Mostrar toast para solicitar créditos IA\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction mostrarToastSolicitarCreditosIA() {\n    $.ajax({\n        url: `/empresas/${$('#empresa_sesion_id').val()}`,\n        method: 'GET',\n        dataType: 'json',\n        success: function(respuesta) {\n            let adicional_toast = '';\n            if (respuesta?.data?.ejecutivo?.telefono) {\n                adicional_toast = `<a href=\"https://wa.me/${respuesta.data.ejecutivo.telefono.replace(/\\D/g, '')}?text=Hola,%20me%20gustar%C3%ADa%20solicitar%20cr%C3%A9ditos%20adicionales%20para%20mi%20empresa.\" target=\"_blank\">\n                    <p class=\"text-label-1 text-white no-visited text-decoration-none mb-0\">Solicitar</p>\n                </a>`;\n            }\n            setTimeout(() => {\n                $('#modal-generando-ia').modal('hide');\n                $('#modal-cargue-ia').modal('hide');\n                mostrarToast('danger', 'No cuentas con créditos. Solicita créditos adicionales.', '', adicional_toast);\n            }, 300);\n        }\n    });\n}\n\n/**\n * Continuar ejecución IA luego del modal de créditos\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction continuarEjecucionIA() {\n    if (funcion_ejecucion_ia) {\n        funcion_ejecucion_ia();\n        funcion_ejecucion_ia = null;\n    }\n    mostro_modal_creditos_ia = false;\n    $('#modal-consumo-creditos-ia').modal('hide');\n}\n\n/**\n * Solicitar más créditos IA\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction solicitarMasCreditosIA() {\n    $.ajax({\n        url: `/empresas/${$('#empresa_sesion_id').val()}`,\n        method: 'GET',\n        dataType: 'json',\n        success: function(respuesta) {\n            if (respuesta?.data?.ejecutivo?.telefono) {\n                window.open(`https://wa.me/${respuesta.data.ejecutivo.telefono.replace(/\\D/g, '')}?text=Hola,%20me%20gustar%C3%ADa%20solicitar%20cr%C3%A9ditos%20adicionales%20para%20mi%20empresa.`, '_blank');\n            } else {\n                mostrarToast('danger', 'No se encontró un ejecutivo asignado a la empresa. Por favor, comunícate con soporte para recargar créditos.');\n            }\n            $('#modal-solicitar-mas-creditos-ia').modal('hide');\n        }\n    });\n}\n\n/**\n * Validar respuesta de créditos IA\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction validarRespuestaCreditosIA(error_ia) {\n    if (error_ia == 'No tienes créditos disponibles en este momento. Renueva tu plan o adquiere más créditos para continuar.') {\n        mostrarToastSolicitarCreditosIA();\n        return true;\n    }\n    return false;\n}\n\n/**\n * Ajustar el ancho de los elementos select2 asincrono multiple.\n *\n * @returns {void}\n * @author Andres Morales\n */\n$(document).ready(function () {\n    cargarNotificiacionesHeader();\n    if (window.configuracion_reverbg && window.configuracion_reverbg.activar_websocket) {\n        configurarWebSocketNotificaciones();\n    }\n    setTimeout(() => {\n        $(\".input-container\").each(function () {\n            let $container = $(this);\n            let $select = $container.find(\"select[multiple]\");\n            let $icon = $container.find(\".input-icono1\");\n            if ($select.length && $icon.length) {\n                $(this).find('.select2-selection--multiple').addClass('ps-5')\n            }\n        });\n    }, 1000);\n    $('#modal-consumo-creditos-ia').on('hidden.bs.modal', function () {\n        if (mostro_modal_creditos_ia) {\n            $(modals_abiertos_ia).removeClass('d-none');\n        }\n        mostro_modal_creditos_ia = false;\n    });\n\n    // Cargar créditos disponibles si existe el contenedor y el ID de empresa\n    if ($('#contenedor-tag-creditos').length && $('#empresa_sesion_id').length) {\n        obtenerCreditosDisponiblesEmpresa($('#empresa_sesion_id').val());\n    }\n});\n\n/**\n * Formatear fecha a formato dd/mm/yyyy - hh:mm AM/PM.  Ejemplo: 01/Feb/2022 - 12:00 PM\n *\n * @param {string} fecha_entrada fecha en formato ISO\n * @returns {string} fecha y hora formateada\n * @author Andres Morales\n */\nfunction formatearFecha(fecha_entrada) {\n    var fecha = new Date(fecha_entrada);\n    var dia = fecha.getDate();\n    var mes = fecha.toLocaleString('es-ES', { month: 'short' });\n    var anio = fecha.getFullYear();\n    let hora = fecha.getHours();\n    let minuto = fecha.getMinutes();\n    let ampm = hora >= 12 ? 'PM' : 'AM';\n    hora = hora % 12 || 12;\n    minuto = minuto.toString().padStart(2, '0');\n    return `${dia}/${mes}/${anio} - ${hora}:${minuto} ${ampm}`;\n}\n\nfunction formatearFecha2(fecha_entrada) {\n    let partes = fecha_entrada.split(' ');\n    let fecha = partes[0].split('-');\n    let hora = partes[1];\n    let fechaISO = `${fecha[2]}-${fecha[1]}-${fecha[0]}T${hora}`;\n\n    let date = new Date(fechaISO);\n\n    if (isNaN(date.getTime())) {\n        return 'Fecha inválida';\n    }\n\n    let dia = date.getDate();\n    let mes = date.toLocaleString('eu-EU', { month: 'short' });\n    let anio = date.getFullYear();\n    return `${dia}/${mes}/${anio}`;\n}\n\n/**\n * Opción para contraer o agrandar el menú principal\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction contraerMenu() {\n    if ($('.sidebar-menu').hasClass('close')) {\n        $('.sidebar-menu').removeClass('d-none');\n        localStorage.setItem('opcion_menu_storage', 'abierto');\n        $('#btn-collapse').attr('data-bs-original-title', 'Contraer');\n        $('#btn-collapse').attr('data-bs-title', 'Contraer');\n        $(\".menu-bar\").each(function() {\n            $(this).removeClass(\"px-2\").addClass(\"px-5\");\n        });\n        $('[data-bs-toggle=\"tooltip\"]').each(function () { new bootstrap.Tooltip(this); });\n        $('.lista-primary[data-bs-toggle=\"tooltip\"]').each(function () {\n            var tooltip_instancia = bootstrap.Tooltip.getInstance(this);\n            if (tooltip_instancia) {\n                tooltip_instancia.dispose();\n            }\n        });\n    } else {\n        $('.sidebar-menu').addClass('d-none');\n        localStorage.setItem('opcion_menu_storage', 'cerrado');\n        $('#btn-collapse').attr('data-bs-original-title', 'Expandir');\n        $('#btn-collapse').attr('data-bs-title', 'Expandir');\n        $(\".menu-bar\").each(function() {\n            $(this).removeClass(\"px-5\").addClass(\"px-2\");\n        });\n        $('[data-bs-toggle=\"tooltip\"]').each(function () { new bootstrap.Tooltip(this); });\n    }\n    $('.tooltip.bs-tooltip-auto').remove();\n    $('.sidebar-menu').toggleClass('close');\n    $('.contenedor-vista').toggleClass('close');\n    $('#btn-collapse').toggleClass('close');\n    $('.nombre-usuario-empresa').toggle();\n    $('.menu-bar .text-menu').toggle();\n}\n\n/**\n * Opción para abrir o cerrar el menu segun la elección guardada\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction mostrarMenuStorage() {\n    $(document).ready(function() {\n        $('.lista-primary[data-bs-toggle=\"tooltip\"]').each(function () {\n            var tooltip_instancia = bootstrap.Tooltip.getInstance(this);\n            if (tooltip_instancia) {\n                tooltip_instancia.dispose();\n            }\n        });\n\n        if (window.innerWidth < 768) {\n            localStorage.setItem('opcion_menu_storage', 'cerrado');\n        }\n\n        if (localStorage.getItem('opcion_menu_storage') === 'cerrado') {\n            contraerMenu();\n        }\n        let $active = $('.menu-bar .active');\n\n        if ($active.length) {\n            $('.menu-bar').scrollTop($active.position().top);\n        }\n    });\n}\nmostrarMenuStorage();\n\n/**\n * Funcion para hacer el slug de un texto desde jquery.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction slugify(text) {\n    return $.trim(text)\n        .toLowerCase()\n        .normalize(\"NFD\")\n        .replace(/[\\u0300-\\u036f]/g, \"\")\n        .replace(/[^a-z0-9 -]/g, \"\")\n        .replace(/\\s+/g, \"-\")\n        .replace(/-+/g, \"-\");\n}\n\n/**\n * Función generica para mostrar mensajes de respuesta\n *\n * @param {string} tipo_alerta define el color de la alerta segun alerts de botstrap.\n * @param {string} texto_1 Texto que mostrara la alerta.\n * @param {string} texto_2 Texto secundario en la alerta.\n * @param {string} accion Acción adicional(por definir).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction mostrarToast(tipo_alerta, texto_1, texto_2 = '', accion = '', icono2 = '') {\n    let icono = '';\n    let texto_color = 'text-white';\n    if (accion != '') {\n        accion = `<div class=\"col-auto p-0 text-label-1\">${accion}</div>`;\n    }\n\n    if (tipo_alerta == 'success') {\n        icono = 'bi bi-check-circle';\n    }\n\n    if (tipo_alerta == 'neutral') {\n        icono = 'bi bi-info-circle';\n    }\n\n    if (tipo_alerta == 'warning') {\n        icono = 'bi bi-info-circle';\n        texto_color = \"text-red-letras\";\n    }\n\n    if (tipo_alerta == 'danger') {\n        icono = 'bi bi-x-circle';\n    }\n\n    if (icono2 != '') {\n        icono = icono2;\n    }\n\n    if (texto_2 != '') {\n        texto_2 = `<div class=\"col-12 p-0 text-label-1 ${texto_color}\">${texto_2}</div>`;\n    }\n\n    let alert_toast = $(`\n        <div class=\"alert toast-${tipo_alerta} alert-dismissible fade show d-flex align-items-center pe-3 py-3 me-3\" role=\"alert\" style=\"display:none\">\n            <div class=\"col-auto\">\n                <span class=\"${icono} ${texto_color}\"></span>\n            </div>\n            <div class=\"col px-3\">\n                <div class=\"row m-0 ${texto_color}\">\n                    <div class=\"col-12 p-0 text-label-1 ${texto_color}\">\n                        ${texto_1}\n                    </div>\n                    ${texto_2}\n                </div>\n            </div>\n            ${accion}\n            <div class=\"col-auto ms-3 pointer\" data-bs-dismiss=\"alert\">\n                <span class=\"bi bi-x ${texto_color}\"></span>\n            </div>\n        </div>\n    `);\n    $('#contenedor-alert-toast').append(alert_toast);\n    alert_toast.fadeIn();\n    setTimeout(function() {\n        alert_toast.fadeOut();\n        alert_toast.alert('close');\n    }, 5000);\n}\n\n/**\n * Formatear número.\n *\n * @param {number} numero número a formatear\n * @author Andres Morales\n */\nfunction formatearNumero(numero) {\n    return parseInt(numero).toLocaleString('es-ES');\n}\n\n/**\n * Formatear fecha.\n *\n * @param {*} fecha Fecha a formatear.\n * @param {boolean} incluir_segundos Indica si se debe incluir los segundos en la hora.\n * @param {string} formato Formato en el que se retornará la fecha.\n * @param {string} separador Símbolo que se usará para separar días, meses y años.\n * @returns {Object} Objeto con la fecha y hora formateada.\n * @author Daniel Beltrán\n */\nfunction formatearFechaConceptual(fecha, incluir_segundos = false, formato = 'Ymd', separador = '-') {\n    const NUEVA_FECHA = new Date(fecha);\n    const ANO         = NUEVA_FECHA.getFullYear();\n    const MES         = String(NUEVA_FECHA.getMonth() + 1).padStart(2, '0');\n    const DIA         = String(NUEVA_FECHA.getDate()).padStart(2, '0');\n    const HORAS       = String(NUEVA_FECHA.getHours()).padStart(2, '0');\n    const MINUTOS     = String(NUEVA_FECHA.getMinutes()).padStart(2, '0');\n    const SEGUNDOS    = String(NUEVA_FECHA.getSeconds()).padStart(2, '0');\n\n    let fecha_formateada = `${ANO}${separador}${MES}${separador}${DIA}`;\n\n    if (formato === 'dmY') {\n        fecha_formateada = `${DIA}${separador}${MES}${separador}${ANO}`;\n    }\n\n    return {\n        fecha: fecha_formateada,\n        hora : incluir_segundos ? `${HORAS}:${MINUTOS}:${SEGUNDOS}` : `${HORAS}:${MINUTOS}`\n    };\n}\n\n/**\n * Formatear fecha a May. 2023.\n *\n * @param {string} fechaISO Fecha a formatear.\n * @returns {string} Objeto con la fecha y hora formateada.\n * @author Andres Morales\n */\nfunction formatearFechaAnioMes(fechaISO) {\n    const fecha = new Date(fechaISO);\n    const opciones = { month: 'short', year: 'numeric' };\n    let fecha_formateada = fecha.toLocaleDateString('es-ES', opciones);\n\n    fecha_formateada = fecha_formateada.replace(\n        /^([a-zñ]+)(\\s\\d{4})$/,\n        (_, mes, anio) => `${mes.charAt(0).toUpperCase() + mes.slice(1)}. ${anio.trim()}`\n    );\n\n    return fecha_formateada;\n}\n\n/**\n * Formatear un numero a moneda.\n *\n * @param {string} valor Numero.\n * @returns {string} Numero formateado.\n * @author Andres Morales\n */\nfunction formatearMonedaCOP(valor) {\n    return new Intl.NumberFormat('es-CO', {\n        style: 'currency',\n        currency: 'COP',\n        minimumFractionDigits: 0,\n        maximumFractionDigits: 0\n    }).format(valor);\n}\n\n/**\n * Formatear fecha a un formato d/m/Y hh:mm:ss entendible para el usuario.\n *\n * @param {*} fecha_inicial Fecha a formatear.\n * @returns {String} String con la fecha y hora formateada.\n * @author José Manuel Jiménez\n */\nfunction fechaMostrar(fecha_inicial) {\n    if (!fecha_inicial) {\n        return \"\";\n    }\n    const fecha = new Date(fecha_inicial);\n    if (isNaN(fecha.getTime())) {\n        return \"\";\n    }\n    const dia = String(fecha.getUTCDate()).padStart(2, '0');\n    const mes = String(fecha.getUTCMonth() + 1).padStart(2, '0');\n    const anio = fecha.getUTCFullYear();\n    if (!fecha_inicial.includes(\" \")) {\n        return `${dia}/${mes}/${anio}`;\n    }\n    const horas = String(fecha.getUTCHours()).padStart(2, '0');\n    const minutos = String(fecha.getUTCMinutes()).padStart(2, '0');\n    const segundos = String(fecha.getUTCSeconds()).padStart(2, '0');\n    return `${dia}/${mes}/${anio} ${horas}:${minutos}:${segundos}`;\n}\n\n/**\n * Descargar Excel.\n *\n * @param {string} ruta Ruta desde donde se descarga el archivo.\n * @param {string} nombre_archivo Nombre del archivo descargado.\n * @param {boolean} marca_tiempo Indica si el nombre del archivo debe llevar marca de tiempo.\n * @param {Object} parametros Parámetros a enviar en la petición.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function descargarExcel(ruta, nombre_archivo, marca_tiempo = true, parametros = {}) {\n    parametros._token = $('meta[name=\"csrf-token\"]').attr('content');\n\n    await $.ajax({\n        type     : 'POST',\n        url      : `/${ruta}`,\n        data     : parametros,\n        xhrFields: {\n            responseType: 'blob'\n        },\n        success: function (respuesta) {\n            // Crear una URL para el Blob\n            let url = window.URL.createObjectURL(respuesta); // 'respuesta' es el Blob\n            let a   = document.createElement('a'); // Crea un nuevo elemento <a> para iniciar la descarga\n            a.href  = url;\n            const fecha_actual     = new Date();\n            const dia              = fecha_actual.getDate();\n            const mes              = fecha_actual.getMonth() + 1;\n            const ano              = fecha_actual.getFullYear();\n            const hora             = fecha_actual.getHours();\n            const minutos          = fecha_actual.getMinutes();\n            const segundos         = fecha_actual.getSeconds();\n            const fecha_formateada = `${dia}${mes}${ano}${hora}${minutos}${segundos}`;\n\n            a.download = marca_tiempo ? `${nombre_archivo}-${fecha_formateada}.xlsx` : `${nombre_archivo}.xlsx`;\n            document.body.appendChild(a);\n            a.click();\n            window.URL.revokeObjectURL(url);\n            document.body.removeChild(a);\n        }\n    }).then(() => {\n        mostrarToast('success', 'Archivo descargado correctamente.');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al descargar el archivo.');\n    });\n}\n\n/**\n * Convierte un string a slug.\n *\n * @param {string} str\n * @returns {string}\n * @author Fahibram Cárcamo\n */\nfunction slug(str) {\n\n    // Quita espacios en blanco\n    str = str.replace(/^\\s+|\\s+$/g, \"\")\n\n    // Convierte el string a minusculas\n    str = str.toLowerCase()\n\n    // Quita los caracteres no alfanuméricos\n    str = str.replace(/[^a-z0-9 -]/g, \"\")\n\n    // Reemplaza los espacio con guiones\n    str = str.replace(/\\s+/g, \"-\")\n\n    // Remueve los guiones consecutivos\n    str = str.replace(/-+/g, \"-\")\n\n    return str\n}\n\n/**\n * Compara los elementos de dos arreglos y retorna `true` si son iguales y `false` en caso contrario\n * (Este función está pensada para comparar arreglos unidimensionales).\n *\n * @param {array} primer_arreglo\n * @param {array} segundo_arreglo\n * @param {boolean} comparar_orden\n * @return {boolean}\n * @author Fahibram Cárcamo\n */\nfunction sonArreglosIguales(primer_arreglo, segundo_arreglo, comparar_orden = false) {\n\n    if (!comparar_orden) {\n        primer_arreglo.sort()\n        segundo_arreglo.sort()\n    }\n\n    if (primer_arreglo.length !== segundo_arreglo.length) return false\n\n    for (let i = 0; i < primer_arreglo.length; i++) {\n        if (primer_arreglo[i] !== segundo_arreglo[i]) return false\n    }\n\n    return true\n}\n\n/**\n * Función para cambiar de empresa.\n *\n * @param {number} empresa_id ID de la empresa a la que se va a cambiar.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction cambiarEmpresa(empresa_id) {\n    $.ajax({\n        type: 'POST',\n        url: '/suplantar-rol-admin-general',\n        data: {\n            _token    : $('meta[name=\"csrf-token\"]').attr('content'),\n            empresa_id: empresa_id\n        },\n        success: function (respuesta) {\n            localStorage.setItem('notificacionToast', JSON.stringify({\n                tipo_alerta: 'success',\n                texto_1    : 'Cambio de empresa exitoso'\n            }));\n\n            window.location.reload();\n        },\n        error: function (error) {\n            mostrarToast('danger', 'Ocurrió un error al cambiar de empresa');\n        }\n    });\n}\n\n/**\n * Enviar la solucitud de suplantación de rol y empresa al Back-end.\n *\n * @param {function|null} callback_exito Callback ejecutado en caso de éxito.\n * @param {string} url URL de suplantación.\n * @param {string} _token Token CSRF del formulario.\n * @param {number} empresa_id Id de la empresa a suplantar.\n * @param {number|null} rol_id Id del rol a suplantar.\n * @param {function|null} callback_error Callback ejecutado en caso de error.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nasync function enviarOrdenSuplantacionRolEmpresa (callback_exito, url, _token, empresa_id = null, rol_id = null, callback_error = null) {\n\n    let condicion_suplantacion = rol_id === null\n        ? empresa_id === null\n            ? true\n            : parseInt($('#empresa_sesion_id').val()) !== parseInt(empresa_id)\n        : parseInt($('#rol_sesion_id').val()) !== parseInt(rol_id) && parseInt($('#empresa_sesion_id').val()) !== parseInt(empresa_id);\n\n    if (condicion_suplantacion) {\n        let data = { _token };\n        if (empresa_id !== null) data.empresa_id = empresa_id;\n        if (rol_id !== null) data.rol_id = rol_id;\n\n        await $.ajax({ type: 'POST', url, data })\n            .then((respuesta, status, xhr) => {\n                if (xhr.status >= 200 && xhr.status < 300 && callback_exito !== null) callback_exito();\n            })\n            .catch(error => {\n                let swal_titulo, swal_texto;\n\n                if (error.status === 404) {\n                    if (error.responseJSON.mensaje) {\n                        swal_titulo = 'Algo salió mal';\n                        if (error.responseJSON.mensaje === 'no existe rol_suplantar') {\n                            swal_texto = 'El rol no existe.';\n                        } else if (error.responseJSON.mensaje === 'no existe empresa_suplantar') {\n                            swal_texto = 'La empresa no existe.';\n                        } else if (error.responseJSON.mensaje === 'no existe usuario_suplantar') {\n                            swal_texto = 'El usuario no existe.';\n                        } else {\n                            swal_texto = '';\n                        }\n                    } else if (error.responseJSON.empresa && error.responseJSON.rol) {\n                        swal_titulo = 'No fué posible cambiar de empresa';\n                        swal_texto = error.responseJSON.rol === 'Administrador general' || error.responseJSON.rol === 'Propietario'\n                            ? `La empresa ${error.responseJSON.empresa} no tiene ningún usuario con el rol Administrador general o Propietario.`\n                            : `La empresa ${error.responseJSON.empresa} no tiene ningún usuario con el rol ${error.responseJSON.rol}.`;\n                    } else {\n                        swal_titulo = 'Algo salió mal';\n                        swal_texto = error.responseJSON.errors;\n                    }\n                } else {\n                    swal_titulo = 'Algo salió mal';\n                    swal_texto = '';\n                }\n\n                if (callback_error !== null) callback_error();\n\n                Swal.fire({\n                    title: swal_titulo,\n                    text: swal_texto,\n                    icon: \"error\",\n                    confirmButtonText: \"Aceptar\"\n                });\n            });\n    }\n}\n\n/**\n * Mostrar tooltip según el div que lo contenga.\n *\n * @param {div} div Elemento en donde se va a mostrar el tooltip.\n * @returns {void}\n * @author Sol Espitia\n */\nfunction mostrarTooltip(div) {\n    const TOOLTIP         = div.querySelector('.tooltip-x');\n    TOOLTIP.style.display = 'block';\n}\n\n/**\n * Ocultar tooltip según el div que lo contenga.\n *\n * @param {div} div Elemento en donde se va a mostrar el tooltip.\n * @returns {void}\n * @author Sol Espitia\n */\nfunction ocultarTooltip(div) {\n    const TOOLTIP         = div.querySelector('.tooltip-x');\n    TOOLTIP.style.display = 'none';\n}\n\n/**\n * Retornar la diferencia en días de dos fechas dadas.\n *\n * @param {string} fecha_inicial Fecha inicial\n * @param {string} fecha_final Fecha final\n * @param {bool} valor_absoluto Retorna la diferencia en valor absoluto\n * @returns {number}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction diferenciaFechasDias(fecha_inicial, fecha_final, valor_absoluto = false, sumar_dia = true) {\n    let fecha1 = new Date(fecha_inicial);\n    let fecha2 = new Date(fecha_final);\n\n    fecha1.setHours(0, 0, 0, 0);\n    fecha2.setHours(0, 0, 0, 0);\n\n    let diferencia_milisegundos = fecha2.getTime() - fecha1.getTime();\n\n    let diferencia_dias = diferencia_milisegundos / (1000 * 60 * 60 * 24);\n    let resultado = diferencia_dias;\n    if (sumar_dia) {\n        resultado = diferencia_dias + 1;\n    }\n\n    return valor_absoluto ? Math.abs(resultado) : resultado;\n}\n\n/**\n * Retornar `true` si una fecha dada está dentro de un rango de fechas dadas, `false` en otro caso.\n *\n * @param {string} fecha Fecha dada\n * @param {string} fecha_desde Fecha inicial del rango\n * @param {string} fecha_hasta Fecha final del rango\n * @returns {boolean}\n * @author Fahibram Cárcamo\n */\nfunction fechaDentroDelRango(fecha, fecha_desde, fecha_hasta) {\n    fecha = new Date(fecha);\n    fecha_desde = new Date(fecha_desde);\n    fecha_hasta = new Date(fecha_hasta);\n\n    if (isNaN(fecha) || isNaN(fecha_desde) || isNaN(fecha_hasta)) {\n        throw new Error('Una o más fechas no son válidas.');\n    }\n\n    return fecha >= fecha_desde && fecha <= fecha_hasta;\n}\n\n/**\n * Descuenta el tiempo para las respuestas.\n *\n * @param id - ID del elemento HTML donde mostrar el tiempo\n * @param tiempo - Tiempo inicial en segundos\n * @author Jair Carvajal\n */\nvar tiempos_usados = {};\n\nfunction descuentoTiempo(id, tiempo, callback, onTick) {\n    var $elemento = $('#' + id);\n    if ($elemento.length === 0) {\n        console.error('Elemento con id \"' + id + '\" no encontrado.');\n        return;\n    }\n    if (tiempos_usados[id]) {\n        clearInterval(tiempos_usados[id]);\n    }\n    let tiempoTotal = tiempo;\n    tiempos_usados[id] = setInterval(function() {\n        if (tiempo <= 0) {\n            clearInterval(tiempos_usados[id]);\n            delete tiempos_usados[id];\n            $elemento.text('Tiempo finalizado');\n            if (window.tiempoFinalizado()) {\n                tiempoFinalizado();\n            }\n            if (typeof callback === 'function') {\n                callback();\n            }\n            return;\n        }\n\n        var minutos = Math.floor(tiempo / 60);\n        var segundos = tiempo % 60;\n\n        var textoTiempo = minutos + ':' + (segundos < 10 ? '0' : '') + segundos + '<i class=\"bi bi-alarm ms-2\"></i>';\n\n        if (tiempo <= 15) {\n            $elemento.addClass('text-state-red');\n            $elemento.removeClass('text-state-green');\n        } else {\n            $elemento.addClass('text-state-green');\n            $elemento.removeClass('text-state-red');\n        }\n\n        $elemento.html(textoTiempo);\n\n        var tiempoUsado = tiempoTotal - tiempo;\n\n        if (typeof onTick === 'function') {\n            onTick((tiempoUsado % 5));\n        }\n        tiempo--;\n    }, 1000);\n}\n\n/**\n * Detengo el tiempo para las respuestas.\n *\n * @param id - ID del elemento HTML donde mostrar el tiempo\n * @param tiempo - Tiempo inicial en segundos\n * @author Jair Carvajal\n */\nfunction detenerDescuentoTiempo(id) {\n    if (tiempos_usados[id]) {\n        clearInterval(tiempos_usados[id]);\n        delete tiempos_usados[id];\n    }\n}\n\n/**\n * Genera un SVG de la imagen de usuario.\n *\n * @param id ID del usuario.\n * @param nombres Nombres del usuario.\n * @param apellidos Apellidos del usuario.\n * @return image\n * @author Andres Morales\n */\nfunction crearImagenUsuarioLetras(id, nombres, apellidos) {\n    var tamano = 200;\n    var iniciales = (nombres[0] + apellidos[0]).toUpperCase();\n    var hash = md5(id);\n\n    var r = parseInt(hash.substring(0, 2), 16);\n    var g = parseInt(hash.substring(2, 4), 16);\n    var b = parseInt(hash.substring(4, 6), 16);\n    var colorFondo = `rgb(${r},${g},${b})`;\n\n    var luminancia = 0.299 * r + 0.587 * g + 0.114 * b;\n    var colorTexto = luminancia > 150 ? \"#000000\" : \"#FFFFFF\";\n\n    // SVG como texto\n    var svg = `\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${tamano}\" height=\"${tamano}\">\n        <rect width=\"100%\" height=\"100%\" fill=\"${colorFondo}\" />\n        <text x=\"50%\" y=\"50%\" dy=\".35em\"\n            text-anchor=\"middle\"\n            font-family=\"Lato, sans-serif\"\n            font-size=\"${tamano * 0.4}\"\n            fill=\"${colorTexto}\">\n            ${iniciales}\n        </text>\n    </svg>`;\n    var svgEncoded = encodeURIComponent(svg)\n        .replace(/'/g, \"%27\")\n        .replace(/\"/g, \"%22\");\n\n    var dataUri = `data:image/svg+xml,${svgEncoded}`;\n    return dataUri;\n}\n\n/**\n * Carga las notificaciones\n *\n * @return void\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author Esperanza Olivo\n */\nfunction cargarNotificiacionesHeader() {\n    $.ajax({\n        url: '/usuario-notificaciones',\n        type: 'GET',\n        dataType: 'json',\n        success: function(respuesta) {\n            let datos = respuesta.data;\n            let notificaciones_noleidas = datos?.unread_notifications?.length ?? 0;\n\n            // Siempre remover el badge existente\n            $('#dropdownNotificaciones #badge-notificaciones').remove();\n\n            // Solo agregar el badge si hay notificaciones no leídas\n            if (notificaciones_noleidas > 0) {\n                $('#dropdownNotificaciones').append(`<span id=\"badge-notificaciones\" class=\"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-white\">${notificaciones_noleidas}</span>`);\n                $('#contador-notificaciones-abierto').append(`<span id=\"badge-notificaciones\" class=\"badge rounded-pill bg-danger border border-white\">${notificaciones_noleidas}</span>`);\n\n                $('#contenedor-boton-marcar-todas').html(`\n                    <button class=\"btn btn-link text-primary w-100 d-flex justify-content-center\" onclick=\"marcarNotificacionesLeidas('all')\">\n                        Marcar todo como leído\n                    </button>\n                `);\n            }\n\n            const NO_LEIDOS_IDS = new Set(Array.isArray(datos?.unread_notifications) ? datos.unread_notifications.map(notificacion => notificacion.id) : []);\n\n            if (Array.isArray(datos?.notifications) && datos.notifications.length > 0) {\n                $('#notificacion-sinnotificaciones').hide();\n                $('.notificaciones-listado').remove();\n                datos.notifications.forEach(notificacion => {\n                    const { id, data, updated_at } = notificacion;\n\n                    const NO_LEIDO = NO_LEIDOS_IDS.has(id);\n                    const MENSAJE = (data?.mensaje || '').slice(0, 120) + '...';\n                    const HORA = new Date(updated_at).toLocaleTimeString('es-CO', {\n                        hour: '2-digit',\n                        minute: '2-digit',\n                        hour12: false\n                    });\n\n                    const notificaciones = `\n                        <li class=\"${NO_LEIDO ? '' : 'bg-gray-90'} notificaciones-listado py-0\" id=\"notificacion-${id}\">\n                            <a class=\"dropdown-item text-gray-10 text-decoration-none border-top pt-0 pb-1\" href=\"javascript:void(0)\" onclick=\"marcarNotificacionesLeidas('${id}','${data?.ruta}')\">\n                                <div class=\"d-flex justify-content-between\">\n                                    <div class=\"w-auto flex-grow-1 pe-3\">\n                                        <p class=\"mt-1 mb-0 text-headline-6 text-gray-10\">${data?.titulo}</p>\n                                        <p class=\"mb-0 text-body-3 text-gray-30 notificacion-mensaje\">${MENSAJE}</p>\n                                    </div>\n                                    <div class=\"w-auto my-auto ${NO_LEIDO ? 'text-cta-azul' : 'text-gray-10'} text-label-2 flex-shrink-0\">\n                                        ${HORA}${NO_LEIDO ? `<i class=\"bi bi-circle-fill text-cta-azul my-auto texto-notificacion-icono ms-3\"></i>` : ''}\n                                    </div>\n                                </div>\n                            </a>\n                        </li>\n                    `;\n\n                    $(notificaciones).insertBefore('#contenedor-boton-marcar-todas');\n                });\n\n            } else {\n                $('#notificacion-sinnotificaciones').hide();\n                $('.notificaciones-listado').remove();\n            }\n\n        },\n        error: function(xhr, status, error) {\n            console.error('Error al cargar notificaciones:', error);\n        }\n    });\n}\n\n/**\n * Marcar las notificaciones leídas.\n *\n * @param {array} notificaciones_ids ids de las notificaciones\n * @param {string} ruta_destino ruta donde se va ha actualizar la pagina\n * @returns {void}\n * @author Andres Gonzalez\n * @author Esperanza Olivo\n */\nfunction marcarNotificacionesLeidas(notificaciones_ids = null, ruta_destino = null, soporte_id = null) {\n\n    let data = {\n        _token: $('meta[name=\"csrf-token\"]').attr('content')\n    };\n\n    if (notificaciones_ids === 'all') {\n        data.marcar_todo = true;\n    } else if (soporte_id) {\n        data.soporte_id = soporte_id;\n    } else if (notificaciones_ids) {\n        data.notificaciones_ids = Array.isArray(notificaciones_ids)\n            ? notificaciones_ids\n            : [notificaciones_ids];\n    }\n\n    $.ajax({\n        url: '/usuario-marcar-notificaciones-leidas',\n        type: 'POST',\n        data: data,\n        success: function(respuesta) {\n            cargarNotificiacionesHeader();\n\n            if (notificaciones_ids && notificaciones_ids !== 'all' && ruta_destino) {\n                window.location.href = \"/\" + ruta_destino;\n            }\n\n            if (notificaciones_ids === 'all') {\n                $('#badge-notificaciones').remove();\n                $('#contenedor-boton-marcar-todas').empty();\n                $('.notificaciones-listado').addClass('bg-gray-90');\n                $('.bi-circle-fill').remove();\n            }\n        },\n        error: function(xhr, estatus, error) {\n            console.error('Error al cargar notificaciones:', error);\n        }\n    });\n}\n\n/**\n * Configurar WebSocket para notificaciones en tiempo real\n *\n * @return void\n * @author Andres Gonzalez\n */\nfunction configurarWebSocketNotificaciones() {\n    try {\n        if (!window.configuracion_reverbg) {\n            return;\n        }\n\n        const PUSHER = new Pusher(window.configuracion_reverbg.appKey, {\n            wsHost: window.configuracion_reverbg.host,\n            wsPort: window.configuracion_reverbg.port,\n            wssPort: window.configuracion_reverbg.port,\n            cluster: 'mt1',\n            forceTLS: false,\n            enabledTransports: ['ws', 'wss'],\n            authEndpoint: '/broadcasting-auth',\n            auth: {\n                headers: {\n                    'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n                }\n            }\n        });\n\n        PUSHER.connection.bind('failed', function() {\n            console.error('❌ Conexión WebSocket falló');\n        });\n\n        PUSHER.connection.bind('error', function(error) {\n            console.error('❌ Error de WebSocket:', error);\n        });\n\n        let usuario_id = window.configuracion_reverbg.usuario_id;\n\n        if (!usuario_id) {\n            return;\n        }\n\n        const NOMBRE_CANAL = `private-App.Models.Usuarios.User.${usuario_id}`;\n        const CANAL = PUSHER.subscribe(NOMBRE_CANAL);\n\n        CANAL.bind('pusher:subscription_error', function(error) {\n            console.error('❌ Error al suscribirse al canal:', error);\n        });\n\n        // Escuchar eventos específicos de notificaciones\n        CANAL.bind('Illuminate\\\\Notifications\\\\Events\\\\BroadcastNotificationCreated', function(data) {\n            if (data.tipo === 'nueva_notificacion') {\n                audio_notificacion.play();\n                cargarNotificiacionesHeader();\n            }\n\n            if (data.tipo === 'nuevo_mensaje') {\n                if (($('#soporte-guardado-id').val() == data.soporte_id) || ($('#soporte_empresa_id').val() == data.soporte_id)) {\n                    audio_notificacion.play();\n                    consultarChat(data.soporte_id);\n                }\n            }\n        });\n    } catch (error) {\n        console.error('💥 Error en configurarWebSocketNotificaciones:', error);\n        console.error('Stack trace:', error.stack);\n    }\n}\n\n/**\n * Retornar el string entrante en formato title case.\n *\n * @param {string} texto\n * @returns {string}\n * @author Fahibram Cárcamo\n */\nfunction titleCase(texto) {\n    return texto.toLowerCase().replace(/\\b\\w/g, caracter => caracter.toUpperCase());\n}\n\n/**\n * Número de horas que durará el almacenamiento de la variable `ulitmas_empresas` en el\n * almacenamiento local **LocalStorage**.\n *\n * @var {number}\n * @author Fahibram Cárcamo\n */\nconst CANTIDAD_HORAS_VENCIMIENTO_ULTIMAS_EMPRESAS_LOCALSTORAGE = 6;\n\n/**\n * Validar si ya debe removerse la variable `ultimas_empresas` del alamacenamiento local\n * **LocalStorage**, si no es tiempo de eliminarla entonces se reinicia el tiempo de vigencia de la\n * variable.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction validarYActualizarUltimasEmpresasLocalStorage() {\n    let fecha_hora_actuales = moment();\n    let fecha_hora_vencimiento_ultimas_empresas = fecha_hora_actuales.clone().add(CANTIDAD_HORAS_VENCIMIENTO_ULTIMAS_EMPRESAS_LOCALSTORAGE, 'hours');\n    let fecha_hora_vencimiento_ultimas_empresas_localstorage = localStorage.getItem('vencimiento_ultimas_empresas');\n    let ultimas_empresas = localStorage.getItem('ultimas_empresas');\n\n    if (\n        ultimas_empresas != null &&\n        fecha_hora_vencimiento_ultimas_empresas_localstorage != null &&\n        fecha_hora_actuales.clone().isBefore(moment(fecha_hora_vencimiento_ultimas_empresas_localstorage).clone())\n    ) {\n        localStorage.setItem('vencimiento_ultimas_empresas', fecha_hora_vencimiento_ultimas_empresas.format('YYYY-MM-DD HH:mm:ss'));\n        return;\n    }\n\n    localStorage.removeItem('vencimiento_ultimas_empresas');\n    localStorage.removeItem('ultimas_empresas');\n}\n\n/**\n * Obtener la edad actual de un usuario según su fecha de nacimiento.\n *\n * @param {string} fecha_nacimiento\n * @returns {string}\n * @author José Manuel Jiménez\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction obtenerEdad(fecha_nacimiento) {\n    if (!fecha_nacimiento) return \"N/A\";\n    let hoy = new Date();\n    let nacimiento = new Date(fecha_nacimiento);\n    let edad = hoy.getFullYear() - nacimiento.getFullYear();\n    let mes = hoy.getMonth() - nacimiento.getMonth();\n    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) edad--;\n    return edad + \" años\";\n}\n\n/**\n * Restablecer un input de tipo file.\n *\n * @param {html} elemento_input_html Elemento input html.\n * @param {html} label_elemento_input_html Label del elemento input html.\n * @param {html} boton_eliminar_elemento_input_html Botón para eliminar archivo del elemento input html.\n * @author Fahibram Cárcamo\n */\nfunction reiniciarCampoArchivo(elemento_input_html, label_elemento_input_html, boton_eliminar_elemento_input_html) {\n    elemento_input_html.val('');\n    elemento_input_html.removeAttr('data-base64');\n    label_elemento_input_html.text('Ningún archivo seleccionado');\n    boton_eliminar_elemento_input_html.hide();\n\n    if (elemento_input_html.data('imagen')) {\n        $('#' + elemento_input_html.data('imagen')).val('');\n        $('#' + elemento_input_html.data('imagen') + '_previsualizacion').attr('src', '');\n        $('#' + elemento_input_html.data('imagen') + '_fondo_previsualizacion').removeClass('d-none');\n    }\n}\n\n/**\n * Definir un campo destinado a recibir un número de teléfono celular.\n *\n * Esta función debe llamarse en el evento ready del objeto global document:\n * `$(document).ready(...)`. Ademas debe incluirse un pequeño fragmento de código en la función\n * `validacionAdicional` para que se agregué el código del número de celular al valor de campo\n * cuando se envíe el formulario donde se encutra el campo.\n *\n * ```\n * if (\n *   $('#input_celular_id').length &&\n *   $('#input_celular_id').val() !== '' &&\n *   input_celular.getNumber() !== ''\n * ) {\n *   $('#input_celular_id').val(input_celular.getNumber().slice(1));\n * }\n * ```\n *\n * Donde `input_celular` es el objeto retornado por esta función.\n *\n * @param {string} input_celular_id Id del campo.\n * @param {string} nombre_input_celular Nombre del campo.\n * @param {string} placeholder_input_celular Placeholder del campo.\n * @param {boolean} obligatorio El campo es obligatorio en el formulario.\n * @returns {object}\n * @author Fahibram Cárcamo\n */\nfunction definirInputTipoCelular(input_celular_id, nombre_input_celular, placeholder_input_celular, obligatorio = true) {\n    /**\n     * 🌎 Campo para ingresar un número de telefono con selectór de código de país con banderas.\n     * Este componente se creó con la librería International Telephone Input\n     * (https://intl-tel-input.com).\n     *\n     * La linea hiddenInput: () => ({ phone: 'celular_contacto' }) tiene como función establecer el\n     * nombre del campo, es decir, la llave del par llave-valor que se adjuntará en los datos del\n     * formulario cuando se envíe, en este caso 'celular_contacto'.\n     *\n     * Las lienas autoPlaceholder: 'aggressive' y\n     * customPlaceholder: (placeholder, country) => 'Celular*' se usan para definir el placeholder\n     * del campo.\n     *\n     * Con $('#celular_contacto').attr('required', true); se establece el campo como requerido\n     * dentro del formulario, se hace de esta forma porque la librería no admite el atributo\n     * required directamente en el componente html.\n     *\n     * @author Fahibram Cárcamo\n     */\n    if (document.querySelector(`#${input_celular_id}`)) {\n        const dropdown_dinamico = document.createElement('div');\n        document.body.appendChild(dropdown_dinamico);\n\n        let campo_celular = window.intlTelInput(document.querySelector(`#${input_celular_id}`), {\n            nationalMode: true,\n            initialCountry: 'co',\n            separateDialCode: true,\n            autoInsertDialCode: false,\n            autoPlaceholder: 'aggressive',\n            dropdownContainer: dropdown_dinamico,\n            customPlaceholder: (placeholder, country) => placeholder_input_celular,\n            loadUtils: () => import('https://cdn.jsdelivr.net/npm/intl-tel-input@25.4.2/build/js/utils.js'),\n            onlyCountries: [\n                'CO', // Colombia\n                'EC', // Ecuador\n                'AR', // Argentina\n                'CL', // Chile\n                'VE', // Venezuela\n                'PE', // Perú\n                'BO', // Bolivia\n                'UY', // Uruguay\n                'PY', // Paraguay\n                'PA', // Panamá\n                'MX', // México\n                'CR', // Costa Rica\n                // 'PR', // Puerto Rico\n                'CU', // Cuba\n                // 'DO', // República Dominicana\n                'SV', // El Salvador\n                'GT', // Guatemala\n                'HN', // Honduras\n                'NI', // Nicaragua\n                'ES', // España\n                'US', // Estados Unidos\n                'GQ'  // Guinea Ecuatorial\n            ]\n        });\n\n        if (obligatorio) $(`#${input_celular_id}`).attr('required', true);\n\n        return campo_celular;\n    }\n\n    return null;\n}\n\n/**\n * Establece la validación adicional que se aplica a un campo de tipo celular antes de enviar sus\n * datos en un formulario.\n *\n * @param {HTMLInputElement} input Elemento HTML del campo de tipo celular.\n * @param {string} input_id Id del elemento HTML del campo de tipo celular.\n * @author Fahibram Cárcamo\n * @author Jair Carvajal\n */\nfunction validacionAdicionalInputTipoCelular(input, input_id) {\n    let numero_completo = input.getNumber();\n    let indicativo = '+' + input.getSelectedCountryData().dialCode;\n    let codigo_iso2_pais = input.getSelectedCountryData().iso2;\n    let numero_sin_indicativo = numero_completo.replace(indicativo, '');\n    $(`#indicativo_${input_id}`).val(indicativo);\n    $(`#codigo_iso2_pais_${input_id}`).val(codigo_iso2_pais);\n    $(`#${input_id}`).val(numero_sin_indicativo);\n}\n\n/**\n * Rellenar un input de tipo celular.\n *\n * @param {string} indicativo_celular Código del país del número de celular.\n * @param {string} codigo_pais_iso2 Código ISO2 del país del número de celular.\n * @param {string} numero_celular Número de celular sin código de país.\n * @param {string} input_celular_id ID del input de tipo celular.\n * @param {HTMLInputElement} input_celular Input de tipo celular.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nfunction rellenarInputCelular(indicativo_celular, codigo_pais_iso2, numero_celular, input_celular_id, input_celular) {\n    $(`#${input_celular_id}`).val(numero_celular);\n    if (![null, undefined].includes(codigo_pais_iso2)) input_celular.setCountry(codigo_pais_iso2);\n}\n\n/**\n * Convierte imágenes de base64 a Blob.\n *\n * @param {string} cadena_base_64 Base 64 de la imagen.\n * @returns {Promise<Array>}\n * @author Andres Gonzalez\n */\nfunction imagenBase64Blob(cadena_base_64) {\n    if (!cadena_base_64 || !cadena_base_64.startsWith('data:image')) return null;\n    let datos_base_64 = cadena_base_64.split(',')[1];\n    let tipo_mime = cadena_base_64.match(/data:(.*?);base64/)[1];\n    let caracteres_binarios = atob(datos_base_64);\n    let arreglo_bytes = new Array(caracteres_binarios.length).fill(0).map((_, i) => caracteres_binarios.charCodeAt(i));\n    let bytes_uint8 = new Uint8Array(arreglo_bytes);\n    return new Blob([bytes_uint8], { type: tipo_mime });\n}\n\n\n/**\n * Limpiar estructuras html innecesarias en el check editor.\n *\n * @param {string} html - Cadena HTML generada por CKEditor a limpiar\n * @returns {string} HTML limpio sin elementos específicos de CKEditor\n * @author Andres Gonzalez\n * @author Jair Carvajal\n */\nfunction limpiarHTMLCKEditor(html) {\n    // Remover todos los elementos con clases de CKEditor\n    html = html.replace(/<div class=\"ck[^\"]*\"[^>]*>.*?<\\/div>/gs, '');\n    html = html.replace(/<span class=\"[^\"]*ck[^\"]*\"[^>]*>/gi, '<span>');\n\n    // Limpiar spans de imagen inline\n    html = html.replace(/<span class=\"image-inline[^\"]*\"[^>]*>/gi, '');\n    html = html.replace(/<\\/span>/g, '');\n\n    // Remover elementos de upload y widgets\n    html = html.replace(/<div class=\"ck-image-upload[^\"]*\"[^>]*>.*?<\\/div>/gs, '');\n    html = html.replace(/<div class=\"ck-fake-selection[^\"]*\"[^>]*>.*?<\\/div>/gs, '');\n\n    // Remover atributos innecesarios\n    html = html.replace(/contenteditable=\"[^\"]*\"/gi, '');\n    html = html.replace(/data-cke-filler=\"[^\"]*\"/gi, '');\n\n    // Limpiar párrafos vacíos con br\n    html = html.replace(/<p><br[^>]*><\\/p>/gi, '');\n    html = html.replace(/<br data-cke[^>]*>/gi, '');\n\n    // Limpiar espacios múltiples y saltos de línea\n    html = html.replace(/\\s+/g, ' ');\n    html = html.replace(/>\\s+</g, '><');\n\n    return html.trim();\n}\n\n/**\n * Ordena estudios por fecha_inicio más reciente (de más nueva a más antigua).\n * Preserva los índices originales para permitir edición y eliminación correcta.\n *\n * @param {Array} estudios - Array de objetos con estudios\n * @returns {Array} Array de estudios ordenados con propiedad indice_original\n * @author Jair Carvajal\n */\nfunction ordenarEstudiosPorFecha(estudios) {\n    // Mapear con índice original\n    let estudios_con_indice = estudios.map((estudio, indice_original) => ({\n        ...estudio,\n        indice_original: indice_original\n    }));\n\n    // Ordenar estudios por fecha_inicio (más reciente primero)\n    let estudios_ordenados = estudios_con_indice.sort((a, b) => {\n        // Si ambos tienen fecha_inicio, ordenar por más reciente\n        if (a.fecha_inicio && b.fecha_inicio) {\n            return moment(b.fecha_inicio).diff(moment(a.fecha_inicio));\n        }\n        // Si solo uno tiene fecha_inicio, ese va primero\n        if (a.fecha_inicio && !b.fecha_inicio) return -1;\n        if (!a.fecha_inicio && b.fecha_inicio) return 1;\n        // Si ninguno tiene fecha_inicio, mantener orden original\n        return 0;\n    });\n\n    return estudios_ordenados;\n}\n\n/**\n * Ordena experiencias laborales por fecha: primero las que está trabajando actualmente (sin fecha_fin),\n * luego por fecha_fin más reciente.\n * Preserva los índices originales para permitir edición y eliminación correcta.\n *\n * @param {Array} experiencias - Array de objetos con experiencias laborales\n * @returns {Array} Array de experiencias ordenadas con propiedad indice_original\n * @author Jair Carvajal\n */\nfunction ordenarExperienciasPorFecha(experiencias) {\n    // Mapear con índice original\n    let experiencias_con_indice = experiencias.map((experiencia, indice_original) => ({\n        ...experiencia,\n        indice_original: indice_original\n    }));\n\n    // Ordenar experiencias\n    let experiencias_ordenadas = experiencias_con_indice.sort((a, b) => {\n        // Si 'a' no tiene fecha_fin (trabaja actualmente), va primero\n        if (!a.fecha_fin && b.fecha_fin) return -1;\n        // Si 'b' no tiene fecha_fin (trabaja actualmente), va primero\n        if (a.fecha_fin && !b.fecha_fin) return 1;\n        // Si ambos están trabajando actualmente (sin fecha_fin), mantener el orden actual\n        if (!a.fecha_fin && !b.fecha_fin) return 0;\n        // Si ambos tienen fecha_fin, ordenar por fecha más reciente primero (descendente)\n        return moment(b.fecha_fin).diff(moment(a.fecha_fin));\n    });\n\n    return experiencias_ordenadas;\n}\n\n/**\n * Obtener créditos disponibles de la empresa y actualizar el tag.\n * - Si tiene créditos >= 20% del plan: tag azul\n * - Si tiene créditos < 20% del plan: tag amarillo\n * - Si no tiene créditos: tag gris \"Sin créditos\"\n *\n * @param {number} empresa_id ID de la empresa\n * @param {string} contenedor_id ID del contenedor donde se mostrará el tag\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction obtenerCreditosDisponiblesEmpresa(empresa_id, contenedor_id = 'contenedor-tag-creditos') {\n    if (!empresa_id || !$(`#${contenedor_id}`).length) {\n        return;\n    }\n\n    $.ajax({\n        url: `/empresas/${empresa_id}/creditos`,\n        method: 'GET',\n        dataType: 'json',\n        success: function(respuesta) {\n            let creditos_disponibles = respuesta?.data?.creditos_disponibles ?? 0;\n            let creditos_plan = respuesta?.data?.creditos_plan ?? 0;\n            let plan_credito = respuesta?.data?.plan_credito;\n            let porcentaje_disponible = creditos_plan > 0 ? (creditos_disponibles / creditos_plan) * 100 : 0;\n\n            let texto_tag = '';\n            let clase_tag = '';\n            let icono_final = '';\n\n            if (creditos_disponibles <= 0 || plan_credito === null) {\n                texto_tag = 'Sin créditos';\n                clase_tag = 'tag-tonal-gray';\n                icono_final = `<i class=\"bi bi-info-circle ms-1\" role=\"button\" tabindex=\"0\" ${crearTooltip({ placement: 'right', content: 'No tienes créditos disponibles en este momento. Renueva tu plan o adquiere más créditos para continuar.' })}></i>`;\n            } else if (porcentaje_disponible < 20) {\n                texto_tag = `Créditos disponibles: ${formatearNumero(creditos_disponibles)}`;\n                clase_tag = 'tag-filled-yellow';\n                icono_final = `<i class=\"bi bi-info-circle ms-1\" role=\"button\" tabindex=\"0\" ${crearTooltip({ placement: 'right', content: 'Estás cerca de agotar tus créditos. Te queda menos del 20% del total disponible. Considera recargar o revisar tu consumo para evitar interrupciones.' })}></i>`;\n            } else {\n                texto_tag = `Créditos disponibles: ${formatearNumero(creditos_disponibles)}`;\n                clase_tag = 'tag-tonal-blue';\n            }\n\n            $(`#${contenedor_id}`).html(crearTag({\n                texto: texto_tag,\n                class: clase_tag,\n                icono_final: icono_final,\n            }));\n\n            inicializarTooltips();\n        },\n        error: function (error) {\n            $(`#${contenedor_id}`).html(crearTag({\n                texto: error.status === 404 ? 'No tienes plan de créditos' : 'Error al cargar créditos',\n                class: 'tag-tonal-gray'\n            }));\n        }\n    });\n}\n","numLines":1463,"startLine":1,"totalLines":1463}},"sourceToolAssistantUUID":"ed11d322-698f-439d-89dd-93577347bfcf"}
{"parentUuid":"2a42571b-eeda-4885-bb28-9243f31b005a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01F519Mv5sAK3TLguzPcxFxN","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que cree una función para obtener las funcionalidades activas del plan de la empresa y que sobrescriba la variable `configuraciones_disponibles_empresa`. La ruta es `/funcionalidades-activas-plan`.\n\nDebo:\n1. Crear la función que haga la petición AJAX a `/funcionalidades-activas-plan`\n2. Actualizar la variable `configuraciones_disponibles_empresa` con los datos obtenidos\n3. Documentar apropiadamente la función siguiendo las convenciones del proyecto\n\nLa función debería llamarse algo como `obtenerFuncionalidadesActivasPlan()` siguiendo la convención de nomenclatura del proyecto (camelCase para funciones).","signature":"Ep8GCkYICxgCKkCwZwrPSl6Wo7nYWMoEkg/Lz6kuf8MGicUAsc1CTLHlJV+myF1yIs8XLkiwgPBePDKOh2X4ku7c2zP0h4dFCnSgEgzj4xKuhjA0zNKx2JoaDF490Skm4hAc1bt+GSIwWw2IzInLKV3XQdDPJD+1GN7Vhp2mouoEl9s+kSNFP99kJAYM9ieUxOwn9SNxpgv6KoYFtRanADx7sQlnAiNzLXCW+lLaKU/TMwbyx2VHxyox469aEuU5SleJ5OmsaAeIbPggSBYYzw9QOOqAZzee/oirGPqFtbBLnkjKa0ku11hf5K++HBPhtS914AvjO3/ddQ+dU96ULmou/pQHOW9JfoAwBXBmbrU40ac7nf/QxYg6aUGT27a2httsWgAtw++Znj/iADGDA513UwqokxjE9RGM/b5xV9iM4FAnw/IxKOC4e4z0Jbp0zmyHYHO0iOi43ndeXzVOTkLAIMeCYXk5tqaIOV3IGebGv9hTb2z3MeveA1Y0aDfYki9u7jb4uXt5odaw6BlqnrOZnl1mZyh3nKRQ2CeEgpGa2YK2tX9REdLyXbhUzc1EC06HxQOZJvmmxRYJ9bKlaP1R6lTSETz803K6kMA5nO9xwHv6t5CPzcXc16r0UtH2l85gQVV0x2CVabsrwGAsfgiTbv2u6vPFW2Xfh6DKRsul2GbwYIej5COa12I+OKpZUrdXtMSSdQwj1cwGfDod9dxOrKuN3VqlBmnao18OmrCjxXbpB6cR3YUdObuav+MRYL4pzRqqOskbXdCmDCW66HeFwWMGLslns+2Yw52uZ1H1FUj00Wk+HYXl7horybxIa/DuOQKBkMRvwackFjzvcL6O4wPswcLofBvxRpEoUMsT27cO4Y5rRcg4SiapQfqD2lJAx/qSyS/sHiY1x35AeeYfhBBV37VOvFhypNxwsBfY1s3Y8CEoNwL0n3M8A9cDLm6wl3H9OLcCPmaAsp81ToJTYrIiF5pTKUD4yyHGe9lhmn82PFAR/cziSAUZS0O34+YxbuKwn3lqbfSt46BdcZ+5BwLABRR0p3/EA89ZwYWg9RgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":22626,"cache_read_input_tokens":65156,"cache_creation":{"ephemeral_5m_input_tokens":22626,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXYAe4yvTrxUDVKDeUpXB","type":"assistant","uuid":"302e3848-bb0e-4e21-b6b1-80d2feae031f","timestamp":"2026-01-27T16:04:39.758Z"}
{"parentUuid":"302e3848-bb0e-4e21-b6b1-80d2feae031f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01F519Mv5sAK3TLguzPcxFxN","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a agregar la función para obtener las funcionalidades activas del plan. La agregaré después de la declaración de la variable `configuraciones_disponibles_empresa`."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":22626,"cache_read_input_tokens":65156,"cache_creation":{"ephemeral_5m_input_tokens":22626,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXYAe4yvTrxUDVKDeUpXB","type":"assistant","uuid":"3fbe0cae-dbe2-44ee-bfab-64a64de9809d","timestamp":"2026-01-27T16:04:40.448Z"}
{"parentUuid":"3fbe0cae-dbe2-44ee-bfab-64a64de9809d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01F519Mv5sAK3TLguzPcxFxN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WSYwZgFncdnbTAp4Aw4rWb","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\globales.js","old_string":"let configuraciones_disponibles_empresa = null;\n\n/**\n * Mostrar modal de créditos IA","new_string":"let configuraciones_disponibles_empresa = null;\n\n/**\n * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.\n *\n * Realiza una petición AJAX a la API para obtener las funcionalidades habilitadas\n * y actualiza la variable global `configuraciones_disponibles_empresa`.\n *\n * @param {number|null} tipo_prueba_id ID del tipo de prueba (opcional).\n * @returns {Promise} Promesa que se resuelve con las funcionalidades activas.\n * @author Andres Gonzalez\n */\nfunction obtenerFuncionalidadesActivasPlan(tipo_prueba_id = null) {\n    let parametros = {};\n\n    if (tipo_prueba_id !== null) {\n        parametros.tipo_prueba_id = tipo_prueba_id;\n    }\n\n    return $.ajax({\n        url: '/funcionalidades-activas-plan',\n        method: 'GET',\n        dataType: 'json',\n        data: parametros,\n        success: function(respuesta) {\n            configuraciones_disponibles_empresa = respuesta?.data ?? [];\n        },\n        error: function(error) {\n            console.error('Error al obtener funcionalidades activas del plan:', error);\n            configuraciones_disponibles_empresa = [];\n        }\n    });\n}\n\n/**\n * Mostrar modal de créditos IA"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":22626,"cache_read_input_tokens":65156,"cache_creation":{"ephemeral_5m_input_tokens":22626,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXYAe4yvTrxUDVKDeUpXB","type":"assistant","uuid":"8d2d34ba-dd42-4b60-b3a2-55432543f8dc","timestamp":"2026-01-27T16:04:45.882Z"}
{"type":"file-history-snapshot","messageId":"8d2d34ba-dd42-4b60-b3a2-55432543f8dc","snapshot":{"messageId":"81a7c172-5e13-4d36-ab7f-afb0a45547de","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v3","version":3,"backupTime":"2026-01-27T16:00:46.237Z"},"app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php":{"backupFileName":"71d1198be92c5143@v2","version":2,"backupTime":"2026-01-27T16:00:46.251Z"},"public\\js\\globales.js":{"backupFileName":"704f632e999527e6@v1","version":1,"backupTime":"2026-01-27T16:05:00.043Z"}},"timestamp":"2026-01-27T16:04:24.831Z"},"isSnapshotUpdate":true}
{"parentUuid":"8d2d34ba-dd42-4b60-b3a2-55432543f8dc","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WSYwZgFncdnbTAp4Aw4rWb","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\globales.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    34→let mostro_modal_creditos_ia = false;\n    35→let funcion_ejecucion_ia = null;\n    36→let modals_abiertos_ia = null;\n    37→\n    38→let configuraciones_disponibles_empresa = null;\n    39→\n    40→/**\n    41→ * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.\n    42→ *\n    43→ * Realiza una petición AJAX a la API para obtener las funcionalidades habilitadas\n    44→ * y actualiza la variable global `configuraciones_disponibles_empresa`.\n    45→ *\n    46→ * @param {number|null} tipo_prueba_id ID del tipo de prueba (opcional).\n    47→ * @returns {Promise} Promesa que se resuelve con las funcionalidades activas.\n    48→ * @author Andres Gonzalez\n    49→ */\n    50→function obtenerFuncionalidadesActivasPlan(tipo_prueba_id = null) {\n    51→    let parametros = {};\n    52→\n    53→    if (tipo_prueba_id !== null) {\n    54→        parametros.tipo_prueba_id = tipo_prueba_id;\n    55→    }\n    56→\n    57→    return $.ajax({\n    58→        url: '/funcionalidades-activas-plan',\n    59→        method: 'GET',\n    60→        dataType: 'json',\n    61→        data: parametros,\n    62→        success: function(respuesta) {\n    63→            configuraciones_disponibles_empresa = respuesta?.data ?? [];\n    64→        },\n    65→        error: function(error) {\n    66→            console.error('Error al obtener funcionalidades activas del plan:', error);\n    67→            configuraciones_disponibles_empresa = [];\n    68→        }\n    69→    });\n    70→}\n    71→\n    72→/**\n    73→ * Mostrar modal de créditos IA\n    74→ *\n    75→ * @return void\n    76→ * @author José Manuel Jiménez\n    77→ */"}]},"uuid":"15804805-6dbf-454b-a2df-8aeb63c16a4b","timestamp":"2026-01-27T16:05:00.105Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\globales.js","oldString":"let configuraciones_disponibles_empresa = null;\n\n/**\n * Mostrar modal de créditos IA","newString":"let configuraciones_disponibles_empresa = null;\n\n/**\n * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.\n *\n * Realiza una petición AJAX a la API para obtener las funcionalidades habilitadas\n * y actualiza la variable global `configuraciones_disponibles_empresa`.\n *\n * @param {number|null} tipo_prueba_id ID del tipo de prueba (opcional).\n * @returns {Promise} Promesa que se resuelve con las funcionalidades activas.\n * @author Andres Gonzalez\n */\nfunction obtenerFuncionalidadesActivasPlan(tipo_prueba_id = null) {\n    let parametros = {};\n\n    if (tipo_prueba_id !== null) {\n        parametros.tipo_prueba_id = tipo_prueba_id;\n    }\n\n    return $.ajax({\n        url: '/funcionalidades-activas-plan',\n        method: 'GET',\n        dataType: 'json',\n        data: parametros,\n        success: function(respuesta) {\n            configuraciones_disponibles_empresa = respuesta?.data ?? [];\n        },\n        error: function(error) {\n            console.error('Error al obtener funcionalidades activas del plan:', error);\n            configuraciones_disponibles_empresa = [];\n        }\n    });\n}\n\n/**\n * Mostrar modal de créditos IA","originalFile":"// Mensajes en español para el plugin Select2\nconst mensajes_select2 = {\n    'noResults'              : () => { return 'No hay resultados para la búsqueda.'; },\n    'searching'              : () => { return 'Buscando...'; },\n    'Loading'                : () => { return 'Cargando...'; },\n    'loadingMore'            : () => { return 'Cargando más resultados...'; },\n    'dropdownFooter'         : (texto) => { return `Mostrando ${texto} resultados`; },\n    'emptyOptions'           : () => { return 'No hay opciones disponibles.'; },\n    'appendItems'            : (items) => { return `Agregando ${items.length} elementos.`; },\n    'maximumSelectionReached': () => { return 'Se ha alcanzado el número máximo de selecciones.'; },\n    'selectOnClose'          : () => { return 'Seleccione una opción al cerrar el menú.'; },\n    'escapeKeyUp'            : () => { return 'Presione \\'Escape\\' para cerrar el menú.'; },\n    'errorLoading'           : () => { return 'Error al cargar datos. Inténtalo de nuevo más tarde.'; },\n    'inputTooShort'          : (elemento) => { return `Ingresa al menos ${elemento.minimum} caracteres para iniciar una búsqueda.`; },\n    'noMatches'              : () => { return 'No se encontraron coincidencias para tu búsqueda.'; },\n    'allowClear'             : () => { return 'Borrar selección'; },\n    'SelectionTooLong'       : (conteo, maximo) => { return `Solo puedes seleccionar ${maximo} opciones.`; },\n    'loadMore'               : () => { return 'Cargando más resultados...'; },\n    'removing'               : (seleccion) => { return 'Eliminando...'; },\n    'matches'                : (coincidencias, total) => {\n        if (coincidencias === 0) {\n            return 'No hay coincidencias.';\n        } else if (coincidencias === 1) {\n            return 'Se encontró 1 coincidencia.';\n        } else {\n            return `Se encontraron ${coincidencias} coincidencias entre ${total}.`;\n        }\n    }\n};\n\n// audios\nvar audio_notificacion = new Audio('/audios/notificacion.mp3');\n\nlet mostro_modal_creditos_ia = false;\nlet funcion_ejecucion_ia = null;\nlet modals_abiertos_ia = null;\n\nlet configuraciones_disponibles_empresa = null;\n\n/**\n * Mostrar modal de créditos IA\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction mostrarModalCreditosIA(servicio_ia_id) {\n    $.ajax({\n        url: `/empresas/${$('#empresa_sesion_id').val()}/creditos`,\n        method: 'GET',\n        dataType: 'json',\n        success: function(respuesta_empresa) {\n            if (respuesta_empresa?.data?.creditos_disponibles > 0) {\n                $.ajax({\n                    url: `/servicios-ia/${servicio_ia_id}/creditos`,\n                    method: 'GET',\n                    dataType: 'json',\n                    success: function(respuesta) {\n                        if (respuesta?.data?.consume_creditos && respuesta?.data?.consume_creditos <= respuesta_empresa.data.creditos_disponibles) {\n                            $('#cantidad-creditos-descontar-modal').text(respuesta.data.consume_creditos);\n                            $('#modal-consumo-creditos-ia').modal('show');\n                            mostro_modal_creditos_ia = true;\n                            modals_abiertos_ia = $('.modal.show').not('#modal-consumo-creditos-ia').not('#modal-generando-ia');\n                            $(modals_abiertos_ia).addClass('d-none');\n                        } else {\n                            mostrarToastSolicitarCreditosIA();\n                        }\n                    }\n                });\n            } else {\n                mostrarToastSolicitarCreditosIA();\n            }\n        }\n    });\n}\n\n/**\n * Mostrar toast para solicitar créditos IA\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction mostrarToastSolicitarCreditosIA() {\n    $.ajax({\n        url: `/empresas/${$('#empresa_sesion_id').val()}`,\n        method: 'GET',\n        dataType: 'json',\n        success: function(respuesta) {\n            let adicional_toast = '';\n            if (respuesta?.data?.ejecutivo?.telefono) {\n                adicional_toast = `<a href=\"https://wa.me/${respuesta.data.ejecutivo.telefono.replace(/\\D/g, '')}?text=Hola,%20me%20gustar%C3%ADa%20solicitar%20cr%C3%A9ditos%20adicionales%20para%20mi%20empresa.\" target=\"_blank\">\n                    <p class=\"text-label-1 text-white no-visited text-decoration-none mb-0\">Solicitar</p>\n                </a>`;\n            }\n            setTimeout(() => {\n                $('#modal-generando-ia').modal('hide');\n                $('#modal-cargue-ia').modal('hide');\n                mostrarToast('danger', 'No cuentas con créditos. Solicita créditos adicionales.', '', adicional_toast);\n            }, 300);\n        }\n    });\n}\n\n/**\n * Continuar ejecución IA luego del modal de créditos\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction continuarEjecucionIA() {\n    if (funcion_ejecucion_ia) {\n        funcion_ejecucion_ia();\n        funcion_ejecucion_ia = null;\n    }\n    mostro_modal_creditos_ia = false;\n    $('#modal-consumo-creditos-ia').modal('hide');\n}\n\n/**\n * Solicitar más créditos IA\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction solicitarMasCreditosIA() {\n    $.ajax({\n        url: `/empresas/${$('#empresa_sesion_id').val()}`,\n        method: 'GET',\n        dataType: 'json',\n        success: function(respuesta) {\n            if (respuesta?.data?.ejecutivo?.telefono) {\n                window.open(`https://wa.me/${respuesta.data.ejecutivo.telefono.replace(/\\D/g, '')}?text=Hola,%20me%20gustar%C3%ADa%20solicitar%20cr%C3%A9ditos%20adicionales%20para%20mi%20empresa.`, '_blank');\n            } else {\n                mostrarToast('danger', 'No se encontró un ejecutivo asignado a la empresa. Por favor, comunícate con soporte para recargar créditos.');\n            }\n            $('#modal-solicitar-mas-creditos-ia').modal('hide');\n        }\n    });\n}\n\n/**\n * Validar respuesta de créditos IA\n *\n * @return void\n * @author José Manuel Jiménez\n */\nfunction validarRespuestaCreditosIA(error_ia) {\n    if (error_ia == 'No tienes créditos disponibles en este momento. Renueva tu plan o adquiere más créditos para continuar.') {\n        mostrarToastSolicitarCreditosIA();\n        return true;\n    }\n    return false;\n}\n\n/**\n * Ajustar el ancho de los elementos select2 asincrono multiple.\n *\n * @returns {void}\n * @author Andres Morales\n */\n$(document).ready(function () {\n    cargarNotificiacionesHeader();\n    if (window.configuracion_reverbg && window.configuracion_reverbg.activar_websocket) {\n        configurarWebSocketNotificaciones();\n    }\n    setTimeout(() => {\n        $(\".input-container\").each(function () {\n            let $container = $(this);\n            let $select = $container.find(\"select[multiple]\");\n            let $icon = $container.find(\".input-icono1\");\n            if ($select.length && $icon.length) {\n                $(this).find('.select2-selection--multiple').addClass('ps-5')\n            }\n        });\n    }, 1000);\n    $('#modal-consumo-creditos-ia').on('hidden.bs.modal', function () {\n        if (mostro_modal_creditos_ia) {\n            $(modals_abiertos_ia).removeClass('d-none');\n        }\n        mostro_modal_creditos_ia = false;\n    });\n\n    // Cargar créditos disponibles si existe el contenedor y el ID de empresa\n    if ($('#contenedor-tag-creditos').length && $('#empresa_sesion_id').length) {\n        obtenerCreditosDisponiblesEmpresa($('#empresa_sesion_id').val());\n    }\n});\n\n/**\n * Formatear fecha a formato dd/mm/yyyy - hh:mm AM/PM.  Ejemplo: 01/Feb/2022 - 12:00 PM\n *\n * @param {string} fecha_entrada fecha en formato ISO\n * @returns {string} fecha y hora formateada\n * @author Andres Morales\n */\nfunction formatearFecha(fecha_entrada) {\n    var fecha = new Date(fecha_entrada);\n    var dia = fecha.getDate();\n    var mes = fecha.toLocaleString('es-ES', { month: 'short' });\n    var anio = fecha.getFullYear();\n    let hora = fecha.getHours();\n    let minuto = fecha.getMinutes();\n    let ampm = hora >= 12 ? 'PM' : 'AM';\n    hora = hora % 12 || 12;\n    minuto = minuto.toString().padStart(2, '0');\n    return `${dia}/${mes}/${anio} - ${hora}:${minuto} ${ampm}`;\n}\n\nfunction formatearFecha2(fecha_entrada) {\n    let partes = fecha_entrada.split(' ');\n    let fecha = partes[0].split('-');\n    let hora = partes[1];\n    let fechaISO = `${fecha[2]}-${fecha[1]}-${fecha[0]}T${hora}`;\n\n    let date = new Date(fechaISO);\n\n    if (isNaN(date.getTime())) {\n        return 'Fecha inválida';\n    }\n\n    let dia = date.getDate();\n    let mes = date.toLocaleString('eu-EU', { month: 'short' });\n    let anio = date.getFullYear();\n    return `${dia}/${mes}/${anio}`;\n}\n\n/**\n * Opción para contraer o agrandar el menú principal\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction contraerMenu() {\n    if ($('.sidebar-menu').hasClass('close')) {\n        $('.sidebar-menu').removeClass('d-none');\n        localStorage.setItem('opcion_menu_storage', 'abierto');\n        $('#btn-collapse').attr('data-bs-original-title', 'Contraer');\n        $('#btn-collapse').attr('data-bs-title', 'Contraer');\n        $(\".menu-bar\").each(function() {\n            $(this).removeClass(\"px-2\").addClass(\"px-5\");\n        });\n        $('[data-bs-toggle=\"tooltip\"]').each(function () { new bootstrap.Tooltip(this); });\n        $('.lista-primary[data-bs-toggle=\"tooltip\"]').each(function () {\n            var tooltip_instancia = bootstrap.Tooltip.getInstance(this);\n            if (tooltip_instancia) {\n                tooltip_instancia.dispose();\n            }\n        });\n    } else {\n        $('.sidebar-menu').addClass('d-none');\n        localStorage.setItem('opcion_menu_storage', 'cerrado');\n        $('#btn-collapse').attr('data-bs-original-title', 'Expandir');\n        $('#btn-collapse').attr('data-bs-title', 'Expandir');\n        $(\".menu-bar\").each(function() {\n            $(this).removeClass(\"px-5\").addClass(\"px-2\");\n        });\n        $('[data-bs-toggle=\"tooltip\"]').each(function () { new bootstrap.Tooltip(this); });\n    }\n    $('.tooltip.bs-tooltip-auto').remove();\n    $('.sidebar-menu').toggleClass('close');\n    $('.contenedor-vista').toggleClass('close');\n    $('#btn-collapse').toggleClass('close');\n    $('.nombre-usuario-empresa').toggle();\n    $('.menu-bar .text-menu').toggle();\n}\n\n/**\n * Opción para abrir o cerrar el menu segun la elección guardada\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction mostrarMenuStorage() {\n    $(document).ready(function() {\n        $('.lista-primary[data-bs-toggle=\"tooltip\"]').each(function () {\n            var tooltip_instancia = bootstrap.Tooltip.getInstance(this);\n            if (tooltip_instancia) {\n                tooltip_instancia.dispose();\n            }\n        });\n\n        if (window.innerWidth < 768) {\n            localStorage.setItem('opcion_menu_storage', 'cerrado');\n        }\n\n        if (localStorage.getItem('opcion_menu_storage') === 'cerrado') {\n            contraerMenu();\n        }\n        let $active = $('.menu-bar .active');\n\n        if ($active.length) {\n            $('.menu-bar').scrollTop($active.position().top);\n        }\n    });\n}\nmostrarMenuStorage();\n\n/**\n * Funcion para hacer el slug de un texto desde jquery.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction slugify(text) {\n    return $.trim(text)\n        .toLowerCase()\n        .normalize(\"NFD\")\n        .replace(/[\\u0300-\\u036f]/g, \"\")\n        .replace(/[^a-z0-9 -]/g, \"\")\n        .replace(/\\s+/g, \"-\")\n        .replace(/-+/g, \"-\");\n}\n\n/**\n * Función generica para mostrar mensajes de respuesta\n *\n * @param {string} tipo_alerta define el color de la alerta segun alerts de botstrap.\n * @param {string} texto_1 Texto que mostrara la alerta.\n * @param {string} texto_2 Texto secundario en la alerta.\n * @param {string} accion Acción adicional(por definir).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction mostrarToast(tipo_alerta, texto_1, texto_2 = '', accion = '', icono2 = '') {\n    let icono = '';\n    let texto_color = 'text-white';\n    if (accion != '') {\n        accion = `<div class=\"col-auto p-0 text-label-1\">${accion}</div>`;\n    }\n\n    if (tipo_alerta == 'success') {\n        icono = 'bi bi-check-circle';\n    }\n\n    if (tipo_alerta == 'neutral') {\n        icono = 'bi bi-info-circle';\n    }\n\n    if (tipo_alerta == 'warning') {\n        icono = 'bi bi-info-circle';\n        texto_color = \"text-red-letras\";\n    }\n\n    if (tipo_alerta == 'danger') {\n        icono = 'bi bi-x-circle';\n    }\n\n    if (icono2 != '') {\n        icono = icono2;\n    }\n\n    if (texto_2 != '') {\n        texto_2 = `<div class=\"col-12 p-0 text-label-1 ${texto_color}\">${texto_2}</div>`;\n    }\n\n    let alert_toast = $(`\n        <div class=\"alert toast-${tipo_alerta} alert-dismissible fade show d-flex align-items-center pe-3 py-3 me-3\" role=\"alert\" style=\"display:none\">\n            <div class=\"col-auto\">\n                <span class=\"${icono} ${texto_color}\"></span>\n            </div>\n            <div class=\"col px-3\">\n                <div class=\"row m-0 ${texto_color}\">\n                    <div class=\"col-12 p-0 text-label-1 ${texto_color}\">\n                        ${texto_1}\n                    </div>\n                    ${texto_2}\n                </div>\n            </div>\n            ${accion}\n            <div class=\"col-auto ms-3 pointer\" data-bs-dismiss=\"alert\">\n                <span class=\"bi bi-x ${texto_color}\"></span>\n            </div>\n        </div>\n    `);\n    $('#contenedor-alert-toast').append(alert_toast);\n    alert_toast.fadeIn();\n    setTimeout(function() {\n        alert_toast.fadeOut();\n        alert_toast.alert('close');\n    }, 5000);\n}\n\n/**\n * Formatear número.\n *\n * @param {number} numero número a formatear\n * @author Andres Morales\n */\nfunction formatearNumero(numero) {\n    return parseInt(numero).toLocaleString('es-ES');\n}\n\n/**\n * Formatear fecha.\n *\n * @param {*} fecha Fecha a formatear.\n * @param {boolean} incluir_segundos Indica si se debe incluir los segundos en la hora.\n * @param {string} formato Formato en el que se retornará la fecha.\n * @param {string} separador Símbolo que se usará para separar días, meses y años.\n * @returns {Object} Objeto con la fecha y hora formateada.\n * @author Daniel Beltrán\n */\nfunction formatearFechaConceptual(fecha, incluir_segundos = false, formato = 'Ymd', separador = '-') {\n    const NUEVA_FECHA = new Date(fecha);\n    const ANO         = NUEVA_FECHA.getFullYear();\n    const MES         = String(NUEVA_FECHA.getMonth() + 1).padStart(2, '0');\n    const DIA         = String(NUEVA_FECHA.getDate()).padStart(2, '0');\n    const HORAS       = String(NUEVA_FECHA.getHours()).padStart(2, '0');\n    const MINUTOS     = String(NUEVA_FECHA.getMinutes()).padStart(2, '0');\n    const SEGUNDOS    = String(NUEVA_FECHA.getSeconds()).padStart(2, '0');\n\n    let fecha_formateada = `${ANO}${separador}${MES}${separador}${DIA}`;\n\n    if (formato === 'dmY') {\n        fecha_formateada = `${DIA}${separador}${MES}${separador}${ANO}`;\n    }\n\n    return {\n        fecha: fecha_formateada,\n        hora : incluir_segundos ? `${HORAS}:${MINUTOS}:${SEGUNDOS}` : `${HORAS}:${MINUTOS}`\n    };\n}\n\n/**\n * Formatear fecha a May. 2023.\n *\n * @param {string} fechaISO Fecha a formatear.\n * @returns {string} Objeto con la fecha y hora formateada.\n * @author Andres Morales\n */\nfunction formatearFechaAnioMes(fechaISO) {\n    const fecha = new Date(fechaISO);\n    const opciones = { month: 'short', year: 'numeric' };\n    let fecha_formateada = fecha.toLocaleDateString('es-ES', opciones);\n\n    fecha_formateada = fecha_formateada.replace(\n        /^([a-zñ]+)(\\s\\d{4})$/,\n        (_, mes, anio) => `${mes.charAt(0).toUpperCase() + mes.slice(1)}. ${anio.trim()}`\n    );\n\n    return fecha_formateada;\n}\n\n/**\n * Formatear un numero a moneda.\n *\n * @param {string} valor Numero.\n * @returns {string} Numero formateado.\n * @author Andres Morales\n */\nfunction formatearMonedaCOP(valor) {\n    return new Intl.NumberFormat('es-CO', {\n        style: 'currency',\n        currency: 'COP',\n        minimumFractionDigits: 0,\n        maximumFractionDigits: 0\n    }).format(valor);\n}\n\n/**\n * Formatear fecha a un formato d/m/Y hh:mm:ss entendible para el usuario.\n *\n * @param {*} fecha_inicial Fecha a formatear.\n * @returns {String} String con la fecha y hora formateada.\n * @author José Manuel Jiménez\n */\nfunction fechaMostrar(fecha_inicial) {\n    if (!fecha_inicial) {\n        return \"\";\n    }\n    const fecha = new Date(fecha_inicial);\n    if (isNaN(fecha.getTime())) {\n        return \"\";\n    }\n    const dia = String(fecha.getUTCDate()).padStart(2, '0');\n    const mes = String(fecha.getUTCMonth() + 1).padStart(2, '0');\n    const anio = fecha.getUTCFullYear();\n    if (!fecha_inicial.includes(\" \")) {\n        return `${dia}/${mes}/${anio}`;\n    }\n    const horas = String(fecha.getUTCHours()).padStart(2, '0');\n    const minutos = String(fecha.getUTCMinutes()).padStart(2, '0');\n    const segundos = String(fecha.getUTCSeconds()).padStart(2, '0');\n    return `${dia}/${mes}/${anio} ${horas}:${minutos}:${segundos}`;\n}\n\n/**\n * Descargar Excel.\n *\n * @param {string} ruta Ruta desde donde se descarga el archivo.\n * @param {string} nombre_archivo Nombre del archivo descargado.\n * @param {boolean} marca_tiempo Indica si el nombre del archivo debe llevar marca de tiempo.\n * @param {Object} parametros Parámetros a enviar en la petición.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function descargarExcel(ruta, nombre_archivo, marca_tiempo = true, parametros = {}) {\n    parametros._token = $('meta[name=\"csrf-token\"]').attr('content');\n\n    await $.ajax({\n        type     : 'POST',\n        url      : `/${ruta}`,\n        data     : parametros,\n        xhrFields: {\n            responseType: 'blob'\n        },\n        success: function (respuesta) {\n            // Crear una URL para el Blob\n            let url = window.URL.createObjectURL(respuesta); // 'respuesta' es el Blob\n            let a   = document.createElement('a'); // Crea un nuevo elemento <a> para iniciar la descarga\n            a.href  = url;\n            const fecha_actual     = new Date();\n            const dia              = fecha_actual.getDate();\n            const mes              = fecha_actual.getMonth() + 1;\n            const ano              = fecha_actual.getFullYear();\n            const hora             = fecha_actual.getHours();\n            const minutos          = fecha_actual.getMinutes();\n            const segundos         = fecha_actual.getSeconds();\n            const fecha_formateada = `${dia}${mes}${ano}${hora}${minutos}${segundos}`;\n\n            a.download = marca_tiempo ? `${nombre_archivo}-${fecha_formateada}.xlsx` : `${nombre_archivo}.xlsx`;\n            document.body.appendChild(a);\n            a.click();\n            window.URL.revokeObjectURL(url);\n            document.body.removeChild(a);\n        }\n    }).then(() => {\n        mostrarToast('success', 'Archivo descargado correctamente.');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al descargar el archivo.');\n    });\n}\n\n/**\n * Convierte un string a slug.\n *\n * @param {string} str\n * @returns {string}\n * @author Fahibram Cárcamo\n */\nfunction slug(str) {\n\n    // Quita espacios en blanco\n    str = str.replace(/^\\s+|\\s+$/g, \"\")\n\n    // Convierte el string a minusculas\n    str = str.toLowerCase()\n\n    // Quita los caracteres no alfanuméricos\n    str = str.replace(/[^a-z0-9 -]/g, \"\")\n\n    // Reemplaza los espacio con guiones\n    str = str.replace(/\\s+/g, \"-\")\n\n    // Remueve los guiones consecutivos\n    str = str.replace(/-+/g, \"-\")\n\n    return str\n}\n\n/**\n * Compara los elementos de dos arreglos y retorna `true` si son iguales y `false` en caso contrario\n * (Este función está pensada para comparar arreglos unidimensionales).\n *\n * @param {array} primer_arreglo\n * @param {array} segundo_arreglo\n * @param {boolean} comparar_orden\n * @return {boolean}\n * @author Fahibram Cárcamo\n */\nfunction sonArreglosIguales(primer_arreglo, segundo_arreglo, comparar_orden = false) {\n\n    if (!comparar_orden) {\n        primer_arreglo.sort()\n        segundo_arreglo.sort()\n    }\n\n    if (primer_arreglo.length !== segundo_arreglo.length) return false\n\n    for (let i = 0; i < primer_arreglo.length; i++) {\n        if (primer_arreglo[i] !== segundo_arreglo[i]) return false\n    }\n\n    return true\n}\n\n/**\n * Función para cambiar de empresa.\n *\n * @param {number} empresa_id ID de la empresa a la que se va a cambiar.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction cambiarEmpresa(empresa_id) {\n    $.ajax({\n        type: 'POST',\n        url: '/suplantar-rol-admin-general',\n        data: {\n            _token    : $('meta[name=\"csrf-token\"]').attr('content'),\n            empresa_id: empresa_id\n        },\n        success: function (respuesta) {\n            localStorage.setItem('notificacionToast', JSON.stringify({\n                tipo_alerta: 'success',\n                texto_1    : 'Cambio de empresa exitoso'\n            }));\n\n            window.location.reload();\n        },\n        error: function (error) {\n            mostrarToast('danger', 'Ocurrió un error al cambiar de empresa');\n        }\n    });\n}\n\n/**\n * Enviar la solucitud de suplantación de rol y empresa al Back-end.\n *\n * @param {function|null} callback_exito Callback ejecutado en caso de éxito.\n * @param {string} url URL de suplantación.\n * @param {string} _token Token CSRF del formulario.\n * @param {number} empresa_id Id de la empresa a suplantar.\n * @param {number|null} rol_id Id del rol a suplantar.\n * @param {function|null} callback_error Callback ejecutado en caso de error.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nasync function enviarOrdenSuplantacionRolEmpresa (callback_exito, url, _token, empresa_id = null, rol_id = null, callback_error = null) {\n\n    let condicion_suplantacion = rol_id === null\n        ? empresa_id === null\n            ? true\n            : parseInt($('#empresa_sesion_id').val()) !== parseInt(empresa_id)\n        : parseInt($('#rol_sesion_id').val()) !== parseInt(rol_id) && parseInt($('#empresa_sesion_id').val()) !== parseInt(empresa_id);\n\n    if (condicion_suplantacion) {\n        let data = { _token };\n        if (empresa_id !== null) data.empresa_id = empresa_id;\n        if (rol_id !== null) data.rol_id = rol_id;\n\n        await $.ajax({ type: 'POST', url, data })\n            .then((respuesta, status, xhr) => {\n                if (xhr.status >= 200 && xhr.status < 300 && callback_exito !== null) callback_exito();\n            })\n            .catch(error => {\n                let swal_titulo, swal_texto;\n\n                if (error.status === 404) {\n                    if (error.responseJSON.mensaje) {\n                        swal_titulo = 'Algo salió mal';\n                        if (error.responseJSON.mensaje === 'no existe rol_suplantar') {\n                            swal_texto = 'El rol no existe.';\n                        } else if (error.responseJSON.mensaje === 'no existe empresa_suplantar') {\n                            swal_texto = 'La empresa no existe.';\n                        } else if (error.responseJSON.mensaje === 'no existe usuario_suplantar') {\n                            swal_texto = 'El usuario no existe.';\n                        } else {\n                            swal_texto = '';\n                        }\n                    } else if (error.responseJSON.empresa && error.responseJSON.rol) {\n                        swal_titulo = 'No fué posible cambiar de empresa';\n                        swal_texto = error.responseJSON.rol === 'Administrador general' || error.responseJSON.rol === 'Propietario'\n                            ? `La empresa ${error.responseJSON.empresa} no tiene ningún usuario con el rol Administrador general o Propietario.`\n                            : `La empresa ${error.responseJSON.empresa} no tiene ningún usuario con el rol ${error.responseJSON.rol}.`;\n                    } else {\n                        swal_titulo = 'Algo salió mal';\n                        swal_texto = error.responseJSON.errors;\n                    }\n                } else {\n                    swal_titulo = 'Algo salió mal';\n                    swal_texto = '';\n                }\n\n                if (callback_error !== null) callback_error();\n\n                Swal.fire({\n                    title: swal_titulo,\n                    text: swal_texto,\n                    icon: \"error\",\n                    confirmButtonText: \"Aceptar\"\n                });\n            });\n    }\n}\n\n/**\n * Mostrar tooltip según el div que lo contenga.\n *\n * @param {div} div Elemento en donde se va a mostrar el tooltip.\n * @returns {void}\n * @author Sol Espitia\n */\nfunction mostrarTooltip(div) {\n    const TOOLTIP         = div.querySelector('.tooltip-x');\n    TOOLTIP.style.display = 'block';\n}\n\n/**\n * Ocultar tooltip según el div que lo contenga.\n *\n * @param {div} div Elemento en donde se va a mostrar el tooltip.\n * @returns {void}\n * @author Sol Espitia\n */\nfunction ocultarTooltip(div) {\n    const TOOLTIP         = div.querySelector('.tooltip-x');\n    TOOLTIP.style.display = 'none';\n}\n\n/**\n * Retornar la diferencia en días de dos fechas dadas.\n *\n * @param {string} fecha_inicial Fecha inicial\n * @param {string} fecha_final Fecha final\n * @param {bool} valor_absoluto Retorna la diferencia en valor absoluto\n * @returns {number}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction diferenciaFechasDias(fecha_inicial, fecha_final, valor_absoluto = false, sumar_dia = true) {\n    let fecha1 = new Date(fecha_inicial);\n    let fecha2 = new Date(fecha_final);\n\n    fecha1.setHours(0, 0, 0, 0);\n    fecha2.setHours(0, 0, 0, 0);\n\n    let diferencia_milisegundos = fecha2.getTime() - fecha1.getTime();\n\n    let diferencia_dias = diferencia_milisegundos / (1000 * 60 * 60 * 24);\n    let resultado = diferencia_dias;\n    if (sumar_dia) {\n        resultado = diferencia_dias + 1;\n    }\n\n    return valor_absoluto ? Math.abs(resultado) : resultado;\n}\n\n/**\n * Retornar `true` si una fecha dada está dentro de un rango de fechas dadas, `false` en otro caso.\n *\n * @param {string} fecha Fecha dada\n * @param {string} fecha_desde Fecha inicial del rango\n * @param {string} fecha_hasta Fecha final del rango\n * @returns {boolean}\n * @author Fahibram Cárcamo\n */\nfunction fechaDentroDelRango(fecha, fecha_desde, fecha_hasta) {\n    fecha = new Date(fecha);\n    fecha_desde = new Date(fecha_desde);\n    fecha_hasta = new Date(fecha_hasta);\n\n    if (isNaN(fecha) || isNaN(fecha_desde) || isNaN(fecha_hasta)) {\n        throw new Error('Una o más fechas no son válidas.');\n    }\n\n    return fecha >= fecha_desde && fecha <= fecha_hasta;\n}\n\n/**\n * Descuenta el tiempo para las respuestas.\n *\n * @param id - ID del elemento HTML donde mostrar el tiempo\n * @param tiempo - Tiempo inicial en segundos\n * @author Jair Carvajal\n */\nvar tiempos_usados = {};\n\nfunction descuentoTiempo(id, tiempo, callback, onTick) {\n    var $elemento = $('#' + id);\n    if ($elemento.length === 0) {\n        console.error('Elemento con id \"' + id + '\" no encontrado.');\n        return;\n    }\n    if (tiempos_usados[id]) {\n        clearInterval(tiempos_usados[id]);\n    }\n    let tiempoTotal = tiempo;\n    tiempos_usados[id] = setInterval(function() {\n        if (tiempo <= 0) {\n            clearInterval(tiempos_usados[id]);\n            delete tiempos_usados[id];\n            $elemento.text('Tiempo finalizado');\n            if (window.tiempoFinalizado()) {\n                tiempoFinalizado();\n            }\n            if (typeof callback === 'function') {\n                callback();\n            }\n            return;\n        }\n\n        var minutos = Math.floor(tiempo / 60);\n        var segundos = tiempo % 60;\n\n        var textoTiempo = minutos + ':' + (segundos < 10 ? '0' : '') + segundos + '<i class=\"bi bi-alarm ms-2\"></i>';\n\n        if (tiempo <= 15) {\n            $elemento.addClass('text-state-red');\n            $elemento.removeClass('text-state-green');\n        } else {\n            $elemento.addClass('text-state-green');\n            $elemento.removeClass('text-state-red');\n        }\n\n        $elemento.html(textoTiempo);\n\n        var tiempoUsado = tiempoTotal - tiempo;\n\n        if (typeof onTick === 'function') {\n            onTick((tiempoUsado % 5));\n        }\n        tiempo--;\n    }, 1000);\n}\n\n/**\n * Detengo el tiempo para las respuestas.\n *\n * @param id - ID del elemento HTML donde mostrar el tiempo\n * @param tiempo - Tiempo inicial en segundos\n * @author Jair Carvajal\n */\nfunction detenerDescuentoTiempo(id) {\n    if (tiempos_usados[id]) {\n        clearInterval(tiempos_usados[id]);\n        delete tiempos_usados[id];\n    }\n}\n\n/**\n * Genera un SVG de la imagen de usuario.\n *\n * @param id ID del usuario.\n * @param nombres Nombres del usuario.\n * @param apellidos Apellidos del usuario.\n * @return image\n * @author Andres Morales\n */\nfunction crearImagenUsuarioLetras(id, nombres, apellidos) {\n    var tamano = 200;\n    var iniciales = (nombres[0] + apellidos[0]).toUpperCase();\n    var hash = md5(id);\n\n    var r = parseInt(hash.substring(0, 2), 16);\n    var g = parseInt(hash.substring(2, 4), 16);\n    var b = parseInt(hash.substring(4, 6), 16);\n    var colorFondo = `rgb(${r},${g},${b})`;\n\n    var luminancia = 0.299 * r + 0.587 * g + 0.114 * b;\n    var colorTexto = luminancia > 150 ? \"#000000\" : \"#FFFFFF\";\n\n    // SVG como texto\n    var svg = `\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${tamano}\" height=\"${tamano}\">\n        <rect width=\"100%\" height=\"100%\" fill=\"${colorFondo}\" />\n        <text x=\"50%\" y=\"50%\" dy=\".35em\"\n            text-anchor=\"middle\"\n            font-family=\"Lato, sans-serif\"\n            font-size=\"${tamano * 0.4}\"\n            fill=\"${colorTexto}\">\n            ${iniciales}\n        </text>\n    </svg>`;\n    var svgEncoded = encodeURIComponent(svg)\n        .replace(/'/g, \"%27\")\n        .replace(/\"/g, \"%22\");\n\n    var dataUri = `data:image/svg+xml,${svgEncoded}`;\n    return dataUri;\n}\n\n/**\n * Carga las notificaciones\n *\n * @return void\n * @author Andres Morales\n * @author Andres Gonzalez\n * @author Esperanza Olivo\n */\nfunction cargarNotificiacionesHeader() {\n    $.ajax({\n        url: '/usuario-notificaciones',\n        type: 'GET',\n        dataType: 'json',\n        success: function(respuesta) {\n            let datos = respuesta.data;\n            let notificaciones_noleidas = datos?.unread_notifications?.length ?? 0;\n\n            // Siempre remover el badge existente\n            $('#dropdownNotificaciones #badge-notificaciones').remove();\n\n            // Solo agregar el badge si hay notificaciones no leídas\n            if (notificaciones_noleidas > 0) {\n                $('#dropdownNotificaciones').append(`<span id=\"badge-notificaciones\" class=\"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-white\">${notificaciones_noleidas}</span>`);\n                $('#contador-notificaciones-abierto').append(`<span id=\"badge-notificaciones\" class=\"badge rounded-pill bg-danger border border-white\">${notificaciones_noleidas}</span>`);\n\n                $('#contenedor-boton-marcar-todas').html(`\n                    <button class=\"btn btn-link text-primary w-100 d-flex justify-content-center\" onclick=\"marcarNotificacionesLeidas('all')\">\n                        Marcar todo como leído\n                    </button>\n                `);\n            }\n\n            const NO_LEIDOS_IDS = new Set(Array.isArray(datos?.unread_notifications) ? datos.unread_notifications.map(notificacion => notificacion.id) : []);\n\n            if (Array.isArray(datos?.notifications) && datos.notifications.length > 0) {\n                $('#notificacion-sinnotificaciones').hide();\n                $('.notificaciones-listado').remove();\n                datos.notifications.forEach(notificacion => {\n                    const { id, data, updated_at } = notificacion;\n\n                    const NO_LEIDO = NO_LEIDOS_IDS.has(id);\n                    const MENSAJE = (data?.mensaje || '').slice(0, 120) + '...';\n                    const HORA = new Date(updated_at).toLocaleTimeString('es-CO', {\n                        hour: '2-digit',\n                        minute: '2-digit',\n                        hour12: false\n                    });\n\n                    const notificaciones = `\n                        <li class=\"${NO_LEIDO ? '' : 'bg-gray-90'} notificaciones-listado py-0\" id=\"notificacion-${id}\">\n                            <a class=\"dropdown-item text-gray-10 text-decoration-none border-top pt-0 pb-1\" href=\"javascript:void(0)\" onclick=\"marcarNotificacionesLeidas('${id}','${data?.ruta}')\">\n                                <div class=\"d-flex justify-content-between\">\n                                    <div class=\"w-auto flex-grow-1 pe-3\">\n                                        <p class=\"mt-1 mb-0 text-headline-6 text-gray-10\">${data?.titulo}</p>\n                                        <p class=\"mb-0 text-body-3 text-gray-30 notificacion-mensaje\">${MENSAJE}</p>\n                                    </div>\n                                    <div class=\"w-auto my-auto ${NO_LEIDO ? 'text-cta-azul' : 'text-gray-10'} text-label-2 flex-shrink-0\">\n                                        ${HORA}${NO_LEIDO ? `<i class=\"bi bi-circle-fill text-cta-azul my-auto texto-notificacion-icono ms-3\"></i>` : ''}\n                                    </div>\n                                </div>\n                            </a>\n                        </li>\n                    `;\n\n                    $(notificaciones).insertBefore('#contenedor-boton-marcar-todas');\n                });\n\n            } else {\n                $('#notificacion-sinnotificaciones').hide();\n                $('.notificaciones-listado').remove();\n            }\n\n        },\n        error: function(xhr, status, error) {\n            console.error('Error al cargar notificaciones:', error);\n        }\n    });\n}\n\n/**\n * Marcar las notificaciones leídas.\n *\n * @param {array} notificaciones_ids ids de las notificaciones\n * @param {string} ruta_destino ruta donde se va ha actualizar la pagina\n * @returns {void}\n * @author Andres Gonzalez\n * @author Esperanza Olivo\n */\nfunction marcarNotificacionesLeidas(notificaciones_ids = null, ruta_destino = null, soporte_id = null) {\n\n    let data = {\n        _token: $('meta[name=\"csrf-token\"]').attr('content')\n    };\n\n    if (notificaciones_ids === 'all') {\n        data.marcar_todo = true;\n    } else if (soporte_id) {\n        data.soporte_id = soporte_id;\n    } else if (notificaciones_ids) {\n        data.notificaciones_ids = Array.isArray(notificaciones_ids)\n            ? notificaciones_ids\n            : [notificaciones_ids];\n    }\n\n    $.ajax({\n        url: '/usuario-marcar-notificaciones-leidas',\n        type: 'POST',\n        data: data,\n        success: function(respuesta) {\n            cargarNotificiacionesHeader();\n\n            if (notificaciones_ids && notificaciones_ids !== 'all' && ruta_destino) {\n                window.location.href = \"/\" + ruta_destino;\n            }\n\n            if (notificaciones_ids === 'all') {\n                $('#badge-notificaciones').remove();\n                $('#contenedor-boton-marcar-todas').empty();\n                $('.notificaciones-listado').addClass('bg-gray-90');\n                $('.bi-circle-fill').remove();\n            }\n        },\n        error: function(xhr, estatus, error) {\n            console.error('Error al cargar notificaciones:', error);\n        }\n    });\n}\n\n/**\n * Configurar WebSocket para notificaciones en tiempo real\n *\n * @return void\n * @author Andres Gonzalez\n */\nfunction configurarWebSocketNotificaciones() {\n    try {\n        if (!window.configuracion_reverbg) {\n            return;\n        }\n\n        const PUSHER = new Pusher(window.configuracion_reverbg.appKey, {\n            wsHost: window.configuracion_reverbg.host,\n            wsPort: window.configuracion_reverbg.port,\n            wssPort: window.configuracion_reverbg.port,\n            cluster: 'mt1',\n            forceTLS: false,\n            enabledTransports: ['ws', 'wss'],\n            authEndpoint: '/broadcasting-auth',\n            auth: {\n                headers: {\n                    'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n                }\n            }\n        });\n\n        PUSHER.connection.bind('failed', function() {\n            console.error('❌ Conexión WebSocket falló');\n        });\n\n        PUSHER.connection.bind('error', function(error) {\n            console.error('❌ Error de WebSocket:', error);\n        });\n\n        let usuario_id = window.configuracion_reverbg.usuario_id;\n\n        if (!usuario_id) {\n            return;\n        }\n\n        const NOMBRE_CANAL = `private-App.Models.Usuarios.User.${usuario_id}`;\n        const CANAL = PUSHER.subscribe(NOMBRE_CANAL);\n\n        CANAL.bind('pusher:subscription_error', function(error) {\n            console.error('❌ Error al suscribirse al canal:', error);\n        });\n\n        // Escuchar eventos específicos de notificaciones\n        CANAL.bind('Illuminate\\\\Notifications\\\\Events\\\\BroadcastNotificationCreated', function(data) {\n            if (data.tipo === 'nueva_notificacion') {\n                audio_notificacion.play();\n                cargarNotificiacionesHeader();\n            }\n\n            if (data.tipo === 'nuevo_mensaje') {\n                if (($('#soporte-guardado-id').val() == data.soporte_id) || ($('#soporte_empresa_id').val() == data.soporte_id)) {\n                    audio_notificacion.play();\n                    consultarChat(data.soporte_id);\n                }\n            }\n        });\n    } catch (error) {\n        console.error('💥 Error en configurarWebSocketNotificaciones:', error);\n        console.error('Stack trace:', error.stack);\n    }\n}\n\n/**\n * Retornar el string entrante en formato title case.\n *\n * @param {string} texto\n * @returns {string}\n * @author Fahibram Cárcamo\n */\nfunction titleCase(texto) {\n    return texto.toLowerCase().replace(/\\b\\w/g, caracter => caracter.toUpperCase());\n}\n\n/**\n * Número de horas que durará el almacenamiento de la variable `ulitmas_empresas` en el\n * almacenamiento local **LocalStorage**.\n *\n * @var {number}\n * @author Fahibram Cárcamo\n */\nconst CANTIDAD_HORAS_VENCIMIENTO_ULTIMAS_EMPRESAS_LOCALSTORAGE = 6;\n\n/**\n * Validar si ya debe removerse la variable `ultimas_empresas` del alamacenamiento local\n * **LocalStorage**, si no es tiempo de eliminarla entonces se reinicia el tiempo de vigencia de la\n * variable.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction validarYActualizarUltimasEmpresasLocalStorage() {\n    let fecha_hora_actuales = moment();\n    let fecha_hora_vencimiento_ultimas_empresas = fecha_hora_actuales.clone().add(CANTIDAD_HORAS_VENCIMIENTO_ULTIMAS_EMPRESAS_LOCALSTORAGE, 'hours');\n    let fecha_hora_vencimiento_ultimas_empresas_localstorage = localStorage.getItem('vencimiento_ultimas_empresas');\n    let ultimas_empresas = localStorage.getItem('ultimas_empresas');\n\n    if (\n        ultimas_empresas != null &&\n        fecha_hora_vencimiento_ultimas_empresas_localstorage != null &&\n        fecha_hora_actuales.clone().isBefore(moment(fecha_hora_vencimiento_ultimas_empresas_localstorage).clone())\n    ) {\n        localStorage.setItem('vencimiento_ultimas_empresas', fecha_hora_vencimiento_ultimas_empresas.format('YYYY-MM-DD HH:mm:ss'));\n        return;\n    }\n\n    localStorage.removeItem('vencimiento_ultimas_empresas');\n    localStorage.removeItem('ultimas_empresas');\n}\n\n/**\n * Obtener la edad actual de un usuario según su fecha de nacimiento.\n *\n * @param {string} fecha_nacimiento\n * @returns {string}\n * @author José Manuel Jiménez\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nfunction obtenerEdad(fecha_nacimiento) {\n    if (!fecha_nacimiento) return \"N/A\";\n    let hoy = new Date();\n    let nacimiento = new Date(fecha_nacimiento);\n    let edad = hoy.getFullYear() - nacimiento.getFullYear();\n    let mes = hoy.getMonth() - nacimiento.getMonth();\n    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) edad--;\n    return edad + \" años\";\n}\n\n/**\n * Restablecer un input de tipo file.\n *\n * @param {html} elemento_input_html Elemento input html.\n * @param {html} label_elemento_input_html Label del elemento input html.\n * @param {html} boton_eliminar_elemento_input_html Botón para eliminar archivo del elemento input html.\n * @author Fahibram Cárcamo\n */\nfunction reiniciarCampoArchivo(elemento_input_html, label_elemento_input_html, boton_eliminar_elemento_input_html) {\n    elemento_input_html.val('');\n    elemento_input_html.removeAttr('data-base64');\n    label_elemento_input_html.text('Ningún archivo seleccionado');\n    boton_eliminar_elemento_input_html.hide();\n\n    if (elemento_input_html.data('imagen')) {\n        $('#' + elemento_input_html.data('imagen')).val('');\n        $('#' + elemento_input_html.data('imagen') + '_previsualizacion').attr('src', '');\n        $('#' + elemento_input_html.data('imagen') + '_fondo_previsualizacion').removeClass('d-none');\n    }\n}\n\n/**\n * Definir un campo destinado a recibir un número de teléfono celular.\n *\n * Esta función debe llamarse en el evento ready del objeto global document:\n * `$(document).ready(...)`. Ademas debe incluirse un pequeño fragmento de código en la función\n * `validacionAdicional` para que se agregué el código del número de celular al valor de campo\n * cuando se envíe el formulario donde se encutra el campo.\n *\n * ```\n * if (\n *   $('#input_celular_id').length &&\n *   $('#input_celular_id').val() !== '' &&\n *   input_celular.getNumber() !== ''\n * ) {\n *   $('#input_celular_id').val(input_celular.getNumber().slice(1));\n * }\n * ```\n *\n * Donde `input_celular` es el objeto retornado por esta función.\n *\n * @param {string} input_celular_id Id del campo.\n * @param {string} nombre_input_celular Nombre del campo.\n * @param {string} placeholder_input_celular Placeholder del campo.\n * @param {boolean} obligatorio El campo es obligatorio en el formulario.\n * @returns {object}\n * @author Fahibram Cárcamo\n */\nfunction definirInputTipoCelular(input_celular_id, nombre_input_celular, placeholder_input_celular, obligatorio = true) {\n    /**\n     * 🌎 Campo para ingresar un número de telefono con selectór de código de país con banderas.\n     * Este componente se creó con la librería International Telephone Input\n     * (https://intl-tel-input.com).\n     *\n     * La linea hiddenInput: () => ({ phone: 'celular_contacto' }) tiene como función establecer el\n     * nombre del campo, es decir, la llave del par llave-valor que se adjuntará en los datos del\n     * formulario cuando se envíe, en este caso 'celular_contacto'.\n     *\n     * Las lienas autoPlaceholder: 'aggressive' y\n     * customPlaceholder: (placeholder, country) => 'Celular*' se usan para definir el placeholder\n     * del campo.\n     *\n     * Con $('#celular_contacto').attr('required', true); se establece el campo como requerido\n     * dentro del formulario, se hace de esta forma porque la librería no admite el atributo\n     * required directamente en el componente html.\n     *\n     * @author Fahibram Cárcamo\n     */\n    if (document.querySelector(`#${input_celular_id}`)) {\n        const dropdown_dinamico = document.createElement('div');\n        document.body.appendChild(dropdown_dinamico);\n\n        let campo_celular = window.intlTelInput(document.querySelector(`#${input_celular_id}`), {\n            nationalMode: true,\n            initialCountry: 'co',\n            separateDialCode: true,\n            autoInsertDialCode: false,\n            autoPlaceholder: 'aggressive',\n            dropdownContainer: dropdown_dinamico,\n            customPlaceholder: (placeholder, country) => placeholder_input_celular,\n            loadUtils: () => import('https://cdn.jsdelivr.net/npm/intl-tel-input@25.4.2/build/js/utils.js'),\n            onlyCountries: [\n                'CO', // Colombia\n                'EC', // Ecuador\n                'AR', // Argentina\n                'CL', // Chile\n                'VE', // Venezuela\n                'PE', // Perú\n                'BO', // Bolivia\n                'UY', // Uruguay\n                'PY', // Paraguay\n                'PA', // Panamá\n                'MX', // México\n                'CR', // Costa Rica\n                // 'PR', // Puerto Rico\n                'CU', // Cuba\n                // 'DO', // República Dominicana\n                'SV', // El Salvador\n                'GT', // Guatemala\n                'HN', // Honduras\n                'NI', // Nicaragua\n                'ES', // España\n                'US', // Estados Unidos\n                'GQ'  // Guinea Ecuatorial\n            ]\n        });\n\n        if (obligatorio) $(`#${input_celular_id}`).attr('required', true);\n\n        return campo_celular;\n    }\n\n    return null;\n}\n\n/**\n * Establece la validación adicional que se aplica a un campo de tipo celular antes de enviar sus\n * datos en un formulario.\n *\n * @param {HTMLInputElement} input Elemento HTML del campo de tipo celular.\n * @param {string} input_id Id del elemento HTML del campo de tipo celular.\n * @author Fahibram Cárcamo\n * @author Jair Carvajal\n */\nfunction validacionAdicionalInputTipoCelular(input, input_id) {\n    let numero_completo = input.getNumber();\n    let indicativo = '+' + input.getSelectedCountryData().dialCode;\n    let codigo_iso2_pais = input.getSelectedCountryData().iso2;\n    let numero_sin_indicativo = numero_completo.replace(indicativo, '');\n    $(`#indicativo_${input_id}`).val(indicativo);\n    $(`#codigo_iso2_pais_${input_id}`).val(codigo_iso2_pais);\n    $(`#${input_id}`).val(numero_sin_indicativo);\n}\n\n/**\n * Rellenar un input de tipo celular.\n *\n * @param {string} indicativo_celular Código del país del número de celular.\n * @param {string} codigo_pais_iso2 Código ISO2 del país del número de celular.\n * @param {string} numero_celular Número de celular sin código de país.\n * @param {string} input_celular_id ID del input de tipo celular.\n * @param {HTMLInputElement} input_celular Input de tipo celular.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nfunction rellenarInputCelular(indicativo_celular, codigo_pais_iso2, numero_celular, input_celular_id, input_celular) {\n    $(`#${input_celular_id}`).val(numero_celular);\n    if (![null, undefined].includes(codigo_pais_iso2)) input_celular.setCountry(codigo_pais_iso2);\n}\n\n/**\n * Convierte imágenes de base64 a Blob.\n *\n * @param {string} cadena_base_64 Base 64 de la imagen.\n * @returns {Promise<Array>}\n * @author Andres Gonzalez\n */\nfunction imagenBase64Blob(cadena_base_64) {\n    if (!cadena_base_64 || !cadena_base_64.startsWith('data:image')) return null;\n    let datos_base_64 = cadena_base_64.split(',')[1];\n    let tipo_mime = cadena_base_64.match(/data:(.*?);base64/)[1];\n    let caracteres_binarios = atob(datos_base_64);\n    let arreglo_bytes = new Array(caracteres_binarios.length).fill(0).map((_, i) => caracteres_binarios.charCodeAt(i));\n    let bytes_uint8 = new Uint8Array(arreglo_bytes);\n    return new Blob([bytes_uint8], { type: tipo_mime });\n}\n\n\n/**\n * Limpiar estructuras html innecesarias en el check editor.\n *\n * @param {string} html - Cadena HTML generada por CKEditor a limpiar\n * @returns {string} HTML limpio sin elementos específicos de CKEditor\n * @author Andres Gonzalez\n * @author Jair Carvajal\n */\nfunction limpiarHTMLCKEditor(html) {\n    // Remover todos los elementos con clases de CKEditor\n    html = html.replace(/<div class=\"ck[^\"]*\"[^>]*>.*?<\\/div>/gs, '');\n    html = html.replace(/<span class=\"[^\"]*ck[^\"]*\"[^>]*>/gi, '<span>');\n\n    // Limpiar spans de imagen inline\n    html = html.replace(/<span class=\"image-inline[^\"]*\"[^>]*>/gi, '');\n    html = html.replace(/<\\/span>/g, '');\n\n    // Remover elementos de upload y widgets\n    html = html.replace(/<div class=\"ck-image-upload[^\"]*\"[^>]*>.*?<\\/div>/gs, '');\n    html = html.replace(/<div class=\"ck-fake-selection[^\"]*\"[^>]*>.*?<\\/div>/gs, '');\n\n    // Remover atributos innecesarios\n    html = html.replace(/contenteditable=\"[^\"]*\"/gi, '');\n    html = html.replace(/data-cke-filler=\"[^\"]*\"/gi, '');\n\n    // Limpiar párrafos vacíos con br\n    html = html.replace(/<p><br[^>]*><\\/p>/gi, '');\n    html = html.replace(/<br data-cke[^>]*>/gi, '');\n\n    // Limpiar espacios múltiples y saltos de línea\n    html = html.replace(/\\s+/g, ' ');\n    html = html.replace(/>\\s+</g, '><');\n\n    return html.trim();\n}\n\n/**\n * Ordena estudios por fecha_inicio más reciente (de más nueva a más antigua).\n * Preserva los índices originales para permitir edición y eliminación correcta.\n *\n * @param {Array} estudios - Array de objetos con estudios\n * @returns {Array} Array de estudios ordenados con propiedad indice_original\n * @author Jair Carvajal\n */\nfunction ordenarEstudiosPorFecha(estudios) {\n    // Mapear con índice original\n    let estudios_con_indice = estudios.map((estudio, indice_original) => ({\n        ...estudio,\n        indice_original: indice_original\n    }));\n\n    // Ordenar estudios por fecha_inicio (más reciente primero)\n    let estudios_ordenados = estudios_con_indice.sort((a, b) => {\n        // Si ambos tienen fecha_inicio, ordenar por más reciente\n        if (a.fecha_inicio && b.fecha_inicio) {\n            return moment(b.fecha_inicio).diff(moment(a.fecha_inicio));\n        }\n        // Si solo uno tiene fecha_inicio, ese va primero\n        if (a.fecha_inicio && !b.fecha_inicio) return -1;\n        if (!a.fecha_inicio && b.fecha_inicio) return 1;\n        // Si ninguno tiene fecha_inicio, mantener orden original\n        return 0;\n    });\n\n    return estudios_ordenados;\n}\n\n/**\n * Ordena experiencias laborales por fecha: primero las que está trabajando actualmente (sin fecha_fin),\n * luego por fecha_fin más reciente.\n * Preserva los índices originales para permitir edición y eliminación correcta.\n *\n * @param {Array} experiencias - Array de objetos con experiencias laborales\n * @returns {Array} Array de experiencias ordenadas con propiedad indice_original\n * @author Jair Carvajal\n */\nfunction ordenarExperienciasPorFecha(experiencias) {\n    // Mapear con índice original\n    let experiencias_con_indice = experiencias.map((experiencia, indice_original) => ({\n        ...experiencia,\n        indice_original: indice_original\n    }));\n\n    // Ordenar experiencias\n    let experiencias_ordenadas = experiencias_con_indice.sort((a, b) => {\n        // Si 'a' no tiene fecha_fin (trabaja actualmente), va primero\n        if (!a.fecha_fin && b.fecha_fin) return -1;\n        // Si 'b' no tiene fecha_fin (trabaja actualmente), va primero\n        if (a.fecha_fin && !b.fecha_fin) return 1;\n        // Si ambos están trabajando actualmente (sin fecha_fin), mantener el orden actual\n        if (!a.fecha_fin && !b.fecha_fin) return 0;\n        // Si ambos tienen fecha_fin, ordenar por fecha más reciente primero (descendente)\n        return moment(b.fecha_fin).diff(moment(a.fecha_fin));\n    });\n\n    return experiencias_ordenadas;\n}\n\n/**\n * Obtener créditos disponibles de la empresa y actualizar el tag.\n * - Si tiene créditos >= 20% del plan: tag azul\n * - Si tiene créditos < 20% del plan: tag amarillo\n * - Si no tiene créditos: tag gris \"Sin créditos\"\n *\n * @param {number} empresa_id ID de la empresa\n * @param {string} contenedor_id ID del contenedor donde se mostrará el tag\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction obtenerCreditosDisponiblesEmpresa(empresa_id, contenedor_id = 'contenedor-tag-creditos') {\n    if (!empresa_id || !$(`#${contenedor_id}`).length) {\n        return;\n    }\n\n    $.ajax({\n        url: `/empresas/${empresa_id}/creditos`,\n        method: 'GET',\n        dataType: 'json',\n        success: function(respuesta) {\n            let creditos_disponibles = respuesta?.data?.creditos_disponibles ?? 0;\n            let creditos_plan = respuesta?.data?.creditos_plan ?? 0;\n            let plan_credito = respuesta?.data?.plan_credito;\n            let porcentaje_disponible = creditos_plan > 0 ? (creditos_disponibles / creditos_plan) * 100 : 0;\n\n            let texto_tag = '';\n            let clase_tag = '';\n            let icono_final = '';\n\n            if (creditos_disponibles <= 0 || plan_credito === null) {\n                texto_tag = 'Sin créditos';\n                clase_tag = 'tag-tonal-gray';\n                icono_final = `<i class=\"bi bi-info-circle ms-1\" role=\"button\" tabindex=\"0\" ${crearTooltip({ placement: 'right', content: 'No tienes créditos disponibles en este momento. Renueva tu plan o adquiere más créditos para continuar.' })}></i>`;\n            } else if (porcentaje_disponible < 20) {\n                texto_tag = `Créditos disponibles: ${formatearNumero(creditos_disponibles)}`;\n                clase_tag = 'tag-filled-yellow';\n                icono_final = `<i class=\"bi bi-info-circle ms-1\" role=\"button\" tabindex=\"0\" ${crearTooltip({ placement: 'right', content: 'Estás cerca de agotar tus créditos. Te queda menos del 20% del total disponible. Considera recargar o revisar tu consumo para evitar interrupciones.' })}></i>`;\n            } else {\n                texto_tag = `Créditos disponibles: ${formatearNumero(creditos_disponibles)}`;\n                clase_tag = 'tag-tonal-blue';\n            }\n\n            $(`#${contenedor_id}`).html(crearTag({\n                texto: texto_tag,\n                class: clase_tag,\n                icono_final: icono_final,\n            }));\n\n            inicializarTooltips();\n        },\n        error: function (error) {\n            $(`#${contenedor_id}`).html(crearTag({\n                texto: error.status === 404 ? 'No tienes plan de créditos' : 'Error al cargar créditos',\n                class: 'tag-tonal-gray'\n            }));\n        }\n    });\n}\n","structuredPatch":[{"oldStart":38,"oldLines":6,"newStart":38,"newLines":38,"lines":[" let configuraciones_disponibles_empresa = null;"," "," /**","+ * Obtiene las funcionalidades activas del plan vigente de la empresa del usuario actual.","+ *","+ * Realiza una petición AJAX a la API para obtener las funcionalidades habilitadas","+ * y actualiza la variable global `configuraciones_disponibles_empresa`.","+ *","+ * @param {number|null} tipo_prueba_id ID del tipo de prueba (opcional).","+ * @returns {Promise} Promesa que se resuelve con las funcionalidades activas.","+ * @author Andres Gonzalez","+ */","+function obtenerFuncionalidadesActivasPlan(tipo_prueba_id = null) {","+    let parametros = {};","+","+    if (tipo_prueba_id !== null) {","+        parametros.tipo_prueba_id = tipo_prueba_id;","+    }","+","+    return $.ajax({","+        url: '/funcionalidades-activas-plan',","+        method: 'GET',","+        dataType: 'json',","+        data: parametros,","+        success: function(respuesta) {","+            configuraciones_disponibles_empresa = respuesta?.data ?? [];","+        },","+        error: function(error) {","+            console.error('Error al obtener funcionalidades activas del plan:', error);","+            configuraciones_disponibles_empresa = [];","+        }","+    });","+}","+","+/**","  * Mostrar modal de créditos IA","  *","  * @return void"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"8d2d34ba-dd42-4b60-b3a2-55432543f8dc"}
{"parentUuid":"15804805-6dbf-454b-a2df-8aeb63c16a4b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_012VguRFLev5x3nsc2hAFrs5","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"La función ha sido creada. Ahora el usuario puede usarla de diferentes maneras:\n\n1. **Llamada simple**:\n```javascript\nobtenerFuncionalidadesActivasPlan();\n```\n\n2. **Con tipo de prueba específico**:\n```javascript\nobtenerFuncionalidadesActivasPlan(1); // Tipo prueba ID 1\n```\n\n3. **Usando promesas para ejecutar código después**:\n```javascript\nobtenerFuncionalidadesActivasPlan().then(function() {\n    console.log(configuraciones_disponibles_empresa);\n});\n```\n\n4. **Con async/await**:\n```javascript\nawait obtenerFuncionalidadesActivasPlan();\nconsole.log(configuraciones_disponibles_empresa);\n```\n\nLa función sobrescribe la variable `configuraciones_disponibles_empresa` con los datos obtenidos de la API.","signature":"EukGCkYICxgCKkB0AbIkKi74oLsKdYsIJ0VnqsuhnQS6jLNVEVN7whyMcnZQKAe6hMLddbXfD6GHFJvX1CZSyH9JpVyJkwuv7uSPEgzzQvDLLgmoZpiwjr8aDDMq5AuAGGbhArTKJyIwI8K508RBixGoyXEgwNsDwI8iGQNVmq5y3FSfCuBqyaNtPXA6TqdkYjyV5BtoILumKtAFldOM+owu9L2Gx3MJpZEqf5rrGk4/fS3uoZlZ7K5TeOdwS9dZtvxzz8jAo58ISr39An+NO3gx36SPUddFZj6KCrblUpMXB5aYTQtS5WmtxyxDdKMinYdmncxdAmHynhj/gXRoQUd+YnZycDD0KSz/4iO9uvMxj/UBGs5iJubYMTvVC5mZBBiHVmWlsReXvjYzYl0tMyrDKe06jzf3mz2kwDUal9ShOtXo7Q7zVstmxRFE6kDOhLBmR2rWBqWH6G/dQRlMRq9Gy3PdtsxN0WiYAWpEKbB346S0K4dVhnf7HW3FS6rDr7YDtgoxNzskZrWmyiJgyyyudihmeJlM0GczR0Hcr0lTG3GYOy9E0TYKVYhoc3NDbIJT/xg0btsryGju0lDoJeEr848smTowFoIeuWpef1Bl2RdbNyoc9hdpetcsRvuYBS5bC8mIdBz2Xw7pLrtSBTNmWRzE3hU6LTGsGSjuSybu4MGxpNmN5/qYU2jkvEMNy0pNHHNjjFIBpuGfIFqXb1DIVskIyEcsuNi9RNxpQth+qLnPQGU0gFLsdd4XSypuTJEzprwERHEPH/X3SORc5gLzxgZWhLglw8+yySeh3p3P3nsjPwcnHPaIyCbGNN5QjksItklQ2ombaLcrrUW4kCRRm/sd98F31aXrEPXJrGDlP+D1jXW3nZU4dsYUgSwEKKr05lPwSIfLjtziC79ewUNfQURe73I+y39u+tYqGbrm5n1LOKT8DS2CUNwEDYTZOWV3IEzK0qm6QzyX4DVJ59F+Oxcimh44WqYBWxjpA4P6ppPwUNcMdJndYmhIhZFIsVYlZumohD8otBh0ldyMHNe4CCqYPByjm2AYAQdJWQDDFCWGDeS3FDGX5j5G1UPLGpP9io2H7fqbXLwYOe/cx5mcLUgr5fdUH0curCuQI6qP7Rzqhu4tHTTZwSZyUpxP9gtYn5hVliiwtSTgGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1351,"cache_read_input_tokens":87782,"cache_creation":{"ephemeral_5m_input_tokens":1351,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXYAgAmjYfiVgBc1TgbpY","type":"assistant","uuid":"3842511e-7846-4835-9f6e-a54ec61df1af","timestamp":"2026-01-27T16:05:06.929Z"}
{"parentUuid":"3842511e-7846-4835-9f6e-a54ec61df1af","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_012VguRFLev5x3nsc2hAFrs5","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He creado la función `obtenerFuncionalidadesActivasPlan()` en [globales.js:50](public/js/globales.js#L50).\n\n## Resumen de la función\n\n| Aspecto | Detalle |\n|---------|---------|\n| **Nombre** | `obtenerFuncionalidadesActivasPlan()` |\n| **Ruta API** | `/funcionalidades-activas-plan` |\n| **Método** | `GET` |\n| **Parámetro opcional** | `tipo_prueba_id` |\n| **Variable actualizada** | `configuraciones_disponibles_empresa` |\n\n## Ejemplos de uso\n\n```javascript\n// Llamada simple (sin tipo de prueba específico)\nobtenerFuncionalidadesActivasPlan();\n\n// Con tipo de prueba específico\nobtenerFuncionalidadesActivasPlan(1);\n\n// Usando promesas para ejecutar código después de obtener los datos\nobtenerFuncionalidadesActivasPlan().then(function() {\n    console.log(configuraciones_disponibles_empresa);\n    // Aquí puedes usar las configuraciones\n});\n\n// Con async/await\nawait obtenerFuncionalidadesActivasPlan();\nconsole.log(configuraciones_disponibles_empresa);\n```\n\nLa función retorna una **Promise** por lo que puedes encadenar acciones después de que se obtengan los datos."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1351,"cache_read_input_tokens":87782,"cache_creation":{"ephemeral_5m_input_tokens":1351,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXYAgAmjYfiVgBc1TgbpY","type":"assistant","uuid":"fb2fad8b-f540-40c3-9f78-b7dcf8ef07e8","timestamp":"2026-01-27T16:05:10.953Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-27T16:07:46.533Z","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a"}
{"type":"file-history-snapshot","messageId":"c840095a-2aa1-486a-9dd0-2046a94a904e","snapshot":{"messageId":"c840095a-2aa1-486a-9dd0-2046a94a904e","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v3","version":3,"backupTime":"2026-01-27T16:00:46.237Z"},"app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php":{"backupFileName":"71d1198be92c5143@v2","version":2,"backupTime":"2026-01-27T16:00:46.251Z"},"public\\js\\globales.js":{"backupFileName":"704f632e999527e6@v2","version":2,"backupTime":"2026-01-27T16:07:49.633Z"}},"timestamp":"2026-01-27T16:07:49.619Z"},"isSnapshotUpdate":false}
{"parentUuid":"ed11d322-698f-439d-89dd-93577347bfcf","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01LBCuPr1xiqJ1eAURVWtu6d","parentToolUseID":"toolu_01LBCuPr1xiqJ1eAURVWtu6d","uuid":"dc96c7df-3e1e-4418-81c4-09668ccd837c","timestamp":"2026-01-27T16:04:29.474Z"}
{"parentUuid":"2a42571b-eeda-4885-bb28-9243f31b005a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01LBCuPr1xiqJ1eAURVWtu6d","toolUseID":"toolu_01LBCuPr1xiqJ1eAURVWtu6d","timestamp":"2026-01-27T16:04:32.864Z","uuid":"e4753e09-088c-4899-9286-2ffa7e30b785"}
{"parentUuid":"8d2d34ba-dd42-4b60-b3a2-55432543f8dc","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01WSYwZgFncdnbTAp4Aw4rWb","parentToolUseID":"toolu_01WSYwZgFncdnbTAp4Aw4rWb","uuid":"0883180e-f4ad-4171-9cde-b0e149fdd0d7","timestamp":"2026-01-27T16:04:46.075Z"}
{"parentUuid":"0883180e-f4ad-4171-9cde-b0e149fdd0d7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01WSYwZgFncdnbTAp4Aw4rWb","parentToolUseID":"toolu_01WSYwZgFncdnbTAp4Aw4rWb","uuid":"5ded54eb-2b93-44fd-aa33-cefd605f0734","timestamp":"2026-01-27T16:04:46.076Z"}
{"parentUuid":"15804805-6dbf-454b-a2df-8aeb63c16a4b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01WSYwZgFncdnbTAp4Aw4rWb","toolUseID":"toolu_01WSYwZgFncdnbTAp4Aw4rWb","timestamp":"2026-01-27T16:05:00.107Z","uuid":"a87e3eec-2b16-40bd-bbef-259ec45c59bd"}
{"parentUuid":"fb2fad8b-f540-40c3-9f78-b7dcf8ef07e8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 73 to 76 from c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js:\nif (VISTA_EMPRESA) {\n        obtenerFuncionalidadesActivasPlan();\n        console.log(configuraciones_disponibles_empresa);\n    }\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"aquyi validar queesa variable de vista llegeu como true y que exista la variable if (VISTA_EMPRESA) {\n        obtenerFuncionalidadesActivasPlan();\n        console.log(configuraciones_disponibles_empresa);\n    }"}]},"uuid":"c840095a-2aa1-486a-9dd0-2046a94a904e","timestamp":"2026-01-27T16:07:49.615Z","permissionMode":"default"}
{"parentUuid":"c840095a-2aa1-486a-9dd0-2046a94a904e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_015Y13L2Fh1v7S6e5r8mGumv","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que valide que la variable `VISTA_EMPRESA` exista y que sea `true` antes de ejecutar la función. Actualmente solo está verificando si `VISTA_EMPRESA` es truthy, pero no está verificando si la variable existe (lo que podría causar un error de referencia).\n\nLa validación correcta debería ser:\n1. Verificar que la variable `VISTA_EMPRESA` esté definida (usando `typeof`)\n2. Verificar que su valor sea `true`\n\nVoy a editar el archivo para agregar esta validación.","signature":"EooFCkYICxgCKkADkCYfeo1AaaU4B8CaVRyspe5bucmd2Hr8ZMSP0y4xkCV5gB43QmJSz2IAt7Rsq2aSuox6Djsoh5IP1N9Xx84uEgxG7swzGlcZpdaV57gaDLhAp+ohHO5KJPYZaCIwbANwXlLjxYtvt0/iJccD9Q4PLNF9yAgNfsmVbm4tm1FJdZq2mhcgBxuNyvTvLTlsKvEDrE+Qt7w+lriIaBCm7f6tO3OKk+EZx4ERrIw9qxa21dnMKaXLYGGoMqMEn8dizGTTRXqQlRZpo53kh72RUrNTm4MYQBkUxx0ikb0KeHi+nw/emtJoGtHr6AYOXGMDOZ7zRHbdawLpodiNgzAddXwQ2etpZDA67tzCyedcgRrFC0/OG8BugcE5LFq2WrL+XR0UZVNc7MMr0nJkAsl8EL5eYBwmX3edI4hc+qIsT9GMFNF7XzdP7ii4tUUG5AH7l7+JktwRx1NZBQdbiiSRUlb+fnlFltV4HPUNl44yr+i5HGmFvNoe72dKaVzIZKO99tZ/3tO1/ZnJv8GrioE2Ac/vnlDeH5zUeYOzDy8ZS8GaweF92UlDSWTgIGijrIhvkcy8blSyvlSV9Vv/a7r2B38R/2G2v23/AfgJ16Y89vSPDPfURmi9vPnX4ETfy1wAlg2nn13B+NokoUwkm+B3k2mLm3vmsA1LIGjEBmZAwrBA9fpkMFSTeEDmbk43yEbf1J5ZezZLU+PmW8F17jdykCcrygeb2pS8oMykGMaFATOLtku+Kmyi2Y0gn7OBGPUgauiQdLA+cuazApl8NGicMUacC0tVNmqhuiFKGvQW2VW7EE1f4uVgBPlVKsN7YVUeYarQOZRlGeH+E4ncw3A+RddjHa0YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2731,"cache_read_input_tokens":89133,"cache_creation":{"ephemeral_5m_input_tokens":2731,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXYAtajyAdVSwYgLU4y51","type":"assistant","uuid":"e639ecd4-602f-4628-98e3-158413afd133","timestamp":"2026-01-27T16:07:55.088Z"}
{"parentUuid":"e639ecd4-602f-4628-98e3-158413afd133","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_015Y13L2Fh1v7S6e5r8mGumv","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a corregir la validación para verificar que la variable exista y sea `true`."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2731,"cache_read_input_tokens":89133,"cache_creation":{"ephemeral_5m_input_tokens":2731,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXYAtajyAdVSwYgLU4y51","type":"assistant","uuid":"edb7d338-5d9f-4552-ae4c-35e94d351097","timestamp":"2026-01-27T16:07:55.552Z"}
{"parentUuid":"edb7d338-5d9f-4552-ae4c-35e94d351097","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_015Y13L2Fh1v7S6e5r8mGumv","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011jvDbzLtcKGPRB4aAaj66d","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js","old_string":"$(document).ready(function() {\n    console.log(configuraciones_disponibles_empresa);\n    if (VISTA_EMPRESA) {\n        obtenerFuncionalidadesActivasPlan();\n        console.log(configuraciones_disponibles_empresa);\n    }","new_string":"$(document).ready(function() {\n    if (typeof VISTA_EMPRESA !== 'undefined' && VISTA_EMPRESA === true) {\n        obtenerFuncionalidadesActivasPlan().then(function() {\n            console.log(configuraciones_disponibles_empresa);\n        });\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2731,"cache_read_input_tokens":89133,"cache_creation":{"ephemeral_5m_input_tokens":2731,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXYAtajyAdVSwYgLU4y51","type":"assistant","uuid":"2e418cdc-9fb9-42f5-afba-fbfa1b59ea3a","timestamp":"2026-01-27T16:07:57.411Z"}
{"parentUuid":"2e418cdc-9fb9-42f5-afba-fbfa1b59ea3a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"File has been unexpectedly modified. Read it again before attempting to write it.","is_error":true,"tool_use_id":"toolu_011jvDbzLtcKGPRB4aAaj66d"}]},"uuid":"7d410fe5-a3ef-4dc8-bbb2-420bf4a4aadf","timestamp":"2026-01-27T16:08:37.534Z","toolUseResult":"Error: File has been unexpectedly modified. Read it again before attempting to write it.","sourceToolAssistantUUID":"2e418cdc-9fb9-42f5-afba-fbfa1b59ea3a"}
{"parentUuid":"7d410fe5-a3ef-4dc8-bbb2-420bf4a4aadf","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01N5A9aRfgAjAnKj4gnj4yN3","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El archivo fue modificado. Necesito leerlo de nuevo para ver los cambios actuales.","signature":"EvoBCkYICxgCKkCkvQFeuFwoiXX2EEZ1B8MXJv4zgwaLyp0DMXmaRJkOvudbxard23olBCcnlKPNm3qHRwdkIJs6wKzZFMFi5Em8Egy29h6KMv5xtXlZFvUaDO9rB5JX9mmSxsgS+SIw7obpOTj7+Oz3eVPiUDCbdybtfUS5uHf0UYHio2J1zLa59++nSuBQPOVL4Erv8x40KmKLWn16acxcjtn3IXJcNVWuKJGzM6KlZvNkl9srg0Ytsi7F2KRUWZFiNyHX6Ja4ZT8auTQrHVyssofv1Dsa9iKstT0yS731x22li8RB358lp7menVA3jtBURWAWHGDZ8LqFqhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":484,"cache_read_input_tokens":91864,"cache_creation":{"ephemeral_5m_input_tokens":484,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXYAx54PT41fYQaRu8cgk","type":"assistant","uuid":"12177436-a871-40c7-a8d9-8f1128b8ae6a","timestamp":"2026-01-27T16:08:41.597Z"}
{"parentUuid":"12177436-a871-40c7-a8d9-8f1128b8ae6a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01N5A9aRfgAjAnKj4gnj4yN3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CBEHU4mD6Jei4V7rKXQwqk","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js","offset":70,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":484,"cache_read_input_tokens":91864,"cache_creation":{"ephemeral_5m_input_tokens":484,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXYAx54PT41fYQaRu8cgk","type":"assistant","uuid":"29683596-631b-4d7d-a36a-daefb46dbe05","timestamp":"2026-01-27T16:08:42.332Z"}
{"parentUuid":"29683596-631b-4d7d-a36a-daefb46dbe05","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CBEHU4mD6Jei4V7rKXQwqk","type":"tool_result","content":"    70→});\n    71→\n    72→$(document).ready(function() {\n    73→    if (VISTA_EMPRESA) {\n    74→        obtenerFuncionalidadesActivasPlan();\n    75→        console.log(configuraciones_disponibles_empresa);\n    76→    }\n    77→\n    78→    configurarFormulario('form-editar-plantilla');\n    79→    $(document).on('click', '.botones-grupo', function(){\n    80→        $('.botones-grupo').removeClass('active');\n    81→        $(this).addClass('active');\n    82→        actualizarDatatables(`${nombre_tabla}`);\n    83→    });\n    84→\n    85→    $(document).on('click', '.boton-editar-modal', function(){\n    86→        let id = $(this).data('value');\n    87→        $('#restablecer_texto').data('value', id);\n    88→        plantillaSeleccionada = datos_ids.find(plantilla => plantilla.id == id);\n    89→        $('#contenedor_editor_texto').html(`\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"cb76dc1f-5edc-43a7-84a3-7afdd18857c4","timestamp":"2026-01-27T16:08:44.201Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js","content":"});\n\n$(document).ready(function() {\n    if (VISTA_EMPRESA) {\n        obtenerFuncionalidadesActivasPlan();\n        console.log(configuraciones_disponibles_empresa);\n    }\n\n    configurarFormulario('form-editar-plantilla');\n    $(document).on('click', '.botones-grupo', function(){\n        $('.botones-grupo').removeClass('active');\n        $(this).addClass('active');\n        actualizarDatatables(`${nombre_tabla}`);\n    });\n\n    $(document).on('click', '.boton-editar-modal', function(){\n        let id = $(this).data('value');\n        $('#restablecer_texto').data('value', id);\n        plantillaSeleccionada = datos_ids.find(plantilla => plantilla.id == id);\n        $('#contenedor_editor_texto').html(`","numLines":20,"startLine":70,"totalLines":230}},"sourceToolAssistantUUID":"29683596-631b-4d7d-a36a-daefb46dbe05"}
{"parentUuid":"cb76dc1f-5edc-43a7-84a3-7afdd18857c4","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JNcN2n73cCq2PjdViY138L","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora puedo ver el código actual. Voy a hacer la edición correctamente.","signature":"EvEBCkYICxgCKkBAnWuBP6JFL/TSBRmhboQI09GLw5xMrEAA5eO/MfwJ3Zd4YRZUi5rs+X9kBCXw3PaOluAdthu4i8ulccJJIaO+EgyhyZZhWnq7JAy0Sj0aDHL3qhQvA6lbDeg51SIwSFU6upKPraFpIiNNfC5XCBB3J4YaQN6sTzsoDaEdnRiUZGmPAjNZj3wbACWLH/i3Kll1wLzF1JHPqHjzB12IG0tiJJUTMHgqANNlR9mwptEDWdYwZJMwPnduAi5zn3PKO6fsyM9uC7IivsEnql/pKYfpfuwT5hy1yfD31NCFVFdhclT974ITc2xPKBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":516,"cache_read_input_tokens":92348,"cache_creation":{"ephemeral_5m_input_tokens":516,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXYAxbbB2BdTWwz73PHBy","type":"assistant","uuid":"6b8683e1-c303-4df2-b1f7-21eafd99d9fd","timestamp":"2026-01-27T16:08:49.666Z"}
{"parentUuid":"6b8683e1-c303-4df2-b1f7-21eafd99d9fd","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JNcN2n73cCq2PjdViY138L","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01P5KLtz43TbTMPZFUVQmwhw","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js","old_string":"$(document).ready(function() {\n    if (VISTA_EMPRESA) {\n        obtenerFuncionalidadesActivasPlan();\n        console.log(configuraciones_disponibles_empresa);\n    }","new_string":"$(document).ready(function() {\n    if (typeof VISTA_EMPRESA !== 'undefined' && VISTA_EMPRESA === true) {\n        obtenerFuncionalidadesActivasPlan().then(function() {\n            console.log(configuraciones_disponibles_empresa);\n        });\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":516,"cache_read_input_tokens":92348,"cache_creation":{"ephemeral_5m_input_tokens":516,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXYAxbbB2BdTWwz73PHBy","type":"assistant","uuid":"d185ffc3-d2c7-4d17-85bf-c59750d54ce6","timestamp":"2026-01-27T16:08:51.341Z"}
{"type":"file-history-snapshot","messageId":"d185ffc3-d2c7-4d17-85bf-c59750d54ce6","snapshot":{"messageId":"c840095a-2aa1-486a-9dd0-2046a94a904e","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v3","version":3,"backupTime":"2026-01-27T16:00:46.237Z"},"app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php":{"backupFileName":"71d1198be92c5143@v2","version":2,"backupTime":"2026-01-27T16:00:46.251Z"},"public\\js\\globales.js":{"backupFileName":"704f632e999527e6@v2","version":2,"backupTime":"2026-01-27T16:07:49.633Z"},"public\\js\\plantillas-correos\\index.js":{"backupFileName":"ef6a062d8a555a70@v1","version":1,"backupTime":"2026-01-27T16:08:53.997Z"}},"timestamp":"2026-01-27T16:07:49.619Z"},"isSnapshotUpdate":true}
{"parentUuid":"d185ffc3-d2c7-4d17-85bf-c59750d54ce6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01P5KLtz43TbTMPZFUVQmwhw","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    68→        inicializarTooltips();\n    69→    }\n    70→});\n    71→\n    72→$(document).ready(function() {\n    73→    if (typeof VISTA_EMPRESA !== 'undefined' && VISTA_EMPRESA === true) {\n    74→        obtenerFuncionalidadesActivasPlan().then(function() {\n    75→            console.log(configuraciones_disponibles_empresa);\n    76→        });\n    77→    }\n    78→\n    79→    configurarFormulario('form-editar-plantilla');\n    80→    $(document).on('click', '.botones-grupo', function(){\n    81→        $('.botones-grupo').removeClass('active');"}]},"uuid":"81d03793-4395-41ba-b4c4-10e9224c475f","timestamp":"2026-01-27T16:08:54.059Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\plantillas-correos\\index.js","oldString":"$(document).ready(function() {\n    if (VISTA_EMPRESA) {\n        obtenerFuncionalidadesActivasPlan();\n        console.log(configuraciones_disponibles_empresa);\n    }","newString":"$(document).ready(function() {\n    if (typeof VISTA_EMPRESA !== 'undefined' && VISTA_EMPRESA === true) {\n        obtenerFuncionalidadesActivasPlan().then(function() {\n            console.log(configuraciones_disponibles_empresa);\n        });\n    }","originalFile":"var datos_ids = [];\nvar nombre_tabla = 'tabla-plantillas';\nvar plantillaSeleccionada = [];\n\n$(`#${nombre_tabla}`).DataTable({\n    ...configuracion_tablas,\n    ajax: {\n        url : `/listado-plantillas-correos`,\n        data: function (datos) {\n            datos.grupo_id = $('#listado_grupos_plantillas button.active').val();\n            datos.empresa_id = EMPRESA_ID_PLANTILLAS;\n        },\n        dataSrc: function (json) {\n            return Object.values(json.data);\n        }\n    },\n    columns: [\n        {\n            data: null,\n            orderable : false,\n            render: (dato) => {\n                return `\n                    <div class=\"card rounded tarjeta-plantilla\">\n                        <div class=\"card-body p-0 pointer rounded-top cuerpo-tarjeta-plantilla\" data-value=\"${dato.id}\">\n                            <div class=\"position-relative\">\n                                <img src=\"/imagenes/plantilla/encabezado_header.svg\" alt=\"Logo Plantilla\" class=\"rounded-top imagen-encabezado-plantilla\">\n                                <img src=\"/imagenes/plantilla/logo_plataformas_evaluacion.svg\" alt=\"Logo Plantilla\" class=\"position-absolute imagen-logo-plantilla\">\n                            </div>\n                            <div class=\"px-3 contenido-plantilla\">\n                                <p class=\"text-center\">Empresa</p>\n                                <p class=\"fw-bold\">${dato.titulo}</p>\n                                <p class=\"\">${dato.contenido}</p>\n                            </div>\n                        </div>\n                        <div class=\"card-footer pie-tarjeta-plantilla\">\n                            <div class=\"d-flex\">\n                                <div class=\"col-10 my-auto\">\n                                    <span class=\"text-headline-5 text-gray-10 my-auto\">${dato.nombre}</span>\n                                </div>\n                                <div class=\"col-auto\">\n                                    ${crearBoton({\n                                        adicional: `data-value=\"${dato.id}\"`,\n                                        clases: 'btn-primary btn-circle boton-editar-modal',\n                                        texto: `\n                                            <svg width=\"19\" height=\"19\" viewBox=\"0 0 19 19\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                                                <path d=\"M18.2695 2.59877C18.5768 2.9061 18.5768 3.40438 18.2695 3.71171L16.628 5.35315L13.4801 2.20527L15.1216 0.56383C15.4289 0.256499 15.9272 0.256499 16.2345 0.563831L18.2695 2.59877Z\" fill=\"white\"/>\n                                                <path d=\"M15.5151 6.46609L12.3672 3.31821L1.64394 14.0415C1.55755 14.1279 1.49246 14.2332 1.45383 14.3491L0.187499 18.1481C0.0849619 18.4557 0.377613 18.7483 0.685223 18.6458L4.48422 17.3795C4.60012 17.3408 4.70544 17.2757 4.79183 17.1893L15.5151 6.46609Z\" fill=\"white\"/>\n                                            </svg>\n                                        `\n                                    })}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                `;\n            }\n        }\n    ],\n    drawCallback: function(settings) {\n        datos_ids = $(`#${nombre_tabla}`).DataTable().data().toArray();\n        inicializarTooltips();\n    },\n    initComplete: function(settings, json) {\n        datos_ids = $(`#${nombre_tabla}`).DataTable().data().toArray();\n\n        $(`#${nombre_tabla}`).find('tbody').addClass('tabla-cards-horizontal');\n        $(`[aria-describedby=\"${nombre_tabla}_info\"] .thead-componente`).hide();\n        inicializarTooltips();\n    }\n});\n\n$(document).ready(function() {\n    if (VISTA_EMPRESA) {\n        obtenerFuncionalidadesActivasPlan();\n        console.log(configuraciones_disponibles_empresa);\n    }\n\n    configurarFormulario('form-editar-plantilla');\n    $(document).on('click', '.botones-grupo', function(){\n        $('.botones-grupo').removeClass('active');\n        $(this).addClass('active');\n        actualizarDatatables(`${nombre_tabla}`);\n    });\n\n    $(document).on('click', '.boton-editar-modal', function(){\n        let id = $(this).data('value');\n        $('#restablecer_texto').data('value', id);\n        plantillaSeleccionada = datos_ids.find(plantilla => plantilla.id == id);\n        $('#contenedor_editor_texto').html(`\n            ${crearEditorTexto({\n                adicional: `data-botonadicional=\"botonAdicionalCkeditor\"`,\n                class: 'classic-editor-opciones',\n                id: 'descripcion_mensaje',\n                input_container_class: 'mb-4',\n                maxlength: 16350,\n                name: 'descripcion_mensaje',\n                required: true\n            })}\n            `);\n            inicializarClassicEditor();\n        $('#titulo-plantilla-modal').html(plantillaSeleccionada.nombre);\n        $('#titulo_mensaje_plantilla').val(plantillaSeleccionada.titulo);\n        $('#id').val(plantillaSeleccionada.id);\n        $('#grupo_id').val(plantillaSeleccionada.grupo_id);\n        if (plantillaSeleccionada.con_logo_empresa == '1') $('#con_logo').prop('checked', true);\n        else $('#con_logo').prop('checked', false);\n        $('#texto_boton').val(plantillaSeleccionada.texto_boton);\n        $('#enlace_boton').val(plantillaSeleccionada.enlace_boton);\n        $('#modal-editar-plantilla').modal('show');\n\n        // Agregar el ID de la empresa y de la plantilla de correo, el segundo se envía solo cuando la empresa actual es diferente a Psicoalianza\n        $('#empresa_id').val(EMPRESA_ID_PLANTILLAS);\n\n        if (EMPRESA_ID_PLANTILLAS !== PSICOALIANZA_ID) {\n            const PLANTILLA_CORREO_ID = plantillaSeleccionada.plantilla_correo_id !== null ? plantillaSeleccionada.plantilla_correo_id : plantillaSeleccionada.id;\n            $('#plantilla_correo_id').val(PLANTILLA_CORREO_ID);\n        }\n    });\n\n    $(document).on('click', '.cuerpo-tarjeta-plantilla', function(){\n        let id = $(this).data('value');\n        let previsualiazcion_plantilla = datos_ids.find(plantilla => plantilla.id == id);\n\n        $('#titulo_previsualizar').html(previsualiazcion_plantilla.titulo);\n        $('#contenido_previsualizar').html(previsualiazcion_plantilla.contenido);\n        $('#modal-previsualizacion').modal('show');\n    });\n\n    $(document).on('click', '#restablecer_texto', function () {\n        let id = $(this).data('value');\n\n        $.ajax({\n            url: `/plantillas-correos-restablecer/${id}`,\n            type: 'PUT',\n            headers: {\n                'X-CSRF-TOKEN': $('meta[name=\"csrf-token\"]').attr('content')\n            },\n            success: function(response) {\n                actualizarDatatables(`${nombre_tabla}`);\n                mostrarToast('success', response.message);\n                $('#modal-editar-plantilla').modal('hide');\n            },\n            error: function(xhr) {\n                mostrarToast('danger', 'Error al restablecer la plantilla');\n            }\n        });\n    });\n});\n\n/**\n * Validar campos de enlace.\n *\n * Si el campo de texto_boton está diligenciado, el campo enlace_boton se vuelve obligatorio y viceversa.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction validarCamposEnlace() {\n    if (!['', null].includes($('#texto_boton').val().trim()) || !['', null].includes($('#enlace_boton').val().trim())) {\n        $('#texto_boton').prop('required', true).trigger('change');\n        $('#enlace_boton').prop('required', true).trigger('change');\n    } else {\n        $('#texto_boton').prop('required', false).trigger('change');\n        $('#enlace_boton').prop('required', false).trigger('change');\n    }\n}\n\n/**\n * Validar el formulario antes de enviarlo.\n *\n * @returns {boolean}\n * @author Andres Morales\n */\nfunction validacionAdicional(formulario) {\n    $('#contenido').val($(`#descripcion_mensaje`).data('editor').getData());\n    $('#con_logo_empresa').val($(`#con_logo`).is(':checked') ? 1 : 0);\n    return true;\n}\n\n/**\n * función para ejecutar algo después de enviar el formulario.\n *\n * @param {object} respuesta Respuesta del servidor.\n * @returns {void}\n * @autor Andres Morales\n */\n\nfunction postSuccess(respuesta) {\n    actualizarDatatables(`${nombre_tabla}`);\n    $('#modal-editar-plantilla').modal('hide');\n    mostrarToast('success', respuesta.message);\n}\n\n/**\n * Crear boton adicional para ckeditor.\n *\n * @returns {html} botón adicional para ckeditor.\n * @author Andres Morales\n */\nfunction botonAdicionalCkeditor(id) {\n    $(`#${id}`).data('editor').setData(plantillaSeleccionada.contenido);\n    if (!plantillaSeleccionada?.variables?.length) return '';\n\n    const opcionesVariables = plantillaSeleccionada.variables\n        .map(variable => `<button type=\"button\" class=\"dropdown-item-ckeditor p-2\" onclick=\"agregarVariable('${id}', '__${variable.llave}__')\">${variable.valor}</button>`)\n        .join('');\n\n    return `\n        <div class=\"border-start border-black border-2 px-2 my-0 dropdown\">\n            ${crearBoton({\n                clases: 'dropdown-toggle text-body-3 btn-dropdown-ckeditor',\n                texto: 'Agregar variable<i class=\"bi bi-chevron-down text-body-3 ms-2\"></i>',\n                data: [{texto: 'bs-toggle', value: 'dropdown'},{texto: 'bs-auto-close', value: 'outside'},]\n            })}\n            <div class=\"dropdown-menu bg-white\">${opcionesVariables}</div>\n        </div>\n    `;\n}\n\n/**\n * Agrega la variable en cuestion en el ckeditor.\n *\n * @returns {void}\n * @author Andres Morales\n */\nfunction agregarVariable(id, variable) {\n    let texto = $(`#${id}`).data('editor').getData()\n    $(`#${id}`).data('editor').setData(texto + variable);\n}\n","structuredPatch":[{"oldStart":70,"oldLines":9,"newStart":70,"newLines":10,"lines":[" });"," "," $(document).ready(function() {","-    if (VISTA_EMPRESA) {","-        obtenerFuncionalidadesActivasPlan();","-        console.log(configuraciones_disponibles_empresa);","+    if (typeof VISTA_EMPRESA !== 'undefined' && VISTA_EMPRESA === true) {","+        obtenerFuncionalidadesActivasPlan().then(function() {","+            console.log(configuraciones_disponibles_empresa);","+        });","     }"," ","     configurarFormulario('form-editar-plantilla');"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d185ffc3-d2c7-4d17-85bf-c59750d54ce6"}
{"parentUuid":"81d03793-4395-41ba-b4c4-10e9224c475f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_015GQMQQRvL3ZMbw8a95ocwQ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"La validación ha sido corregida. Ahora:\n1. Verifica que `VISTA_EMPRESA` esté definida (evita error de referencia si no existe)\n2. Verifica que su valor sea exactamente `true` (no solo truthy)\n3. Usa `.then()` para que el `console.log` se ejecute después de que la petición AJAX termine, ya que AJAX es asíncrono","signature":"EuQDCkYICxgCKkAKVpdPQMeoq/KiW1nV0lh1seK1Xv1hfMuQpoXIoXt+PnSDDDVsLQFTqQoN7ycFH0Xrp672832gOmXEY/f755GHEgzKfAR9A6IOXmfm9QYaDP+1V58ZIB0Jbg8ntiIwBOjRXUrmN2gHL2DAfYSMpiTD2vRDqq0HYRttMoFk9ZLi9msu4aPCpkSbnWeqL/iTKssCxwTh8m4zRjdOvNRskWQtW1dt7OQcpNtyYgWyc+ZY+sTssmq1TE0ZxXAeTRaPi5jiXbw9Svq8MATp/rphdQwhkVi+bZ6DPa0KxKpjybXO8foZqqC1TRPdW60mmdVUEjxaewgGmaUXTKlI9HLuiaEW2OgtAmjiRRgqbDRnvsXBJhgrwdOHd1XAM2EZ3SWDMtiwNw0sufX2vSf6riG4Sw0ufqj8z0EnPis5dhsf0Qt54K8Ajw8YeWGBMxBCE35+elawsoRMUl6q9Z7WTTZjBoPTPVOkfCZCR5FBRZcKmJSg51ZZ15JsIGHOwNkgoIVOpAGM5OqsDN1HfTmdEFpGUJbh2kViPizuEabjBCdVZIgn8C1d48N7Fa8VKFpGvAPawnxPiG/D2ACzMnPWseJ13sqgE0MPoR7briBLLQR4MxQMYbngE/RhAmaNP/4jfhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":537,"cache_read_input_tokens":92864,"cache_creation":{"ephemeral_5m_input_tokens":537,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXYAyTYGC58wHehN3p5j7","type":"assistant","uuid":"349a1aac-f28d-49de-8dda-484423b824ad","timestamp":"2026-01-27T16:09:00.294Z"}
{"parentUuid":"349a1aac-f28d-49de-8dda-484423b824ad","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"e26e5dd9-4c48-4278-a166-784ff34f268a","version":"2.1.19","gitBranch":"D26-489","slug":"sharded-petting-biscuit","message":{"model":"claude-opus-4-5-20251101","id":"msg_015GQMQQRvL3ZMbw8a95ocwQ","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He corregido la validación con las siguientes mejoras:\n\n| Antes | Después |\n|-------|---------|\n| `if (VISTA_EMPRESA)` | `if (typeof VISTA_EMPRESA !== 'undefined' && VISTA_EMPRESA === true)` |\n| `console.log` inmediato | `console.log` dentro de `.then()` |\n\n## Cambios realizados:\n\n1. **`typeof VISTA_EMPRESA !== 'undefined'`** - Verifica que la variable exista (evita `ReferenceError` si no está definida)\n\n2. **`VISTA_EMPRESA === true`** - Verifica que sea exactamente `true` (no solo un valor truthy como `1`, `\"true\"`, etc.)\n\n3. **`.then(function() {...})`** - El `console.log` ahora se ejecuta **después** de que la petición AJAX termine, ya que `obtenerFuncionalidadesActivasPlan()` es asíncrona. Antes se mostraba `null` porque el log se ejecutaba antes de recibir la respuesta."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":537,"cache_read_input_tokens":92864,"cache_creation":{"ephemeral_5m_input_tokens":537,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXYAyTYGC58wHehN3p5j7","type":"assistant","uuid":"1ac0ac4f-c591-4d76-b7c5-3a260449d497","timestamp":"2026-01-27T16:09:04.241Z"}

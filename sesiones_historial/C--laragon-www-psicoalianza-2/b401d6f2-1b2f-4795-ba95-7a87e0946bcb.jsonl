{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T18:49:37.371Z","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb"}
{"type":"file-history-snapshot","messageId":"bbb859aa-c226-4aa3-ab0c-7e82dafcab22","snapshot":{"messageId":"bbb859aa-c226-4aa3-ab0c-7e82dafcab22","trackedFileBackups":{},"timestamp":"2026-01-22T18:49:37.441Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\storage\\logs\\laravel.log in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"aqui public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array { quere en el retur colocar el estado qye llega de de empresa plan asi 'estado' => \n  array (\n    'id' => 4,\n    'nombre' => 'Por vencer',\n  ),"}]},"uuid":"bbb859aa-c226-4aa3-ab0c-7e82dafcab22","timestamp":"2026-01-22T18:49:37.438Z","permissionMode":"default"}
{"parentUuid":"bbb859aa-c226-4aa3-ab0c-7e82dafcab22","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KGj8UPs68NixmGr97h5mbk","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere modificar una función `creditosDisponiblesEmpresa` para que en el return incluya el estado que viene de empresa plan. Necesito encontrar esta función primero para ver su estructura actual.","signature":"EvkCCkYICxgCKkBVG+7Mba5E+t/r3JGbpPsdAUsrQEL03hP7ZZpsMzwH6URYSo/1mK/oxcgUdq+jUlVyiAMhKbXLTymgAkIsQ4B2EgxD50NY8Gh2PerScz8aDPQ/P70Pl3YshoAdViIwm3bM9axqBKC731MjGCqMc8mo9twAoMgHfBQL3nDvfelhmJPUYGNiJnRtrGEoEsFYKuAB/oanAhFtxFkIBacF76qA+8O6apBco9ylYc3VNNy9hxXudC/W+BQzhgN902wTz+TPQSbz4bTdOHZcXqJ1iCVJ214BcVvJeGXyuCvr0rxEqJ7ZEdVZqZNGrooDRwN6OAzP16wlktbK9M/wGLe3u3NResOEefDy8Ep4lcJlhB/RYMK/zke2TrTt1CtrNzV6l9G0mdK5arf7ndenuBsRQdI38L7R0Ig+Ug1ZctdAyxtmKv807hH2FkMp8ch4p/M/JHsuyOPBysCkLzxHeqt8K2MdJF68TAypJvcDhauhYxgyTbIYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":25005,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25005,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNvBa9wRjcqdmCF9guiF","type":"assistant","uuid":"506680df-3105-4376-bc70-111d6f84b4a6","timestamp":"2026-01-22T18:49:41.267Z"}
{"parentUuid":"506680df-3105-4376-bc70-111d6f84b4a6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KGj8UPs68NixmGr97h5mbk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014cYNkbjoctbxyrtbjsBtog","name":"Grep","input":{"pattern":"creditosDisponiblesEmpresa","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":25005,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25005,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNvBa9wRjcqdmCF9guiF","type":"assistant","uuid":"fe9333d2-dc2f-4a74-8652-0e9049ceaeee","timestamp":"2026-01-22T18:49:41.917Z"}
{"parentUuid":"fe9333d2-dc2f-4a74-8652-0e9049ceaeee","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014cYNkbjoctbxyrtbjsBtog","type":"tool_result","content":"Found 5 files\napp\\Http\\Services\\Empresas\\EmpresaPlanService.php\napp\\Http\\Controllers\\Empresas\\EmpresaPlanController.php\napp\\Http\\Services\\Empresas\\EmpresaService.php\napp\\Http\\Services\\Usuarios\\CompletarDatosService.php\nroutes\\api.php"}]},"uuid":"a8e56db6-8151-4d30-9c99-355a8143e47d","timestamp":"2026-01-22T18:49:45.401Z","toolUseResult":{"mode":"files_with_matches","filenames":["app\\Http\\Services\\Empresas\\EmpresaPlanService.php","app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","app\\Http\\Services\\Empresas\\EmpresaService.php","app\\Http\\Services\\Usuarios\\CompletarDatosService.php","routes\\api.php"],"numFiles":5},"sourceToolAssistantUUID":"fe9333d2-dc2f-4a74-8652-0e9049ceaeee"}
{"parentUuid":"a8e56db6-8151-4d30-9c99-355a8143e47d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_014TEHXSEsfhJCydcB5N1gFL","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Encontré los archivos. Voy a leer el servicio EmpresaPlanService.php ya que el usuario mencionó que es ahí donde está la función.","signature":"Eq8CCkYICxgCKkBfBiPpoKyLOqBWPVFFA5/4Prs/NkSAGUlt12Tok55pYqI7MIs/pa5GBb1LAewHlTSwaDsgkOkNskCKkIv+em9+Egxq+EcUeltVLDpYlmEaDIOITOsCIfk0jizxIyIwmcVi1VNnIVbHSy4gwIEM4bRuZ2oXFI5+ZauS+cOJX5IS1wfdmoiIXNs51aAOj1NNKpYBe0VLyaJo0hHkj8vjrpWM5/+AWeELozxkB8Bqel+dEAHUoLcC+87yUMSrd/0WDylosHn8AU7AYMz4+EUUqaGi7O2jR1HlAe3mdA8nHURvVB3K+o3OElWhghnEV+/I8aJhzY9yDTPbuAgImYNBWXtWGGDKJthVVXvopbBU4KqtSg92RTNN/nSdAbz38WCGVhHtB5qadkaAGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":247,"cache_read_input_tokens":25005,"cache_creation":{"ephemeral_5m_input_tokens":247,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvCAb8Pmm1kAmWq1C4v","type":"assistant","uuid":"23c458e0-8f21-40f2-b051-11359f88853e","timestamp":"2026-01-22T18:49:48.681Z"}
{"parentUuid":"23c458e0-8f21-40f2-b051-11359f88853e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_014TEHXSEsfhJCydcB5N1gFL","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CbNpYu66iLFjBr1VW3utTQ","name":"Grep","input":{"pattern":"function creditosDisponiblesEmpresa","output_mode":"content","path":"app/Http/Services/Empresas/EmpresaPlanService.php","-A":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":247,"cache_read_input_tokens":25005,"cache_creation":{"ephemeral_5m_input_tokens":247,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvCAb8Pmm1kAmWq1C4v","type":"assistant","uuid":"baa59f5a-8dd1-4a70-b0d9-b6c8f61ef5b7","timestamp":"2026-01-22T18:49:49.671Z"}
{"parentUuid":"baa59f5a-8dd1-4a70-b0d9-b6c8f61ef5b7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CbNpYu66iLFjBr1VW3utTQ","type":"tool_result","content":"582:    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n583-        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n584-            ? (int) $request->tipo_prueba_id\n585-            : TipoPrueba::SELECCION_ID;\n586-\n587-        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n588-\n589-        info($empresa_plan->toArray());\n590-\n591-        if (!$empresa_plan) {\n592-            return null;\n593-        }\n594-\n595-        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n596-\n597-        return [\n598-            'empresa_id'           => $empresa_id,\n599-            'empresa_plan_id'      => $empresa_plan->id,\n600-            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n601-            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n602-            'plan_credito'         => $empresa_plan->planCredito ? [\n603-                'id'       => $empresa_plan->planCredito->id,\n604-                'nombre'   => $empresa_plan->planCredito->nombre,\n605-                'creditos' => $empresa_plan->planCredito->creditos,\n606-                'precio'   => $empresa_plan->planCredito->precio\n607-            ] : null\n608-        ];\n609-    }\n610-\n611-    /**\n612-     * Validar si hay creditos suficientes.\n613-     *\n614-     * @param int $empresa_plan_id ID del plan de empresa.\n615-     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n616-     * @return bool\n617-     * @author Sergio Vargas\n618-     * @author Daniel Beltrán\n619-     */\n620-    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n621-        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n622-    }\n623-}"}]},"uuid":"cb29cfd9-e0aa-4fbc-a92a-442e5c548811","timestamp":"2026-01-22T18:49:52.908Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"582:    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n583-        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n584-            ? (int) $request->tipo_prueba_id\n585-            : TipoPrueba::SELECCION_ID;\n586-\n587-        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n588-\n589-        info($empresa_plan->toArray());\n590-\n591-        if (!$empresa_plan) {\n592-            return null;\n593-        }\n594-\n595-        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n596-\n597-        return [\n598-            'empresa_id'           => $empresa_id,\n599-            'empresa_plan_id'      => $empresa_plan->id,\n600-            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n601-            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n602-            'plan_credito'         => $empresa_plan->planCredito ? [\n603-                'id'       => $empresa_plan->planCredito->id,\n604-                'nombre'   => $empresa_plan->planCredito->nombre,\n605-                'creditos' => $empresa_plan->planCredito->creditos,\n606-                'precio'   => $empresa_plan->planCredito->precio\n607-            ] : null\n608-        ];\n609-    }\n610-\n611-    /**\n612-     * Validar si hay creditos suficientes.\n613-     *\n614-     * @param int $empresa_plan_id ID del plan de empresa.\n615-     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n616-     * @return bool\n617-     * @author Sergio Vargas\n618-     * @author Daniel Beltrán\n619-     */\n620-    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n621-        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n622-    }\n623-}","numLines":42},"sourceToolAssistantUUID":"baa59f5a-8dd1-4a70-b0d9-b6c8f61ef5b7"}
{"parentUuid":"cb29cfd9-e0aa-4fbc-a92a-442e5c548811","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UQLKNz8cRXTcwE4nXDDxsg","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito ver qué campos tiene empresa_plan para saber cómo obtener el estado. Veo que hay un `info($empresa_plan->toArray())` que el usuario probablemente usó para ver la estructura. Necesito ver el modelo EmpresaPlan para entender la relación con el estado.","signature":"ErUDCkYICxgCKkC5/xY0I+2jluZ5RFMm9bZElYFzRTcTRbLNSSxfHczFgEYUGVDcyS6iRHPOObm7wSKvsI79lFr9fvsgJjfcUb/PEgwu0l2dZweFIh2i0HkaDLFmfMJ/FcVYsvgEpSIwjLr2a5c8KGJH6rLCtgLFQ0BZaIDln6EBAyS0N5t5/HbzAGi203ofULT+Jpp9KW7KKpwC0BLVGkjBb235T659zFToFxht71nMYHK/S4q0tn9WwwDlQB9GXAF46WppLc+qBgV4SHJocplkdGCVtxqVDo7lyOaISZvuZ92wXtaIOP/C0C1UU1t1nbN+wSgG0PAflMX7t1PirwRqDV4ozBLoRnfMp9eHjr7n64DD3IZRN9wYlMizZ2+U1HvDnVOSbu4K+C4L5/RFDNT2qy8Sif6sOpMnobotY2Eqgu4IjsgOW/bg8qB0OHCfajCdYxLdrgwbVJAHCcxZbGxU49zfPuR53LtRh38IlUc9HxVV+MKAy3tPHl4kZKo0qSy8Q2QkrWcGiaTsDZJgKVJI3yeYFtxxYc3hpjiz6qHM8s5NW9wBVcSNtWv13R4DhyX37oQELj4YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":782,"cache_read_input_tokens":25252,"cache_creation":{"ephemeral_5m_input_tokens":782,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvChzkMTJcpnqLnw9Lq","type":"assistant","uuid":"84d70cf2-a5cc-4c3d-9afd-16e74240a571","timestamp":"2026-01-22T18:49:56.638Z"}
{"parentUuid":"84d70cf2-a5cc-4c3d-9afd-16e74240a571","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UQLKNz8cRXTcwE4nXDDxsg","type":"message","role":"assistant","content":[{"type":"text","text":"Veo la función. Necesito verificar cómo se obtiene el estado en el modelo EmpresaPlan."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":782,"cache_read_input_tokens":25252,"cache_creation":{"ephemeral_5m_input_tokens":782,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvChzkMTJcpnqLnw9Lq","type":"assistant","uuid":"8ac98cc5-f8a0-4139-92c7-d9349210659b","timestamp":"2026-01-22T18:49:57.276Z"}
{"parentUuid":"8ac98cc5-f8a0-4139-92c7-d9349210659b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UQLKNz8cRXTcwE4nXDDxsg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GFq5kgT5AnLiZRnyp9G9DG","name":"Grep","input":{"pattern":"estado|EstadoEmpresaPlan","path":"app/Models/Empresas/EmpresaPlan.php","output_mode":"content","-B":2,"-A":5}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":782,"cache_read_input_tokens":25252,"cache_creation":{"ephemeral_5m_input_tokens":782,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvChzkMTJcpnqLnw9Lq","type":"assistant","uuid":"2f0997a1-4e0e-4389-81ba-13808372c9ef","timestamp":"2026-01-22T18:49:58.368Z"}
{"parentUuid":"2f0997a1-4e0e-4389-81ba-13808372c9ef","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GFq5kgT5AnLiZRnyp9G9DG","type":"tool_result","content":"31-        'plan_credito_id',\n32-        'usuario_id',\n33:        'estado_id',\n34-        'unidades',\n35-        'cantidad_ofertas_laborales',\n36-        'cantidad_usuarios',\n37-        'cantidad_pruebas',\n38-        'creditos',\n--\n130-\n131-    /**\n132:     * Relación de muchos a uno con estados_planes.\n133-     *\n134-     * @return BelongsTo\n135-     * @author Daniel Beltrán\n136-     */\n137:    public function estado(): BelongsTo {\n138-        return $this->belongsTo(EstadoPlan::class);\n139-    }\n140-\n141-    /**\n142-     * Relación de uno a muchos con consumos."}]},"uuid":"dd2151a3-d748-44f1-ac96-8db6b5d88aa6","timestamp":"2026-01-22T18:50:01.679Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"31-        'plan_credito_id',\n32-        'usuario_id',\n33:        'estado_id',\n34-        'unidades',\n35-        'cantidad_ofertas_laborales',\n36-        'cantidad_usuarios',\n37-        'cantidad_pruebas',\n38-        'creditos',\n--\n130-\n131-    /**\n132:     * Relación de muchos a uno con estados_planes.\n133-     *\n134-     * @return BelongsTo\n135-     * @author Daniel Beltrán\n136-     */\n137:    public function estado(): BelongsTo {\n138-        return $this->belongsTo(EstadoPlan::class);\n139-    }\n140-\n141-    /**\n142-     * Relación de uno a muchos con consumos.","numLines":22},"sourceToolAssistantUUID":"2f0997a1-4e0e-4389-81ba-13808372c9ef"}
{"parentUuid":"dd2151a3-d748-44f1-ac96-8db6b5d88aa6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QX8uoyuwb8SVXujeCXErbw","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfecto, la relación con estado existe. Ahora puedo modificar la función para incluir el estado en el return. Necesito cargar la relación 'estado' y agregarla al array de retorno.","signature":"EuACCkYICxgCKkDWYhJMDqaWHdjadkp/Hkq1DWfrvwV5cwwX0HPzjqsOpG+iz4EbT39DmSV2MFQtKhMP2vlWpJIZkgcemnXpPzq6EgyLMK7w4XWDpm18KuMaDOrQm1x6sit6hq7EGiIwDH5ox9OKyDFUqOzGeQe+/kSu8Etk50MNnoJtZ209H4l/voDPyeGZtizNffuJA5kFKscBhFNSqBej5Z/oq3P+6HOmLtSEMznoDpXRSyu0qhPOZaj5i4p0ZWsem+Js50oUihuhJbhjFHnExoFjvJCIn/7tySc71AhDe2RrnWr+ESKzbsZLwuvKE+0PoAZYkJDWGrQ0PGL86qk0s4kjctaUIU8CIMWzQrnh0ckkdA8fihfljS+wwRL9f8zASK/y63tSQfRCFtDOc+hWMqngkN7+BPUP/jDlYXQYKNQ98M/i1Gtnap0mcQkPpJfcc59UWKIbE0ZzYDyV9rRf2RgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":480,"cache_read_input_tokens":26034,"cache_creation":{"ephemeral_5m_input_tokens":480,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvDMnbwJQZDu3GJduJW","type":"assistant","uuid":"3cf53ef3-e1e3-4bd1-8447-230cbe9f9ce1","timestamp":"2026-01-22T18:50:05.076Z"}
{"parentUuid":"3cf53ef3-e1e3-4bd1-8447-230cbe9f9ce1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QX8uoyuwb8SVXujeCXErbw","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora puedo hacer la modificación. Agregaré el estado al return:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":480,"cache_read_input_tokens":26034,"cache_creation":{"ephemeral_5m_input_tokens":480,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvDMnbwJQZDu3GJduJW","type":"assistant","uuid":"621deeb7-7c66-4b0c-b141-b29dac46d875","timestamp":"2026-01-22T18:50:05.503Z"}
{"parentUuid":"621deeb7-7c66-4b0c-b141-b29dac46d875","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QX8uoyuwb8SVXujeCXErbw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018gBubgbE1xnBwx45wZreaz","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];","new_string":"        $empresa_plan->load(['planCredito:id,nombre,creditos,precio', 'estado:id,nombre']);\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null,\n            'estado'               => $empresa_plan->estado ? [\n                'id'     => $empresa_plan->estado->id,\n                'nombre' => $empresa_plan->estado->nombre,\n            ] : null\n        ];"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":480,"cache_read_input_tokens":26034,"cache_creation":{"ephemeral_5m_input_tokens":480,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvDMnbwJQZDu3GJduJW","type":"assistant","uuid":"86349c0f-ccc2-433d-a590-ada0367ce8d7","timestamp":"2026-01-22T18:50:09.652Z"}
{"parentUuid":"86349c0f-ccc2-433d-a590-ada0367ce8d7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_018gBubgbE1xnBwx45wZreaz"}]},"uuid":"0e718043-3760-4506-a085-06cc692f5be9","timestamp":"2026-01-22T18:50:09.785Z","toolUseResult":"Error: File has not been read yet. Read it first before writing to it.","sourceToolAssistantUUID":"86349c0f-ccc2-433d-a590-ada0367ce8d7"}
{"parentUuid":"0e718043-3760-4506-a085-06cc692f5be9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01U3GWAuGDMNb4eiV8L3WLZ5","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Necesito leer el archivo primero antes de editarlo.","signature":"EtsBCkYICxgCKkA+55ABi5YAUdM2VAHfIiR2B7p6LURg4xg1uIWkEY3eG47nVywLz+xUsascCmbpSSSQoZO2hfp1N2lB4hCbYVQzEgz9hZPZI3bcauznz1MaDObMRY63jeQYVTXB3SIwdZDriUUUrTm2YiYBhOAUCdH3d5iYYy5pvX2hO9fxFDwu39egrc4sGPqKi9rZxLjrKkNea8qbmqa5FUe1/8gM9Fp2wnnKz3Q/o7hZtWCfn66QzJ6/c9Gl8t+/x6jYPq+dWdloEJBaTkBAXbo16PyiuC0KmvT6GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":730,"cache_read_input_tokens":26514,"cache_creation":{"ephemeral_5m_input_tokens":730,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXNvDxZP4MN6uAqknWZbW","type":"assistant","uuid":"a8dcc652-3047-436a-b2ea-2ddbba1dbd5f","timestamp":"2026-01-22T18:50:12.298Z"}
{"parentUuid":"a8dcc652-3047-436a-b2ea-2ddbba1dbd5f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01U3GWAuGDMNb4eiV8L3WLZ5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019CWr2J4UujzoxcFDW4GeeL","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","offset":580,"limit":40}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":730,"cache_read_input_tokens":26514,"cache_creation":{"ephemeral_5m_input_tokens":730,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXNvDxZP4MN6uAqknWZbW","type":"assistant","uuid":"a5ea01d1-584b-4674-9ac4-b736a926b1a0","timestamp":"2026-01-22T18:50:12.998Z"}
{"parentUuid":"a5ea01d1-584b-4674-9ac4-b736a926b1a0","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019CWr2J4UujzoxcFDW4GeeL","type":"tool_result","content":"   580→     * @author Sergio Vargas\n   581→     */\n   582→    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n   583→        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n   584→            ? (int) $request->tipo_prueba_id\n   585→            : TipoPrueba::SELECCION_ID;\n   586→\n   587→        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   588→\n   589→        info($empresa_plan->toArray());\n   590→\n   591→        if (!$empresa_plan) {\n   592→            return null;\n   593→        }\n   594→\n   595→        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n   596→\n   597→        return [\n   598→            'empresa_id'           => $empresa_id,\n   599→            'empresa_plan_id'      => $empresa_plan->id,\n   600→            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n   601→            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n   602→            'plan_credito'         => $empresa_plan->planCredito ? [\n   603→                'id'       => $empresa_plan->planCredito->id,\n   604→                'nombre'   => $empresa_plan->planCredito->nombre,\n   605→                'creditos' => $empresa_plan->planCredito->creditos,\n   606→                'precio'   => $empresa_plan->planCredito->precio\n   607→            ] : null\n   608→        ];\n   609→    }\n   610→\n   611→    /**\n   612→     * Validar si hay creditos suficientes.\n   613→     *\n   614→     * @param int $empresa_plan_id ID del plan de empresa.\n   615→     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n   616→     * @return bool\n   617→     * @author Sergio Vargas\n   618→     * @author Daniel Beltrán\n   619→     */\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"38a7e8ab-63d9-4dd2-98e6-92eee45e3ccd","timestamp":"2026-01-22T18:50:14.250Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","content":"     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        info($empresa_plan->toArray());\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */","numLines":40,"startLine":580,"totalLines":624}},"sourceToolAssistantUUID":"a5ea01d1-584b-4674-9ac4-b736a926b1a0"}
{"parentUuid":"38a7e8ab-63d9-4dd2-98e6-92eee45e3ccd","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_019LMejtCyUe4iWXxk2PvomN","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora puedo editar el archivo.","signature":"EsYBCkYICxgCKkBoYbyXd0gs7wWqc1QYpTzXFu3Jl+aHTsfR1YXuozbdlGmKVmtGHr+CA8ch+BATk3h3vlbR63Fb9oUf7AqYHpJREgz3eHOEg09lZkFV63AaDPqIU3uTBhgdr91uvyIw3mJE2hQrfe9c0GDtoRr/wll5W5f+bq82f2gTCWL7MXCs8aCH/MD1VbBaICcuh5H2Ki6IF6q2LtOuL6aKDt26QtKIuhbstfqO1TIMAji5nzdtG7seLMRklqrAtsPj8ehLGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":810,"cache_read_input_tokens":27244,"cache_creation":{"ephemeral_5m_input_tokens":810,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXNvEHVQyUx8XghHgLKHh","type":"assistant","uuid":"89040cb6-23ed-4042-9ef4-be1ccd22e967","timestamp":"2026-01-22T18:50:17.057Z"}
{"parentUuid":"89040cb6-23ed-4042-9ef4-be1ccd22e967","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_019LMejtCyUe4iWXxk2PvomN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017SkfZfyJcbS6X3dLitVnpE","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","old_string":"        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];","new_string":"        $empresa_plan->load(['planCredito:id,nombre,creditos,precio', 'estado:id,nombre']);\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null,\n            'estado'               => $empresa_plan->estado ? [\n                'id'     => $empresa_plan->estado->id,\n                'nombre' => $empresa_plan->estado->nombre,\n            ] : null\n        ];"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":810,"cache_read_input_tokens":27244,"cache_creation":{"ephemeral_5m_input_tokens":810,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXNvEHVQyUx8XghHgLKHh","type":"assistant","uuid":"532bfd69-cffd-4fe6-bbcf-ab2f3c509bd8","timestamp":"2026-01-22T18:50:20.831Z"}
{"type":"file-history-snapshot","messageId":"532bfd69-cffd-4fe6-bbcf-ab2f3c509bd8","snapshot":{"messageId":"bbb859aa-c226-4aa3-ab0c-7e82dafcab22","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v1","version":1,"backupTime":"2026-01-22T18:50:33.002Z"}},"timestamp":"2026-01-22T18:49:37.441Z"},"isSnapshotUpdate":true}
{"parentUuid":"532bfd69-cffd-4fe6-bbcf-ab2f3c509bd8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017SkfZfyJcbS6X3dLitVnpE","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   591→        if (!$empresa_plan) {\n   592→            return null;\n   593→        }\n   594→\n   595→        $empresa_plan->load(['planCredito:id,nombre,creditos,precio', 'estado:id,nombre']);\n   596→\n   597→        return [\n   598→            'empresa_id'           => $empresa_id,\n   599→            'empresa_plan_id'      => $empresa_plan->id,\n   600→            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n   601→            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n   602→            'plan_credito'         => $empresa_plan->planCredito ? [\n   603→                'id'       => $empresa_plan->planCredito->id,\n   604→                'nombre'   => $empresa_plan->planCredito->nombre,\n   605→                'creditos' => $empresa_plan->planCredito->creditos,\n   606→                'precio'   => $empresa_plan->planCredito->precio\n   607→            ] : null,\n   608→            'estado'               => $empresa_plan->estado ? [\n   609→                'id'     => $empresa_plan->estado->id,\n   610→                'nombre' => $empresa_plan->estado->nombre,\n   611→            ] : null\n   612→        ];\n   613→    }\n   614→\n   615→    /**\n   616→     * Validar si hay creditos suficientes."}]},"uuid":"b424cde9-6a69-4e8e-8e6d-006a9a10758f","timestamp":"2026-01-22T18:50:33.043Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","oldString":"        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];","newString":"        $empresa_plan->load(['planCredito:id,nombre,creditos,precio', 'estado:id,nombre']);\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null,\n            'estado'               => $empresa_plan->estado ? [\n                'id'     => $empresa_plan->estado->id,\n                'nombre' => $empresa_plan->estado->nombre,\n            ] : null\n        ];","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $plan                  = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo           = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia              = $plan->vigencia;\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos'        => 0\n            ]);\n        }\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia;\n                }\n            }\n\n            // Poner el nuevo plan como próximo\n            $request->merge(['estado_id' => 3]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => 1]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy          = now();\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses             = $vigencia / 30;\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia          = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio'      => $fecha_inicio->format('Y-m-d'),\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n        $this->generarDirectorios(\"app/{$ruta}\");\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo'    => 'App\\Models\\Empresas\\EmpresaPlan',\n            'modelo_id' => $id,\n            'nombre'    => 'factura',\n            'ruta'      => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n            $plan->creditos_consumidos = $creditos_consumidos;\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo       = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     *\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan                = $this->plan_repositorio->getUno($request->plan_id);\n        $empresa             = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        info($empresa_plan->toArray());\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","structuredPatch":[{"oldStart":592,"oldLines":7,"newStart":592,"newLines":7,"lines":["             return null;","         }"," ","-        $empresa_plan->load('planCredito:id,nombre,creditos,precio');","+        $empresa_plan->load(['planCredito:id,nombre,creditos,precio', 'estado:id,nombre']);"," ","         return [","             'empresa_id'           => $empresa_id,"]},{"oldStart":604,"oldLines":6,"newStart":604,"newLines":10,"lines":["                 'nombre'   => $empresa_plan->planCredito->nombre,","                 'creditos' => $empresa_plan->planCredito->creditos,","                 'precio'   => $empresa_plan->planCredito->precio","+            ] : null,","+            'estado'               => $empresa_plan->estado ? [","+                'id'     => $empresa_plan->estado->id,","+                'nombre' => $empresa_plan->estado->nombre,","             ] : null","         ];","     }"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"532bfd69-cffd-4fe6-bbcf-ab2f3c509bd8"}
{"parentUuid":"b424cde9-6a69-4e8e-8e6d-006a9a10758f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01X9QhCrRtiN8brnK9w3WVZ4","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Listo. He modificado la función para incluir el estado en el return. También puedo eliminar el `info($empresa_plan->toArray())` que parece ser código de debug, pero el usuario no lo mencionó así que lo dejaré como está.","signature":"EosDCkYICxgCKkAPnQrmaG4W7rZwPJ9li4m7+v1zwdrbq8Ep71cmXcBZI9NugrMHQS/KgiGuYD6xYK6WJr/215srIzN35d9rY+ZBEgwdmpnjdln/6mh8mToaDLZuQNHRzvH4/BQ9GSIwvLgi4R8HAq3jK0ZQ9KHMAQyO15tasH0qpS1Np250aYMzlXe01iZy78RX8XCTGk3oKvIBZpwYZXkTzbMQ7ZlL4ITVds74IcYk+jrr0oxd1ZNaF5dj2SiGmknUkZ2ozippIFGD9c2VauDmYtCSHfeDxRc8mge1Qd8aPMlp7y7hZUgRFBwEyo4WibSu7+4HpXGsMsTsXWp9ubIUTCSKwFLyGE0WAtLYsYPTlkQfyV6Wl55AslhgALD86ovkLFN8xwztM0D2FJ4dnaaSx6/gxb7Xe0n9oEO3pDIEqT+giJKsOYce1L3/TYjH/htFMsXJPU/XAoMSPska/6jqxEl0RJSq2lW6+FIzAggqmG4vtbvLpS0Qb9gaFVPULggrP2/PNMAlq9i3KTsYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1071,"cache_read_input_tokens":28054,"cache_creation":{"ephemeral_5m_input_tokens":1071,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvFrhDZP1XBR1sxuAdj","type":"assistant","uuid":"cdbc9fe2-b969-45d2-8bda-05c02569301a","timestamp":"2026-01-22T18:50:39.235Z"}
{"parentUuid":"cdbc9fe2-b969-45d2-8bda-05c02569301a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01X9QhCrRtiN8brnK9w3WVZ4","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Ahora el método `creditosDisponiblesEmpresa` retorna el estado con la estructura que indicaste:\n\n```php\n'estado' => [\n    'id'     => 4,\n    'nombre' => 'Por vencer',\n]\n```\n\nLos cambios fueron:\n1. Se agregó `'estado:id,nombre'` al `load()` para cargar la relación\n2. Se agregó `'estado'` al array de retorno con `id` y `nombre`"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1071,"cache_read_input_tokens":28054,"cache_creation":{"ephemeral_5m_input_tokens":1071,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvFrhDZP1XBR1sxuAdj","type":"assistant","uuid":"b22fd1b8-313a-4762-bc18-8c24f8d894b5","timestamp":"2026-01-22T18:50:41.333Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T18:53:05.541Z","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb"}
{"type":"file-history-snapshot","messageId":"9a4173ba-b537-4d64-8415-a90ca980bfff","snapshot":{"messageId":"9a4173ba-b537-4d64-8415-a90ca980bfff","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v2","version":2,"backupTime":"2026-01-22T18:53:05.618Z"}},"timestamp":"2026-01-22T18:53:05.607Z"},"isSnapshotUpdate":false}
{"parentUuid":"a5ea01d1-584b-4674-9ac4-b736a926b1a0","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_019CWr2J4UujzoxcFDW4GeeL","parentToolUseID":"toolu_019CWr2J4UujzoxcFDW4GeeL","uuid":"1a09c614-702f-471d-b6ed-c1de370e76ec","timestamp":"2026-01-22T18:50:13.128Z"}
{"parentUuid":"532bfd69-cffd-4fe6-bbcf-ab2f3c509bd8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_017SkfZfyJcbS6X3dLitVnpE","parentToolUseID":"toolu_017SkfZfyJcbS6X3dLitVnpE","uuid":"fc524f81-abfd-41a9-a899-39f13b2cc4ca","timestamp":"2026-01-22T18:50:20.977Z"}
{"parentUuid":"fc524f81-abfd-41a9-a899-39f13b2cc4ca","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_017SkfZfyJcbS6X3dLitVnpE","parentToolUseID":"toolu_017SkfZfyJcbS6X3dLitVnpE","uuid":"a4d9f348-de68-4991-be97-a3e2adf993ee","timestamp":"2026-01-22T18:50:20.977Z"}
{"parentUuid":"b424cde9-6a69-4e8e-8e6d-006a9a10758f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_017SkfZfyJcbS6X3dLitVnpE","toolUseID":"toolu_017SkfZfyJcbS6X3dLitVnpE","timestamp":"2026-01-22T18:50:33.045Z","uuid":"ea0a8787-8b12-4d09-a6e5-1818261e3611"}
{"parentUuid":"b22fd1b8-313a-4762-bc18-8c24f8d894b5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 180 to 182 from c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js:\n<div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"mira aqui quiero que el estado funcione igual que el de sin creditos ya que utiliza los isos estados <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>"}]},"uuid":"9a4173ba-b537-4d64-8415-a90ca980bfff","timestamp":"2026-01-22T18:53:05.606Z","permissionMode":"default"}
{"parentUuid":"9a4173ba-b537-4d64-8415-a90ca980bfff","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Ky7GAqsYyqdkNhacptSnuu","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que el estado funcione como el de \"sin créditos\" que ya existe. Necesito ver el archivo planes.js para entender cómo funciona la lógica de \"sin créditos\" y aplicar lo mismo para el estado que viene del backend.","signature":"EpEDCkYICxgCKkAnYWYPyiuj0iq33tEtP08fu21HHCOxSbFLDWymtK2wqmv4xe59JVyfsDJYEgXojTTzKzNQ4jZcjJzUFIfuphF8EgwrmtqcW8O618lsfg4aDKvmYDSPUbwRKNoZ6SIw2/IFNd15yEh019srSuX6Y0HwZULN8iyEeQYKlTd11DSTGfvrXxa3us1SPXhPLnezKvgB9i7QbGpvnbOgMopRpesrvXaicxwqkNLcHyvsh61Yyc/RHqJdYzzHNXL1+jS09q98hzZOv3FF+la8iW2NcPGlcMS+KlJdXWmYbXI7y1Z2YCnkKrACbVVFx5Iu8c1uk76lDES9Wjn4UjLHFYu0UTC6ESpoXhmO0qQDbUet0XElghR8RWB0RQy2c/0+bl90TdljydwoPJ8moO17tQiLsiOcO2JXOt6Qnab4BMci9cRMfuWN0o7Ngtu69NWvixzv7KMEaTj0cCSj8OYm1kkPcVAJJxOw1EXB8JD1aOwFmUAi88YkTBJ2Pfq5LKb5jf3VHjrF0yD9c+ZSvIkYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":394,"cache_read_input_tokens":29125,"cache_creation":{"ephemeral_5m_input_tokens":394,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXNvSwjPCn2ZhAnwSTDuC","type":"assistant","uuid":"fdbe09bd-89c4-478a-872a-732c6c6137f5","timestamp":"2026-01-22T18:53:09.451Z"}
{"parentUuid":"fdbe09bd-89c4-478a-872a-732c6c6137f5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Ky7GAqsYyqdkNhacptSnuu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Wf2FYWdpx1wM9WYyavJrZW","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":394,"cache_read_input_tokens":29125,"cache_creation":{"ephemeral_5m_input_tokens":394,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXNvSwjPCn2ZhAnwSTDuC","type":"assistant","uuid":"bb9c2826-4bb9-4fb6-bea6-7bf6ffb29c87","timestamp":"2026-01-22T18:53:09.847Z"}
{"parentUuid":"bb9c2826-4bb9-4fb6-bea6-7bf6ffb29c87","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Wf2FYWdpx1wM9WYyavJrZW","type":"tool_result","content":"     1→let empresa_id = $('#input_empresa_id').val();\n     2→let usuario_id = $('#input_usuario_id').val();\n     3→let empresas_planes = [];\n     4→let usuarios_ids = [];\n     5→let sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     6→let usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     7→let empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     8→let planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\n     9→usuarios_ids = usuarios.map(usuario => usuario.id);\n    10→let total_usuarios = usuarios_ids.length;\n    11→\n    12→const ESTADOS_PLANES = {\n    13→    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    14→    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    15→    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    16→    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    17→    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    18→    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n    19→};\n    20→\n    21→const ICONOS_PLANES_TIPO = {\n    22→    'Selección': 'bi-person-bounding-box',\n    23→    'Organizacional': 'bi-diagram-3-fill',\n    24→    'Vocacional': 'bi-mortarboard-fill',\n    25→};\n    26→\n    27→/**\n    28→ * Obtiene la data para mostrar en la tabla de planes de la empresa.\n    29→ *\n    30→ * @returns {void}\n    31→ * @author Andres Morales\n    32→ * @author Fahibram Cárcamo\n    33→*/\n    34→async function traerDatos() {\n    35→    try {\n    36→        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n    37→        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n    38→        empresas_planes = respuesta.data.empresas_planes;\n    39→    } catch (error) {\n    40→        console.error(error);\n    41→    }\n    42→}\n    43→traerDatos();\n    44→\n    45→/**\n    46→ * Crea el componente html de los planes de la empresa\n    47→ *\n    48→ * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n    49→ * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n    50→ * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n    51→ * @returns {void}\n    52→ * @author Fahibram Cárcamo\n    53→ * @author Andres Morales\n    54→ * @author Jair Carvajal\n    55→ * @author Andres González\n    56→ */\n    57→function listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    58→    let contenidoHTML = empresas_planes.map(empresa_plan => {\n    59→        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n    60→        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n    61→\n    62→        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n    63→        let suscripcion_ilimitada = !!fecha_vencimiento;\n    64→\n    65→        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n    66→            ? empresa_plan.fecha_inicio\n    67→            : (new Date()).toString();\n    68→\n    69→        let dias_restantes = suscripcion_ilimitada\n    70→            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n    71→            : null;\n    72→\n    73→        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n    74→        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n    75→\n    76→        return empresa_plan.plan_credito_id === null ? `\n    77→            <div class=\"card my-5\">\n    78→                <div class=\"card-body\">\n    79→                    <div class=\"row\">\n    80→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n    81→                        <div class=\"col-auto my-auto\">\n    82→                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n    83→                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n    84→                        </div>\n    85→                        <div class=\"col-auto ms-auto my-auto\">\n    86→                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n    87→                        </div>\n    88→                        <div class=\"col-auto my-auto\">\n    89→                            <div class=\"dropdown\">\n    90→                                ${crearBoton({\n    91→                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n    92→                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n    93→                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n    94→                                })}\n    95→                                <div class=\"dropdown-menu dropdown-menu-start\">\n    96→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n    97→                                        Solicitar renovación\n    98→                                    </button>\n    99→                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n   100→                                        Ver factura\n   101→                                    </button>\n   102→                                </div>\n   103→                            </div>\n   104→                        </div>\n   105→                    </div>\n   106→                    <div class=\"table-responsive mt-4\">\n   107→                        <table class=\"table\">\n   108→                            <tbody>\n   109→                                <tr id=\"contenedor_plan_padre\">\n   110→                                    <td class=\"py-0 my-0 border-0\">\n   111→                                        <div class=\"card bg-gray-90 border-0\">\n   112→                                            <div class=\"card-body py-2\">\n   113→                                                <div class=\"row\">\n   114→                                                    <div class=\"col-auto my-auto\">\n   115→                                                        ${crearBoton({\n   116→                                                            clases: 'btn-text-gray text-label-2',\n   117→                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   118→                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   119→                                                        })}\n   120→                                                    </div>\n   121→                                                    <div class=\"col my-auto\">\n   122→                                                        <div class=\"card bg-white border-0\">\n   123→                                                            <div class=\"card-body py-2\">\n   124→                                                                <div class=\"row\">\n   125→                                                                    <div class=\"col-4 px-7\">\n   126→                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n   127→                                                                    </div>\n   128→                                                                    <div class=\"col-4 px-7\">\n   129→                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n   130→                                                                    </div>\n   131→                                                                    <div class=\"col-4 px-7\">\n   132→                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n   133→                                                                    </div>\n   134→                                                                </div>\n   135→                                                            </div>\n   136→                                                        </div>\n   137→                                                    </div>\n   138→                                                    <div class=\"col-auto my-auto ps-0\">\n   139→                                                        ${crearBoton({\n   140→                                                            tooltip: `${crearTooltip({\n   141→                                                                placement: `top`,\n   142→                                                                content: `Detalle de consumo`,\n   143→                                                                toggle: `popover`,\n   144→                                                            })}`,\n   145→                                                            clases: 'btn-text-primary btn-circle p-2',\n   146→                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   147→                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n   148→                                                        })}\n   149→                                                    </div>\n   150→                                                </div>\n   151→                                            </div>\n   152→                                        </div>\n   153→                                    </td>\n   154→                                </tr>\n   155→                                ${lista_consumos_por_sucursal}\n   156→                            </tbody>\n   157→                        </table>\n   158→                    </div>\n   159→                    <div class=\"row mt-5\">\n   160→                        <div class=\"col-auto\">\n   161→                            <p class=\"text-label-2\">\n   162→                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n   163→                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n   164→                            </p>\n   165→                        </div>\n   166→                        <div class=\"col-auto ms-auto\">\n   167→                            <p class=\"text-label-2\">\n   168→                                <span class=\"me-4\">Vigencia</span>\n   169→                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n   170→                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n   171→                            </p>\n   172→                        </div>\n   173→                    </div>\n   174→                </div>\n   175→            </div>\n   176→        ` : `\n   177→            <div class=\"card my-5\">\n   178→                <div class=\"card-body\">\n   179→                    <div class=\"row\">\n   180→                        <div class=\"col-auto my-auto\">\n   181→                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n   182→                        </div>\n   183→                        <div class=\"col-auto my-auto\">\n   184→                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n   185→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   186→                        </div>\n   187→                        <div class=\"col-auto ms-auto my-auto\">\n   188→                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n   189→                        </div>\n   190→                    </div>\n   191→                    <div class=\"row mt-4\">\n   192→                        <div class=\"col-12\">\n   193→                            <div class=\"card bg-gray-90 border-0\">\n   194→                                <div class=\"card-body py-3\">\n   195→                                    <div class=\"row\">\n   196→                                        <div class=\"col-auto my-auto\">\n   197→                                            ${crearBoton({\n   198→                                                clases: 'btn-text-gray text-label-2',\n   199→                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n   200→                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n   201→                                            })}\n   202→                                        </div>\n   203→                                        <div class=\"col my-auto\">\n   204→                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n   205→                                        </div>\n   206→                                        <div class=\"col-auto my-auto ps-0\">\n   207→                                            ${crearBoton({\n   208→                                                tooltip: `${crearTooltip({\n   209→                                                    placement: `top`,\n   210→                                                    content: `Detalle de consumo`,\n   211→                                                    toggle: `popover`,\n   212→                                                })}`,\n   213→                                                clases: 'btn-text-primary btn-circle p-2',\n   214→                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n   215→                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n   216→                                            })}\n   217→                                        </div>\n   218→                                    </div>\n   219→                                </div>\n   220→                            </div>\n   221→                        </div>\n   222→                    </div>\n   223→                </div>\n   224→            </div>\n   225→        `;\n   226→    }).join('');\n   227→\n   228→    $('#listado-planes').html(contenidoHTML);\n   229→    inicializarTooltips();\n   230→}\n   231→\n   232→/**\n   233→ * Crea el componente HTML de los progress bars de los consumos.\n   234→ *\n   235→ * @param {string} label Etiqueta del progress bar.\n   236→ * @param {string} icono Icono del progress bar.\n   237→ * @param {number} valor Valor actual del consumo.\n   238→ * @param {number} total Valor total del consumo.\n   239→ * @param {boolean} un_text Booleano para mostrar o no el texto.\n   240→ * @returns {string} HTML del progress bar.\n   241→ * @author Andres Morales\n   242→ */\n   243→function crearProgressBarTemplate(label, icono, valor, total, un_text) {\n   244→    return `\n   245→        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n   246→        ${crearProgressBar({\n   247→            label: `${valor}/${total ?? 0}`,\n   248→            height: '8px',\n   249→            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n   250→        })}\n   251→    `;\n   252→}\n   253→\n   254→/**\n   255→ * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n   256→ *\n   257→ * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n   258→ * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n   259→ * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n   260→ * @returns {string}\n   261→ * @author Andres Morales\n   262→ * @author Fahibram Cárcamo\n   263→ */\n   264→function listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n   265→    return sucursales.map(sucursal => {\n   266→        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n   267→        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n   268→\n   269→        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n   270→            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n   271→            ?.conteo_consumos ?? 0;\n   272→\n   273→        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n   274→            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n   275→            ?.conteo_consumos ?? 0;\n   276→\n   277→        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n   278→        let plan = empresa_plan.plan;\n   279→\n   280→        return `\n   281→            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n   282→                <td class=\"py-0 my-0\">\n   283→                    <div class=\"card border-0\">\n   284→                        <div class=\"card-body py-2 px-10\">\n   285→                            <div class=\"row\">\n   286→                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n   287→                                    ${sucursal.nombre_comercial}\n   288→                                </div>\n   289→                                <div class=\"col my-auto\">\n   290→                                    <div class=\"card bg-white border-0\">\n   291→                                        <div class=\"card-body py-2\">\n   292→                                            <div class=\"row\">\n   293→                                                <div class=\"col-4 px-7\">\n   294→                                                    ${\n   295→                                                        crearProgressBarTemplate(\n   296→                                                            'Unidades',\n   297→                                                            'box',\n   298→                                                            total_agendas_consumidas_sucursal,\n   299→                                                            plan.unidades,\n   300→                                                            false\n   301→                                                        )\n   302→                                                    }\n   303→                                                </div>\n   304→                                                <div class=\"col-4 px-7\">\n   305→                                                    ${\n   306→                                                        crearProgressBarTemplate(\n   307→                                                            'Vacantes',\n   308→                                                            'briefcase',\n   309→                                                            total_ofertas_laborales_consumidas_sucursal,\n   310→                                                            plan.cantidad_ofertas_laborales,\n   311→                                                            false\n   312→                                                        )\n   313→                                                    }\n   314→                                                </div>\n   315→                                                <div class=\"col-4 px-7\">\n   316→                                                    ${\n   317→                                                        crearProgressBarTemplate(\n   318→                                                            'Usuarios',\n   319→                                                            'person',\n   320→                                                            total_usuarios_sucursal,\n   321→                                                            plan.cantidad_usuarios,\n   322→                                                            false\n   323→                                                        )\n   324→                                                    }\n   325→                                                </div>\n   326→                                            </div>\n   327→                                        </div>\n   328→                                    </div>\n   329→                                </div>\n   330→                            </div>\n   331→                        </div>\n   332→                    </div>\n   333→                </td>\n   334→            </tr>\n   335→        `;\n   336→    }).join('');\n   337→}\n   338→\n   339→\n   340→/**\n   341→ * Agrupar los consumos de un plan por empresa.\n   342→ *\n   343→ * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n   344→ * @returns {array}\n   345→ * @author Andres Morales\n   346→ */\n   347→function obtenerConsumos(empresa_plan_consumos) {\n   348→    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n   349→\n   350→    let consumos_empresas = new Map();\n   351→\n   352→    empresa_plan_consumos.forEach(consumo => {\n   353→        let empresa = consumo.empresa;\n   354→        if (!consumos_empresas.has(empresa.id)) {\n   355→            empresa.consumos = [];\n   356→            consumos_empresas.set(empresa.id, empresa);\n   357→        }\n   358→        consumos_empresas.get(empresa.id).consumos.push(consumo);\n   359→    });\n   360→\n   361→    sucursales.forEach(sucursal => {\n   362→        if (!consumos_empresas.has(sucursal.id)) {\n   363→            consumos_empresas.set(sucursal.id, sucursal);\n   364→        }\n   365→    });\n   366→\n   367→    return Array.from(consumos_empresas.values());\n   368→}\n   369→\n   370→\n   371→/**\n   372→ * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n   373→ *\n   374→ * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n   375→ * @returns {number}\n   376→ * @author Andres Morales\n   377→ */\n   378→function obtenerTotalUsuarios(empresa = null) {\n   379→    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n   380→    let usuarios_ids_temporal = new Set();\n   381→    usuarios_temporal.forEach(usuario => {\n   382→        if (usuarios_ids.includes(usuario.id)) {\n   383→            usuarios_ids_temporal.add(usuario.id);\n   384→        }\n   385→    });\n   386→    return usuarios_ids_temporal.size;\n   387→}\n   388→\n   389→/**\n   390→ * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n   391→ *\n   392→ * @param {string} id Id del elemento a mostar u ocultar.\n   393→ * @param {string} elemento Elemento padre del menú de acciones.\n   394→ * @returns {void}\n   395→ * @author Andres Morales\n   396→ */\n   397→function toggleSucursalesList(id, elemento) {\n   398→    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n   399→    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n   400→}\n   401→\n   402→/**\n   403→ * Realizar la consulta HTTP para solicitar la renovación de un plan.\n   404→ *\n   405→ * @returns {void}\n   406→ * @author Fahibram Cárcamo\n   407→ * @author Andres Morales\n   408→ */\n   409→async function solicitarRenovacionPlan() {\n   410→    $('#modal-solicitar-renovacion').modal('hide');\n   411→    let plan_id = $('#id-plan-solicitar-renovacion').val();\n   412→    await $.ajax({\n   413→        type: 'POST',\n   414→        url : '/solicitud-renovacion-plan',\n   415→        data: {\n   416→            plan_id,\n   417→            empresa_id,\n   418→            usuario_id,\n   419→            _token: $('meta[name=\"csrf-token\"]').attr('content')\n   420→        }\n   421→    }).then(respuesta => {\n   422→        $('#nombre-plan-solicitar-renovacion').text('');\n   423→        $('#id-plan-solicitar-renovacion').val('');\n   424→        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n   425→    }).catch((error) => {\n   426→        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n   427→    });\n   428→}\n   429→\n   430→/**\n   431→ * Abrir el modal de confirmación de solicitud de renovación de un plan.\n   432→ *\n   433→ * @param {number} plan_id Id del plan.\n   434→ * @param {string} nombre_plan Nombre del plan.\n   435→ * @returns {void}\n   436→ * @author Fahibram Cárcamo\n   437→ */\n   438→function abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n   439→    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n   440→    $('#id-plan-solicitar-renovacion').val(plan_id);\n   441→    $('#modal-solicitar-renovacion').modal('show');\n   442→}\n   443→\n   444→/**\n   445→ * Abrir la factura del plan en una nueva pestaña del navegador.\n   446→ *\n   447→ * @param {number} factura_id Id de la factura.\n   448→ * @returns {void}\n   449→ * @author Fahibram Cárcamo\n   450→ * @author Andres Morales\n   451→ */\n   452→async function abrirFacturaPlan(factura_id){\n   453→    if (factura_id) {\n   454→        await $.ajax({\n   455→            type: 'GET',\n   456→            url: `archivos-abrir/${factura_id}`,\n   457→            xhrFields: {responseType: 'blob'},\n   458→        })\n   459→            .then(respuesta => {\n   460→                let ruta_factura = window.URL.createObjectURL(respuesta);\n   461→                window.open(ruta_factura, '_blank');\n   462→            })\n   463→            .catch((error) => {\n   464→                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n   465→            });\n   466→    } else {\n   467→        mostrarToast('danger', 'No se encontró la factura');\n   468→    }\n   469→}\n   470→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"60afb126-4f87-4f1e-9d1d-0449ab9dfbf1","timestamp":"2026-01-22T18:53:11.935Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","content":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n * @author Andres González\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return empresa_plan.plan_credito_id === null ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n        let plan = empresa_plan.plan;\n\n        return `\n            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n                <td class=\"py-0 my-0\">\n                    <div class=\"card border-0\">\n                        <div class=\"card-body py-2 px-10\">\n                            <div class=\"row\">\n                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n                                    ${sucursal.nombre_comercial}\n                                </div>\n                                <div class=\"col my-auto\">\n                                    <div class=\"card bg-white border-0\">\n                                        <div class=\"card-body py-2\">\n                                            <div class=\"row\">\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Unidades',\n                                                            'box',\n                                                            total_agendas_consumidas_sucursal,\n                                                            plan.unidades,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Vacantes',\n                                                            'briefcase',\n                                                            total_ofertas_laborales_consumidas_sucursal,\n                                                            plan.cantidad_ofertas_laborales,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Usuarios',\n                                                            'person',\n                                                            total_usuarios_sucursal,\n                                                            plan.cantidad_usuarios,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `;\n    }).join('');\n}\n\n\n/**\n * Agrupar los consumos de un plan por empresa.\n *\n * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n * @returns {array}\n * @author Andres Morales\n */\nfunction obtenerConsumos(empresa_plan_consumos) {\n    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n\n    let consumos_empresas = new Map();\n\n    empresa_plan_consumos.forEach(consumo => {\n        let empresa = consumo.empresa;\n        if (!consumos_empresas.has(empresa.id)) {\n            empresa.consumos = [];\n            consumos_empresas.set(empresa.id, empresa);\n        }\n        consumos_empresas.get(empresa.id).consumos.push(consumo);\n    });\n\n    sucursales.forEach(sucursal => {\n        if (!consumos_empresas.has(sucursal.id)) {\n            consumos_empresas.set(sucursal.id, sucursal);\n        }\n    });\n\n    return Array.from(consumos_empresas.values());\n}\n\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n *\n * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n * @returns {number}\n * @author Andres Morales\n */\nfunction obtenerTotalUsuarios(empresa = null) {\n    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n    let usuarios_ids_temporal = new Set();\n    usuarios_temporal.forEach(usuario => {\n        if (usuarios_ids.includes(usuario.id)) {\n            usuarios_ids_temporal.add(usuario.id);\n        }\n    });\n    return usuarios_ids_temporal.size;\n}\n\n/**\n * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n *\n * @param {string} id Id del elemento a mostar u ocultar.\n * @param {string} elemento Elemento padre del menú de acciones.\n * @returns {void}\n * @author Andres Morales\n */\nfunction toggleSucursalesList(id, elemento) {\n    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n}\n\n/**\n * Realizar la consulta HTTP para solicitar la renovación de un plan.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function solicitarRenovacionPlan() {\n    $('#modal-solicitar-renovacion').modal('hide');\n    let plan_id = $('#id-plan-solicitar-renovacion').val();\n    await $.ajax({\n        type: 'POST',\n        url : '/solicitud-renovacion-plan',\n        data: {\n            plan_id,\n            empresa_id,\n            usuario_id,\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then(respuesta => {\n        $('#nombre-plan-solicitar-renovacion').text('');\n        $('#id-plan-solicitar-renovacion').val('');\n        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n    });\n}\n\n/**\n * Abrir el modal de confirmación de solicitud de renovación de un plan.\n *\n * @param {number} plan_id Id del plan.\n * @param {string} nombre_plan Nombre del plan.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n    $('#id-plan-solicitar-renovacion').val(plan_id);\n    $('#modal-solicitar-renovacion').modal('show');\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id){\n    if (factura_id) {\n        await $.ajax({\n            type: 'GET',\n            url: `archivos-abrir/${factura_id}`,\n            xhrFields: {responseType: 'blob'},\n        })\n            .then(respuesta => {\n                let ruta_factura = window.URL.createObjectURL(respuesta);\n                window.open(ruta_factura, '_blank');\n            })\n            .catch((error) => {\n                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n            });\n    } else {\n        mostrarToast('danger', 'No se encontró la factura');\n    }\n}\n","numLines":470,"startLine":1,"totalLines":470}},"sourceToolAssistantUUID":"bb9c2826-4bb9-4fb6-bea6-7bf6ffb29c87"}
{"parentUuid":"60afb126-4f87-4f1e-9d1d-0449ab9dfbf1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ET6P1EAcyYn8HYvAAFRNvv","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Veo que ya existe una constante `ESTADOS_PLANES` que mapea los nombres de estado a los tags correspondientes. En la línea 80 se usa para los planes normales:\n\n```javascript\n<div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n```\n\nPero en la línea 181 para los planes de créditos está hardcodeado:\n```javascript\n${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n```\n\nNecesito cambiar esa línea para que use la misma lógica que los planes normales, usando `ESTADOS_PLANES[estado.nombre]`.","signature":"ErMFCkYICxgCKkBdIAaHdT9iwvQyh6W1ewfH+5PUAnbwqNEtPnChe0RrmukbQvWoUsGWpPJ3bL5mi3gDpNlhgsIx3cNi1G9s6q75EgwCVYZ0dr4ZClRFIKAaDKvwG4WtVKWLoCLgTSIw7Tz3TEjYHGZm5ZKpIydg2mjZOeCDucdhbNZ659jLT52xMcweWz8IJYw7xkVOdG8OKpoEtDcQL1PglWcPGtKDpg6IKud7pJ9Jp/pNxWZ6fKu1HDQYhDmhq72GD7TQrPqW2nfv3m7bOz+5DF8tJRVLBP+pDQkDSF7dmHj6OCBJLyPIbVylLZtFgbcR5z7uOtDntqQe1r9p674UiYjCxCnqcTIsvXWLYhj5xWy0mMwkuHKco33q+Ki42YgLhkVu+IQQbFCrCsXXCC2kPMluUtq9o5aCMp6ftT23RH2rKljcfC7AuIZ4y8xoNUJ6fm253mT2haL2BrUzoOC6sfaq/km9fnGc0VIvqLxVTjjmjrndb6qId7AgT7Y24tsIYenz7wY/Nawjac3s2LzC/F+JaZx9MJdxe2I2oIuFGKTGqiL7mhY7VWbzleen7LBk10TYkQL3mAezCPECGEca49afZo/3Ywfv8AGRg6EzoH1fblVZlz4gAiOLu+2aTkqEOzpX1zPbWw+YI4gNPFaIoAlhhpMVXKc8RfSAktxUg3r/qfTtDRhT3m56W3dsZpxiGrQcSF7B/PWxy28HJOrVRmsECi9Dr4Sj+8bZ62NaB8TcKo8IH0ZuesOLGeKMu48akLmVycdV1bxcA4zZ+fh2A8jZWwp8JKd9JJ4fnw2Ei+ER0FDp1gMinjYMzspxykGCO/GMrPt2GGQkgt14CQ/OI2ClZUfpAUTIczhNsxan3zHcg81IbDjjfCd2JYlu2KiHFTSipA+6Cfc7DL8y9NeuxgPSUhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8356,"cache_read_input_tokens":29519,"cache_creation":{"ephemeral_5m_input_tokens":8356,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvTNvwzjfbQ3sYsYZn2","type":"assistant","uuid":"48830887-a0f0-4906-9b58-dcfb8ad54b99","timestamp":"2026-01-22T18:53:17.782Z"}
{"parentUuid":"48830887-a0f0-4906-9b58-dcfb8ad54b99","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ET6P1EAcyYn8HYvAAFRNvv","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo. Veo que en la línea 80 ya se usa `ESTADOS_PLANES[estado.nombre]` para los planes normales, pero en la línea 181 para los planes de créditos está hardcodeado. Solo necesito cambiarlo para que use la misma lógica:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8356,"cache_read_input_tokens":29519,"cache_creation":{"ephemeral_5m_input_tokens":8356,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvTNvwzjfbQ3sYsYZn2","type":"assistant","uuid":"bc4d4d94-307a-482e-addb-9968dd67bd49","timestamp":"2026-01-22T18:53:18.841Z"}
{"parentUuid":"bc4d4d94-307a-482e-addb-9968dd67bd49","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ET6P1EAcyYn8HYvAAFRNvv","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012LyXM6LP4jrohLUJdD7LQR","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","old_string":"                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>","new_string":"                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8356,"cache_read_input_tokens":29519,"cache_creation":{"ephemeral_5m_input_tokens":8356,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvTNvwzjfbQ3sYsYZn2","type":"assistant","uuid":"07fc2c0d-951e-4f0f-9d17-b2a140379050","timestamp":"2026-01-22T18:53:20.745Z"}
{"type":"file-history-snapshot","messageId":"07fc2c0d-951e-4f0f-9d17-b2a140379050","snapshot":{"messageId":"9a4173ba-b537-4d64-8415-a90ca980bfff","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v2","version":2,"backupTime":"2026-01-22T18:53:05.618Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v1","version":1,"backupTime":"2026-01-22T18:53:27.493Z"}},"timestamp":"2026-01-22T18:53:05.607Z"},"isSnapshotUpdate":true}
{"parentUuid":"07fc2c0d-951e-4f0f-9d17-b2a140379050","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012LyXM6LP4jrohLUJdD7LQR","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   176→        ` : `\n   177→            <div class=\"card my-5\">\n   178→                <div class=\"card-body\">\n   179→                    <div class=\"row\">\n   180→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n   181→                        <div class=\"col-auto my-auto\">\n   182→                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n   183→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   184→                        </div>"}]},"uuid":"57ae281a-2313-4626-aaef-b5953110005a","timestamp":"2026-01-22T18:53:27.526Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","oldString":"                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>","newString":"                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>","originalFile":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n * @author Andres González\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return empresa_plan.plan_credito_id === null ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">\n                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Detalle de consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n        let plan = empresa_plan.plan;\n\n        return `\n            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n                <td class=\"py-0 my-0\">\n                    <div class=\"card border-0\">\n                        <div class=\"card-body py-2 px-10\">\n                            <div class=\"row\">\n                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n                                    ${sucursal.nombre_comercial}\n                                </div>\n                                <div class=\"col my-auto\">\n                                    <div class=\"card bg-white border-0\">\n                                        <div class=\"card-body py-2\">\n                                            <div class=\"row\">\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Unidades',\n                                                            'box',\n                                                            total_agendas_consumidas_sucursal,\n                                                            plan.unidades,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Vacantes',\n                                                            'briefcase',\n                                                            total_ofertas_laborales_consumidas_sucursal,\n                                                            plan.cantidad_ofertas_laborales,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Usuarios',\n                                                            'person',\n                                                            total_usuarios_sucursal,\n                                                            plan.cantidad_usuarios,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `;\n    }).join('');\n}\n\n\n/**\n * Agrupar los consumos de un plan por empresa.\n *\n * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n * @returns {array}\n * @author Andres Morales\n */\nfunction obtenerConsumos(empresa_plan_consumos) {\n    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n\n    let consumos_empresas = new Map();\n\n    empresa_plan_consumos.forEach(consumo => {\n        let empresa = consumo.empresa;\n        if (!consumos_empresas.has(empresa.id)) {\n            empresa.consumos = [];\n            consumos_empresas.set(empresa.id, empresa);\n        }\n        consumos_empresas.get(empresa.id).consumos.push(consumo);\n    });\n\n    sucursales.forEach(sucursal => {\n        if (!consumos_empresas.has(sucursal.id)) {\n            consumos_empresas.set(sucursal.id, sucursal);\n        }\n    });\n\n    return Array.from(consumos_empresas.values());\n}\n\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n *\n * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n * @returns {number}\n * @author Andres Morales\n */\nfunction obtenerTotalUsuarios(empresa = null) {\n    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n    let usuarios_ids_temporal = new Set();\n    usuarios_temporal.forEach(usuario => {\n        if (usuarios_ids.includes(usuario.id)) {\n            usuarios_ids_temporal.add(usuario.id);\n        }\n    });\n    return usuarios_ids_temporal.size;\n}\n\n/**\n * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n *\n * @param {string} id Id del elemento a mostar u ocultar.\n * @param {string} elemento Elemento padre del menú de acciones.\n * @returns {void}\n * @author Andres Morales\n */\nfunction toggleSucursalesList(id, elemento) {\n    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n}\n\n/**\n * Realizar la consulta HTTP para solicitar la renovación de un plan.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function solicitarRenovacionPlan() {\n    $('#modal-solicitar-renovacion').modal('hide');\n    let plan_id = $('#id-plan-solicitar-renovacion').val();\n    await $.ajax({\n        type: 'POST',\n        url : '/solicitud-renovacion-plan',\n        data: {\n            plan_id,\n            empresa_id,\n            usuario_id,\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then(respuesta => {\n        $('#nombre-plan-solicitar-renovacion').text('');\n        $('#id-plan-solicitar-renovacion').val('');\n        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n    });\n}\n\n/**\n * Abrir el modal de confirmación de solicitud de renovación de un plan.\n *\n * @param {number} plan_id Id del plan.\n * @param {string} nombre_plan Nombre del plan.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n    $('#id-plan-solicitar-renovacion').val(plan_id);\n    $('#modal-solicitar-renovacion').modal('show');\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id){\n    if (factura_id) {\n        await $.ajax({\n            type: 'GET',\n            url: `archivos-abrir/${factura_id}`,\n            xhrFields: {responseType: 'blob'},\n        })\n            .then(respuesta => {\n                let ruta_factura = window.URL.createObjectURL(respuesta);\n                window.open(ruta_factura, '_blank');\n            })\n            .catch((error) => {\n                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n            });\n    } else {\n        mostrarToast('danger', 'No se encontró la factura');\n    }\n}\n","structuredPatch":[{"oldStart":177,"oldLines":10,"newStart":177,"newLines":8,"lines":["             <div class=\"card my-5\">","                 <div class=\"card-body\">","                     <div class=\"row\">","+                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>","                         <div class=\"col-auto my-auto\">","-                            ${crearTag({ texto: 'Activos', class: 'tag-tonal-green px-5 py-4'})}","-                        </div>","-                        <div class=\"col-auto my-auto\">","                             <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>","                             <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>","                         </div>"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"07fc2c0d-951e-4f0f-9d17-b2a140379050"}
{"parentUuid":"57ae281a-2313-4626-aaef-b5953110005a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YF4gbHUXFngbgC6vJogVbs","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfecto. Ahora el plan de créditos usa la misma lógica que los planes normales para mostrar el estado con los tags correspondientes según el nombre del estado (Activo, Inactivo, Próximo, Por vencer, Vencido, Renovando).","signature":"EokDCkYICxgCKkCAV3iBJKhgAT5aJvj3BoFo02NbWTjKby93fhFAGop5IKCGS6oIwAdQ8Y5zL+0vszlpAci4sx0Vs9zKYNKns002EgwVAFYjHGalVUJ5Cl4aDBPxHUaLeuSLp/MW+iIwf4mePKBWsjy5FMs1w2viKaHs0ciCOx9xGRckAWalj5tx9KTB7zYTunQaFqiB8T0nKvABaDAGaqoRdcY/bIOsTJtKyl8RvHh7jYVsD85NgnkECuAo7amrzkIQAACWmUN0Asb46P38ZsGWI3aBt6ifvMR6n4FlUnMmwqZf8zqyky6JtXPaR8kG1WMPBYhtkAEsasqX4mURMo1H6gX/0rNVtKEcOMA20zIF0+jKspJebv0SjIn/9MJNOMS3cYanVAEtxlH34FNj0kJngyzITRsH8mndt7PgmIssU+k0x6k8X1bycwgwahwh0ZJWGOvBnkK+TYhkkAOFFPiP47+62Gja8vEyFAHvsNEq7zG1jaUPlnPU2pp46uH5SnOESUqxLW5SlVbgGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":728,"cache_read_input_tokens":37875,"cache_creation":{"ephemeral_5m_input_tokens":728,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvUfE1PgxkDA9nxdsDS","type":"assistant","uuid":"06f5c8ac-05ed-4da9-92f4-fd0bb380bf81","timestamp":"2026-01-22T18:53:32.969Z"}
{"parentUuid":"06f5c8ac-05ed-4da9-92f4-fd0bb380bf81","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YF4gbHUXFngbgC6vJogVbs","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Ahora el plan de créditos usa la misma lógica que los planes normales, mostrando el tag correspondiente según el `estado.nombre` que viene del backend:\n\n- **Activo** → `tag-tonal-green`\n- **Inactivo** → `tag-tonal-gray`\n- **Próximo** → `tag-tonal-purple`\n- **Por vencer** → `tag-tonal-yellow`\n- **Vencido** → `tag-tonal-red`\n- **Renovando** → `tag-tonal-blue`"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":728,"cache_read_input_tokens":37875,"cache_creation":{"ephemeral_5m_input_tokens":728,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNvUfE1PgxkDA9nxdsDS","type":"assistant","uuid":"8e4dc5f2-72c2-407f-8e13-ece93e85f36e","timestamp":"2026-01-22T18:53:34.402Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T19:00:33.939Z","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb"}
{"type":"file-history-snapshot","messageId":"86d69926-8660-4d97-92dc-5d932222971c","snapshot":{"messageId":"86d69926-8660-4d97-92dc-5d932222971c","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v2","version":2,"backupTime":"2026-01-22T18:53:05.618Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v2","version":2,"backupTime":"2026-01-22T19:00:34.963Z"}},"timestamp":"2026-01-22T19:00:34.949Z"},"isSnapshotUpdate":false}
{"parentUuid":"bb9c2826-4bb9-4fb6-bea6-7bf6ffb29c87","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01Wf2FYWdpx1wM9WYyavJrZW","parentToolUseID":"toolu_01Wf2FYWdpx1wM9WYyavJrZW","uuid":"a7280ab0-f772-44aa-8acc-0834d997be09","timestamp":"2026-01-22T18:53:10.852Z"}
{"parentUuid":"07fc2c0d-951e-4f0f-9d17-b2a140379050","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_012LyXM6LP4jrohLUJdD7LQR","parentToolUseID":"toolu_012LyXM6LP4jrohLUJdD7LQR","uuid":"46fb2381-7fff-4581-9e68-a9e511af16cb","timestamp":"2026-01-22T18:53:20.904Z"}
{"parentUuid":"46fb2381-7fff-4581-9e68-a9e511af16cb","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_012LyXM6LP4jrohLUJdD7LQR","parentToolUseID":"toolu_012LyXM6LP4jrohLUJdD7LQR","uuid":"4126f353-646c-48b4-8eb6-dc97bdbb14aa","timestamp":"2026-01-22T18:53:20.904Z"}
{"parentUuid":"57ae281a-2313-4626-aaef-b5953110005a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_012LyXM6LP4jrohLUJdD7LQR","toolUseID":"toolu_012LyXM6LP4jrohLUJdD7LQR","timestamp":"2026-01-22T18:53:27.527Z","uuid":"8d206fd8-e8b0-4f9d-bb6f-fba137d9f050"}
{"parentUuid":"8e4dc5f2-72c2-407f-8e13-ece93e85f36e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 92 to 92 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php:\npublic function getTodo(Request $request): Collection {\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"listo analiza eta funcion y su modelo public function getTodo(Request $request): Collection { ya que si llega el elfilled un capor que dice con conteo consumo creditos en treu me traiga el conte de lso creditos pero en el modeo,ya esta la realcion en el modelo public function consumosCreditos(): HasMany { public function consumosCreditos(): HasMany {"}]},"uuid":"86d69926-8660-4d97-92dc-5d932222971c","timestamp":"2026-01-22T19:00:34.947Z","permissionMode":"default"}
{"parentUuid":"86d69926-8660-4d97-92dc-5d932222971c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vkcne44EvV3u2FyFpjfjoC","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que analice la función `getTodo` en el repositorio `EmpresaPlanRepository` y el modelo relacionado. Quiere agregar una funcionalidad donde si llega un parámetro `con_conteo_consumo_creditos` en true, se traiga el conteo de los créditos usando la relación `consumosCreditos` que ya existe en el modelo.\n\nPrimero necesito leer el repositorio y el modelo para entender la estructura actual.","signature":"EsIECkYICxgCKkCSWXay6sujAzEBk/kwiTjg7ipXzvoJbk1Smc8kMdr1b+DFuiDdkFQBahpbxHTNxdG16Tlj99ckKQEhBGxAcraPEgxKOraS2D/64nwtzgYaDLRQE2VrgzsoHjmFlCIwrFKYEXZlMdhWpiUgz02MdxSmWhaTQv97msVWA3/p8YEvqtpHo/BH9L8ilmElGoBUKqkDIxx+QwRU6a8B7C0K0Iq/LrGXmjUT4dcC+OJ689B5VCN615cg415FQ3zDYTlfErsB4sBrcSxAbwMz9BnYkf9l+Tf1fXBoAFNTyOiJUgIsVVTE4T8AYjBn3pTDID+m4d/+4E9OtIq5FvntOSkpys+SPsJ+d2WUVgJZNDMpZs3G7SeYjwY+DH2Wvy6FadZVeXouyXve6mn9GRf8SyyLQFX/TJ8vPjQ9UdIUOtTL1nmzTsDVcjRyjMw/cRMKgWYWMzs19srfMvKu5+fLy1/GRpXz7CYg5XrShAtb3H4O421zWtdHsN7SBQw1Gm+Dxr/YZ2PV/bGaIf2kCnMh0Y/kldFeihwFm3Csk40OHiu2LjLlXB2pZEq8n7yHn0u5w5Ke/ghLZGJrju96JjDLQQ6iB3Li/D1wi6y+MxefO/odlDJGf2gNzZ/Dr/uZBhyk+sCztppd+9VMw2i/weuK3GmiYS3P4T7YuRWHISxv76bDreFrbHDR0felnC/3CwSOG5X3JBF/Pr8N6i4WidqaVH5SUPCLSx0gShSrFcTUbJkg2i7AC0NdgLXpV27KrVAYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":39570,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":39570,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNw24LgEMKpJQ5ee8uJz","type":"assistant","uuid":"62e4077d-d027-473b-9de6-43eb88b60d8f","timestamp":"2026-01-22T19:00:39.465Z"}
{"parentUuid":"62e4077d-d027-473b-9de6-43eb88b60d8f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vkcne44EvV3u2FyFpjfjoC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KbBLiXvMLxP5E4DUw4Z4TG","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":39570,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":39570,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNw24LgEMKpJQ5ee8uJz","type":"assistant","uuid":"90c819e2-0189-485c-b0ef-50769c8fa863","timestamp":"2026-01-22T19:00:39.954Z"}
{"parentUuid":"90c819e2-0189-485c-b0ef-50769c8fa863","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vkcne44EvV3u2FyFpjfjoC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BdQb5vRHWDp7Pc1PX6wt1L","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":39570,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":39570,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNw24LgEMKpJQ5ee8uJz","type":"assistant","uuid":"b9ea9089-5fec-41a0-9e60-20d607dbcae6","timestamp":"2026-01-22T19:00:40.385Z"}
{"parentUuid":"b9ea9089-5fec-41a0-9e60-20d607dbcae6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BdQb5vRHWDp7Pc1PX6wt1L","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Models\\Empresas;\n     4→\n     5→use App\\Models\\Planes\\Plan;\n     6→use App\\Models\\Usuarios\\User;\n     7→use App\\Models\\Planes\\Consumo;\n     8→use App\\Models\\Pruebas\\Prueba;\n     9→use OwenIt\\Auditing\\Auditable;\n    10→use App\\Models\\IA\\ConsumoCredito;\n    11→use App\\Models\\Planes\\EstadoPlan;\n    12→use App\\Models\\Planes\\PlanCredito;\n    13→use App\\Models\\Planes\\Funcionalidad;\n    14→use App\\Models\\Configuraciones\\Archivo;\n    15→use Illuminate\\Database\\Eloquent\\Model;\n    16→use Illuminate\\Database\\Eloquent\\Relations\\HasMany;\n    17→use Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\n    18→use Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\n    19→use Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\n    20→use OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n    21→\n    22→class EmpresaPlan extends Model implements AuditableContract\n    23→{\n    24→    use Auditable;\n    25→\n    26→    protected $table = 'empresas_planes';\n    27→\n    28→    protected $fillable = [\n    29→        'empresa_id',\n    30→        'plan_id',\n    31→        'plan_credito_id',\n    32→        'usuario_id',\n    33→        'estado_id',\n    34→        'unidades',\n    35→        'cantidad_ofertas_laborales',\n    36→        'cantidad_usuarios',\n    37→        'cantidad_pruebas',\n    38→        'creditos',\n    39→        'fecha_inicio',\n    40→        'fecha_vencimiento',\n    41→        'precio',\n    42→        'porcentaje_descuento',\n    43→        'numero_factura',\n    44→        'comentario',\n    45→        'plan_original',\n    46→        'renovando',\n    47→        'por_facturar'\n    48→    ];\n    49→\n    50→    protected $casts = [\n    51→        'plan_credito_id'   => 'integer',\n    52→        'creditos'          => 'integer',\n    53→        'fecha_inicio'      => 'date:Y-m-d',\n    54→        'fecha_vencimiento' => 'date:Y-m-d'\n    55→    ];\n    56→\n    57→    protected $appends = [\n    58→        'vigencia_dias',\n    59→        'creditos_restantes'\n    60→    ];\n    61→\n    62→    /**\n    63→     * Obtener el atributo vigencia_dias.\n    64→     *\n    65→     * @return int\n    66→     * @author Daniel Beltrán\n    67→     */\n    68→    public function getVigenciaDiasAttribute(): int {\n    69→        $vigencia = 0;\n    70→\n    71→        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n    72→            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n    73→        }\n    74→\n    75→        return $vigencia;\n    76→    }\n    77→\n    78→    /**\n    79→     * Obtener el atributo creditos_restantes.\n    80→     *\n    81→     * @return int\n    82→     * @author Sergio Vargas\n    83→     * @author Daniel Beltrán\n    84→     */\n    85→    public function getCreditosRestantesAttribute(): int {\n    86→        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    87→    }\n    88→\n    89→    /**\n    90→     * Relación de muchos a uno con empresas.\n    91→     *\n    92→     * @return BelongsTo\n    93→     * @author Daniel Beltrán\n    94→     */\n    95→    public function empresa(): BelongsTo {\n    96→        return $this->belongsTo(Empresa::class);\n    97→    }\n    98→\n    99→    /**\n   100→     * Relación de muchos a uno con planes.\n   101→     *\n   102→     * @return BelongsTo\n   103→     * @author Daniel Beltrán\n   104→     */\n   105→    public function plan(): BelongsTo {\n   106→        return $this->belongsTo(Plan::class);\n   107→    }\n   108→\n   109→    /**\n   110→     * Relación de muchos a uno con planes_creditos.\n   111→     *\n   112→     * @return BelongsTo\n   113→     * @author Sergio Vargas\n   114→     * @author Daniel Beltrán\n   115→     * @author Jair Carvajal\n   116→     */\n   117→    public function planCredito(): BelongsTo {\n   118→        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n   119→    }\n   120→\n   121→    /**\n   122→     * Relación de uno a varios con users.\n   123→     *\n   124→     * @return BelongsTo\n   125→     * @author José Manuel Jiménez\n   126→     */\n   127→    public function usuario(): BelongsTo {\n   128→        return $this->belongsTo(User::class);\n   129→    }\n   130→\n   131→    /**\n   132→     * Relación de muchos a uno con estados_planes.\n   133→     *\n   134→     * @return BelongsTo\n   135→     * @author Daniel Beltrán\n   136→     */\n   137→    public function estado(): BelongsTo {\n   138→        return $this->belongsTo(EstadoPlan::class);\n   139→    }\n   140→\n   141→    /**\n   142→     * Relación de uno a muchos con consumos.\n   143→     *\n   144→     * @return HasMany\n   145→     * @author Daniel Beltrán\n   146→     */\n   147→    public function consumos(): HasMany {\n   148→        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n   149→    }\n   150→\n   151→    /**\n   152→     * Relación de uno a muchos con consumos de créditos.\n   153→     *\n   154→     * @return HasMany\n   155→     * @author Sergio Vargas\n   156→     * @author Daniel Beltrán\n   157→     */\n   158→    public function consumosCreditos(): HasMany {\n   159→        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n   160→    }\n   161→\n   162→    /**\n   163→     * Relación de muchos a muchos con pruebas.\n   164→     *\n   165→     * @return BelongsToMany\n   166→     * @author Daniel Beltrán\n   167→     */\n   168→    public function pruebas(): BelongsToMany {\n   169→        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n   170→    }\n   171→\n   172→    /**\n   173→     * Relación polimórfica de uno a muchos con archivos.\n   174→     *\n   175→     * @return MorphMany\n   176→     * @author Daniel Beltrán\n   177→     */\n   178→    public function archivos(): MorphMany {\n   179→        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n   180→    }\n   181→\n   182→    /**\n   183→     * Relación de muchos a muchos con funcionalidades.\n   184→     *\n   185→     * @return BelongsToMany\n   186→     * @author Daniel Beltrán\n   187→     */\n   188→    public function funcionalidades(): BelongsToMany {\n   189→        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n   190→    }\n   191→}\n   192→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ab795dfb-9727-4390-b1b4-8073e0089a50","timestamp":"2026-01-22T19:00:42.690Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Models\\Empresas\\EmpresaPlan.php","content":"<?php\n\nnamespace App\\Models\\Empresas;\n\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\Usuarios\\User;\nuse App\\Models\\Planes\\Consumo;\nuse App\\Models\\Pruebas\\Prueba;\nuse OwenIt\\Auditing\\Auditable;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Models\\Planes\\EstadoPlan;\nuse App\\Models\\Planes\\PlanCredito;\nuse App\\Models\\Planes\\Funcionalidad;\nuse App\\Models\\Configuraciones\\Archivo;\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Relations\\MorphMany;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsToMany;\nuse OwenIt\\Auditing\\Contracts\\Auditable as AuditableContract;\n\nclass EmpresaPlan extends Model implements AuditableContract\n{\n    use Auditable;\n\n    protected $table = 'empresas_planes';\n\n    protected $fillable = [\n        'empresa_id',\n        'plan_id',\n        'plan_credito_id',\n        'usuario_id',\n        'estado_id',\n        'unidades',\n        'cantidad_ofertas_laborales',\n        'cantidad_usuarios',\n        'cantidad_pruebas',\n        'creditos',\n        'fecha_inicio',\n        'fecha_vencimiento',\n        'precio',\n        'porcentaje_descuento',\n        'numero_factura',\n        'comentario',\n        'plan_original',\n        'renovando',\n        'por_facturar'\n    ];\n\n    protected $casts = [\n        'plan_credito_id'   => 'integer',\n        'creditos'          => 'integer',\n        'fecha_inicio'      => 'date:Y-m-d',\n        'fecha_vencimiento' => 'date:Y-m-d'\n    ];\n\n    protected $appends = [\n        'vigencia_dias',\n        'creditos_restantes'\n    ];\n\n    /**\n     * Obtener el atributo vigencia_dias.\n     *\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function getVigenciaDiasAttribute(): int {\n        $vigencia = 0;\n\n        if (!is_null($this->fecha_vencimiento) && !is_null($this->fecha_inicio)) {\n            $vigencia = $this->fecha_inicio->diffInDays($this->fecha_vencimiento);\n        }\n\n        return $vigencia;\n    }\n\n    /**\n     * Obtener el atributo creditos_restantes.\n     *\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function getCreditosRestantesAttribute(): int {\n        return max(0, $this->creditos - $this->consumosCreditos()->sum('creditos'));\n    }\n\n    /**\n     * Relación de muchos a uno con empresas.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function empresa(): BelongsTo {\n        return $this->belongsTo(Empresa::class);\n    }\n\n    /**\n     * Relación de muchos a uno con planes.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function plan(): BelongsTo {\n        return $this->belongsTo(Plan::class);\n    }\n\n    /**\n     * Relación de muchos a uno con planes_creditos.\n     *\n     * @return BelongsTo\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planCredito(): BelongsTo {\n        return $this->belongsTo(PlanCredito::class, 'plan_credito_id')->withDefault([]);\n    }\n\n    /**\n     * Relación de uno a varios con users.\n     *\n     * @return BelongsTo\n     * @author José Manuel Jiménez\n     */\n    public function usuario(): BelongsTo {\n        return $this->belongsTo(User::class);\n    }\n\n    /**\n     * Relación de muchos a uno con estados_planes.\n     *\n     * @return BelongsTo\n     * @author Daniel Beltrán\n     */\n    public function estado(): BelongsTo {\n        return $this->belongsTo(EstadoPlan::class);\n    }\n\n    /**\n     * Relación de uno a muchos con consumos.\n     *\n     * @return HasMany\n     * @author Daniel Beltrán\n     */\n    public function consumos(): HasMany {\n        return $this->hasMany(Consumo::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de uno a muchos con consumos de créditos.\n     *\n     * @return HasMany\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function consumosCreditos(): HasMany {\n        return $this->hasMany(ConsumoCredito::class, 'empresa_plan_id');\n    }\n\n    /**\n     * Relación de muchos a muchos con pruebas.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function pruebas(): BelongsToMany {\n        return $this->belongsToMany(Prueba::class, 'empresas_planes_pruebas', 'empresa_plan_id', 'prueba_id')->withTimestamps();\n    }\n\n    /**\n     * Relación polimórfica de uno a muchos con archivos.\n     *\n     * @return MorphMany\n     * @author Daniel Beltrán\n     */\n    public function archivos(): MorphMany {\n        return $this->morphMany(Archivo::class, 'modelo', 'modelo', 'modelo_id');\n    }\n\n    /**\n     * Relación de muchos a muchos con funcionalidades.\n     *\n     * @return BelongsToMany\n     * @author Daniel Beltrán\n     */\n    public function funcionalidades(): BelongsToMany {\n        return $this->belongsToMany(Funcionalidad::class, 'empresas_planes_funcionalidades', 'empresa_plan_id', 'funcionalidad_id')->withTimestamps();\n    }\n}\n","numLines":192,"startLine":1,"totalLines":192}},"sourceToolAssistantUUID":"b9ea9089-5fec-41a0-9e60-20d607dbcae6"}
{"parentUuid":"90c819e2-0189-485c-b0ef-50769c8fa863","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KbBLiXvMLxP5E4DUw4Z4TG","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Repositories\\Empresas;\n     4→\n     5→use Illuminate\\Http\\Request;\n     6→use App\\Models\\Pruebas\\TipoPrueba;\n     7→use Illuminate\\Support\\Collection;\n     8→use Illuminate\\Support\\Facades\\DB;\n     9→use App\\Models\\Empresas\\EmpresaPlan;\n    10→use App\\Http\\Repositories\\BaseRepository;\n    11→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    12→use App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n    13→\n    14→class EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n    15→{\n    16→    /**\n    17→     * Ids de los roles de tipo empresa.\n    18→     *\n    19→     * @var array\n    20→     * @author Fahibram Cárcamo\n    21→     */\n    22→    private const IDS_ROLES_TIPO_EMPRESA = [\n    23→        RolRepository::ROL_PROPIETARIO_ID,\n    24→        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n    25→        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n    26→        RolRepository::ROL_EVALUADOR_ID\n    27→    ];\n    28→\n    29→    private $consulta_conteo_total_usuarios_empresa_sucursales;\n    30→\n    31→    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n    32→\n    33→    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n    39→     * @return void\n    40→     * @author Daniel Beltrán\n    41→     * @author Fahibram Cárcamo\n    42→     */\n    43→    public function __construct(EmpresaPlan $modelo) {\n    44→        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n    45→            (\n    46→                SELECT COUNT(DISTINCT eu.usuario_id)\n    47→                FROM empresas_usuarios AS eu\n    48→                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n    49→                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n    50→                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n    51→            ) AS conteo_total_usuarios_empresa_sucursales\n    52→        ';\n    53→\n    54→        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n    55→            (\n    56→                SELECT COUNT(*)\n    57→                FROM consumos\n    58→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    59→                WHERE (\n    60→                    consumos.empresa_id = empresas_planes.empresa_id\n    61→                    OR suc.empresa_id = empresas_planes.empresa_id\n    62→                )\n    63→                AND consumos.agenda_id IS NOT NULL\n    64→            ) AS conteo_total_consumos_agendas_empresa_sucursales\n    65→        ';\n    66→\n    67→        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n    68→            (\n    69→                SELECT COUNT(*)\n    70→                FROM consumos\n    71→                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n    72→                WHERE (\n    73→                    consumos.empresa_id = empresas_planes.empresa_id\n    74→                    OR suc.empresa_id = empresas_planes.empresa_id\n    75→                )\n    76→                AND consumos.oferta_laboral_id IS NOT NULL\n    77→            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n    78→        ';\n    79→\n    80→        parent::__construct($modelo);\n    81→    }\n    82→\n    83→    /**\n    84→     * Obtener todos los planes de empresas.\n    85→     *\n    86→     * @param Request $request Contenido de la petición.\n    87→     * @return Collection\n    88→     * @author Daniel Beltrán\n    89→     * @author Fahibram Cárcamo\n    90→     * @author Jair Carvajal\n    91→     */\n    92→    public function getTodo(Request $request): Collection {\n    93→        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n    94→            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    95→        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n    96→            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n    97→        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n    98→            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    99→        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n   100→            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n   101→\n   102→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   103→        ->with([\n   104→            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n   105→            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   106→            'plan.tipoPrueba:id,nombre',\n   107→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   108→            'estado:id,nombre',\n   109→            'pruebas:id,nombre',\n   110→            'funcionalidades:id,nombre,predeterminado',\n   111→            'archivos' => function ($archivos) {\n   112→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   113→            }\n   114→        ])\n   115→        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   116→            $query->with([\n   117→                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n   118→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   119→                        ->with(['empresa' => function ($empresa) {\n   120→                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n   121→                        }])\n   122→                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n   123→                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n   124→                },\n   125→                'consumos.agenda:id,prueba_id',\n   126→                'consumos.agenda.prueba:id,nombre,slug'\n   127→            ]);\n   128→        })\n   129→        ->when($con_conteo_consumos_agendas, function ($consulta) {\n   130→            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   131→        })\n   132→        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n   133→            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   134→        })\n   135→        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n   136→            $query->where('empresa_id', $request->empresa_id);\n   137→        })\n   138→        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n   139→            $query->whereHas('plan', function ($plan) use ($request) {\n   140→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   141→            });\n   142→        })\n   143→        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n   144→            $query->whereHas('plan', function ($plan) use ($request) {\n   145→                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n   146→            });\n   147→        })\n   148→        ->when($request->filled('plan_id'), function ($query) use ($request) {\n   149→            $query->where('plan_id', $request->plan_id);\n   150→        })\n   151→        ->when(\n   152→            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n   153→            function ($query) use ($request) {\n   154→                $query->whereIn($request->campo, $request->valores);\n   155→            }\n   156→        )\n   157→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   158→            $consulta->whereIn('estado_id', $request->estado_id);\n   159→        })\n   160→        ->when(\n   161→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   162→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   163→        )\n   164→        ->when(\n   165→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   166→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   167→        )\n   168→        ->when(\n   169→            $request->filled('fecha_vencimiento_desde'),\n   170→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   171→        )\n   172→        ->when(\n   173→            $request->filled('fecha_vencimiento_hasta'),\n   174→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   175→        )\n   176→        ->when(\n   177→            $request->filled('fecha_inicio_desde'),\n   178→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   179→        )\n   180→        ->when(\n   181→            $request->filled('fecha_inicio_hasta'),\n   182→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   183→        )\n   184→        ->orderBy('created_at', 'DESC')\n   185→        ->get();\n   186→    }\n   187→\n   188→    /**\n   189→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n   190→     *\n   191→     * @param Request $request Contenido de la petición HTTP entrante.\n   192→     * @return Collection\n   193→     * @author Fahibram Cárcamo\n   194→     * @author Jair Carvajal\n   195→     */\n   196→    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n   197→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   198→            ->addSelect([\n   199→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   200→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   201→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   202→            ])\n   203→            ->whereExists(function ($subconsulta) {\n   204→                $subconsulta->select(DB::raw(1))\n   205→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   206→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   207→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   208→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   209→            })\n   210→            ->with([\n   211→                'estado:id,nombre',\n   212→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   213→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n   214→            ])\n   215→            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n   216→            ->when(\n   217→                $request->filled('tipo_prueba_id'),\n   218→                function ($consulta) use ($request) {\n   219→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   220→                },\n   221→                function ($consulta) {\n   222→                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   223→                        TipoPrueba::SELECCION_ID,\n   224→                        TipoPrueba::ORGANIZACIONAL_ID,\n   225→                        TipoPrueba::VOCACIONAL_ID\n   226→                    ]));\n   227→                }\n   228→            )\n   229→            ->get();\n   230→    }\n   231→\n   232→    /**\n   233→     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n   234→     *\n   235→     * @param Request $request Contenido de la petición HTTP entrante.\n   236→     * @return Collection\n   237→     * @author Fahibram Cárcamo\n   238→     * @author Andres Gonzalez\n   239→     * @author Jair Carvajal\n   240→     */\n   241→    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n   242→        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   243→            ->addSelect([\n   244→                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n   245→                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n   246→                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n   247→            ])\n   248→            ->whereExists(function ($sub_consulta) {\n   249→                $sub_consulta->select(DB::raw(1))\n   250→                    ->from('empresas_planes AS empresas_planes_subconsulta')\n   251→                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   252→                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   253→                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   254→            })\n   255→            ->with([\n   256→                'estado:id,nombre',\n   257→                'plan:id,tipo_prueba_id,nombre,vigencia',\n   258→                'plan.tipoPrueba:id,nombre',\n   259→                'pruebas:id,nombre,slug',\n   260→                'funcionalidades:id,nombre,predeterminado',\n   261→                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n   262→                'consumos' => function ($consumos) {\n   263→                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n   264→                        ->with([\n   265→                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n   266→                            'agenda:id,prueba_id',\n   267→                            'agenda.prueba:id,nombre,slug'\n   268→                        ]);\n   269→                }\n   270→            ])\n   271→            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   272→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   273→            })\n   274→            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   275→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n   276→            })\n   277→            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n   278→                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n   279→                    $sub_consulta->where('empresa_id', $request->empresa_id)\n   280→                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n   281→                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n   282→                        });\n   283→                });\n   284→            })\n   285→            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   286→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n   287→            }, function ($consulta) {\n   288→                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n   289→                    TipoPrueba::SELECCION_ID,\n   290→                    TipoPrueba::ORGANIZACIONAL_ID,\n   291→                    TipoPrueba::VOCACIONAL_ID\n   292→                ]));\n   293→            })\n   294→            ->orderBy('created_at', 'DESC')\n   295→            ->get();\n   296→    }\n   297→\n   298→    /**\n   299→     * Obtener datos básicos de los planes de empresas.\n   300→     *\n   301→     * @param Request $request Contenido de la petición.\n   302→     * @return Collection\n   303→     * @author Daniel Beltrán\n   304→     * @author Fahibram Cárcamo\n   305→     * @author Jair Carvajal\n   306→     */\n   307→    public function getDatosBasicos(Request $request): Collection {\n   308→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n   309→        ->with([\n   310→            'plan:id,tipo_prueba_id,nombre'\n   311→        ])\n   312→        ->withCount([\n   313→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   314→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n   315→        ])\n   316→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   317→            $consulta->where('empresa_id', $request->empresa_id);\n   318→        })\n   319→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   320→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   321→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   322→            });\n   323→        })\n   324→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   325→            $consulta->whereIn('estado_id', $request->estados_ids);\n   326→        })\n   327→        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n   328→            $sentido = $request->ordenar_sentido ?? 'ASC';\n   329→            $consulta->orderBy($request->ordenar_por, $sentido);\n   330→        })\n   331→        ->get();\n   332→    }\n   333→\n   334→    /**\n   335→     * Obtener un plan de empresa.\n   336→     *\n   337→     * @param int $id ID del plan de empresa.\n   338→     * @return EmpresaPlan|null\n   339→     * @author Daniel Beltrán\n   340→     * @author Jair Carvajal\n   341→     */\n   342→    public function getUno(int $id): ?EmpresaPlan {\n   343→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   344→        ->with([\n   345→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n   346→            'plan.tipoPrueba:id,nombre',\n   347→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   348→            'estado:id,nombre',\n   349→            'pruebas:id,nombre,slug',\n   350→            'funcionalidades:id,nombre,llave,valor',\n   351→            'archivos' => function ($archivos) {\n   352→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n   353→            }\n   354→        ])\n   355→        ->find($id);\n   356→    }\n   357→\n   358→    /**\n   359→     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n   360→     *\n   361→     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n   362→     *\n   363→     * @param int $empresa_id ID de la empresa.\n   364→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   365→     * @return EmpresaPlan|null\n   366→     * @author Daniel Beltrán\n   367→     * @author Fahibram Cárcamo\n   368→     * @author José Manuel Jiménez\n   369→     * @author Andres Gonzalez\n   370→     * @author Sergio Vargas\n   371→     * @author Jair Carvajal\n   372→     */\n   373→    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   374→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   375→        ->with([\n   376→            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n   377→            'plan.tipoPrueba:id,nombre',\n   378→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   379→            'estado:id,nombre',\n   380→            'pruebas:id,nombre,slug',\n   381→            'usuario:id,nombres,apellidos',\n   382→            'archivos' => function ($archivos) {\n   383→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   384→                ->orderBy('created_at', 'DESC');\n   385→            }\n   386→        ])\n   387→        ->withCount([\n   388→            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n   389→            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n   390→            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n   391→        ])\n   392→        ->where('empresa_id', $empresa_id)\n   393→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   394→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   395→        })\n   396→        ->whereIn('estado_id', [1, 4])\n   397→        ->first();\n   398→    }\n   399→\n   400→    /**\n   401→     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n   402→     *\n   403→     * @param int $empresa_id ID de la empresa.\n   404→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   405→     * @return EmpresaPlan|null\n   406→     * @author Daniel Beltrán\n   407→     * @author Jair Carvajal\n   408→     */\n   409→    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   410→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   411→        ->with([\n   412→            'plan:id,tipo_prueba_id,nombre',\n   413→            'plan.tipoPrueba:id,nombre',\n   414→            'estado:id,nombre',\n   415→            'pruebas:id,nombre',\n   416→            'archivos' => function ($archivos) {\n   417→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   418→                ->orderBy('created_at', 'DESC');\n   419→            }\n   420→        ])\n   421→        ->where([\n   422→            'empresa_id' => $empresa_id,\n   423→            'estado_id'  => 3\n   424→        ])\n   425→        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n   426→            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n   427→        })\n   428→        ->first();\n   429→    }\n   430→\n   431→    /**\n   432→     * Obtener el último plan asignado.\n   433→     *\n   434→     * @param Request $request Contenido de la petición.\n   435→     * @return EmpresaPlan|null\n   436→     * @author Daniel Beltrán\n   437→     * @author Jair Carvajal\n   438→     */\n   439→    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n   440→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   441→        ->with([\n   442→            'plan:id,tipo_prueba_id,nombre',\n   443→            'plan.tipoPrueba:id,nombre',\n   444→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   445→            'estado:id,nombre',\n   446→            'pruebas:id,nombre',\n   447→            'archivos' => function ($archivos) {\n   448→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   449→                ->orderBy('created_at', 'DESC');\n   450→            }\n   451→        ])\n   452→        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n   453→            $consulta->where('empresa_id', $request->empresa_id);\n   454→        })\n   455→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   456→            $consulta->where('estado_id', $request->estado_id);\n   457→        })\n   458→        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n   459→            $consulta->whereIn('estado_id', $request->estados_ids);\n   460→        })\n   461→        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n   462→            $consulta->where('estado_id', '!=', 3);\n   463→        })\n   464→        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n   465→            $consulta->whereHas('plan', function ($plan) use ($request) {\n   466→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   467→            });\n   468→        })\n   469→        ->orderBy('created_at', 'DESC')\n   470→        ->first();\n   471→    }\n   472→\n   473→    /**\n   474→     * Sincronizar pruebas.\n   475→     *\n   476→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   477→     * @param array $pruebas ID's de las pruebas.\n   478→     * @return void\n   479→     * @author Daniel Beltrán\n   480→     */\n   481→    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n   482→        $empresa_plan->pruebas()->sync($pruebas);\n   483→    }\n   484→\n   485→    /**\n   486→     * Sincronizar funcionalidades.\n   487→     *\n   488→     * @param EmpresaPlan $empresa_plan Plan de empresa.\n   489→     * @param array $funcionalidades ID's de las funcionalidades.\n   490→     * @return void\n   491→     * @author Daniel Beltrán\n   492→     */\n   493→    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n   494→        $empresa_plan->funcionalidades()->sync($funcionalidades);\n   495→    }\n   496→\n   497→    /**\n   498→     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n   499→     *\n   500→     * @param Request $request Contenido de la petición.\n   501→     * @return ?EmpresaPlan\n   502→     * @author Fahibram Cárcamo\n   503→     * @author Jair Carvajal\n   504→     */\n   505→    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n   506→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n   507→        ->with([\n   508→            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n   509→            'plan.tipoPrueba:id,nombre',\n   510→            'estado:id,nombre',\n   511→            'pruebas:id,nombre',\n   512→            'funcionalidades:id,nombre,llave,valor'\n   513→        ])\n   514→        ->when(\n   515→            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n   516→            function ($consulta) {\n   517→                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   518→            }\n   519→        )\n   520→        ->when(\n   521→            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n   522→            function ($consulta) {\n   523→                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   524→            }\n   525→        )\n   526→        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n   527→        ->first();\n   528→    }\n   529→\n   530→    /**\n   531→     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n   532→     *\n   533→     * @return Collection\n   534→     * @author Fahibram Cárcamo\n   535→     * @author Andres Gonzalez\n   536→     * @author José Manuel Jiménez\n   537→     * @author Jair Carvajal\n   538→     * @author Daniel Beltrán\n   539→     */\n   540→    public function datosConsumosEmpresas(Request $request): Collection {\n   541→        $roles_tipo_empresa_ids = [\n   542→            RolRepository::ROL_PROPIETARIO_ID,\n   543→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   544→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   545→            RolRepository::ROL_EVALUADOR_ID\n   546→        ];\n   547→\n   548→        $matriz_conteos = [\n   549→            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n   550→            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n   551→            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n   552→                'empresasUsuarios',\n   553→                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n   554→            )\n   555→        ];\n   556→\n   557→        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n   558→\n   559→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   560→            ->addSelect([\n   561→                DB::raw('\n   562→                    (\n   563→                        SELECT COUNT(DISTINCT eu.usuario_id)\n   564→                        FROM empresas_usuarios AS eu\n   565→                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n   566→                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n   567→                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n   568→                    ) AS conteo_total_usuarios_empresa_sucursales\n   569→                '),\n   570→                DB::raw('\n   571→                    (\n   572→                        SELECT COUNT(*)\n   573→                        FROM consumos\n   574→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   575→                        WHERE (\n   576→                            consumos.empresa_id = empresas_planes.empresa_id\n   577→                            OR suc.empresa_id = empresas_planes.empresa_id\n   578→                        )\n   579→                        AND consumos.agenda_id IS NOT NULL\n   580→                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n   581→                '),\n   582→                DB::raw('\n   583→                    (\n   584→                        SELECT COUNT(*)\n   585→                        FROM consumos\n   586→                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n   587→                        WHERE (\n   588→                            consumos.empresa_id = empresas_planes.empresa_id\n   589→                            OR suc.empresa_id = empresas_planes.empresa_id\n   590→                        )\n   591→                        AND consumos.oferta_laboral_id IS NOT NULL\n   592→                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n   593→                '),\n   594→            ])\n   595→            ->with([\n   596→                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n   597→                'plan.tipoPrueba:id,nombre',\n   598→                'pruebas:id,nombre,slug',\n   599→                'estado:id,nombre',\n   600→                'usuario:id,nombres,apellidos',\n   601→                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n   602→                    $consulta_empresa->select($campos_empresas)\n   603→                        ->whereNull('empresa_id')\n   604→                        ->withCount([\n   605→                            ...$matriz_conteos,\n   606→                            'sucursales as conteo_sucursales'\n   607→                        ])\n   608→                        ->with([\n   609→                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n   610→                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n   611→                            }\n   612→                        ]);\n   613→                }\n   614→            ])\n   615→            ->when(\n   616→                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n   617→                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n   618→            )\n   619→            ->whereNotIn('estado_id', [3, 8])\n   620→            ->when(\n   621→                $request->filled('prueba_id'),\n   622→                fn($consulta) => $consulta->whereHas(\n   623→                    'pruebas',\n   624→                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n   625→                )\n   626→            )\n   627→            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n   628→                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n   629→            })\n   630→            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n   631→                switch ($request->plan_por) {\n   632→                    case 'por unidades':\n   633→                        $consulta_plan_por->whereNotNull('unidades');\n   634→                        break;\n   635→\n   636→                    case 'por ofertas laborales':\n   637→                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n   638→                        break;\n   639→\n   640→                    case 'por tiempo':\n   641→                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n   642→                        break;\n   643→                }\n   644→            })\n   645→            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n   646→                $fecha_inicio = $request->fecha_vencimiento;\n   647→                $fecha_fin    = $request->fecha_vencimiento;\n   648→\n   649→                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n   650→                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n   651→                    $fecha_inicio = $fechas[0];\n   652→                    $fecha_fin    = $fechas[1];\n   653→                }\n   654→\n   655→                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n   656→            })\n   657→            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n   658→                $fecha_inicio = $request->fecha_inicio;\n   659→                $fecha_fin    = $request->fecha_inicio;\n   660→\n   661→                if (strpos($request->fecha_inicio, ' a ') !== false) {\n   662→                    $fechas       = explode(' a ', $request->fecha_inicio);\n   663→                    $fecha_inicio = $fechas[0];\n   664→                    $fecha_fin    = $fechas[1];\n   665→                }\n   666→\n   667→                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n   668→            })\n   669→            ->when(\n   670→                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   671→                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n   672→            )\n   673→            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n   674→                if ($request->tipo_activacion === 'compra') {\n   675→                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n   676→                        $subconsulta->select(DB::raw(1))\n   677→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   678→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   679→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   680→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   681→                    });\n   682→                } elseif ($request->tipo_activacion === 'recompra') {\n   683→                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n   684→                        $subconsulta->select(DB::raw(1))\n   685→                            ->from('empresas_planes AS empresas_planes_subconsulta')\n   686→                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n   687→                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n   688→                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n   689→                    });\n   690→                }\n   691→            })\n   692→            ->get();\n   693→    }\n   694→\n   695→    /**\n   696→     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n   697→     *\n   698→     * @param Request $request Contenido de la petición HTTP entrante.\n   699→     * @return Collection\n   700→     * @author Fahibram Cárcamo\n   701→     */\n   702→    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n   703→        return $this->modelo::select(\n   704→            'empresas_planes.id',\n   705→            'empresas_planes.empresa_id',\n   706→            'empresas_planes.plan_id',\n   707→            'empresas_planes.plan_credito_id',\n   708→            'empresas_planes.usuario_id',\n   709→            'empresas_planes.estado_id',\n   710→            'empresas_planes.unidades',\n   711→            'empresas_planes.cantidad_ofertas_laborales',\n   712→            'empresas_planes.cantidad_usuarios',\n   713→            'empresas_planes.cantidad_pruebas',\n   714→            'empresas_planes.creditos',\n   715→            'empresas_planes.fecha_inicio',\n   716→            'empresas_planes.fecha_vencimiento',\n   717→            'empresas_planes.precio',\n   718→            'empresas_planes.porcentaje_descuento',\n   719→            'empresas_planes.numero_factura',\n   720→            'empresas_planes.comentario',\n   721→            'empresas_planes.plan_original',\n   722→            'empresas_planes.renovando',\n   723→            'empresas_planes.por_facturar',\n   724→            'empresas_planes.created_at',\n   725→            'planes.id',\n   726→            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n   727→            'planes.nombre AS plan_nombre',\n   728→            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n   729→            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n   730→            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n   731→            'planes.unidades AS plan_unidades',\n   732→            'planes.vigencia AS plan_vigencia',\n   733→            'planes.precio AS plan_precio',\n   734→            'tipos_pruebas.id AS tipo_prueba_id',\n   735→            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n   736→            'estados_planes.id AS estado_plan_id',\n   737→            'estados_planes.nombre AS estado_plan_nombre',\n   738→            'users.id AS usuario_usuario_id',\n   739→            'users.nombres AS usuario_nombres',\n   740→            'users.apellidos AS usuario_apellidos',\n   741→            'empresas.id AS empresa_empresa_id',\n   742→            'empresas.empresa_id',\n   743→            'empresas.nombre_comercial AS empresa_nombre_comercial',\n   744→            'empresas.razon_social AS empresa_razon_social',\n   745→            'empresas.nombre_contacto',\n   746→            'empresas.celular_contacto',\n   747→            'empresas.email_contacto',\n   748→            'empresas.telefono_contacto',\n   749→            'empresas.extension_contacto',\n   750→            'empresas.nombre_tesorero',\n   751→            'empresas.celular_tesorero',\n   752→            'empresas.telefono_tesorero',\n   753→            'empresas.email_tesorero',\n   754→            DB::raw('\n   755→                (\n   756→                    SELECT COUNT(*)\n   757→                    FROM consumos\n   758→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n   759→                )\n   760→                AS conteo_consumos_agendas\n   761→            '),\n   762→            DB::raw('\n   763→                (\n   764→                    SELECT COUNT(*)\n   765→                    FROM consumos\n   766→                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n   767→                )\n   768→                AS conteo_consumos_ofertas_laborales\n   769→            '),\n   770→            DB::raw('\n   771→                (\n   772→                    SELECT COUNT(*)\n   773→                    FROM empresas\n   774→                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n   775→                )\n   776→                AS conteo_sucursales\n   777→            '),\n   778→            DB::raw('\n   779→                (\n   780→                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n   781→                    FROM empresas AS sucursales\n   782→                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n   783→                )\n   784→                AS nombres_comerciales_sucursales\n   785→            ')\n   786→        )\n   787→        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n   788→        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n   789→        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n   790→        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n   791→        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n   792→        ->whereNull('empresas.empresa_id')\n   793→        ->when(\n   794→            $request->filled('plan_por'),\n   795→            function ($consulta) use ($request) {\n   796→                switch ($request->plan_por) {\n   797→                    case 'por unidades':\n   798→                        $consulta->whereNotNull('empresas_planes.unidades');\n   799→                        break;\n   800→\n   801→                    case 'por ofertas laborales':\n   802→                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n   803→                        break;\n   804→\n   805→                    case 'por tiempo':\n   806→                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n   807→                        break;\n   808→                }\n   809→            }\n   810→        )\n   811→        ->when(\n   812→            $request->filled('tipo_prueba_id'),\n   813→            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n   814→            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n   815→                TipoPrueba::SELECCION_ID,\n   816→                TipoPrueba::ORGANIZACIONAL_ID,\n   817→                TipoPrueba::VOCACIONAL_ID\n   818→            ])\n   819→        )\n   820→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n   821→        ->when(\n   822→            $request->filled('ejecutivo_id'),\n   823→            function ($consulta) use ($request) {\n   824→                $consulta->whereExists(function ($subconsulta) use ($request) {\n   825→                    $subconsulta->select(DB::raw(1))\n   826→                        ->from('empresas_usuarios')\n   827→                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n   828→                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n   829→                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n   830→                });\n   831→            }\n   832→        )\n   833→        ->when(\n   834→            $request->filled('fecha_vencimiento'),\n   835→            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n   836→        )\n   837→        ->when(\n   838→            $request->filled('fecha_inicio'),\n   839→            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n   840→        )\n   841→        ->when(\n   842→            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n   843→            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n   844→        )\n   845→        ->get();\n   846→    }\n   847→\n   848→    /**\n   849→     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n   850→     *\n   851→     * @param int $empresa_id ID de la empresa.\n   852→     * @param Request $request Contenido de la peticion.\n   853→     * @return Collection\n   854→     * @author Sergio Vargas\n   855→     */\n   856→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   857→        return $this->modelo::select(\n   858→            'id',\n   859→            'empresa_id',\n   860→            'plan_credito_id',\n   861→            'estado_id',\n   862→            'creditos',\n   863→            'fecha_inicio',\n   864→            'fecha_vencimiento',\n   865→            'precio',\n   866→            'porcentaje_descuento',\n   867→            'numero_factura',\n   868→            'comentario',\n   869→            'created_at'\n   870→        )\n   871→        ->with([\n   872→            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n   873→            'estado:id,nombre',\n   874→            'archivos' => function ($archivos) {\n   875→                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n   876→                    ->orderBy('created_at', 'DESC');\n   877→            }\n   878→        ])\n   879→        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n   880→        ->where('empresa_id', $empresa_id)\n   881→        ->whereNotNull('plan_credito_id')\n   882→        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n   883→        ->when(\n   884→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   885→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   886→        )\n   887→        ->when(\n   888→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   889→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   890→        )\n   891→        ->when(\n   892→            $request->filled('fecha_vencimiento_desde'),\n   893→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   894→        )\n   895→        ->when(\n   896→            $request->filled('fecha_vencimiento_hasta'),\n   897→            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n   898→        )\n   899→        ->when(\n   900→            $request->filled('fecha_inicio_desde'),\n   901→            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n   902→        )\n   903→        ->when(\n   904→            $request->filled('fecha_inicio_hasta'),\n   905→            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n   906→        )\n   907→        ->orderBy('created_at', 'DESC')\n   908→        ->get();\n   909→    }\n   910→}\n   911→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e47d41f5-79ce-48ad-8c74-0db513ab705e","timestamp":"2026-01-22T19:00:43.046Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","content":"<?php\n\nnamespace App\\Http\\Repositories\\Empresas;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Repositories\\BaseRepository;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n\nclass EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n{\n    /**\n     * Ids de los roles de tipo empresa.\n     *\n     * @var array\n     * @author Fahibram Cárcamo\n     */\n    private const IDS_ROLES_TIPO_EMPRESA = [\n        RolRepository::ROL_PROPIETARIO_ID,\n        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n        RolRepository::ROL_EVALUADOR_ID\n    ];\n\n    private $consulta_conteo_total_usuarios_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(EmpresaPlan $modelo) {\n        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n            (\n                SELECT COUNT(DISTINCT eu.usuario_id)\n                FROM empresas_usuarios AS eu\n                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n            ) AS conteo_total_usuarios_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.agenda_id IS NOT NULL\n            ) AS conteo_total_consumos_agendas_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.oferta_laboral_id IS NOT NULL\n            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n        ';\n\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener todos los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getTodo(Request $request): Collection {\n        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n            'empresa:id,empresa_id,nombre_comercial,razon_social',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,predeterminado',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n            $query->with([\n                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with(['empresa' => function ($empresa) {\n                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n                        }])\n                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n                },\n                'consumos.agenda:id,prueba_id',\n                'consumos.agenda.prueba:id,nombre,slug'\n            ]);\n        })\n        ->when($con_conteo_consumos_agendas, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n        })\n        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n            $query->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n            });\n        })\n        ->when($request->filled('plan_id'), function ($query) use ($request) {\n            $query->where('plan_id', $request->plan_id);\n        })\n        ->when(\n            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n            function ($query) use ($request) {\n                $query->whereIn($request->campo, $request->valores);\n            }\n        )\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estado_id);\n        })\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($subconsulta) {\n                $subconsulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n            ])\n            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n            ->when(\n                $request->filled('tipo_prueba_id'),\n                function ($consulta) use ($request) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n                },\n                function ($consulta) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                        TipoPrueba::SELECCION_ID,\n                        TipoPrueba::ORGANIZACIONAL_ID,\n                        TipoPrueba::VOCACIONAL_ID\n                    ]));\n                }\n            )\n            ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($sub_consulta) {\n                $sub_consulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'funcionalidades:id,nombre,predeterminado',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n                'consumos' => function ($consumos) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with([\n                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n                            'agenda:id,prueba_id',\n                            'agenda.prueba:id,nombre,slug'\n                        ]);\n                }\n            ])\n            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            })\n            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n            })\n            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n                    $sub_consulta->where('empresa_id', $request->empresa_id)\n                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n                        });\n                });\n            })\n            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n            }, function ($consulta) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                    TipoPrueba::SELECCION_ID,\n                    TipoPrueba::ORGANIZACIONAL_ID,\n                    TipoPrueba::VOCACIONAL_ID\n                ]));\n            })\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener datos básicos de los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getDatosBasicos(Request $request): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre'\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n            $sentido = $request->ordenar_sentido ?? 'ASC';\n            $consulta->orderBy($request->ordenar_por, $sentido);\n        })\n        ->get();\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'funcionalidades:id,nombre,llave,valor',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->find($id);\n    }\n\n    /**\n     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n     *\n     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author José Manuel Jiménez\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])\n        ->first();\n    }\n\n    /**\n     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener el último plan asignado.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->where('estado_id', $request->estado_id);\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n    }\n\n    /**\n     * Sincronizar pruebas.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $pruebas ID's de las pruebas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n        $empresa_plan->pruebas()->sync($pruebas);\n    }\n\n    /**\n     * Sincronizar funcionalidades.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $funcionalidades ID's de las funcionalidades.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n        $empresa_plan->funcionalidades()->sync($funcionalidades);\n    }\n\n    /**\n     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return ?EmpresaPlan\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,llave,valor'\n        ])\n        ->when(\n            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            }\n        )\n        ->when(\n            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n            }\n        )\n        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n        ->first();\n    }\n\n    /**\n     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n     *\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author José Manuel Jiménez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function datosConsumosEmpresas(Request $request): Collection {\n        $roles_tipo_empresa_ids = [\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID\n        ];\n\n        $matriz_conteos = [\n            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n                'empresasUsuarios',\n                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n            )\n        ];\n\n        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw('\n                    (\n                        SELECT COUNT(DISTINCT eu.usuario_id)\n                        FROM empresas_usuarios AS eu\n                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n                    ) AS conteo_total_usuarios_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.agenda_id IS NOT NULL\n                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.oferta_laboral_id IS NOT NULL\n                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n                '),\n            ])\n            ->with([\n                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n                    $consulta_empresa->select($campos_empresas)\n                        ->whereNull('empresa_id')\n                        ->withCount([\n                            ...$matriz_conteos,\n                            'sucursales as conteo_sucursales'\n                        ])\n                        ->with([\n                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n                            }\n                        ]);\n                }\n            ])\n            ->when(\n                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n            )\n            ->whereNotIn('estado_id', [3, 8])\n            ->when(\n                $request->filled('prueba_id'),\n                fn($consulta) => $consulta->whereHas(\n                    'pruebas',\n                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n                )\n            )\n            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n            })\n            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta_plan_por->whereNotNull('unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n                        break;\n                }\n            })\n            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_vencimiento;\n                $fecha_fin    = $request->fecha_vencimiento;\n\n                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_inicio;\n                $fecha_fin    = $request->fecha_inicio;\n\n                if (strpos($request->fecha_inicio, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_inicio);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when(\n                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n            )\n            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n                if ($request->tipo_activacion === 'compra') {\n                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                } elseif ($request->tipo_activacion === 'recompra') {\n                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                }\n            })\n            ->get();\n    }\n\n    /**\n     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     */\n    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n        return $this->modelo::select(\n            'empresas_planes.id',\n            'empresas_planes.empresa_id',\n            'empresas_planes.plan_id',\n            'empresas_planes.plan_credito_id',\n            'empresas_planes.usuario_id',\n            'empresas_planes.estado_id',\n            'empresas_planes.unidades',\n            'empresas_planes.cantidad_ofertas_laborales',\n            'empresas_planes.cantidad_usuarios',\n            'empresas_planes.cantidad_pruebas',\n            'empresas_planes.creditos',\n            'empresas_planes.fecha_inicio',\n            'empresas_planes.fecha_vencimiento',\n            'empresas_planes.precio',\n            'empresas_planes.porcentaje_descuento',\n            'empresas_planes.numero_factura',\n            'empresas_planes.comentario',\n            'empresas_planes.plan_original',\n            'empresas_planes.renovando',\n            'empresas_planes.por_facturar',\n            'empresas_planes.created_at',\n            'planes.id',\n            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n            'planes.nombre AS plan_nombre',\n            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n            'planes.unidades AS plan_unidades',\n            'planes.vigencia AS plan_vigencia',\n            'planes.precio AS plan_precio',\n            'tipos_pruebas.id AS tipo_prueba_id',\n            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n            'estados_planes.id AS estado_plan_id',\n            'estados_planes.nombre AS estado_plan_nombre',\n            'users.id AS usuario_usuario_id',\n            'users.nombres AS usuario_nombres',\n            'users.apellidos AS usuario_apellidos',\n            'empresas.id AS empresa_empresa_id',\n            'empresas.empresa_id',\n            'empresas.nombre_comercial AS empresa_nombre_comercial',\n            'empresas.razon_social AS empresa_razon_social',\n            'empresas.nombre_contacto',\n            'empresas.celular_contacto',\n            'empresas.email_contacto',\n            'empresas.telefono_contacto',\n            'empresas.extension_contacto',\n            'empresas.nombre_tesorero',\n            'empresas.celular_tesorero',\n            'empresas.telefono_tesorero',\n            'empresas.email_tesorero',\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n                )\n                AS conteo_consumos_agendas\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n                )\n                AS conteo_consumos_ofertas_laborales\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM empresas\n                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n                )\n                AS conteo_sucursales\n            '),\n            DB::raw('\n                (\n                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n                    FROM empresas AS sucursales\n                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n                )\n                AS nombres_comerciales_sucursales\n            ')\n        )\n        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n        ->whereNull('empresas.empresa_id')\n        ->when(\n            $request->filled('plan_por'),\n            function ($consulta) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta->whereNotNull('empresas_planes.unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n                        break;\n                }\n            }\n        )\n        ->when(\n            $request->filled('tipo_prueba_id'),\n            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n                TipoPrueba::SELECCION_ID,\n                TipoPrueba::ORGANIZACIONAL_ID,\n                TipoPrueba::VOCACIONAL_ID\n            ])\n        )\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n        ->when(\n            $request->filled('ejecutivo_id'),\n            function ($consulta) use ($request) {\n                $consulta->whereExists(function ($subconsulta) use ($request) {\n                    $subconsulta->select(DB::raw(1))\n                        ->from('empresas_usuarios')\n                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n                });\n            }\n        )\n        ->when(\n            $request->filled('fecha_vencimiento'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n        )\n        ->when(\n            $request->filled('fecha_inicio'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n        )\n        ->when(\n            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n        )\n        ->get();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        return $this->modelo::select(\n            'id',\n            'empresa_id',\n            'plan_credito_id',\n            'estado_id',\n            'creditos',\n            'fecha_inicio',\n            'fecha_vencimiento',\n            'precio',\n            'porcentaje_descuento',\n            'numero_factura',\n            'comentario',\n            'created_at'\n        )\n        ->with([\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                    ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n}\n","numLines":911,"startLine":1,"totalLines":911}},"sourceToolAssistantUUID":"90c819e2-0189-485c-b0ef-50769c8fa863"}
{"parentUuid":"e47d41f5-79ce-48ad-8c74-0db513ab705e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Tjz7b2qKi6XoM28mcesa2Q","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Entiendo. El usuario quiere agregar en la función `getTodo` una opción similar a las existentes para obtener el conteo de consumos de créditos. Ya existe la relación `consumosCreditos()` en el modelo (línea 158).\n\nVeo que ya hay parámetros similares:\n- `con_conteo_consumos_agendas` \n- `con_conteo_consumos_ofertas_laborales`\n\nEl usuario quiere agregar `con_conteo_consumos_creditos` que use `withSum` o `withCount` con la relación `consumosCreditos`.\n\nMirando el método `historialComprasCreditos` en la línea 879, ya se usa:\n```php\n->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n```\n\nEsto es lo que necesita agregar en `getTodo`. Voy a agregar la lógica para el nuevo parámetro `con_conteo_consumos_creditos`.","signature":"EoMHCkYICxgCKkA99UvnP0gRpzqSpFQ6Io8T7NZhrqtb84AFVXB8r+prqGMC6K+LEok7tB/Gd8FxUIA1B7E2EeuSDt1YkosxMt7bEgwLa3PCkVfaGvRczJMaDC+CDB7V2eN0cW28QiIwD96D8ZtNu+dQXnsYYZCLYmd2SZdK/cRCNrPzjN2hSVOB88+JWhqZB6neecZQ7ev7KuoFUcoAWPRTZ2hNLkp+NyWT21sRJCSXxZSsvHHEsviKJL4SA0xO6pfHmqz6G8g+bOX13wYQNqriLNAc6hxJ4siExzmQlB1donCzwNqyqdGuEqy+UDI/7oqwRVk+BXtPPaxzDxATbonX+lt1kSrp/iaeDJLMcmOdMrAEhTJniLdJhHz4ACbmJCkVtiWjanIcPxkQhYV5oCSynPh+g203YlSGWDvDK4z5FmJVlUpmXc0hRmagg0tFmCn+IZtNToGTlUKq83mqXOsdl7C58XJ+up/eGaWJUMGAnH0SqFxdYP8G9WjaXZyVjFlwc0+C9f8gw8qZ1PzWra6BIGboO+il+AsA8WnlTJbSZqJ9EHi9v632WOrFaGzN9t0f+ahWr5TjAXjoKhzsVFVaCp1FNTStomPVmP2vJ5B2Nc7lgGRXK4W7OSOF8DbPOT9Ryjt4rFQlBT5FEdh3XoNRaG3IrhuigNy7nU/eIL9h6FAU/nmwm0u2qPm1O+dADikdki3bs95ZOT3+KNrPhrewvMx58tH6ijw4iyd/n/J8goQhUCbyE8RHOD5sCazNMBH2YoNQiTItaHmjHd1vxvwOEajfPjzaG8o5SF10oUXCvWPboX/0yhFiWzV01S6msWFRJky1K/1xUJDZ4gq7CAooJG2S1lAUDlpsHTh+hpbSIv6+/9p7P2orrJa2YMUaWbCIKcSF74rYf6I1qASPEVDBvjwyRH8g/GYUDhetoJZeAqsiIt8YarGo+6Xj3om1WoucMycHBok2LnqQGRlJ8pPJZfDdgUftJwzwNdE22aHPxWMftGK9KrCsAo2VXEVVnEd3zf8+rsykUgA7a8/W8+/wqbTTFSi92nRAM18Tuhr/e/xmDBtpMhr6YPUFYRkrRO9wO75wqvSK3myC+H8N/E/TcAWuKcloizneKgHf03IaRzcLo7N+6z/FOvWWncfesef+irtJ158U4TY11I0lIcTZLK4u0FbG0gFQ0fxNhRY5YUJoDUQYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2397,"cache_creation_input_tokens":16952,"cache_read_input_tokens":39570,"cache_creation":{"ephemeral_5m_input_tokens":16952,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw2e6geLGMQYXB6N8PF","type":"assistant","uuid":"bd36834a-51ce-44a4-ae21-33d82a7de192","timestamp":"2026-01-22T19:00:50.601Z"}
{"parentUuid":"bd36834a-51ce-44a4-ae21-33d82a7de192","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Tjz7b2qKi6XoM28mcesa2Q","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo. Quieres agregar un parámetro `con_conteo_consumos_creditos` que cuando sea `true` traiga el conteo/suma de los créditos consumidos usando la relación `consumosCreditos`. Veo que en `historialComprasCreditos` (línea 879) ya se usa `withSum('consumosCreditos as creditos_consumidos', 'creditos')`.\n\nVoy a agregar esa funcionalidad a `getTodo`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2397,"cache_creation_input_tokens":16952,"cache_read_input_tokens":39570,"cache_creation":{"ephemeral_5m_input_tokens":16952,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw2e6geLGMQYXB6N8PF","type":"assistant","uuid":"4c9c7520-8eb4-4e24-8160-3b5c9546d604","timestamp":"2026-01-22T19:00:52.348Z"}
{"parentUuid":"4c9c7520-8eb4-4e24-8160-3b5c9546d604","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Tjz7b2qKi6XoM28mcesa2Q","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AQE5NvTWPzGRJ7j7cYSKxC","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","old_string":"        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);","new_string":"        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2397,"cache_creation_input_tokens":16952,"cache_read_input_tokens":39570,"cache_creation":{"ephemeral_5m_input_tokens":16952,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw2e6geLGMQYXB6N8PF","type":"assistant","uuid":"8e8d226d-3ec6-46e6-bf44-8b155ca51f9c","timestamp":"2026-01-22T19:00:56.221Z"}
{"type":"file-history-snapshot","messageId":"8e8d226d-3ec6-46e6-bf44-8b155ca51f9c","snapshot":{"messageId":"86d69926-8660-4d97-92dc-5d932222971c","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v2","version":2,"backupTime":"2026-01-22T18:53:05.618Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v2","version":2,"backupTime":"2026-01-22T19:00:34.963Z"},"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"04cb3be0b984b422@v1","version":1,"backupTime":"2026-01-22T19:01:06.450Z"}},"timestamp":"2026-01-22T19:00:34.949Z"},"isSnapshotUpdate":true}
{"parentUuid":"8e8d226d-3ec6-46e6-bf44-8b155ca51f9c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AQE5NvTWPzGRJ7j7cYSKxC","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    93→        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n    94→            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    95→        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n    96→            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n    97→        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n    98→            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n    99→        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n   100→            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n   101→        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n   102→            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n   103→\n   104→        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n   105→        ->with([\n   106→            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',"}]},"uuid":"5301fecc-71af-43d1-9d71-04fe074e7f44","timestamp":"2026-01-22T19:01:06.510Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","oldString":"        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);","newString":"        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);","originalFile":"<?php\n\nnamespace App\\Http\\Repositories\\Empresas;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Repositories\\BaseRepository;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n\nclass EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n{\n    /**\n     * Ids de los roles de tipo empresa.\n     *\n     * @var array\n     * @author Fahibram Cárcamo\n     */\n    private const IDS_ROLES_TIPO_EMPRESA = [\n        RolRepository::ROL_PROPIETARIO_ID,\n        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n        RolRepository::ROL_EVALUADOR_ID\n    ];\n\n    private $consulta_conteo_total_usuarios_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(EmpresaPlan $modelo) {\n        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n            (\n                SELECT COUNT(DISTINCT eu.usuario_id)\n                FROM empresas_usuarios AS eu\n                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n            ) AS conteo_total_usuarios_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.agenda_id IS NOT NULL\n            ) AS conteo_total_consumos_agendas_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.oferta_laboral_id IS NOT NULL\n            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n        ';\n\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener todos los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getTodo(Request $request): Collection {\n        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n            'empresa:id,empresa_id,nombre_comercial,razon_social',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,predeterminado',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n            $query->with([\n                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with(['empresa' => function ($empresa) {\n                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n                        }])\n                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n                },\n                'consumos.agenda:id,prueba_id',\n                'consumos.agenda.prueba:id,nombre,slug'\n            ]);\n        })\n        ->when($con_conteo_consumos_agendas, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n        })\n        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n            $query->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n            });\n        })\n        ->when($request->filled('plan_id'), function ($query) use ($request) {\n            $query->where('plan_id', $request->plan_id);\n        })\n        ->when(\n            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n            function ($query) use ($request) {\n                $query->whereIn($request->campo, $request->valores);\n            }\n        )\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estado_id);\n        })\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($subconsulta) {\n                $subconsulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n            ])\n            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n            ->when(\n                $request->filled('tipo_prueba_id'),\n                function ($consulta) use ($request) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n                },\n                function ($consulta) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                        TipoPrueba::SELECCION_ID,\n                        TipoPrueba::ORGANIZACIONAL_ID,\n                        TipoPrueba::VOCACIONAL_ID\n                    ]));\n                }\n            )\n            ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($sub_consulta) {\n                $sub_consulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'funcionalidades:id,nombre,predeterminado',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n                'consumos' => function ($consumos) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with([\n                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n                            'agenda:id,prueba_id',\n                            'agenda.prueba:id,nombre,slug'\n                        ]);\n                }\n            ])\n            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            })\n            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n            })\n            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n                    $sub_consulta->where('empresa_id', $request->empresa_id)\n                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n                        });\n                });\n            })\n            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n            }, function ($consulta) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                    TipoPrueba::SELECCION_ID,\n                    TipoPrueba::ORGANIZACIONAL_ID,\n                    TipoPrueba::VOCACIONAL_ID\n                ]));\n            })\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener datos básicos de los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getDatosBasicos(Request $request): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre'\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n            $sentido = $request->ordenar_sentido ?? 'ASC';\n            $consulta->orderBy($request->ordenar_por, $sentido);\n        })\n        ->get();\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'funcionalidades:id,nombre,llave,valor',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->find($id);\n    }\n\n    /**\n     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n     *\n     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author José Manuel Jiménez\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])\n        ->first();\n    }\n\n    /**\n     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener el último plan asignado.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->where('estado_id', $request->estado_id);\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n    }\n\n    /**\n     * Sincronizar pruebas.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $pruebas ID's de las pruebas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n        $empresa_plan->pruebas()->sync($pruebas);\n    }\n\n    /**\n     * Sincronizar funcionalidades.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $funcionalidades ID's de las funcionalidades.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n        $empresa_plan->funcionalidades()->sync($funcionalidades);\n    }\n\n    /**\n     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return ?EmpresaPlan\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,llave,valor'\n        ])\n        ->when(\n            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            }\n        )\n        ->when(\n            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n            }\n        )\n        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n        ->first();\n    }\n\n    /**\n     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n     *\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author José Manuel Jiménez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function datosConsumosEmpresas(Request $request): Collection {\n        $roles_tipo_empresa_ids = [\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID\n        ];\n\n        $matriz_conteos = [\n            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n                'empresasUsuarios',\n                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n            )\n        ];\n\n        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw('\n                    (\n                        SELECT COUNT(DISTINCT eu.usuario_id)\n                        FROM empresas_usuarios AS eu\n                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n                    ) AS conteo_total_usuarios_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.agenda_id IS NOT NULL\n                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.oferta_laboral_id IS NOT NULL\n                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n                '),\n            ])\n            ->with([\n                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n                    $consulta_empresa->select($campos_empresas)\n                        ->whereNull('empresa_id')\n                        ->withCount([\n                            ...$matriz_conteos,\n                            'sucursales as conteo_sucursales'\n                        ])\n                        ->with([\n                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n                            }\n                        ]);\n                }\n            ])\n            ->when(\n                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n            )\n            ->whereNotIn('estado_id', [3, 8])\n            ->when(\n                $request->filled('prueba_id'),\n                fn($consulta) => $consulta->whereHas(\n                    'pruebas',\n                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n                )\n            )\n            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n            })\n            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta_plan_por->whereNotNull('unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n                        break;\n                }\n            })\n            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_vencimiento;\n                $fecha_fin    = $request->fecha_vencimiento;\n\n                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_inicio;\n                $fecha_fin    = $request->fecha_inicio;\n\n                if (strpos($request->fecha_inicio, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_inicio);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when(\n                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n            )\n            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n                if ($request->tipo_activacion === 'compra') {\n                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                } elseif ($request->tipo_activacion === 'recompra') {\n                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                }\n            })\n            ->get();\n    }\n\n    /**\n     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     */\n    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n        return $this->modelo::select(\n            'empresas_planes.id',\n            'empresas_planes.empresa_id',\n            'empresas_planes.plan_id',\n            'empresas_planes.plan_credito_id',\n            'empresas_planes.usuario_id',\n            'empresas_planes.estado_id',\n            'empresas_planes.unidades',\n            'empresas_planes.cantidad_ofertas_laborales',\n            'empresas_planes.cantidad_usuarios',\n            'empresas_planes.cantidad_pruebas',\n            'empresas_planes.creditos',\n            'empresas_planes.fecha_inicio',\n            'empresas_planes.fecha_vencimiento',\n            'empresas_planes.precio',\n            'empresas_planes.porcentaje_descuento',\n            'empresas_planes.numero_factura',\n            'empresas_planes.comentario',\n            'empresas_planes.plan_original',\n            'empresas_planes.renovando',\n            'empresas_planes.por_facturar',\n            'empresas_planes.created_at',\n            'planes.id',\n            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n            'planes.nombre AS plan_nombre',\n            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n            'planes.unidades AS plan_unidades',\n            'planes.vigencia AS plan_vigencia',\n            'planes.precio AS plan_precio',\n            'tipos_pruebas.id AS tipo_prueba_id',\n            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n            'estados_planes.id AS estado_plan_id',\n            'estados_planes.nombre AS estado_plan_nombre',\n            'users.id AS usuario_usuario_id',\n            'users.nombres AS usuario_nombres',\n            'users.apellidos AS usuario_apellidos',\n            'empresas.id AS empresa_empresa_id',\n            'empresas.empresa_id',\n            'empresas.nombre_comercial AS empresa_nombre_comercial',\n            'empresas.razon_social AS empresa_razon_social',\n            'empresas.nombre_contacto',\n            'empresas.celular_contacto',\n            'empresas.email_contacto',\n            'empresas.telefono_contacto',\n            'empresas.extension_contacto',\n            'empresas.nombre_tesorero',\n            'empresas.celular_tesorero',\n            'empresas.telefono_tesorero',\n            'empresas.email_tesorero',\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n                )\n                AS conteo_consumos_agendas\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n                )\n                AS conteo_consumos_ofertas_laborales\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM empresas\n                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n                )\n                AS conteo_sucursales\n            '),\n            DB::raw('\n                (\n                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n                    FROM empresas AS sucursales\n                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n                )\n                AS nombres_comerciales_sucursales\n            ')\n        )\n        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n        ->whereNull('empresas.empresa_id')\n        ->when(\n            $request->filled('plan_por'),\n            function ($consulta) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta->whereNotNull('empresas_planes.unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n                        break;\n                }\n            }\n        )\n        ->when(\n            $request->filled('tipo_prueba_id'),\n            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n                TipoPrueba::SELECCION_ID,\n                TipoPrueba::ORGANIZACIONAL_ID,\n                TipoPrueba::VOCACIONAL_ID\n            ])\n        )\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n        ->when(\n            $request->filled('ejecutivo_id'),\n            function ($consulta) use ($request) {\n                $consulta->whereExists(function ($subconsulta) use ($request) {\n                    $subconsulta->select(DB::raw(1))\n                        ->from('empresas_usuarios')\n                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n                });\n            }\n        )\n        ->when(\n            $request->filled('fecha_vencimiento'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n        )\n        ->when(\n            $request->filled('fecha_inicio'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n        )\n        ->when(\n            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n        )\n        ->get();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        return $this->modelo::select(\n            'id',\n            'empresa_id',\n            'plan_credito_id',\n            'estado_id',\n            'creditos',\n            'fecha_inicio',\n            'fecha_vencimiento',\n            'precio',\n            'porcentaje_descuento',\n            'numero_factura',\n            'comentario',\n            'created_at'\n        )\n        ->with([\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                    ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n}\n","structuredPatch":[{"oldStart":98,"oldLines":6,"newStart":98,"newLines":8,"lines":["             && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);","         $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')","             && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);","+        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')","+            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);"," ","         return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')","         ->with(["]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"8e8d226d-3ec6-46e6-bf44-8b155ca51f9c"}
{"parentUuid":"5301fecc-71af-43d1-9d71-04fe074e7f44","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FT61qmpg7v1y8W9wstcUdU","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito agregar el `when` para usar `withSum` cuando `con_conteo_consumos_creditos` sea true. Buscaré la sección donde están los otros `when` para conteos.","signature":"Es4CCkYICxgCKkDt0q36QkbFcrVMFNS6wj+gXrR6EPb2pt5u/tO7iYtcw65xT9AEKVFJ0QW+pXnmp5Iw0HHDXcSaBQWUi2Qf477rEgzS5Ts8hb6KekZMM2IaDJLnt7NSyzKVJChOlyIwne/du8e3R9TR7tkJTRDWW+0z9VdKWldHhP/ffCFKsCXjwJvIa09Z37wdIXy/TaTTKrUB0L7csYWv2JMI6+fz4PtLe5d1LfdTtsSbIcpSa+L8YT9CFsA+dDf/v1jMgNlEQvshM39u4oc3OKD4Pq/7X87E6/YJPyL+cp/4xkEoTHll5r2E88vY0II59JX8f5VqH1cR1h5yldA6PLrSBl+GLvO10qSjwxCr6OqjsxlMIZlxECFC609Sk092bOywSoDR1C6pccBXoSgtKYdiOY1bmPQUJcjop1NGcOXg3Vg3CbPl5BDJxoIXchgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3815,"cache_read_input_tokens":56522,"cache_creation":{"ephemeral_5m_input_tokens":3815,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw4VHQzJc4Kmwu9FvMm","type":"assistant","uuid":"b42b5b70-8dbb-4760-9311-6a359076ea22","timestamp":"2026-01-22T19:01:11.850Z"}
{"parentUuid":"b42b5b70-8dbb-4760-9311-6a359076ea22","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FT61qmpg7v1y8W9wstcUdU","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LQrbB2rEcXm5vNREqSfu7b","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","old_string":"        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })","new_string":"        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($con_conteo_consumos_creditos, function ($consulta) {\n            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n        })"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3815,"cache_read_input_tokens":56522,"cache_creation":{"ephemeral_5m_input_tokens":3815,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw4VHQzJc4Kmwu9FvMm","type":"assistant","uuid":"a2c2dfe8-805a-4b06-af68-32660c191c0d","timestamp":"2026-01-22T19:01:14.877Z"}
{"parentUuid":"a2c2dfe8-805a-4b06-af68-32660c191c0d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has been modified since read, either by the user or by a linter. Read it again before attempting to write it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_01LQrbB2rEcXm5vNREqSfu7b"}]},"uuid":"fbf17455-8e76-4b27-8f05-376893cd8542","timestamp":"2026-01-22T19:01:15.044Z","toolUseResult":"Error: File has been modified since read, either by the user or by a linter. Read it again before attempting to write it.","sourceToolAssistantUUID":"a2c2dfe8-805a-4b06-af68-32660c191c0d"}
{"parentUuid":"fbf17455-8e76-4b27-8f05-376893cd8542","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_015QXfbph5awMqCBpDRmbMTb","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Necesito leer el archivo nuevamente ya que fue modificado por el linter.","signature":"EvABCkYICxgCKkBZpG9cJTsKV6GDB7xseml1oCbXifc/zPcOxSYuVMWrzVdBw7QUCMCJpN1W4sVx/7ixI1VpA3Y+umZs9cQzl7kiEgzOrqaVZfo9Vy5xH+oaDB6YgkFMZw3gW/qEUCIw6zXZ8VgdgpcZcHN05bFuxhiOKd+cny/CYjECG6dJnPRpj2rmj4bYBehhTXD/uLU6Klj624PRXodcBO9XJ8GKt81Uy0NBMfE2AmElmd6wOJgCz5SJeE3MQBATBFUAWXxEPc9pzqw3penduir+LtaAGUvSv3Uv7YKUmKWnGaTrer1EKNGX8LI42MHgGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":917,"cache_read_input_tokens":60337,"cache_creation":{"ephemeral_5m_input_tokens":917,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw52Y7SKFMjFEZJUYXJ","type":"assistant","uuid":"fd26756d-32cd-451b-b2b7-420b629b2399","timestamp":"2026-01-22T19:01:18.169Z"}
{"parentUuid":"fd26756d-32cd-451b-b2b7-420b629b2399","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_015QXfbph5awMqCBpDRmbMTb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WVEP1QB2suwCDATL8htsjX","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","offset":125,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":917,"cache_read_input_tokens":60337,"cache_creation":{"ephemeral_5m_input_tokens":917,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw52Y7SKFMjFEZJUYXJ","type":"assistant","uuid":"0e19bf1c-2933-48b1-a538-e90ebfe4aef8","timestamp":"2026-01-22T19:01:18.908Z"}
{"parentUuid":"0e19bf1c-2933-48b1-a538-e90ebfe4aef8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WVEP1QB2suwCDATL8htsjX","type":"tool_result","content":"   125→                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n   126→                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n   127→                },\n   128→                'consumos.agenda:id,prueba_id',\n   129→                'consumos.agenda.prueba:id,nombre,slug'\n   130→            ]);\n   131→        })\n   132→        ->when($con_conteo_consumos_agendas, function ($consulta) {\n   133→            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   134→        })\n   135→        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n   136→            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   137→        })\n   138→        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n   139→            $query->where('empresa_id', $request->empresa_id);\n   140→        })\n   141→        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n   142→            $query->whereHas('plan', function ($plan) use ($request) {\n   143→                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n   144→            });\n   145→        })\n   146→        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n   147→            $query->whereHas('plan', function ($plan) use ($request) {\n   148→                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n   149→            });\n   150→        })\n   151→        ->when($request->filled('plan_id'), function ($query) use ($request) {\n   152→            $query->where('plan_id', $request->plan_id);\n   153→        })\n   154→        ->when(\n   155→            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n   156→            function ($query) use ($request) {\n   157→                $query->whereIn($request->campo, $request->valores);\n   158→            }\n   159→        )\n   160→        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n   161→            $consulta->whereIn('estado_id', $request->estado_id);\n   162→        })\n   163→        ->when(\n   164→            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n   165→            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n   166→        )\n   167→        ->when(\n   168→            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n   169→            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n   170→        )\n   171→        ->when(\n   172→            $request->filled('fecha_vencimiento_desde'),\n   173→            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n   174→        )\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"420f0049-3e1e-47cd-baf2-6aefcf171a5e","timestamp":"2026-01-22T19:01:20.874Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","content":"                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n                },\n                'consumos.agenda:id,prueba_id',\n                'consumos.agenda.prueba:id,nombre,slug'\n            ]);\n        })\n        ->when($con_conteo_consumos_agendas, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n        })\n        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n            $query->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n            });\n        })\n        ->when($request->filled('plan_id'), function ($query) use ($request) {\n            $query->where('plan_id', $request->plan_id);\n        })\n        ->when(\n            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n            function ($query) use ($request) {\n                $query->whereIn($request->campo, $request->valores);\n            }\n        )\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estado_id);\n        })\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )","numLines":50,"startLine":125,"totalLines":914}},"sourceToolAssistantUUID":"0e19bf1c-2933-48b1-a538-e90ebfe4aef8"}
{"parentUuid":"420f0049-3e1e-47cd-baf2-6aefcf171a5e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QYatdCKWgvpmd4DmorZGRk","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora puedo ver la estructura actual. Necesito agregar el `when` para `con_conteo_consumos_creditos` después de la línea 137 donde termina `con_conteo_consumos_ofertas_laborales`.","signature":"Et4CCkYICxgCKkCUZgZ0MaMHmwKRKKL97Wv5bWThTnqAiViNgTCqcBW7m5P/A1pvBz+Xth14brIGtmkOagsLP2kXPmp924PlW0ECEgzepygp0PmCqMFu3o4aDM0kD+SoCUaT2tRpaCIwJXIqymbT+BjWMwurVDOBT5k1ROZGUdMcCCDTAK3x99/ptUg3r4sPqNlmZi9/ly19KsUBKtNhNBN2aZEXT0lMIdWo5XXjB6bkVD/v35tROOir9IW9iS1Dw1K/uskoIcDatmdndyvTPtkIJEg7KN5d0xfVOt/x8cgEEsxTy8rVBIiuNY+zw+BapqEiIqvVEoxvq64oY+EsObNH9xBDVbDFfgaCcgFsMJjOVQu8xN4M5sPf0zY+OWN9N96ka1CXbb61Tl3dVooo04/n8WxEhHoM/3Fzy57TGiqLCRB0qijlIbqdpRsj5Sw8HoDtFMnJXxlQkzcrEvQIxTEYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1190,"cache_read_input_tokens":61254,"cache_creation":{"ephemeral_5m_input_tokens":1190,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw5Ro6ZDcqioQP2LLue","type":"assistant","uuid":"3e7e6083-a4d0-4c6e-b278-a948fdd4b395","timestamp":"2026-01-22T19:01:24.389Z"}
{"parentUuid":"3e7e6083-a4d0-4c6e-b278-a948fdd4b395","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QYatdCKWgvpmd4DmorZGRk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MFa5tBgyyoCXNSrNYQ2BwY","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","old_string":"        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {","new_string":"        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($con_conteo_consumos_creditos, function ($consulta) {\n            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1190,"cache_read_input_tokens":61254,"cache_creation":{"ephemeral_5m_input_tokens":1190,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw5Ro6ZDcqioQP2LLue","type":"assistant","uuid":"df9b11e8-c3ce-41ed-9fd5-1c75e408ca4f","timestamp":"2026-01-22T19:01:27.039Z"}
{"parentUuid":"df9b11e8-c3ce-41ed-9fd5-1c75e408ca4f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MFa5tBgyyoCXNSrNYQ2BwY","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   131→        })\n   132→        ->when($con_conteo_consumos_agendas, function ($consulta) {\n   133→            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n   134→        })\n   135→        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n   136→            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n   137→        })\n   138→        ->when($con_conteo_consumos_creditos, function ($consulta) {\n   139→            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n   140→        })\n   141→        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n   142→            $query->where('empresa_id', $request->empresa_id);\n   143→        })\n   144→        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n   145→            $query->whereHas('plan', function ($plan) use ($request) {"}]},"uuid":"a0be2708-d282-4b15-9a8d-2d00ca44ef70","timestamp":"2026-01-22T19:01:47.460Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php","oldString":"        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {","newString":"        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($con_conteo_consumos_creditos, function ($consulta) {\n            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {","originalFile":"<?php\n\nnamespace App\\Http\\Repositories\\Empresas;\n\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Http\\Repositories\\BaseRepository;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Interfaces\\Repositorios\\ObtenerUnoAvanzado;\n\nclass EmpresaPlanRepository extends BaseRepository implements ObtenerUnoAvanzado\n{\n    /**\n     * Ids de los roles de tipo empresa.\n     *\n     * @var array\n     * @author Fahibram Cárcamo\n     */\n    private const IDS_ROLES_TIPO_EMPRESA = [\n        RolRepository::ROL_PROPIETARIO_ID,\n        RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n        RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n        RolRepository::ROL_EVALUADOR_ID\n    ];\n\n    private $consulta_conteo_total_usuarios_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_agendas_empresa_sucursales;\n\n    private $consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlan $modelo Modelo de planes de empresas.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(EmpresaPlan $modelo) {\n        $this->consulta_conteo_total_usuarios_empresa_sucursales = '\n            (\n                SELECT COUNT(DISTINCT eu.usuario_id)\n                FROM empresas_usuarios AS eu\n                LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                AND eu.rol_id IN (' . implode(',', self::IDS_ROLES_TIPO_EMPRESA) . ')\n            ) AS conteo_total_usuarios_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_agendas_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.agenda_id IS NOT NULL\n            ) AS conteo_total_consumos_agendas_empresa_sucursales\n        ';\n\n        $this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales = '\n            (\n                SELECT COUNT(*)\n                FROM consumos\n                LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                WHERE (\n                    consumos.empresa_id = empresas_planes.empresa_id\n                    OR suc.empresa_id = empresas_planes.empresa_id\n                )\n                AND consumos.oferta_laboral_id IS NOT NULL\n            ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n        ';\n\n        parent::__construct($modelo);\n    }\n\n    /**\n     * Obtener todos los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     * \n     */\n    public function getTodo(Request $request): Collection {\n        $con_consumos_agendas = $request->filled('con_consumos_agendas')\n            && filter_var($request->con_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_consumos_ofertas_laborales = $request->filled('con_consumos_ofertas_laborales')\n            && filter_var($request->con_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_agendas = $request->filled('con_conteo_consumos_agendas')\n            && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_ofertas_laborales = $request->filled('con_conteo_consumos_ofertas_laborales')\n            && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN);\n        $con_conteo_consumos_creditos = $request->filled('con_conteo_consumos_creditos')\n            && filter_var($request->con_conteo_consumos_creditos, FILTER_VALIDATE_BOOLEAN);\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,cantidad_pruebas,cantidad_usuarios,cantidad_ofertas_laborales,unidades,vigencia,precio',\n            'empresa:id,empresa_id,nombre_comercial,razon_social',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,predeterminado',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($con_consumos_agendas || $con_consumos_ofertas_laborales, function ($query) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n            $query->with([\n                'consumos' => function ($consumos) use ($con_consumos_agendas, $con_consumos_ofertas_laborales) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with(['empresa' => function ($empresa) {\n                            $empresa->select('id', 'empresa_id', 'nombre_comercial', 'razon_social')->with('usuarios:id,nombres,apellidos');\n                        }])\n                        ->when($con_consumos_agendas, fn($consulta) => $consulta->whereNotNull('agenda_id'))\n                        ->when($con_consumos_ofertas_laborales, fn($consulta) => $consulta->orWhereNotNull('oferta_laboral_id'));\n                },\n                'consumos.agenda:id,prueba_id',\n                'consumos.agenda.prueba:id,nombre,slug'\n            ]);\n        })\n        ->when($con_conteo_consumos_agendas, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n        })\n        ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {\n            $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n        })\n        ->when($request->filled('empresa_id'), function ($query) use ($request) {\n            $query->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('nombre_plan'), function ($query) use ($request) {\n            $query->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('nombre', 'like', \"%{$request->nombre_plan}%\");\n            });\n        })\n        ->when($request->filled('plan_id'), function ($query) use ($request) {\n            $query->where('plan_id', $request->plan_id);\n        })\n        ->when(\n            $request->has('en') && filter_var($request->en, FILTER_VALIDATE_BOOLEAN) && $request->filled('campo') && $request->filled('valores'),\n            function ($query) use ($request) {\n                $query->whereIn($request->campo, $request->valores);\n            }\n        )\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estado_id);\n        })\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol Superadministrador.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaSuperadmin(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($subconsulta) {\n                $subconsulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1)\n            ])\n            ->when($request->filled('empresa_id'), fn($consulta) => $consulta->where('empresa_id', $request->empresa_id))\n            ->when(\n                $request->filled('tipo_prueba_id'),\n                function ($consulta) use ($request) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n                },\n                function ($consulta) {\n                    $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                        TipoPrueba::SELECCION_ID,\n                        TipoPrueba::ORGANIZACIONAL_ID,\n                        TipoPrueba::VOCACIONAL_ID\n                    ]));\n                }\n            )\n            ->get();\n    }\n\n    /**\n     * Obtener todas las suscripciones de planes que hayan sido recompradas para mostrarlas a un usuario con rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerRecomprasEmpresaParaRolTipoEmpresa(Request $request): Collection {\n        return $this->modelo->select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw($this->consulta_conteo_total_usuarios_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_agendas_empresa_sucursales),\n                DB::raw($this->consulta_conteo_total_consumos_ofertas_laborales_empresa_sucursales),\n            ])\n            ->whereExists(function ($sub_consulta) {\n                $sub_consulta->select(DB::raw(1))\n                    ->from('empresas_planes AS empresas_planes_subconsulta')\n                    ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                    ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                    ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n            })\n            ->with([\n                'estado:id,nombre',\n                'plan:id,tipo_prueba_id,nombre,vigencia',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'funcionalidades:id,nombre,predeterminado',\n                'archivos' => fn($consulta_factura) => $consulta_factura->where('nombre', 'factura')->limit(1),\n                'consumos' => function ($consumos) {\n                    $consumos->select('id', 'empresa_plan_id', 'empresa_id', 'agenda_id', 'oferta_laboral_id')\n                        ->with([\n                            'empresa:id,empresa_id,nombre_comercial,razon_social',\n                            'agenda:id,prueba_id',\n                            'agenda.prueba:id,nombre,slug'\n                        ]);\n                }\n            ])\n            ->when($request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            })\n            ->when($request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('vacante_id')]);\n            })\n            ->when($request->filled('empresa_id'), function ($consulta_empresa) use ($request) {\n                $consulta_empresa->where(function ($sub_consulta) use ($request) {\n                    $sub_consulta->where('empresa_id', $request->empresa_id)\n                        ->orWhereHas('empresa', function ($consulta_sucursal) use ($request) {\n                            $consulta_sucursal->where('empresa_id', $request->empresa_id);\n                        });\n                });\n            })\n            ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->where('tipo_prueba_id', $request->tipo_prueba_id));\n            }, function ($consulta) {\n                $consulta->whereHas('plan', fn($consulta_plan) => $consulta_plan->whereIn('tipo_prueba_id', [\n                    TipoPrueba::SELECCION_ID,\n                    TipoPrueba::ORGANIZACIONAL_ID,\n                    TipoPrueba::VOCACIONAL_ID\n                ]));\n            })\n            ->orderBy('created_at', 'DESC')\n            ->get();\n    }\n\n    /**\n     * Obtener datos básicos de los planes de empresas.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getDatosBasicos(Request $request): Collection {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre'\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id')\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('ordenar_por'), function ($consulta) use ($request) {\n            $sentido = $request->ordenar_sentido ?? 'ASC';\n            $consulta->orderBy($request->ordenar_por, $sentido);\n        })\n        ->get();\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'funcionalidades:id,nombre,llave,valor',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->find($id);\n    }\n\n    /**\n     * Obtener el plan activo de la empresa del mismo tipo de prueba.\n     *\n     * En este método no se validan los consumos ni las fechas de vigencia, ya que al momento de realizar los consumos, se desactiva el plan automáticamente.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author José Manuel Jiménez\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function planActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,created_at',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre,slug',\n            'usuario:id,nombres,apellidos',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withCount([\n            'consumos as consumos_agendas'           => fn($consumos) => $consumos->whereNotNull('agenda_id'),\n            'consumos as consumos_ofertas_laborales' => fn($consumos) => $consumos->whereNotNull('oferta_laboral_id'),\n            'consumos as consumos_vacantes'          => fn($consumos) => $consumos->whereNotNull('vacante_id')\n        ])\n        ->where('empresa_id', $empresa_id)\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->whereIn('estado_id', [1, 4])\n        ->first();\n    }\n\n    /**\n     * Obtener el próximo plan de la empresa del mismo tipo de prueba.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function planProximo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->where([\n            'empresa_id' => $empresa_id,\n            'estado_id'  => 3\n        ])\n        ->whereHas('plan', function ($plan) use ($tipo_prueba_id) {\n            $plan->where('tipo_prueba_id', $tipo_prueba_id);\n        })\n        ->first();\n    }\n\n    /**\n     * Obtener el último plan asignado.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan|null\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function ultimoPlanAsignado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre',\n            'plan.tipoPrueba:id,nombre',\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->when($request->filled('empresa_id'), function ($consulta) use ($request) {\n            $consulta->where('empresa_id', $request->empresa_id);\n        })\n        ->when($request->filled('estado_id'), function ($consulta) use ($request) {\n            $consulta->where('estado_id', $request->estado_id);\n        })\n        ->when($request->filled('estados_ids'), function ($consulta) use ($request) {\n            $consulta->whereIn('estado_id', $request->estados_ids);\n        })\n        ->when($request->filled('excluir_estado_proximo') && filter_var($request->excluir_estado_proximo, FILTER_VALIDATE_BOOLEAN), function ($consulta) {\n            $consulta->where('estado_id', '!=', 3);\n        })\n        ->when($request->filled('tipo_prueba_id'), function ($consulta) use ($request) {\n            $consulta->whereHas('plan', function ($plan) use ($request) {\n                $plan->where('tipo_prueba_id', $request->tipo_prueba_id);\n            });\n        })\n        ->orderBy('created_at', 'DESC')\n        ->first();\n    }\n\n    /**\n     * Sincronizar pruebas.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $pruebas ID's de las pruebas.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarPruebas(EmpresaPlan $empresa_plan, array $pruebas): void {\n        $empresa_plan->pruebas()->sync($pruebas);\n    }\n\n    /**\n     * Sincronizar funcionalidades.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de empresa.\n     * @param array $funcionalidades ID's de las funcionalidades.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function sincronizarFuncionalidades(EmpresaPlan $empresa_plan, array $funcionalidades): void {\n        $empresa_plan->funcionalidades()->sync($funcionalidades);\n    }\n\n    /**\n     * Obtener una instancia de la clase EmpresaPlan en base a filtros avanzados.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return ?EmpresaPlan\n     * @author Fahibram Cárcamo\n     * @author Jair Carvajal\n     */\n    public function getUnoAvanzado(Request $request): ?EmpresaPlan {\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'renovando', 'por_facturar', 'numero_factura', 'comentario', 'plan_original')\n        ->with([\n            'plan:id,tipo_prueba_id,nombre,vigencia,cantidad_usuarios',\n            'plan.tipoPrueba:id,nombre',\n            'estado:id,nombre',\n            'pruebas:id,nombre',\n            'funcionalidades:id,nombre,llave,valor'\n        ])\n        ->when(\n            $request->filled('con_conteo_consumos_agendas') && filter_var($request->con_conteo_consumos_agendas, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_agendas' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id')]);\n            }\n        )\n        ->when(\n            $request->filled('con_conteo_consumos_ofertas_laborales') && filter_var($request->con_conteo_consumos_ofertas_laborales, FILTER_VALIDATE_BOOLEAN),\n            function ($consulta) {\n                $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);\n            }\n        )\n        ->when($request->filled('id'), fn($consulta) => $consulta->where('id', $request->id))\n        ->first();\n    }\n\n    /**\n     * Obtener los registros de la tabla empresas_planes con sus datos de consumo de todas las empresas.\n     *\n     * @return Collection\n     * @author Fahibram Cárcamo\n     * @author Andres Gonzalez\n     * @author José Manuel Jiménez\n     * @author Jair Carvajal\n     * @author Daniel Beltrán\n     */\n    public function datosConsumosEmpresas(Request $request): Collection {\n        $roles_tipo_empresa_ids = [\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID\n        ];\n\n        $matriz_conteos = [\n            'consumos as conteo_consumos_agendas'           => fn($consulta_consumos) => $consulta_consumos->whereNotNull('agenda_id'),\n            'consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id'),\n            'usuarios as conteo_usuarios'                   => fn($consulta_usuarios) => $consulta_usuarios->whereHas(\n                'empresasUsuarios',\n                fn($consulta_empresas_usuarios) => $consulta_empresas_usuarios->whereIn('rol_id', $roles_tipo_empresa_ids)\n            )\n        ];\n\n        $campos_empresas = ['id', 'empresa_id', 'nombre_comercial', 'razon_social', 'nombre_contacto', 'celular_contacto', 'email_contacto', 'telefono_contacto', 'extension_contacto', 'nombre_tesorero', 'celular_tesorero', 'telefono_tesorero', 'email_tesorero'];\n\n        return $this->modelo::select('id', 'empresa_id', 'plan_id', 'plan_credito_id', 'usuario_id', 'estado_id', 'unidades', 'cantidad_ofertas_laborales', 'cantidad_usuarios', 'cantidad_pruebas', 'creditos', 'fecha_inicio', 'fecha_vencimiento', 'precio', 'porcentaje_descuento', 'numero_factura', 'comentario', 'plan_original', 'renovando', 'por_facturar', 'created_at')\n            ->addSelect([\n                DB::raw('\n                    (\n                        SELECT COUNT(DISTINCT eu.usuario_id)\n                        FROM empresas_usuarios AS eu\n                        LEFT JOIN empresas AS suc ON eu.empresa_id = suc.id\n                        WHERE (eu.empresa_id = empresas_planes.empresa_id OR suc.empresa_id = empresas_planes.empresa_id)\n                        AND eu.rol_id IN (' . implode(',', $roles_tipo_empresa_ids) . ')\n                    ) AS conteo_total_usuarios_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.agenda_id IS NOT NULL\n                    ) AS conteo_total_consumos_agendas_empresa_sucursales\n                '),\n                DB::raw('\n                    (\n                        SELECT COUNT(*)\n                        FROM consumos\n                        LEFT JOIN empresas AS suc ON consumos.empresa_id = suc.id\n                        WHERE (\n                            consumos.empresa_id = empresas_planes.empresa_id\n                            OR suc.empresa_id = empresas_planes.empresa_id\n                        )\n                        AND consumos.oferta_laboral_id IS NOT NULL\n                    ) AS conteo_total_consumos_ofertas_laborales_empresa_sucursales\n                '),\n            ])\n            ->with([\n                'plan:id,tipo_prueba_id,nombre,unidades,cantidad_ofertas_laborales,vigencia,precio',\n                'plan.tipoPrueba:id,nombre',\n                'pruebas:id,nombre,slug',\n                'estado:id,nombre',\n                'usuario:id,nombres,apellidos',\n                'empresa' => function ($consulta_empresa) use ($matriz_conteos, $campos_empresas) {\n                    $consulta_empresa->select($campos_empresas)\n                        ->whereNull('empresa_id')\n                        ->withCount([\n                            ...$matriz_conteos,\n                            'sucursales as conteo_sucursales'\n                        ])\n                        ->with([\n                            'sucursales' => function ($consulta_sucursal) use ($matriz_conteos, $campos_empresas) {\n                                $consulta_sucursal->select($campos_empresas)->withCount($matriz_conteos);\n                            }\n                        ]);\n                }\n            ])\n            ->when(\n                $request->filled('estado_id') && !in_array($request->estado_id, [3, 8]),\n                fn($consulta_estado) => $consulta_estado->where('estado_id', $request->estado_id)\n            )\n            ->whereNotIn('estado_id', [3, 8])\n            ->when(\n                $request->filled('prueba_id'),\n                fn($consulta) => $consulta->whereHas(\n                    'pruebas',\n                    fn($consulta_prueba) => $consulta_prueba->where('pruebas.id', $request->prueba_id)\n                )\n            )\n            ->when($request->filled('ejecutivo_id'), function ($consulta) use ($request) {\n                $consulta->whereHas('empresa', fn($empresa) => $empresa->where('ejecutivo_id', $request->ejecutivo_id));\n            })\n            ->when($request->filled('plan_por'), function ($consulta_plan_por) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta_plan_por->whereNotNull('unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta_plan_por->whereNotNull('cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta_plan_por->whereNotNull('fecha_inicio')->whereNotNull('fecha_vencimiento');\n                        break;\n                }\n            })\n            ->when($request->filled('fecha_vencimiento'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_vencimiento;\n                $fecha_fin    = $request->fecha_vencimiento;\n\n                if (strpos($request->fecha_vencimiento, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_vencimiento);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_vencimiento)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when($request->filled('fecha_inicio'), function ($consulta, $buscar) use ($request) {\n                $fecha_inicio = $request->fecha_inicio;\n                $fecha_fin    = $request->fecha_inicio;\n\n                if (strpos($request->fecha_inicio, ' a ') !== false) {\n                    $fechas       = explode(' a ', $request->fecha_inicio);\n                    $fecha_inicio = $fechas[0];\n                    $fecha_fin    = $fechas[1];\n                }\n\n                $consulta->whereBetween(DB::raw('DATE(fecha_inicio)'), [$fecha_inicio, $fecha_fin]);\n            })\n            ->when(\n                $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n                fn($consulta_empresas_planes) => $consulta_empresas_planes->whereIn('id', $request->empresas_planes_ids)\n            )\n            ->when($request->filled('tipo_activacion'), function ($consulta_tipo_activacion) use ($request) {\n                if ($request->tipo_activacion === 'compra') {\n                    $consulta_tipo_activacion->whereNotExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                } elseif ($request->tipo_activacion === 'recompra') {\n                    $consulta_tipo_activacion->whereExists(function ($subconsulta) {\n                        $subconsulta->select(DB::raw(1))\n                            ->from('empresas_planes AS empresas_planes_subconsulta')\n                            ->whereColumn('empresas_planes_subconsulta.plan_id', 'empresas_planes.plan_id')\n                            ->whereColumn('empresas_planes_subconsulta.empresa_id', 'empresas_planes.empresa_id')\n                            ->whereColumn('empresas_planes_subconsulta.id', '<>', 'empresas_planes.id');\n                    });\n                }\n            })\n            ->get();\n    }\n\n    /**\n     * Retornar una colección que contiene los datos de las suscripciones de planes de las empresas principales junto con un conteo de sus consumos.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Fahibram Cárcamo\n     */\n    public function obtenerConsumosEmpresasPlanes(Request $request): Collection {\n        return $this->modelo::select(\n            'empresas_planes.id',\n            'empresas_planes.empresa_id',\n            'empresas_planes.plan_id',\n            'empresas_planes.plan_credito_id',\n            'empresas_planes.usuario_id',\n            'empresas_planes.estado_id',\n            'empresas_planes.unidades',\n            'empresas_planes.cantidad_ofertas_laborales',\n            'empresas_planes.cantidad_usuarios',\n            'empresas_planes.cantidad_pruebas',\n            'empresas_planes.creditos',\n            'empresas_planes.fecha_inicio',\n            'empresas_planes.fecha_vencimiento',\n            'empresas_planes.precio',\n            'empresas_planes.porcentaje_descuento',\n            'empresas_planes.numero_factura',\n            'empresas_planes.comentario',\n            'empresas_planes.plan_original',\n            'empresas_planes.renovando',\n            'empresas_planes.por_facturar',\n            'empresas_planes.created_at',\n            'planes.id',\n            'planes.tipo_prueba_id AS plan_tipo_prueba_id',\n            'planes.nombre AS plan_nombre',\n            'planes.cantidad_pruebas AS plan_cantidad_pruebas',\n            'planes.cantidad_usuarios AS plan_cantidad_usuarios',\n            'planes.cantidad_ofertas_laborales AS plan_cantidad_ofertas_laborales',\n            'planes.unidades AS plan_unidades',\n            'planes.vigencia AS plan_vigencia',\n            'planes.precio AS plan_precio',\n            'tipos_pruebas.id AS tipo_prueba_id',\n            'tipos_pruebas.nombre AS tipo_prueba_nombre',\n            'estados_planes.id AS estado_plan_id',\n            'estados_planes.nombre AS estado_plan_nombre',\n            'users.id AS usuario_usuario_id',\n            'users.nombres AS usuario_nombres',\n            'users.apellidos AS usuario_apellidos',\n            'empresas.id AS empresa_empresa_id',\n            'empresas.empresa_id',\n            'empresas.nombre_comercial AS empresa_nombre_comercial',\n            'empresas.razon_social AS empresa_razon_social',\n            'empresas.nombre_contacto',\n            'empresas.celular_contacto',\n            'empresas.email_contacto',\n            'empresas.telefono_contacto',\n            'empresas.extension_contacto',\n            'empresas.nombre_tesorero',\n            'empresas.celular_tesorero',\n            'empresas.telefono_tesorero',\n            'empresas.email_tesorero',\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.agenda_id IS NOT NULL\n                )\n                AS conteo_consumos_agendas\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM consumos\n                    WHERE consumos.empresa_plan_id = empresas_planes.id AND consumos.oferta_laboral_id IS NOT NULL\n                )\n                AS conteo_consumos_ofertas_laborales\n            '),\n            DB::raw('\n                (\n                    SELECT COUNT(*)\n                    FROM empresas\n                    WHERE empresas.empresa_id = empresas_planes.empresa_id\n                )\n                AS conteo_sucursales\n            '),\n            DB::raw('\n                (\n                    SELECT CONCAT(COALESCE(GROUP_CONCAT(DISTINCT sucursales.nombre_comercial SEPARATOR \",\"), \"\"))\n                    FROM empresas AS sucursales\n                    WHERE sucursales.empresa_id = empresas_planes.empresa_id\n                )\n                AS nombres_comerciales_sucursales\n            ')\n        )\n        ->leftJoin('planes', 'empresas_planes.plan_id', '=', 'planes.id')\n        ->leftJoin('tipos_pruebas', 'planes.tipo_prueba_id', '=', 'tipos_pruebas.id')\n        ->leftJoin('estados_planes', 'empresas_planes.estado_id', '=', 'estados_planes.id')\n        ->leftJoin('users', 'empresas_planes.usuario_id', '=', 'users.id')\n        ->leftJoin('empresas', 'empresas_planes.empresa_id', '=', 'empresas.id')\n        ->whereNull('empresas.empresa_id')\n        ->when(\n            $request->filled('plan_por'),\n            function ($consulta) use ($request) {\n                switch ($request->plan_por) {\n                    case 'por unidades':\n                        $consulta->whereNotNull('empresas_planes.unidades');\n                        break;\n\n                    case 'por ofertas laborales':\n                        $consulta->whereNotNull('empresas_planes.cantidad_ofertas_laborales');\n                        break;\n\n                    case 'por tiempo':\n                        $consulta->whereNotNull('empresas_planes.fecha_inicio')->whereNotNull('empresas_planes.fecha_vencimiento');\n                        break;\n                }\n            }\n        )\n        ->when(\n            $request->filled('tipo_prueba_id'),\n            fn($consulta) => $consulta->where('planes.tipo_prueba_id', $request->tipo_prueba_id),\n            fn($consulta) => $consulta->whereIn('planes.tipo_prueba_id', [\n                TipoPrueba::SELECCION_ID,\n                TipoPrueba::ORGANIZACIONAL_ID,\n                TipoPrueba::VOCACIONAL_ID\n            ])\n        )\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('empresas_planes.estado_id', $request->estado_id))\n        ->when(\n            $request->filled('ejecutivo_id'),\n            function ($consulta) use ($request) {\n                $consulta->whereExists(function ($subconsulta) use ($request) {\n                    $subconsulta->select(DB::raw(1))\n                        ->from('empresas_usuarios')\n                        ->whereColumn('empresas_usuarios.empresa_id', 'empresas_planes.empresa_id')\n                        ->where('empresas_usuarios.usuario_id', $request->ejecutivo_id)\n                        ->where('empresas_usuarios.rol_id', RolRepository::ROL_EJECUTIVO_CUENTA_ID);\n                });\n            }\n        )\n        ->when(\n            $request->filled('fecha_vencimiento'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_vencimiento', '<=', $request->fecha_vencimiento)\n        )\n        ->when(\n            $request->filled('fecha_inicio'),\n            fn($consulta) => $consulta->where('empresas_planes.fecha_inicio', '>=', $request->fecha_inicio)\n        )\n        ->when(\n            $request->has('empresas_planes_ids') && is_array($request->empresas_planes_ids) && count($request->empresas_planes_ids) > 0,\n            fn($consulta) => $consulta->whereIn('id', $request->empresas_planes_ids)\n        )\n        ->get();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con cr鑠ditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        return $this->modelo::select(\n            'id',\n            'empresa_id',\n            'plan_credito_id',\n            'estado_id',\n            'creditos',\n            'fecha_inicio',\n            'fecha_vencimiento',\n            'precio',\n            'porcentaje_descuento',\n            'numero_factura',\n            'comentario',\n            'created_at'\n        )\n        ->with([\n            'planCredito:id,nombre,creditos,precio,porcentaje_descuento,fecha_inicio_promocion,fecha_fin_promocion',\n            'estado:id,nombre',\n            'archivos' => function ($archivos) {\n                $archivos->select('id', 'modelo', 'modelo_id', 'nombre', 'ruta', 'created_at')\n                    ->orderBy('created_at', 'DESC');\n            }\n        ])\n        ->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n        ->where('empresa_id', $empresa_id)\n        ->whereNotNull('plan_credito_id')\n        ->when($request->filled('estado_id'), fn($consulta) => $consulta->where('estado_id', $request->estado_id))\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'con_tiempo',\n            fn($consulta) => $consulta->whereNotNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('duracion') && $request->duracion === 'sin_tiempo',\n            fn($consulta) => $consulta->whereNull('fecha_vencimiento')\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_desde'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '>=', $request->fecha_vencimiento_desde)\n        )\n        ->when(\n            $request->filled('fecha_vencimiento_hasta'),\n            fn($consulta) => $consulta->where('fecha_vencimiento', '<=', $request->fecha_vencimiento_hasta)\n        )\n        ->when(\n            $request->filled('fecha_inicio_desde'),\n            fn($consulta) => $consulta->where('fecha_inicio', '>=', $request->fecha_inicio_desde)\n        )\n        ->when(\n            $request->filled('fecha_inicio_hasta'),\n            fn($consulta) => $consulta->where('fecha_inicio', '<=', $request->fecha_inicio_hasta)\n        )\n        ->orderBy('created_at', 'DESC')\n        ->get();\n    }\n}\n","structuredPatch":[{"oldStart":135,"oldLines":6,"newStart":135,"newLines":9,"lines":["         ->when($con_conteo_consumos_ofertas_laborales, function ($consulta) {","             $consulta->withCount(['consumos as conteo_consumos_ofertas_laborales' => fn($consulta_consumos) => $consulta_consumos->whereNotNull('oferta_laboral_id')]);","         })","+        ->when($con_conteo_consumos_creditos, function ($consulta) {","+            $consulta->withSum('consumosCreditos as creditos_consumidos', 'creditos');","+        })","         ->when($request->filled('empresa_id'), function ($query) use ($request) {","             $query->where('empresa_id', $request->empresa_id);","         })"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"df9b11e8-c3ce-41ed-9fd5-1c75e408ca4f"}
{"parentUuid":"a0be2708-d282-4b15-9a8d-2d00ca44ef70","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_014HPnkortAADQFLC7gFDydC","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Listo. Ahora la función `getTodo` tiene la capacidad de traer el conteo de consumos de créditos cuando se pasa el parámetro `con_conteo_consumos_creditos` en `true`. El resultado vendrá como `creditos_consumidos` en cada registro.","signature":"EpMDCkYICxgCKkCe4Vf0j30Ekxdg9692bExBpVmTiCdDaGxo5NE/PJaceigJtrX5G2Ji8CIFKGKIlEUQZ0OZB0JQ2w3AD2jRYFuqEgzrMjscslFntJV9iy0aDMkvRisH8zY0vMn0TSIwAvXESWw2xOQ1oE3xIE6rO/WMhDmRX6fpNlWIvSOZ4y7dVYihH1hLDVKpcpzCdnR3KvoB4XfDkCrv44zyP8rVUG17jhs2SDICvAgcfcaup2r2xRHVXOgIOhLyrlWwdY9IG68MlAC/4Itdj6RcRpJ107HsyF6gThcFUSitiET4ukxBpP7WSkWJ6LvURFCmfdOLrV/5ACUURy8IYCo8Uq/G75CLcRMbnqe470NvFNt3OcVOyRl+fZkDSV3sUz8WpNln8kdRU/bP+iJ/pXF7I8ONcm6Y68KIm5izr3sGrULBxtYJJvP7QTkgL5A3Jygo4g2GWMr5M/LMYRfAfiLvyNhOoDxfNiTQisu4smiLnVBSlCBb0lJP0jtNt6Hf1IZbHYVFMs/aminhPDAVinjPVxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":986,"cache_read_input_tokens":62444,"cache_creation":{"ephemeral_5m_input_tokens":986,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw7WcNQCBdehbvsUYtM","type":"assistant","uuid":"e04a9a0a-3750-45fd-b4c0-8d3b7f035e8a","timestamp":"2026-01-22T19:01:52.990Z"}
{"parentUuid":"e04a9a0a-3750-45fd-b4c0-8d3b7f035e8a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_014HPnkortAADQFLC7gFDydC","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Ahora la función `getTodo` acepta el parámetro `con_conteo_consumos_creditos`. Cuando sea `true`, traerá la suma de los créditos consumidos como `creditos_consumidos` usando la relación `consumosCreditos` del modelo.\n\n**Resumen de cambios en** [EmpresaPlanRepository.php](app/Http/Repositories/Empresas/EmpresaPlanRepository.php):\n\n1. **Línea 101-102**: Agregué la variable `$con_conteo_consumos_creditos`\n2. **Línea 138-140**: Agregué el `when` que usa `withSum('consumosCreditos as creditos_consumidos', 'creditos')`\n\n**Uso:**\n```php\n// En el request pasar:\ncon_conteo_consumos_creditos: true\n\n// El resultado tendrá:\n$empresa_plan->creditos_consumidos // suma de los créditos consumidos\n```"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":986,"cache_read_input_tokens":62444,"cache_creation":{"ephemeral_5m_input_tokens":986,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXNw7WcNQCBdehbvsUYtM","type":"assistant","uuid":"7501bf5c-e5c8-4aa7-92d6-877f26bb621d","timestamp":"2026-01-22T19:01:56.474Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T19:02:13.167Z","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb"}
{"type":"file-history-snapshot","messageId":"0511420f-3797-4576-b9bb-d35801da550c","snapshot":{"messageId":"0511420f-3797-4576-b9bb-d35801da550c","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v2","version":2,"backupTime":"2026-01-22T18:53:05.618Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v2","version":2,"backupTime":"2026-01-22T19:00:34.963Z"},"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"04cb3be0b984b422@v2","version":2,"backupTime":"2026-01-22T19:02:14.825Z"}},"timestamp":"2026-01-22T19:02:14.810Z"},"isSnapshotUpdate":false}
{"parentUuid":"b9ea9089-5fec-41a0-9e60-20d607dbcae6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01KbBLiXvMLxP5E4DUw4Z4TG","parentToolUseID":"toolu_01KbBLiXvMLxP5E4DUw4Z4TG","uuid":"c185e9e0-b872-4940-a02d-ef840b0b40ad","timestamp":"2026-01-22T19:00:40.587Z"}
{"parentUuid":"c185e9e0-b872-4940-a02d-ef840b0b40ad","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01BdQb5vRHWDp7Pc1PX6wt1L","parentToolUseID":"toolu_01BdQb5vRHWDp7Pc1PX6wt1L","uuid":"1a98b7ac-33eb-443c-b7c1-6ff677019448","timestamp":"2026-01-22T19:00:40.587Z"}
{"parentUuid":"8e8d226d-3ec6-46e6-bf44-8b155ca51f9c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01AQE5NvTWPzGRJ7j7cYSKxC","parentToolUseID":"toolu_01AQE5NvTWPzGRJ7j7cYSKxC","uuid":"dcfb4b60-241e-4d97-8a69-18172968b83f","timestamp":"2026-01-22T19:00:56.377Z"}
{"parentUuid":"dcfb4b60-241e-4d97-8a69-18172968b83f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01AQE5NvTWPzGRJ7j7cYSKxC","parentToolUseID":"toolu_01AQE5NvTWPzGRJ7j7cYSKxC","uuid":"fcb29e43-b344-44fe-91d9-bbff4dfb521a","timestamp":"2026-01-22T19:00:56.378Z"}
{"parentUuid":"5301fecc-71af-43d1-9d71-04fe074e7f44","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01AQE5NvTWPzGRJ7j7cYSKxC","toolUseID":"toolu_01AQE5NvTWPzGRJ7j7cYSKxC","timestamp":"2026-01-22T19:01:06.512Z","uuid":"2ed4e4db-1c18-4925-9ccf-de490e528d65"}
{"parentUuid":"0e19bf1c-2933-48b1-a538-e90ebfe4aef8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01WVEP1QB2suwCDATL8htsjX","parentToolUseID":"toolu_01WVEP1QB2suwCDATL8htsjX","uuid":"7ad2ce13-9409-4bdc-83fe-56f2417e8884","timestamp":"2026-01-22T19:01:19.090Z"}
{"parentUuid":"df9b11e8-c3ce-41ed-9fd5-1c75e408ca4f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01MFa5tBgyyoCXNSrNYQ2BwY","parentToolUseID":"toolu_01MFa5tBgyyoCXNSrNYQ2BwY","uuid":"1219be7d-74a3-44f9-af6e-203226e7d7ae","timestamp":"2026-01-22T19:01:27.217Z"}
{"parentUuid":"1219be7d-74a3-44f9-af6e-203226e7d7ae","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01MFa5tBgyyoCXNSrNYQ2BwY","parentToolUseID":"toolu_01MFa5tBgyyoCXNSrNYQ2BwY","uuid":"e5386804-9dbb-442c-ad24-144d4f76b0c8","timestamp":"2026-01-22T19:01:27.217Z"}
{"parentUuid":"a0be2708-d282-4b15-9a8d-2d00ca44ef70","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01MFa5tBgyyoCXNSrNYQ2BwY","toolUseID":"toolu_01MFa5tBgyyoCXNSrNYQ2BwY","timestamp":"2026-01-22T19:01:47.461Z","uuid":"9f81dedf-824a-4c4d-a73a-cc1cf8eba1dd"}
{"parentUuid":"7501bf5c-e5c8-4aa7-92d6-877f26bb621d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 139 to 139 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php:\n, 'creditos'\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"´por que le colocas esto , 'creditos'?"}]},"uuid":"0511420f-3797-4576-b9bb-d35801da550c","timestamp":"2026-01-22T19:02:14.807Z","permissionMode":"default"}
{"parentUuid":"0511420f-3797-4576-b9bb-d35801da550c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YBkcs8VQYybni2qpUBVj9g","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario pregunta por qué coloqué `'creditos'` como segundo parámetro en `withSum`.\n\nLa función `withSum` de Laravel tiene la siguiente firma:\n```php\nwithSum(string|array $relation, string $column)\n```\n\n- Primer parámetro: la relación y el alias (`'consumosCreditos as creditos_consumidos'`)\n- Segundo parámetro: la columna que se va a sumar (`'creditos'`)\n\nEsto significa que va a sumar el campo `creditos` de la tabla relacionada `consumos_creditos`. Sin este segundo parámetro, Laravel no sabría qué columna sumar.\n\nDéjame verificar el modelo ConsumoCredito para confirmar que tiene un campo `creditos`.","signature":"Eo4GCkYICxgCKkAJ+s7Es1b1fIyQ4jS1aD7AFUY8tTxZDLXq4MPhFsB02wsMDs8/HPV5aRTvD6AnVUGmLh/Vw5kZLRNkPoC7nkTQEgyc8x0tk17gk7ltz/0aDGKktnzqbkvW+ARBViIw62lyOCL0F+K3TYAu/NoVp1/oprRil1kIXEFqUWjtw1gOpEFskX9nwb6qL0Md9YdDKvUEx5IpPrPbG2WQlwFd2EPWkg4STGDcFly8kTkh+YP/wFxa0q4fgyf0+l2uCgFkL7rBphfaM7E+mjSgjmtOlUe7DZPuWgzORGUWzPJp+QeBNE/AlauRpYuB6gJ/oR2FOSLYKvO1B9OSq3igVDEYMJZ/N+DiFmM8K+aUDKs+y/m6VBJDWTFGNpq+xKkbXLDIbd3FG+eI9NV75dpNwFGg1h2dznPawBsmOIZqk57zYretOGjNmfnCf/Ho3hI8GCQVec84cVYUMQrB5dQTLb155wOFGTXnjpXoQvrzedrI9KQxjsMzA52fAoHyOFjqT2ZGZOcskSsVAhBI3mAxhtBW4yEdci9qlysxom+jUQdH4/QNNzD1ufpZnoCgw+LKtKTggWafMI0uRTN96z3kRmvT7N6VZrD8vigPEch27ccrM/RBafcOk328Nv162HVIP6pSJ8fekl/5SCuR/6Kjs//hJ0Sw6OPT0A29rI6g6MZtLgoPr1dqcTUtrMjUNVe5iFToaVTA/E3biCqn06lzj5DKCUm50YPrKrrxhHkQGs3b0NtAqAG/vcrzFUO342lFJDaSscV2VI0EZyafwSbudZyRoub9/YTrZGj5QIoCGudL7nv2u7NeWNw8wt8xY/GdRRB0oiOVQSebIhNcF/x3ong5QBpKMgC2xHpMKFwMuuagNG2+O6tTKAx8qrIDRe9iKRZMRMwIfv0LVjaW+2e9xX2dsgiVDcP3vny+EJAlxW/IFuqsM1iJnMPwNfCZxPfby4Q8rrKGjXXPXywOqvArZCyWOVZ+ugpNe5E+k7fNXO8fRD1gX59bTWDwxdkfHV6HzUpSV0cqTM/0z+AYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2368,"cache_read_input_tokens":63430,"cache_creation":{"ephemeral_5m_input_tokens":2368,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNw9Qiie1GRaFSQMGZmt","type":"assistant","uuid":"7ff39bef-2cbb-46be-a59d-ed25cce3fae5","timestamp":"2026-01-22T19:02:20.755Z"}
{"parentUuid":"7ff39bef-2cbb-46be-a59d-ed25cce3fae5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YBkcs8VQYybni2qpUBVj9g","type":"message","role":"assistant","content":[{"type":"text","text":"El segundo parámetro `'creditos'` en `withSum` indica **qué columna sumar** de la tabla relacionada.\n\n```php\n->withSum('consumosCreditos as creditos_consumidos', 'creditos')\n//         ↑ relación + alias                        ↑ columna a sumar\n```\n\nLaravel necesita saber qué campo de la tabla `consumos_creditos` debe sumar. En este caso suma la columna `creditos` de cada registro de consumo.\n\nSi la tabla `consumos_creditos` tiene una estructura como:\n| id | empresa_plan_id | creditos | ... |\n|----|-----------------|----------|-----|\n| 1  | 5               | 10       | ... |\n| 2  | 5               | 5        | ... |\n\nEl resultado sería `creditos_consumidos = 15` (suma de 10 + 5).\n\n¿Quieres que verifique el modelo `ConsumoCredito` para confirmar el nombre del campo?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2368,"cache_read_input_tokens":63430,"cache_creation":{"ephemeral_5m_input_tokens":2368,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXNw9Qiie1GRaFSQMGZmt","type":"assistant","uuid":"350476aa-af31-4b1b-89e9-5d3f94f176fb","timestamp":"2026-01-22T19:02:24.484Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T20:15:45.197Z","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb"}
{"type":"file-history-snapshot","messageId":"cd534133-d7b8-4600-b55c-103b1c2df3a0","snapshot":{"messageId":"cd534133-d7b8-4600-b55c-103b1c2df3a0","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v3","version":3,"backupTime":"2026-01-22T20:15:47.092Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v3","version":3,"backupTime":"2026-01-22T20:15:47.109Z"},"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"04cb3be0b984b422@v2","version":2,"backupTime":"2026-01-22T19:02:14.825Z"}},"timestamp":"2026-01-22T20:15:47.078Z"},"isSnapshotUpdate":false}
{"parentUuid":"350476aa-af31-4b1b-89e9-5d3f94f176fb","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 46 to 46 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php:\npublic function registrarConsumoDesdeRespuesta(\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"listo ira aqui public function registrarConsumoDesdeRespuesta( al final del todo quero hacer una validacion de aque si el plan de creditos le queda menos del 20% pasea estado proximo avencer y s itiene 0 a vencido y se calcula con esta funcion public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array { de app\\Http\\Services\\Empresas\\EmpresaPlanService.php dentro del plan_credito etan los creditos son son los creditos del plan y estan creditos diponibles que son los cretitos que ha consumisdo la emnpresa y se actualiz asi $this->empresa_plan_repositorio->actualizar($empresa_plan_activo->id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);"}]},"uuid":"cd534133-d7b8-4600-b55c-103b1c2df3a0","timestamp":"2026-01-22T20:15:47.073Z","permissionMode":"default"}
{"parentUuid":"cd534133-d7b8-4600-b55c-103b1c2df3a0","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01We86t4C5rqdAaRyppcEydT","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere agregar una validación al final de la función `registrarConsumoDesdeRespuesta` en `ConsumoCreditoService.php`. La lógica sería:\n\n1. Después de registrar el consumo, verificar los créditos disponibles\n2. Si quedan menos del 20% de los créditos del plan → cambiar estado a \"Por vencer\"\n3. Si quedan 0 créditos → cambiar estado a \"Vencido\"\n\nNecesito:\n1. Leer el archivo `ConsumoCreditoService.php` para ver la función completa\n2. Usar la función `creditosDisponiblesEmpresa` del `EmpresaPlanService`\n3. Actualizar el estado usando el repositorio\n\nPrimero voy a leer el archivo para entender la estructura actual.","signature":"EqcGCkYICxgCKkDGngt3q8qgRdTGptnSSnEFyuBGelBk09RwG48lR2ArMgBIoz5pFjgTvG9HLRfha8WkRyf9vQGzwt9ngsbs/1nREgysdGlUHWhuOjDiPcgaDDAR67y5AVRZzua9QCIwljXzkOHf2y9jlq50+7pezNHCBLO2laXP6KtwJQQ5rJ0Aw4N2OvgXztMkSedVZnloKo4FUHD6ibEoXE28eD+v5a20Hr8fhYaYFL8YJZg2aK0qWRNV+jqLVmgY0FJHgVd2w7NPauWFQoKgLvEOMZMJJIB9tZcPLllixyS67atf9qPLFhoH4lzLfY9HWGOQif77PouabrWo0wECc253YJTnWI0HvjyeoESOcQ8bXp8IGEehAbFDLggYBpHFdBdVglUcKVigCbuI/FKoahIBuXIFEeQ283wPSYlKSJElktulu5OmuQjA9fMJ6lk5BdlEL828XQwjSXaJ6t4PiKK19G7Zmdm/rFDVT05H7zT9KsaVSZv+bvJ60s3+HUf1NZUxFOjfhS2Y7S9nMd4YHbzdASSAW5xXkAabL1C47Z0ZTIiPVLzvUR3UBUZpJqIkd/K6aOZ0rg1pN7E1jExzUloDlYEPArFxpvmk6NWlV2EoBBNe6Pdn71XPBo4nD1lZ5hbTRF1fQZoC5cbwtkvwlf2+85A45qsMJOtFcNheQOxqjxZ3Q1AQE6A91KjwuoF0CcSYx2vRtdYudZ79SpwaRN68bzISweqT6GDZO5TFDZaN1FTAyHFUlnqEjyiIR/aeLwBX9KdC9+KqHhPPwIJ63L/vVMJgOqooHlKOKNFspZQA0gQVsyYwQxlC76YqNq/8sK6SZ1pBA8jWXIp1oXnDX+3dVPCYK+HLHtZ3f5mCQ4xcqT68mHckiJ1Q6BNUz/4DsQlQL0HCupz+3T6MN4AQ5JNMmMhyJ5JhcO3j6tClA3PvYYikO7XViQzXfQeQ/mQkKrJuoe/dAH4msyqz/JQnbdiJ4sBqVQ9/C2J3++5dWf6M34Lq5YGqLa5rMhwceAMEBYFBERpPfN/DQ+BD1a2Uz9pqsTk5DetWGszrCjfo0GAXpWpIZRt+GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":68828,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":68828,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2kebhmR7HfwWqGauB9","type":"assistant","uuid":"80a7dbae-b89f-4d76-a895-37e4c7e734c8","timestamp":"2026-01-22T20:15:53.804Z"}
{"parentUuid":"80a7dbae-b89f-4d76-a895-37e4c7e734c8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01We86t4C5rqdAaRyppcEydT","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a leer el servicio `ConsumoCreditoService.php` para ver la función completa y agregar la validación."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":68828,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":68828,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2kebhmR7HfwWqGauB9","type":"assistant","uuid":"1a425e07-ee70-4545-988f-48856da1cb00","timestamp":"2026-01-22T20:15:54.279Z"}
{"parentUuid":"1a425e07-ee70-4545-988f-48856da1cb00","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01We86t4C5rqdAaRyppcEydT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01F1Gzf31LpqC9bgfXLvxoaQ","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":68828,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":68828,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP2kebhmR7HfwWqGauB9","type":"assistant","uuid":"03c7aba7-abcf-4ed1-b963-fa61f96760d8","timestamp":"2026-01-22T20:15:54.857Z"}
{"parentUuid":"03c7aba7-abcf-4ed1-b963-fa61f96760d8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01F1Gzf31LpqC9bgfXLvxoaQ","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use Illuminate\\Support\\Str;\n     7→use App\\Models\\IA\\ConsumoCredito;\n     8→use App\\Http\\Services\\BaseService;\n     9→use Illuminate\\Support\\Collection;\n    10→use App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n    11→\n    12→class ConsumoCreditoService extends BaseService\n    13→{\n    14→    /**\n    15→     * Constructor.\n    16→     *\n    17→     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n    18→     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n    19→     * @return void\n    20→     * @author Sergio Vargas\n    21→     * @author Daniel Beltrán\n    22→     */\n    23→    public function __construct(\n    24→        ConsumoCreditoRepository $repositorio,\n    25→        private readonly ServicioPrecioTokenService $precio_token_servicio\n    26→    ) {\n    27→        parent::__construct($repositorio);\n    28→    }\n    29→\n    30→    /**\n    31→     * Registra el consumo de tokens desde la respuesta de la API de IA.\n    32→     *\n    33→     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n    34→     *\n    35→     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n    36→     * @param array $respuesta_ia Respuesta completa de la API de IA.\n    37→     * @param ?int $usuario_id ID del usuario que realizó la petición.\n    38→     * @param ?int $empresa_id ID de la empresa del usuario.\n    39→     * @param array $contexto Array con agenda_id, vacante_id, etc.\n    40→     * @param ?string $payload_peticion JSON del payload enviado.\n    41→     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n    42→     * @return ?ConsumoCredito\n    43→     * @author Sergio Vargas\n    44→     * @author Daniel Beltrán\n    45→     */\n    46→    public function registrarConsumoDesdeRespuesta(\n    47→        string $ruta_endpoint,\n    48→        array $respuesta_ia,\n    49→        ?int $usuario_id = null,\n    50→        ?int $empresa_id = null,\n    51→        ?array $contexto = [],\n    52→        ?string $payload_peticion = null,\n    53→        ?int $latencia_ms = null\n    54→    ): ?ConsumoCredito {\n    55→        // Detectar si hay múltiples metadata de uso (formato nuevo)\n    56→        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n    57→        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n    58→        $ultimo_registro = null;\n    59→\n    60→        // Registrar Whisper si existe\n    61→        if ($uso_whisper) {\n    62→            $ultimo_registro = $this->registrarConsumoIndividual(\n    63→                ruta_endpoint: $ruta_endpoint . '.whisper',\n    64→                usage: $uso_whisper,\n    65→                respuesta_ia: $respuesta_ia,\n    66→                usuario_id: $usuario_id,\n    67→                empresa_id: $empresa_id,\n    68→                contexto: $contexto,\n    69→                payload_peticion: $payload_peticion,\n    70→                latencia_ms: $latencia_ms\n    71→            );\n    72→        }\n    73→\n    74→        // Registrar GPT si existe\n    75→        if ($uso_gpt) {\n    76→            $ultimo_registro = $this->registrarConsumoIndividual(\n    77→                ruta_endpoint: $ruta_endpoint . '.gpt',\n    78→                usage: $uso_gpt,\n    79→                respuesta_ia: $respuesta_ia,\n    80→                usuario_id: $usuario_id,\n    81→                empresa_id: $empresa_id,\n    82→                contexto: $contexto,\n    83→                payload_peticion: $payload_peticion,\n    84→                latencia_ms: $latencia_ms\n    85→            );\n    86→        }\n    87→\n    88→        // Fallback: Si solo hay \"usage\" (formato legacy)\n    89→        $usage_legacy = $respuesta_ia['usage'] ?? null;\n    90→\n    91→        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n    92→            $ultimo_registro = $this->registrarConsumoIndividual(\n    93→                ruta_endpoint: $ruta_endpoint,\n    94→                usage: $usage_legacy,\n    95→                respuesta_ia: $respuesta_ia,\n    96→                usuario_id: $usuario_id,\n    97→                empresa_id: $empresa_id,\n    98→                contexto: $contexto,\n    99→                payload_peticion: $payload_peticion,\n   100→                latencia_ms: $latencia_ms\n   101→            );\n   102→        }\n   103→\n   104→        return $ultimo_registro;\n   105→    }\n   106→\n   107→    /**\n   108→     * Registra un consumo individual de tokens desde una metadata de uso específica.\n   109→     *\n   110→     * @param string $ruta_endpoint Ruta del endpoint llamado.\n   111→     * @param array $usage Metadata de uso específica.\n   112→     * @param array $respuesta_ia Respuesta completa de la API de IA.\n   113→     * @param ?int $usuario_id ID del usuario que realizó la petición.\n   114→     * @param ?int $empresa_id ID de la empresa del usuario.\n   115→     * @param array $contexto Array con agenda_id, vacante_id, etc.\n   116→     * @param ?string $payload_peticion JSON del payload enviado.\n   117→     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n   118→     * @return ?ConsumoCredito\n   119→     * @author Sergio Vargas\n   120→     * @author Daniel Beltrán\n   121→     */\n   122→    private function registrarConsumoIndividual(\n   123→        string $ruta_endpoint,\n   124→        array $usage,\n   125→        array $respuesta_ia,\n   126→        ?int $usuario_id,\n   127→        ?int $empresa_id,\n   128→        array $contexto,\n   129→        ?string $payload_peticion,\n   130→        ?int $latencia_ms\n   131→    ): ?ConsumoCredito {\n   132→        $vacante_id = $contexto['vacante_id'] ?? null;\n   133→\n   134→        if (!$vacante_id && $payload_peticion) {\n   135→            $decoded = json_decode($payload_peticion, true);\n   136→\n   137→            if (is_array($decoded)) {\n   138→                $vacante_id = data_get($decoded, 'vacante_id')\n   139→                    ?? data_get($decoded, 'vacanteId')\n   140→                    ?? data_get($decoded, 'id')\n   141→                    ?? data_get($decoded, 'vacante.id');\n   142→\n   143→                if ($vacante_id && !is_numeric($vacante_id)) {\n   144→                    $vacante_id = null;\n   145→                } elseif (is_numeric($vacante_id)) {\n   146→                    $vacante_id = (int) $vacante_id;\n   147→                }\n   148→            }\n   149→        }\n   150→\n   151→        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n   152→        $modelo = $usage['model'] ?? 'desconocido';\n   153→\n   154→        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n   155→        $metadata_adicional = [];\n   156→\n   157→        if (isset($usage['audio_duration_minutes'])) {\n   158→            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n   159→        }\n   160→\n   161→        if (isset($usage['audio_duration_seconds'])) {\n   162→            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n   163→        }\n   164→\n   165→        // Calcular costo estimado (pasando metadata adicional para Whisper)\n   166→        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n   167→            $modelo,\n   168→            $usage['prompt_tokens'] ?? 0,\n   169→            $usage['completion_tokens'] ?? 0,\n   170→            $metadata_adicional ?: null\n   171→        );\n   172→\n   173→        // Generar huella digital\n   174→        $huella_peticion = null;\n   175→\n   176→        if ($payload_peticion) {\n   177→            $huella_peticion = hash('sha256', $payload_peticion);\n   178→        }\n   179→\n   180→        // Determinar estado de la respuesta\n   181→        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n   182→        $estado = 'exitoso';\n   183→\n   184→        if (isset($respuesta_ia['status_code'])) {\n   185→            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n   186→        } elseif (isset($respuesta_ia['error'])) {\n   187→            $estado = 'error';\n   188→        }\n   189→\n   190→        // Preparar datos\n   191→        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n   192→        $contenido_respuesta = $respuesta_ia['data']\n   193→            ?? $respuesta_ia['vacante']\n   194→            ?? $respuesta_ia['preguntas']\n   195→            ?? $respuesta_ia['pruebas']\n   196→            ?? $respuesta_ia['calificacion']\n   197→            ?? null;\n   198→\n   199→        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n   200→        if ($contenido_respuesta === null) {\n   201→            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n   202→        }\n   203→\n   204→        $datos = [\n   205→            'usuario_id'         => $usuario_id,\n   206→            'empresa_id'         => $empresa_id,\n   207→            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n   208→            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n   209→            'creditos'           => $contexto['creditos'] ?? 0,\n   210→            'ruta_endpoint'      => $ruta_endpoint,\n   211→            'nombre_servicio'    => $usage['service_name'] ?? null,\n   212→            'modelo'             => $modelo,\n   213→            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n   214→            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n   215→            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n   216→            'caracteres_entrada' => $usage['input_chars'] ?? null,\n   217→            'costo_estimado_usd' => $costo_estimado,\n   218→            'huella_peticion'    => $huella_peticion,\n   219→            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n   220→            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n   221→            'estado'             => $estado,\n   222→            'latencia_ms'        => $latencia_ms,\n   223→            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n   224→            'agenda_id'          => $contexto['agenda_id'] ?? null,\n   225→            'vacante_id'         => $vacante_id\n   226→        ];\n   227→\n   228→        return $this->repositorio->crear($datos);\n   229→    }\n   230→\n   231→    /**\n   232→     * Obtener historial de consumos de creditos por empresa.\n   233→     *\n   234→     * @param int $empresa_id ID de la empresa.\n   235→     * @param array $filtros Filtros de fecha.\n   236→     * @return Collection\n   237→     * @author Sergio Vargas\n   238→     */\n   239→    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n   240→        $desde = null;\n   241→        $hasta = null;\n   242→\n   243→        if (!empty($filtros['desde'])) {\n   244→            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n   245→        }\n   246→\n   247→        if (!empty($filtros['hasta'])) {\n   248→            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n   249→        }\n   250→\n   251→        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n   252→\n   253→        return $consumos->map(function (ConsumoCredito $consumo) {\n   254→            $servicio = $consumo->servicioIA?->nombre\n   255→                ?? $consumo->nombre_servicio\n   256→                ?? $consumo->ruta_endpoint;\n   257→\n   258→            return [\n   259→                'usuario'        => $consumo->usuario ? [\n   260→                    'id'              => $consumo->usuario->id,\n   261→                    'nombre_completo' => $consumo->usuario->nombre_completo\n   262→                ] : null,\n   263→                'servicio'       => $servicio,\n   264→                'creditos'       => $consumo->creditos ?? 0,\n   265→                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n   266→                'fecha_consumo'  => $consumo->created_at\n   267→            ];\n   268→        });\n   269→    }\n   270→}\n   271→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"780b063b-de19-4f71-a296-75a0aa3dbc20","timestamp":"2026-01-22T20:15:56.100Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","content":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(\n        string $ruta_endpoint,\n        array $respuesta_ia,\n        ?int $usuario_id = null,\n        ?int $empresa_id = null,\n        ?array $contexto = [],\n        ?string $payload_peticion = null,\n        ?int $latencia_ms = null\n    ): ?ConsumoCredito {\n        // Detectar si hay múltiples metadata de uso (formato nuevo)\n        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n        $ultimo_registro = null;\n\n        // Registrar Whisper si existe\n        if ($uso_whisper) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.whisper',\n                usage: $uso_whisper,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Registrar GPT si existe\n        if ($uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.gpt',\n                usage: $uso_gpt,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado.\n     * @param array $usage Metadata de uso específica.\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function registrarConsumoIndividual(\n        string $ruta_endpoint,\n        array $usage,\n        array $respuesta_ia,\n        ?int $usuario_id,\n        ?int $empresa_id,\n        array $contexto,\n        ?string $payload_peticion,\n        ?int $latencia_ms\n    ): ?ConsumoCredito {\n        $vacante_id = $contexto['vacante_id'] ?? null;\n\n        if (!$vacante_id && $payload_peticion) {\n            $decoded = json_decode($payload_peticion, true);\n\n            if (is_array($decoded)) {\n                $vacante_id = data_get($decoded, 'vacante_id')\n                    ?? data_get($decoded, 'vacanteId')\n                    ?? data_get($decoded, 'id')\n                    ?? data_get($decoded, 'vacante.id');\n\n                if ($vacante_id && !is_numeric($vacante_id)) {\n                    $vacante_id = null;\n                } elseif (is_numeric($vacante_id)) {\n                    $vacante_id = (int) $vacante_id;\n                }\n            }\n        }\n\n        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n        $modelo = $usage['model'] ?? 'desconocido';\n\n        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n        $metadata_adicional = [];\n\n        if (isset($usage['audio_duration_minutes'])) {\n            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n        }\n\n        if (isset($usage['audio_duration_seconds'])) {\n            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n        }\n\n        // Calcular costo estimado (pasando metadata adicional para Whisper)\n        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n            $modelo,\n            $usage['prompt_tokens'] ?? 0,\n            $usage['completion_tokens'] ?? 0,\n            $metadata_adicional ?: null\n        );\n\n        // Generar huella digital\n        $huella_peticion = null;\n\n        if ($payload_peticion) {\n            $huella_peticion = hash('sha256', $payload_peticion);\n        }\n\n        // Determinar estado de la respuesta\n        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n        $estado = 'exitoso';\n\n        if (isset($respuesta_ia['status_code'])) {\n            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n        } elseif (isset($respuesta_ia['error'])) {\n            $estado = 'error';\n        }\n\n        // Preparar datos\n        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n        $contenido_respuesta = $respuesta_ia['data']\n            ?? $respuesta_ia['vacante']\n            ?? $respuesta_ia['preguntas']\n            ?? $respuesta_ia['pruebas']\n            ?? $respuesta_ia['calificacion']\n            ?? null;\n\n        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n        if ($contenido_respuesta === null) {\n            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n        }\n\n        $datos = [\n            'usuario_id'         => $usuario_id,\n            'empresa_id'         => $empresa_id,\n            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n            'creditos'           => $contexto['creditos'] ?? 0,\n            'ruta_endpoint'      => $ruta_endpoint,\n            'nombre_servicio'    => $usage['service_name'] ?? null,\n            'modelo'             => $modelo,\n            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n            'caracteres_entrada' => $usage['input_chars'] ?? null,\n            'costo_estimado_usd' => $costo_estimado,\n            'huella_peticion'    => $huella_peticion,\n            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n            'estado'             => $estado,\n            'latencia_ms'        => $latencia_ms,\n            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n            'agenda_id'          => $contexto['agenda_id'] ?? null,\n            'vacante_id'         => $vacante_id\n        ];\n\n        return $this->repositorio->crear($datos);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param array $filtros Filtros de fecha.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n        $desde = null;\n        $hasta = null;\n\n        if (!empty($filtros['desde'])) {\n            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n        }\n\n        if (!empty($filtros['hasta'])) {\n            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n        }\n\n        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n\n        return $consumos->map(function (ConsumoCredito $consumo) {\n            $servicio = $consumo->servicioIA?->nombre\n                ?? $consumo->nombre_servicio\n                ?? $consumo->ruta_endpoint;\n\n            return [\n                'usuario'        => $consumo->usuario ? [\n                    'id'              => $consumo->usuario->id,\n                    'nombre_completo' => $consumo->usuario->nombre_completo\n                ] : null,\n                'servicio'       => $servicio,\n                'creditos'       => $consumo->creditos ?? 0,\n                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n                'fecha_consumo'  => $consumo->created_at\n            ];\n        });\n    }\n}\n","numLines":271,"startLine":1,"totalLines":271}},"sourceToolAssistantUUID":"03c7aba7-abcf-4ed1-b963-fa61f96760d8"}
{"parentUuid":"780b063b-de19-4f71-a296-75a0aa3dbc20","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01T3QzhHKySrSmrxHGhcM6re","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito ver las constantes de estado del Plan para saber los IDs correctos. También necesito ver cómo inyectar el `EmpresaPlanService` o `EmpresaPlanRepository` en el constructor.\n\nVoy a buscar las constantes de estado en el modelo Plan o EstadoPlan.","signature":"EqoDCkYICxgCKkAabz1RHkyea6kYU9vGAEMTY7dpSV9KWWAPpkPKnwqTE6SwjdDQgT8LdSyNUEsi0vYfz+CWC5TBiOjj5ApzItcFEgxW1cVjsFtfK9jTB/kaDMFbzEDmi45UnA6k8yIwhzboiyeAl3g6Sz6iPXu1GTSJOmLwHDRujbHWKzEFlSPnYj3zebwN56NcF/gLBTv9KpECoCAlCSNhltcfEjRgYyPOzoiXPhOC1kWho15Z+P7Lu+ZYngn9cR0O7gvoruC/zpEGHHoNM2TV5v/loXBDEAbdggRbH3tusdSGRGtgRfd3yU8kBJQtMPfayGnMBsh1N3/gvcpalbRPq7BgoAPhGV5qkCdNAVLJfHeYYqaKYuOWayW9fMbfQHhJBRYd5HgEuB6OExjJ/Q+xfp+GI+EL+z8/fPpbHGFgW+Y4WKQH3YH1OnuuNH9m6Vot9VxYNjXva0T41NSW5PZr/KL5JqGCpxKkwTKico1fhsnChkPmJTlD7hqYLBnwgDsecxYnW8+7q7edFfN0U319xafsUEgS5u+1cZT5UFfZQ+41TicXdjpwAU4VGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":4385,"cache_read_input_tokens":68828,"cache_creation":{"ephemeral_5m_input_tokens":4385,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2mKpsK6CMDvcsCfeoV","type":"assistant","uuid":"c402a45c-2c81-47f9-bf39-0575257fa50c","timestamp":"2026-01-22T20:16:01.110Z"}
{"parentUuid":"c402a45c-2c81-47f9-bf39-0575257fa50c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01T3QzhHKySrSmrxHGhcM6re","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora necesito ver las constantes de estado del plan para usar los IDs correctos."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":4385,"cache_read_input_tokens":68828,"cache_creation":{"ephemeral_5m_input_tokens":4385,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2mKpsK6CMDvcsCfeoV","type":"assistant","uuid":"2798fa7f-5b0d-4fec-8991-9a53048724aa","timestamp":"2026-01-22T20:16:01.695Z"}
{"parentUuid":"2798fa7f-5b0d-4fec-8991-9a53048724aa","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01T3QzhHKySrSmrxHGhcM6re","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DdBzNhw8k5zbw4rCmTw3GH","name":"Grep","input":{"pattern":"ESTADO.*ID|POR_VENCER|VENCIDO","path":"app/Models/Planes","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":4385,"cache_read_input_tokens":68828,"cache_creation":{"ephemeral_5m_input_tokens":4385,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2mKpsK6CMDvcsCfeoV","type":"assistant","uuid":"73d5948e-9c8f-43a7-87b7-60f5ea5e3db5","timestamp":"2026-01-22T20:16:02.892Z"}
{"parentUuid":"73d5948e-9c8f-43a7-87b7-60f5ea5e3db5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DdBzNhw8k5zbw4rCmTw3GH","type":"tool_result","content":"c:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:19:    public const ESTADO_ACTIVO_ID     = 1;\nc:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:20:    public const ESTADO_INACTIVO_ID   = 2;\nc:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:21:    public const ESTADO_PROXIMO_ID    = 3;\nc:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:22:    public const ESTADO_POR_VENCER_ID = 4;\nc:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:23:    public const ESTADO_VENCIDO_ID    = 5;"}]},"uuid":"01603a57-bb9a-48b5-bad1-f6d3f9c24667","timestamp":"2026-01-22T20:16:06.373Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"c:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:19:    public const ESTADO_ACTIVO_ID     = 1;\nc:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:20:    public const ESTADO_INACTIVO_ID   = 2;\nc:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:21:    public const ESTADO_PROXIMO_ID    = 3;\nc:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:22:    public const ESTADO_POR_VENCER_ID = 4;\nc:\\laragon\\www\\psicoalianza-2\\app\\Models\\Planes\\Plan.php:23:    public const ESTADO_VENCIDO_ID    = 5;","numLines":5},"sourceToolAssistantUUID":"73d5948e-9c8f-43a7-87b7-60f5ea5e3db5"}
{"parentUuid":"01603a57-bb9a-48b5-bad1-f6d3f9c24667","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XguCdXj6jBACEA3szpAUvp","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora tengo los IDs de estado:\n- ESTADO_ACTIVO_ID = 1\n- ESTADO_INACTIVO_ID = 2\n- ESTADO_PROXIMO_ID = 3\n- ESTADO_POR_VENCER_ID = 4\n- ESTADO_VENCIDO_ID = 5\n\nNecesito agregar la validación al final de `registrarConsumoDesdeRespuesta`. La lógica sería:\n\n1. Obtener los créditos disponibles de la empresa usando `creditosDisponiblesEmpresa`\n2. Calcular el porcentaje restante: `creditos_disponibles / creditos_plan * 100`\n3. Si porcentaje <= 0 → estado VENCIDO (5)\n4. Si porcentaje < 20 → estado POR_VENCER (4)\n\nNecesito inyectar el `EmpresaPlanService` o el repositorio en el constructor. Voy a agregar el `EmpresaPlanRepository` ya que es más directo para actualizar el estado.\n\nVoy a modificar el archivo:\n1. Agregar el import de `EmpresaPlanRepository` y `Plan`\n2. Agregar la dependencia en el constructor\n3. Agregar la lógica de validación al final de `registrarConsumoDesdeRespuesta`","signature":"EpsICkYICxgCKkB8sMUxes1Vawht2ZpnJQOvB8DdNePG7Qft0AKE9UJVDh7J2veG9rFXWvIiK+TSpSO+v5FwQxsX7iHT0Wyso5N3Egw/pICa1o9uFQV6VJUaDCqi/8o4Y6Tkpei+MSIwQIXKYzK/5ecyJFo0wrzKrhWY/R83Aff9j6kIs9d7eBjoaSDwlbE1aL/pxmcNX2JvKoIHqj+thDdlTMz8TQyETTZy+GkIezzs5G+RKkA2vZfq5vrsxM7RWRRCqr7vmkPVpfCffi7g3w7LhkMkAnB4VC87sHTQ2a+E1qxXalqvHA6ygt/MlAusb4pIeGAl3JDJ6fQyFug2FI3rRXKKqHVGHaEZhj3YyGac8pboj7YxwTlzmC3R18znsbEz+Q/CgB2rvzLuXU9dGwAg+JD6woslkkernUUIaJtpNyMvCi6jWG2SlpPLPTiP+UKEjjut7jSTFZFdD6yB6tm5Cq7DIVuKsmtaGZ7cUQE9pCD0v1aQz+1+T0lI4o52sYLFIOFIseBOgvwYLJt7QplH6Ioh381gJKJQbdWF/sjCi89jHAMpu6j6arS5Ze65a43Hw2/VSWbGxu6R5OJGJyIpuWSs23KSD6W1TQ48k6xYrF0MM1EWHiStLO5+OEcRVOcBY4LhCELSu3Wj/l5CWB5bhjuocegx+H92JnVl7hBilppyXsv1PMIXpwbzh7mEL4KvbuDEEttbjhYLTzP8pzqVD7mFukcqyS+TaGg0dp6ZXOwzPwHlASg/U5+fI0PWNtwmMnq7LMKb6hlENA83Vq7QnTXuvjFWN9GdlpfDRsUWKrKTFnxq4HcCtFB47B5Z4bb77/0N+CotnlenC88tTduZrnNwXOMatVUdsQthcnwdDYZCJV6vHyFaHyOU6Zb0k2VPuAAoKqBQdLNdD9UrSp5Hk9AnkcXKyxMu3M9jlvQwAnOoujimFTKMU0qKFAmSV8UmIT8dhEe0r4lq30UEuESbgUwvSYyRduuO1kuMP12lC3Ua4Ub0rjimg3DhVZoBhLHzCUU3FEW+xDlcE7kTou2LuxOEF4m2tatYMVFyR64ceQOlDTZ/WYE/N6YHO9MShk4jLNpTDDYVD2Bl6S4HkSFkLEzUkqp6nkGAGt2+xVcyFLAP3+PZg/NpmFZdZ79P4r6mCIzg1vPG9w4jeAGnZ3oICS/79m4uoi+vTof4sh1CdZu+C7hIm8hHj+oer9T2KD3RJ8sCU1WcA7jGy8D89YUkKdnC1tSgmPjXw9BpspLGpL6lYBQxrK+fAsb1JFR7eIgZLqyNynGlwodtZD1seSaR235HfuSBLOXzUHD+V8Vaba+ptcDAbx01+4/Geak9nSdd2J0MVDyDk9vLgjAKnBuafQg+hOgpU6wA2C/iKp9VSXt6B83y9ufnoWd2XxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":460,"cache_read_input_tokens":73213,"cache_creation":{"ephemeral_5m_input_tokens":460,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2n5FJe3vNUQNX6QZ4v","type":"assistant","uuid":"e36bb1d4-d038-482e-9c54-fbd977a50c30","timestamp":"2026-01-22T20:16:14.514Z"}
{"parentUuid":"e36bb1d4-d038-482e-9c54-fbd977a50c30","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XguCdXj6jBACEA3szpAUvp","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a modificar el servicio para agregar la validación. Necesito:\n1. Inyectar el repositorio de empresa plan\n2. Agregar la lógica de validación al final de la función"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":460,"cache_read_input_tokens":73213,"cache_creation":{"ephemeral_5m_input_tokens":460,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2n5FJe3vNUQNX6QZ4v","type":"assistant","uuid":"95cd1c69-f8e1-4cc3-95f5-b061e0a8c7ee","timestamp":"2026-01-22T20:16:15.191Z"}
{"parentUuid":"95cd1c69-f8e1-4cc3-95f5-b061e0a8c7ee","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XguCdXj6jBACEA3szpAUvp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VYcAodFY8jtaPkfwJG73xi","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","old_string":"use Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;","new_string":"use Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":460,"cache_read_input_tokens":73213,"cache_creation":{"ephemeral_5m_input_tokens":460,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2n5FJe3vNUQNX6QZ4v","type":"assistant","uuid":"eac7b333-a60c-4063-a6b0-8467de1af88b","timestamp":"2026-01-22T20:16:17.916Z"}
{"type":"file-history-snapshot","messageId":"eac7b333-a60c-4063-a6b0-8467de1af88b","snapshot":{"messageId":"cd534133-d7b8-4600-b55c-103b1c2df3a0","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v3","version":3,"backupTime":"2026-01-22T20:15:47.092Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v3","version":3,"backupTime":"2026-01-22T20:15:47.109Z"},"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"04cb3be0b984b422@v2","version":2,"backupTime":"2026-01-22T19:02:14.825Z"},"app\\Http\\Services\\IA\\ConsumoCreditoService.php":{"backupFileName":"3e939a737c702ece@v1","version":1,"backupTime":"2026-01-22T20:16:22.082Z"}},"timestamp":"2026-01-22T20:15:47.078Z"},"isSnapshotUpdate":true}
{"parentUuid":"eac7b333-a60c-4063-a6b0-8467de1af88b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VYcAodFY8jtaPkfwJG73xi","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use Illuminate\\Support\\Str;\n     7→use App\\Models\\Planes\\Plan;\n     8→use App\\Models\\IA\\ConsumoCredito;\n     9→use App\\Http\\Services\\BaseService;\n    10→use Illuminate\\Support\\Collection;\n    11→use App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n    12→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    13→\n    14→class ConsumoCreditoService extends BaseService\n    15→{\n    16→    /**"}]},"uuid":"654821ed-d20d-47c1-95ac-571d337a80ea","timestamp":"2026-01-22T20:16:22.127Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","oldString":"use Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;","newString":"use Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;","originalFile":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(\n        string $ruta_endpoint,\n        array $respuesta_ia,\n        ?int $usuario_id = null,\n        ?int $empresa_id = null,\n        ?array $contexto = [],\n        ?string $payload_peticion = null,\n        ?int $latencia_ms = null\n    ): ?ConsumoCredito {\n        // Detectar si hay múltiples metadata de uso (formato nuevo)\n        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n        $ultimo_registro = null;\n\n        // Registrar Whisper si existe\n        if ($uso_whisper) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.whisper',\n                usage: $uso_whisper,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Registrar GPT si existe\n        if ($uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.gpt',\n                usage: $uso_gpt,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado.\n     * @param array $usage Metadata de uso específica.\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function registrarConsumoIndividual(\n        string $ruta_endpoint,\n        array $usage,\n        array $respuesta_ia,\n        ?int $usuario_id,\n        ?int $empresa_id,\n        array $contexto,\n        ?string $payload_peticion,\n        ?int $latencia_ms\n    ): ?ConsumoCredito {\n        $vacante_id = $contexto['vacante_id'] ?? null;\n\n        if (!$vacante_id && $payload_peticion) {\n            $decoded = json_decode($payload_peticion, true);\n\n            if (is_array($decoded)) {\n                $vacante_id = data_get($decoded, 'vacante_id')\n                    ?? data_get($decoded, 'vacanteId')\n                    ?? data_get($decoded, 'id')\n                    ?? data_get($decoded, 'vacante.id');\n\n                if ($vacante_id && !is_numeric($vacante_id)) {\n                    $vacante_id = null;\n                } elseif (is_numeric($vacante_id)) {\n                    $vacante_id = (int) $vacante_id;\n                }\n            }\n        }\n\n        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n        $modelo = $usage['model'] ?? 'desconocido';\n\n        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n        $metadata_adicional = [];\n\n        if (isset($usage['audio_duration_minutes'])) {\n            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n        }\n\n        if (isset($usage['audio_duration_seconds'])) {\n            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n        }\n\n        // Calcular costo estimado (pasando metadata adicional para Whisper)\n        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n            $modelo,\n            $usage['prompt_tokens'] ?? 0,\n            $usage['completion_tokens'] ?? 0,\n            $metadata_adicional ?: null\n        );\n\n        // Generar huella digital\n        $huella_peticion = null;\n\n        if ($payload_peticion) {\n            $huella_peticion = hash('sha256', $payload_peticion);\n        }\n\n        // Determinar estado de la respuesta\n        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n        $estado = 'exitoso';\n\n        if (isset($respuesta_ia['status_code'])) {\n            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n        } elseif (isset($respuesta_ia['error'])) {\n            $estado = 'error';\n        }\n\n        // Preparar datos\n        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n        $contenido_respuesta = $respuesta_ia['data']\n            ?? $respuesta_ia['vacante']\n            ?? $respuesta_ia['preguntas']\n            ?? $respuesta_ia['pruebas']\n            ?? $respuesta_ia['calificacion']\n            ?? null;\n\n        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n        if ($contenido_respuesta === null) {\n            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n        }\n\n        $datos = [\n            'usuario_id'         => $usuario_id,\n            'empresa_id'         => $empresa_id,\n            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n            'creditos'           => $contexto['creditos'] ?? 0,\n            'ruta_endpoint'      => $ruta_endpoint,\n            'nombre_servicio'    => $usage['service_name'] ?? null,\n            'modelo'             => $modelo,\n            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n            'caracteres_entrada' => $usage['input_chars'] ?? null,\n            'costo_estimado_usd' => $costo_estimado,\n            'huella_peticion'    => $huella_peticion,\n            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n            'estado'             => $estado,\n            'latencia_ms'        => $latencia_ms,\n            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n            'agenda_id'          => $contexto['agenda_id'] ?? null,\n            'vacante_id'         => $vacante_id\n        ];\n\n        return $this->repositorio->crear($datos);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param array $filtros Filtros de fecha.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n        $desde = null;\n        $hasta = null;\n\n        if (!empty($filtros['desde'])) {\n            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n        }\n\n        if (!empty($filtros['hasta'])) {\n            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n        }\n\n        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n\n        return $consumos->map(function (ConsumoCredito $consumo) {\n            $servicio = $consumo->servicioIA?->nombre\n                ?? $consumo->nombre_servicio\n                ?? $consumo->ruta_endpoint;\n\n            return [\n                'usuario'        => $consumo->usuario ? [\n                    'id'              => $consumo->usuario->id,\n                    'nombre_completo' => $consumo->usuario->nombre_completo\n                ] : null,\n                'servicio'       => $servicio,\n                'creditos'       => $consumo->creditos ?? 0,\n                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n                'fecha_consumo'  => $consumo->created_at\n            ];\n        });\n    }\n}\n","structuredPatch":[{"oldStart":4,"oldLines":10,"newStart":4,"newLines":12,"lines":[" "," use Carbon\\Carbon;"," use Illuminate\\Support\\Str;","+use App\\Models\\Planes\\Plan;"," use App\\Models\\IA\\ConsumoCredito;"," use App\\Http\\Services\\BaseService;"," use Illuminate\\Support\\Collection;"," use App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;","+use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;"," "," class ConsumoCreditoService extends BaseService"," {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"eac7b333-a60c-4063-a6b0-8467de1af88b"}
{"parentUuid":"654821ed-d20d-47c1-95ac-571d337a80ea","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DjgMy2Vndmiqrss8JE8VDM","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito agregar la dependencia al constructor.","signature":"Et0BCkYICxgCKkCqM9o0NAOVxbeMSbIJEi5BxwKh884iHEEMSwf11Rk/7TKmIJfMvYS8rZjAWdP7Tcl8+xeEPOSNoS7HmmWnoNCwEgwr1QnLq7Xk7I9R66kaDLbjQX1Edg7ovrY2zyIwoYBTveK2OmZ1wwWC+InPjKEZflbVQT4SGBcCDoFRlgozrL0I9hWSsFl6Tarw6+qoKkXp7y6N9DpcnuvhI8pv5cGFNy7xCVXcpk8LR4KjSDeR4hoMgQb4hiWghvSDJ+3dBv+JmorsgP/s8GHhZmRJq3po7dxQ27AYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":950,"cache_read_input_tokens":73673,"cache_creation":{"ephemeral_5m_input_tokens":950,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP2oKW5aLGTAXmXpPTRw","type":"assistant","uuid":"e4c30842-ef31-4604-97f1-16762c42f357","timestamp":"2026-01-22T20:16:26.738Z"}
{"parentUuid":"e4c30842-ef31-4604-97f1-16762c42f357","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DjgMy2Vndmiqrss8JE8VDM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KYAsBx6GQdFMnznGnpvvWj","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","old_string":"    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio\n    ) {\n        parent::__construct($repositorio);\n    }","new_string":"    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":950,"cache_read_input_tokens":73673,"cache_creation":{"ephemeral_5m_input_tokens":950,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXP2oKW5aLGTAXmXpPTRw","type":"assistant","uuid":"a93fed5b-12df-459b-846c-5ec1db7779c7","timestamp":"2026-01-22T20:16:30.396Z"}
{"parentUuid":"a93fed5b-12df-459b-846c-5ec1db7779c7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KYAsBx6GQdFMnznGnpvvWj","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    12→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    13→\n    14→class ConsumoCreditoService extends BaseService\n    15→{\n    16→    /**\n    17→     * Constructor.\n    18→     *\n    19→     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n    20→     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n    21→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n    22→     * @return void\n    23→     * @author Sergio Vargas\n    24→     * @author Daniel Beltrán\n    25→     */\n    26→    public function __construct(\n    27→        ConsumoCreditoRepository $repositorio,\n    28→        private readonly ServicioPrecioTokenService $precio_token_servicio,\n    29→        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    30→    ) {\n    31→        parent::__construct($repositorio);\n    32→    }\n    33→\n    34→    /**\n    35→     * Registra el consumo de tokens desde la respuesta de la API de IA.\n    36→     *"}]},"uuid":"debfcdf3-1cac-4598-aa28-44b7f05951b3","timestamp":"2026-01-22T20:16:36.754Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","oldString":"    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio\n    ) {\n        parent::__construct($repositorio);\n    }","newString":"    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(\n        string $ruta_endpoint,\n        array $respuesta_ia,\n        ?int $usuario_id = null,\n        ?int $empresa_id = null,\n        ?array $contexto = [],\n        ?string $payload_peticion = null,\n        ?int $latencia_ms = null\n    ): ?ConsumoCredito {\n        // Detectar si hay múltiples metadata de uso (formato nuevo)\n        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n        $ultimo_registro = null;\n\n        // Registrar Whisper si existe\n        if ($uso_whisper) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.whisper',\n                usage: $uso_whisper,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Registrar GPT si existe\n        if ($uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.gpt',\n                usage: $uso_gpt,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado.\n     * @param array $usage Metadata de uso específica.\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function registrarConsumoIndividual(\n        string $ruta_endpoint,\n        array $usage,\n        array $respuesta_ia,\n        ?int $usuario_id,\n        ?int $empresa_id,\n        array $contexto,\n        ?string $payload_peticion,\n        ?int $latencia_ms\n    ): ?ConsumoCredito {\n        $vacante_id = $contexto['vacante_id'] ?? null;\n\n        if (!$vacante_id && $payload_peticion) {\n            $decoded = json_decode($payload_peticion, true);\n\n            if (is_array($decoded)) {\n                $vacante_id = data_get($decoded, 'vacante_id')\n                    ?? data_get($decoded, 'vacanteId')\n                    ?? data_get($decoded, 'id')\n                    ?? data_get($decoded, 'vacante.id');\n\n                if ($vacante_id && !is_numeric($vacante_id)) {\n                    $vacante_id = null;\n                } elseif (is_numeric($vacante_id)) {\n                    $vacante_id = (int) $vacante_id;\n                }\n            }\n        }\n\n        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n        $modelo = $usage['model'] ?? 'desconocido';\n\n        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n        $metadata_adicional = [];\n\n        if (isset($usage['audio_duration_minutes'])) {\n            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n        }\n\n        if (isset($usage['audio_duration_seconds'])) {\n            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n        }\n\n        // Calcular costo estimado (pasando metadata adicional para Whisper)\n        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n            $modelo,\n            $usage['prompt_tokens'] ?? 0,\n            $usage['completion_tokens'] ?? 0,\n            $metadata_adicional ?: null\n        );\n\n        // Generar huella digital\n        $huella_peticion = null;\n\n        if ($payload_peticion) {\n            $huella_peticion = hash('sha256', $payload_peticion);\n        }\n\n        // Determinar estado de la respuesta\n        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n        $estado = 'exitoso';\n\n        if (isset($respuesta_ia['status_code'])) {\n            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n        } elseif (isset($respuesta_ia['error'])) {\n            $estado = 'error';\n        }\n\n        // Preparar datos\n        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n        $contenido_respuesta = $respuesta_ia['data']\n            ?? $respuesta_ia['vacante']\n            ?? $respuesta_ia['preguntas']\n            ?? $respuesta_ia['pruebas']\n            ?? $respuesta_ia['calificacion']\n            ?? null;\n\n        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n        if ($contenido_respuesta === null) {\n            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n        }\n\n        $datos = [\n            'usuario_id'         => $usuario_id,\n            'empresa_id'         => $empresa_id,\n            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n            'creditos'           => $contexto['creditos'] ?? 0,\n            'ruta_endpoint'      => $ruta_endpoint,\n            'nombre_servicio'    => $usage['service_name'] ?? null,\n            'modelo'             => $modelo,\n            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n            'caracteres_entrada' => $usage['input_chars'] ?? null,\n            'costo_estimado_usd' => $costo_estimado,\n            'huella_peticion'    => $huella_peticion,\n            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n            'estado'             => $estado,\n            'latencia_ms'        => $latencia_ms,\n            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n            'agenda_id'          => $contexto['agenda_id'] ?? null,\n            'vacante_id'         => $vacante_id\n        ];\n\n        return $this->repositorio->crear($datos);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param array $filtros Filtros de fecha.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n        $desde = null;\n        $hasta = null;\n\n        if (!empty($filtros['desde'])) {\n            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n        }\n\n        if (!empty($filtros['hasta'])) {\n            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n        }\n\n        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n\n        return $consumos->map(function (ConsumoCredito $consumo) {\n            $servicio = $consumo->servicioIA?->nombre\n                ?? $consumo->nombre_servicio\n                ?? $consumo->ruta_endpoint;\n\n            return [\n                'usuario'        => $consumo->usuario ? [\n                    'id'              => $consumo->usuario->id,\n                    'nombre_completo' => $consumo->usuario->nombre_completo\n                ] : null,\n                'servicio'       => $servicio,\n                'creditos'       => $consumo->creditos ?? 0,\n                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n                'fecha_consumo'  => $consumo->created_at\n            ];\n        });\n    }\n}\n","structuredPatch":[{"oldStart":18,"oldLines":13,"newStart":18,"newLines":15,"lines":["      *","      * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.","      * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.","+     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.","      * @return void","      * @author Sergio Vargas","      * @author Daniel Beltrán","      */","     public function __construct(","         ConsumoCreditoRepository $repositorio,","-        private readonly ServicioPrecioTokenService $precio_token_servicio","+        private readonly ServicioPrecioTokenService $precio_token_servicio,","+        private readonly EmpresaPlanRepository $empresa_plan_repositorio","     ) {","         parent::__construct($repositorio);","     }"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"a93fed5b-12df-459b-846c-5ec1db7779c7"}
{"parentUuid":"debfcdf3-1cac-4598-aa28-44b7f05951b3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_014oBR12VeFcGo4SsVVvwNJj","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito agregar la lógica de validación al final de `registrarConsumoDesdeRespuesta`. Voy a agregar antes del `return $ultimo_registro;`.","signature":"ErsCCkYICxgCKkDoFEPOywQfnWP+4JR5O+YnhSK4hgVa1HomndBl//hkPcAPiiRGizKlkJu9TtEWos3+EU5ExLNZyb9zLj9W4ZTqEgyEf7p3aGIMMglzDe0aDNM0HMgKrSopQVEprCIwEfRifU18fNnSLKvHizRsHAt1qJEDm0gpPi7l0qNC7JVOW/AbSdAXb3pKP87We8k2KqIBqVeR0MZcINCYQA2wNH9O2Mqx7GlzM9f7DItFWOubJVd1PTWnIc/fgJZ+d+By2/OSKtMyIn6LjbqnSUd18VtBqocem2BWVSDlRXHiwu/zsx26z5NXHzNoGn8UV1BZ8Kx2zb0SSEeS8LH3MSltQJJMUROEy0VNghJHyZZWFgu+u5ACs7fElb1eqqbJsTAPYPxjyxJHfo7CoQ+ETaGNHfayhpAgGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":901,"cache_read_input_tokens":74623,"cache_creation":{"ephemeral_5m_input_tokens":901,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXP2pPoZw1igym5CBDgVE","type":"assistant","uuid":"d9b74729-5d02-4854-95ce-9c8e1c277067","timestamp":"2026-01-22T20:16:40.898Z"}
{"parentUuid":"d9b74729-5d02-4854-95ce-9c8e1c277067","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_014oBR12VeFcGo4SsVVvwNJj","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora agrego la lógica de validación al final de la función `registrarConsumoDesdeRespuesta`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":901,"cache_read_input_tokens":74623,"cache_creation":{"ephemeral_5m_input_tokens":901,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXP2pPoZw1igym5CBDgVE","type":"assistant","uuid":"485e5200-9916-412b-9422-d691c8850be3","timestamp":"2026-01-22T20:16:41.185Z"}
{"parentUuid":"485e5200-9916-412b-9422-d691c8850be3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_014oBR12VeFcGo4SsVVvwNJj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012J5JtAf51ugmTVS9msfnue","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","old_string":"        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        return $ultimo_registro;\n    }","new_string":"        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos($contexto);\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * - Si quedan 0 créditos → estado Vencido\n     * - Si quedan menos del 20% → estado Por vencer\n     *\n     * @param array $contexto Contexto con empresa_plan_id.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n\n        if (!$empresa_plan_id) {\n            return;\n        }\n\n        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n\n        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n            return;\n        }\n\n        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n\n        if ($creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":901,"cache_read_input_tokens":74623,"cache_creation":{"ephemeral_5m_input_tokens":901,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXP2pPoZw1igym5CBDgVE","type":"assistant","uuid":"5e03b1e5-caf8-471e-a991-befbe7f76b04","timestamp":"2026-01-22T20:16:51.031Z"}
{"parentUuid":"5e03b1e5-caf8-471e-a991-befbe7f76b04","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012J5JtAf51ugmTVS9msfnue","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    88→                latencia_ms: $latencia_ms\n    89→            );\n    90→        }\n    91→\n    92→        // Fallback: Si solo hay \"usage\" (formato legacy)\n    93→        $usage_legacy = $respuesta_ia['usage'] ?? null;\n    94→\n    95→        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n    96→            $ultimo_registro = $this->registrarConsumoIndividual(\n    97→                ruta_endpoint: $ruta_endpoint,\n    98→                usage: $usage_legacy,\n    99→                respuesta_ia: $respuesta_ia,\n   100→                usuario_id: $usuario_id,\n   101→                empresa_id: $empresa_id,\n   102→                contexto: $contexto,\n   103→                payload_peticion: $payload_peticion,\n   104→                latencia_ms: $latencia_ms\n   105→            );\n   106→        }\n   107→\n   108→        // Validar y actualizar estado del plan según créditos restantes\n   109→        $this->actualizarEstadoPlanSegunCreditos($contexto);\n   110→\n   111→        return $ultimo_registro;\n   112→    }\n   113→\n   114→    /**\n   115→     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n   116→     *\n   117→     * - Si quedan 0 créditos → estado Vencido\n   118→     * - Si quedan menos del 20% → estado Por vencer\n   119→     *\n   120→     * @param array $contexto Contexto con empresa_plan_id.\n   121→     * @return void\n   122→     * @author Andres Gonzalez\n   123→     */\n   124→    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n   125→        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n   126→\n   127→        if (!$empresa_plan_id) {\n   128→            return;\n   129→        }\n   130→\n   131→        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n   132→\n   133→        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n   134→            return;\n   135→        }\n   136→\n   137→        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n   138→        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n   139→\n   140→        if ($creditos_plan <= 0) {\n   141→            return;\n   142→        }\n   143→\n   144→        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n   145→\n   146→        if ($creditos_disponibles <= 0) {\n   147→            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n   148→        } elseif ($porcentaje_restante < 20) {\n   149→            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n   150→        }\n   151→    }\n   152→\n   153→    /**\n   154→     * Registra un consumo individual de tokens desde una metadata de uso específica.\n   155→     *"}]},"uuid":"c28220fc-5859-4be5-9405-f606fbdc4e72","timestamp":"2026-01-22T20:16:57.774Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","oldString":"        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        return $ultimo_registro;\n    }","newString":"        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos($contexto);\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * - Si quedan 0 créditos → estado Vencido\n     * - Si quedan menos del 20% → estado Por vencer\n     *\n     * @param array $contexto Contexto con empresa_plan_id.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n\n        if (!$empresa_plan_id) {\n            return;\n        }\n\n        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n\n        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n            return;\n        }\n\n        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n\n        if ($creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(\n        string $ruta_endpoint,\n        array $respuesta_ia,\n        ?int $usuario_id = null,\n        ?int $empresa_id = null,\n        ?array $contexto = [],\n        ?string $payload_peticion = null,\n        ?int $latencia_ms = null\n    ): ?ConsumoCredito {\n        // Detectar si hay múltiples metadata de uso (formato nuevo)\n        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n        $ultimo_registro = null;\n\n        // Registrar Whisper si existe\n        if ($uso_whisper) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.whisper',\n                usage: $uso_whisper,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Registrar GPT si existe\n        if ($uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.gpt',\n                usage: $uso_gpt,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado.\n     * @param array $usage Metadata de uso específica.\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function registrarConsumoIndividual(\n        string $ruta_endpoint,\n        array $usage,\n        array $respuesta_ia,\n        ?int $usuario_id,\n        ?int $empresa_id,\n        array $contexto,\n        ?string $payload_peticion,\n        ?int $latencia_ms\n    ): ?ConsumoCredito {\n        $vacante_id = $contexto['vacante_id'] ?? null;\n\n        if (!$vacante_id && $payload_peticion) {\n            $decoded = json_decode($payload_peticion, true);\n\n            if (is_array($decoded)) {\n                $vacante_id = data_get($decoded, 'vacante_id')\n                    ?? data_get($decoded, 'vacanteId')\n                    ?? data_get($decoded, 'id')\n                    ?? data_get($decoded, 'vacante.id');\n\n                if ($vacante_id && !is_numeric($vacante_id)) {\n                    $vacante_id = null;\n                } elseif (is_numeric($vacante_id)) {\n                    $vacante_id = (int) $vacante_id;\n                }\n            }\n        }\n\n        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n        $modelo = $usage['model'] ?? 'desconocido';\n\n        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n        $metadata_adicional = [];\n\n        if (isset($usage['audio_duration_minutes'])) {\n            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n        }\n\n        if (isset($usage['audio_duration_seconds'])) {\n            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n        }\n\n        // Calcular costo estimado (pasando metadata adicional para Whisper)\n        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n            $modelo,\n            $usage['prompt_tokens'] ?? 0,\n            $usage['completion_tokens'] ?? 0,\n            $metadata_adicional ?: null\n        );\n\n        // Generar huella digital\n        $huella_peticion = null;\n\n        if ($payload_peticion) {\n            $huella_peticion = hash('sha256', $payload_peticion);\n        }\n\n        // Determinar estado de la respuesta\n        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n        $estado = 'exitoso';\n\n        if (isset($respuesta_ia['status_code'])) {\n            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n        } elseif (isset($respuesta_ia['error'])) {\n            $estado = 'error';\n        }\n\n        // Preparar datos\n        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n        $contenido_respuesta = $respuesta_ia['data']\n            ?? $respuesta_ia['vacante']\n            ?? $respuesta_ia['preguntas']\n            ?? $respuesta_ia['pruebas']\n            ?? $respuesta_ia['calificacion']\n            ?? null;\n\n        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n        if ($contenido_respuesta === null) {\n            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n        }\n\n        $datos = [\n            'usuario_id'         => $usuario_id,\n            'empresa_id'         => $empresa_id,\n            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n            'creditos'           => $contexto['creditos'] ?? 0,\n            'ruta_endpoint'      => $ruta_endpoint,\n            'nombre_servicio'    => $usage['service_name'] ?? null,\n            'modelo'             => $modelo,\n            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n            'caracteres_entrada' => $usage['input_chars'] ?? null,\n            'costo_estimado_usd' => $costo_estimado,\n            'huella_peticion'    => $huella_peticion,\n            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n            'estado'             => $estado,\n            'latencia_ms'        => $latencia_ms,\n            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n            'agenda_id'          => $contexto['agenda_id'] ?? null,\n            'vacante_id'         => $vacante_id\n        ];\n\n        return $this->repositorio->crear($datos);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param array $filtros Filtros de fecha.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n        $desde = null;\n        $hasta = null;\n\n        if (!empty($filtros['desde'])) {\n            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n        }\n\n        if (!empty($filtros['hasta'])) {\n            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n        }\n\n        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n\n        return $consumos->map(function (ConsumoCredito $consumo) {\n            $servicio = $consumo->servicioIA?->nombre\n                ?? $consumo->nombre_servicio\n                ?? $consumo->ruta_endpoint;\n\n            return [\n                'usuario'        => $consumo->usuario ? [\n                    'id'              => $consumo->usuario->id,\n                    'nombre_completo' => $consumo->usuario->nombre_completo\n                ] : null,\n                'servicio'       => $servicio,\n                'creditos'       => $consumo->creditos ?? 0,\n                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n                'fecha_consumo'  => $consumo->created_at\n            ];\n        });\n    }\n}\n","structuredPatch":[{"oldStart":105,"oldLines":10,"newStart":105,"newLines":52,"lines":["             );","         }"," ","+        // Validar y actualizar estado del plan según créditos restantes","+        $this->actualizarEstadoPlanSegunCreditos($contexto);","+","         return $ultimo_registro;","     }"," ","     /**","+     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.","+     *","+     * - Si quedan 0 créditos → estado Vencido","+     * - Si quedan menos del 20% → estado Por vencer","+     *","+     * @param array $contexto Contexto con empresa_plan_id.","+     * @return void","+     * @author Andres Gonzalez","+     */","+    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {","+        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;","+","+        if (!$empresa_plan_id) {","+            return;","+        }","+","+        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);","+","+        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {","+            return;","+        }","+","+        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;","+        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;","+","+        if ($creditos_plan <= 0) {","+            return;","+        }","+","+        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;","+","+        if ($creditos_disponibles <= 0) {","+            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);","+        } elseif ($porcentaje_restante < 20) {","+            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);","+        }","+    }","+","+    /**","      * Registra un consumo individual de tokens desde una metadata de uso específica.","      *","      * @param string $ruta_endpoint Ruta del endpoint llamado."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"5e03b1e5-caf8-471e-a991-befbe7f76b04"}
{"parentUuid":"c28220fc-5859-4be5-9405-f606fbdc4e72","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Cq91jnT1Hnw8rzEXhsJjFm","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Listo. He agregado la validación al final de `registrarConsumoDesdeRespuesta`. La lógica:\n\n1. Después de registrar el consumo, llama a `actualizarEstadoPlanSegunCreditos`\n2. Esta función obtiene el `empresa_plan_id` del contexto\n3. Busca el plan de empresa y verifica que sea un plan de créditos\n4. Calcula el porcentaje restante: `creditos_disponibles / creditos_plan * 100`\n5. Si quedan 0 créditos → actualiza a ESTADO_VENCIDO_ID (5)\n6. Si quedan menos del 20% → actualiza a ESTADO_POR_VENCER_ID (4)\n\nEl atributo `creditos_restantes` ya existe en el modelo `EmpresaPlan` y calcula automáticamente los créditos disponibles restando los consumos.","signature":"ErgGCkYICxgCKkDEF6rPWeBhyXz9NBiowjA9tVrSsl6jfWBVEkOxSq4LIr0BbzPJ5ef6PS0R4wGoU+oivdAyvuXCr7EcNt9yc/HGEgwlqF60JyqS43TSGNgaDBaiOuRmxMGl9IcJWSIw/NxPl0qQ140aOVXpUkGIluLr/xUtZBTCAZ7ajQqGxJUOwoQQlABVgs7KhxmLt+4IKp8FSBcoBL6f/K0fFb7mcmgdIoWjeiPz6GNSEX0RwA0HjdALQFCNZfQ60ESkpmrN6Tqyw3OKJZKXyyjY8b25x/pvSatFzUbUrKswH6znvMlQUHzJbJkjwirQh5EYMHV+LPpSlcg+CZDjKIOwFBB1DILpY1ua/ocqrNRkVWgEMH9p65bxEbwOOMIVST50zAgAocQ3BUa0+rttybmaVlnQz6O3g7K/n1AihvqgpejlvSvZroLCo30xl766lWpv3cRu8TAJQlb4n07NOZlpCIxPhyFaSzRJSpzL/NGM5ra1mZV4XMwMZm66bdyNLqgIFq+oIYFXsD9X6+1PC88gb8H9XTtImRyivqq6xsJtMnpF+f+/iWDv4wtAIw4zccpoaaowFrSMq69bE5XtzcCNIFkzXHItu2DiN2kZEB8QgOKfeHo0BQeASK4Pq3aYt0bChwyyxvewGINbMoCOXwBX0lxugnEOyYRFfyWrVltA2GJuymN3Sdg/zpfBcERW9AktisJrt3kcH7bva0YRUfC80/0QZATrEqxRS/gwctT9kGZrbCqVlMUXyXgeSZJeM/2a9MKF5Xzy2jFZuTRLqzysMMIsEjDM4OiEmY5oDAd6reUbNYQHsexAUUC55mjOHm0sivl4DK+1AuOGLYIHed9s9vZqJBY8c7H7+iIDSyBeqPHqsidisKHSsVSQ6YwJFNpqrW+/CtbHjlf1rftTAFu6YmykWUWgglTx3y5LZXHI/Qi2aBHdiESuO57PJH8q+1vwooxpYOU/o9vTms4ZEIP5uni5x6JDCWM47b8BT/Ka0iM6kyRX37EQinS26hqVdvTEix46DPHrr3DQg2tL/A1d3yJFTPlRcOuuAAwkxAa19K44vrMGoiF9dZYEjuK/qCpqx86G4UIYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2177,"cache_read_input_tokens":75524,"cache_creation":{"ephemeral_5m_input_tokens":2177,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2qz67QgkfNesUyNa3v","type":"assistant","uuid":"ccbf397d-e358-4960-aad9-0d6eb4f3e5bc","timestamp":"2026-01-22T20:17:05.605Z"}
{"parentUuid":"ccbf397d-e358-4960-aad9-0d6eb4f3e5bc","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Cq91jnT1Hnw8rzEXhsJjFm","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He agregado la validación en [ConsumoCreditoService.php](app/Http/Services/IA/ConsumoCreditoService.php).\n\n**Resumen de cambios:**\n\n1. **Imports agregados** (líneas 7 y 12):\n   - `App\\Models\\Planes\\Plan` - para las constantes de estado\n   - `App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository`\n\n2. **Constructor actualizado** (línea 29):\n   - Inyectado `EmpresaPlanRepository $empresa_plan_repositorio`\n\n3. **Llamada a validación** (línea 109):\n   - Al final de `registrarConsumoDesdeRespuesta` se llama `actualizarEstadoPlanSegunCreditos`\n\n4. **Nueva función `actualizarEstadoPlanSegunCreditos`** (líneas 114-151):\n   - Obtiene el plan de empresa del contexto\n   - Calcula el porcentaje: `creditos_disponibles / creditos_plan * 100`\n   - Si `creditos_disponibles <= 0` → estado **Vencido** (5)\n   - Si `porcentaje < 20%` → estado **Por vencer** (4)\n\nLa función usa el atributo `creditos_restantes` del modelo `EmpresaPlan` que ya calcula automáticamente los créditos disponibles."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2177,"cache_read_input_tokens":75524,"cache_creation":{"ephemeral_5m_input_tokens":2177,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP2qz67QgkfNesUyNa3v","type":"assistant","uuid":"5e960a81-fb0a-4648-8868-a326272b5e9c","timestamp":"2026-01-22T20:17:10.166Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T20:20:27.108Z","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb"}
{"type":"file-history-snapshot","messageId":"fc3fa474-be43-484f-b2c7-87331b9bc96e","snapshot":{"messageId":"fc3fa474-be43-484f-b2c7-87331b9bc96e","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v3","version":3,"backupTime":"2026-01-22T20:15:47.092Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v3","version":3,"backupTime":"2026-01-22T20:15:47.109Z"},"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"04cb3be0b984b422@v2","version":2,"backupTime":"2026-01-22T19:02:14.825Z"},"app\\Http\\Services\\IA\\ConsumoCreditoService.php":{"backupFileName":"3e939a737c702ece@v2","version":2,"backupTime":"2026-01-22T20:20:29.242Z"}},"timestamp":"2026-01-22T20:20:29.227Z"},"isSnapshotUpdate":false}
{"parentUuid":"03c7aba7-abcf-4ed1-b963-fa61f96760d8","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01F1Gzf31LpqC9bgfXLvxoaQ","parentToolUseID":"toolu_01F1Gzf31LpqC9bgfXLvxoaQ","uuid":"6b844904-f7e7-4ef4-99bb-eb2b521822e7","timestamp":"2026-01-22T20:15:55.020Z"}
{"parentUuid":"eac7b333-a60c-4063-a6b0-8467de1af88b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01VYcAodFY8jtaPkfwJG73xi","parentToolUseID":"toolu_01VYcAodFY8jtaPkfwJG73xi","uuid":"ea4a83ce-01c0-4d9a-9157-364fda53440a","timestamp":"2026-01-22T20:16:18.105Z"}
{"parentUuid":"ea4a83ce-01c0-4d9a-9157-364fda53440a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01VYcAodFY8jtaPkfwJG73xi","parentToolUseID":"toolu_01VYcAodFY8jtaPkfwJG73xi","uuid":"f986bc17-0411-4fc5-837f-971cf79074bb","timestamp":"2026-01-22T20:16:18.106Z"}
{"parentUuid":"654821ed-d20d-47c1-95ac-571d337a80ea","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01VYcAodFY8jtaPkfwJG73xi","toolUseID":"toolu_01VYcAodFY8jtaPkfwJG73xi","timestamp":"2026-01-22T20:16:22.128Z","uuid":"2ecac09f-7786-4a48-9acc-8fb34c1ed07b"}
{"parentUuid":"a93fed5b-12df-459b-846c-5ec1db7779c7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01KYAsBx6GQdFMnznGnpvvWj","parentToolUseID":"toolu_01KYAsBx6GQdFMnznGnpvvWj","uuid":"a8448e49-4120-4cff-8b0f-d433e82dc923","timestamp":"2026-01-22T20:16:30.583Z"}
{"parentUuid":"a8448e49-4120-4cff-8b0f-d433e82dc923","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01KYAsBx6GQdFMnznGnpvvWj","parentToolUseID":"toolu_01KYAsBx6GQdFMnznGnpvvWj","uuid":"36354379-d0ac-4d31-87bf-5c216ac83a5c","timestamp":"2026-01-22T20:16:30.584Z"}
{"parentUuid":"debfcdf3-1cac-4598-aa28-44b7f05951b3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01KYAsBx6GQdFMnznGnpvvWj","toolUseID":"toolu_01KYAsBx6GQdFMnznGnpvvWj","timestamp":"2026-01-22T20:16:36.755Z","uuid":"33b72c79-ee09-49b5-80a6-68df8b5e6ef2"}
{"parentUuid":"5e03b1e5-caf8-471e-a991-befbe7f76b04","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_012J5JtAf51ugmTVS9msfnue","parentToolUseID":"toolu_012J5JtAf51ugmTVS9msfnue","uuid":"09f4bec3-5b36-45a9-8b14-47bc69f7b879","timestamp":"2026-01-22T20:16:51.213Z"}
{"parentUuid":"09f4bec3-5b36-45a9-8b14-47bc69f7b879","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_012J5JtAf51ugmTVS9msfnue","parentToolUseID":"toolu_012J5JtAf51ugmTVS9msfnue","uuid":"73319cd1-434b-4e13-9024-7196955a2653","timestamp":"2026-01-22T20:16:51.213Z"}
{"parentUuid":"c28220fc-5859-4be5-9405-f606fbdc4e72","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_012J5JtAf51ugmTVS9msfnue","toolUseID":"toolu_012J5JtAf51ugmTVS9msfnue","timestamp":"2026-01-22T20:16:57.775Z","uuid":"ee0d9632-edc5-493c-8e43-c39331a871fa"}
{"parentUuid":"5e960a81-fb0a-4648-8868-a326272b5e9c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 128 to 128 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php:\nempresa_plan\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"no le pases el contexto tienes que utilizar esta funcion function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array { de app\\Http\\Services\\Empresas\\EmpresaPlanService.php y pasarle el id d ela empresa y eso deblbe esto \"empresa_id\": 2,\n    \"empresa_plan_id\": 2,\n    \"creditos_plan\": 300,\n    \"creditos_disponibles\": 1,\n    \"plan_credito\": {\n      \"id\": 3,\n      \"nombre\": \"Plan 300\",\n      \"creditos\": 300,\n      \"precio\": \"300.00\"\n    } y para obtenr el id de la empresa existe una funcion que dice obtenr empresa actual"}]},"uuid":"fc3fa474-be43-484f-b2c7-87331b9bc96e","timestamp":"2026-01-22T20:20:29.209Z","permissionMode":"default"}
{"parentUuid":"fc3fa474-be43-484f-b2c7-87331b9bc96e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GbU8HPmTbFtkPFeTu4bUn1","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que use la función `creditosDisponiblesEmpresa` del `EmpresaPlanService` en lugar de pasar el contexto directamente. También menciona que existe una función para obtener la empresa actual.\n\nNecesito:\n1. Buscar la función para obtener la empresa actual\n2. Inyectar el `EmpresaPlanService` en lugar de usar el repositorio directamente\n3. Modificar la función `actualizarEstadoPlanSegunCreditos` para usar `creditosDisponiblesEmpresa`\n\nPrimero voy a buscar la función para obtener la empresa actual.","signature":"Eq4FCkYICxgCKkCu2T7N/qlUNeWIaIH7/LMtTAL/e/y4GxtP9GM73b8ge/39gflQlp81QN/YCRlT/FcbYQ6dOr4ybxDzpMatO/d1EgwZ2JVH8obyDMk857saDHtXcuWTIgYHJ0jcqiIwAcJEc4s5V/i6qwDr9c9O1hdnMAJe/65z4/uNYamcyqx4ttdcxnfi2wMTgzMr10WdKpUEg7tdnQDxzfLMJgwbheijBZEhvoE+lr/qCHgy4Lj1h09UfHUEaJAC579wMvJFG2BHL90X7u9cYX37Pv4dBk0wVc3MVlnGSQmEDjwntp0+/uiARm6lhG0qPKUvcLABFix326480gYEVtGw95pWtlR/lfKYZ/U+GLnLG0Pw25gKGpoooisIdYsbJ1LBNb8BAoTurptUZsnmlTNad4A0aSv7ap0pRWsTu255DjYWVwKii1igPZjFMNtdWE1wH5Sv+AI5A/iPsgOxd+oJ//ur3jtpOOkq/ObQpH07j7HvwzF/U8p0Ur3c+6A0tPDbt//LXfE53F941oqa1QQd0OysOel5DdbIY9d/Z2kqY8XnKRWGpDK2jt18kWLjzb/iGW85FQ0Og2rFKa6Gty7d277SK3mLjzs8U/QZere3th1cpdAWWEKuARMtyGQ7az++gCsLcsVW3b3h5itQdoUA9x+iIBzxOpoE2M6vVI0jaXqvZ/LeBh1leo/98a0VdOcFc+1BaMn4I86/5hUkXDQ6xY0X5t0Py3W/Zz4HOGTqkj3fszbTH5ZocYfOsiibNA63/b/dSvD84YTUIMGiRGTZMvVbDkQACyqbtWwA3obUAZt8+05X7Ur4bmDuIebp4c6YosMkAnuOonn5gX3gQ12a1LIVIt0ma+UjvoXlApfqdikY9TrlCfZsb5VR/GfeMoz08b4SubqMbceqYGoYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":4715,"cache_read_input_tokens":77701,"cache_creation":{"ephemeral_5m_input_tokens":4715,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP37T8UA2JsoDM7oAyDZ","type":"assistant","uuid":"273d9d13-1711-4683-b9e3-cdf1fa481fa2","timestamp":"2026-01-22T20:20:33.882Z"}
{"parentUuid":"273d9d13-1711-4683-b9e3-cdf1fa481fa2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GbU8HPmTbFtkPFeTu4bUn1","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a buscar la función para obtener la empresa actual y luego modificar el código."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":4715,"cache_read_input_tokens":77701,"cache_creation":{"ephemeral_5m_input_tokens":4715,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP37T8UA2JsoDM7oAyDZ","type":"assistant","uuid":"ad94631c-a77a-471d-b566-3830b21e5a71","timestamp":"2026-01-22T20:20:34.671Z"}
{"parentUuid":"ad94631c-a77a-471d-b566-3830b21e5a71","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GbU8HPmTbFtkPFeTu4bUn1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ag7kPDbg1GyiTo6bNpKzG5","name":"Grep","input":{"pattern":"obtener.*empresa.*actual|empresaActual","-i":true,"output_mode":"content","head_limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":4715,"cache_read_input_tokens":77701,"cache_creation":{"ephemeral_5m_input_tokens":4715,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXP37T8UA2JsoDM7oAyDZ","type":"assistant","uuid":"7ff1a8e3-128a-4707-9afe-c011e917f51e","timestamp":"2026-01-22T20:20:35.608Z"}
{"parentUuid":"7ff1a8e3-128a-4707-9afe-c011e917f51e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ag7kPDbg1GyiTo6bNpKzG5","type":"tool_result","content":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:187:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:200:            'pruebas_plan_activo_seleccion' => $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id, TipoPrueba::SELECCION_ID),\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:228:            $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:403:        $empresa  = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:518:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:656:        $empresa          = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\PruebaTecnicaService.php:87:        $empresa          = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php:131:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteService.php:143:        $empresa       = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\DocumentoSolicitableService.php:40:        $empresa          = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Usuarios\\UserService.php:597:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\public\\js\\globales.js:1403: * Obtener créditos disponibles de la empresa y actualizar el tag.\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PruebaService.php:605:        $empresa      = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PerfilService.php:178:        $empresa_actual = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PerfilService.php:258:        $empresa      = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PerfilService.php:387:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PerfilService.php:390:            throw new Exception('No se pudo obtener la empresa actual del usuario');\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php:135:                'empresa_id'   => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id,\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Planes\\ConsumoService.php:212:            : $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\OrdenesServicios\\OrdenServicioEnlaceCreacionService.php:39:            $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n[Showing results with pagination = limit: 20, offset: 0]"}]},"uuid":"897d29bd-0e0c-45dc-9327-4b23c390ab1d","timestamp":"2026-01-22T20:20:37.899Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:187:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:200:            'pruebas_plan_activo_seleccion' => $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id, TipoPrueba::SELECCION_ID),\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:228:            $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:403:        $empresa  = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:518:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\VacanteService.php:656:        $empresa          = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\PruebaTecnicaService.php:87:        $empresa          = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteUsuarioService.php:131:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\EtapaVacanteService.php:143:        $empresa       = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Vacantes\\DocumentoSolicitableService.php:40:        $empresa          = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Usuarios\\UserService.php:597:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\public\\js\\globales.js:1403: * Obtener créditos disponibles de la empresa y actualizar el tag.\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PruebaService.php:605:        $empresa      = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PerfilService.php:178:        $empresa_actual = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PerfilService.php:258:        $empresa      = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PerfilService.php:387:        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Pruebas\\PerfilService.php:390:            throw new Exception('No se pudo obtener la empresa actual del usuario');\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php:135:                'empresa_id'   => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id,\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Planes\\ConsumoService.php:212:            : $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\nc:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\OrdenesServicios\\OrdenServicioEnlaceCreacionService.php:39:            $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();","numLines":20,"appliedLimit":20},"sourceToolAssistantUUID":"7ff1a8e3-128a-4707-9afe-c011e917f51e"}
{"parentUuid":"897d29bd-0e0c-45dc-9327-4b23c390ab1d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NBFBJFkF6qzgVZPrL9m3Gb","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Veo que se usa `$this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()`. Necesito:\n\n1. Inyectar `EmpresaUsuarioRepository` para obtener la empresa actual\n2. Inyectar `EmpresaPlanService` para usar `creditosDisponiblesEmpresa`\n3. Modificar la función `actualizarEstadoPlanSegunCreditos`\n\nVoy a leer el archivo actual para ver qué necesito modificar.","signature":"Eo4ECkYICxgCKkDG+QiPgAIfE4sndCqF+NspnusS1jk2NWu2lKFjpjObGGlK8NK7Xp6XlN32vl1rudvEmhfSajwZfgDRk3RJZzLoEgzIyjUPmGi2GtbQcgoaDAHVQYYEGVfHxDGkayIw7rgvaB9cfeS9HPKSsw/zj0JaXQQdifuwh9Z8d9yDGqF7vxRGWr8lDasuqWKpdIfjKvUCsemdNaZ7NNIbEFWxgqvThYTV1VA2QuBXFX0UsWVEmMzPHB2PeB1f2QlzsUELCrPhycO7dcdRpb2H2MKPlxHtXn61A6dc8b/nQ7Ts3STSS0IU8sMAlIKLIOrBe6wLIzlMjiSSOrSdQjHDVnpfeqSKzoAbneXN4K1+N0wcibrW5MjF/brGqT5oQ+eeirKbbjepXaxW6orNKfG3J6NGMu5UA0zAFl0vYbRu6rtDRlwMBDnYyjjom/HHyf+Krq5iexYCdwVhFEffPw2udbCmDJ0PAqoLObEPBEZ3rQi6UzGh0ycsfgvoTfh4oTiyoh/09JgcvLS9Lv47h4lsM5+p7ZMOsGK+FI2p7kIDf7jGfRlmQMPuvlI4Yxm6cEJeQtdCxPSy6EAAOK62tOw+oyeV/Ux6vDLZPwwzAoj/3I01odXU1+GosQRa5Q6EaOxkxgSXassg1XZU4WM0qN4mTLGFmGTNZY+cv97SkAEzaptq9fIo/WUkQVk7QRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1610,"cache_read_input_tokens":82416,"cache_creation":{"ephemeral_5m_input_tokens":1610,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXP386mPpaTz6jA4jsdqX","type":"assistant","uuid":"a61be6da-a336-4a9b-bc86-fb4c9c8c68f7","timestamp":"2026-01-22T20:20:42.231Z"}
{"parentUuid":"a61be6da-a336-4a9b-bc86-fb4c9c8c68f7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NBFBJFkF6qzgVZPrL9m3Gb","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a modificar el código para usar `EmpresaPlanService` y `EmpresaUsuarioRepository`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1610,"cache_read_input_tokens":82416,"cache_creation":{"ephemeral_5m_input_tokens":1610,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXP386mPpaTz6jA4jsdqX","type":"assistant","uuid":"1c587551-4b0d-4244-ac07-94e85eeca560","timestamp":"2026-01-22T20:20:42.779Z"}
{"parentUuid":"1c587551-4b0d-4244-ac07-94e85eeca560","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NBFBJFkF6qzgVZPrL9m3Gb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UoATByeTG3C1No9E6xgDRw","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1610,"cache_read_input_tokens":82416,"cache_creation":{"ephemeral_5m_input_tokens":1610,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXP386mPpaTz6jA4jsdqX","type":"assistant","uuid":"70200a34-b40e-4ac0-8744-d15f67fd0a99","timestamp":"2026-01-22T20:20:43.345Z"}
{"parentUuid":"70200a34-b40e-4ac0-8744-d15f67fd0a99","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UoATByeTG3C1No9E6xgDRw","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use Illuminate\\Support\\Str;\n     7→use App\\Models\\Planes\\Plan;\n     8→use App\\Models\\IA\\ConsumoCredito;\n     9→use App\\Http\\Services\\BaseService;\n    10→use Illuminate\\Support\\Collection;\n    11→use App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n    12→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    13→\n    14→class ConsumoCreditoService extends BaseService\n    15→{\n    16→    /**\n    17→     * Constructor.\n    18→     *\n    19→     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n    20→     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n    21→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n    22→     * @return void\n    23→     * @author Sergio Vargas\n    24→     * @author Daniel Beltrán\n    25→     */\n    26→    public function __construct(\n    27→        ConsumoCreditoRepository $repositorio,\n    28→        private readonly ServicioPrecioTokenService $precio_token_servicio,\n    29→        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    30→    ) {\n    31→        parent::__construct($repositorio);\n    32→    }\n    33→\n    34→    /**\n    35→     * Registra el consumo de tokens desde la respuesta de la API de IA.\n    36→     *\n    37→     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n    38→     *\n    39→     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n    40→     * @param array $respuesta_ia Respuesta completa de la API de IA.\n    41→     * @param ?int $usuario_id ID del usuario que realizó la petición.\n    42→     * @param ?int $empresa_id ID de la empresa del usuario.\n    43→     * @param array $contexto Array con agenda_id, vacante_id, etc.\n    44→     * @param ?string $payload_peticion JSON del payload enviado.\n    45→     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n    46→     * @return ?ConsumoCredito\n    47→     * @author Sergio Vargas\n    48→     * @author Daniel Beltrán\n    49→     */\n    50→    public function registrarConsumoDesdeRespuesta(\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"17d219ce-ec04-4417-91c4-4e58d13832f2","timestamp":"2026-01-22T20:20:44.793Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","content":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(","numLines":50,"startLine":1,"totalLines":314}},"sourceToolAssistantUUID":"70200a34-b40e-4ac0-8744-d15f67fd0a99"}
{"parentUuid":"17d219ce-ec04-4417-91c4-4e58d13832f2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GmNRVZWKThCRGSYUewP9PW","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito modificar:\n1. Cambiar imports: quitar EmpresaPlanRepository, agregar EmpresaPlanService, EmpresaUsuarioRepository, Request\n2. Modificar constructor\n3. Modificar la función actualizarEstadoPlanSegunCreditos","signature":"EoMDCkYICxgCKkA0YJdkMSwYWL5E5hIUWG36MYcInWY5G0B48o6XKjNmPx9R3Q0c5Ol/db0qg3QkCLtDd27WENwKsNdr0BNWAuzfEgyBJtTmaRGgWQg5oOwaDPQj5qSjUVpCzLMY2SIwSuM1VHhQYwcWltGKM8NcsDYe7JCDwegbXlDcEDGFu5R2rjTRwNfhLuOKrS6xEs1VKuoBv+9wFeQV9fC0A/51MoMeeJmDNhhJeGEjNvcdUC3G2UxOFKXtHdrcCWUUgVIGfDhnxPIv0Ghj2E+tWW020zz+doTIw3B7PGTWYBRCKuMHcXIsPB4bwQiAB9YrjoXEKDau2TbRJSY8GNULg9uRLeajMsMdumZLZhbTadu6SRW/WmjGuZkcPObLDb07YlyiHKEA3kkJOj6zaf5E3EqUe6oRmT3K3g34Eg0826fW0ZOAsX6WUh9hCr81Xncrxi31Af6OWC5gyVqbFd+tcnJN8pX5b3RjmARwFGNlTrGZnSERdpcMqtBLL9xagauIGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1100,"cache_read_input_tokens":84026,"cache_creation":{"ephemeral_5m_input_tokens":1100,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP38bNqa9Ci9G9y1SsiD","type":"assistant","uuid":"ad33b3d5-7db2-43d4-a2db-6a51352725e2","timestamp":"2026-01-22T20:20:48.447Z"}
{"parentUuid":"ad33b3d5-7db2-43d4-a2db-6a51352725e2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GmNRVZWKThCRGSYUewP9PW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01H18wPEu8ynX1DhqWEWPnei","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","old_string":"use Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;","new_string":"use Carbon\\Carbon;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1100,"cache_read_input_tokens":84026,"cache_creation":{"ephemeral_5m_input_tokens":1100,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP38bNqa9Ci9G9y1SsiD","type":"assistant","uuid":"0232b453-b0ea-419a-b4c3-ea0222a65e3b","timestamp":"2026-01-22T20:20:51.684Z"}
{"parentUuid":"0232b453-b0ea-419a-b4c3-ea0222a65e3b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01H18wPEu8ynX1DhqWEWPnei","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\IA;\n     4→\n     5→use Carbon\\Carbon;\n     6→use Illuminate\\Http\\Request;\n     7→use Illuminate\\Support\\Str;\n     8→use App\\Models\\Planes\\Plan;\n     9→use App\\Models\\IA\\ConsumoCredito;\n    10→use App\\Http\\Services\\BaseService;\n    11→use Illuminate\\Support\\Collection;\n    12→use App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\n    13→use App\\Http\\Services\\Empresas\\EmpresaPlanService;\n    14→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    15→use App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    16→\n    17→class ConsumoCreditoService extends BaseService\n    18→{\n    19→    /**"}]},"uuid":"ef838d01-df3c-49e9-8625-6f46ed34d24d","timestamp":"2026-01-22T20:21:10.939Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","oldString":"use Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;","newString":"use Carbon\\Carbon;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;","originalFile":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(\n        string $ruta_endpoint,\n        array $respuesta_ia,\n        ?int $usuario_id = null,\n        ?int $empresa_id = null,\n        ?array $contexto = [],\n        ?string $payload_peticion = null,\n        ?int $latencia_ms = null\n    ): ?ConsumoCredito {\n        // Detectar si hay múltiples metadata de uso (formato nuevo)\n        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n        $ultimo_registro = null;\n\n        // Registrar Whisper si existe\n        if ($uso_whisper) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.whisper',\n                usage: $uso_whisper,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Registrar GPT si existe\n        if ($uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.gpt',\n                usage: $uso_gpt,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos($contexto);\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * @param array $contexto Contexto con empresa_plan_id.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n\n        if (!$empresa_plan_id) {\n            return;\n        }\n\n        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n\n        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n            return;\n        }\n\n        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n\n        if ($creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado.\n     * @param array $usage Metadata de uso específica.\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function registrarConsumoIndividual(\n        string $ruta_endpoint,\n        array $usage,\n        array $respuesta_ia,\n        ?int $usuario_id,\n        ?int $empresa_id,\n        array $contexto,\n        ?string $payload_peticion,\n        ?int $latencia_ms\n    ): ?ConsumoCredito {\n        $vacante_id = $contexto['vacante_id'] ?? null;\n\n        if (!$vacante_id && $payload_peticion) {\n            $decoded = json_decode($payload_peticion, true);\n\n            if (is_array($decoded)) {\n                $vacante_id = data_get($decoded, 'vacante_id')\n                    ?? data_get($decoded, 'vacanteId')\n                    ?? data_get($decoded, 'id')\n                    ?? data_get($decoded, 'vacante.id');\n\n                if ($vacante_id && !is_numeric($vacante_id)) {\n                    $vacante_id = null;\n                } elseif (is_numeric($vacante_id)) {\n                    $vacante_id = (int) $vacante_id;\n                }\n            }\n        }\n\n        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n        $modelo = $usage['model'] ?? 'desconocido';\n\n        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n        $metadata_adicional = [];\n\n        if (isset($usage['audio_duration_minutes'])) {\n            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n        }\n\n        if (isset($usage['audio_duration_seconds'])) {\n            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n        }\n\n        // Calcular costo estimado (pasando metadata adicional para Whisper)\n        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n            $modelo,\n            $usage['prompt_tokens'] ?? 0,\n            $usage['completion_tokens'] ?? 0,\n            $metadata_adicional ?: null\n        );\n\n        // Generar huella digital\n        $huella_peticion = null;\n\n        if ($payload_peticion) {\n            $huella_peticion = hash('sha256', $payload_peticion);\n        }\n\n        // Determinar estado de la respuesta\n        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n        $estado = 'exitoso';\n\n        if (isset($respuesta_ia['status_code'])) {\n            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n        } elseif (isset($respuesta_ia['error'])) {\n            $estado = 'error';\n        }\n\n        // Preparar datos\n        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n        $contenido_respuesta = $respuesta_ia['data']\n            ?? $respuesta_ia['vacante']\n            ?? $respuesta_ia['preguntas']\n            ?? $respuesta_ia['pruebas']\n            ?? $respuesta_ia['calificacion']\n            ?? null;\n\n        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n        if ($contenido_respuesta === null) {\n            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n        }\n\n        $datos = [\n            'usuario_id'         => $usuario_id,\n            'empresa_id'         => $empresa_id,\n            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n            'creditos'           => $contexto['creditos'] ?? 0,\n            'ruta_endpoint'      => $ruta_endpoint,\n            'nombre_servicio'    => $usage['service_name'] ?? null,\n            'modelo'             => $modelo,\n            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n            'caracteres_entrada' => $usage['input_chars'] ?? null,\n            'costo_estimado_usd' => $costo_estimado,\n            'huella_peticion'    => $huella_peticion,\n            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n            'estado'             => $estado,\n            'latencia_ms'        => $latencia_ms,\n            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n            'agenda_id'          => $contexto['agenda_id'] ?? null,\n            'vacante_id'         => $vacante_id\n        ];\n\n        return $this->repositorio->crear($datos);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param array $filtros Filtros de fecha.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n        $desde = null;\n        $hasta = null;\n\n        if (!empty($filtros['desde'])) {\n            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n        }\n\n        if (!empty($filtros['hasta'])) {\n            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n        }\n\n        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n\n        return $consumos->map(function (ConsumoCredito $consumo) {\n            $servicio = $consumo->servicioIA?->nombre\n                ?? $consumo->nombre_servicio\n                ?? $consumo->ruta_endpoint;\n\n            return [\n                'usuario'        => $consumo->usuario ? [\n                    'id'              => $consumo->usuario->id,\n                    'nombre_completo' => $consumo->usuario->nombre_completo\n                ] : null,\n                'servicio'       => $servicio,\n                'creditos'       => $consumo->creditos ?? 0,\n                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n                'fecha_consumo'  => $consumo->created_at\n            ];\n        });\n    }\n}\n","structuredPatch":[{"oldStart":3,"oldLines":13,"newStart":3,"newLines":16,"lines":[" namespace App\\Http\\Services\\IA;"," "," use Carbon\\Carbon;","+use Illuminate\\Http\\Request;"," use Illuminate\\Support\\Str;"," use App\\Models\\Planes\\Plan;"," use App\\Models\\IA\\ConsumoCredito;"," use App\\Http\\Services\\BaseService;"," use Illuminate\\Support\\Collection;"," use App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;","+use App\\Http\\Services\\Empresas\\EmpresaPlanService;"," use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;","+use App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;"," "," class ConsumoCreditoService extends BaseService"," {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"0232b453-b0ea-419a-b4c3-ea0222a65e3b"}
{"parentUuid":"ef838d01-df3c-49e9-8625-6f46ed34d24d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_017XSwFTi8fkNbzgQ684aTUt","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito modificar el constructor para agregar las nuevas dependencias.","signature":"EvUBCkYICxgCKkBwBSaIdyjJmiVlFQrBZqXoWEYfPkiM+WiJLXMcathASjcDMplTzGMh8C/zjLnmojOcbhhD4hXq+c9Yrfy0m1gDEgwB16d5f0fqVquPwA0aDL+tKbirvQLomZYkEyIwHQVLoufZ+nAajQK6MGgD4Zj5mHEgtOOAsfbEyaWu0gTVldOuKIuehFs2LCqwUjwZKl0z/qTNOO4tpwNtsdvogFpyi6nhgd0J4R1ll1lO/s8bD7c+j4LtD25qrO6xJN28mPrNHLmhCTYbt7XsSBX4/2WbHycc0GA0f9EjaPwb7S7xsCh4xHk6xLUfzQMiCV4YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":776,"cache_read_input_tokens":85126,"cache_creation":{"ephemeral_5m_input_tokens":776,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXP3AdmWmieeGWk9b9q5k","type":"assistant","uuid":"fc7de35a-5fda-4cca-99a7-f3de241b385c","timestamp":"2026-01-22T20:21:15.437Z"}
{"parentUuid":"fc7de35a-5fda-4cca-99a7-f3de241b385c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_017XSwFTi8fkNbzgQ684aTUt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JvEHwGvhKLvtNPMHodZEKp","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","old_string":"    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }","new_string":"    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresa.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de empresas de usuarios.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio,\n        private readonly EmpresaPlanService $empresa_plan_servicio,\n        private readonly EmpresaUsuarioRepository $empresa_usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":776,"cache_read_input_tokens":85126,"cache_creation":{"ephemeral_5m_input_tokens":776,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXP3AdmWmieeGWk9b9q5k","type":"assistant","uuid":"d4213ed8-32f3-4e8e-bc3d-b9735341fd96","timestamp":"2026-01-22T20:21:19.882Z"}
{"parentUuid":"d4213ed8-32f3-4e8e-bc3d-b9735341fd96","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JvEHwGvhKLvtNPMHodZEKp","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    15→use App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    16→\n    17→class ConsumoCreditoService extends BaseService\n    18→{\n    19→    /**\n    20→     * Constructor.\n    21→     *\n    22→     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n    23→     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n    24→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n    25→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresa.\n    26→     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de empresas de usuarios.\n    27→     * @return void\n    28→     * @author Sergio Vargas\n    29→     * @author Daniel Beltrán\n    30→     */\n    31→    public function __construct(\n    32→        ConsumoCreditoRepository $repositorio,\n    33→        private readonly ServicioPrecioTokenService $precio_token_servicio,\n    34→        private readonly EmpresaPlanRepository $empresa_plan_repositorio,\n    35→        private readonly EmpresaPlanService $empresa_plan_servicio,\n    36→        private readonly EmpresaUsuarioRepository $empresa_usuario_repositorio\n    37→    ) {\n    38→        parent::__construct($repositorio);\n    39→    }\n    40→\n    41→    /**\n    42→     * Registra el consumo de tokens desde la respuesta de la API de IA.\n    43→     *"}]},"uuid":"52607f34-08a5-4db0-8cd3-28a370207496","timestamp":"2026-01-22T20:21:23.642Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","oldString":"    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }","newString":"    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresa.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de empresas de usuarios.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio,\n        private readonly EmpresaPlanService $empresa_plan_servicio,\n        private readonly EmpresaUsuarioRepository $empresa_usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(\n        string $ruta_endpoint,\n        array $respuesta_ia,\n        ?int $usuario_id = null,\n        ?int $empresa_id = null,\n        ?array $contexto = [],\n        ?string $payload_peticion = null,\n        ?int $latencia_ms = null\n    ): ?ConsumoCredito {\n        // Detectar si hay múltiples metadata de uso (formato nuevo)\n        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n        $ultimo_registro = null;\n\n        // Registrar Whisper si existe\n        if ($uso_whisper) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.whisper',\n                usage: $uso_whisper,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Registrar GPT si existe\n        if ($uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.gpt',\n                usage: $uso_gpt,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos($contexto);\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * @param array $contexto Contexto con empresa_plan_id.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n\n        if (!$empresa_plan_id) {\n            return;\n        }\n\n        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n\n        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n            return;\n        }\n\n        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n\n        if ($creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado.\n     * @param array $usage Metadata de uso específica.\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function registrarConsumoIndividual(\n        string $ruta_endpoint,\n        array $usage,\n        array $respuesta_ia,\n        ?int $usuario_id,\n        ?int $empresa_id,\n        array $contexto,\n        ?string $payload_peticion,\n        ?int $latencia_ms\n    ): ?ConsumoCredito {\n        $vacante_id = $contexto['vacante_id'] ?? null;\n\n        if (!$vacante_id && $payload_peticion) {\n            $decoded = json_decode($payload_peticion, true);\n\n            if (is_array($decoded)) {\n                $vacante_id = data_get($decoded, 'vacante_id')\n                    ?? data_get($decoded, 'vacanteId')\n                    ?? data_get($decoded, 'id')\n                    ?? data_get($decoded, 'vacante.id');\n\n                if ($vacante_id && !is_numeric($vacante_id)) {\n                    $vacante_id = null;\n                } elseif (is_numeric($vacante_id)) {\n                    $vacante_id = (int) $vacante_id;\n                }\n            }\n        }\n\n        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n        $modelo = $usage['model'] ?? 'desconocido';\n\n        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n        $metadata_adicional = [];\n\n        if (isset($usage['audio_duration_minutes'])) {\n            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n        }\n\n        if (isset($usage['audio_duration_seconds'])) {\n            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n        }\n\n        // Calcular costo estimado (pasando metadata adicional para Whisper)\n        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n            $modelo,\n            $usage['prompt_tokens'] ?? 0,\n            $usage['completion_tokens'] ?? 0,\n            $metadata_adicional ?: null\n        );\n\n        // Generar huella digital\n        $huella_peticion = null;\n\n        if ($payload_peticion) {\n            $huella_peticion = hash('sha256', $payload_peticion);\n        }\n\n        // Determinar estado de la respuesta\n        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n        $estado = 'exitoso';\n\n        if (isset($respuesta_ia['status_code'])) {\n            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n        } elseif (isset($respuesta_ia['error'])) {\n            $estado = 'error';\n        }\n\n        // Preparar datos\n        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n        $contenido_respuesta = $respuesta_ia['data']\n            ?? $respuesta_ia['vacante']\n            ?? $respuesta_ia['preguntas']\n            ?? $respuesta_ia['pruebas']\n            ?? $respuesta_ia['calificacion']\n            ?? null;\n\n        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n        if ($contenido_respuesta === null) {\n            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n        }\n\n        $datos = [\n            'usuario_id'         => $usuario_id,\n            'empresa_id'         => $empresa_id,\n            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n            'creditos'           => $contexto['creditos'] ?? 0,\n            'ruta_endpoint'      => $ruta_endpoint,\n            'nombre_servicio'    => $usage['service_name'] ?? null,\n            'modelo'             => $modelo,\n            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n            'caracteres_entrada' => $usage['input_chars'] ?? null,\n            'costo_estimado_usd' => $costo_estimado,\n            'huella_peticion'    => $huella_peticion,\n            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n            'estado'             => $estado,\n            'latencia_ms'        => $latencia_ms,\n            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n            'agenda_id'          => $contexto['agenda_id'] ?? null,\n            'vacante_id'         => $vacante_id\n        ];\n\n        return $this->repositorio->crear($datos);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param array $filtros Filtros de fecha.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n        $desde = null;\n        $hasta = null;\n\n        if (!empty($filtros['desde'])) {\n            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n        }\n\n        if (!empty($filtros['hasta'])) {\n            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n        }\n\n        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n\n        return $consumos->map(function (ConsumoCredito $consumo) {\n            $servicio = $consumo->servicioIA?->nombre\n                ?? $consumo->nombre_servicio\n                ?? $consumo->ruta_endpoint;\n\n            return [\n                'usuario'        => $consumo->usuario ? [\n                    'id'              => $consumo->usuario->id,\n                    'nombre_completo' => $consumo->usuario->nombre_completo\n                ] : null,\n                'servicio'       => $servicio,\n                'creditos'       => $consumo->creditos ?? 0,\n                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n                'fecha_consumo'  => $consumo->created_at\n            ];\n        });\n    }\n}\n","structuredPatch":[{"oldStart":22,"oldLines":6,"newStart":22,"newLines":8,"lines":["      * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.","      * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.","      * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.","+     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresa.","+     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de empresas de usuarios.","      * @return void","      * @author Sergio Vargas","      * @author Daniel Beltrán"]},{"oldStart":29,"oldLines":7,"newStart":31,"newLines":9,"lines":["     public function __construct(","         ConsumoCreditoRepository $repositorio,","         private readonly ServicioPrecioTokenService $precio_token_servicio,","-        private readonly EmpresaPlanRepository $empresa_plan_repositorio","+        private readonly EmpresaPlanRepository $empresa_plan_repositorio,","+        private readonly EmpresaPlanService $empresa_plan_servicio,","+        private readonly EmpresaUsuarioRepository $empresa_usuario_repositorio","     ) {","         parent::__construct($repositorio);","     }"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d4213ed8-32f3-4e8e-bc3d-b9735341fd96"}
{"parentUuid":"52607f34-08a5-4db0-8cd3-28a370207496","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VLYyNwmsJVGggd82S4yJzi","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito leer y modificar la función `actualizarEstadoPlanSegunCreditos` para usar `creditosDisponiblesEmpresa`.","signature":"EqACCkYICxgCKkDv/wJXbvT3AQXx6h/6NlCpKB/8v724+dXGOJmlB5P/7CPha4DR8uG5/1//FHQ0kS3ixdqdKuyPqMgiWSs5kUF1Egw4/RdT8Mi8G22DaIkaDMKu65eTM8b0XaC9viIwd4itBBLok3o1kuB1wriF/MabYdtbhx3CdLF39GjGyDaHLYUApQULT8V1aWPZi4QoKocBzuQvFNY3JYAFtVu4Fc4byzSqFeFWcQS2aKyGyqtkpE4ArNrqzygDdapBv/zF++P71nFCBCW/9u2AalqzNdDFbxMd5aqlhUiayQdQ9bWMYFJI1Oha5fFnQ9soJ5+V/jQKBtRTbH21nHOYzliFC1Mi/MInRmI4gIAG4BgJGDbBfhuqqIHRxqk4GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1145,"cache_read_input_tokens":85902,"cache_creation":{"ephemeral_5m_input_tokens":1145,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CXP3Ba828P5q22pYGaMw3","type":"assistant","uuid":"5827c041-0214-4b33-914f-34748b9c8155","timestamp":"2026-01-22T20:21:28.659Z"}
{"parentUuid":"5827c041-0214-4b33-914f-34748b9c8155","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VLYyNwmsJVGggd82S4yJzi","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora modifico la función `actualizarEstadoPlanSegunCreditos`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1145,"cache_read_input_tokens":85902,"cache_creation":{"ephemeral_5m_input_tokens":1145,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CXP3Ba828P5q22pYGaMw3","type":"assistant","uuid":"78f32b4a-600b-4286-a850-bcc9bcfad60d","timestamp":"2026-01-22T20:21:29.039Z"}
{"parentUuid":"78f32b4a-600b-4286-a850-bcc9bcfad60d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VLYyNwmsJVGggd82S4yJzi","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GFBDmdF6q48JaqcjTTKejt","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","offset":110,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1145,"cache_read_input_tokens":85902,"cache_creation":{"ephemeral_5m_input_tokens":1145,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CXP3Ba828P5q22pYGaMw3","type":"assistant","uuid":"668dd761-1ccd-4562-84b8-7e55a0dedc87","timestamp":"2026-01-22T20:21:29.777Z"}
{"parentUuid":"668dd761-1ccd-4562-84b8-7e55a0dedc87","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GFBDmdF6q48JaqcjTTKejt","type":"tool_result","content":"   110→                payload_peticion: $payload_peticion,\n   111→                latencia_ms: $latencia_ms\n   112→            );\n   113→        }\n   114→\n   115→        // Validar y actualizar estado del plan según créditos restantes\n   116→        $this->actualizarEstadoPlanSegunCreditos($contexto);\n   117→\n   118→        return $ultimo_registro;\n   119→    }\n   120→\n   121→    /**\n   122→     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n   123→     *\n   124→     * @param array $contexto Contexto con empresa_plan_id.\n   125→     * @return void\n   126→     * @author Andres Gonzalez\n   127→     */\n   128→    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n   129→        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n   130→\n   131→        if (!$empresa_plan_id) {\n   132→            return;\n   133→        }\n   134→\n   135→        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n   136→\n   137→        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n   138→            return;\n   139→        }\n   140→\n   141→        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n   142→        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n   143→\n   144→        if ($creditos_plan <= 0) {\n   145→            return;\n   146→        }\n   147→\n   148→        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n   149→\n   150→        if ($creditos_disponibles <= 0) {\n   151→            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n   152→        } elseif ($porcentaje_restante < 20) {\n   153→            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n   154→        }\n   155→    }\n   156→\n   157→    /**\n   158→     * Registra un consumo individual de tokens desde una metadata de uso específica.\n   159→     *\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"755e2a90-5f93-4a0f-b3f2-524f73be6f13","timestamp":"2026-01-22T20:21:31.013Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","content":"                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos($contexto);\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * @param array $contexto Contexto con empresa_plan_id.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n\n        if (!$empresa_plan_id) {\n            return;\n        }\n\n        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n\n        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n            return;\n        }\n\n        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n\n        if ($creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *","numLines":50,"startLine":110,"totalLines":321}},"sourceToolAssistantUUID":"668dd761-1ccd-4562-84b8-7e55a0dedc87"}
{"parentUuid":"755e2a90-5f93-4a0f-b3f2-524f73be6f13","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_015KG8xLUG6KC23vAsUfrVk8","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito modificar:1. La llamada a la función (quitar el contexto, ya no necesita parámetros)2. La función en sí para usar `creditosDisponiblesEmpresa` y `obtenerEmpresaActualUsuario`","signature":"EuoCCkYICxgCKkA3gg/TEYgmRYtiAzziTtcqtE6AlKwRSFk+2lCb2tTBDcQQ/cVPueTHLE/DqL0tETcMOb5E/MhiIf8Wvd1RheDLEgxUsq2K1L+g2LCtMm0aDItgVMk/O+vqZ+kIuyIwbwywpVo3vEY41XekFWy9DkqONbZl9IV4faVkTIdb/F7czhBVGOD9j/53JHf5jlJCKtEBnIN7mi6Xnzm7W3PN3ay4z9+x2hisWi8YT++ZR8i9Q+iS54UCMVm7BIKS8un3zgi2djQKJngOpQFaALZIBy2ACUGSvmYgMP5H1HL0qT2pEQsHjpsXiYXYAxesR7SLuFpqqVCbF0ifNKYgSCuHXnwQWaBhDpp5fslDOR7T3QMXXNIda47txwK0jl4CWlPcpDuyrLxY3svKbqAy++vV/MmX5PYmTujmLkB2Uox46+u3bKXlGho7uQbD5bJ5D1+kPFPuf8oXp3STITcRu5tyVgvekREYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":954,"cache_read_input_tokens":87047,"cache_creation":{"ephemeral_5m_input_tokens":954,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXP3C14TX64vbVhZEubzh","type":"assistant","uuid":"bf1ac456-c5bb-445f-adc4-77ec9e5e478c","timestamp":"2026-01-22T20:21:34.888Z"}
{"parentUuid":"bf1ac456-c5bb-445f-adc4-77ec9e5e478c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_015KG8xLUG6KC23vAsUfrVk8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JjpzDJCbBuniPCNBjimCw9","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","old_string":"        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos($contexto);\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * @param array $contexto Contexto con empresa_plan_id.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n\n        if (!$empresa_plan_id) {\n            return;\n        }\n\n        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n\n        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n            return;\n        }\n\n        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n\n        if ($creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }","new_string":"        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos();\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * - Si quedan 0 créditos → estado Vencido\n     * - Si quedan menos del 20% → estado Por vencer\n     *\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(): void {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n        if (!$empresa) {\n            return;\n        }\n\n        $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n\n        if (!$creditos_info) {\n            return;\n        }\n\n        $empresa_plan_id = $creditos_info['empresa_plan_id'] ?? null;\n        $creditos_plan = $creditos_info['creditos_plan'] ?? 0;\n        $creditos_disponibles = $creditos_info['creditos_disponibles'] ?? 0;\n\n        if (!$empresa_plan_id || $creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":954,"cache_read_input_tokens":87047,"cache_creation":{"ephemeral_5m_input_tokens":954,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXP3C14TX64vbVhZEubzh","type":"assistant","uuid":"a73c9529-2a18-4ab5-97a9-d118dc31bb03","timestamp":"2026-01-22T20:21:43.169Z"}
{"parentUuid":"a73c9529-2a18-4ab5-97a9-d118dc31bb03","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JjpzDJCbBuniPCNBjimCw9","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   111→                latencia_ms: $latencia_ms\n   112→            );\n   113→        }\n   114→\n   115→        // Validar y actualizar estado del plan según créditos restantes\n   116→        $this->actualizarEstadoPlanSegunCreditos();\n   117→\n   118→        return $ultimo_registro;\n   119→    }\n   120→\n   121→    /**\n   122→     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n   123→     *\n   124→     * - Si quedan 0 créditos → estado Vencido\n   125→     * - Si quedan menos del 20% → estado Por vencer\n   126→     *\n   127→     * @return void\n   128→     * @author Andres Gonzalez\n   129→     */\n   130→    private function actualizarEstadoPlanSegunCreditos(): void {\n   131→        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   132→\n   133→        if (!$empresa) {\n   134→            return;\n   135→        }\n   136→\n   137→        $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n   138→\n   139→        if (!$creditos_info) {\n   140→            return;\n   141→        }\n   142→\n   143→        $empresa_plan_id = $creditos_info['empresa_plan_id'] ?? null;\n   144→        $creditos_plan = $creditos_info['creditos_plan'] ?? 0;\n   145→        $creditos_disponibles = $creditos_info['creditos_disponibles'] ?? 0;\n   146→\n   147→        if (!$empresa_plan_id || $creditos_plan <= 0) {\n   148→            return;\n   149→        }\n   150→\n   151→        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n   152→\n   153→        if ($creditos_disponibles <= 0) {\n   154→            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n   155→        } elseif ($porcentaje_restante < 20) {\n   156→            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n   157→        }\n   158→    }\n   159→\n   160→    /**\n   161→     * Registra un consumo individual de tokens desde una metadata de uso específica.\n   162→     *"}]},"uuid":"f2229e92-0119-4bf9-b1fb-5a96639e4c59","timestamp":"2026-01-22T20:21:47.974Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\IA\\ConsumoCreditoService.php","oldString":"        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos($contexto);\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * @param array $contexto Contexto con empresa_plan_id.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n\n        if (!$empresa_plan_id) {\n            return;\n        }\n\n        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n\n        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n            return;\n        }\n\n        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n\n        if ($creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }","newString":"        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos();\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * - Si quedan 0 créditos → estado Vencido\n     * - Si quedan menos del 20% → estado Por vencer\n     *\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(): void {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n        if (!$empresa) {\n            return;\n        }\n\n        $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n\n        if (!$creditos_info) {\n            return;\n        }\n\n        $empresa_plan_id = $creditos_info['empresa_plan_id'] ?? null;\n        $creditos_plan = $creditos_info['creditos_plan'] ?? 0;\n        $creditos_disponibles = $creditos_info['creditos_disponibles'] ?? 0;\n\n        if (!$empresa_plan_id || $creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\IA;\n\nuse Carbon\\Carbon;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Support\\Str;\nuse App\\Models\\Planes\\Plan;\nuse App\\Models\\IA\\ConsumoCredito;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Http\\Repositories\\IA\\ConsumoCreditoRepository;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n\nclass ConsumoCreditoService extends BaseService\n{\n    /**\n     * Constructor.\n     *\n     * @param ConsumoCreditoRepository $repositorio Repositorio de consumos de créditos.\n     * @param ServicioPrecioTokenService $precio_token_servicio Servicio de precios de tokens.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresa.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresa.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de empresas de usuarios.\n     * @return void\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        ConsumoCreditoRepository $repositorio,\n        private readonly ServicioPrecioTokenService $precio_token_servicio,\n        private readonly EmpresaPlanRepository $empresa_plan_repositorio,\n        private readonly EmpresaPlanService $empresa_plan_servicio,\n        private readonly EmpresaUsuarioRepository $empresa_usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Registra el consumo de tokens desde la respuesta de la API de IA.\n     *\n     * Maneja tanto el formato nuevo (usage_whisper, usage_gpt) como el formato legacy (usage).\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado (ej: 'generar-vacante').\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function registrarConsumoDesdeRespuesta(\n        string $ruta_endpoint,\n        array $respuesta_ia,\n        ?int $usuario_id = null,\n        ?int $empresa_id = null,\n        ?array $contexto = [],\n        ?string $payload_peticion = null,\n        ?int $latencia_ms = null\n    ): ?ConsumoCredito {\n        // Detectar si hay múltiples metadata de uso (formato nuevo)\n        $uso_whisper     = $respuesta_ia['usage_whisper'] ?? null;\n        $uso_gpt         = $respuesta_ia['usage_gpt'] ?? null;\n        $ultimo_registro = null;\n\n        // Registrar Whisper si existe\n        if ($uso_whisper) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.whisper',\n                usage: $uso_whisper,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Registrar GPT si existe\n        if ($uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint . '.gpt',\n                usage: $uso_gpt,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Fallback: Si solo hay \"usage\" (formato legacy)\n        $usage_legacy = $respuesta_ia['usage'] ?? null;\n\n        if ($usage_legacy && !$uso_whisper && !$uso_gpt) {\n            $ultimo_registro = $this->registrarConsumoIndividual(\n                ruta_endpoint: $ruta_endpoint,\n                usage: $usage_legacy,\n                respuesta_ia: $respuesta_ia,\n                usuario_id: $usuario_id,\n                empresa_id: $empresa_id,\n                contexto: $contexto,\n                payload_peticion: $payload_peticion,\n                latencia_ms: $latencia_ms\n            );\n        }\n\n        // Validar y actualizar estado del plan según créditos restantes\n        $this->actualizarEstadoPlanSegunCreditos($contexto);\n\n        return $ultimo_registro;\n    }\n\n    /**\n     * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.\n     *\n     * @param array $contexto Contexto con empresa_plan_id.\n     * @return void\n     * @author Andres Gonzalez\n     */\n    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {\n        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;\n\n        if (!$empresa_plan_id) {\n            return;\n        }\n\n        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);\n\n        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {\n            return;\n        }\n\n        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;\n        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;\n\n        if ($creditos_plan <= 0) {\n            return;\n        }\n\n        $porcentaje_restante = ($creditos_disponibles / $creditos_plan) * 100;\n\n        if ($creditos_disponibles <= 0) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_VENCIDO_ID]);\n        } elseif ($porcentaje_restante < 20) {\n            $this->empresa_plan_repositorio->actualizar($empresa_plan_id, ['estado_id' => Plan::ESTADO_POR_VENCER_ID]);\n        }\n    }\n\n    /**\n     * Registra un consumo individual de tokens desde una metadata de uso específica.\n     *\n     * @param string $ruta_endpoint Ruta del endpoint llamado.\n     * @param array $usage Metadata de uso específica.\n     * @param array $respuesta_ia Respuesta completa de la API de IA.\n     * @param ?int $usuario_id ID del usuario que realizó la petición.\n     * @param ?int $empresa_id ID de la empresa del usuario.\n     * @param array $contexto Array con agenda_id, vacante_id, etc.\n     * @param ?string $payload_peticion JSON del payload enviado.\n     * @param ?int $latencia_ms Latencia de la petición en milisegundos.\n     * @return ?ConsumoCredito\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    private function registrarConsumoIndividual(\n        string $ruta_endpoint,\n        array $usage,\n        array $respuesta_ia,\n        ?int $usuario_id,\n        ?int $empresa_id,\n        array $contexto,\n        ?string $payload_peticion,\n        ?int $latencia_ms\n    ): ?ConsumoCredito {\n        $vacante_id = $contexto['vacante_id'] ?? null;\n\n        if (!$vacante_id && $payload_peticion) {\n            $decoded = json_decode($payload_peticion, true);\n\n            if (is_array($decoded)) {\n                $vacante_id = data_get($decoded, 'vacante_id')\n                    ?? data_get($decoded, 'vacanteId')\n                    ?? data_get($decoded, 'id')\n                    ?? data_get($decoded, 'vacante.id');\n\n                if ($vacante_id && !is_numeric($vacante_id)) {\n                    $vacante_id = null;\n                } elseif (is_numeric($vacante_id)) {\n                    $vacante_id = (int) $vacante_id;\n                }\n            }\n        }\n\n        // Usar el usage recibido como parámetro (ya sea usage_whisper o usage_gpt)\n        $modelo = $usage['model'] ?? 'desconocido';\n\n        // Preparar metadata adicional para cálculo de costo (necesario para Whisper)\n        $metadata_adicional = [];\n\n        if (isset($usage['audio_duration_minutes'])) {\n            $metadata_adicional['audio_duration_minutes'] = $usage['audio_duration_minutes'];\n        }\n\n        if (isset($usage['audio_duration_seconds'])) {\n            $metadata_adicional['audio_duration_seconds'] = $usage['audio_duration_seconds'];\n        }\n\n        // Calcular costo estimado (pasando metadata adicional para Whisper)\n        $costo_estimado = $this->precio_token_servicio->calcularCosto(\n            $modelo,\n            $usage['prompt_tokens'] ?? 0,\n            $usage['completion_tokens'] ?? 0,\n            $metadata_adicional ?: null\n        );\n\n        // Generar huella digital\n        $huella_peticion = null;\n\n        if ($payload_peticion) {\n            $huella_peticion = hash('sha256', $payload_peticion);\n        }\n\n        // Determinar estado de la respuesta\n        // Si tiene usage, asumimos que fue exitoso (FastAPI ya lanzaría excepción si hubo error)\n        $estado = 'exitoso';\n\n        if (isset($respuesta_ia['status_code'])) {\n            $estado = $respuesta_ia['status_code'] === 200 ? 'exitoso' : 'error';\n        } elseif (isset($respuesta_ia['error'])) {\n            $estado = 'error';\n        }\n\n        // Preparar datos\n        // Determinar extracto de la respuesta (soportar distintos nombres usados por FastAPI)\n        $contenido_respuesta = $respuesta_ia['data']\n            ?? $respuesta_ia['vacante']\n            ?? $respuesta_ia['preguntas']\n            ?? $respuesta_ia['pruebas']\n            ?? $respuesta_ia['calificacion']\n            ?? null;\n\n        // Si no se encontrИ un payload claro, usar la respuesta completa sin la secciИn usage\n        if ($contenido_respuesta === null) {\n            $contenido_respuesta = collect($respuesta_ia)->except('usage')->all();\n        }\n\n        $datos = [\n            'usuario_id'         => $usuario_id,\n            'empresa_id'         => $empresa_id,\n            'empresa_plan_id'    => $contexto['empresa_plan_id'] ?? null,\n            'servicio_ia_id'     => $contexto['servicio_ia_id'] ?? null,\n            'creditos'           => $contexto['creditos'] ?? 0,\n            'ruta_endpoint'      => $ruta_endpoint,\n            'nombre_servicio'    => $usage['service_name'] ?? null,\n            'modelo'             => $modelo,\n            'tokens_entrada'     => $usage['prompt_tokens'] ?? 0,\n            'tokens_salida'      => $usage['completion_tokens'] ?? 0,\n            'tokens_totales'     => $usage['total_tokens'] ?? 0,\n            'caracteres_entrada' => $usage['input_chars'] ?? null,\n            'costo_estimado_usd' => $costo_estimado,\n            'huella_peticion'    => $huella_peticion,\n            'extracto_peticion'  => $payload_peticion ? Str::limit($payload_peticion, 500) : null,\n            'extracto_respuesta' => $contenido_respuesta ? Str::limit(json_encode($contenido_respuesta), 500) : null,\n            'estado'             => $estado,\n            'latencia_ms'        => $latencia_ms,\n            'mensaje_error'      => $respuesta_ia['error'] ?? null,\n            'agenda_id'          => $contexto['agenda_id'] ?? null,\n            'vacante_id'         => $vacante_id\n        ];\n\n        return $this->repositorio->crear($datos);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos por empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param array $filtros Filtros de fecha.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialConsumosEmpresa(int $empresa_id, array $filtros = []): Collection {\n        $desde = null;\n        $hasta = null;\n\n        if (!empty($filtros['desde'])) {\n            $desde = Carbon::parse($filtros['desde'])->startOfDay();\n        }\n\n        if (!empty($filtros['hasta'])) {\n            $hasta = Carbon::parse($filtros['hasta'])->endOfDay();\n        }\n\n        $consumos = $this->repositorio->historialPorEmpresa($empresa_id, $desde, $hasta);\n\n        return $consumos->map(function (ConsumoCredito $consumo) {\n            $servicio = $consumo->servicioIA?->nombre\n                ?? $consumo->nombre_servicio\n                ?? $consumo->ruta_endpoint;\n\n            return [\n                'usuario'        => $consumo->usuario ? [\n                    'id'              => $consumo->usuario->id,\n                    'nombre_completo' => $consumo->usuario->nombre_completo\n                ] : null,\n                'servicio'       => $servicio,\n                'creditos'       => $consumo->creditos ?? 0,\n                'tokens_reales'  => $consumo->tokens_totales ?? 0,\n                'fecha_consumo'  => $consumo->created_at\n            ];\n        });\n    }\n}\n","structuredPatch":[{"oldStart":113,"oldLines":7,"newStart":113,"newLines":7,"lines":["         }"," ","         // Validar y actualizar estado del plan según créditos restantes","-        $this->actualizarEstadoPlanSegunCreditos($contexto);","+        $this->actualizarEstadoPlanSegunCreditos();"," ","         return $ultimo_registro;","     }"]},{"oldStart":121,"oldLines":27,"newStart":121,"newLines":30,"lines":["     /**","      * Actualiza el estado del plan de créditos según el porcentaje de créditos restantes.","      *","-     * @param array $contexto Contexto con empresa_plan_id.","+     * - Si quedan 0 créditos → estado Vencido","+     * - Si quedan menos del 20% → estado Por vencer","+     *","      * @return void","      * @author Andres Gonzalez","      */","-    private function actualizarEstadoPlanSegunCreditos(array $contexto): void {","-        $empresa_plan_id = $contexto['empresa_plan_id'] ?? null;","+    private function actualizarEstadoPlanSegunCreditos(): void {","+        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();"," ","-        if (!$empresa_plan_id) {","+        if (!$empresa) {","             return;","         }"," ","-        $empresa_plan = $this->empresa_plan_repositorio->getUno($empresa_plan_id);","+        $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());"," ","-        if (!$empresa_plan || !$empresa_plan->plan_credito_id) {","+        if (!$creditos_info) {","             return;","         }"," ","-        $creditos_plan = $empresa_plan->planCredito->creditos ?? 0;","-        $creditos_disponibles = $empresa_plan->creditos_restantes ?? 0;","+        $empresa_plan_id = $creditos_info['empresa_plan_id'] ?? null;","+        $creditos_plan = $creditos_info['creditos_plan'] ?? 0;","+        $creditos_disponibles = $creditos_info['creditos_disponibles'] ?? 0;"," ","-        if ($creditos_plan <= 0) {","+        if (!$empresa_plan_id || $creditos_plan <= 0) {","             return;","         }"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"a73c9529-2a18-4ab5-97a9-d118dc31bb03"}
{"parentUuid":"f2229e92-0119-4bf9-b1fb-5a96639e4c59","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_011FuRc7L6GdZ5b7mmkaj3x4","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Listo. Ahora la función usa:\n1. `obtenerEmpresaActualUsuario()` para obtener la empresa actual\n2. `creditosDisponiblesEmpresa()` para obtener la información de créditos\n3. Los datos del array retornado para calcular el porcentaje y actualizar el estado","signature":"EqUDCkYICxgCKkCxbh3riFx+tL1/DRSH9/s2lXEUNloiokmCddLicJCSEJWSY9iTJBZYe43Mwe9icV+arSmrVR8ZKt91kYMQTTv5Egwvw3/w8eoQHR4VXb8aDEawzGOWgC2jtiqEPiIw7C+D8uYv6GJmtCOHZvi4OMO+iIVJjdBp2RBaK4soCH+hln+7Q2hQ0ardjmh22glmKowCq+2RotqHP2G6zhGKz6XReBjFnVxWCBeB+hQyCQp2C3YnD5A+TLLEnKH4KODSIQQnXZG5rmE6ySi76TrMX4QhO8BuSmnjMyEJzfgijw0wg6OkUaBJo7NVyskuXHNblmTDlha8VpA+rgWwLHPeY61JEDVTyL0zO2Y2ihuVld9UoZddnStS1vB5biSXvRyzJ10a3XuiR709OFbUhWLgZel5TAhNvG97zvDQdb/joA5zwy16h+8BDlPJD13+wIlEGYa0ysnJxi1qcjqCmEAd4UADJONfgLiMtbgkCFI+01tdmJHW97ABH7FDXJlcp2But/qL3ZueHDc9QpfYUsIlOMfm1gZkID/bKB2mWeovghgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2043,"cache_read_input_tokens":88001,"cache_creation":{"ephemeral_5m_input_tokens":2043,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP3DNScBifkHnWUABeJd","type":"assistant","uuid":"e7a87d69-80a9-44c8-bf31-d32b30c2d1ad","timestamp":"2026-01-22T20:21:54.614Z"}
{"parentUuid":"e7a87d69-80a9-44c8-bf31-d32b30c2d1ad","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_011FuRc7L6GdZ5b7mmkaj3x4","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He modificado la función para usar `creditosDisponiblesEmpresa` y `obtenerEmpresaActualUsuario`.\n\n**Resumen de cambios en** [ConsumoCreditoService.php](app/Http/Services/IA/ConsumoCreditoService.php):\n\n1. **Imports agregados** (líneas 6, 13, 15):\n   - `Illuminate\\Http\\Request`\n   - `App\\Http\\Services\\Empresas\\EmpresaPlanService`\n   - `App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository`\n\n2. **Constructor actualizado** (líneas 35-36):\n   - `EmpresaPlanService $empresa_plan_servicio`\n   - `EmpresaUsuarioRepository $empresa_usuario_repositorio`\n\n3. **Función `actualizarEstadoPlanSegunCreditos`** (líneas 130-158):\n   - Obtiene la empresa actual con `obtenerEmpresaActualUsuario()`\n   - Llama a `creditosDisponiblesEmpresa($empresa->id, new Request())`\n   - Usa los datos del array retornado:\n     - `empresa_plan_id`\n     - `creditos_plan`\n     - `creditos_disponibles`\n   - Calcula el porcentaje y actualiza el estado según corresponda"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2043,"cache_read_input_tokens":88001,"cache_creation":{"ephemeral_5m_input_tokens":2043,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXP3DNScBifkHnWUABeJd","type":"assistant","uuid":"617c6081-3fd0-45c5-bc58-513aee97234b","timestamp":"2026-01-22T20:21:58.472Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-22T23:08:19.956Z","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb"}
{"type":"file-history-snapshot","messageId":"070a43e1-dcfe-4cb0-86bb-9d0ddc18a34c","snapshot":{"messageId":"070a43e1-dcfe-4cb0-86bb-9d0ddc18a34c","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaPlanService.php":{"backupFileName":"ec393a54ef0823b3@v4","version":4,"backupTime":"2026-01-22T23:08:23.649Z"},"public\\js\\empresa\\planes\\planes.js":{"backupFileName":"40785c941af62b87@v4","version":4,"backupTime":"2026-01-22T23:08:23.666Z"},"app\\Http\\Repositories\\Empresas\\EmpresaPlanRepository.php":{"backupFileName":"04cb3be0b984b422@v3","version":3,"backupTime":"2026-01-22T23:08:23.683Z"},"app\\Http\\Services\\IA\\ConsumoCreditoService.php":{"backupFileName":"3e939a737c702ece@v3","version":3,"backupTime":"2026-01-22T23:08:23.694Z"}},"timestamp":"2026-01-22T23:08:23.559Z"},"isSnapshotUpdate":false}
{"parentUuid":"70200a34-b40e-4ac0-8744-d15f67fd0a99","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01UoATByeTG3C1No9E6xgDRw","parentToolUseID":"toolu_01UoATByeTG3C1No9E6xgDRw","uuid":"ea8de35c-5635-4fa3-93b5-58d5aa9f23ff","timestamp":"2026-01-22T20:20:43.535Z"}
{"parentUuid":"0232b453-b0ea-419a-b4c3-ea0222a65e3b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01H18wPEu8ynX1DhqWEWPnei","parentToolUseID":"toolu_01H18wPEu8ynX1DhqWEWPnei","uuid":"c07c1586-a28d-4431-877e-ad5f738a4921","timestamp":"2026-01-22T20:20:51.872Z"}
{"parentUuid":"c07c1586-a28d-4431-877e-ad5f738a4921","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01H18wPEu8ynX1DhqWEWPnei","parentToolUseID":"toolu_01H18wPEu8ynX1DhqWEWPnei","uuid":"68cd40b8-da10-43af-856a-12565cee6ca1","timestamp":"2026-01-22T20:20:51.873Z"}
{"parentUuid":"ef838d01-df3c-49e9-8625-6f46ed34d24d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01H18wPEu8ynX1DhqWEWPnei","toolUseID":"toolu_01H18wPEu8ynX1DhqWEWPnei","timestamp":"2026-01-22T20:21:10.939Z","uuid":"baf21da3-c355-4203-b467-98615f34d0b0"}
{"parentUuid":"d4213ed8-32f3-4e8e-bc3d-b9735341fd96","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01JvEHwGvhKLvtNPMHodZEKp","parentToolUseID":"toolu_01JvEHwGvhKLvtNPMHodZEKp","uuid":"5e6027ea-4bbb-4c00-982c-c9e07131aea1","timestamp":"2026-01-22T20:21:21.003Z"}
{"parentUuid":"5e6027ea-4bbb-4c00-982c-c9e07131aea1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01JvEHwGvhKLvtNPMHodZEKp","parentToolUseID":"toolu_01JvEHwGvhKLvtNPMHodZEKp","uuid":"af3be637-fedd-4557-a15a-5d45a537103e","timestamp":"2026-01-22T20:21:21.003Z"}
{"parentUuid":"52607f34-08a5-4db0-8cd3-28a370207496","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01JvEHwGvhKLvtNPMHodZEKp","toolUseID":"toolu_01JvEHwGvhKLvtNPMHodZEKp","timestamp":"2026-01-22T20:21:23.643Z","uuid":"4e367ad9-9b72-4f00-ac93-2834714ed027"}
{"parentUuid":"668dd761-1ccd-4562-84b8-7e55a0dedc87","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01GFBDmdF6q48JaqcjTTKejt","parentToolUseID":"toolu_01GFBDmdF6q48JaqcjTTKejt","uuid":"509696ba-a02d-40f2-a930-bfc8050b412b","timestamp":"2026-01-22T20:21:29.970Z"}
{"parentUuid":"a73c9529-2a18-4ab5-97a9-d118dc31bb03","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01JjpzDJCbBuniPCNBjimCw9","parentToolUseID":"toolu_01JjpzDJCbBuniPCNBjimCw9","uuid":"0ce48352-434f-4df8-b49a-73199010c16e","timestamp":"2026-01-22T20:21:43.373Z"}
{"parentUuid":"0ce48352-434f-4df8-b49a-73199010c16e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01JjpzDJCbBuniPCNBjimCw9","parentToolUseID":"toolu_01JjpzDJCbBuniPCNBjimCw9","uuid":"2838a7de-4a40-4923-9ec0-109dd3dd84b8","timestamp":"2026-01-22T20:21:43.373Z"}
{"parentUuid":"f2229e92-0119-4bf9-b1fb-5a96639e4c59","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01JjpzDJCbBuniPCNBjimCw9","toolUseID":"toolu_01JjpzDJCbBuniPCNBjimCw9","timestamp":"2026-01-22T20:21:47.975Z","uuid":"7ff2f7b8-37ec-4c2a-b3e5-8f43ea71007d"}
{"parentUuid":"617c6081-3fd0-45c5-bc58-513aee97234b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 186 to 186 from c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js:\n<p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"aqui quiero colcar el icno desde un svg qyue sta aqui public\\iconos\\icono_ia_azul.svg"}]},"uuid":"070a43e1-dcfe-4cb0-86bb-9d0ddc18a34c","timestamp":"2026-01-22T23:08:23.555Z","permissionMode":"default"}
{"parentUuid":"070a43e1-dcfe-4cb0-86bb-9d0ddc18a34c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RxTuLD1fjG9eoNydxqnJ6a","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere reemplazar el icono de Bootstrap `bi bi-coin` con un SVG personalizado que está en `public\\iconos\\icono_ia_azul.svg`. Necesito ver el archivo SVG primero para entender su contenido y luego modificar la línea correspondiente en el archivo JavaScript.","signature":"ErYDCkYICxgCKkDYM+vIg9uI9ompjo0oCD4yPvPdfGx/aWvzrpEYZc3+OTbmGFGqx4ECR8JaMSSi7/DEZ0zYbZ6KwrIdsRn7ZLdXEgzhltfbOK+6ZRD+l/MaDA3ktEYZJ2oVI1Ba9yIwz4XQcuUO3zEylJUc5KkkHmAd5TIwahJ3/CtjO2jyXlykre4isNFED+dMmXklTiL6Kp0CXc9XU+C00eZyCY3M8qBwLO8b1YOblvoXZApX+pG37C8rFXdwsFWZxJgzjbz8qr31jC5tbA8KqUoWDPZFlBlDrVUxdZ2JD6kpHY291tI9E2LjXWuMixoHKJXGWZmfIiVnfacVp0jz1pmJwFZz9/jY+DKG/agM7pzje7EwcyfUdNK4vNB7WmYVEPxyPmHT+1Xc3nbjO0CQFYK/KM7V0seIpP/8m8fO7ws475SHSsVrMjHNFCyFdGHvTly3jyJ8CtvhCnbWHOi0DD2GRoSTWwCn2Ue/xGtmPloh3YGQgYonM/kM6jFXOiEaQLIzMuvyfRf1eahRH4dlag4mQ+hOennP/genACOfA4sQQHSWOmNiOAHQT8fkRk0hSivqWWktGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":99447,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":99447,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXPFv66Ph6hz5PsYgoxq3","type":"assistant","uuid":"1390f361-35c0-4e3b-866e-dec8aca22bbf","timestamp":"2026-01-22T23:08:29.491Z"}
{"parentUuid":"1390f361-35c0-4e3b-866e-dec8aca22bbf","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RxTuLD1fjG9eoNydxqnJ6a","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CcaTPVxXhXVNAcpcXMz44D","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\iconos\\icono_ia_azul.svg"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":99447,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":99447,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXPFv66Ph6hz5PsYgoxq3","type":"assistant","uuid":"029aa213-9ab8-43ef-8af2-9f108551e61e","timestamp":"2026-01-22T23:08:30.491Z"}
{"parentUuid":"029aa213-9ab8-43ef-8af2-9f108551e61e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CcaTPVxXhXVNAcpcXMz44D","type":"tool_result","content":"     1→<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n     2→<path d=\"M16.0723 20.001C16.07 19.9955 16.0684 19.9893 16.0684 19.9834C16.0684 19.9776 16.0701 19.9721 16.0723 19.9668C16.0758 19.9779 16.0758 19.9899 16.0723 20.001ZM16.0713 11.9131C16.1083 11.9131 16.1447 11.9246 16.1758 11.9453C16.2068 11.9661 16.2318 11.9954 16.2471 12.0303C17.2196 14.2372 17.7054 14.8433 19.874 15.668C19.9104 15.6817 19.9423 15.7067 19.9648 15.7393C19.9874 15.7719 19.9992 15.8115 20 15.8516C20.0007 15.8916 19.99 15.9314 19.9688 15.9648C19.9475 15.9983 19.9167 16.0239 19.8809 16.0391C17.9733 16.8529 17.1519 17.4389 16.248 19.5918C16.2331 19.6273 16.2081 19.6575 16.1768 19.6787C16.1454 19.6999 16.1087 19.7109 16.0713 19.7109C16.034 19.7109 15.9971 19.6999 15.9658 19.6787C15.9347 19.6575 15.9104 19.6272 15.8955 19.5918C14.9916 17.4388 14.1703 16.8583 12.2617 16.0391C12.226 16.0238 12.195 15.9983 12.1738 15.9648C12.1526 15.9314 12.1419 15.8916 12.1426 15.8516C12.1434 15.8114 12.1561 15.7719 12.1787 15.7393C12.2013 15.7066 12.2331 15.6817 12.2695 15.668C14.4401 14.8434 14.925 14.2371 15.8965 12.0303C15.9117 11.9956 15.9359 11.966 15.9668 11.9453C15.9978 11.9246 16.0344 11.9131 16.0713 11.9131ZM14.1279 0C14.6021 2.35356e-05 15.0717 0.0973403 15.5098 0.285156C15.9478 0.472993 16.3463 0.74769 16.6816 1.09473C17.017 1.44178 17.2824 1.85417 17.4639 2.30762C17.6454 2.7611 17.7393 3.24743 17.7393 3.73828V9.63867C17.7397 9.68058 17.7288 9.72187 17.708 9.75781C17.687 9.79389 17.6563 9.82346 17.6201 9.84277C17.584 9.86203 17.5434 9.87037 17.5029 9.86719C17.4624 9.86399 17.4235 9.84894 17.3906 9.82422C17.0089 9.52713 16.544 9.36668 16.0664 9.36621C15.9926 9.36622 15.9194 9.3704 15.8467 9.37793C15.8166 9.38054 15.7864 9.37629 15.7578 9.36621C15.729 9.35601 15.7021 9.33973 15.6797 9.31836C15.6573 9.29702 15.6391 9.27104 15.627 9.24219C15.6149 9.21337 15.6093 9.18182 15.6094 9.15039V3.73438C15.6093 3.53297 15.5705 3.33354 15.4961 3.14746C15.4215 2.96114 15.3117 2.791 15.1738 2.64844C15.0361 2.50603 14.8723 2.39343 14.6924 2.31641C14.5124 2.23938 14.3197 2.19913 14.125 2.19922H3.61426C3.41955 2.19908 3.2268 2.2394 3.04688 2.31641C2.86704 2.39343 2.7031 2.50606 2.56543 2.64844C2.42767 2.79102 2.31765 2.96115 2.24316 3.14746C2.16884 3.33354 2.13077 3.53302 2.13086 3.73438V14.5713C2.13074 14.7729 2.1687 14.9728 2.24316 15.1592C2.31764 15.3455 2.4277 15.5146 2.56543 15.6572C2.70304 15.7997 2.86611 15.913 3.0459 15.9902C3.22592 16.0674 3.41939 16.1074 3.61426 16.1074H9.06738C9.1943 16.1116 9.31709 16.1565 9.41797 16.2363C9.51878 16.3162 9.59276 16.4271 9.62988 16.5527C9.76509 17.092 10.1489 17.4825 10.5576 17.7549C10.6098 17.7897 10.6503 17.8411 10.6719 17.9014C10.6933 17.9616 10.6954 18.0274 10.6777 18.0889C10.66 18.1505 10.6231 18.2049 10.5732 18.2432C10.5235 18.2812 10.4632 18.302 10.4014 18.3018H3.61133C2.65427 18.3018 1.73573 17.908 1.05859 17.208C0.381694 16.5081 0.00121561 15.5587 0 14.5684V3.73828C0.000275677 2.74719 0.380597 1.79658 1.05762 1.0957C1.73481 0.394803 2.65363 0.000285367 3.61133 0H14.1279ZM7.38477 4.79004C7.41033 4.79205 7.43495 4.80192 7.45508 4.81836C7.47505 4.83476 7.49023 4.85672 7.49805 4.88184L10.0986 12.8418C10.109 12.8693 10.1129 12.8993 10.1104 12.9287C10.1077 12.9583 10.0982 12.9875 10.083 13.0127C10.0679 13.0378 10.0469 13.0588 10.0225 13.0742C9.99811 13.0896 9.9708 13.0991 9.94238 13.1016H9.10352C9.06838 13.1004 9.03474 13.0876 9.00684 13.0654C8.97885 13.0432 8.95846 13.0125 8.94824 12.9775L8.45605 11.4707C8.44811 11.4436 8.43177 11.4197 8.41016 11.4023C8.38858 11.3851 8.36222 11.3753 8.33496 11.374H5.41406C5.3869 11.3753 5.36036 11.3851 5.33887 11.4023C5.31738 11.4197 5.30186 11.4437 5.29395 11.4707L4.80273 12.9775C4.7922 13.0135 4.77045 13.0451 4.74121 13.0674C4.712 13.0896 4.67688 13.1018 4.64062 13.1016H3.80859C3.78001 13.0991 3.752 13.0897 3.72754 13.0742C3.70332 13.0588 3.68296 13.0377 3.66797 13.0127C3.65289 12.9875 3.64309 12.9583 3.64062 12.9287C3.63823 12.8993 3.64268 12.8692 3.65332 12.8418L6.25391 4.88184C6.2618 4.85566 6.27768 4.83293 6.29883 4.81641C6.32 4.79987 6.34556 4.79071 6.37207 4.79004H7.38477ZM12.9775 13.0908H11.7852V4.79004H12.9775V13.0908ZM6.87793 6.44922C6.84959 6.44923 6.82202 6.45934 6.7998 6.47754C6.77752 6.49596 6.76121 6.522 6.75488 6.55078C6.71123 6.70247 6.67213 6.83604 6.63574 6.95117L5.71094 10.2109C5.7031 10.2319 5.70009 10.255 5.70215 10.2773C5.70424 10.2995 5.71124 10.3209 5.72266 10.3398C5.73417 10.3589 5.75002 10.3751 5.76855 10.3867C5.78693 10.3983 5.80768 10.4053 5.8291 10.4072H7.92578C7.94752 10.4055 7.96867 10.3984 7.9873 10.3867C8.00605 10.3749 8.02165 10.3582 8.0332 10.3389C8.04468 10.3196 8.05186 10.2979 8.05371 10.2754C8.05556 10.2528 8.05219 10.23 8.04395 10.209L7.12012 6.94238C7.08064 6.8273 7.04149 6.69701 7.00098 6.55078C6.99465 6.52201 6.97834 6.49595 6.95605 6.47754C6.93384 6.45936 6.90627 6.44922 6.87793 6.44922Z\" fill=\"#006CB3\"/>\n     3→</svg>\n     4→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8c1e9e65-5db8-4bf8-be7c-58b528bca2d1","timestamp":"2026-01-22T23:08:31.907Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\iconos\\icono_ia_azul.svg","content":"<svg width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M16.0723 20.001C16.07 19.9955 16.0684 19.9893 16.0684 19.9834C16.0684 19.9776 16.0701 19.9721 16.0723 19.9668C16.0758 19.9779 16.0758 19.9899 16.0723 20.001ZM16.0713 11.9131C16.1083 11.9131 16.1447 11.9246 16.1758 11.9453C16.2068 11.9661 16.2318 11.9954 16.2471 12.0303C17.2196 14.2372 17.7054 14.8433 19.874 15.668C19.9104 15.6817 19.9423 15.7067 19.9648 15.7393C19.9874 15.7719 19.9992 15.8115 20 15.8516C20.0007 15.8916 19.99 15.9314 19.9688 15.9648C19.9475 15.9983 19.9167 16.0239 19.8809 16.0391C17.9733 16.8529 17.1519 17.4389 16.248 19.5918C16.2331 19.6273 16.2081 19.6575 16.1768 19.6787C16.1454 19.6999 16.1087 19.7109 16.0713 19.7109C16.034 19.7109 15.9971 19.6999 15.9658 19.6787C15.9347 19.6575 15.9104 19.6272 15.8955 19.5918C14.9916 17.4388 14.1703 16.8583 12.2617 16.0391C12.226 16.0238 12.195 15.9983 12.1738 15.9648C12.1526 15.9314 12.1419 15.8916 12.1426 15.8516C12.1434 15.8114 12.1561 15.7719 12.1787 15.7393C12.2013 15.7066 12.2331 15.6817 12.2695 15.668C14.4401 14.8434 14.925 14.2371 15.8965 12.0303C15.9117 11.9956 15.9359 11.966 15.9668 11.9453C15.9978 11.9246 16.0344 11.9131 16.0713 11.9131ZM14.1279 0C14.6021 2.35356e-05 15.0717 0.0973403 15.5098 0.285156C15.9478 0.472993 16.3463 0.74769 16.6816 1.09473C17.017 1.44178 17.2824 1.85417 17.4639 2.30762C17.6454 2.7611 17.7393 3.24743 17.7393 3.73828V9.63867C17.7397 9.68058 17.7288 9.72187 17.708 9.75781C17.687 9.79389 17.6563 9.82346 17.6201 9.84277C17.584 9.86203 17.5434 9.87037 17.5029 9.86719C17.4624 9.86399 17.4235 9.84894 17.3906 9.82422C17.0089 9.52713 16.544 9.36668 16.0664 9.36621C15.9926 9.36622 15.9194 9.3704 15.8467 9.37793C15.8166 9.38054 15.7864 9.37629 15.7578 9.36621C15.729 9.35601 15.7021 9.33973 15.6797 9.31836C15.6573 9.29702 15.6391 9.27104 15.627 9.24219C15.6149 9.21337 15.6093 9.18182 15.6094 9.15039V3.73438C15.6093 3.53297 15.5705 3.33354 15.4961 3.14746C15.4215 2.96114 15.3117 2.791 15.1738 2.64844C15.0361 2.50603 14.8723 2.39343 14.6924 2.31641C14.5124 2.23938 14.3197 2.19913 14.125 2.19922H3.61426C3.41955 2.19908 3.2268 2.2394 3.04688 2.31641C2.86704 2.39343 2.7031 2.50606 2.56543 2.64844C2.42767 2.79102 2.31765 2.96115 2.24316 3.14746C2.16884 3.33354 2.13077 3.53302 2.13086 3.73438V14.5713C2.13074 14.7729 2.1687 14.9728 2.24316 15.1592C2.31764 15.3455 2.4277 15.5146 2.56543 15.6572C2.70304 15.7997 2.86611 15.913 3.0459 15.9902C3.22592 16.0674 3.41939 16.1074 3.61426 16.1074H9.06738C9.1943 16.1116 9.31709 16.1565 9.41797 16.2363C9.51878 16.3162 9.59276 16.4271 9.62988 16.5527C9.76509 17.092 10.1489 17.4825 10.5576 17.7549C10.6098 17.7897 10.6503 17.8411 10.6719 17.9014C10.6933 17.9616 10.6954 18.0274 10.6777 18.0889C10.66 18.1505 10.6231 18.2049 10.5732 18.2432C10.5235 18.2812 10.4632 18.302 10.4014 18.3018H3.61133C2.65427 18.3018 1.73573 17.908 1.05859 17.208C0.381694 16.5081 0.00121561 15.5587 0 14.5684V3.73828C0.000275677 2.74719 0.380597 1.79658 1.05762 1.0957C1.73481 0.394803 2.65363 0.000285367 3.61133 0H14.1279ZM7.38477 4.79004C7.41033 4.79205 7.43495 4.80192 7.45508 4.81836C7.47505 4.83476 7.49023 4.85672 7.49805 4.88184L10.0986 12.8418C10.109 12.8693 10.1129 12.8993 10.1104 12.9287C10.1077 12.9583 10.0982 12.9875 10.083 13.0127C10.0679 13.0378 10.0469 13.0588 10.0225 13.0742C9.99811 13.0896 9.9708 13.0991 9.94238 13.1016H9.10352C9.06838 13.1004 9.03474 13.0876 9.00684 13.0654C8.97885 13.0432 8.95846 13.0125 8.94824 12.9775L8.45605 11.4707C8.44811 11.4436 8.43177 11.4197 8.41016 11.4023C8.38858 11.3851 8.36222 11.3753 8.33496 11.374H5.41406C5.3869 11.3753 5.36036 11.3851 5.33887 11.4023C5.31738 11.4197 5.30186 11.4437 5.29395 11.4707L4.80273 12.9775C4.7922 13.0135 4.77045 13.0451 4.74121 13.0674C4.712 13.0896 4.67688 13.1018 4.64062 13.1016H3.80859C3.78001 13.0991 3.752 13.0897 3.72754 13.0742C3.70332 13.0588 3.68296 13.0377 3.66797 13.0127C3.65289 12.9875 3.64309 12.9583 3.64062 12.9287C3.63823 12.8993 3.64268 12.8692 3.65332 12.8418L6.25391 4.88184C6.2618 4.85566 6.27768 4.83293 6.29883 4.81641C6.32 4.79987 6.34556 4.79071 6.37207 4.79004H7.38477ZM12.9775 13.0908H11.7852V4.79004H12.9775V13.0908ZM6.87793 6.44922C6.84959 6.44923 6.82202 6.45934 6.7998 6.47754C6.77752 6.49596 6.76121 6.522 6.75488 6.55078C6.71123 6.70247 6.67213 6.83604 6.63574 6.95117L5.71094 10.2109C5.7031 10.2319 5.70009 10.255 5.70215 10.2773C5.70424 10.2995 5.71124 10.3209 5.72266 10.3398C5.73417 10.3589 5.75002 10.3751 5.76855 10.3867C5.78693 10.3983 5.80768 10.4053 5.8291 10.4072H7.92578C7.94752 10.4055 7.96867 10.3984 7.9873 10.3867C8.00605 10.3749 8.02165 10.3582 8.0332 10.3389C8.04468 10.3196 8.05186 10.2979 8.05371 10.2754C8.05556 10.2528 8.05219 10.23 8.04395 10.209L7.12012 6.94238C7.08064 6.8273 7.04149 6.69701 7.00098 6.55078C6.99465 6.52201 6.97834 6.49595 6.95605 6.47754C6.93384 6.45936 6.90627 6.44922 6.87793 6.44922Z\" fill=\"#006CB3\"/>\n</svg>\n","numLines":4,"startLine":1,"totalLines":4}},"sourceToolAssistantUUID":"029aa213-9ab8-43ef-8af2-9f108551e61e"}
{"parentUuid":"8c1e9e65-5db8-4bf8-be7c-58b528bca2d1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_019JexHHRXkWcwxwaVM1MHGe","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora necesito modificar la línea en planes.js para usar este SVG en lugar del icono de Bootstrap. Puedo referenciarlo usando una etiqueta `<img>` con la ruta al archivo SVG.","signature":"EtgCCkYICxgCKkBZBqwIgh+j4B7SwhJtABd0/BK+Wo0lhLUI5wYFQKPIQ2VetFmKgymp45RrLzkMVrHvxlCukl66UMXelzIyuumNEgwgoGvKg8S6yv4aUewaDERHKoNKhIIU+7VTwCIw8QiDOovk3JF9gRARy7K7sADSBdUJSLdlD82ljprUk9E96ue1NVygaxIE+aPJO8UaKr8BEZXz2Zbe8NzUUkLWYaSfmPELeiwdi07x0NdU2zcA3v07aheiesOc+BW7cLDZqLqadCYnIRJLvoYJXjRNJ0xrIa2WHPBnGb1lpURFrKJv0o2LkyDmYB/J/dulr0OHSW1Q3p++kOro6OHJDtIdqDMSt6wsDn8kRT9px7BU/PujYcSmIKkxO+uM+OUjKe3GnaT7NgYeU9QMyJs41VgbkQiiKN0d03dFbnkXzcp1BHADZONjz63BiULTsknflLRrGbQYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3322,"cache_read_input_tokens":99447,"cache_creation":{"ephemeral_5m_input_tokens":3322,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXPFvgrBPm85YUfwdThjP","type":"assistant","uuid":"e5dc5173-3677-469a-9ad7-44d17281e199","timestamp":"2026-01-22T23:08:35.810Z"}
{"parentUuid":"e5dc5173-3677-469a-9ad7-44d17281e199","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_019JexHHRXkWcwxwaVM1MHGe","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a modificar la línea para usar el SVG:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3322,"cache_read_input_tokens":99447,"cache_creation":{"ephemeral_5m_input_tokens":3322,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXPFvgrBPm85YUfwdThjP","type":"assistant","uuid":"ec5c853a-0548-4dfa-95db-b7b054a58f83","timestamp":"2026-01-22T23:08:36.154Z"}
{"parentUuid":"ec5c853a-0548-4dfa-95db-b7b054a58f83","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_019JexHHRXkWcwxwaVM1MHGe","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VZDwZ4aqo2u5gsybSsDFTV","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","offset":175,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3322,"cache_read_input_tokens":99447,"cache_creation":{"ephemeral_5m_input_tokens":3322,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXPFvgrBPm85YUfwdThjP","type":"assistant","uuid":"387cc7e3-3a37-4e66-b32d-b44b55194bb2","timestamp":"2026-01-22T23:08:36.878Z"}
{"parentUuid":"387cc7e3-3a37-4e66-b32d-b44b55194bb2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VZDwZ4aqo2u5gsybSsDFTV","type":"tool_result","content":"   175→                            </p>\n   176→                        </div>\n   177→                    </div>\n   178→                </div>\n   179→            </div>\n   180→        ` : `\n   181→            <div class=\"card my-5\">\n   182→                <div class=\"card-body\">\n   183→                    <div class=\"row\">\n   184→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n   185→                        <div class=\"col-auto my-auto\">\n   186→                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n   187→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   188→                        </div>\n   189→                        <div class=\"col-auto ms-auto my-auto\">\n   190→                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n   191→                        </div>\n   192→                    </div>\n   193→                    <div class=\"row mt-4\">\n   194→                        <div class=\"col-12\">\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"00953960-36fd-439a-87d2-f38bdf45d81f","timestamp":"2026-01-22T23:08:38.548Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","content":"                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">","numLines":20,"startLine":175,"totalLines":474}},"sourceToolAssistantUUID":"387cc7e3-3a37-4e66-b32d-b44b55194bb2"}
{"parentUuid":"00953960-36fd-439a-87d2-f38bdf45d81f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WNxvA1Z4SLHPXziLsV3fdX","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Ahora puedo modificar la línea 186 para usar el SVG en lugar del icono de Bootstrap.","signature":"Ev0BCkYICxgCKkCKE7XUY4ToPoEV740EyJC2iXvkFhTZbWo+INjuLEjsinCZGnJnxvrZETPSgiw4p/TXrWJyKUUJ2IUdhGGlM24tEgwsriX/Fk6fiza8niwaDJUV0zKXFd0A/QyRqyIwwbx/PAHCzhPokAYmwW4Y9LAVFNagIHBRgVsjjBmzwBX01PwwFD7ncOAID9YaFpcPKmUK7Zy6odTHoWDpsV9EMkOt4uL+f4VqlBO3eHMACHwkSWhjFeN2k2GQ1CqsimpXhvyohRFfioZFNOTnWZj51Y8m0eXMqUAC4MYSk0vJ9AyXJXYaKlQfpPo4FETPl1fyfEGpUXZG9hgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":661,"cache_read_input_tokens":102769,"cache_creation":{"ephemeral_5m_input_tokens":661,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXPFwAjifQjdVhYDqdPRK","type":"assistant","uuid":"3cca4713-8344-487b-a36d-43958ed23a0b","timestamp":"2026-01-22T23:08:41.585Z"}
{"parentUuid":"3cca4713-8344-487b-a36d-43958ed23a0b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WNxvA1Z4SLHPXziLsV3fdX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01H7CxYGsNr4hGHF8SwD9YvE","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","old_string":"                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>","new_string":"                            <p class=\"m-0 text-body-3\"><img src=\"/iconos/icono_ia_azul.svg\" alt=\"IA\" class=\"me-2\" style=\"width: 20px; height: 20px;\">Plan de Créditos</p>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":661,"cache_read_input_tokens":102769,"cache_creation":{"ephemeral_5m_input_tokens":661,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXPFwAjifQjdVhYDqdPRK","type":"assistant","uuid":"5eae142e-50a2-4876-9a6d-2eb199189e5c","timestamp":"2026-01-22T23:08:43.401Z"}
{"parentUuid":"5eae142e-50a2-4876-9a6d-2eb199189e5c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01H7CxYGsNr4hGHF8SwD9YvE","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   182→                <div class=\"card-body\">\n   183→                    <div class=\"row\">\n   184→                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n   185→                        <div class=\"col-auto my-auto\">\n   186→                            <p class=\"m-0 text-body-3\"><img src=\"/iconos/icono_ia_azul.svg\" alt=\"IA\" class=\"me-2\" style=\"width: 20px; height: 20px;\">Plan de Créditos</p>\n   187→                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n   188→                        </div>\n   189→                        <div class=\"col-auto ms-auto my-auto\">\n   190→                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>"}]},"uuid":"085061be-999a-483c-9f2c-d32c39162980","timestamp":"2026-01-22T23:08:50.002Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresa\\planes\\planes.js","oldString":"                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>","newString":"                            <p class=\"m-0 text-body-3\"><img src=\"/iconos/icono_ia_azul.svg\" alt=\"IA\" class=\"me-2\" style=\"width: 20px; height: 20px;\">Plan de Créditos</p>","originalFile":"let empresa_id = $('#input_empresa_id').val();\nlet usuario_id = $('#input_usuario_id').val();\nlet empresas_planes = [];\nlet usuarios_ids = [];\nlet sucursales = JSON.parse($('#input_sucursales').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet usuarios = JSON.parse($('#input_usuarios').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet empresa = JSON.parse($('#input_empresa').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nlet planes = JSON.parse($('#input_planes').val().replace(/\\\\/g, '/').replace(/[\\n\\t\\r]/g, ''));\nusuarios_ids = usuarios.map(usuario => usuario.id);\nlet total_usuarios = usuarios_ids.length;\n\nconst ESTADOS_PLANES = {\n    'Activo': crearTag({ texto: 'Activo', class: 'tag-tonal-green px-5 py-4'}),\n    'Inactivo': crearTag({ texto: 'Inactivo', class: 'tag-tonal-gray px-5 py-4'}),\n    'Próximo': crearTag({ texto: 'Próximo', class: 'tag-tonal-purple px-5 py-4'}),\n    'Por vencer': crearTag({ texto: 'Por vencer', class: 'tag-tonal-yellow px-5 py-4'}),\n    'Vencido': crearTag({ texto: 'Vencido', class: 'tag-tonal-red px-5 py-4'}),\n    'Renovando': crearTag({ texto: 'Renovando', class: 'tag-tonal-blue px-5 py-4'}),\n};\n\nconst ICONOS_PLANES_TIPO = {\n    'Selección': 'bi-person-bounding-box',\n    'Organizacional': 'bi-diagram-3-fill',\n    'Vocacional': 'bi-mortarboard-fill',\n};\n\n/**\n * Obtiene la data para mostrar en la tabla de planes de la empresa.\n *\n * @returns {void}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n * @author Sergio Vargas\n*/\nasync function traerDatos() {\n    try {\n        let respuesta = await $.ajax({ method: 'GET', url: `empresas-planes-listado-tabla/${empresa_id}` });\n        listarPlanes(respuesta.data.empresas_planes, respuesta.data.sucursales_consumos_agendas, respuesta.data.sucursales_consumos_ofertas_laborales);\n        empresas_planes = respuesta.data.empresas_planes;\n    } catch (error) {\n        console.error(error);\n    }\n}\ntraerDatos();\n\n/**\n * Crea el componente html de los planes de la empresa\n *\n * @param {array} empresas_planes Arreglo de datos de empresas-planes de la empresa.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n * @author Jair Carvajal\n * @author Andres González\n */\nfunction listarPlanes(empresas_planes, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    let contenidoHTML = empresas_planes.map(empresa_plan => {\n        let consumos_empresas = obtenerConsumos(empresa_plan.consumos);\n        let lista_consumos_por_sucursal = listarCantidadConsumosSucursales(empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales);\n\n        let { plan, fecha_vencimiento, precio, estado, vigencia_dias, unidades, cantidad_ofertas_laborales, cantidad_usuarios, consumos } = empresa_plan;\n        if (!plan) {\n            return '';\n        }\n        let suscripcion_ilimitada = !!fecha_vencimiento;\n\n        let fecha_inicio = diferenciaFechasDias((new Date()).toString(), empresa_plan.fecha_inicio) >= 0\n            ? empresa_plan.fecha_inicio\n            : (new Date()).toString();\n\n        let dias_restantes = suscripcion_ilimitada\n            ? diferenciaFechasDias(fecha_inicio, empresa_plan.fecha_vencimiento, false, false)\n            : null;\n\n        let unidades_consumidas = empresa_plan.conteo_consumos_agendas ?? 0;\n        let ofertas_laborales_consumidas = empresa_plan.conteo_consumos_ofertas_laborales ?? 0;\n\n        return empresa_plan.plan_credito_id === null ? `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi ${ICONOS_PLANES_TIPO[plan.tipo_prueba.nombre]} me-2 text-primary text-body-2\"></i>${plan.tipo_prueba.nombre}</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${plan.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: ${precio.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                        <div class=\"col-auto my-auto\">\n                            <div class=\"dropdown\">\n                                ${crearBoton({\n                                    clases: 'btn-outline-primary btn-circle dropdown-toggle',\n                                    texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                    data: [{ texto: 'bs-toggle', value: 'dropdown' }]\n                                })}\n                                <div class=\"dropdown-menu dropdown-menu-start\">\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirModalSolicitudRenovacionPlan(${plan.id}, '${plan.nombre}')\">\n                                        Solicitar renovación\n                                    </button>\n                                    <button class=\"dropdown-item no-visited\" onclick=\"abrirFacturaPlan('${empresa_plan?.archivos[0]?.id}')\">\n                                        Ver factura\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class=\"table-responsive mt-4\">\n                        <table class=\"table\">\n                            <tbody>\n                                <tr id=\"contenedor_plan_padre\">\n                                    <td class=\"py-0 my-0 border-0\">\n                                        <div class=\"card bg-gray-90 border-0\">\n                                            <div class=\"card-body py-2\">\n                                                <div class=\"row\">\n                                                    <div class=\"col-auto my-auto\">\n                                                        ${crearBoton({\n                                                            clases: 'btn-text-gray text-label-2',\n                                                            texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                            onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                                        })}\n                                                    </div>\n                                                    <div class=\"col my-auto\">\n                                                        <div class=\"card bg-white border-0\">\n                                                            <div class=\"card-body py-2\">\n                                                                <div class=\"row\">\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Unidades', 'box', unidades_consumidas, unidades, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Vacantes', 'briefcase', ofertas_laborales_consumidas, cantidad_ofertas_laborales, true)}\n                                                                    </div>\n                                                                    <div class=\"col-4 px-7\">\n                                                                        ${crearProgressBarTemplate('Usuarios', 'person', total_usuarios, cantidad_usuarios, true)}\n                                                                    </div>\n                                                                </div>\n                                                            </div>\n                                                        </div>\n                                                    </div>\n                                                    <div class=\"col-auto my-auto ps-0\">\n                                                        ${crearBoton({\n                                                            tooltip: `${crearTooltip({\n                                                                placement: `top`,\n                                                                content: `Detalle de consumo`,\n                                                                toggle: `popover`,\n                                                            })}`,\n                                                            clases: 'btn-text-primary btn-circle p-2',\n                                                            texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                            onclick: `abrirModalConsumos(${empresa_plan.id}, '${plan.nombre}', '${plan.tipo_prueba.nombre}')`,\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </td>\n                                </tr>\n                                ${lista_consumos_por_sucursal}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"row mt-5\">\n                        <div class=\"col-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-3\"><i class=\"bi bi-clock me-2\"></i>Duración: ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias} día(s)` : 'Sin vigencia'}</span>\n                                <span class=\"\">quedan ${ suscripcion_ilimitada ? `${parseInt(dias_restantes) >= 0 ? `${parseInt(dias_restantes)}` : '0'}` : ''} de ${empresa_plan.vigencia_dias ? `${empresa_plan.vigencia_dias}` : '0'} días</span>\n                            </p>\n                        </div>\n                        <div class=\"col-auto ms-auto\">\n                            <p class=\"text-label-2\">\n                                <span class=\"me-4\">Vigencia</span>\n                                <span class=\"me-4\"><i class=\"bi bi-circle-fill small-1 text-green-cta me-2\"></i>${convertirFecha(empresa_plan.fecha_inicio)}</span>\n                                ${ suscripcion_ilimitada ? `<span class=\"\"><i class=\"bi bi-circle-fill small-1 text-danger me-2\"></i>${convertirFecha(empresa_plan.fecha_vencimiento)}</span>` : '' }\n                            </p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ` : `\n            <div class=\"card my-5\">\n                <div class=\"card-body\">\n                    <div class=\"row\">\n                        <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>\n                        <div class=\"col-auto my-auto\">\n                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>\n                            <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>\n                        </div>\n                        <div class=\"col-auto ms-auto my-auto\">\n                            <p class=\"m-0 text-body-3\">Costo: $ ${empresa_plan.plan_credito.precio?.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' }) ?? 0}</p>\n                        </div>\n                    </div>\n                    <div class=\"row mt-4\">\n                        <div class=\"col-12\">\n                            <div class=\"card bg-gray-90 border-0\">\n                                <div class=\"card-body py-3\">\n                                    <div class=\"row\">\n                                        <div class=\"col-auto my-auto\">\n                                            ${crearBoton({\n                                                clases: 'btn-text-gray text-label-2',\n                                                texto: `Sucursales: ${consumos_empresas.length} <i class=\"bi bi-caret-down-fill\"></i>`,\n                                                onclick: `toggleSucursalesList('${empresa_plan.id + '_' + empresa_plan.plan_id + '_' + empresa_plan.numero_factura}', this)`,\n                                            })}\n                                        </div>\n                                        <div class=\"col my-auto\">\n                                            ${crearProgressBarTemplate('Créditos disponibles', 'coin', empresa_plan.creditos_consumidos ?? 0, empresa_plan.plan_credito.creditos ?? 0, true)}\n                                        </div>\n                                        <div class=\"col-auto my-auto ps-0\">\n                                            ${crearBoton({\n                                                tooltip: `${crearTooltip({\n                                                    placement: `top`,\n                                                    content: `Ver detalle consumo`,\n                                                    toggle: `popover`,\n                                                })}`,\n                                                clases: 'btn-text-primary btn-circle p-2',\n                                                texto: '<i class=\"bi bi-eye text-headline-4\"></i>',\n                                                onclick: `abrirModalConsumosCreditos(${empresa_plan.empresa_id}, ${empresa_plan.id}, '${empresa_plan.plan_credito.nombre}')`,\n                                            })}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;\n    }).join('');\n\n    $('#listado-planes').html(contenidoHTML);\n    inicializarTooltips();\n}\n\n/**\n * Crea el componente HTML de los progress bars de los consumos.\n *\n * @param {string} label Etiqueta del progress bar.\n * @param {string} icono Icono del progress bar.\n * @param {number} valor Valor actual del consumo.\n * @param {number} total Valor total del consumo.\n * @param {boolean} un_text Booleano para mostrar o no el texto.\n * @returns {string} HTML del progress bar.\n * @author Andres Morales\n */\nfunction crearProgressBarTemplate(label, icono, valor, total, un_text) {\n    return `\n        ${un_text ? '<p class=\"text-label-1 mb-1\">' : ''}${icono ? `<i class=\"bi bi-${icono} text-headline-5 me-2\"></i>` : ''}${label}${un_text ? '</p>' : ''}\n        ${crearProgressBar({\n            label: `${valor}/${total ?? 0}`,\n            height: '8px',\n            porcentaje: { porcentaje: (valor / (total ?? 1)) * 100, texto: false }\n        })}\n    `;\n}\n\n/**\n * Retornar el componente html de la lista de cantidades de consumos agrupados por sucursal.\n *\n * @param {Object} empresa_plan Registro de la tabla empresas_planes.\n * @param {array} sucursales_consumos_agendas Arreglo de los conteos de los consumos de agendas de las sucursales de la empresa.\n * @param {array} sucursales_consumos_ofertas_laborales Arreglo de los conteos de los consumos de ofertas laborales de las sucursales de la empresa.\n * @returns {string}\n * @author Andres Morales\n * @author Fahibram Cárcamo\n * @author Sergio Vargas\n */\nfunction listarCantidadConsumosSucursales (empresa_plan, sucursales_consumos_agendas, sucursales_consumos_ofertas_laborales) {\n    if (!empresa_plan.plan) {\n        return '';\n    }\n    return sucursales.map(sucursal => {\n        let conteos_consumos_agendas_sucursal = sucursales_consumos_agendas.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n        let conteos_consumos_ofertas_laborales_sucursal = sucursales_consumos_ofertas_laborales.find(sucursal_busqueda => sucursal_busqueda.id === sucursal.id);\n\n        let total_agendas_consumidas_sucursal = conteos_consumos_agendas_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_ofertas_laborales_consumidas_sucursal = conteos_consumos_ofertas_laborales_sucursal?.consumos_agrupados_por_empresa_plan\n            ?.find(conteo => conteo.empresa_plan_id === empresa_plan.id)\n            ?.conteo_consumos ?? 0;\n\n        let total_usuarios_sucursal = obtenerTotalUsuarios(sucursal);\n        let plan = empresa_plan.plan;\n\n        return `\n            <tr class=\"contenedor_plan_hijo_${empresa_plan.id}_${plan.id}_${empresa_plan.numero_factura} d-none\">\n                <td class=\"py-0 my-0\">\n                    <div class=\"card border-0\">\n                        <div class=\"card-body py-2 px-10\">\n                            <div class=\"row\">\n                                <div class=\"col-2 my-auto text-body-3 text-wrap\">\n                                    ${sucursal.nombre_comercial}\n                                </div>\n                                <div class=\"col my-auto\">\n                                    <div class=\"card bg-white border-0\">\n                                        <div class=\"card-body py-2\">\n                                            <div class=\"row\">\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Unidades',\n                                                            'box',\n                                                            total_agendas_consumidas_sucursal,\n                                                            plan.unidades,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Vacantes',\n                                                            'briefcase',\n                                                            total_ofertas_laborales_consumidas_sucursal,\n                                                            plan.cantidad_ofertas_laborales,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                                <div class=\"col-4 px-7\">\n                                                    ${\n                                                        crearProgressBarTemplate(\n                                                            'Usuarios',\n                                                            'person',\n                                                            total_usuarios_sucursal,\n                                                            plan.cantidad_usuarios,\n                                                            false\n                                                        )\n                                                    }\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </td>\n            </tr>\n        `;\n    }).join('');\n}\n\n/**\n * Agrupar los consumos de un plan por empresa.\n *\n * @param {Object} empresa_plan_consumos Consumos del registro de la tabla empresas_planes.\n * @returns {array}\n * @author Andres Morales\n */\nfunction obtenerConsumos(empresa_plan_consumos) {\n    if (!empresa_plan_consumos || empresa_plan_consumos.length === 0) return sucursales;\n\n    let consumos_empresas = new Map();\n\n    empresa_plan_consumos.forEach(consumo => {\n        let empresa = consumo.empresa;\n        if (!consumos_empresas.has(empresa.id)) {\n            empresa.consumos = [];\n            consumos_empresas.set(empresa.id, empresa);\n        }\n        consumos_empresas.get(empresa.id).consumos.push(consumo);\n    });\n\n    sucursales.forEach(sucursal => {\n        if (!consumos_empresas.has(sucursal.id)) {\n            consumos_empresas.set(sucursal.id, sucursal);\n        }\n    });\n\n    return Array.from(consumos_empresas.values());\n}\n\n/**\n * Retornar la suma total de usuarios de una empresa o de todas las empresas.\n *\n * @param {Object|null} empresa Empresa a la que pertenecen los usuarios.\n * @returns {number}\n * @author Andres Morales\n */\nfunction obtenerTotalUsuarios(empresa = null) {\n    let usuarios_temporal = empresa?.usuarios ?? usuarios;\n    let usuarios_ids_temporal = new Set();\n    usuarios_temporal.forEach(usuario => {\n        if (usuarios_ids.includes(usuario.id)) {\n            usuarios_ids_temporal.add(usuario.id);\n        }\n    });\n    return usuarios_ids_temporal.size;\n}\n\n/**\n * Abrir y cerrar el contenido de la lista de consumos por sucursal.\n *\n * @param {string} id Id del elemento a mostar u ocultar.\n * @param {string} elemento Elemento padre del menú de acciones.\n * @returns {void}\n * @author Andres Morales\n */\nfunction toggleSucursalesList(id, elemento) {\n    $('.contenedor_plan_hijo_' + id).toggleClass('d-none');\n    $(elemento).find('i').toggleClass('bi-caret-down-fill bi-caret-up-fill');\n}\n\n/**\n * Realizar la consulta HTTP para solicitar la renovación de un plan.\n *\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function solicitarRenovacionPlan() {\n    $('#modal-solicitar-renovacion').modal('hide');\n    let plan_id = $('#id-plan-solicitar-renovacion').val();\n    await $.ajax({\n        type: 'POST',\n        url : '/solicitud-renovacion-plan',\n        data: {\n            plan_id,\n            empresa_id,\n            usuario_id,\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then(respuesta => {\n        $('#nombre-plan-solicitar-renovacion').text('');\n        $('#id-plan-solicitar-renovacion').val('');\n        mostrarToast('success', 'Solicitud de renovación de plan realizada');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error en la solicitud');\n    });\n}\n\n/**\n * Abrir el modal de confirmación de solicitud de renovación de un plan.\n *\n * @param {number} plan_id Id del plan.\n * @param {string} nombre_plan Nombre del plan.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalSolicitudRenovacionPlan(plan_id, nombre_plan) {\n    $('#nombre-plan-solicitar-renovacion').text(nombre_plan);\n    $('#id-plan-solicitar-renovacion').val(plan_id);\n    $('#modal-solicitar-renovacion').modal('show');\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id){\n    if (factura_id) {\n        await $.ajax({\n            type: 'GET',\n            url: `archivos-abrir/${factura_id}`,\n            xhrFields: {responseType: 'blob'},\n        })\n            .then(respuesta => {\n                let ruta_factura = window.URL.createObjectURL(respuesta);\n                window.open(ruta_factura, '_blank');\n            })\n            .catch((error) => {\n                mostrarToast('danger', 'Ocurrió un error en la solicitud');\n            });\n    } else {\n        mostrarToast('danger', 'No se encontró la factura');\n    }\n}\n","structuredPatch":[{"oldStart":183,"oldLines":7,"newStart":183,"newLines":7,"lines":["                     <div class=\"row\">","                         <div class=\"col-auto my-auto\">${ESTADOS_PLANES[estado.nombre]}</div>","                         <div class=\"col-auto my-auto\">","-                            <p class=\"m-0 text-body-3\"><i class=\"bi bi-coin me-2 text-primary text-body-2\"></i>Plan de Créditos</p>","+                            <p class=\"m-0 text-body-3\"><img src=\"/iconos/icono_ia_azul.svg\" alt=\"IA\" class=\"me-2\" style=\"width: 20px; height: 20px;\">Plan de Créditos</p>","                             <p class=\"m-0 text-headline-3 fw-bolder\">${empresa_plan.plan_credito.nombre}</p>","                         </div>","                         <div class=\"col-auto ms-auto my-auto\">"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"5eae142e-50a2-4876-9a6d-2eb199189e5c"}
{"parentUuid":"085061be-999a-483c-9f2c-d32c39162980","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01S6MSr1E9V8mFC2cEs11stA","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Listo. He reemplazado el icono de Bootstrap por el SVG personalizado usando una etiqueta `<img>` con la ruta al archivo SVG.","signature":"EqUCCkYICxgCKkBLDTZyJQA/80KatxJMdayBm3QPXqr7FwJqczlV01MaBwiNcn+K+9jYLYjlXgEmL93FjW17lKHvJWFfNg9Vb1lEEgwFgpA3kA8z26yk26IaDFdQ2YMyWu/TK/IiTSIwcIabkVND71oUDmFnIWilmD1H3Clu8UlwNwdIsW+k73BZl2ZusXg0dMGwPzm7rlE6KowBBPCa1WLt5wWDl4UCQTTYzKgblNattRcgYcNwindbbZ6WKwnInzVYxpLGeBlQksjLoaHVp3KGhN6qmJeG9xsD8f711pFfkriKXyl7+3a+bWQy/K8ajSZIureeyQgvqx4QDTAmWpZaE+q2vBn4PV1y9yXOKnXaCXOMr8fFVd/cobA35FVkmDb4l2G/W+IYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":626,"cache_read_input_tokens":103430,"cache_creation":{"ephemeral_5m_input_tokens":626,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXPFx8Sar1E1WyKVB7DAu","type":"assistant","uuid":"29538130-03b2-4ee6-8a2a-a14388481d30","timestamp":"2026-01-22T23:08:54.548Z"}
{"parentUuid":"29538130-03b2-4ee6-8a2a-a14388481d30","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"b401d6f2-1b2f-4795-ba95-7a87e0946bcb","version":"2.1.15","gitBranch":"D26-260","slug":"polished-inventing-aho","message":{"model":"claude-opus-4-5-20251101","id":"msg_01S6MSr1E9V8mFC2cEs11stA","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He reemplazado el icono `bi bi-coin` por el SVG personalizado de IA:\n\n```html\n<img src=\"/iconos/icono_ia_azul.svg\" alt=\"IA\" class=\"me-2\" style=\"width: 20px; height: 20px;\">\n```\n\nEl SVG se cargará desde `/iconos/icono_ia_azul.svg` con un tamaño de 20x20px (mismo tamaño definido en el SVG original)."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":626,"cache_read_input_tokens":103430,"cache_creation":{"ephemeral_5m_input_tokens":626,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXPFx8Sar1E1WyKVB7DAu","type":"assistant","uuid":"df6cc2d2-0d38-4c9e-a1ca-55522eb90333","timestamp":"2026-01-22T23:08:56.163Z"}

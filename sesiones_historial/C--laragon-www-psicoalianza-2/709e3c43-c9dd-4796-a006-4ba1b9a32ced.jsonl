{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-19T19:48:10.611Z","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced"}
{"type":"file-history-snapshot","messageId":"3f112933-6e10-4629-9262-da2be10bb09b","snapshot":{"messageId":"3f112933-6e10-4629-9262-da2be10bb09b","trackedFileBackups":{},"timestamp":"2026-01-19T19:48:10.724Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"hola aqui me genera eerro de que no existe opcion_formulario if (opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n        $(\"#digito_verificacion\").val(numero)\n    } me puedes colocar otra validacion valilando la existencia del mismo"}]},"uuid":"3f112933-6e10-4629-9262-da2be10bb09b","timestamp":"2026-01-19T19:48:10.718Z"}
{"parentUuid":"3f112933-6e10-4629-9262-da2be10bb09b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01V7fCdsNDQEYZZ777ZeCidQ","type":"message","role":"assistant","content":[{"type":"text","text":"Hola, el error ocurre porque `opcion_form` no está definida en ese contexto. Déjame revisar el archivo para entender mejor la estructura y proponer una solución."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":25214,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25214,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXHKDnRqCFYmrrJyDbw1p","type":"assistant","uuid":"782ff931-25e0-4d54-af9d-0d6454e4b1f6","timestamp":"2026-01-19T19:48:14.243Z"}
{"parentUuid":"782ff931-25e0-4d54-af9d-0d6454e4b1f6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01V7fCdsNDQEYZZ777ZeCidQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Gib19N8UVJeQ7fxJgudGqo","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":25214,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25214,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXHKDnRqCFYmrrJyDbw1p","type":"assistant","uuid":"9d0cde7a-4046-4742-94c3-c3d3197ac7cb","timestamp":"2026-01-19T19:48:14.664Z"}
{"parentUuid":"9d0cde7a-4046-4742-94c3-c3d3197ac7cb","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"File content (39666 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","is_error":true,"tool_use_id":"toolu_01Gib19N8UVJeQ7fxJgudGqo"}]},"uuid":"e7183a3c-fdbd-46eb-b83b-fa9211673eb1","timestamp":"2026-01-19T19:48:16.876Z","toolUseResult":"Error: File content (39666 tokens) exceeds maximum allowed tokens (25000). Please use offset and limit parameters to read specific portions of the file, or use the GrepTool to search for specific content.","sourceToolAssistantUUID":"9d0cde7a-4046-4742-94c3-c3d3197ac7cb"}
{"parentUuid":"e7183a3c-fdbd-46eb-b83b-fa9211673eb1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_013knLs3JJnihDzpnJRf7y2s","type":"message","role":"assistant","content":[{"type":"text","text":"El archivo es muy grande. Déjame buscar el contexto específico donde está ese código."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":190,"cache_read_input_tokens":25214,"cache_creation":{"ephemeral_5m_input_tokens":190,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXHKEEvY5qDUwPtbmqNvK","type":"assistant","uuid":"0d915980-1168-4433-b878-e4e33490b7e7","timestamp":"2026-01-19T19:48:19.737Z"}
{"parentUuid":"0d915980-1168-4433-b878-e4e33490b7e7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_013knLs3JJnihDzpnJRf7y2s","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TFK7bdhq34UZv2vPsKs58M","name":"Grep","input":{"pattern":"opcion_form.*Editar.*digito_verificacion","path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js","output_mode":"content","-C":10}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":190,"cache_read_input_tokens":25214,"cache_creation":{"ephemeral_5m_input_tokens":190,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXHKEEvY5qDUwPtbmqNvK","type":"assistant","uuid":"8d52157d-2eec-4985-add0-0c1c40b8ed0d","timestamp":"2026-01-19T19:48:21.063Z"}
{"parentUuid":"8d52157d-2eec-4985-add0-0c1c40b8ed0d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TFK7bdhq34UZv2vPsKs58M","type":"tool_result","content":"No matches found"}]},"uuid":"d0b3b283-70d2-4d12-a5ac-dcf7ea5d7e21","timestamp":"2026-01-19T19:48:24.025Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0},"sourceToolAssistantUUID":"8d52157d-2eec-4985-add0-0c1c40b8ed0d"}
{"parentUuid":"d0b3b283-70d2-4d12-a5ac-dcf7ea5d7e21","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01ErdLLtFW3s4wzYTvwoF57n","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014R8ijFxS8uJXkz8M1Mk8rs","name":"Grep","input":{"pattern":"digito_verificacion","path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js","output_mode":"content","-C":10}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":182,"cache_read_input_tokens":25404,"cache_creation":{"ephemeral_5m_input_tokens":182,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXHKEmihQCTuLpzhQSXw4","type":"assistant","uuid":"47f0418e-6203-465d-91cf-ea855c155ef0","timestamp":"2026-01-19T19:48:27.621Z"}
{"parentUuid":"47f0418e-6203-465d-91cf-ea855c155ef0","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014R8ijFxS8uJXkz8M1Mk8rs","type":"tool_result","content":"469-        mostrarToast('danger', error.responseJSON.errors);\n470-        empresa_id_eliminar = null;\n471-        empresa_nombre_eliminar = '';\n472-        $('#modal-confirmar-eliminacion').modal('hide');\n473-    });\n474-}\n475-\n476-$(document).ready(function () {\n477-    if (opcion_form == \"Editar\") {\n478-        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n479:        $(\"#digito_verificacion\").val(numero)\n480-    }\n481-    \n482-    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n483-    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n484-    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n485-    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n486-\n487-    inicializarSelect2Asincrono('filtro_empresa_id', 'empresas-listado', 'razon_social', { id: 'id', nombre: 'razon_social' }, false, { solo_principales: true });\n488-\n489-    configurarFormulario('formulario-archivos');\n--\n1314-                }\n1315-                if (empresa.es_persona_juridica == 1) {\n1316-                    $(\"#es_persona_juridica_si\").prop('checked', true);\n1317-                } else {\n1318-                    $(\"#es_persona_juridica_no\").prop('checked', true);\n1319-                }\n1320-                $('#razon_social').val(empresa.razon_social);\n1321-                $('#nombre_comercial').val(empresa.nombre_comercial);\n1322-                let documento = empresa.documento.split('-');\n1323-                $('#documento').val(documento[0]);\n1324:                $('#digito_verificacion').val(documento[1]);\n1325-                $('#sector_id').val(empresa.sector_id).trigger('change').trigger('select2:select');\n1326-                $('#tamano_empresa_id').val(empresa.tamano_empresa_id).trigger('change').trigger('select2:select');\n1327-                $('#procesos_estimados_mensuales').val(empresa.procesos_estimados_mensuales);\n1328-                $('#pruebas_estimadas_mensuales').val(empresa.pruebas_estimadas_mensuales);\n1329-                $('#pais_id').data('departamento_id', empresa.ciudad.departamento_id);\n1330-                $('#pais_id').val(empresa.ciudad.departamento.pais_id).trigger('change').trigger('select2:select');\n1331-                $('#departamento_id').data('ciudad_id', empresa.ciudad.id);\n1332-                $('#departamento_id').val(empresa.departamento_id).trigger('change').trigger('select2:select');\n1333-                $('#ciudad_id').val(empresa.ciudad_id).trigger('change').trigger('select2:select');\n1334-                $('#direccion').val(empresa.direccion);"}]},"uuid":"78abaca0-340c-437d-a75a-b406baa75f1d","timestamp":"2026-01-19T19:48:30.608Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"469-        mostrarToast('danger', error.responseJSON.errors);\n470-        empresa_id_eliminar = null;\n471-        empresa_nombre_eliminar = '';\n472-        $('#modal-confirmar-eliminacion').modal('hide');\n473-    });\n474-}\n475-\n476-$(document).ready(function () {\n477-    if (opcion_form == \"Editar\") {\n478-        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n479:        $(\"#digito_verificacion\").val(numero)\n480-    }\n481-    \n482-    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n483-    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n484-    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n485-    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n486-\n487-    inicializarSelect2Asincrono('filtro_empresa_id', 'empresas-listado', 'razon_social', { id: 'id', nombre: 'razon_social' }, false, { solo_principales: true });\n488-\n489-    configurarFormulario('formulario-archivos');\n--\n1314-                }\n1315-                if (empresa.es_persona_juridica == 1) {\n1316-                    $(\"#es_persona_juridica_si\").prop('checked', true);\n1317-                } else {\n1318-                    $(\"#es_persona_juridica_no\").prop('checked', true);\n1319-                }\n1320-                $('#razon_social').val(empresa.razon_social);\n1321-                $('#nombre_comercial').val(empresa.nombre_comercial);\n1322-                let documento = empresa.documento.split('-');\n1323-                $('#documento').val(documento[0]);\n1324:                $('#digito_verificacion').val(documento[1]);\n1325-                $('#sector_id').val(empresa.sector_id).trigger('change').trigger('select2:select');\n1326-                $('#tamano_empresa_id').val(empresa.tamano_empresa_id).trigger('change').trigger('select2:select');\n1327-                $('#procesos_estimados_mensuales').val(empresa.procesos_estimados_mensuales);\n1328-                $('#pruebas_estimadas_mensuales').val(empresa.pruebas_estimadas_mensuales);\n1329-                $('#pais_id').data('departamento_id', empresa.ciudad.departamento_id);\n1330-                $('#pais_id').val(empresa.ciudad.departamento.pais_id).trigger('change').trigger('select2:select');\n1331-                $('#departamento_id').data('ciudad_id', empresa.ciudad.id);\n1332-                $('#departamento_id').val(empresa.departamento_id).trigger('change').trigger('select2:select');\n1333-                $('#ciudad_id').val(empresa.ciudad_id).trigger('change').trigger('select2:select');\n1334-                $('#direccion').val(empresa.direccion);","numLines":43},"sourceToolAssistantUUID":"47f0418e-6203-465d-91cf-ea855c155ef0"}
{"parentUuid":"78abaca0-340c-437d-a75a-b406baa75f1d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Hw221vs9wyfcugyRiFsEbN","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora veo el problema. En la línea 477 se usa `opcion_form` que debe estar definida en algún lugar (probablemente viene de la vista Blade). Déjame buscar dónde se define esta variable."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1099,"cache_read_input_tokens":25586,"cache_creation":{"ephemeral_5m_input_tokens":1099,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXHKFFbzMr7RK7U84tgcS","type":"assistant","uuid":"91eebbc5-131d-4567-91a1-fe176ba8fe5c","timestamp":"2026-01-19T19:48:33.975Z"}
{"parentUuid":"91eebbc5-131d-4567-91a1-fe176ba8fe5c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Hw221vs9wyfcugyRiFsEbN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AHUwgcpyeD1iBcb37YG8r2","name":"Grep","input":{"pattern":"opcion_form","path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1099,"cache_read_input_tokens":25586,"cache_creation":{"ephemeral_5m_input_tokens":1099,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXHKFFbzMr7RK7U84tgcS","type":"assistant","uuid":"a54f219b-e82b-4a09-a675-f91acafce9ac","timestamp":"2026-01-19T19:48:34.888Z"}
{"parentUuid":"a54f219b-e82b-4a09-a675-f91acafce9ac","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AHUwgcpyeD1iBcb37YG8r2","type":"tool_result","content":"477:    if (opcion_form == \"Editar\") {\n532:                if (opcion_form === 'Editar') {"}]},"uuid":"214ecc69-620b-4eca-b298-032963bacba7","timestamp":"2026-01-19T19:48:38.594Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"477:    if (opcion_form == \"Editar\") {\n532:                if (opcion_form === 'Editar') {","numLines":2},"sourceToolAssistantUUID":"a54f219b-e82b-4a09-a675-f91acafce9ac"}
{"parentUuid":"214ecc69-620b-4eca-b298-032963bacba7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DCsxdjV38avoqNTKYbEorV","type":"message","role":"assistant","content":[{"type":"text","text":"La variable `opcion_form` se usa pero no se define en este archivo JS. Probablemente viene de la vista Blade. La solución es agregar una validación de existencia. Aquí está la corrección:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":238,"cache_read_input_tokens":26685,"cache_creation":{"ephemeral_5m_input_tokens":238,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXHKFqskozz28AnMCND5q","type":"assistant","uuid":"192ab935-de4c-456b-ad26-57f0c40f433d","timestamp":"2026-01-19T19:48:42.066Z"}
{"parentUuid":"192ab935-de4c-456b-ad26-57f0c40f433d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DCsxdjV38avoqNTKYbEorV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SuXVFS9tVQUpA6sRZYcrFj","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js","old_string":"$(document).ready(function () {\n    if (opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n        $(\"#digito_verificacion\").val(numero)\n    }","new_string":"$(document).ready(function () {\n    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\" && typeof empresa !== 'undefined' && empresa.documento) {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;\n        $(\"#digito_verificacion\").val(numero)\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":238,"cache_read_input_tokens":26685,"cache_creation":{"ephemeral_5m_input_tokens":238,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXHKFqskozz28AnMCND5q","type":"assistant","uuid":"dac5d3c6-94ba-421d-ba6c-649a9c42656d","timestamp":"2026-01-19T19:48:43.939Z"}
{"parentUuid":"dac5d3c6-94ba-421d-ba6c-649a9c42656d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File has not been read yet. Read it first before writing to it.</tool_use_error>","is_error":true,"tool_use_id":"toolu_01SuXVFS9tVQUpA6sRZYcrFj"}]},"uuid":"6b24c14f-5afc-4a60-9d57-35c4d1e48c8a","timestamp":"2026-01-19T19:48:44.126Z","toolUseResult":"Error: File has not been read yet. Read it first before writing to it.","sourceToolAssistantUUID":"dac5d3c6-94ba-421d-ba6c-649a9c42656d"}
{"parentUuid":"6b24c14f-5afc-4a60-9d57-35c4d1e48c8a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MowuvdZ33ksfjajadNRgq2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SdeH4Qee7WqqKnXh3BJn72","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js","offset":470,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":390,"cache_read_input_tokens":26923,"cache_creation":{"ephemeral_5m_input_tokens":390,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CXHKGFzLckDqBvb1ERpYz","type":"assistant","uuid":"0f28c0a1-13b4-4ff7-9e00-14ec64d25494","timestamp":"2026-01-19T19:48:47.304Z"}
{"parentUuid":"0f28c0a1-13b4-4ff7-9e00-14ec64d25494","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SdeH4Qee7WqqKnXh3BJn72","type":"tool_result","content":"   470→        empresa_id_eliminar = null;\n   471→        empresa_nombre_eliminar = '';\n   472→        $('#modal-confirmar-eliminacion').modal('hide');\n   473→    });\n   474→}\n   475→\n   476→$(document).ready(function () {\n   477→    if (opcion_form == \"Editar\") {\n   478→        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n   479→        $(\"#digito_verificacion\").val(numero)\n   480→    }\n   481→    \n   482→    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n   483→    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n   484→    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n   485→    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n   486→\n   487→    inicializarSelect2Asincrono('filtro_empresa_id', 'empresas-listado', 'razon_social', { id: 'id', nombre: 'razon_social' }, false, { solo_principales: true });\n   488→\n   489→    configurarFormulario('formulario-archivos');\n   490→    configurarFormulario('formulario-contactos');\n   491→\n   492→    if ($('#pais_id').val() != '') {\n   493→        $('#pais_id').trigger('change');\n   494→    }\n   495→    if ($('#empresa_id').val() != '') {\n   496→        $('#empresa_id').trigger('change');\n   497→    }\n   498→    if ($('#filtro_empresa_id').val() != '') {\n   499→        $('#filtro_empresa_id').trigger('change').trigger('select2:select');\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"581b0d2f-7384-41ef-9094-4233706a9c3a","timestamp":"2026-01-19T19:48:49.148Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js","content":"        empresa_id_eliminar = null;\n        empresa_nombre_eliminar = '';\n        $('#modal-confirmar-eliminacion').modal('hide');\n    });\n}\n\n$(document).ready(function () {\n    if (opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n        $(\"#digito_verificacion\").val(numero)\n    }\n    \n    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n\n    inicializarSelect2Asincrono('filtro_empresa_id', 'empresas-listado', 'razon_social', { id: 'id', nombre: 'razon_social' }, false, { solo_principales: true });\n\n    configurarFormulario('formulario-archivos');\n    configurarFormulario('formulario-contactos');\n\n    if ($('#pais_id').val() != '') {\n        $('#pais_id').trigger('change');\n    }\n    if ($('#empresa_id').val() != '') {\n        $('#empresa_id').trigger('change');\n    }\n    if ($('#filtro_empresa_id').val() != '') {\n        $('#filtro_empresa_id').trigger('change').trigger('select2:select');","numLines":30,"startLine":470,"totalLines":3180}},"sourceToolAssistantUUID":"0f28c0a1-13b4-4ff7-9e00-14ec64d25494"}
{"parentUuid":"581b0d2f-7384-41ef-9094-4233706a9c3a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Rd6dCwzJDXD3BA182bo298","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FEsFiuDN9S7rxWuLpFVDVx","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js","old_string":"$(document).ready(function () {\n    if (opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n        $(\"#digito_verificacion\").val(numero)\n    }","new_string":"$(document).ready(function () {\n    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\" && typeof empresa !== 'undefined' && empresa.documento) {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;\n        $(\"#digito_verificacion\").val(numero)\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":939,"cache_read_input_tokens":27313,"cache_creation":{"ephemeral_5m_input_tokens":939,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXHKGczPdAPuNMHVrodrq","type":"assistant","uuid":"7181ee75-e1e6-46a2-8665-df3a338ee583","timestamp":"2026-01-19T19:48:53.127Z"}
{"parentUuid":"7181ee75-e1e6-46a2-8665-df3a338ee583","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). The user provided the following reason for the rejection:  solo opcion_form","is_error":true,"tool_use_id":"toolu_01FEsFiuDN9S7rxWuLpFVDVx"}]},"uuid":"9545c200-0cd8-4b23-afa3-0fa63d0c4451","timestamp":"2026-01-19T19:49:22.386Z","toolUseResult":"Error: The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). The user provided the following reason for the rejection:  solo opcion_form","sourceToolAssistantUUID":"7181ee75-e1e6-46a2-8665-df3a338ee583"}
{"parentUuid":"9545c200-0cd8-4b23-afa3-0fa63d0c4451","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EguUxX7gVCDupp7kuU258S","type":"message","role":"assistant","content":[{"type":"text","text":"Entendido, solo validaré `opcion_form`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":366,"cache_read_input_tokens":28252,"cache_creation":{"ephemeral_5m_input_tokens":366,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXHKK5pV6g7z5tnAQkwFN","type":"assistant","uuid":"8f13a667-72e6-4f22-a38b-661b907532ae","timestamp":"2026-01-19T19:49:25.172Z"}
{"parentUuid":"8f13a667-72e6-4f22-a38b-661b907532ae","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EguUxX7gVCDupp7kuU258S","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AXG5Bt1Mp3dqDsj4v1K2cL","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js","old_string":"$(document).ready(function () {\n    if (opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n        $(\"#digito_verificacion\").val(numero)\n    }","new_string":"$(document).ready(function () {\n    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;\n        $(\"#digito_verificacion\").val(numero)\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":366,"cache_read_input_tokens":28252,"cache_creation":{"ephemeral_5m_input_tokens":366,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CXHKK5pV6g7z5tnAQkwFN","type":"assistant","uuid":"aba499bb-9cda-4138-8698-682fe1c8872f","timestamp":"2026-01-19T19:49:26.817Z"}
{"type":"file-history-snapshot","messageId":"aba499bb-9cda-4138-8698-682fe1c8872f","snapshot":{"messageId":"3f112933-6e10-4629-9262-da2be10bb09b","trackedFileBackups":{"public\\js\\empresas\\empresas.js":{"backupFileName":"14441ae59043bcc7@v1","version":1,"backupTime":"2026-01-19T19:49:49.372Z"}},"timestamp":"2026-01-19T19:48:10.724Z"},"isSnapshotUpdate":true}
{"parentUuid":"aba499bb-9cda-4138-8698-682fe1c8872f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AXG5Bt1Mp3dqDsj4v1K2cL","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   472→        $('#modal-confirmar-eliminacion').modal('hide');\n   473→    });\n   474→}\n   475→\n   476→$(document).ready(function () {\n   477→    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\") {\n   478→        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;\n   479→        $(\"#digito_verificacion\").val(numero)\n   480→    }\n   481→    \n   482→    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n   483→    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n   484→    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');"}]},"uuid":"a3ae6945-e2e2-4348-826e-99e8705e982c","timestamp":"2026-01-19T19:49:49.517Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js","oldString":"$(document).ready(function () {\n    if (opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n        $(\"#digito_verificacion\").val(numero)\n    }","newString":"$(document).ready(function () {\n    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;\n        $(\"#digito_verificacion\").val(numero)\n    }","originalFile":"let redirige_form = 'empresas-gestionar';\nlet empresa_id      = null;\nlet enlace_creacion = null;\nlet resource_url = 'empresas';\nlet logo_valido = true;\nlet validacion_logo_mensaje = '';\nif (resource_url == undefined) {\n    redirige_form = 'empresas';\n}\nlet usuarios_seleccionados = [];\nlet empresas_seleccionadas = [];\nlet url_datatable = {\n    url: resource_url + '-listado-tabla',\n};\nlet cantidad_empresas_listado = 0;\nlet empresas_listado = [];\nempresa_id_eliminar = null;\nempresa_nombre_eliminar = '';\n\nconst CAMPO_CELULAR_ID = 'celular';\nconst CAMPO_CELULAR_CONTACTO_ID = 'celular_contacto';\nconst CAMPO_CELULAR_TESORERO_ID = 'celular_tesorero';\nconst CAMPO_CELULAR_USUARIO_ID = 'celular_usuario';\n\nlet campo_celular = null;\nlet campo_celular_contacto = null;\nlet campo_celular_tesorero = null;\nlet campo_celular_usuario = null;\n\nlet columnas_datatable = [\n    { data: 'id' },\n    { data: 'sucursales_count' },\n    { data: 'id' },\n    { data: 'nombre_comercial' },\n    { data: 'razon_social' },\n    { data: 'documento' },\n    { data: 'ejecutivo.nombre_completo' },\n    { data: 'plan_seleccion' },\n    { data: 'plan_organizacional' },\n    { data: 'plan_vocacional' },\n    { data: null, name: 'acciones', orderable: false, searchable: false }\n];\n\nlet colunmasHTML = [\n    {\n        targets: [0],\n        render: function (data) {\n            return `<div class=\"check-container my-1 me-1\">\n                        <input type=\"checkbox\" class=\"form-check-input\" value=\"${data}\" name=\"empresas_seleccionadas[]\" />\n                    </div>`;\n        }\n    },\n    {\n        targets: 1,\n        render: function (data, type, row) {\n            // Agrega botón para mostrar sucursales\n            return `<span style=\"witdh:80px;\" class=\"pointer\" onclick=\"mostrarOcultarSucursales(this, ${row.id})\">${row.sucursales_count}</span>`;\n        }\n    },\n    {\n        targets: -1,\n        render: function(data, type, row) {\n            return `\n                <div class=\"text-center text-nowrap\">\n                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'ver')\">\n                        <i class=\"bi bi-eye\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary btn-circle\" onclick=\"consultarTabla('${resource_url}', ${row.id}, 'editar')\">\n                        <i class=\"bi bi-pencil\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalArchivar(${row.id})\">\n                        <i class=\"bi bi-archive\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirHistorialCambios(${row.id}, '${row.razon_social}')\">\n                        <i class=\"bi bi-clock\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirDetalleArchivado(${row.id}, '${row.razon_social}', '${row.comentario}')\" title=\"Detalle de archivado\">\n                        <i class=\"bi bi-list\"></i>\n                    </button>\n                    <button type=\"button\" class=\"btn btn-text-danger text-white btn-circle\" onclick=\"eliminarTabla('${resource_url}', ${row.id}, 'empresa')\">\n                        <i class=\"bi bi-trash\"></i>\n                    </button>\n                </div>\n            `;\n        }\n    },\n    {\n        targets: [6, 7, 8], // Columnas de planes de empresa por tipo de prueba\n        render: function (data) {\n            if (data === null) {\n                return null;\n            }\n\n            return `<span onclick=\"abrirDetallePlan(${data?.id})\" class=\"pointer\">${data?.estado?.nombre}</span>`;\n        }\n    }\n];\n\n/**\n * Función que abre el modal para filtrar las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalFiltrosAvanzadosEmpresas() {\n    $('#modal-filtros-avanzados-empresas').modal('show');\n}\n\n/**\n * Función busca los planes de un tipo de prueba para el filtrado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTipoPruebaFiltro(tipo_prueba_id) {\n    $('#filtro_plan_id').empty();\n    if (tipo_prueba_id == '') {\n        $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n        $('#filtro-plan').addClass('d-none');\n    } else {\n        $.ajax({\n            type : 'GET',\n            url : `/planes-listado`,\n            data : {\n                tipo_prueba_id: tipo_prueba_id\n            },\n            success: function(respuesta) {\n                let planes = respuesta.data;\n                $('#filtro_plan_id').append(`<option value=\"\">Todos</option>`);\n                for (let i = 0; i < planes.length; i++) {\n                    $('#filtro_plan_id').append(`\n                        <option value=\"${planes[i].id}\">${planes[i].nombre}</option>\n                    `);\n                }\n            },\n            error: function(error) {\n                console.log(error);\n            }\n        });\n        $('#filtro-plan').removeClass('d-none');\n    }\n}\n\n/**\n * Función recarga las empresas con el filtro aplicado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction aplicarFiltrosAvanzadosEmpresas() {\n    mostrarEmpresas();\n    $('#modal-filtros-avanzados-empresas').modal('hide');\n}\n\n/**\n * Función que limpia los filtros aplicados en las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction borrarFiltrosAvanzadosEmpresas() {\n    $('#modal-filtros-avanzados-empresas .select2-filtro').val('').trigger('change').trigger('select2:select');\n    aplicarFiltrosAvanzadosEmpresas();\n}\n\n/**\n * Función que muestra la lista de las empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarEmpresas() {\n    let estado = !archivadas;\n    let tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    let plan_id = $('#filtro_plan_id').val();\n    let ejecutivo_id = $('#filtro_ejecutivo_id').val();\n    let rango_fechas = $('#filtro_fecha_hora').val();\n    if (rango_fechas != '') {\n        rango_fechas = rango_fechas.split(\" a \");\n    }\n    let pais_id = $('#pais_id').val();\n    let departamento_id = $('#departamento_id').val();\n    let estado_plan_id = $('#filtro_estado').val();\n    let ciudad_id = $('#ciudad_id').val();\n    inicializarTooltips()\n    $.ajax({\n        type: 'GET',\n        url: `/empresas-listado-tabla`,\n        data: {\n            'solo_principales': true,\n            'estado_plan_id': estado_plan_id,\n            'activo': estado,\n            'tipo_prueba_id': tipo_prueba_id,\n            'plan_id': plan_id,\n            'ejecutivo_id': ejecutivo_id,\n            'rango_fechas': rango_fechas,\n            'pais_id': pais_id,\n            'departamento_id': departamento_id,\n            'ciudad_id': ciudad_id\n        },\n        success: function(empresas) {\n            cantidad_empresas_listado = 0;\n            empresas_listado = empresas;\n            if ($.fn.DataTable.isDataTable('#tabla-empresas')) {\n                tabla_empresas.destroy();\n            }\n            $('#buscador-empresas').remove();\n            $('#tbody-empresas').empty();\n            for (let i = 0; i < empresas.length; i++) {\n                cantidad_empresas_listado++;\n                crearItemTabla(empresas[i]);\n                let sucursales = empresas[i].sucursales;\n                for (let j = 0; j < sucursales.length; j++) {\n                    cantidad_empresas_listado++;\n                    crearItemTabla(sucursales[j], 'sucursal', empresas[i].plan_seleccion, empresas[i].plan_organizacional, empresas[i].plan_vocacional);\n                }\n            }\n            tabla_empresas = $('#tabla-empresas').DataTable({\n                language: lenguajeDatatables,\n                deferRender: true,\n                lengthMenu: [\n                    [ 10, 25, 50, 100, 200],\n                    [ 10, 25, 50, 100, 200]\n                ],\n                columnDefs: [\n                    { targets: [0, 1], orderable: false }\n                ],\n            });\n            mostrarComponenteNumeroRegistrosTabla('tabla-empresas');\n            $('colgroup').addClass('d-none');\n            mostrarOcultarColumnas();\n            tabla_empresas.on('page order length', function () {\n                setTimeout(function() {\n                    mostrarOcultarColumnas();\n                }, 30);\n            });\n            $(`#buscador-tabla-empresas`).empty();\n            $(`#buscador-tabla-empresas`).append(`\n                <div class=\"input-container input-icon mb-3\" id=\"contenedor-buscador-tabla-empresas\">\n                    <i class=\"bi bi-search\"></i>\n                    <i class=\"bi bi-filter pointer\" style=\"right: 10px!important; left: auto!important;\" onclick=\"abrirModalFiltrosAvanzadosEmpresas();\"></i>\n                </div>\n            `);\n            var buscador_datatables = $(`#tabla-empresas_wrapper .dt-search .dt-input`).first();\n            $(buscador_datatables).addClass('rounded-2 text-body-2 input-filtro');\n            $(buscador_datatables).prop('placeholder', 'Buscar');\n            $(`#contenedor-buscador-tabla-empresas`).append(buscador_datatables);\n            $(`#tabla-empresas_wrapper .dt-layout-cell.dt-end `).first().addClass('d-none');\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Función que muestra cada item de empresa o sucursal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction crearItemTabla(item, tipo = 'empresa', plan_seleccion = null, plan_organizacional = null, plan_vocacional = null) {\n    let campo_sucursal = '';\n    if (tipo == 'empresa' && item.sucursales.length > 0) {\n        campo_sucursal = `\n            <div class=\"width-60px rounded-1 badge-estado-plan badge-estado-inactivo nowrap pointer\" onclick=\"mostrarOcultarSucursales(this, ${item.id})\">\n                ${item.sucursales_count} <i class=\"bi bi-caret-down-fill\"></i>\n            </div>\n        `;\n    }\n    let planes = '';\n    let clase = '';\n    let bg = '';\n    if (tipo == 'sucursal') {\n        clase = `empresa-${item.empresa_id} d-none`;\n        bg = 'bg-gray-90';\n        planes = `\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_seleccion?.estado?.id ?? null,\n                    plan_seleccion?.estado?.nombre ?? null,\n                    plan_seleccion?.por_facturar ?? null,\n                    plan_seleccion?.renovando ?? null,\n                    plan_seleccion?.id ?? null,\n                    plan_seleccion?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_organizacional?.estado?.id ?? null,\n                    plan_organizacional?.estado?.nombre ?? null,\n                    plan_organizacional?.por_facturar ?? null,\n                    plan_organizacional?.renovando ?? null,\n                    plan_organizacional?.id ?? null,\n                    plan_organizacional?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    plan_vocacional?.estado?.id ?? null,\n                    plan_vocacional?.estado?.nombre ?? null,\n                    plan_vocacional?.por_facturar ?? null,\n                    plan_vocacional?.renovando ?? null,\n                    plan_vocacional?.id ?? null,\n                    plan_vocacional?.plan_proximo\n                )}\n            </td>\n        `;\n    } else {\n        planes = `\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_de_seleccion?.estado?.id ?? null,\n                    item?.plan_procesos_de_seleccion?.estado?.nombre ?? null,\n                    item?.plan_procesos_de_seleccion?.por_facturar ?? null,\n                    item?.plan_procesos_de_seleccion?.renovando ?? null,\n                    item?.plan_procesos_de_seleccion?.id ?? null,\n                    item?.plan_procesos_de_seleccion?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_organizacionales?.estado?.id ?? null,\n                    item?.plan_procesos_organizacionales?.estado?.nombre ?? null,\n                    item?.plan_procesos_organizacionales?.por_facturar ?? null,\n                    item?.plan_procesos_organizacionales?.renovando ?? null,\n                    item?.plan_procesos_organizacionales?.id ?? null,\n                    item?.plan_procesos_organizacionales?.plan_proximo\n                )}\n            </td>\n            <td class=\"${bg}\">\n                ${obtenerEstadoPlan(\n                    item?.plan_procesos_vocacionales?.estado?.id ?? null,\n                    item?.plan_procesos_vocacionales?.estado?.nombre ?? null,\n                    item?.plan_procesos_vocacionales?.por_facturar ?? null,\n                    item?.plan_procesos_vocacionales?.renovando ?? null,\n                    item?.plan_procesos_vocacionales?.id ?? null,\n                    item?.plan_procesos_vocacionales?.plan_proximo\n                )}\n            </td>\n        `;\n    }\n    let checked = '';\n    if (empresas_seleccionadas.includes(item.id)) {\n        checked = 'checked';\n    }\n\n    $('#tbody-empresas').append(`\n        <tr class=\"${clase} ${bg}\">\n            <td class=\"${bg}\">\n                <div class=\"check-container my-1 me-1\">\n                    <input type=\"checkbox\" class=\"form-check-input\" value=\"${item.id}\" onchange=\"seleccionarCheckboxEmpresa(this.checked, this.value);\" ${checked}/>\n                </div>\n            </td>\n            <td class=\"${bg}\">${campo_sucursal ?? ''}</td>\n            <td class=\"${bg}\">${item?.id ?? ''}</td>\n            <td class=\"${bg}\">${item?.nombre_comercial ?? ''}</td>\n            <td class=\"${bg}\">${item?.razon_social ?? ''}</td>\n            <td class=\"${bg}\">${item?.documento ?? ''}</td>\n            <td class=\"${bg}\">${item?.ejecutivo?.nombre_completo ?? ''}</td>\n            ${planes}\n            <td class=\"${bg} d-none columna-ubicacion\">${item?.ciudad?.nombre ?? ''} ${item?.ciudad?.departamento?.pais?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-numero-celular\">${item?.celular ?? ''}</td>\n            <td class=\"${bg} d-none columna-correo-facturacion\">${item?.email_facturacion ?? ''}</td>\n            <td class=\"${bg} d-none columna-fecha-creacion\">${item?.created_at ?? ''}</td>\n            <td class=\"${bg} d-none columna-progreso-creacion\">${item?.porcentaje_creacion ?? ''}</td>\n            <td class=\"${bg} d-none columna-tamano-empresa\">${item?.tamano_empresa?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-sector\">${item?.sector?.nombre ?? ''}</td>\n            <td class=\"${bg} d-none columna-direccion\">${item?.direccion ?? ''}</td>\n            <td class=\"${bg} d-none columna-representante\">${item?.nombre_representante ?? ''}</td>\n            <td class=\"${bg} text-center\">\n                <div class=\"col-auto px-0 dropdown\">\n                    <i class=\"bi bi-three-dots dropdown-toggle text-blue-40 pointer\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                    <div class=\"dropdown-menu\">\n                        <a href=\"/empresas-gestionar/${item.id}\" class=\"dropdown-item no-visited pointer py-2\">Gestionar empresa</a>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirHistorialCambios(${item?.id}, '${item?.razon_social}', '${item?.creado_administrador}')\">Historial de cambios</div>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"abrirModalArchivar(${item?.id})\">Archivar</div>\n                        <div class=\"dropdown-item no-visited pointer py-2\" onclick=\"cambiarEmpresa(${item?.id});\">Cambiar a esta empresa</div>\n                        <div class=\"dropdown-item no-visited pointer py-2 text-danger\" onclick=\"abrirModalConfirmarEliminarEmpresas('${item?.id}', '${item?.razon_social}')\">Eliminar</div>\n                    </div>\n                </div>\n            </td>\n        </tr>\n    `);\n}\n\n/**\n * Función que muestra u oculta las sucursales de una empresa.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarOcultarSucursales(elemento, empresa_id_padre) {\n    if ($(elemento).find('.bi-caret-down-fill').first().length > 0) {\n        $('.empresa-' + empresa_id_padre).removeClass('d-none');\n        $(elemento).find('.bi-caret-down-fill').first().removeClass('bi-caret-down-fill').addClass('bi-caret-up-fill');\n    } else {\n        $('.empresa-' + empresa_id_padre).addClass('d-none');\n        $(elemento).find('.bi-caret-up-fill').first().removeClass('bi-caret-up-fill').addClass('bi-caret-down-fill');\n    }\n}\n\n/**\n * Función que evalua que columnasn adicionales hay que mostrar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction mostrarOcultarColumnas() {\n    let columnas = $('.filtro-columna');\n    for (let i = 0; i < columnas.length; i++) {\n        let valor = $(columnas[i]).val();\n        let checked = $(columnas[i]).prop('checked');\n        if (checked) {\n            $('.' + valor).removeClass('d-none');\n        } else {\n            $('.' + valor).addClass('d-none');\n        }\n    }\n}\n\n/**\n * Función que abre el modal para confirmar la eliminación de empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction abrirModalConfirmarEliminarEmpresas(empresa_id = null, nombre_empresa = '') {\n    empresa_id_eliminar = empresa_id;\n    nombre_empresa = 'Eliminar ' + nombre_empresa;\n    $('#nombre-confirmar-eliminacion').text(nombre_empresa);\n    $('#modal-confirmar-eliminacion').modal('show');\n}\n\n/**\n * Confirmar la eliminación de empresas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction confirmarEliminarEmpresas() {\n    eliminarEmpresas(empresa_id_eliminar);\n}\n\n/**\n * Eliminar empresas.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function eliminarEmpresas(empresa_id = null) {\n    await $.ajax({\n        type: 'DELETE',\n        url : `/empresas/${empresa_id}`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n        }\n    }).then((respuesta) => {\n        empresa_id_eliminar = null;\n        empresa_nombre_eliminar = '';\n        if (respuesta.tipo != undefined && respuesta.tipo == 'success') {\n            mostrarToast('success', respuesta.mensaje);\n            mostrarEmpresas();\n        } else if (respuesta.errors != undefined) {\n            mostrarToast('danger', respuesta.message);\n        }\n        $('#modal-confirmar-eliminacion').modal('hide');\n    }).catch((error) => {\n        mostrarToast('danger', error.responseJSON.errors);\n        empresa_id_eliminar = null;\n        empresa_nombre_eliminar = '';\n        $('#modal-confirmar-eliminacion').modal('hide');\n    });\n}\n\n$(document).ready(function () {\n    if (opcion_form == \"Editar\") {\n        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        \n        $(\"#digito_verificacion\").val(numero)\n    }\n    \n    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n\n    inicializarSelect2Asincrono('filtro_empresa_id', 'empresas-listado', 'razon_social', { id: 'id', nombre: 'razon_social' }, false, { solo_principales: true });\n\n    configurarFormulario('formulario-archivos');\n    configurarFormulario('formulario-contactos');\n\n    if ($('#pais_id').val() != '') {\n        $('#pais_id').trigger('change');\n    }\n    if ($('#empresa_id').val() != '') {\n        $('#empresa_id').trigger('change');\n    }\n    if ($('#filtro_empresa_id').val() != '') {\n        $('#filtro_empresa_id').trigger('change').trigger('select2:select');\n    }\n    let empresa_id = $('#formulario #id').val();\n    if (![undefined, null, ''].includes(empresa_id)) {\n        $.ajax({\n            type: 'GET',\n            url : `/empresas-logo/${empresa_id}`,\n            success: function() {\n                $('#logo_fondo_previsualizacion').addClass('d-none');\n                $('#logo_previsualizacion').attr('src', `/empresas-logo/${empresa_id}`);\n                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n            }\n        });\n    }\n    $(\"#modal-filtros-avanzados\").on(\"hidden.bs.modal\", function () {\n        $('#modal-historial-cambios-usuario').modal('show');\n    });\n    inicializarTooltips();\n});\n\nfunction postSuccess(respuesta) {\n    if (respuesta.formulario == 'formulario') {\n        if (respuesta.data.empresa_id == null) {\n            if (vista == 'crear-editar') {\n                mostrarToast('success', `La empresa se ${respuesta.accion_realizada} con éxito`);\n                $('#empresa-tab').html(`<i class=\"bi bi-check\"></i>`);\n                $('#documentos-tab').prop('disabled', false);\n                $('#documentos-tab').click();\n            } else if (vista == 'gestionar') {\n                mostrarToast('success', `La empresa se ${respuesta.accion_realizada} con éxito`);\n            }\n        } else {\n            if (vista == 'crear-editar') {\n                if (opcion_form === 'Editar') {\n                    localStorage.setItem('notificacionToast', JSON.stringify({\n                        tipo_alerta: 'success',\n                        texto_1: `La sucursal se ${respuesta.accion_realizada} con éxito`,\n                    }));\n                } else {\n                    localStorage.setItem('notificacionToast', JSON.stringify({\n                        sucursal_creada: true,\n                        id_sucursal: respuesta.data.id,\n                        nombre_comercial_sucursal: respuesta.data.nombre_comercial\n                    }));\n                }\n                if (tipo_rol_activo_usuario === 'empresa') {\n                    window.location.href = '/sucursales';\n                } else if (tipo_rol_activo_usuario === 'superadmin') {\n                    window.location.href = '/empresas';\n                }\n            } else if (vista == 'gestionar') {\n                mostrarToast('success', `La sucursal se ${respuesta.accion_realizada} con éxito`);\n            }\n        }\n    } else if (respuesta.formulario == 'formulario-archivos') {\n        if (Array.isArray(respuesta.data) && respuesta.data.length > 0) actualizarEnlacesPrevisualizacionArchivos(respuesta.data, false);\n        mostrarToast('success', `Los documentos se ${respuesta.accion_realizada} con éxito`);\n        $('#documentos-tab').html(`<i class=\"bi bi-check\"></i>`);\n        $('#contactos-tab').prop('disabled', false);\n        $('#contactos-tab').click();\n    } else if (respuesta.formulario == 'formulario-contactos') {\n        mostrarToast('success', `La información de contacto se ${respuesta.accion_realizada} con éxito`);\n        $('#contactos-tab').html(`<i class=\"bi bi-check\"></i>`);\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `La empresa se ${respuesta.accion_realizada} con éxito`,\n        }));\n        window.location.href='/empresas';\n    }\n    if (typeof respuesta.data !== 'undefined' && typeof es_sucursal !== 'undefined'){\n        if (es_sucursal == false) {\n            if (typeof respuesta.data.id !== 'undefined') {\n                $('.id').val(respuesta.data.id);\n            }\n        }\n    }\n}\n\n/**\n * Validar datos antes de enviar el formulario.\n *\n * @returns {boolean}\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction validacionAdicional() {    \n    if (campo_celular !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular, CAMPO_CELULAR_ID);\n    }\n    if (campo_celular_contacto !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_contacto, CAMPO_CELULAR_CONTACTO_ID);\n    }\n    if (campo_celular_tesorero !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_tesorero, CAMPO_CELULAR_TESORERO_ID);\n    }\n    if (campo_celular_usuario !== null) {\n        validacionAdicionalInputTipoCelular(campo_celular_usuario, CAMPO_CELULAR_USUARIO_ID);\n    }\n\n    if ($('#usuario').length) {\n        $('#usuario').val('');\n        let usuario_id = $('#usuario_id').val();\n        if (usuario_id.length == 0) {\n            usuario_id = null;\n        }\n        let usuario = {\n            id                       : usuario_id,\n            tipo_documento_id        : $('#tipo_documento_id').val(),\n            documento                : $('#documento_usuario').val(),\n            nombres                  : $('#nombres').val(),\n            apellidos                : $('#apellidos').val(),\n            email                    : $('#email').val(),\n            codigo_iso2_pais_telefono: $(`#codigo_iso2_pais_${CAMPO_CELULAR_USUARIO_ID}`).val(),\n            indicativo_telefono      : $(`#indicativo_${CAMPO_CELULAR_USUARIO_ID}`).val(),\n            telefono                 : $(`#${CAMPO_CELULAR_USUARIO_ID}`).val()\n        };\n\n        $('#usuario').val(JSON.stringify(usuario));\n    }\n\n    if (!logo_valido) {\n        mostrarToast('danger', validacion_logo_mensaje);\n        return false;\n    }\n\n    return true;\n}\n\nfunction seleccionarEmpresa(empresa_id) {\n    $('.campo-sucursal').addClass('d-none');\n\n    if (empresas_principales.length) {\n        let ejecutivo = empresas_principales.filter(empresa_principal => empresa_principal.id === parseInt(empresa_id))[0].ejecutivo;\n        $('#ejecutivo-cuenta').text('Ejecutivo de cuenta: ' + ejecutivo?.nombre_completo);\n        let campo_ejecutivo_id = $('input[type=\"hidden\"]#ejecutivo_id');\n        if (campo_ejecutivo_id) {\n            campo_ejecutivo_id.val(ejecutivo?.id);\n        }\n    }\n\n    $('#empresa_id').val('');\n    if (empresa_id.length > 0) {\n        $('#empresa_id').val(empresa_id);\n        $('.campo-sucursal').removeClass('d-none');\n    }\n}\n\nfunction cambiarLogoSucursal() {\n    $('#cambiar-logo').addClass('d-none');\n    $('.campo-imagen-sucursal').removeClass('d-none');\n}\n\nfunction validarLineasTabs() {\n    let pasos = $('.nav-pasos:not(:disabled)').length;\n    for (let i = 0; i < (pasos - 1); i++) {\n        $($('.hr-tab')[i]).addClass('border-blue-40 opacity-100');\n    }\n}\n\n/**\n * Obtener los departamentos según el país seleccionado.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\n$(document).on('change', '#pais_id', function() {\n    const pais_id = $(this).val();\n    $('#departamento_id').empty();\n    $('#ciudad_id').empty();\n    if (pais_id != null && pais_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/departamentos-listado`,\n            data: {\n                pais_id: pais_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n            $('#departamento_id').append(`<option></option>`);\n            datos.forEach((item) => {\n                $('#departamento_id').append(new Option(item.nombre, item.id));\n            });\n            if ($(this).data('departamento_id') != '') {\n                $('#departamento_id').val($(this).data('departamento_id')).trigger('change');\n            }\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n});\n\n/**\n * Obtener las ciudades según el departamento seleccionado.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\n$(document).on('change', '#departamento_id', function() {\n    const departamento_id = $(this).val();\n    $('#ciudad_id').empty();\n    if (departamento_id != null && departamento_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/ciudades-listado`,\n            data: {\n                departamento_id: departamento_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n            $('#ciudad_id').append(`<option></option>`);\n            datos.forEach((item) => {\n                $('#ciudad_id').append(new Option(item.nombre, item.id));\n            });\n            if ($(this).data('ciudad_id') != '') {\n                $('#ciudad_id').val($(this).data('ciudad_id')).trigger('change');\n            }\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n});\n\n/**\n * Obtener las sucursales de la empresa seleccionada.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction buscarSucursalesEmpresa(empresa_id, sucursal_id = null) {\n    $('#filtro_sucursal_id').empty();\n    $('#filtro_sucursal_id').append(`<option value=\"\"></option>`);\n    if (empresa_id != '') {\n        $.ajax({\n            type: 'GET',\n            url : `/empresas-listado`,\n            data: {\n                empresa_id: empresa_id\n            }\n        }).then((response) => {\n            const datos = response.data;\n\n            datos.forEach((item) => {\n                let selected = '';\n                if (sucursal_id == item.id) {\n                    selected = 'selected';\n                }\n                $('#filtro_sucursal_id').append(`\n                    <option value=\"${item.id}\" ${selected}>${item.nombre_comercial}</option>\n                `);\n            });\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n}\n\n/**\n * Obtener los planes de la empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {Object} parametros Parámetros para filtrar los planes.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function getPlanesEmpresa(empresa_id, parametros = {}) {\n    $.ajax({\n        type: 'GET',\n        url : `/empresas-planes-listado/${empresa_id}`,\n        data: parametros\n    }).then((response) => {\n        const datos = response.data;\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n/**\n * Abrir el modal para archivar o desarchivar empresa.\n *\n * @param {number} id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction abrirModalArchivar(id) {\n    $('#modal-archivar').modal('show');\n    $('#empresa-archivar-id').val(null);\n    $('#empresa-archivar-id').val(id);\n}\n\n/**\n * Archivar o desarchivar empresa.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction archivar() {\n    const formulario = $('#formulario-archivar');\n\n    formulario.validate({\n        ignore: [] // No ignorar campos ocultos\n    });\n\n    const datos = new FormData(formulario[0]);\n    datos.append('_token', $('meta[name=\"csrf-token\"]').attr('content'));\n    datos.append('activo', archivadas);\n    datos.delete('id');\n\n    const id = $('#empresa-archivar-id').val();\n\n    if (formulario.valid()) {\n        $.ajax({\n            type       : 'POST',\n            url        : `/empresas-archivar/${id}`,\n            data       : datos,\n            processData: false,\n            contentType: false\n        }).then((respuesta) => {\n            mostrarToast('success', respuesta.mensaje);\n            $('#modal-archivar').modal('hide');\n            formulario[0].reset();\n            mostrarEmpresas();\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n};\n\n/**\n * Abrir el historial de cambios.\n *\n * @param {number} id ID de la empresa.\n * @param {string} razon_social Razón social de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirHistorialCambios(id, razon_social, creado_administrador = 0) {\n    \n    $(document).on('shown.bs.tab', 'a.nav-item-horizontal', function () {\n        let id_tab = $(this).attr('id');\n        $('#descargar-historial').removeClass('d-none');\n        if (id_tab == 'archivos') {\n            $('#descargar-historial').addClass('d-none');\n        }\n    });\n\n    $('#modal-historial-cambios').modal('show');\n    $('#descargar-historial').attr('onclick', `descargarExcel('empresas-historial-cambios-exportar/${id}', 'historial-cambios')`);\n    $('#historial-razon-social').text(razon_social);\n    if (creado_administrador == 1) {\n        $('#forma-creacion').text('Manualmente');\n    } else {\n        $('#forma-creacion').text('Automático');\n    }  \n    const TITULOS_CAMPOS = {\n        id                             : 'ID',\n        empresa_id                     : 'Empresa principal',\n        ciudad_id                      : 'Ciudad',\n        ejecutivo_id                   : 'Ejecutivo',\n        sector_id                      : 'Sector',\n        tamano_empresa_id              : 'Tamaño',\n        razon_social                   : 'Razón social',\n        nombre_comercial               : 'Nombre comercial',\n        documento                      : 'NIT',\n        direccion                      : 'Dirección',\n        celular                        : 'Celular',\n        telefono                       : 'Teléfono',\n        email_facturacion              : 'Correo para facturación electrónica',\n        es_persona_juridica            : 'Persona jurídica',\n        procesos_estimados_mensuales   : 'Procesos estimados mensuales',\n        pruebas_estimadas_mensuales    : 'Pruebas estimadas mensuales',\n        tipo_documento_representante_id: 'Tipo de documento del representante',\n        documento_representante        : 'Documento del representante',\n        nombre_representante           : 'Nombre del representante',\n        email_representante            : 'Correo del representante',\n        nombre_tesorero                : 'Nombre del tesorero',\n        celular_tesorero               : 'Celular del tesorero',\n        telefono_tesorero              : 'Teléfono del tesorero',\n        email_tesorero                 : 'Correo del tesorero',\n        nombre_contacto                : 'Nombre del contacto',\n        celular_contacto               : 'Celular del contacto',\n        email_contacto                 : 'Correo del contacto',\n        comentario                     : 'Comentario',\n        activo                         : 'Archivada'\n    };\n    const CAMPOS_ARCHIVOS = {\n        logo                : 'Logo',\n        rut                 : 'RUT',\n        camara_comercio     : 'Cámara de comercio',\n        cedula_representante: 'Cédula del representante'\n    };\n    destruirTablaExistente('tabla-historial-cambios');\n    destruirTablaExistente('tabla-archivos');\n    \n    $(`#tabla-historial-cambios`).DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 200px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/empresas-historial-cambios/${id}`\n        },\n        columns: [\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Datos anteriores</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '350px',\n                render: (dato) => {\n                    var datos_anteriores = '';\n                    for (const LLAVE in dato.old_values) {                        \n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && dato.old_values[LLAVE] !== null && LLAVE !== 'activo') {\n                            if (LLAVE === 'es_persona_juridica') {\n                                dato.old_values[LLAVE] = dato.old_values[LLAVE] ? 'Sí' : 'No';\n                            }\n\n                            datos_anteriores += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${dato.old_values[LLAVE]}</span>`;\n                        }\n                    }\n                    return `\n                        <div>\n                            ${datos_anteriores}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Datos nuevos</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '350px',\n                render: (dato) => {\n                    var datos_nuevos = '';\n                    for (const LLAVE in dato.new_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && dato.new_values[LLAVE] !== null && LLAVE !== 'activo') {\n                            if (LLAVE === 'es_persona_juridica') {\n                                dato.new_values[LLAVE] = dato.new_values[LLAVE] ? 'Sí' : 'No';\n                            }\n                            datos_nuevos += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${dato.new_values[LLAVE]}</span>`;\n                        }\n                    }\n                    return `\n                        <div>\n                            ${datos_nuevos}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Responsable</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '150px',\n                render: (dato) => {\n                    var responsable = `<span class=\"d-block text-body-3\">${dato.user.nombre_completo}</span>`;\n                    return responsable;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Fecha</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '130px',\n                render: (dato) => {\n                    const FECHA = obtenerFechaHora(dato.created_at);\n                    return `\n                        <span class=\"d-block text-body-3\">${FECHA.fecha}</span>\n                        <small class=\"text-label-2\">${FECHA.hora}</small>\n                    `;\n                }\n            }\n        ],\n        initComplete: function(settings) {\n            cargarDataTablas();\n        },\n    });\n\n    $(`#tabla-archivos`).DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: false,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 200px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/archivos`,\n            data: function (datos) {\n                datos.modelo = 'App\\\\Models\\\\Empresas\\\\Empresa';\n                datos.modelo_id = id;\n            },\n        },\n        columns: [\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Archivo</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: (dato) => {\n                    const DATO  = `<a href=\"/archivos-abrir/${dato.id}\" target=\"_blank\" class=\"text-body-3 text-blue-40\">${CAMPOS_ARCHIVOS[dato.nombre]}</a>`;\n                    return `\n                        <div>\n                            ${DATO}\n                        </div>\n                    `;\n                }\n            },\n            {\n                data: null,\n                title: '<span class=\"text-body-3\">Fecha</span>',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                width: '130px',\n                render: (dato) => {\n                    const FECHA = obtenerFechaHora(dato.created_at);\n                    return `\n                        <span class=\"d-block text-body-3\">${FECHA.fecha}</span>\n                        <small class=\"text-label-2\">${FECHA.hora}</small>\n                    `;\n                }\n            }\n        ],\n        initComplete: function(settings) {\n            cargarDataTablas();\n        },\n    });\n}\n\n/**\n * Función para formatear la hora\n *\n * @param {number} timestamp fecha a transformar.\n * @returns {Promise<Array>}\n * @author Jair Carvajal\n */\nfunction obtenerFechaHora(timestamp) {\n  // Crear objeto Date a partir del timestamp ISO\n  let fecha = new Date(timestamp);\n  // Extraer fecha en formato YYYY-MM-DD\n  let fechaStr = fecha.toISOString().split(\"T\")[0];\n  // Extraer hora en formato HH:MM:SS\n  let horaStr = fecha.toISOString().split(\"T\")[1].split(\".\")[0];\n\n  return {\n    fecha: fechaStr,\n    hora: horaStr\n  };\n}\n\n/**\n * Obtener historial de cambios.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getHistorialCambios(id) {\n    let datos = [];\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-historial-cambios/${id}`\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Obtener archivos.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getArchivos(id) {\n    let datos = [];\n\n    await $.ajax({\n        type: 'GET',\n        url : `/archivos`,\n        data: {\n            modelo   : 'App\\\\Models\\\\Empresas\\\\Empresa',\n            modelo_id: id\n        }\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n\n    return datos;\n}\n\n/**\n * Generar enlace de creación o actualización.\n *\n * @param {number} id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function generarEnlaceCreacion(id = null) {\n    enlace_creacion = null;\n    const URL       = ![undefined, null, ''].includes(id) ? `/generar-enlace-creacion/${id}` : `/generar-enlace-creacion`;\n\n    await $.ajax({\n        type: 'POST',\n        url : URL,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content')\n        }\n    }).then((respuesta) => {\n        enlace_creacion = respuesta.data;\n        $('#enlace-creacion').text(enlace_creacion);\n        $('#modal-generar-enlace').modal('show');\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n/**\n * Copiar enlace de creación.\n *\n * @param {boolean} cerrar_modal Indica si se debe cerrar el modal.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction copiarEnlace(cerrar_modal = false) {\n    navigator.clipboard.writeText(enlace_creacion);\n\n    if (cerrar_modal) {\n        $('#modal-generar-enlace').modal('hide');\n    }\n}\n\n/**\n * Abrir detalle de archivado de la empresa.\n *\n * @param {number} id ID de la empresa.\n * @param {string} razon_social Razón social.\n * @param {string} comentario Comentario de archivado.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirDetalleArchivado(id, razon_social, comentario) {\n    $('#razon-social-archivado').text('');\n    $('#responsable-archivado').text('');\n    $('#fecha-archivado').text('');\n    $('#comentario-archivado').text('');\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-detalle-archivado/${id}`,\n        success: function(respuesta) {\n            const DETALLE = respuesta.data;\n            if (DETALLE != null) {\n                $('#razon-social-archivado').text(razon_social);\n                $('#responsable-archivado').text(DETALLE.user.nombre_completo);\n                $('#fecha-archivado').text(formatearFecha(DETALLE.created_at).fecha);\n                $('#comentario-archivado').text(comentario);\n            }\n            $('#modal-detalle-archivado').modal('show');\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Abrir detalle del plan de empresa.\n *\n * @param {number} id ID del plan de empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function abrirDetallePlan(id) {\n    $('.tipo-prueba-plan').text('');\n    $('.nombre-plan').text('');\n    $('.unidades-plan').text('');\n    $('.tiempo-plan').text('');\n    $('.usuarios-plan').text('');\n    $('.ofertas-laborales-plan').text('');\n    await $.ajax({\n        type: 'GET',\n        url : `/empresas-planes/${id}`\n    }).then((respuesta) => {\n        let plan = respuesta.data;\n        $('#tipo-prueba-plan').text(plan.plan.tipo_prueba.nombre);\n        $('#nombre-plan').text(plan.plan.nombre);\n        $('#unidades-plan').text(plan.unidades);\n        $('#tiempo-plan').text(plan.vigencia_dias + ' Días');\n        $('#usuarios-plan').text(plan.plan.cantidad_usuarios);\n        $('#ofertas-laborales-plan').text(plan.cantidad_ofertas_laborales);\n        $('#nav-actual-tab').click();\n        if (plan.plan_proximo ) {\n            $('#nombre-plan-proximo').text(plan.plan_proximo.plan.nombre);\n            $('#unidades-plan-proximo').text(plan.plan_proximo.unidades);\n            $('#tiempo-plan-proximo').text(plan.plan_proximo.vigencia_dias + ' Días');\n            $('#usuarios-plan-proximo').text(plan.plan_proximo.cantidad_usuarios);\n            $('#ofertas-laborales-plan-proximo').text(plan.plan_proximo.cantidad_ofertas_laborales);\n            $('#contenedor-alert-proximo').removeClass('d-none');\n            $('#nav-tab-plan').removeClass('d-none');\n        } else {\n            $('#contenedor-alert-proximo').addClass('d-none');\n            $('#nav-tab-plan').addClass('d-none');\n        }\n        $('#modal-detalle-plan').modal('show');\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n//APARTADO PARA GESTIONAR EMPRESAS\nlet usuarios = [];\nlet empresa_seleccionada = null;\nlet configuraciones_defecto = [];\nlet configuraciones_personalizadas = [];\n\n/**\n * Obtener los datos del formulario de gestionar empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nfunction obtenerDatosGestionarEmpresa(empresa_id) {\n\n    if (campo_celular_contacto === null) campo_celular_contacto = definirInputTipoCelular(CAMPO_CELULAR_CONTACTO_ID, CAMPO_CELULAR_CONTACTO_ID, 'Celular*');\n    if (campo_celular === null) campo_celular = definirInputTipoCelular(CAMPO_CELULAR_ID, CAMPO_CELULAR_ID, 'Celular*');\n    if (campo_celular_tesorero === null) campo_celular_tesorero = definirInputTipoCelular(CAMPO_CELULAR_TESORERO_ID, CAMPO_CELULAR_TESORERO_ID, 'Celular*');\n    if (campo_celular_usuario === null) campo_celular_usuario = definirInputTipoCelular(CAMPO_CELULAR_USUARIO_ID, CAMPO_CELULAR_USUARIO_ID, 'Celular*', false);\n\n    usuarios = [];\n    usuarios_seleccionados = [];\n    empresa_seleccionada = null;\n    configuraciones_defecto = [];\n    configuraciones_personalizadas = [];\n\n    $('.id').val('');\n    $('.empresa_id').val('');\n    $('#usuario').val('');\n    $('.col-lg-6-empresa').addClass('col-lg-6');\n    $('#tabs-empresa').addClass('d-none');\n    if (empresa_id != '' && empresa_id != null) {\n        $.ajax({\n            type : 'GET',\n            url : `/empresas-gestionar-datos/${empresa_id}`,\n            processData: false,\n            contentType: false,\n            success: function(respuesta) {\n                let empresa = respuesta.data;\n                if (empresa.empresa_id != null) {\n                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n                    $('#filtro_empresa_id').append(`\n                        <option value=\"${empresa.empresa.id}\">${empresa.empresa.razon_social}</option>\n                    `);\n                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n                        $('#filtro_empresa_id').val(empresa.empresa.id).trigger('change', {programmatic: true});\n                    }\n                    buscarSucursalesEmpresa(empresa.empresa.id, empresa.id);\n                    $('.id').val(empresa.id);\n                    $('.empresa_id').val(empresa.empresa.id);\n                    $('.empresa').addClass('d-none');\n                    $('.sucursal').removeClass('d-none');\n                    $('.col-lg-6-empresa').removeClass('col-lg-6');\n                    $('#ejecutivo-cuenta').text('Ejecutivo de cuenta: ' + empresa.ejecutivo.nombre_completo);\n                    $('#seccion-logo').addClass('d-none');\n                } else {\n                    $('#boton-crear-usuarios').prop('href', `/usuarios/create?empresa_id=${empresa.id}`);\n                    $('#boton-asignar-planes').prop('href', `/asignar-plan/${empresa.id}`);\n                    $('#filtro_empresa_id').append(`\n                        <option value=\"${empresa.id}\">${empresa.razon_social}</option>\n                    `);\n                    if ($('#filtro_empresa_id').val() == '' || $('#filtro_empresa_id').val() == null) {\n                        $('#filtro_empresa_id').val(empresa.id).trigger('change', {programmatic: true});\n                    }\n                    buscarSucursalesEmpresa(empresa_id);\n                    $('.id').val(empresa.id);\n                    $('.empresa').removeClass('d-none');\n                    $('.sucursal').addClass('d-none');\n                    $('#ejecutivo-cuenta').text('');\n                    $('#seccion-logo').removeClass('d-none');\n                }\n                if (empresa.es_persona_juridica == 1) {\n                    $(\"#es_persona_juridica_si\").prop('checked', true);\n                } else {\n                    $(\"#es_persona_juridica_no\").prop('checked', true);\n                }\n                $('#razon_social').val(empresa.razon_social);\n                $('#nombre_comercial').val(empresa.nombre_comercial);\n                let documento = empresa.documento.split('-');\n                $('#documento').val(documento[0]);\n                $('#digito_verificacion').val(documento[1]);\n                $('#sector_id').val(empresa.sector_id).trigger('change').trigger('select2:select');\n                $('#tamano_empresa_id').val(empresa.tamano_empresa_id).trigger('change').trigger('select2:select');\n                $('#procesos_estimados_mensuales').val(empresa.procesos_estimados_mensuales);\n                $('#pruebas_estimadas_mensuales').val(empresa.pruebas_estimadas_mensuales);\n                $('#pais_id').data('departamento_id', empresa.ciudad.departamento_id);\n                $('#pais_id').val(empresa.ciudad.departamento.pais_id).trigger('change').trigger('select2:select');\n                $('#departamento_id').data('ciudad_id', empresa.ciudad.id);\n                $('#departamento_id').val(empresa.departamento_id).trigger('change').trigger('select2:select');\n                $('#ciudad_id').val(empresa.ciudad_id).trigger('change').trigger('select2:select');\n                $('#direccion').val(empresa.direccion);\n                $('#celular').val(empresa.celular);\n\n                rellenarInputCelular(empresa.indicativo_celular, empresa.codigo_iso2_pais_celular, empresa.celular, CAMPO_CELULAR_ID, campo_celular);\n\n                $('#email_facturacion').val(empresa.email_facturacion);\n                $('#telefono').val(empresa.telefono);\n\n                actualizarEnlacesPrevisualizacionArchivos(empresa.archivos);\n\n                if (empresa.telefono_tesorero != null) {\n                    let telefono = empresa.telefono_tesorero.split('-');\n                    $('#telefono').val(telefono[0]);\n                    $('#extension').val(telefono[1]);\n                }\n\n                $('#ejecutivo_id').val(empresa.ejecutivo_id).trigger('change').trigger('select2:select');\n                $('#nombre_representante').val(empresa.nombre_representante);\n                $('#tipo_documento_representante_id').val(empresa.tipo_documento_representante_id).trigger('change').trigger('select2:select');\n                $('#documento_representante').val(empresa.documento_representante);\n                $('#email_representante').val(empresa.email_representante);\n                if (![undefined, null, ''].includes(empresa.id)) {\n                    if (empresa.empresa_id != null) {\n                        $.ajax({\n                            type: 'GET',\n                            url : `/empresas-logo/${empresa.id}`,\n                            success: function() {\n                                $('#logo_sucursal_fondo_previsualizacion').addClass('d-none');\n                                $('#logo_sucursal_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n                            }\n                        });\n                    } else {\n                        $.ajax({\n                            type: 'GET',\n                            url : `/empresas-logo/${empresa.id}`,\n                            success: function() {\n                                $('#logo_fondo_previsualizacion').addClass('d-none');\n                                $('#logo_previsualizacion').attr('src', `/empresas-logo/${empresa.id}`);\n                                $($('.hr-tab')[0]).addClass('border-blue-40 opacity-100');\n                            }\n                        });\n                    }\n                }\n\n                if (empresa.usuarios.length > 0) {\n                    const USUARIO_EMPRESA = empresa.usuarios[0].usuario;\n\n                    $('#usuario_id').val(USUARIO_EMPRESA.id);\n                    $('#nombres').val(USUARIO_EMPRESA.nombres);\n                    $('#apellidos').val(USUARIO_EMPRESA.apellidos);\n                    $('#tipo_documento_id').val(USUARIO_EMPRESA.tipo_documento_id).trigger('change').trigger('select2:select');\n                    $('#documento_usuario').val(USUARIO_EMPRESA.documento);\n                    $('#email').val(USUARIO_EMPRESA.email);\n\n                    rellenarInputCelular(\n                        USUARIO_EMPRESA.indicativo_telefono,\n                        USUARIO_EMPRESA.codigo_iso2_pais_telefono,\n                        USUARIO_EMPRESA.telefono,\n                        CAMPO_CELULAR_USUARIO_ID,\n                        campo_celular_usuario\n                    );\n\n                    $('#usuario').val(JSON.stringify({\n                        id               : USUARIO_EMPRESA.id,\n                        tipo_documento_id: USUARIO_EMPRESA.tipo_documento_id,\n                        documento        : USUARIO_EMPRESA.documento,\n                        nombres          : USUARIO_EMPRESA.nombres,\n                        apellidos        : USUARIO_EMPRESA.apellidos,\n                        email            : USUARIO_EMPRESA.email,\n                        telefono         : USUARIO_EMPRESA.telefono\n                    }));\n                }\n\n                $('#nombre_tesorero').val(empresa.nombre_tesorero);\n                $('#email_tesorero').val(empresa.email_tesorero);\n\n                rellenarInputCelular(\n                    empresa.indicativo_celular_tesorero,\n                    empresa.codigo_iso2_pais_celular_tesorero,\n                    empresa.celular_tesorero,\n                    CAMPO_CELULAR_TESORERO_ID,\n                    campo_celular_tesorero\n                );\n\n                if ( empresa.telefono_tesorero != null) {\n                    let telefono_tesorero = empresa.telefono_tesorero.split('-');\n                    $('#telefono_tesorero').val(telefono_tesorero[0]);\n                    $('#extension_tesorero').val(empresa.telefono_tesorero[1]);\n                }\n                $('#nombre_contacto').val(empresa.nombre_contacto);\n                $('#email_contacto').val(empresa.email_contacto);\n\n                rellenarInputCelular(\n                    empresa.indicativo_celular_contacto,\n                    empresa.codigo_iso2_pais_celular_contacto,\n                    empresa.celular_contacto,\n                    CAMPO_CELULAR_CONTACTO_ID,\n                    campo_celular_contacto\n                );\n\n                empresa_seleccionada = empresa;\n                mostrarPlanes();\n                $('#empresa-tab').click();\n                $('#tabs-empresa').removeClass('d-none');\n                usuarios = empresa.usuarios;\n                mostrarUsuarios(empresa_id);\n                configuraciones_defecto = empresa.configuraciones_defecto;\n                configuraciones_personalizadas = empresa.configuraciones_personalizadas;\n                let archivos = empresa.archivos;\n                $('.contenedor-archivo').addClass('d-none');\n                archivos.forEach((archivo) => {\n                    $('#archivo_' + archivo.nombre).removeClass('d-none');\n                    $('#archivo_' + archivo.nombre).prop('href', '/archivos-abrir/' + archivo.id);\n                });\n\n                mostrarConfiguraciones();\n            },\n            error: function(error) {\n                console.log(error);\n            }\n        });\n    } else if ($('#filtro_empresa_id').val() != '' && $('#filtro_empresa_id').val() != null) {\n        obtenerDatosGestionarEmpresa($('#filtro_empresa_id').val());\n        $('#tabs-empresa').removeClass('d-none');\n    }\n};\n\n/**\n * Actualizar los elementos anchor de previsualización de archivos de la empresa.\n *\n * @param {array} archivos_empresa Arreglo de archivos de la empresa.\n * @param {boolean} reiniciar_campo_archivo Si se debe reiniciar el campo de archivo.\n * @returns {void}\n * @author Fahibram Cárcamo\n * @author Andres Gonzalez\n */\nfunction actualizarEnlacesPrevisualizacionArchivos(archivos_empresa, reiniciar_campo_archivo = true) {\n    // Oculta todos los elementos anchor de previsualización de archivos.\n    $('.previsualizacion-archivo').addClass('d-none');\n\n    // Muestra los elementos de previsualización de archivos que corresponden con los archivos\n    // relacionados con la empresa.\n    for (let i = 0; i < archivos_empresa.length; i++) {\n        $('#archivo_' + archivos_empresa[i].nombre).prop('href', `/archivos-abrir/${archivos_empresa[i].id}`);\n        $('#archivo_' + archivos_empresa[i].nombre).removeClass('d-none');\n\n        let input_archivo = $('#' + archivos_empresa[i].nombre + '.input-file.input-form');\n        let input_archivo_label = $('label[for=\"' + archivos_empresa[i].nombre + '\"].nombre-archivo');\n        let input_archivo_boton_eliminar = $('#boton-eliminar-archivo-' + archivos_empresa[i].nombre + '.eliminar-archivo');\n\n        if(reiniciar_campo_archivo) {\n            reiniciarCampoArchivo(input_archivo, input_archivo_label, input_archivo_boton_eliminar);\n        }\n    }\n}\n\n/**\n * mostrar los planes de la empresa.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanes() {\n    let empresa_id = empresa_seleccionada.id;\n    let buscar = $('#buscador-plan').val();\n    let filtro_tipo_prueba_id = $('#filtro_tipo_prueba_id').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        tabla_planes.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    let planes = empresa_seleccionada.planes;\n    if (planes.length > 0) {\n        for (let i = 0; i < planes.length; i++) {\n            if (\n                (filtro_tipo_prueba_id == 'Todos') ||\n                (filtro_tipo_prueba_id == '1' && planes[i].plan.tipo_prueba_id == 1) ||\n                (filtro_tipo_prueba_id == '2' && planes[i].plan.tipo_prueba_id == 2) ||\n                (filtro_tipo_prueba_id == '3' && planes[i].plan.tipo_prueba_id != 3)\n            ) {\n                let estado = obtenerEstadoPlan(\n                    planes[i].estado.id,\n                    planes[i].estado.nombre,\n                    planes[i].por_facturar,\n                    planes[i].renovando,\n                    null,\n                    planes[i].plan_proximo_id\n                );\n\n                let acciones = obtenerAcciones(\n                    planes[i].estado.id,\n                    planes[i].id, empresa_id,\n                    planes[i].plan.tipo_prueba_id,\n                    planes[i].plan.nombre,\n                    planes[i]?.archivos[0]?.id ?? '0',\n                    empresa_seleccionada.nombre_comercial\n                );\n\n                let modificado = '';\n                if (planes[i].plan_original == 0) {\n                    modificado = `<i class=\"bi bi-wrench me-3 text-blue-40\" ${crearTooltip({placement: 'top', content: 'Plan modificado', toggle: 'popover' })}></i>`;\n                }\n                let fecha_vencimiento = '';\n                if (planes[i].fecha_vencimiento != null) {\n                    fecha_vencimiento = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                }\n                let fecha_creacion = '';\n                if (planes[i].created_at != null) {\n                    fecha_creacion = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                }\n                let fecha_inicio = '';\n                if (planes[i].fecha_inicio != null) {\n                    fecha_inicio = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                }\n                let pruebas_plan = '';\n                if (planes[i].pruebas !== undefined) {\n                    let pruebas = planes[i].pruebas;\n                    for (let j = 0; j < pruebas.length; j++) {\n                        pruebas_plan += `\n                            <div\n                                class=\"col-auto me-3 circulo-prueba\"\n                                style=\"background-image: url(../imagenes/logos/pruebas/${slugify(planes[i].pruebas[j].nombre)}.png)\"\n                                ${crearTooltip({placement: 'top', content: planes[i].pruebas[j].nombre, toggle: 'popover' })}\n                            ></div>\n                        `;\n                    }\n                }\n                let icono = '';\n                let title = '';\n                if (planes[i].plan.tipo_prueba_id == 1) {\n                    title = 'Selección';\n                    icono = 'bi-person-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 2) {\n                    title = 'Organizacional';\n                    icono = 'bi-people-fill';\n                } else if (planes[i].plan.tipo_prueba_id == 3) {\n                    title = 'Vocacional';\n                    icono = 'bi-mortarboard-fill';\n                }\n                let opcion_editar = `\n                    <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=seleccion'\">\n                        <i class=\"bi bi-pencil-fill\"></i>\n                    </button>\n                `;\n                if (planes[i]?.plan_proximo_id) {\n                    opcion_editar = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited dropdown\" title=\"Editar\">\n                            <i class=\"bi bi-pencil-fill\" data-bs-toggle=\"dropdown\" data-bs-auto-close=\"outside\" aria-expanded=\"false\"></i>\n                            <div class=\"dropdown-menu\">\n                                <a href=\"/empresas-planes/${planes[i].id}/edit?tipo=seleccion\" class=\"dropdown-item no-visited pointer py-2\">Editar plan vigente</a>\n                                <a href=\"/empresas-planes/${planes[i]?.plan_proximo_id}/edit?tipo=seleccion\" class=\"dropdown-item no-visited pointer py-2\">Editar plan próximo</a>\n                            </div>\n                        </button>\n                    `;\n                }\n                $('#tbody-planes').append(`\n                    <tr>\n                        <td style=\"border-bottom: 0px!important;\">\n                            <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                    <div class=\"col\">\n                                        <div class=\"row align-items-center\">\n                                            <div class=\"col-auto mb-0\">\n                                                <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                    <i class=\"bi ${icono} me-3\" title=\"${title}\"></i> ${modificado} ${planes[i].plan.nombre}\n                                                </p>\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                ${estado}\n                                            </div>\n                                            <div class=\"col-auto\">\n                                                <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                    <i class=\"bi bi-person-fill\"></i>&nbsp;<span class=\"text-label-2\">${planes[i].cantidad_usuarios}&nbsp;${fecha_vencimiento}</span>\n                                                </p>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n                                                <div class=\"row w-100 m-0\">${pruebas_plan}</div>\n                                            </div>\n                                            <div class=\"col-12 mt-3\">\n\n                                            </div>\n                                        </div>\n                                    </div>\n                                    <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                        ${opcion_editar}\n                                        ${crearBoton({\n                                            clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                            texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                            adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                        })}\n                                        ${acciones}\n                                    </div>\n                                </div>\n                                <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                    <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                        ${crearTag({\n                                            class: 'tag-sm tag-tonal-yellow',\n                                            icono: '<i class=\"bi bi-briefcase\"></i>',\n                                            texto: 'Vacantes: ' + (planes[i].cantidad_ofertas_laborales !== null ? planes[i].cantidad_ofertas_laborales : ''),\n                                        })}\n                                        ${crearTag({\n                                            class: 'tag-sm tag-tonal-yellow',\n                                            icono: '<i class=\"bi bi-box\"></i>',\n                                            texto: 'Unidades: ' + (planes[i].unidades !== null ? planes[i].unidades : ''),\n                                        })}\n                                        ${crearTag({\n                                            class: 'tag-sm tag-tonal-yellow',\n                                            icono: '<i class=\"bi bi-clock\"></i>',\n                                            texto: 'Tiempo: ' + (planes[i].vigencia_dias !== null ? planes[i].vigencia_dias : '') + ' días',\n                                        })}\n                                    </div>\n                                    <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                        <p class=\"text-label-2 mb-0\">\n                                            <span class=\"text-gray-50 me-3\">${fecha_creacion}</span>\n                                            <span class=\"text-gray-30\">${fecha_inicio}</span>\n                                        </p>\n                                    </div>\n                                </div>\n                            </div>\n                        </td>\n                    </tr>\n                `);\n            }\n        }\n\n        // Mostrar cards de planes de créditos\n        let planes_creditos_mostrados = [];\n        for (let i = 0; i < planes.length; i++) {\n            if (planes[i].plan_credito && planes[i].plan_credito.id) {\n                // Evitar duplicados de plan_credito\n                if (!planes_creditos_mostrados.includes(planes[i].plan_credito.id)) {\n                    planes_creditos_mostrados.push(planes[i].plan_credito.id);\n\n                    let plan_credito = planes[i].plan_credito;\n                    let creditos_totales = planes[i].creditos !== null ? planes[i].creditos : 0;\n                    let creditos_restantes = planes[i].creditos_restantes !== null ? planes[i].creditos_restantes : 0;\n                    let creditos_promedio = empresa_seleccionada.creditos_promedio_accion || 0;\n                    let acciones_estimadas = creditos_restantes > 0 && creditos_promedio > 0\n                        ? Math.floor(creditos_restantes / creditos_promedio)\n                        : 0;\n\n                    let estado_credito = creditos_restantes > 0\n                        ? `<span class=\"tag tag-sm tag-tonal-green\">Disponible</span>`\n                        : `<span class=\"tag tag-sm tag-tonal-red\">Agotado</span>`;\n\n                    let precio_informacion= '';\n                    if (plan_credito.precio) {\n                        precio_informacion= `$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}`;\n                        if (plan_credito.porcentaje_descuento && plan_credito.precio_con_descuento) {\n                            precio_informacion= `<span class=\"text-decoration-line-through text-gray-50\">$${parseFloat(plan_credito.precio).toLocaleString('es-CO')}</span>\n                                          <span class=\"text-green-40 ms-2\">$${parseFloat(plan_credito.precio_con_descuento).toLocaleString('es-CO')}</span>\n                                          <span class=\"tag tag-sm tag-tonal-green ms-2\">-${plan_credito.porcentaje_descuento}%</span>`;\n                        }\n                    }\n\n                    let fecha_promocion = '';\n                    if (plan_credito.fecha_inicio_promocion && plan_credito.fecha_fin_promocion) {\n                        fecha_promocion = `Promoción: ${obtenerFecha(plan_credito.fecha_inicio_promocion)} - ${obtenerFecha(plan_credito.fecha_fin_promocion)}`;\n                    }\n\n                    let fecha_creacion_credito = '';\n                    if (planes[i].created_at != null) {\n                        fecha_creacion_credito = `Creación: ${obtenerFecha(planes[i].created_at)}`;\n                    }\n\n                    let fecha_activacion_credito = '';\n                    if (planes[i].fecha_inicio != null) {\n                        fecha_activacion_credito = `Activación: ${obtenerFecha(planes[i].fecha_inicio)}`;\n                    }\n\n                    let fecha_vencimiento_credito = '';\n                    if (planes[i].fecha_vencimiento != null) {\n                        fecha_vencimiento_credito = `<span class=\"ms-3\">Vencimiento: ${obtenerFecha(planes[i].fecha_vencimiento)}</span>`;\n                    }\n\n                    let opcion_editar_credito = `\n                        <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle no-visited\" title=\"Editar\" onclick=\"window.location.href='/empresas-planes/${planes[i].id}/edit?tipo=creditos'\">\n                            <i class=\"bi bi-pencil-fill\"></i>\n                        </button>\n                    `;\n\n                    $('#tbody-planes').append(`\n                        <tr>\n                            <td style=\"border-bottom: 0px!important;\">\n                                <div class=\"border border-1 rounded rounded-3 text-gray-30\">\n                                    <div class=\"row m-0 w-100 px-3 pt-6 text-headline-6\">\n                                        <div class=\"col\">\n                                            <div class=\"row align-items-center\">\n                                                <div class=\"col-auto mb-0\">\n                                                    <p class=\"text-gray-30 text-headline-4 mb-0\">\n                                                        <i class=\"bi bi-coin me-3\" title=\"Plan de Créditos\"></i> ${plan_credito.nombre}\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    ${estado_credito}\n                                                </div>\n                                                <div class=\"col-auto\">\n                                                    <p class=\"text-headline-5 text-gray-30 d-flex align-items-center mb-0\">\n                                                        <span class=\"text-label-2\">${fecha_vencimiento_credito}</span>\n                                                    </p>\n                                                </div>\n                                                <div class=\"col-12 mt-3\">\n                                                </div>\n                                            </div>\n                                        </div>\n                                        <div class=\"col-auto w-120px pt-4 position-relative d-flex justify-content-end\">\n                                            ${opcion_editar_credito}\n                                            ${crearBoton({\n                                                clases: 'btn btn-text-primary-border text-white btn-circle ms-3',\n                                                texto: '<i class=\"bi bi-three-dots-vertical\"></i>',\n                                                adicional: 'data-bs-toggle=\"dropdown\" aria-expanded=\"false\"'\n                                            })}\n                                        </div>\n                                    </div>\n                                    <div class=\"d-flex justify-content-between w-100 mx-0 mb-6 px-3\">\n                                        <div class=\"d-flex align-items-center ps-3 column-gap-3\">\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos disponibles: ' + creditos_restantes.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Créditos promedio por acción: ' + creditos_promedio.toLocaleString('es-CO'),\n                                            })}\n                                            ${crearTag({\n                                                class: 'tag-sm tag-tonal-yellow',\n                                                texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                                            })}\n                                        </div>\n                                        <div class=\"d-flex justify-content-end align-items-end pe-3\">\n                                            <p class=\"text-label-2 mb-0\">\n                                                <span class=\"text-gray-50 me-3\">${fecha_creacion_credito}</span>\n                                                <span class=\"text-gray-30\">${fecha_activacion_credito}</span>\n                                            </p>\n                                        </div>\n                                    </div>\n                                </div>\n                            </td>\n                        </tr>\n                    `);\n                }\n            }\n        }\n\n        inicializarTooltips();\n        tabla_planes = $('#tabla-planes').DataTable({\n            \"paging\": false,\n            \"searching\": true,\n            \"ordering\": false,\n            \"info\": false\n        });\n        let buscador = $('#tabla-planes_wrapper input');\n        $(buscador).addClass('rounded-2 text-body-2');\n        $(buscador).prop('placeholder', 'Buscar');\n        $(buscador).prop('id', 'buscador-plan');\n        $('#input-busqueda').append(buscador);\n        $(buscador).val(buscar).trigger('input');\n    } else {\n        $('#fila-cabecera-tabla-planes').remove();\n        $('#tbody-planes').append(`\n            <tr class=\"w-100 d-flex justify-content-center align-items-center\" style=\"height: 480px;\">\n                <td class=\"d-flex justify-content-center align-items-center flex-column row-gap-4\">\n                    <p class=\"text-center text-gray-60 m-0\" style=\"font-size: 80px;\"><i class=\"bi bi-slash-circle m-0 p-0\"></i></p>\n                    <div class=\"m-0\">\n                        <p class=\"text-center text-body-2 text-gray-30 fs-4 mb-3\">Aún no hay planes asignados</p>\n                        <p class=\"text-center text-body-2 text-gray-30 mb-0\">Comienza ahora</p>\n                    </div>\n                    ${crearBoton({\n                        id: 'boton-asignar-plan',\n                        type: 'button',\n                        clases: 'btn-primary',\n                        texto: 'Asignar plan',\n                        url: `/asignar-plan/${empresa_id}`\n                    })}\n                </td>\n            </tr>\n        `);\n    }\n}\n\nfunction obtenerFecha(fecha) {\n    let fecha_obj = new Date(fecha);\n    let dia = ('0' + fecha_obj.getUTCDate()).slice(-2);\n    let mes = ('0' + (fecha_obj.getUTCMonth() + 1)).slice(-2);\n    let año = fecha_obj.getUTCFullYear();\n    return `${dia}/${mes}/${año}`;\n}\n\nfunction obtenerEstadoPlan(estado_id, nombre, por_facturar = 0, renovando = 0, empresa_plan_id = null, proximo = false) {\n\n    let detalle_empresa_plan = '';\n    if (empresa_plan_id != null) {\n        detalle_empresa_plan = `onclick=\"abrirDetallePlan(${empresa_plan_id})\"`;\n    }\n    let badge_proximo = '';\n    if (proximo) {\n        badge_proximo = `<span class=\"position-absolute badge badge-proximo bg-purple rounded-pill text-label-2 py-0 px-1 fw-normal\"><div class=\"text-white texto-proximo\">Próximo: </div>+1</span>`;\n    }\n    let estado = '';\n    if (por_facturar == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-por-facturar text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>Por facturar${badge_proximo}</span>`;\n    } else if (renovando == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-renovado text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>Renovando${badge_proximo}</span>`;\n    } else if (estado_id == 1) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-activo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 2) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-inactivo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 3) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-proximo text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 4) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-por-vencer text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    } else if (estado_id == 5) {\n        estado = `<span class=\"alert badge-estado-plan badge-estado-vencido text-body-3 px-0 py-1 mb-0 fw-bold pointer\" ${detalle_empresa_plan}>${nombre}${badge_proximo}</span>`;\n    }\n\n    return estado;\n}\n\n/**\n * Obtener las acciones para la tabla de recompras.\n *\n * @param {number} estado_id Id del estado\n * @param {number} id Id del plan\n * @param {number} empresa_id Id de la empresa\n * @param {number} tipo_prueba_id Id del tipo de prueba\n * @param {string} tipo_prueba_nombre Nombre del tipo de prueba\n * @param {number} id_archivo Id del archivo\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa\n * @returns {string}\n * @author José Manuel Jimenez\n * @author Fahibram Cárcamo\n */\nfunction obtenerAcciones(estado_id, id, empresa_id, tipo_prueba_id, tipo_prueba_nombre, id_archivo, nombre_comercial_empresa) {\n\n    let acciones_html = '<ul class=\"dropdown-menu py-1\">';\n\n    if ([1, 4, 5].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\">\n            <button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"generarEnlaceCreacion(${id})\">Renovar</button>\n        </li>`;\n    }\n\n    acciones_html += `\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"window.location = '/facturar-plan/${id}'\">Facturación de recompra</button>\n        </li>\n        <li class=\"py-1\">\n            <button\n                type=\"button\"\n                class=\"dropdown-item text-body-2 text-gray-30\"\n                onclick=\"abrirHistorialRecompras(${empresa_id}, ${tipo_prueba_id}, '${tipo_prueba_nombre}', '${nombre_comercial_empresa}')\"\n            >\n                Historial de recompras\n            </button>\n        </li>\n        <li class=\"py-1\">\n            <button type=\"button\" class=\"dropdown-item text-body-2 text-gray-30\" onclick=\"abrirFacturaPlan(${id_archivo})\">Ver factura</button>\n        </li>\n    `;\n\n    if ([1, 2, 3].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-gray-30\" type=\"button\" onclick=\"inactivar(${id})\">Inactivar</button></li>`;\n    }\n\n    if ([1, 3].includes(estado_id)) {\n        acciones_html += `<li class=\"py-1\"><button class=\"dropdown-item text-body-2 text-danger\" type=\"button\" onclick=\"eliminar(${id})\">Eliminar</button></li>`;\n    }\n\n    acciones_html += '</ul>';\n\n    return acciones_html;\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\nfunction abrirAcciones(elemento) {\n    $(elemento).parent().find('.acciones-lista').removeClass('d-none');\n}\n\n$(document).mouseup(function(e) {\n    var acciones = $(\".acciones-lista\");\n    if (!acciones.is(e.target) && acciones.has(e.target).length === 0) {\n        $(\".acciones-lista\").addClass('d-none');\n    }\n});\n\n/**\n * Agrega los usuarios a la tabla de usuarios.\n *\n * @param {number} empresa_id Id de la empresa o sucursal.\n * @returns {void}\n * @author Jose Jimenez\n * @author Fahibram Cárcamo\n * @author Andres Gonzalez\n */\nasync function mostrarUsuarios(empresa_id) {\n    let filtrar_usuarios = $('#filtrar-usuarios').val();\n    if ($.fn.DataTable.isDataTable('#tabla-usuarios')) {\n        tabla_usuarios.destroy();\n    }\n    $('#buscador-usuario').remove();\n    $('#tbody-usuarios').empty();\n    for (let i = 0; i < usuarios.length; i++) {\n        if (\n            usuarios[i].usuario != undefined &&\n            (\n                (filtrar_usuarios == 'Todos') ||\n                (filtrar_usuarios == '1' && usuarios[i].usuario.estado.id == 1) ||\n                (filtrar_usuarios == '2' && usuarios[i].usuario.estado.id == 2)\n            )\n        ) {\n            let estado = `\n                <div class=\"col-12 text-gray-30 text-end\">\n                    <span class=\"me-3\">Inactivo</span>\n                    <div class=\"custom-switch\">\n                        <input type=\"checkbox\" id=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-input\" onclick=\"activarOInactivarUsuarios(this.checked, ${usuarios[i].usuario.id})\">\n                        <label for=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-label\"></label>\n                    </div>\n                </div>\n            `;\n            if (usuarios[i].usuario.estado.id == 1) {\n                estado = `\n                    <div class=\"col-12 text-gray-30 text-end\">\n                        <span class=\"me-3\">Activo</span>\n                        <div class=\"custom-switch\">\n                            <input type=\"checkbox\" id=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-input\" onclick=\"activarOInactivarUsuarios(this.checked, ${usuarios[i].usuario.id})\" checked>\n                            <label for=\"check-estado-usuario-${usuarios[i].usuario.id}\" class=\"custom-switch-label\"></label>\n                        </div>\n                    </div>\n                `;\n            }\n            let checked = '';\n            if (usuarios_seleccionados.includes(usuarios[i].usuario.id)) {\n                checked = 'checked';\n            }\n            $('#tbody-usuarios').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-3\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6 align-items-center\">\n                                <div class=\"col-auto\">\n                                    <div class=\"check-container my-1 me-1\">\n                                        <input type=\"checkbox\" class=\"form-check-input\" value=\"${usuarios[i].usuario.id}\" ${checked} onclick=\"seleccionarUsuario(this.value, this.checked);\">\n                                    </div>\n                                </div>\n                                <div class=\"col-auto w-120px px-0 text-center text-headline-7 text-gray-30\">\n                                    <div class=\"row justify-content-center mb-1\">\n                                        <div class=\"imagen-usuario\" style=\"background-image: url(/usuarios-imagen/${usuarios[i].usuario.id})\"></div>\n                                    </div>\n                                    ${usuarios[i]?.usuario?.ciudad?.nombre ?? ''}, ${usuarios[i]?.usuario?.ciudad?.departamento?.pais.nombre ?? ''}\n                                </div>\n                                <div class=\"col ps-lg-4\">\n                                    <div class=\"row w-100 mx-0\">\n                                        <div class=\"col-12 mb-0 text-gray-10 text-headline-5\">\n                                            ${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos} | <span class=\"text-headline-7 mb-0\">${obtenerEdad(usuarios[i].usuario.fecha_nacimiento)}</span>\n                                        </div>\n                                        <div class=\"col-12 mt-2 text-gray-50 text-headline-7\">\n                                            Rol: ${usuarios[i]?.rol?.name ?? ''} <span class=\"ms-3\">Cargo:</span> ${usuarios[i]?.usuario?.cargo?.nombre ?? ''}\n                                        </div>\n                                        <div class=\"col-12 mt-3 text-gray-30 text-headline-7\">\n                                            <i class=\"bi bi-envelope me-1\"></i> ${usuarios[i]?.usuario?.email} <i class=\"bi bi-telephone ms-4 me-1\"></i> ${usuarios[i]?.usuario?.telefono}\n                                        </div>\n                                        <div class=\"col-12 mt-1 text-gray-30 text-headline-7\">\n                                            <i class=\"bi bi-person-vcard me-1\"></i> ${usuarios[i]?.usuario?.tipo_documento?.abreviatura} ${usuarios[i]?.usuario?.documento}\n                                        </div>\n                                    </div>\n                                </div>\n                                <div class=\"col-auto\">\n                                    <div class=\"row\">\n                                        ${estado}\n                                        <input type=\"hidden\" id=\"usuario_id_${usuarios[i].usuario.id}\" value=\"${usuarios[i].usuario.eliminar}\">\n                                        <div class=\"col-12 pt-4 position-relative d-flex justify-content-end text-gray-30\">\n                                            <div class=\"acciones-lista bg-white rounded-4 py-2 position-absolute shadow d-none\" style=\"width: 260px; right: 0; z-index: 1000;\">\n                                                <div class=\"row m-0 w-100\">\n                                                    <div class=\"col-12 pointer py-3 h6 mb-0\" title=\"Generar acceso\" onclick=\"generarAccesoUsuarios(${usuarios[i].usuario.id});\">Generar acceso</div>\n                                                    <div class=\"col-12 pointer py-3 h6 mb-0\" title=\"Ver uso\" onclick=\"abrirHistorialCambiosUsuario(${usuarios[i].usuario.id}, '${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}', true)\">Historial de cambios</div>\n                                                    ${ usuarios[i].usuario.eliminar ? `<div class=\"col-12 pointer py-3 h6 mb-0 text-danger\" title=\"Eliminar\" onclick=\"abrirModalConfirmarEliminarUsuarios(${usuarios[i].usuario.id}, '${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}');\">Eliminar</div>` : '' }\n                                                </div>\n                                            </div>\n                                            <button\n                                                type=\"button\"\n                                                title=\"Editar\"\n                                                class=\"btn btn-text-primary-border text-white btn-circle\"\n                                                onclick=\"window.location.href='/usuarios/${usuarios[i].usuario.id}/edit?rol_id=${usuarios[i].rol.id}&empresa_id=${empresa_id}'\"\n                                            >\n                                                <i class=\"bi bi-pencil\"></i>\n                                            </button>\n                                            <button type=\"button\" class=\"btn btn-text-primary-border text-white btn-circle ms-3\" onclick=\"abrirAcciones(this);\">\n                                                <i class=\"bi bi-three-dots-vertical\"></i>\n                                            </button>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n    tabla_usuarios = $('#tabla-usuarios').DataTable({\n        \"paging\": true,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": true,\n        \"language\": lenguajeDatatables,\n        \"lengthMenu\": [ [10, 25, 50, 100, 200], [10, 25, 50, 100, 200] ],\n    });\n    mostrarComponenteNumeroRegistrosTabla('tabla-usuarios');\n    mostrarComponenteBuscarTabla('tabla-usuarios');\n    validarCheckUsuariosSeleccionados();\n}\n\nfunction seleccionarTodosUsuarios(checked) {\n    usuarios_seleccionados = [];\n    if (checked) {\n        for (let i = 0; i < usuarios.length; i++) {\n            usuarios_seleccionados.push(usuarios[i].usuario.id);\n        }\n    }\n    mostrarUsuarios();\n}\n\nfunction seleccionarUsuario(usuario_id, checked) {\n    if (checked) {\n        if (!usuarios_seleccionados.includes(parseInt(usuario_id))) {\n            usuarios_seleccionados.push(parseInt(usuario_id));\n        }\n    } else {\n        usuarios_seleccionados = usuarios_seleccionados.filter(id => id !== parseInt(usuario_id));\n    }\n    validarCheckUsuariosSeleccionados();\n}\n\nfunction validarCheckUsuariosSeleccionados() {\n    if (usuarios_seleccionados.length == 0) {\n        $('#check-seleccionar-todos').prop('indeterminate', false);\n        $('.botones-usuarios').prop('disabled', true);\n        $('#check-seleccionar-todos').prop('checked', false);\n    } else if (usuarios_seleccionados.length == usuarios.length) {\n        $('.botones-usuarios').prop('disabled', false);\n        $('#check-seleccionar-todos').prop('indeterminate', false);\n        $('#check-seleccionar-todos').prop('checked', true);\n    } else {\n        $('.botones-usuarios').prop('disabled', false);\n        $('#check-seleccionar-todos').prop('indeterminate', true);\n    }\n    $('#cantidad-seleccionados').text(usuarios_seleccionados.length);\n}\n\nfunction actualizarDataUsuarios() {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-gestionar-datos/${empresa_seleccionada.id}`,\n        processData: false,\n        contentType: false,\n        success: function(respuesta) {\n            let empresa = respuesta.data;\n            usuarios = empresa.usuarios;\n            mostrarUsuarios();\n        },\n        error: function(error) {\n            console.log(error);\n        }\n    });\n}\n\n/**\n * Función para obtener edad actual de un usuario segun su fecha de nacimiénto\n *\n * @param {string} fecha_nacimiento\n * @return {string}\n * @author José Manuel Jiménez\n */\nfunction obtenerEdad(fecha_nacimiento) {\n    if (!fecha_nacimiento) {\n        return \"\";\n    }\n    const hoy = new Date();\n    const nacimiento = new Date(fecha_nacimiento);\n    let edad = hoy.getFullYear() - nacimiento.getFullYear();\n    const mes = hoy.getMonth() - nacimiento.getMonth();\n    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {\n        edad--;\n    }\n    return edad + \" años\";\n}\n\n/**\n * Abrir el historial de recompras de planes de empresa.\n *\n * @param {number} empresa_id ID de la empresa.\n * @param {string} tipo_prueba_id ID del tipo de prueba.\n * @param {string} tipo_prueba_nombre Nombre del tipo de prueba.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nasync function abrirHistorialRecompras(empresa_id, tipo_prueba_id, tipo_prueba_nombre, nombre_comercial_empresa) {\n    destruirTablaExistente('tabla-historial-recompras');\n    $('#nombre-tipo-prueba').text(tipo_prueba_nombre);\n    $('#tabla-historial-recompras').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: true,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 450px)',\n        scrollCollapse: true,\n        ajax: {\n            url : '/planes-historial-recompras',\n            data: function (datos) {\n                datos.empresa_id = empresa_id;\n                datos.tipo_prueba_id = tipo_prueba_id;\n            },\n            dataSrc: function (json) {\n                return Object.values(json.data);\n            }\n        },\n        columns: [\n            {\n                title: '<span class=\"text-body-3\">Plan</span>',\n                data: 'plan.nombre',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: (data, type, row) => `\n                    <div class=\"d-flex\">\n                        <div class=\"col-auto ps-0 d-flex align-items-center\">\n                            ${crearBoton({\n                                clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n                                texto: '<i class=\"bi bi-chevron-down\"></i>',\n                                data: [{ texto: 'id', value: row.id }],\n                            })}\n                        </div>\n                        &nbsp;&nbsp;\n                        <div class=\"col d-flex align-items-center pe-0\">\n                            ${\n                                row.plan_original == 0\n                                    ? `\n                                        <span\n                                            class=\"text-primary me-3\"\n                                            style=\"cursor: pointer\"\n                                            ${crearTooltip({ placement: 'bottom', content: 'Plan modificado', toggle: 'popover'})}\n                                        >\n                                            <i class=\"bi bi-wrench\"></i>\n                                        </span>\n                                    `\n                                    : ''\n                            }\n                            <span class=\"text-body-3\">${data}</span>\n                        </div>\n                    </div>\n                `,\n            },\n            {\n                title: '<span class=\"text-body-3\">Creación</span>',\n                data: 'created_at',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Activación</span>',\n                data: 'fecha_inicio',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Vencimiento</span>',\n                data: 'fecha_vencimiento',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : moment(data).format('YYYY-MM-DD');\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Uso de unidades</span>',\n                data: 'conteo_total_consumos_agendas_empresa_sucursales',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    return `${data}/${row.unidades}`;\n                }\n            },\n            // Por el momento no se mostrará el conteo de consumos ni nada relacionado con ofertas laborales.\n            // {\n            //     title: '<span class=\"text-body-3\">Uso de ofertas</span>',\n            //     data: 'conteo_total_consumos_ofertas_laborales_empresa_sucursales',\n            //     className: 'text-body-3 text-center',\n            //     orderable: false,\n            //     searchable: true,\n            //     render: function (data, type, row) {\n            //         return `${data}/${row.cantidad_ofertas_laborales}`;\n            //     }\n            // },\n            {\n                title: '<span class=\"text-body-3\">Uso de tiempo</span>',\n                data: 'vigencia_dias',\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data, type, row) {\n                    let fecha_hora_actuales = moment();\n                    let fecha_hora_inicio = moment(row.fecha_inicio);\n                    let dias_consumidos = fecha_hora_actuales.clone().diff(fecha_hora_inicio.clone(), 'days');\n\n                    if (row.fecha_vencimiento == null) {\n                        return `${dias_consumidos}/Ilimitado`;\n                    } else {\n                        let fecha_hora_vencimiento = moment(row.fecha_vencimiento);\n                        if (fecha_hora_actuales.clone().isAfter(fecha_hora_vencimiento.clone(), 'day')) return `${row.vigencia_dias}/${row.vigencia_dias}`;\n                        else return dias_consumidos > row.vigencia_dias ? `${row.vigencia_dias}/${row.vigencia_dias}` : `${dias_consumidos}/${row.vigencia_dias}`;\n                    }\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Adjunto</span>',\n                data: null,\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data) {\n                    let archivo_factura = data.archivos !== undefined && data.archivos !== null && data.archivos.length ? data.archivos[0] : null;\n\n                    if (archivo_factura === null) return '---';\n\n                    let arreglo_ruta_archivo = archivo_factura.ruta.split('/');\n                    let nombre_archivo_factura = arreglo_ruta_archivo[arreglo_ruta_archivo.length - 1];\n                    let indice_ultimo_punto = nombre_archivo_factura.lastIndexOf('.');\n\n                    if (indice_ultimo_punto === -1) return '---';\n\n                    let nombre_archivo_factura_sin_extension = nombre_archivo_factura.substring(0, indice_ultimo_punto);\n                    let extension_archivo_factura = nombre_archivo_factura.substring(indice_ultimo_punto);\n                    let nombre_archivo_factura_truncado = nombre_archivo_factura_sin_extension.substring(0, 6);\n\n                    return `${\n                        crearBoton({\n                            clases: 'btn-text-primary text-decoration-underline',\n                            onclick: `descargarFactura(${archivo_factura.id})`,\n                            texto: `${nombre_archivo_factura_truncado}...${extension_archivo_factura}`,\n                            tooltip: `${crearTooltip({placement: `bottom`,content: `${nombre_archivo_factura}`, toggle: 'popover' })}`\n                        })\n                    }`;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Acciones</span>',\n                data: null,\n                className: 'text-body-3 text-center',\n                orderable: false,\n                searchable: false,\n                render: function (data, type, row) {\n                    return `${\n                        crearBoton({\n                            clases: 'btn-text-primary btn-circle',\n                            texto: '<i class=\"bi bi-eye\"></i>',\n                            onclick: `abrirModalConsumosRecompra(${row.id}, '${row.plan.nombre}', '${nombre_comercial_empresa}')`,\n                            tooltip: `${crearTooltip({placement: `bottom`,content: 'Ver consumo', toggle: 'popover' })}`\n                        })\n                    }`;\n                }\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n\n    $('#boton-descargar-historial-recompras').off('click');\n    $('#boton-descargar-historial-recompras').on(\n        'click',\n        evento => {\n            evento.preventDefault();\n            descargarExcel('planes-historial-recompras-exportar', 'historial-de-recompras', true, {empresa_id});\n        }\n    );\n\n    $('#modal-historial-recompras').modal('show');\n    ajustarRenderDataTable('tabla-historial-recompras');\n    cargarDataTablas();\n    $('#buscador-tabla-historial-recompras input.dt-input:not(:last)').remove();\n    $(\".acciones-lista\").addClass('d-none');\n}\n\n/**\n * Abrir la ventana modal de consumos de un plan de empresa.\n *\n * @param {number} empresa_plan_id Id del registro de la tabla empresas_planes.\n * @param {string} nombre_plan Nombre del plan.\n * @param {string} nombre_comercial_empresa Nombre comercial de la empresa.\n * @returns {void}\n * @author Fahibram Cárcamo\n */\nfunction abrirModalConsumosRecompra(empresa_plan_id, nombre_plan, nombre_comercial_empresa) {\n    $('#modal-historial-recompras').modal('hide');\n    abrirModalConsumosEmpresaPlan(empresa_plan_id, nombre_plan, nombre_comercial_empresa);\n}\n\n/**\n * Renderiza el contenido de las subtablas.\n *\n * @param {array} data Array de datos a renderizar.\n * @returns {string} HTML de la subtabla.\n * @author Andres Morales\n * @author Fahibram Cárcamo\n */\nfunction crearContenidoSubTabla(data) {\n    return `\n        <div class=\"d-flex flex-column row-gap-3 w-100 p-6\">\n            <div class=\"d-flex column-gap-5\">\n                <p class=\"m-0\">Costo<br>${formatearNumero(data.precio)}</p>\n                <p class=\"m-0\">Descuento<br>${data.porcentaje_descuento ?? '0'}%</p>\n                <p class=\"m-0\">\n                    Precio de venta\n                    <br>\n                    ${formatearNumero(data.porcentaje_descuento !== null ? (data.precio * (1 - parseInt(data.porcentaje_descuento)/100)) : data.precio)}\n                </p>\n            </div>\n            ${data.comentario == null ? '' : `<div class=\"d-flex flex-column\"><p class=\"m-0\">Detalle de uso<br>${data.comentario}</p></div>`}\n        </div>\n    `;\n}\n\n/**\n * Descargar documento de la factura de un plan.\n *\n * @param {number} id Id del archivo de la factura.\n * @returns {Promise<void>}\n * @author Fahibram Cárcamo\n */\nfunction descargarFactura(id) {\n    $.ajax({\n        type: 'POST',\n        url : `/empresas-planes-descargar-factura/${id}`,\n        data: { _token: $('meta[name=\"csrf-token\"]').attr('content') },\n        xhrFields: {\n            responseType: 'blob'\n        },\n        success: function (respuesta) {\n            let url = window.URL.createObjectURL(respuesta);\n            let a   = document.createElement('a');\n            a.href  = url;\n\n            a.download = `archivo_de_factura_${id}.pdf`;\n            document.body.appendChild(a);\n            a.click();\n            window.URL.revokeObjectURL(url);\n            document.body.removeChild(a);\n        }\n    }).then(() => {\n        mostrarToast('success', 'PDF generado correctamente.');\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al descargar el archivo.');\n    });\n}\n\n/**\n * Inactivar plan de empresa.\n *\n * @param {number} id ID del plan de empresa.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function inactivar(id) {\n    await $.ajax({\n        type: 'POST',\n        url : `/empresas-planes-actualizar/${id}`,\n        data: {\n            _token   : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method  : 'PATCH',\n            estado_id: 2\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', respuesta.message);\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\n/**\n * Generar acceso para usuarios.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function generarAccesoUsuarios(usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-generar-acceso`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n            ids   : usuarios_enviar // IDs de los usuarios seleccionados\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', `Acceso generado correctamente`);\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\n/**\n * Activar o inactivar usuarios.\n *\n * @param {boolean} activar Indica si se deben activar o inactivar los usuarios.\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function activarOInactivarUsuarios(activar = true, usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-actualizar-multiples`,\n        data: {\n            _token   : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method  : 'PATCH',\n            ids      : usuarios_enviar, // IDs de los usuarios seleccionados\n            estado_id: activar ? 1 : 2\n        }\n    }).then((respuesta) => {\n        if (activar) {\n            mostrarToast('success', `Usuario(s) activados con éxito`);\n        } else {\n            mostrarToast('success', `Usuario(s) inactivados con éxito`);\n        }\n        actualizarDataUsuarios();\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\nusuario_id_eliminar = null;\nusuario_nombre_eliminar = '';\n\n/**\n * Función que abre el modal para confirmar la eliminación de usuarios.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction abrirModalConfirmarEliminarUsuarios(usuario_id = null, nombre_usuario = '') {\n    usuario_id_eliminar = usuario_id;\n    let detener_proceso = true;\n\n    for (let elemento of usuarios_seleccionados) {\n        let bandera_usuario = $(`#usuario_id_${elemento}`).val();\n        if (bandera_usuario === 'false' || bandera_usuario === false) {\n            detener_proceso = false;\n            break;\n        }\n    }\n\n    if (detener_proceso) {\n        usuario_nombre_eliminar = nombre_usuario;\n        if (nombre_usuario == '') {\n            nombre_usuario = 'Se van a eliminar ' + usuarios_seleccionados.length + ' usuario(s)';\n        } else {\n            nombre_usuario = 'Se eliminará el usuario ' + nombre_usuario;\n        }\n        $('#nombre-confirmar-eliminacion').text(nombre_usuario);\n        $('#modal-confirmar-eliminacion').modal('show');\n    }else{\n        mostrarToast('danger', 'No es posible eliminar el usuario o los usuarios seleccionados porque tienen relaciones con otros módulos.');\n    }\n\n}\n\n/**\n * Confirmar la eliminación de usuarios.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction confirmarEliminarUsuarios() {\n    eliminarUsuarios(usuario_id_eliminar);\n}\n\n/**\n * Eliminar usuarios.\n *\n * @returns {void}\n * @author Daniel Beltrán\n */\nasync function eliminarUsuarios(usuario_id = null) {\n    usuarios_enviar = [];\n    if (usuario_id != null) {\n        usuarios_enviar.push(usuario_id);\n    } else {\n        usuarios_enviar = usuarios_seleccionados;\n    }\n    await $.ajax({\n        type: 'POST',\n        url : `/usuarios-eliminar-multiples`,\n        data: {\n            _token: $('meta[name=\"csrf-token\"]').attr('content'),\n            ids   : usuarios_enviar\n        }\n    }).then((respuesta) => {\n        if (respuesta.message == 'Usuarios eliminados correctamente' && usuarios_enviar.length == 1 && respuesta.data == 0) {\n            mostrarToast('success', `Usuario eliminado correctamente`);\n        } else if (respuesta.message == 'Usuarios eliminados correctamente' && respuesta.data == 0) {\n            mostrarToast('success', `Usuarios eliminados correctamente`);\n        } else {\n            mostrarToast('neutral', `Algunos usuarios no fueron eliminados, puede que tengan auditorías.`);\n        }\n        usuarios_seleccionados = usuarios_seleccionados.filter(usuario => !usuarios_enviar.includes(usuario));\n        usuario_id_eliminar = null;\n        usuario_nombre_eliminar = '';\n        $('#modal-confirmar-eliminacion').modal('hide');\n        actualizarDataUsuarios();\n        $(\".acciones-lista\").addClass('d-none');\n    }).catch((error) => {\n        mostrarToast('danger', error.message);\n    });\n}\n\nbuscar_usuario_id = null;\nbuscar_usuario_nombre = null;\n\n/**\n * Abrir el historial de cambios de un usuario.\n *\n * @param {number} id ID del usuario.\n * @param {string} nombre Nombre del usuario.\n * @param {boolean} limpiar True para limpiar los filtros de la tabla.\n * @returns {void}\n * @author Daniel Beltrán\n * @author Fahibram Cárcamo\n */\nasync function abrirHistorialCambiosUsuario(id, nombre, limpiar = false) {\n    if (limpiar) {\n        $('#filtro_tipo_accion').val('').trigger('change').trigger('select2:select');\n        $('#filtro_fecha_hora').val('');\n    }\n\n    buscar_usuario_id = id;\n    buscar_usuario_nombre = nombre;\n\n    const TITULOS_CAMPOS = {\n        id                                         : 'ID',\n        empresa_id                                 : 'Empresa',\n        area_id                                    : 'Área',\n        cargo_id                                   : 'Cargo',\n        tipo_documento_id                          : 'Tipo de documento',\n        genero_id                                  : 'Género',\n        ciudad_id                                  : 'Ciudad',\n        estado_id                                  : 'Estado',\n        nombres                                    : 'Nombres',\n        apellidos                                  : 'Apellidos',\n        documento                                  : 'Número de documento',\n        email                                      : 'Correo electrónico',\n        email_secundario                           : 'Correo electrónico corporativo',\n        fecha_nacimiento                           : 'Fecha de nacimiento',\n        direccion                                  : 'Dirección',\n        direccion_extra                            : 'Dirección adicional',\n        telefono                                   : 'Teléfono',\n        telefono_secundario                        : 'Teléfono corporativo',\n        profesion                                  : 'Profesión',\n        postgrado                                  : 'Postgrado',\n        numero_tarjeta_profesional                 : 'Número de tarjeta profesional',\n        numero_licencia_salud_ocupacional          : 'Número de licencia en salud ocupacional',\n        fecha_expedicion_licencia_salud_ocupacional: 'Fecha de expedición de la licencia en salud ocupacional',\n        password                                   : 'Contraseña'\n    };\n\n    destruirTablaExistente('tabla-historial-cambios-usuario');\n\n    $('#historial-usuario-nombre').text(nombre);\n\n    $('#tabla-historial-cambios-usuario').DataTable({\n        autoWidth: false,\n        responsive: true,\n        processing: false,\n        serverSide: true,\n        searching: true,\n        deferRender: true,\n        paging: true,\n        aaSorting: [],\n        language: lenguaje_componente_datatables,\n        lengthMenu: [\n            [5, 10, 25, 50, 100, 200],\n            [5, 10, 25, 50, 100, 200]\n        ],\n        scrollX: true,\n        scrollY: 'calc(100vh - 450px)',\n        scrollCollapse: true,\n        ajax: {\n            url : `/usuarios-historial-cambios/${id}`,\n            data: function (datos) {\n                let filtro_fecha_arreglo = $('#filtro_fecha_hora').val().split(' a ');\n                if (filtro_fecha_arreglo[0] !== undefined && filtro_fecha_arreglo[0] !== '') datos.fecha_desde = filtro_fecha_arreglo[0];\n                if (filtro_fecha_arreglo[1] !== undefined && filtro_fecha_arreglo[1] !== '') datos.fecha_hasta = filtro_fecha_arreglo[1];\n                if ($('#filtro_tipo_accion').val() !== undefined && $('#filtro_tipo_accion').val() !== '') datos.event = $('#filtro_tipo_accion').val();\n            },\n            dataSrc: function (json) {\n                let datos_historial_cambios_usuario = Object.values(json.data);\n                return datos_historial_cambios_usuario\n                    .filter(fila => {\n                        for (const LLAVE in fila.new_values) {\n                            if (TITULOS_CAMPOS[LLAVE] !== undefined && fila.new_values[LLAVE] !== null) return true;\n                        }\n                        for (const LLAVE in fila.old_values) {\n                            if (TITULOS_CAMPOS[LLAVE] !== undefined && fila.old_values[LLAVE] !== null) return true;\n                        }\n\n                        return false;\n                    });\n            }\n        },\n        columns: [\n            // Por el momento no se mostrará el contenido que se muestra debajo de cada fila del historial de cambios.\n            // {\n            //     title: '',\n            //     data: null,\n            //     className: 'text-body-3',\n            //     orderable: false,\n            //     searchable: false,\n            //     render: function (data, type, row) {\n            //         return `\n            //             <div class=\"d-flex\">\n            //                 <div class=\"col-auto ps-0 d-flex align-items-center\">\n            //                     ${crearBoton({\n            //                         clases: 'btn-text-primary text-dark p-2 desplegarSubRow my-auto',\n            //                         texto: '<i class=\"bi bi-chevron-down\"></i>',\n            //                         data: [{texto: 'id', value: row.id}],\n            //                     })}\n            //                 </div>\n            //             </div>\n            //         `;\n            //     }\n            // },\n            {\n                title: '<span class=\"text-body-3\">Dato anterior</span>',\n                data: null,\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    let datos_anteriores = '<p class=\"text-start mb-0\">';\n\n                    for (const LLAVE in row.old_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && row.old_values[LLAVE] !== null) {\n                            if (LLAVE === 'password') row.old_values[LLAVE] = 'Cambio de contraseña';\n                            datos_anteriores += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${row.old_values[LLAVE]}</span>`;\n                        }\n                    }\n\n                    datos_anteriores += '</p>';\n                    return datos_anteriores;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Dato nuevo</span>',\n                data: null,\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data, type, row) {\n                    let datos_nuevos = '<p class=\"text-start mb-0\">';\n\n                    for (const LLAVE in row.new_values) {\n                        if (TITULOS_CAMPOS[LLAVE] !== undefined && row.new_values[LLAVE] !== null) {\n                            if (LLAVE === 'password') row.new_values[LLAVE] = 'Cambio de contraseña';\n                            datos_nuevos += `<span class=\"d-block text-body-3\">${TITULOS_CAMPOS[LLAVE]}: ${row.new_values[LLAVE]}</span>`;\n                        }\n                    }\n\n                    datos_nuevos += '</p>';\n                    return datos_nuevos;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Responsable</span>',\n                data: 'user.nombre_completo',\n                className: 'text-body-3',\n                orderable: false,\n                searchable: true,\n                render: function (data) {\n                    return data == null ? '---' : data;\n                }\n            },\n            {\n                title: '<span class=\"text-body-3\">Fecha y hora</span>',\n                data: 'created_at',\n                className: 'text-body-3',\n                orderable: true,\n                searchable: true,\n                render: function (data) {\n                    return data == null\n                        ? '---'\n                        : `\n                            <p class='text-start mb-0'>\n                                <span class=\"text-body-3 text-gray-10\">${moment(data).format('YYYY-MM-DD')}</span><br>\n                                <span class=\"text-label-2 text-gray-30\">${moment(data).format('hh:mm A')}</span>\n                            </p>\n                        `;\n                }\n            }\n        ],\n        drawCallback: function(settings) {\n            inicializarTooltips();\n        },\n    });\n\n    $('#boton-descargar-historial-cambios-usuario').off('click').on(\n        'click',\n        evento => {\n            evento.preventDefault();\n            descargarExcel(`usuarios-historial-cambios-exportar/${id}`, 'historial-de-cambios-de-usuario');\n        }\n    );\n\n    $('#modal-historial-cambios-usuario').modal('show');\n\n    ajustarRenderDataTable('tabla-historial-cambios-usuario');\n    cargarDataTablas();\n\n    $('#buscador-tabla-historial-recompras input.dt-input:not(:last)').remove();\n    $(\".acciones-lista\").addClass('d-none');\n}\n\nfunction abrirModalFiltrosAvanzados() {\n    $('#modal-historial-cambios-usuario').modal('hide');\n    $('#modal-filtros-avanzados').modal('show');\n}\n\nfunction aplicarFiltrosAvanzados() {\n    abrirHistorialCambiosUsuario(buscar_usuario_id, buscar_usuario_nombre);\n    $('#modal-filtros-avanzados').modal('hide');\n}\n\nfunction borrarFiltrosAvanzados() {\n    $('#filtro_tipo_accion').val('').trigger('change').trigger('select2:select');\n    flatpickr(\"#filtro_fecha_hora\", { mode: \"range\" }).clear();\n    $('#filtro_fecha_hora_alt').val('');\n    $('#modal-filtros-avanzados').modal('hide');\n    abrirHistorialCambiosUsuario(buscar_usuario_id, buscar_usuario_nombre);\n}\n\n/**\n * Obtener historial de cambios de un usuario.\n *\n * @param {number} id ID del usuario.\n * @returns {Promise<Array>}\n * @author Daniel Beltrán\n */\nasync function getHistorialCambiosUsuario(id) {\n    let datos = [];\n    await $.ajax({\n        type: 'GET',\n        url : `/usuarios-historial-cambios/${id}`,\n        data: {\n            event: $('#filtro_tipo_accion').val(),\n            created_at: $('#filtro_fecha_hora').val()\n        }\n    }).then((respuesta) => {\n        datos = respuesta.data || [];\n    }).catch((error) => {\n        console.error(error);\n    });\n    return datos;\n}\n\n/**\n * Validar si 2 arrays son iguales\n *\n * @param {array} arr1 primer array a validar.\n * @param {array} arr2 segundo array a validar.\n * @returns {Boolean}\n * @author José Manuel Jiménez\n */\nfunction arraysIguales(arr1, arr2) {\n    if (arr1.length !== arr2.length) {\n        return false;\n    }\n    return arr1.every((element, index) => element === arr2[index]);\n}\n\n/**\n * Mostrar la información de la configuración\n *\n * @author José Manuel Jiménez\n */\nlet actualizar_configuracion = false;\nfunction mostrarConfiguraciones() {\n    actualizar_configuracion = false;\n    $('#configuracion-1').multiselect('destroy');\n    $('#configuracion-2').multiselect('destroy');\n    for (let i = 0; i < usuarios.length; i++) {\n        if (usuarios[i].usuario != undefined) {\n            $('#configuracion-1').append(`\n                <option value=\"${usuarios[i].usuario.id}\">${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}</option>\n            `);\n            $('#configuracion-2').append(`\n                <option value=\"${usuarios[i].usuario.id}\">${usuarios[i].usuario.nombres} ${usuarios[i].usuario.apellidos}</option>\n            `);\n        }\n    }\n    $('.switch-config').prop('checked', true);\n    for (let i = 0; i < configuraciones_defecto.length; i++) {\n        if (configuraciones_defecto[i].id == 1) {\n            if (configuraciones_defecto[i].valor == 'todos' || configuraciones_defecto[i].valor == 'administradores') {\n                $('#configuracion-1').val([]);\n                $('#elegir_usuarios').val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-1').val(JSON.parse(configuraciones_defecto[i].valor));\n                $('#elegir_usuarios').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if (configuraciones_defecto[i].id == 2) {\n            if (configuraciones_defecto[i].valor == 'todos' || configuraciones_defecto[i].valor == 'administradores') {\n                $('#configuracion-2').val([]);\n                $('#elegir_actividad').val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-2').val(JSON.parse(configuraciones_defecto[i].valor));\n                $('#elegir_actividad').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if ([3, 4, 6, 7].includes(configuraciones_defecto[i].id) && (configuraciones_defecto[i].valor == '0')) {\n            $('#configuracion-' + configuraciones_defecto[i].id).prop('checked', false);\n        }\n        if (configuraciones_defecto[i].id == 5) {\n            $('#configuracion-' + configuraciones_defecto[i].id).val(configuraciones_defecto[i].valor).trigger('change').trigger('select2:select');\n        }\n        if (configuraciones_defecto[i].id == 8) {\n            $('#configuracion-' + configuraciones_defecto[i].id).val(configuraciones_defecto[i].valor);\n        }\n    }\n    for (let i = 0; i < configuraciones_personalizadas.length; i++) {\n        if (configuraciones_personalizadas[i].configuracion_id == 1) {\n            if (configuraciones_personalizadas[i].valor == 'todos' || configuraciones_personalizadas[i].valor == 'administradores') {\n                $('#configuracion-1').val([]);\n                $('#elegir_usuarios').val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-1').val(JSON.parse(configuraciones_personalizadas[i].valor));\n                $('#elegir_usuarios').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 2) {\n            if (configuraciones_personalizadas[i].valor == 'todos' || configuraciones_personalizadas[i].valor == 'administradores') {\n                $('#configuracion-2').val([]);\n                $('#elegir_actividad').val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n            } else {\n                $('#configuracion-2').val(JSON.parse(configuraciones_personalizadas[i].valor));\n                $('#elegir_actividad').val('Elegir usuarios').trigger('change').trigger('select2:select');\n            }\n        }\n        if ([3, 4, 6, 7].includes(configuraciones_personalizadas[i].configuracion_id) && (configuraciones_personalizadas[i].valor == '0')) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).prop('checked', false);\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 5) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).val(configuraciones_personalizadas[i].valor).trigger('change').trigger('select2:select');\n        }\n        if (configuraciones_personalizadas[i].configuracion_id == 8) {\n            $('#configuracion-' + configuraciones_personalizadas[i].configuracion_id).val(configuraciones_personalizadas[i].valor);\n        }\n    }\n    actualizar_configuracion = true;\n}\n\n/**\n * Función que se ejecut al al cambiar un switch\n *\n * @param {boolean} opcion dato que indica si esta o no seleccionado el switch.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction SeleccionarOpcionSwitch(opcion, configuracion_id) {\n    let dato = opcion ? 1 : 0;\n    actualizarConfiguracion(dato, configuracion_id);\n}\n\n/**\n * Función que se ejecuta al seleccionar una opción de los selects de visibilidad\n *\n * @param {boolean} opcion dato que indica el valor seleccionado en el select.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction SeleccionarOpcionVisibilidad(opcion, configuracion_id) {\n    inizializarMultiselect();\n    if (opcion == 'Elegir usuarios') {\n        $('#contenedor-elegir-usuarios-' + configuracion_id).addClass('col-3');\n        $('#contenedor-elegir-usuarios-' + configuracion_id).removeClass('col-6');\n        $('#contenedor-usuarios-' + configuracion_id).removeClass('d-none');\n    } else {\n        $('#contenedor-elegir-usuarios-' + configuracion_id).removeClass('col-3');\n        $('#contenedor-elegir-usuarios-' + configuracion_id).addClass('col-6');\n        $('#contenedor-usuarios-' + configuracion_id).addClass('d-none');\n    }\n    if (actualizar_configuracion) {\n        $('#configuracion-' + configuracion_id).val([]);\n        actualizarConfiguracion(opcion, configuracion_id);\n    }\n    $('#configuracion-' + configuracion_id).multiselect(\"refresh\");\n}\n\n/**\n * Función que se ejecuta al seleccionar alguno o varios usuarios.\n *\n * @param {int} configuracion_id id de configuración a actualizar.\n * @author José Manuel Jiménez\n */\nfunction seleccionarOpcionSelect(configuracion_id) {\n    let usuarios_select = $('#configuracion-' + configuracion_id).val();\n    actualizarConfiguracion(JSON.stringify(usuarios_select.map(numero => parseInt(numero))), configuracion_id);\n}\n\n/**\n * Actualizar la configuración de la empresa.\n *\n * @param {any} valor valor a actualizar en la configuración seleccionada.\n * @param {int} configuracion_id id de configuración a actualizar.\n * @returns {Promise<void>}\n * @author Daniel Beltrán, José Manuel Jiménez\n */\nasync function actualizarConfiguracion(valor, configuracion_id) {\n    if (actualizar_configuracion) {\n        if (configuracion_id == 1 || configuracion_id == 2) {\n            if (valor != 'todos' && valor != 'administradores') {\n                if (valor == '[]') {\n                    mostrarToast('neutral', `Selecciona al menos un usuario`);\n                    return false;\n                } else if (valor == 'Elegir usuarios') {\n                    return false;\n                }\n            }\n        }\n        await $.ajax({\n            type: 'POST',\n            url : `/configuraciones-modelos`,\n            data: {\n                _token          : $('meta[name=\"csrf-token\"]').attr('content'),\n                model_type      : 'App\\\\Models\\\\Empresas\\\\Empresa',\n                modelo_id       : empresa_seleccionada.id,\n                configuracion_id: configuracion_id,\n                valor           : valor\n            }\n        }).then((respuesta) => {\n            mostrarToast('success', respuesta.message);\n            datos = respuesta.data || [];\n        }).catch((error) => {\n            console.error(error);\n        });\n    }\n}\n\n/**\n * metodo para mostrar un tooltip segun el div que lo contenga.\n *\n * @param {div} div del elemento donde se va a mostrar el tooltip\n * @returns {void}\n * @author Sol Espitia\n */\nfunction mostrarTooltip(div) {\n    const tooltip = div.querySelector('.tooltip-bottom');\n    tooltip.style.display = 'inline';\n}\n\n/**\n * metodo para ocultar un tooltip segun el div que lo contenga.\n *\n * @param {div} div del elemento donde se va a mostrar el tooltip\n * @returns {void}\n * @author Sol Espitia\n */\nfunction ocultarTooltip(div) {\n    const tooltip = div.querySelector('.tooltip-bottom');\n    tooltip.style.display = 'none';\n}\n\n/**\n * metodo para seleccionar una empresa en los chackbox para descargar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction seleccionarCheckboxEmpresa(check, empresa_id) {\n    if (check) {\n        empresas_seleccionadas.push(parseInt(empresa_id));\n    } else {\n        empresas_seleccionadas = empresas_seleccionadas.filter(id => id !== parseInt(empresa_id));\n    }\n    if (empresas_seleccionadas.length == cantidad_empresas_listado) {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', false);\n        $('#check-seleccionar-todos-empresas').prop('checked', true);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    } else if (empresas_seleccionadas.length == 0) {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', false);\n        $('#check-seleccionar-todos-empresas').prop('checked', false);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`);\n    } else {\n        $('#check-seleccionar-todos-empresas').prop('indeterminate', true);\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    }\n}\n\n/**\n * metodo para seleccionar todas las empresas en los chackbox para descargar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Morales\n */\nfunction seleccionarTodasEmpresas(check) {\n    empresas_seleccionadas = [];\n    if (check) {\n        for (let i = 0; i < empresas_listado.length; i++) {\n            empresas_seleccionadas.push(empresas_listado[i].id);\n            for (let j = 0; j < empresas_listado[i].sucursales.length; j++) {\n                empresas_seleccionadas.push(empresas_listado[i].sucursales[j].id);\n            }\n        }\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar seleccionado`);\n    } else {\n        $('#boton-descargar-excel').html(`<img class=\"me-3\" src=\"/iconos/excel_icon.svg\"> Exportar todo`);\n    }\n    mostrarEmpresas();\n}\n\n/**\n * metodo para descargar el excel pasandole los id de empresas seleccionados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction descargarExcelEmpresas() {\n    if (empresas_seleccionadas.length > 0) {\n        descargarExcel('empresas-exportar', 'empresas', true, {\n            empresas_ids: empresas_seleccionadas\n        });\n    } else {\n        descargarExcel('empresas-exportar', 'empresas');\n    }\n}\n/**\n * Eliminar el logo de la empresa.\n *\n * @param {number} id ID de la empresa.\n * @returns {Promise<void>}\n * @author Daniel Beltrán\n */\nasync function eliminarLogo(id) {\n    await $.ajax({\n        type: 'POST',\n        url : `/empresas-eliminar-logo/${id}`,\n        data: {\n            _token : $('meta[name=\"csrf-token\"]').attr('content'),\n            _method: 'DELETE'\n        }\n    }).then((respuesta) => {\n        mostrarToast('success', respuesta.message);\n    }).catch((error) => {\n        console.error(error);\n    });\n}\n\n$('#logo_recorte').on('change', evento => {\n    let archivo_logo = evento.target.files[0];\n    if (archivo_logo && archivo_logo.type.startsWith('image/')) {\n        const reader = new FileReader();\n        reader.onload = evento => {\n            let imagen = new Image();\n            imagen.onload = function() {\n                if (imagen.height > 500) {\n                    validacion_logo_mensaje = 'La imagen es demasiado grande. Intenta con dimensiones inferiores a 500px de alto.';\n                    logo_valido = false;\n                } else if (archivo_logo.size > 400_000) {\n                    validacion_logo_mensaje = 'La imagen es demasiado pesada. Intenta con un peso inferior o igual a 400KB.';\n                    logo_valido = false;\n                } else if (!['image/png', 'image/jpg', 'image/jpeg'].includes(archivo_logo.type)) {\n                    validacion_logo_mensaje = 'El formato no es válido. Carga una imagen en JPG o PNG.';\n                    logo_valido = false;\n                } else {\n                    validacion_logo_mensaje = '';\n                    logo_valido = true;\n                }\n            };\n            imagen.src = evento.target.result;\n        };\n        reader.readAsDataURL(archivo_logo);\n    } else {\n        alert('Por favor selecciona un archivo de imagen válido.');\n    }\n});\n","structuredPatch":[{"oldStart":474,"oldLines":8,"newStart":474,"newLines":8,"lines":[" }"," "," $(document).ready(function () {","-    if (opcion_form == \"Editar\") {","-        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;        ","+    if (typeof opcion_form !== 'undefined' && opcion_form == \"Editar\") {","+        let numero = empresa.documento.includes('-') ? parseInt(empresa.documento.split('-')[1]) : 0;","         $(\"#digito_verificacion\").val(numero)","     }","     "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"aba499bb-9cda-4138-8698-682fe1c8872f"}
{"parentUuid":"a3ae6945-e2e2-4348-826e-99e8705e982c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Pc555GNCUPNjMFHVuBcb6k","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Ahora el código verifica si `opcion_form` existe antes de usarla con `typeof opcion_form !== 'undefined'`. Esto evitará el error cuando la variable no esté definida (por ejemplo, cuando no estás en el formulario de edición)."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":681,"cache_read_input_tokens":28618,"cache_creation":{"ephemeral_5m_input_tokens":681,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXHKMD85iV6SN9eFPfiSq","type":"assistant","uuid":"6b6e5b85-2dbf-484d-a112-9baf68beede5","timestamp":"2026-01-19T19:49:55.224Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-19T20:06:05.155Z","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced"}
{"type":"file-history-snapshot","messageId":"e30c4622-831a-4922-8aeb-ff6c80a2cb07","snapshot":{"messageId":"e30c4622-831a-4922-8aeb-ff6c80a2cb07","trackedFileBackups":{"public\\js\\empresas\\empresas.js":{"backupFileName":"14441ae59043bcc7@v2","version":2,"backupTime":"2026-01-19T20:06:06.593Z"}},"timestamp":"2026-01-19T20:06:06.565Z"},"isSnapshotUpdate":false}
{"parentUuid":"9d0cde7a-4046-4742-94c3-c3d3197ac7cb","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01Gib19N8UVJeQ7fxJgudGqo","parentToolUseID":"toolu_01Gib19N8UVJeQ7fxJgudGqo","uuid":"d3d41077-5e94-4b65-8bf3-cf1284599eb5","timestamp":"2026-01-19T19:48:14.870Z"}
{"parentUuid":"0f28c0a1-13b4-4ff7-9e00-14ec64d25494","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01SdeH4Qee7WqqKnXh3BJn72","parentToolUseID":"toolu_01SdeH4Qee7WqqKnXh3BJn72","uuid":"2c5eee1b-8235-4a19-b8c5-b95155ede5e1","timestamp":"2026-01-19T19:48:47.493Z"}
{"parentUuid":"7181ee75-e1e6-46a2-8665-df3a338ee583","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01FEsFiuDN9S7rxWuLpFVDVx","parentToolUseID":"toolu_01FEsFiuDN9S7rxWuLpFVDVx","uuid":"1437799f-45c6-4c59-a707-15bd97c8428d","timestamp":"2026-01-19T19:48:53.397Z"}
{"parentUuid":"1437799f-45c6-4c59-a707-15bd97c8428d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01FEsFiuDN9S7rxWuLpFVDVx","parentToolUseID":"toolu_01FEsFiuDN9S7rxWuLpFVDVx","uuid":"6ebc3d1e-a283-4843-a01a-a285e5980440","timestamp":"2026-01-19T19:48:53.399Z"}
{"parentUuid":"aba499bb-9cda-4138-8698-682fe1c8872f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01AXG5Bt1Mp3dqDsj4v1K2cL","parentToolUseID":"toolu_01AXG5Bt1Mp3dqDsj4v1K2cL","uuid":"2891d53a-4c28-43c8-9139-417907bd0dca","timestamp":"2026-01-19T19:49:27.054Z"}
{"parentUuid":"2891d53a-4c28-43c8-9139-417907bd0dca","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01AXG5Bt1Mp3dqDsj4v1K2cL","parentToolUseID":"toolu_01AXG5Bt1Mp3dqDsj4v1K2cL","uuid":"2f145567-ef5c-47fb-a6cf-a6a75426f95c","timestamp":"2026-01-19T19:49:27.055Z"}
{"parentUuid":"a3ae6945-e2e2-4348-826e-99e8705e982c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01AXG5Bt1Mp3dqDsj4v1K2cL","toolUseID":"toolu_01AXG5Bt1Mp3dqDsj4v1K2cL","timestamp":"2026-01-19T19:49:49.519Z","uuid":"8dfbd89c-8358-4c17-a0f8-72d96f1918ef"}
{"parentUuid":"6b6e5b85-2dbf-484d-a112-9baf68beede5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 477 to 477 from c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\empresas.js:\nopcion_form\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"si llega existir opcion_form entrara al if normal verdad?"}]},"uuid":"e30c4622-831a-4922-8aeb-ff6c80a2cb07","timestamp":"2026-01-19T20:06:06.561Z"}
{"parentUuid":"e30c4622-831a-4922-8aeb-ff6c80a2cb07","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"709e3c43-c9dd-4796-a006-4ba1b9a32ced","version":"2.1.9","gitBranch":"D26-260","slug":"declarative-conjuring-moth","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HZ2tPgSApaz8zxkBA2438J","type":"message","role":"assistant","content":[{"type":"text","text":"Sí, exactamente. La validación funciona así:\n\n1. **`typeof opcion_form !== 'undefined'`** - Primero verifica si la variable existe\n2. **`&& opcion_form == \"Editar\"`** - Solo si existe, entonces compara su valor\n\nGracias al operador `&&` (AND), JavaScript evalúa de izquierda a derecha y si la primera condición es `false`, ni siquiera evalúa la segunda (esto se llama \"short-circuit evaluation\").\n\n**Escenarios:**\n- Si `opcion_form` **no existe** → la primera condición es `false` → no entra al if (y no hay error)\n- Si `opcion_form` **existe y es \"Editar\"** → ambas condiciones son `true` → entra al if normalmente\n- Si `opcion_form` **existe pero no es \"Editar\"** → la segunda condición es `false` → no entra al if\n\nAsí que el comportamiento original se mantiene intacto cuando la variable existe."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":29455,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":29455,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXHLb6TVi6UmZqF627JVT","type":"assistant","uuid":"74fee630-14d6-4f17-8af7-0e9a98901150","timestamp":"2026-01-19T20:06:13.522Z"}

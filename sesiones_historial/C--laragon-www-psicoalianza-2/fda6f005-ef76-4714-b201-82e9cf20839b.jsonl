{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-21T19:45:34.123Z","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b"}
{"type":"file-history-snapshot","messageId":"534db3c6-e4c7-4bca-8fb4-ff57ad0d9535","snapshot":{"messageId":"534db3c6-e4c7-4bca-8fb4-ff57ad0d9535","trackedFileBackups":{},"timestamp":"2026-01-21T19:45:34.216Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 175 to 175 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php:\npublic function getTodo(Request $request): Collection {\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"analiza esto public function getTodo(Request $request): Collection {"}]},"uuid":"534db3c6-e4c7-4bca-8fb4-ff57ad0d9535","timestamp":"2026-01-21T19:45:34.212Z"}
{"parentUuid":"534db3c6-e4c7-4bca-8fb4-ff57ad0d9535","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_019WpBnVTzUesW2ajRDQRC1A","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a analizar el método `getTodo` en el `EmpresaService`. Primero necesito leer el archivo completo para entender el contexto."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":25088,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25088,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXM6e6JnU91JjWvxJXBQA","type":"assistant","uuid":"a19f141f-5daf-4615-880a-9600e28c320f","timestamp":"2026-01-21T19:45:37.873Z"}
{"parentUuid":"a19f141f-5daf-4615-880a-9600e28c320f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_019WpBnVTzUesW2ajRDQRC1A","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015PwcKHvYDed1dK44U7BFry","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":25088,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25088,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CXM6e6JnU91JjWvxJXBQA","type":"assistant","uuid":"c44976e3-07e8-4e99-80db-5ac0305d6faf","timestamp":"2026-01-21T19:45:38.390Z"}
{"parentUuid":"c44976e3-07e8-4e99-80db-5ac0305d6faf","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015PwcKHvYDed1dK44U7BFry","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Exception;\n     6→use Illuminate\\Support\\Str;\n     7→use App\\Traits\\ArchivoTrait;\n     8→use Illuminate\\Http\\Request;\n     9→use Illuminate\\Http\\Response;\n    10→use App\\Models\\Empresas\\Empresa;\n    11→use App\\Http\\Services\\BaseService;\n    12→use Illuminate\\Support\\Collection;\n    13→use Illuminate\\Support\\Facades\\Auth;\n    14→use Maatwebsite\\Excel\\Facades\\Excel;\n    15→use App\\Exports\\Empresas\\HistorialCambiosExport;\n    16→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    17→use App\\Http\\Repositories\\IA\\ServicioIARepository;\n    18→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    19→use App\\Http\\Repositories\\Planes\\ConsumoRepository;\n    20→use App\\Http\\Repositories\\Empresas\\SectorRepository;\n    21→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    22→use App\\Http\\Services\\Configuraciones\\ArchivoService;\n    23→use Symfony\\Component\\HttpFoundation\\StreamedResponse;\n    24→use App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\n    25→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    26→use Symfony\\Component\\HttpFoundation\\{BinaryFileResponse};\n    27→use App\\Http\\Repositories\\Configuraciones\\CiudadRepository;\n    28→use App\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository;\n    29→use App\\Http\\Repositories\\Usuarios\\TipoDocumentoRepository;\n    30→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    31→use App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    32→use App\\Http\\Repositories\\Politicas\\PoliticaAceptadaRepository;\n    33→use App\\Jobs\\Configuraciones\\CrearPlantillasPorDefectoEmpresaJob;\n    34→use App\\Http\\Repositories\\Configuraciones\\ConfiguracionRepository;\n    35→use App\\Http\\Repositories\\Configuraciones\\ConfiguracionModeloRepository;\n    36→\n    37→/**\n    38→ * @property EmpresaRepository $repositorio\n    39→ */\n    40→class EmpresaService extends BaseService\n    41→{\n    42→    use ArchivoTrait;\n    43→\n    44→    private $modelo = 'App\\Models\\Empresas\\Empresa';\n    45→\n    46→    /**\n    47→     * Constructor.\n    48→     *\n    49→     * @param EmpresaRepository $repositorio Repositorio de empresas.\n    50→     * @param ArchivoService $archivo_servicio Servicio de archivos.\n    51→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    52→     * @param PoliticaAceptadaRepository $politica_aceptada_repositorio Repositorio de políticas aceptadas.\n    53→     * @param CiudadRepository $ciudad_repositorio Repositorio de ciudades.\n    54→     * @param SectorRepository $sector_repositorio Repositorio de sectores.\n    55→     * @param TamanoEmpresaRepository $tamano_empresa_repositorio Repositorio de tamaños de empresas.\n    56→     * @param TipoDocumentoRepository $tipo_documento_repositorio Repositorio de tipos de documentos.\n    57→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    58→     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n    59→     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n    60→     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n    61→     * @param ConfiguracionRepository $configuracion_repositorio Repositorio de configuraciones.\n    62→     * @param ConfiguracionModeloRepository $configuracion_modelo_repositorio Repositorio de configuraciones de modelos.\n    63→     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n    64→     * @param ConsumoRepository $consumo_repositorio Repositorio de consumos.\n    65→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    66→     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n    67→     * @return void\n    68→     * @author Daniel Beltrán\n    69→     * @author Jair Carvajal\n    70→     */\n    71→    public function __construct(\n    72→        EmpresaRepository $repositorio,\n    73→        protected ArchivoService $archivo_servicio,\n    74→        protected UserRepository $usuario_repositorio,\n    75→        protected PoliticaAceptadaRepository $politica_aceptada_repositorio,\n    76→        protected CiudadRepository $ciudad_repositorio,\n    77→        protected SectorRepository $sector_repositorio,\n    78→        protected TamanoEmpresaRepository $tamano_empresa_repositorio,\n    79→        protected TipoDocumentoRepository $tipo_documento_repositorio,\n    80→        protected ArchivoRepository $archivo_repositorio,\n    81→        protected TipoPruebaRepository $tipo_prueba_repositorio,\n    82→        protected EmpresaPlanRepository $empresa_plan_repositorio,\n    83→        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n    84→        protected ConfiguracionRepository $configuracion_repositorio,\n    85→        protected ConfiguracionModeloRepository $configuracion_modelo_repositorio,\n    86→        protected EmpresaPlanService $empresa_plan_servicio,\n    87→        protected ConsumoRepository $consumo_repositorio,\n    88→        protected RolRepository $rol_repositorio,\n    89→        protected ServicioIARepository $servicio_ia_repositorio\n    90→    ) {\n    91→        parent::__construct($repositorio);\n    92→    }\n    93→\n    94→    /**\n    95→     * Obtener una empresa.\n    96→     *\n    97→     * @param int $id ID de la empresa.\n    98→     * @return Empresa|null\n    99→     * @author Daniel Beltrán\n   100→     * @author Andres Gonzalez\n   101→     * @author Jair Carvajal\n   102→     */\n   103→    public function getUno(int $id): ?Empresa {\n   104→        $empresa = $this->repositorio->getUnoBasico($id);\n   105→\n   106→        if (!is_null($empresa)) {\n   107→            $planes        = [];\n   108→            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   109→\n   110→            foreach ($tipos_pruebas as $tipo_prueba) {\n   111→                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n   112→                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n   113→\n   114→                if (!is_null($plan)) {\n   115→                    array_push($planes, $plan);\n   116→                }\n   117→            }\n   118→\n   119→            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n   120→                'empresa_id'         => $id,\n   121→                'con_relaciones'     => true,\n   122→                'validar_relaciones' => true,\n   123→                'en'                 => true,\n   124→                'campo'              => 'rol_id',\n   125→                'valores'            => [\n   126→                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n   127→                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n   128→                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n   129→                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n   130→                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n   131→                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   132→                    $this->rol_repositorio::ROL_EVALUADOR_ID\n   133→                ]\n   134→            ]));\n   135→\n   136→            $usuarios = $usuarios->map(function ($usuario) {\n   137→                $eliminar = false;\n   138→\n   139→                if (\n   140→                    !$usuario->usuario->tiene_agendas\n   141→                    && !$usuario->usuario->tiene_ofertas_laborales\n   142→                    && !$usuario->usuario->tiene_procesos\n   143→                    && !$usuario->usuario->tiene_procesos\n   144→                    && !$usuario->usuario->tiene_etapa_usuario\n   145→                ) {\n   146→                    $eliminar = true;\n   147→                }\n   148→\n   149→                $usuario->usuario->eliminar = $eliminar;\n   150→                return $usuario;\n   151→            });\n   152→\n   153→            $empresa->planes                         = $planes;\n   154→            $empresa->usuarios                       = $usuarios;\n   155→            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n   156→            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n   157→                'model_type' => $this->modelo,\n   158→                'modelo_id'  => $id\n   159→            ]));\n   160→            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n   161→        }\n   162→\n   163→        return $empresa;\n   164→    }\n   165→\n   166→    /**\n   167→     * Obtener todas las empresas.\n   168→     *\n   169→     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n   170→     *\n   171→     * @param Request $request Contenido de la petición.\n   172→     * @return Collection\n   173→     * @author Daniel Beltrán\n   174→     */\n   175→    public function getTodo(Request $request): Collection {\n   176→        $empresas      = $this->repositorio->getTodo($request);\n   177→        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n   178→        $coleccion     = [];\n   179→\n   180→        foreach ($empresas as $empresa) {\n   181→            $registro = $empresa;\n   182→\n   183→            foreach ($tipos_pruebas as $tipo_prueba) {\n   184→                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n   185→\n   186→                // Obtener el plan activo, si no tiene se obtiene el último plan asignado\n   187→                $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n   188→\n   189→                if (is_null($registro[$llave])) {\n   190→                    $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(new Request([\n   191→                        'empresa_id'             => $empresa->id,\n   192→                        'tipo_prueba_id'         => $tipo_prueba->id,\n   193→                        'excluir_estado_proximo' => true\n   194→                    ]));\n   195→                }\n   196→\n   197→                // Verificar si tiene un plan próximo adicional al plan actual\n   198→                if (!is_null($registro[$llave])) {\n   199→                    $plan_proximo                     = $this->empresa_plan_repositorio->planProximo($empresa->id, $tipo_prueba->id);\n   200→                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n   201→                }\n   202→            }\n   203→\n   204→            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n   205→            array_push($coleccion, $registro);\n   206→        }\n   207→\n   208→        return collect($coleccion);\n   209→    }\n   210→\n   211→    /**\n   212→     * Obtener el porcentaje de creación.\n   213→     *\n   214→     * @param int $id ID de la empresa.\n   215→     * @return int\n   216→     * @author Daniel Beltrán\n   217→     */\n   218→    public function obtenerPorcentajeCreacion(int $id): int {\n   219→        $empresa    = $this->repositorio->getUno($id);\n   220→        $porcentaje = 0;\n   221→\n   222→        if (is_null($empresa)) {\n   223→            return $porcentaje;\n   224→        }\n   225→\n   226→        if (!is_null($empresa->empresa_id)) {\n   227→            return $porcentaje;\n   228→        }\n   229→\n   230→        $porcentaje += 10;\n   231→\n   232→        if (count($empresa->archivos) > 0) {\n   233→            $porcentaje += 20;\n   234→        }\n   235→\n   236→        if (count($empresa->usuarios) > 0) {\n   237→            $porcentaje += 10;\n   238→        }\n   239→\n   240→        if (count($empresa->planes) > 0) {\n   241→            $porcentaje += 30;\n   242→        }\n   243→\n   244→        if (count($empresa->usuarios) > 1) {\n   245→            $porcentaje += 30;\n   246→        }\n   247→\n   248→        return $porcentaje;\n   249→    }\n   250→\n   251→    /**\n   252→     * Guardar empresa.\n   253→     *\n   254→     * @param Request $request Contenido de la petición.\n   255→     * @throws Exception Cuando un usuario que no es superadministrador, intenta modificar una empresa diferente a la que está logueado.\n   256→     * @return Empresa\n   257→     * @author Daniel Beltrán\n   258→     */\n   259→    public function guardar(Request $request): Empresa {\n   260→        $campos_excluidos = ['_token', '_method', 'id', 'pais_id', 'departamento_id', 'digito_verificacion', 'extension', 'extension_tesorero', 'logo', 'empresa_plan_id'];\n   261→\n   262→        if ($request->filled('digito_verificacion')) {\n   263→            $request->merge(['documento' => $request->documento . '-' . $request->digito_verificacion]);\n   264→        }\n   265→\n   266→        if ($request->filled('telefono') && $request->filled('extension')) {\n   267→            $request->merge(['telefono' => $request->telefono . '-' . $request->extension]);\n   268→        }\n   269→\n   270→        if ($request->filled('telefono_tesorero') && $request->filled('extension_tesorero')) {\n   271→            $request->merge(['telefono_tesorero' => $request->telefono_tesorero . '-' . $request->extension_tesorero]);\n   272→        }\n   273→\n   274→        // Agregar datos a la sucursal\n   275→        if ($request->filled('empresa_id')) {\n   276→            $empresa_principal = $this->repositorio->getUno($request->empresa_id);\n   277→\n   278→            if (!is_null($empresa_principal->empresa_id)) {\n   279→                throw new Exception('No se puede crearse una sucursal de otra sucursal');\n   280→            }\n   281→\n   282→            $request->merge([\n   283→                'tamano_empresa_id' => $empresa_principal->tamano_empresa_id,\n   284→                'razon_social'      => $empresa_principal->razon_social\n   285→            ]);\n   286→\n   287→            unset($empresa_principal);\n   288→        }\n   289→\n   290→        if ($request->filled('id')) {\n   291→            $rol_usuario = $this->rol_repositorio->usuarioRolActivo(Auth::id());\n   292→\n   293→            // Validar que solo el superadministrador pueda editar cualquier empresa\n   294→            if ($rol_usuario->id != RolRepository::ROL_SUPERADMIN_ID) {\n   295→                $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   296→\n   297→                if ($empresa_usuario->id != $request->empresa_id) {\n   298→                    throw new Exception('No puedes editar una empresa diferente a la que estás logueado', Response::HTTP_FORBIDDEN);\n   299→                }\n   300→            }\n   301→\n   302→            $empresa = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   303→        } else {\n   304→            $empresa = $this->repositorio->crear($request->except($campos_excluidos));\n   305→            CrearPlantillasPorDefectoEmpresaJob::dispatch($empresa->id);\n   306→        }\n   307→\n   308→        // Renovación el plan\n   309→        if ($request->filled('empresa_plan_id')) {\n   310→            $this->empresa_plan_servicio->renovar($request->empresa_plan_id);\n   311→        }\n   312→\n   313→        // Guardar el logo de la sucursal\n   314→        if ($request->filled('empresa_id') && $request->filled('logo')) {\n   315→            $this->cambiarLogo($empresa->id, $request->logo);\n   316→        }\n   317→\n   318→        return $empresa;\n   319→    }\n   320→\n   321→    /**\n   322→     * Guardar archivos de la empresa.\n   323→     *\n   324→     * @param int $id ID de la empresa.\n   325→     * @param Request $request Contenido de la petición.\n   326→     * @return void\n   327→     * @author Daniel Beltrán\n   328→     * @author Fahibram Cárcamo\n   329→     */\n   330→    public function guardarArchivos(int $id, Request $request): void {\n   331→        if ($request->filled('logo')) {\n   332→            $this->cambiarLogo($id, $request->logo);\n   333→        }\n   334→\n   335→        foreach ($request->files->all() as $nombre_archivo_empresa => $archivo_empresa) {\n   336→            $archivo_existente = $this->archivo_repositorio->getUnoAvanzado(new Request([\n   337→                'modelo'    => $this->modelo,\n   338→                'modelo_id' => $id,\n   339→                'nombre'    => $nombre_archivo_empresa\n   340→            ]));\n   341→\n   342→            if (!is_null($archivo_existente)) {\n   343→                $this->archivo_servicio->eliminarPorModelo($this->modelo, $id, $nombre_archivo_empresa);\n   344→            }\n   345→\n   346→            $ruta = \"private/archivos/empresas/{$id}\";\n   347→            $this->generarDirectorios(\"app/{$ruta}\");\n   348→\n   349→            $nombre_archivo = $this->generarNombreArchivo($archivo_empresa);\n   350→            $this->guardarArchivoEnRuta($archivo_empresa, $ruta, $nombre_archivo);\n   351→\n   352→            $this->archivo_repositorio->crear([\n   353→                'modelo'                  => $this->modelo,\n   354→                'modelo_id'               => $id,\n   355→                'nombre'                  => $nombre_archivo_empresa,\n   356→                'nombre_original_archivo' => $nombre_archivo,\n   357→                'ruta'                    => $ruta . '/' . $nombre_archivo\n   358→            ]);\n   359→        }\n   360→    }\n   361→\n   362→    /**\n   363→     * Eliminar empresa.\n   364→     *\n   365→     * @param int $id ID de la empresa.\n   366→     * @throws Exception Cuando la empresa tiene algún registro asociado o está archivada.\n   367→     * @return void\n   368→     * @author Daniel Beltrán\n   369→     * @author Fahibram Cárcamo\n   370→     */\n   371→    public function eliminar(int $id): void {\n   372→        $empresa = $this->repositorio->getUnoAvanzado(new Request([\n   373→            'id'                       => $id,\n   374→            'contar_sucursales'        => true,\n   375→            'contar_planes'            => true,\n   376→            'contar_procesos'          => true,\n   377→            'contar_areas'             => true,\n   378→            'contar_perfiles'          => true,\n   379→            'contar_agendas'           => true,\n   380→            'contar_encuestas'         => true,\n   381→            'contar_soportes'          => true,\n   382→            'contar_usuarios'          => true,\n   383→            'contar_ordenes_servicios' => true,\n   384→            'contar_ofertas_laborales' => true,\n   385→            'contar_portales_empleos'  => true\n   386→        ]));\n   387→\n   388→        if ($empresa->activo) {\n   389→            // Validar que no tenga planes\n   390→            if ($empresa->planes_count > 0) {\n   391→                throw new Exception('La empresa tiene planes asignados');\n   392→            }\n   393→\n   394→            // Validar que no tenga sucursales\n   395→            if ($empresa->sucursales_count > 0) {\n   396→                throw new Exception('La empresa tiene sucursales asignadas');\n   397→            }\n   398→\n   399→            // Validar que no tenga procesos\n   400→            if ($empresa->procesos_count > 0) {\n   401→                throw new Exception('La empresa tiene procesos asignados');\n   402→            }\n   403→\n   404→            // Validar que no tenga áreas\n   405→            if ($empresa->areas_count > 0) {\n   406→                throw new Exception('La empresa tiene áreas asignadas');\n   407→            }\n   408→\n   409→            // Validar que no tenga perfiles\n   410→            if ($empresa->perfiles_count > 0) {\n   411→                throw new Exception('La empresa tiene perfiles asignados');\n   412→            }\n   413→\n   414→            // Validar que no tenga agendas\n   415→            if ($empresa->agendas_count > 0) {\n   416→                throw new Exception('La empresa tiene agendas asignadas');\n   417→            }\n   418→\n   419→            // Validar que no tenga encuestas\n   420→            if ($empresa->encuestas_count > 0) {\n   421→                throw new Exception('La empresa tiene encuestas asignadas');\n   422→            }\n   423→\n   424→            // Validar que no tenga soportes\n   425→            if ($empresa->soportes_count > 0) {\n   426→                throw new Exception('La empresa tiene soportes asignados');\n   427→            }\n   428→\n   429→            // Validar que no tenga usuarios\n   430→            if ($empresa->usuarios_count > 0) {\n   431→                throw new Exception('La empresa tiene usuarios asignados');\n   432→            }\n   433→\n   434→            // Validar que no tenga ordenes de servicio\n   435→            if ($empresa->ordenes_servicios_count > 0) {\n   436→                throw new Exception('La empresa tiene ordenes de servicio asignadas');\n   437→            }\n   438→\n   439→            // Validar que no tenga ofertas laborales\n   440→            if ($empresa->ofertas_laborales_count > 0) {\n   441→                throw new Exception('La empresa tiene ofertas laborales asignadas');\n   442→            }\n   443→\n   444→            // Validar que no tenga portales de empleo\n   445→            if ($empresa->portal_empleo_count > 0) {\n   446→                throw new Exception('La empresa tiene portales de empleo asignados');\n   447→            }\n   448→\n   449→            $this->repositorio->sincronizarConfiguraciones($empresa, []);\n   450→            $this->repositorio->eliminar($id);\n   451→        } else {\n   452→            throw new Exception('La empresa está archivada');\n   453→        }\n   454→    }\n   455→\n   456→    /**\n   457→     * Eliminar los usuarios de la empresa junto con sus políticas aceptadas.\n   458→     *\n   459→     * @param Empresa $empresa Empresa.\n   460→     * @param Collection $usuarios Usuarios.\n   461→     * @return void\n   462→     * @author Daniel Beltrán\n   463→     */\n   464→    public function eliminarUsuarios(Empresa $empresa, Collection $usuarios): void {\n   465→        if (count($usuarios) > 0) {\n   466→            foreach ($usuarios as $usuario_empresa) {\n   467→                // Disociar el usuario de la empresa\n   468→                $this->repositorio->disociarUsuario($empresa, $usuario_empresa->id);\n   469→\n   470→                // Disociar las políticas aceptadas del usuario para la empresa\n   471→                $this->politica_aceptada_repositorio->eliminarPorUsuarioYEmpresa($usuario_empresa->id, $empresa->id);\n   472→\n   473→                // Obtener todas las políticas aceptadas del usuario en otras empresas\n   474→                $politicas_otras_empresas = $this->politica_aceptada_repositorio->obtenerPorUsuarioYEmpresasDiferentes($usuario_empresa->id, [$empresa->id]);\n   475→\n   476→                // Obtener los datos del usuario\n   477→                $usuario = $this->usuario_repositorio->getUno($usuario_empresa->id);\n   478→\n   479→                // Validar si el usuario tiene más empresas asociadas y más políticas aceptadas de otras empresas\n   480→                if (count($usuario->empresas) == 0 && count($politicas_otras_empresas) == 0) {\n   481→                    $this->usuario_repositorio->eliminar($usuario_empresa->id);\n   482→                }\n   483→            }\n   484→        }\n   485→    }\n   486→\n   487→    /**\n   488→     * Obtener el historial de cambios.\n   489→     *\n   490→     * @param int $id ID de la empresa.\n   491→     * @return Collection\n   492→     * @author Daniel Beltrán\n   493→     */\n   494→    public function historialCambios(int $id): Collection {\n   495→        $historial       = $this->repositorio->historialCambios($id);\n   496→        $historial_final = [];\n   497→\n   498→        // Obtener los datos referenciados a través de llaves foráneas\n   499→        $ciudades         = $this->obtenerDatosReferenciados($historial, 'ciudad_id', 'ciudades_ids', $this->ciudad_repositorio);\n   500→        $ejecutivos       = $this->obtenerDatosReferenciados($historial, 'ejecutivo_id', 'usuarios_ids', $this->usuario_repositorio);\n   501→        $sectores         = $this->obtenerDatosReferenciados($historial, 'sector_id', 'sectores_ids', $this->sector_repositorio);\n   502→        $tamanos_empresas = $this->obtenerDatosReferenciados($historial, 'tamano_empresa_id', 'tamanos_empresas_ids', $this->tamano_empresa_repositorio);\n   503→        $tipos_documentos = $this->obtenerDatosReferenciados($historial, 'tipo_documento_representante_id', 'tipos_documentos_ids', $this->tipo_documento_repositorio);\n   504→\n   505→        foreach ($historial as $item) {\n   506→            array_push($historial_final, [\n   507→                'id'             => $item->id,\n   508→                'user_type'      => $item->user_type,\n   509→                'user_id'        => $item->user_id,\n   510→                'event'          => $item->event,\n   511→                'auditable_type' => $item->auditable_type,\n   512→                'auditable_id'   => $item->auditable_id,\n   513→                'created_at'     => $item->created_at,\n   514→                'user'           => $item->user,\n   515→                'old_values'     => $this->asignarCambiosHistorial($item->old_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos),\n   516→                'new_values'     => $this->asignarCambiosHistorial($item->new_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos)\n   517→            ]);\n   518→        }\n   519→\n   520→        return collect($historial_final);\n   521→    }\n   522→\n   523→    /**\n   524→     * Asignar los cambios del historial.\n   525→     *\n   526→     * @param array $valores Valores del historial (pueden ser antigüos o nuevos).\n   527→     * @param Collection $ciudades Ciudades.\n   528→     * @param Collection $ejecutivos Ejecutivos.\n   529→     * @param Collection $sectores Sectores.\n   530→     * @param Collection $tamanos_empresas Tamaños de empresas.\n   531→     * @param Collection $tipos_documentos Tipos de documentos.\n   532→     * @return array\n   533→     * @author Daniel Beltrán\n   534→     */\n   535→    private function asignarCambiosHistorial(\n   536→        array $valores,\n   537→        Collection $ciudades,\n   538→        Collection $ejecutivos,\n   539→        Collection $sectores,\n   540→        Collection $tamanos_empresas,\n   541→        Collection $tipos_documentos\n   542→    ): array {\n   543→        $valores_actualizados = [];\n   544→\n   545→        foreach ($valores as $llave => $valor) {\n   546→            $valores_actualizados[$llave] = $valor;\n   547→\n   548→            if ($llave === 'ciudad_id') {\n   549→                $ciudad                       = $ciudades->firstWhere('id', $valor);\n   550→                $valores_actualizados[$llave] = $ciudad->nombre . ', ' . $ciudad->departamento->nombre . ' - ' . $ciudad->departamento->pais->nombre;\n   551→            }\n   552→\n   553→            if ($llave === 'ejecutivo_id') {\n   554→                $valores_actualizados[$llave] = !is_null($valor) ? $ejecutivos->firstWhere('id', $valor)->nombre_completo : null;\n   555→            }\n   556→\n   557→            if ($llave === 'sector_id') {\n   558→                $valores_actualizados[$llave] = $sectores->firstWhere('id', $valor)->nombre;\n   559→            }\n   560→\n   561→            if ($llave === 'tamano_empresa_id') {\n   562→                $valores_actualizados[$llave] = $tamanos_empresas->firstWhere('id', $valor)->nombre;\n   563→            }\n   564→\n   565→            if ($llave === 'tipo_documento_representante_id') {\n   566→                $valores_actualizados[$llave] = !is_null($valor) ? $tipos_documentos->firstWhere('id', $valor)->nombre : null;\n   567→            }\n   568→        }\n   569→\n   570→        return $valores_actualizados;\n   571→    }\n   572→\n   573→    /**\n   574→     * Obtener el logo de la empresa.\n   575→     *\n   576→     * @param int $id ID de la empresa.\n   577→     * @throws Exception Cuando la empresa no tiene ningún logo.\n   578→     * @return BinaryFileResponse|StreamedResponse\n   579→     * @author Daniel Beltrán\n   580→     */\n   581→    public function getLogo(int $id): BinaryFileResponse|StreamedResponse {\n   582→        $logo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n   583→        abort_if(is_null($logo), 404, 'Esta empresa no tiene ningún logo');\n   584→        return $this->obtenerArchivoDesdeRuta($logo->ruta);\n   585→    }\n   586→\n   587→    /**\n   588→     * Cambiar el logo de la empresa.\n   589→     *\n   590→     * Elimina el logo actual y guarda el nuevo.\n   591→     *\n   592→     * @param int $id ID de la empresa.\n   593→     * @param string $logo Nuevo logo en base64.\n   594→     * @return void\n   595→     * @author Daniel Beltrán\n   596→     */\n   597→    public function cambiarLogo(int $id, string $logo): void {\n   598→        $archivo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n   599→\n   600→        if (!is_null($archivo)) {\n   601→            $this->archivo_servicio->eliminar($archivo->id);\n   602→        }\n   603→\n   604→        $this->archivo_servicio->guardarVariosBase64($this->modelo, $id, ['logo' => $logo], 'empresas');\n   605→    }\n   606→\n   607→    /**\n   608→     * Exportar Excel del historial de cambios.\n   609→     *\n   610→     * @param int $id ID de la empresa.\n   611→     * @return BinaryFileResponse|Response\n   612→     * @author Daniel Beltrán\n   613→     */\n   614→    public function exportarExcelHistorialCambios(int $id): BinaryFileResponse|Response {\n   615→        $datos = [\n   616→            'historial_cambios' => $this->historialCambios($id),\n   617→            'archivos'          => $this->archivo_repositorio->getTodo(new Request([\n   618→                'modelo'    => $this->modelo,\n   619→                'modelo_id' => $id\n   620→            ]))\n   621→        ];\n   622→\n   623→        return Excel::download(new HistorialCambiosExport($datos), 'historial-cambios.xlsx');\n   624→    }\n   625→\n   626→    /**\n   627→     * Obtiene el conteo dependiendo de id de empresas planes.\n   628→     *\n   629→     * @param int $empresa_plan_id Id de empresas planes.\n   630→     * @param Request $request Contenido de la petición.\n   631→     * @return int\n   632→     * @author Andres Gonzalez\n   633→     * @author Fahibram Cárcamo\n   634→     */\n   635→    public function conteoConsumo(int $empresa_plan_id, Request $request): int {\n   636→        return $this->consumo_repositorio->getTodo(\n   637→            new Request([\n   638→                'empresa_plan_id' => $empresa_plan_id,\n   639→                'fecha_inicio'    => $request->fecha_inicio,\n   640→                'fecha_fin'       => $request->fecha_fin\n   641→            ])\n   642→        )\n   643→        ->count();\n   644→    }\n   645→\n   646→    /**\n   647→     * Obtiene el resumen para el panel.\n   648→     *\n   649→     * @param Request $request Contenido de la petición.\n   650→     * @return array\n   651→     * @author Andres Gonzalez\n   652→     */\n   653→    public function obtenerResumen(Request $request): array {\n   654→        $resumen = $this->repositorio->obtenerResumen($request);\n   655→        $alto    = 0;\n   656→        $normal  = 0;\n   657→        $bajo    = 0;\n   658→\n   659→        $ejecutivos_procesados = [];\n   660→        $planes                = [];\n   661→        $total_precio          = 0;\n   662→        $empresas_asignadas    = 0;\n   663→        $planes_agrupados      = [];\n   664→\n   665→        foreach ($resumen['empresasPlanes'] as $empresa_plan) {\n   666→            $consumo = $this->conteoConsumo($empresa_plan->id, $request);\n   667→\n   668→            if ($consumo > $empresa_plan->unidades) {\n   669→                $alto++;\n   670→            } elseif ($consumo == $empresa_plan->unidades) {\n   671→                $normal++;\n   672→            } else {\n   673→                $bajo++;\n   674→            }\n   675→        }\n   676→\n   677→        $resumen['consumo'] = [\n   678→            'alto'   => $alto,\n   679→            'normal' => $normal,\n   680→            'bajo'   => $bajo,\n   681→        ];\n   682→\n   683→        // Top ejecutivos\n   684→        foreach ($resumen['empresa_ejecutivo'] as $ejecutivo) {\n   685→            $empresas = $this->repositorio->getTodoAgrupadoPlan(new Request([\n   686→                'ejecutivo_id' => $ejecutivo->ejecutivo_id,\n   687→                'fecha_inicio' => $request->fecha_inicio,\n   688→                'fecha_fin'    => $request->fecha_fin,\n   689→            ]));\n   690→\n   691→            foreach ($empresas as $empresa) {\n   692→                foreach ($empresa['empresas_planes'] as $plan) {\n   693→                    $empresas_asignadas++;\n   694→                    $total_precio += $plan['precio'];\n   695→\n   696→                    $planes[] = [\n   697→                        'id'          => $plan['plan']['id'],\n   698→                        'nombre'      => $plan['plan']['nombre'],\n   699→                        'descripcion' => $plan['plan']['descripcion'],\n   700→                        'precio'      => $plan['precio'],\n   701→                        'conteo'      => null\n   702→                    ];\n   703→                }\n   704→            }\n   705→\n   706→            // Agrupa los planes por el id y suma su precio y conteo.\n   707→            foreach ($planes as $plan) {\n   708→                $plan_id = $plan['id'];\n   709→\n   710→                if (!isset($planes_agrupados[$plan_id])) {\n   711→                    $planes_agrupados[$plan_id]           = $plan;\n   712→                    $planes_agrupados[$plan_id]['conteo'] = 1;\n   713→                } else {\n   714→                    $planes_agrupados[$plan_id]['precio'] += $plan['precio'];\n   715→                    $planes_agrupados[$plan_id]['conteo'] += 1;\n   716→                }\n   717→            }\n   718→\n   719→            $planes = array_values($planes_agrupados);\n   720→\n   721→            // Ordena de mayor a menor precio.\n   722→            usort($planes, function ($primero, $segundo) {\n   723→                return $segundo['precio'] <=> $primero['precio'];\n   724→            });\n   725→\n   726→            if ($total_precio > 0) {\n   727→                $ejecutivos_procesados[] = [\n   728→                    'id_ejecutivo'       => $ejecutivo->ejecutivo_id,\n   729→                    'nombre'             => $ejecutivo->ejecutivo->nombre_completo,\n   730→                    'ventas_totales'     => $total_precio,\n   731→                    'empresas_asignadas' => $empresas_asignadas,\n   732→                    'planes'             => $planes,\n   733→                ];\n   734→            }\n   735→\n   736→            // Reiniciar variables.\n   737→            $empresas_asignadas = 0;\n   738→            $total_precio       = 0;\n   739→            $planes             = [];\n   740→            $planes_agrupados   = [];\n   741→        }\n   742→\n   743→        // Ordena de mayor a menor de ventas_totales.\n   744→        usort($ejecutivos_procesados, function ($primero, $segundo) {\n   745→            return $segundo['ventas_totales'] <=> $primero['ventas_totales'];\n   746→        });\n   747→\n   748→        $resumen['ejecutivos'] = $ejecutivos_procesados;\n   749→\n   750→        unset($resumen['empresasPlanes'], $resumen['empresa_ejecutivo']);\n   751→\n   752→        return $resumen;\n   753→    }\n   754→}\n   755→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5b9a59c5-9c27-4222-9742-bf723425170c","timestamp":"2026-01-21T19:45:40.951Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Illuminate\\Support\\Str;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\Response;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse App\\Exports\\Empresas\\HistorialCambiosExport;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\IA\\ServicioIARepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Planes\\ConsumoRepository;\nuse App\\Http\\Repositories\\Empresas\\SectorRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse Symfony\\Component\\HttpFoundation\\StreamedResponse;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse Symfony\\Component\\HttpFoundation\\{BinaryFileResponse};\nuse App\\Http\\Repositories\\Configuraciones\\CiudadRepository;\nuse App\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository;\nuse App\\Http\\Repositories\\Usuarios\\TipoDocumentoRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Politicas\\PoliticaAceptadaRepository;\nuse App\\Jobs\\Configuraciones\\CrearPlantillasPorDefectoEmpresaJob;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionModeloRepository;\n\n/**\n * @property EmpresaRepository $repositorio\n */\nclass EmpresaService extends BaseService\n{\n    use ArchivoTrait;\n\n    private $modelo = 'App\\Models\\Empresas\\Empresa';\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaRepository $repositorio Repositorio de empresas.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param PoliticaAceptadaRepository $politica_aceptada_repositorio Repositorio de políticas aceptadas.\n     * @param CiudadRepository $ciudad_repositorio Repositorio de ciudades.\n     * @param SectorRepository $sector_repositorio Repositorio de sectores.\n     * @param TamanoEmpresaRepository $tamano_empresa_repositorio Repositorio de tamaños de empresas.\n     * @param TipoDocumentoRepository $tipo_documento_repositorio Repositorio de tipos de documentos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param ConfiguracionRepository $configuracion_repositorio Repositorio de configuraciones.\n     * @param ConfiguracionModeloRepository $configuracion_modelo_repositorio Repositorio de configuraciones de modelos.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @param ConsumoRepository $consumo_repositorio Repositorio de consumos.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        EmpresaRepository $repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected PoliticaAceptadaRepository $politica_aceptada_repositorio,\n        protected CiudadRepository $ciudad_repositorio,\n        protected SectorRepository $sector_repositorio,\n        protected TamanoEmpresaRepository $tamano_empresa_repositorio,\n        protected TipoDocumentoRepository $tipo_documento_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected TipoPruebaRepository $tipo_prueba_repositorio,\n        protected EmpresaPlanRepository $empresa_plan_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected ConfiguracionRepository $configuracion_repositorio,\n        protected ConfiguracionModeloRepository $configuracion_modelo_repositorio,\n        protected EmpresaPlanService $empresa_plan_servicio,\n        protected ConsumoRepository $consumo_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected ServicioIARepository $servicio_ia_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Obtener una empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @return Empresa|null\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?Empresa {\n        $empresa = $this->repositorio->getUnoBasico($id);\n\n        if (!is_null($empresa)) {\n            $planes        = [];\n            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n                'empresa_id'         => $id,\n                'con_relaciones'     => true,\n                'validar_relaciones' => true,\n                'en'                 => true,\n                'campo'              => 'rol_id',\n                'valores'            => [\n                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n                    $this->rol_repositorio::ROL_EVALUADOR_ID\n                ]\n            ]));\n\n            $usuarios = $usuarios->map(function ($usuario) {\n                $eliminar = false;\n\n                if (\n                    !$usuario->usuario->tiene_agendas\n                    && !$usuario->usuario->tiene_ofertas_laborales\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_etapa_usuario\n                ) {\n                    $eliminar = true;\n                }\n\n                $usuario->usuario->eliminar = $eliminar;\n                return $usuario;\n            });\n\n            $empresa->planes                         = $planes;\n            $empresa->usuarios                       = $usuarios;\n            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n                'model_type' => $this->modelo,\n                'modelo_id'  => $id\n            ]));\n            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Obtener todas las empresas.\n     *\n     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     */\n    public function getTodo(Request $request): Collection {\n        $empresas      = $this->repositorio->getTodo($request);\n        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n        $coleccion     = [];\n\n        foreach ($empresas as $empresa) {\n            $registro = $empresa;\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n\n                // Obtener el plan activo, si no tiene se obtiene el último plan asignado\n                $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n\n                if (is_null($registro[$llave])) {\n                    $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(new Request([\n                        'empresa_id'             => $empresa->id,\n                        'tipo_prueba_id'         => $tipo_prueba->id,\n                        'excluir_estado_proximo' => true\n                    ]));\n                }\n\n                // Verificar si tiene un plan próximo adicional al plan actual\n                if (!is_null($registro[$llave])) {\n                    $plan_proximo                     = $this->empresa_plan_repositorio->planProximo($empresa->id, $tipo_prueba->id);\n                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n                }\n            }\n\n            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);\n        }\n\n        return collect($coleccion);\n    }\n\n    /**\n     * Obtener el porcentaje de creación.\n     *\n     * @param int $id ID de la empresa.\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function obtenerPorcentajeCreacion(int $id): int {\n        $empresa    = $this->repositorio->getUno($id);\n        $porcentaje = 0;\n\n        if (is_null($empresa)) {\n            return $porcentaje;\n        }\n\n        if (!is_null($empresa->empresa_id)) {\n            return $porcentaje;\n        }\n\n        $porcentaje += 10;\n\n        if (count($empresa->archivos) > 0) {\n            $porcentaje += 20;\n        }\n\n        if (count($empresa->usuarios) > 0) {\n            $porcentaje += 10;\n        }\n\n        if (count($empresa->planes) > 0) {\n            $porcentaje += 30;\n        }\n\n        if (count($empresa->usuarios) > 1) {\n            $porcentaje += 30;\n        }\n\n        return $porcentaje;\n    }\n\n    /**\n     * Guardar empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Cuando un usuario que no es superadministrador, intenta modificar una empresa diferente a la que está logueado.\n     * @return Empresa\n     * @author Daniel Beltrán\n     */\n    public function guardar(Request $request): Empresa {\n        $campos_excluidos = ['_token', '_method', 'id', 'pais_id', 'departamento_id', 'digito_verificacion', 'extension', 'extension_tesorero', 'logo', 'empresa_plan_id'];\n\n        if ($request->filled('digito_verificacion')) {\n            $request->merge(['documento' => $request->documento . '-' . $request->digito_verificacion]);\n        }\n\n        if ($request->filled('telefono') && $request->filled('extension')) {\n            $request->merge(['telefono' => $request->telefono . '-' . $request->extension]);\n        }\n\n        if ($request->filled('telefono_tesorero') && $request->filled('extension_tesorero')) {\n            $request->merge(['telefono_tesorero' => $request->telefono_tesorero . '-' . $request->extension_tesorero]);\n        }\n\n        // Agregar datos a la sucursal\n        if ($request->filled('empresa_id')) {\n            $empresa_principal = $this->repositorio->getUno($request->empresa_id);\n\n            if (!is_null($empresa_principal->empresa_id)) {\n                throw new Exception('No se puede crearse una sucursal de otra sucursal');\n            }\n\n            $request->merge([\n                'tamano_empresa_id' => $empresa_principal->tamano_empresa_id,\n                'razon_social'      => $empresa_principal->razon_social\n            ]);\n\n            unset($empresa_principal);\n        }\n\n        if ($request->filled('id')) {\n            $rol_usuario = $this->rol_repositorio->usuarioRolActivo(Auth::id());\n\n            // Validar que solo el superadministrador pueda editar cualquier empresa\n            if ($rol_usuario->id != RolRepository::ROL_SUPERADMIN_ID) {\n                $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n                if ($empresa_usuario->id != $request->empresa_id) {\n                    throw new Exception('No puedes editar una empresa diferente a la que estás logueado', Response::HTTP_FORBIDDEN);\n                }\n            }\n\n            $empresa = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $empresa = $this->repositorio->crear($request->except($campos_excluidos));\n            CrearPlantillasPorDefectoEmpresaJob::dispatch($empresa->id);\n        }\n\n        // Renovación el plan\n        if ($request->filled('empresa_plan_id')) {\n            $this->empresa_plan_servicio->renovar($request->empresa_plan_id);\n        }\n\n        // Guardar el logo de la sucursal\n        if ($request->filled('empresa_id') && $request->filled('logo')) {\n            $this->cambiarLogo($empresa->id, $request->logo);\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Guardar archivos de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function guardarArchivos(int $id, Request $request): void {\n        if ($request->filled('logo')) {\n            $this->cambiarLogo($id, $request->logo);\n        }\n\n        foreach ($request->files->all() as $nombre_archivo_empresa => $archivo_empresa) {\n            $archivo_existente = $this->archivo_repositorio->getUnoAvanzado(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id,\n                'nombre'    => $nombre_archivo_empresa\n            ]));\n\n            if (!is_null($archivo_existente)) {\n                $this->archivo_servicio->eliminarPorModelo($this->modelo, $id, $nombre_archivo_empresa);\n            }\n\n            $ruta = \"private/archivos/empresas/{$id}\";\n            $this->generarDirectorios(\"app/{$ruta}\");\n\n            $nombre_archivo = $this->generarNombreArchivo($archivo_empresa);\n            $this->guardarArchivoEnRuta($archivo_empresa, $ruta, $nombre_archivo);\n\n            $this->archivo_repositorio->crear([\n                'modelo'                  => $this->modelo,\n                'modelo_id'               => $id,\n                'nombre'                  => $nombre_archivo_empresa,\n                'nombre_original_archivo' => $nombre_archivo,\n                'ruta'                    => $ruta . '/' . $nombre_archivo\n            ]);\n        }\n    }\n\n    /**\n     * Eliminar empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa tiene algún registro asociado o está archivada.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function eliminar(int $id): void {\n        $empresa = $this->repositorio->getUnoAvanzado(new Request([\n            'id'                       => $id,\n            'contar_sucursales'        => true,\n            'contar_planes'            => true,\n            'contar_procesos'          => true,\n            'contar_areas'             => true,\n            'contar_perfiles'          => true,\n            'contar_agendas'           => true,\n            'contar_encuestas'         => true,\n            'contar_soportes'          => true,\n            'contar_usuarios'          => true,\n            'contar_ordenes_servicios' => true,\n            'contar_ofertas_laborales' => true,\n            'contar_portales_empleos'  => true\n        ]));\n\n        if ($empresa->activo) {\n            // Validar que no tenga planes\n            if ($empresa->planes_count > 0) {\n                throw new Exception('La empresa tiene planes asignados');\n            }\n\n            // Validar que no tenga sucursales\n            if ($empresa->sucursales_count > 0) {\n                throw new Exception('La empresa tiene sucursales asignadas');\n            }\n\n            // Validar que no tenga procesos\n            if ($empresa->procesos_count > 0) {\n                throw new Exception('La empresa tiene procesos asignados');\n            }\n\n            // Validar que no tenga áreas\n            if ($empresa->areas_count > 0) {\n                throw new Exception('La empresa tiene áreas asignadas');\n            }\n\n            // Validar que no tenga perfiles\n            if ($empresa->perfiles_count > 0) {\n                throw new Exception('La empresa tiene perfiles asignados');\n            }\n\n            // Validar que no tenga agendas\n            if ($empresa->agendas_count > 0) {\n                throw new Exception('La empresa tiene agendas asignadas');\n            }\n\n            // Validar que no tenga encuestas\n            if ($empresa->encuestas_count > 0) {\n                throw new Exception('La empresa tiene encuestas asignadas');\n            }\n\n            // Validar que no tenga soportes\n            if ($empresa->soportes_count > 0) {\n                throw new Exception('La empresa tiene soportes asignados');\n            }\n\n            // Validar que no tenga usuarios\n            if ($empresa->usuarios_count > 0) {\n                throw new Exception('La empresa tiene usuarios asignados');\n            }\n\n            // Validar que no tenga ordenes de servicio\n            if ($empresa->ordenes_servicios_count > 0) {\n                throw new Exception('La empresa tiene ordenes de servicio asignadas');\n            }\n\n            // Validar que no tenga ofertas laborales\n            if ($empresa->ofertas_laborales_count > 0) {\n                throw new Exception('La empresa tiene ofertas laborales asignadas');\n            }\n\n            // Validar que no tenga portales de empleo\n            if ($empresa->portal_empleo_count > 0) {\n                throw new Exception('La empresa tiene portales de empleo asignados');\n            }\n\n            $this->repositorio->sincronizarConfiguraciones($empresa, []);\n            $this->repositorio->eliminar($id);\n        } else {\n            throw new Exception('La empresa está archivada');\n        }\n    }\n\n    /**\n     * Eliminar los usuarios de la empresa junto con sus políticas aceptadas.\n     *\n     * @param Empresa $empresa Empresa.\n     * @param Collection $usuarios Usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function eliminarUsuarios(Empresa $empresa, Collection $usuarios): void {\n        if (count($usuarios) > 0) {\n            foreach ($usuarios as $usuario_empresa) {\n                // Disociar el usuario de la empresa\n                $this->repositorio->disociarUsuario($empresa, $usuario_empresa->id);\n\n                // Disociar las políticas aceptadas del usuario para la empresa\n                $this->politica_aceptada_repositorio->eliminarPorUsuarioYEmpresa($usuario_empresa->id, $empresa->id);\n\n                // Obtener todas las políticas aceptadas del usuario en otras empresas\n                $politicas_otras_empresas = $this->politica_aceptada_repositorio->obtenerPorUsuarioYEmpresasDiferentes($usuario_empresa->id, [$empresa->id]);\n\n                // Obtener los datos del usuario\n                $usuario = $this->usuario_repositorio->getUno($usuario_empresa->id);\n\n                // Validar si el usuario tiene más empresas asociadas y más políticas aceptadas de otras empresas\n                if (count($usuario->empresas) == 0 && count($politicas_otras_empresas) == 0) {\n                    $this->usuario_repositorio->eliminar($usuario_empresa->id);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener el historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return Collection\n     * @author Daniel Beltrán\n     */\n    public function historialCambios(int $id): Collection {\n        $historial       = $this->repositorio->historialCambios($id);\n        $historial_final = [];\n\n        // Obtener los datos referenciados a través de llaves foráneas\n        $ciudades         = $this->obtenerDatosReferenciados($historial, 'ciudad_id', 'ciudades_ids', $this->ciudad_repositorio);\n        $ejecutivos       = $this->obtenerDatosReferenciados($historial, 'ejecutivo_id', 'usuarios_ids', $this->usuario_repositorio);\n        $sectores         = $this->obtenerDatosReferenciados($historial, 'sector_id', 'sectores_ids', $this->sector_repositorio);\n        $tamanos_empresas = $this->obtenerDatosReferenciados($historial, 'tamano_empresa_id', 'tamanos_empresas_ids', $this->tamano_empresa_repositorio);\n        $tipos_documentos = $this->obtenerDatosReferenciados($historial, 'tipo_documento_representante_id', 'tipos_documentos_ids', $this->tipo_documento_repositorio);\n\n        foreach ($historial as $item) {\n            array_push($historial_final, [\n                'id'             => $item->id,\n                'user_type'      => $item->user_type,\n                'user_id'        => $item->user_id,\n                'event'          => $item->event,\n                'auditable_type' => $item->auditable_type,\n                'auditable_id'   => $item->auditable_id,\n                'created_at'     => $item->created_at,\n                'user'           => $item->user,\n                'old_values'     => $this->asignarCambiosHistorial($item->old_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos),\n                'new_values'     => $this->asignarCambiosHistorial($item->new_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos)\n            ]);\n        }\n\n        return collect($historial_final);\n    }\n\n    /**\n     * Asignar los cambios del historial.\n     *\n     * @param array $valores Valores del historial (pueden ser antigüos o nuevos).\n     * @param Collection $ciudades Ciudades.\n     * @param Collection $ejecutivos Ejecutivos.\n     * @param Collection $sectores Sectores.\n     * @param Collection $tamanos_empresas Tamaños de empresas.\n     * @param Collection $tipos_documentos Tipos de documentos.\n     * @return array\n     * @author Daniel Beltrán\n     */\n    private function asignarCambiosHistorial(\n        array $valores,\n        Collection $ciudades,\n        Collection $ejecutivos,\n        Collection $sectores,\n        Collection $tamanos_empresas,\n        Collection $tipos_documentos\n    ): array {\n        $valores_actualizados = [];\n\n        foreach ($valores as $llave => $valor) {\n            $valores_actualizados[$llave] = $valor;\n\n            if ($llave === 'ciudad_id') {\n                $ciudad                       = $ciudades->firstWhere('id', $valor);\n                $valores_actualizados[$llave] = $ciudad->nombre . ', ' . $ciudad->departamento->nombre . ' - ' . $ciudad->departamento->pais->nombre;\n            }\n\n            if ($llave === 'ejecutivo_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $ejecutivos->firstWhere('id', $valor)->nombre_completo : null;\n            }\n\n            if ($llave === 'sector_id') {\n                $valores_actualizados[$llave] = $sectores->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tamano_empresa_id') {\n                $valores_actualizados[$llave] = $tamanos_empresas->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tipo_documento_representante_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $tipos_documentos->firstWhere('id', $valor)->nombre : null;\n            }\n        }\n\n        return $valores_actualizados;\n    }\n\n    /**\n     * Obtener el logo de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa no tiene ningún logo.\n     * @return BinaryFileResponse|StreamedResponse\n     * @author Daniel Beltrán\n     */\n    public function getLogo(int $id): BinaryFileResponse|StreamedResponse {\n        $logo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n        abort_if(is_null($logo), 404, 'Esta empresa no tiene ningún logo');\n        return $this->obtenerArchivoDesdeRuta($logo->ruta);\n    }\n\n    /**\n     * Cambiar el logo de la empresa.\n     *\n     * Elimina el logo actual y guarda el nuevo.\n     *\n     * @param int $id ID de la empresa.\n     * @param string $logo Nuevo logo en base64.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function cambiarLogo(int $id, string $logo): void {\n        $archivo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n\n        if (!is_null($archivo)) {\n            $this->archivo_servicio->eliminar($archivo->id);\n        }\n\n        $this->archivo_servicio->guardarVariosBase64($this->modelo, $id, ['logo' => $logo], 'empresas');\n    }\n\n    /**\n     * Exportar Excel del historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return BinaryFileResponse|Response\n     * @author Daniel Beltrán\n     */\n    public function exportarExcelHistorialCambios(int $id): BinaryFileResponse|Response {\n        $datos = [\n            'historial_cambios' => $this->historialCambios($id),\n            'archivos'          => $this->archivo_repositorio->getTodo(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id\n            ]))\n        ];\n\n        return Excel::download(new HistorialCambiosExport($datos), 'historial-cambios.xlsx');\n    }\n\n    /**\n     * Obtiene el conteo dependiendo de id de empresas planes.\n     *\n     * @param int $empresa_plan_id Id de empresas planes.\n     * @param Request $request Contenido de la petición.\n     * @return int\n     * @author Andres Gonzalez\n     * @author Fahibram Cárcamo\n     */\n    public function conteoConsumo(int $empresa_plan_id, Request $request): int {\n        return $this->consumo_repositorio->getTodo(\n            new Request([\n                'empresa_plan_id' => $empresa_plan_id,\n                'fecha_inicio'    => $request->fecha_inicio,\n                'fecha_fin'       => $request->fecha_fin\n            ])\n        )\n        ->count();\n    }\n\n    /**\n     * Obtiene el resumen para el panel.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function obtenerResumen(Request $request): array {\n        $resumen = $this->repositorio->obtenerResumen($request);\n        $alto    = 0;\n        $normal  = 0;\n        $bajo    = 0;\n\n        $ejecutivos_procesados = [];\n        $planes                = [];\n        $total_precio          = 0;\n        $empresas_asignadas    = 0;\n        $planes_agrupados      = [];\n\n        foreach ($resumen['empresasPlanes'] as $empresa_plan) {\n            $consumo = $this->conteoConsumo($empresa_plan->id, $request);\n\n            if ($consumo > $empresa_plan->unidades) {\n                $alto++;\n            } elseif ($consumo == $empresa_plan->unidades) {\n                $normal++;\n            } else {\n                $bajo++;\n            }\n        }\n\n        $resumen['consumo'] = [\n            'alto'   => $alto,\n            'normal' => $normal,\n            'bajo'   => $bajo,\n        ];\n\n        // Top ejecutivos\n        foreach ($resumen['empresa_ejecutivo'] as $ejecutivo) {\n            $empresas = $this->repositorio->getTodoAgrupadoPlan(new Request([\n                'ejecutivo_id' => $ejecutivo->ejecutivo_id,\n                'fecha_inicio' => $request->fecha_inicio,\n                'fecha_fin'    => $request->fecha_fin,\n            ]));\n\n            foreach ($empresas as $empresa) {\n                foreach ($empresa['empresas_planes'] as $plan) {\n                    $empresas_asignadas++;\n                    $total_precio += $plan['precio'];\n\n                    $planes[] = [\n                        'id'          => $plan['plan']['id'],\n                        'nombre'      => $plan['plan']['nombre'],\n                        'descripcion' => $plan['plan']['descripcion'],\n                        'precio'      => $plan['precio'],\n                        'conteo'      => null\n                    ];\n                }\n            }\n\n            // Agrupa los planes por el id y suma su precio y conteo.\n            foreach ($planes as $plan) {\n                $plan_id = $plan['id'];\n\n                if (!isset($planes_agrupados[$plan_id])) {\n                    $planes_agrupados[$plan_id]           = $plan;\n                    $planes_agrupados[$plan_id]['conteo'] = 1;\n                } else {\n                    $planes_agrupados[$plan_id]['precio'] += $plan['precio'];\n                    $planes_agrupados[$plan_id]['conteo'] += 1;\n                }\n            }\n\n            $planes = array_values($planes_agrupados);\n\n            // Ordena de mayor a menor precio.\n            usort($planes, function ($primero, $segundo) {\n                return $segundo['precio'] <=> $primero['precio'];\n            });\n\n            if ($total_precio > 0) {\n                $ejecutivos_procesados[] = [\n                    'id_ejecutivo'       => $ejecutivo->ejecutivo_id,\n                    'nombre'             => $ejecutivo->ejecutivo->nombre_completo,\n                    'ventas_totales'     => $total_precio,\n                    'empresas_asignadas' => $empresas_asignadas,\n                    'planes'             => $planes,\n                ];\n            }\n\n            // Reiniciar variables.\n            $empresas_asignadas = 0;\n            $total_precio       = 0;\n            $planes             = [];\n            $planes_agrupados   = [];\n        }\n\n        // Ordena de mayor a menor de ventas_totales.\n        usort($ejecutivos_procesados, function ($primero, $segundo) {\n            return $segundo['ventas_totales'] <=> $primero['ventas_totales'];\n        });\n\n        $resumen['ejecutivos'] = $ejecutivos_procesados;\n\n        unset($resumen['empresasPlanes'], $resumen['empresa_ejecutivo']);\n\n        return $resumen;\n    }\n}\n","numLines":755,"startLine":1,"totalLines":755}},"sourceToolAssistantUUID":"c44976e3-07e8-4e99-80db-5ac0305d6faf"}
{"parentUuid":"5b9a59c5-9c27-4222-9742-bf723425170c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_0186QzABULcMr7Dgf8oWwwwS","type":"message","role":"assistant","content":[{"type":"text","text":"## Análisis del método `getTodo`\n\nEl método `getTodo` (líneas 175-209) obtiene todas las empresas con información enriquecida sobre sus planes. Aquí está el análisis:\n\n### Propósito\nObtiene todas las empresas y les agrega información de planes por cada tipo de prueba, excluyendo planes en estado \"próximo\".\n\n### Flujo del método\n\n```php\npublic function getTodo(Request $request): Collection {\n    $empresas      = $this->repositorio->getTodo($request);      // 1. Obtiene empresas del repositorio\n    $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());  // 2. Obtiene tipos de prueba\n    $coleccion     = [];\n\n    foreach ($empresas as $empresa) {                            // 3. Itera cada empresa\n        $registro = $empresa;\n\n        foreach ($tipos_pruebas as $tipo_prueba) {               // 4. Por cada tipo de prueba\n            $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n\n            // 5. Busca plan activo, si no existe busca el último asignado\n            $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n\n            if (is_null($registro[$llave])) {\n                $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(...);\n            }\n\n            // 6. Verifica si hay plan próximo adicional\n            if (!is_null($registro[$llave])) {\n                $plan_proximo = $this->empresa_plan_repositorio->planProximo(...);\n                $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && ...;\n            }\n        }\n\n        $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n        array_push($coleccion, $registro);\n    }\n\n    return collect($coleccion);\n}\n```\n\n### Observaciones y posibles mejoras\n\n| Aspecto | Observación |\n|---------|-------------|\n| **Problema N+1** | Hay múltiples consultas dentro de loops anidados (`planActivo`, `ultimoPlanAsignado`, `planProximo`, `obtenerPorcentajeCreacion`). Con muchas empresas y tipos de prueba, esto puede ser costoso. |\n| **Duplicación de lógica** | La lógica de obtener plan activo o último asignado se repite en `getUno` (líneas 111-117). Podría extraerse a un método privado. |\n| **Transformación de datos** | Se usa un array intermedio y luego `collect()`. Podría usarse `$empresas->map()` directamente. |\n| **Tipos de prueba en cada iteración** | Se obtienen los tipos de prueba una vez fuera del loop, lo cual es correcto. |\n\n### Sugerencia de optimización\n\n```php\npublic function getTodo(Request $request): Collection {\n    $empresas      = $this->repositorio->getTodo($request);\n    $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n    return $empresas->map(function ($empresa) use ($tipos_pruebas) {\n        foreach ($tipos_pruebas as $tipo_prueba) {\n            $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n            $empresa[$llave] = $this->obtenerPlanParaEmpresa($empresa->id, $tipo_prueba->id);\n        }\n        \n        $empresa['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n        return $empresa;\n    });\n}\n```\n\n¿Quieres que profundice en algún aspecto específico o implemente alguna mejora?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":11253,"cache_read_input_tokens":25088,"cache_creation":{"ephemeral_5m_input_tokens":11253,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXM6eb1wCeNDi112Pjqv5","type":"assistant","uuid":"6729c7e6-e729-46c3-b42a-61b6c8db7a49","timestamp":"2026-01-21T19:45:56.482Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-21T19:54:27.208Z","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b"}
{"type":"file-history-snapshot","messageId":"acdc929c-42a9-4545-9dbe-c95af0d9daf7","snapshot":{"messageId":"acdc929c-42a9-4545-9dbe-c95af0d9daf7","trackedFileBackups":{},"timestamp":"2026-01-21T19:54:28.082Z"},"isSnapshotUpdate":false}
{"parentUuid":"c44976e3-07e8-4e99-80db-5ac0305d6faf","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_015PwcKHvYDed1dK44U7BFry","parentToolUseID":"toolu_015PwcKHvYDed1dK44U7BFry","uuid":"9b24b1ce-406e-4a44-949b-689fc9d377f6","timestamp":"2026-01-21T19:45:39.376Z"}
{"parentUuid":"6729c7e6-e729-46c3-b42a-61b6c8db7a49","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 183 to 184 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php:\nforeach ($tipos_pruebas as $tipo_prueba) {\n                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"mira comoaqui se estan gregando data con los tipos de pruebas foreach ($tipos_pruebas as $tipo_prueba) {\n                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_'); quiero agregar otro que diga plan_creditos ba ha utilizar esta funcionpublic function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array { de app\\Http\\Services\\Empresas\\EmpresaPlanService.php y eso debulves esto \"empresa_id\": 2,\n    \"empresa_plan_id\": 2,\n    \"creditos_plan\": 300,\n    \"creditos_disponibles\": 300,\n    \"plan_credito\": {\n      \"id\": 3,\n      \"nombre\": \"Plan 300\",\n      \"creditos\": 300,\n      \"precio\": \"300.00\"\n    } entonces quie motrar eso \"empresa_id\": 2,\n    \"empresa_plan_id\": 2,\n    \"creditos_plan\": 300,\n    \"creditos_disponibles\": 300,\n    \"plan_credito\": {\n      \"id\": 3,\n      \"nombre\": \"Plan 300\",\n      \"creditos\": 300,\n      \"precio\": \"300.00\"\n    } pero si \"plan_credito\" es null entonces que solo muestre estoasi plan_credito :null"}]},"uuid":"acdc929c-42a9-4545-9dbe-c95af0d9daf7","timestamp":"2026-01-21T19:54:28.078Z"}
{"parentUuid":"acdc929c-42a9-4545-9dbe-c95af0d9daf7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FzULNXWuaJm2PH6fNLZmG9","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo, quieres agregar un campo `plan_creditos` que use el método `creditosDisponiblesEmpresa` del `EmpresaPlanService`. Primero déjame verificar ese método."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":37799,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":37799,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXM7KTmxJ1MhS3LsdCRCA","type":"assistant","uuid":"46b8ff2f-9f10-47cc-b6c6-126bdd3a7e47","timestamp":"2026-01-21T19:54:31.750Z"}
{"parentUuid":"46b8ff2f-9f10-47cc-b6c6-126bdd3a7e47","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FzULNXWuaJm2PH6fNLZmG9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UxLNX6eect5Lay2GkqMFHG","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":37799,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":37799,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXM7KTmxJ1MhS3LsdCRCA","type":"assistant","uuid":"b30c8a01-827a-451d-b25c-94bda5d1fae7","timestamp":"2026-01-21T19:54:32.345Z"}
{"parentUuid":"b30c8a01-827a-451d-b25c-94bda5d1fae7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UxLNX6eect5Lay2GkqMFHG","type":"tool_result","content":"     1→<?php\n     2→\n     3→namespace App\\Http\\Services\\Empresas;\n     4→\n     5→use Exception;\n     6→use Carbon\\Carbon;\n     7→use Illuminate\\Support\\Arr;\n     8→use App\\Traits\\ArchivoTrait;\n     9→use Illuminate\\Http\\Request;\n    10→use App\\Mail\\CrearUsuarioMail;\n    11→use Illuminate\\Http\\UploadedFile;\n    12→use App\\Http\\Services\\BaseService;\n    13→use Illuminate\\Support\\Collection;\n    14→use App\\Models\\Empresas\\EmpresaPlan;\n    15→use App\\Models\\Pruebas\\TipoPrueba;\n    16→use Illuminate\\Support\\Facades\\Notification;\n    17→use App\\Http\\Repositories\\Planes\\PlanRepository;\n    18→use Illuminate\\Support\\Facades\\{Mail, Password};\n    19→use App\\Http\\Repositories\\Permisos\\RolRepository;\n    20→use App\\Http\\Repositories\\Usuarios\\UserRepository;\n    21→use App\\Http\\Repositories\\Empresas\\EmpresaRepository;\n    22→use App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\n    23→use App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\n    24→use App\\Notifications\\SolicitudRenovacionPlanNotification;\n    25→use App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\n    26→use Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n    27→\n    28→/**\n    29→ * @property EmpresaPlanRepository $repositorio\n    30→ */\n    31→class EmpresaPlanService extends BaseService\n    32→{\n    33→    use ArchivoTrait;\n    34→\n    35→    /**\n    36→     * Constructor.\n    37→     *\n    38→     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n    39→     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n    40→     * @param RolRepository $rol_repositorio Repositorio de roles.\n    41→     * @param PlanRepository $plan_repositorio Repositorio de planes.\n    42→     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n    43→     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    44→     * @return void\n    45→     * @author Daniel Beltrán\n    46→     */\n    47→    public function __construct(\n    48→        EmpresaPlanRepository $repositorio,\n    49→        protected EmpresaRepository $empresa_repositorio,\n    50→        protected RolRepository $rol_repositorio,\n    51→        protected PlanRepository $plan_repositorio,\n    52→        protected PlanCreditoRepository $plan_credito_repositorio,\n    53→        protected ArchivoRepository $archivo_repositorio,\n    54→        protected UserRepository $usuario_repositorio\n    55→    ) {\n    56→        parent::__construct($repositorio);\n    57→    }\n    58→\n    59→    /**\n    60→     * Guardar un plan de empresa.\n    61→     *\n    62→     * @param Request $request Contenido de la petición.\n    63→     * @return EmpresaPlan\n    64→     * @author Sergio Vargas\n    65→     * @author Daniel Beltrán\n    66→     * @author Andres Morales\n    67→     * @author Jair Carvajal\n    68→     * @author Andres Gonzalez\n    69→     */\n    70→    public function guardar(Request $request): EmpresaPlan {\n    71→        $bandera_enviar_correo = false;\n    72→        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n    73→        $plan                  = $this->plan_repositorio->getUno($request->plan_id);\n    74→        $plan_activo           = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n    75→        $vigencia              = $plan->vigencia;\n    76→\n    77→        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n    78→            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n    79→\n    80→            if ($plan_credito) {\n    81→                $request->merge(['creditos' => $plan_credito->creditos]);\n    82→            }\n    83→        } elseif (!$request->filled('plan_credito_id')) {\n    84→            $request->merge([\n    85→                'plan_credito_id' => null,\n    86→                'creditos'        => 0\n    87→            ]);\n    88→        }\n    89→\n    90→        if ($request->filled('vigencia')) {\n    91→            $vigencia = $request->vigencia;\n    92→        }\n    93→\n    94→        if (!is_null($plan_activo)) {\n    95→            if ($request->filled('id')) {\n    96→                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n    97→                if ($request->id === $plan_activo->id) {\n    98→                    goto omitir_calcular_vigencia;\n    99→                }\n   100→\n   101→                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n   102→                if ($vigencia == $request->vigencia) {\n   103→                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n   104→                    goto omitir_calcular_vigencia;\n   105→                }\n   106→            }\n   107→\n   108→            // Poner el nuevo plan como próximo\n   109→            $request->merge(['estado_id' => 3]);\n   110→\n   111→            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n   112→            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n   113→                // Agregar las nuevas fechas al nuevo plan\n   114→                $hoy          = now();\n   115→                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n   116→                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n   117→            }\n   118→        } else {\n   119→            $request->merge(['estado_id' => 1]);\n   120→\n   121→            // Validar si el plan seleccionado tiene vigencia\n   122→            if (!is_null($plan->vigencia)) {\n   123→                $request->merge($this->calcularFechasVigencia($vigencia));\n   124→            }\n   125→        }\n   126→\n   127→        omitir_calcular_vigencia:\n   128→\n   129→        if (!$request->filled('unidades')) {\n   130→            $request->merge(['unidades' => $plan->unidades]);\n   131→        } elseif ($request->unidades != $plan->unidades) {\n   132→            $request->merge(['plan_original' => false]);\n   133→        }\n   134→\n   135→        if (!$request->filled('cantidad_ofertas_laborales')) {\n   136→            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n   137→        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n   138→            $request->merge(['plan_original' => false]);\n   139→        }\n   140→\n   141→        if (!$request->filled('cantidad_usuarios')) {\n   142→            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n   143→        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n   144→            $request->merge(['plan_original' => false]);\n   145→        }\n   146→\n   147→        if (!$request->filled('cantidad_pruebas')) {\n   148→            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n   149→        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n   150→            $request->merge(['plan_original' => false]);\n   151→        }\n   152→\n   153→        // Comprobar si se modificaron las funcionalidades respecto al plan original\n   154→        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n   155→            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n   156→            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n   157→            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n   158→\n   159→            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n   160→                $request->merge(['plan_original' => false]);\n   161→            }\n   162→        }\n   163→\n   164→        if ($request->filled('id')) {\n   165→            // Eliminar la factura actual\n   166→            if ($request->hasFile('factura')) {\n   167→                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n   168→\n   169→                if (!is_null($archivo)) {\n   170→                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n   171→                    $this->archivo_repositorio->eliminar($archivo->id);\n   172→                }\n   173→            }\n   174→\n   175→            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   176→        } else {\n   177→            $bandera_enviar_correo = true;\n   178→            $request->merge(['usuario_id' => auth()->user()->id]);\n   179→            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n   180→        }\n   181→\n   182→        if ($request->filled('pruebas')) {\n   183→            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n   184→        }\n   185→\n   186→        if ($request->filled('funcionalidades')) {\n   187→            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n   188→        }\n   189→\n   190→        // Guardar la factura\n   191→        if ($request->hasFile('factura')) {\n   192→            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n   193→        }\n   194→\n   195→        if ($bandera_enviar_correo) {\n   196→            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n   197→            $usuario      = $empresa->usuarios[0];\n   198→            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n   199→\n   200→            $titulo = 'Usuario principal de la empresa creado';\n   201→            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n   202→        }\n   203→\n   204→        return $plan_asignado;\n   205→    }\n   206→\n   207→    /**\n   208→     * Renovar el plan asignado.\n   209→     *\n   210→     * @param int $id ID del plan de la empresa que se quiere renovar.\n   211→     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n   212→     * @return EmpresaPlan Plan de la empresa renovado.\n   213→     * @author Daniel Beltrán\n   214→     */\n   215→    public function renovar(int $id): EmpresaPlan {\n   216→        $empresa_plan = $this->repositorio->getUno($id);\n   217→\n   218→        if ($empresa_plan->estado_id === 3) {\n   219→            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n   220→        }\n   221→\n   222→        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n   223→        $request->merge(['por_facturar' => true]);\n   224→\n   225→        if (in_array($empresa_plan->estado_id, [1, 4])) {\n   226→            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n   227→            $request->merge(['estado_id' => 3]);\n   228→        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n   229→            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n   230→            $request->merge(['estado_id' => 1]);\n   231→        }\n   232→\n   233→        $this->verificarYAsignarTiempo($empresa_plan, $request);\n   234→        $plan_renovado = $this->repositorio->crear($request->toArray());\n   235→\n   236→        if ($request->filled('pruebas')) {\n   237→            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n   238→        }\n   239→\n   240→        if ($request->filled('funcionalidades')) {\n   241→            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n   242→        }\n   243→\n   244→        return $plan_renovado;\n   245→    }\n   246→\n   247→    /**\n   248→     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n   249→     *\n   250→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   251→     * @param Request $request Contenido de la petición.\n   252→     * @return void\n   253→     * @author Daniel Beltrán\n   254→     */\n   255→    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n   256→        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n   257→            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n   258→        }\n   259→    }\n   260→\n   261→    /**\n   262→     * Calcular las fechas en las que el plan estará vigente.\n   263→     *\n   264→     * @param int $vigencia Cantidad de días de vigencia.\n   265→     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n   266→     * @return array Fechas de inicio y vencimiento.\n   267→     * @author Daniel Beltrán\n   268→     */\n   269→    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n   270→        $hoy          = now();\n   271→        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n   272→\n   273→        // Si es múltiplo de 3, entonces la vigencia es en meses\n   274→        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n   275→            $meses             = $vigencia / 30;\n   276→            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n   277→\n   278→            if ($fecha_inicio->day === 1) {\n   279→                $fecha_vencimiento->subDay();\n   280→            }\n   281→        } else {\n   282→            $vigencia          = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n   283→            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n   284→        }\n   285→\n   286→        return [\n   287→            'fecha_inicio'      => $fecha_inicio->format('Y-m-d'),\n   288→            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n   289→        ];\n   290→    }\n   291→\n   292→    /**\n   293→     * Facturar un plan de empresa.\n   294→     *\n   295→     * @param int $id ID del plan de empresa.\n   296→     * @param Request $request Contenido de la petición.\n   297→     * @return EmpresaPlan\n   298→     * @author Daniel Beltrán\n   299→     */\n   300→    public function facturar(int $id, Request $request): EmpresaPlan {\n   301→        $empresa_plan = $this->repositorio->getUno($id);\n   302→\n   303→        if ($request->filled('vigencia')) {\n   304→            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n   305→        }\n   306→\n   307→        $request->merge(['por_facturar' => false]);\n   308→\n   309→        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n   310→        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n   311→\n   312→        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n   313→        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n   314→    }\n   315→\n   316→    /**\n   317→     * Guardar factura.\n   318→     *\n   319→     * @param int $id ID del plan de empresa.\n   320→     * @param int $empresa_id ID de la empresa.\n   321→     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n   322→     * @return void\n   323→     * @author Daniel Beltrán\n   324→     */\n   325→    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n   326→        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n   327→        $this->generarDirectorios(\"app/{$ruta}\");\n   328→        $nombre_archivo = $this->generarNombreArchivo($archivo);\n   329→        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n   330→\n   331→        $this->archivo_repositorio->crear([\n   332→            'modelo'    => 'App\\Models\\Empresas\\EmpresaPlan',\n   333→            'modelo_id' => $id,\n   334→            'nombre'    => 'factura',\n   335→            'ruta'      => $ruta . '/' . $nombre_archivo\n   336→        ]);\n   337→    }\n   338→\n   339→    /**\n   340→     * Obtener el historial de recompras de una empresa por tipo de prueba.\n   341→     *\n   342→     * @param Request $request Contenido de la petición HTTP entrante.\n   343→     * @return Collection\n   344→     * @author Daniel Beltrán\n   345→     * @author Fahibram Cárcamo\n   346→     * @author Andres Morales\n   347→     * @author Andres Gonzalez\n   348→     */\n   349→    public function historialRecompras(Request $request): Collection {\n   350→        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n   351→        $request->merge([\n   352→            'con_conteo_consumos_agendas'           => true,\n   353→            'con_conteo_consumos_ofertas_laborales' => true\n   354→        ]);\n   355→\n   356→        return match ($rol_usuario->id) {\n   357→            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n   358→            RolRepository::ROL_PROPIETARIO_ID,\n   359→            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n   360→            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n   361→            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n   362→        };\n   363→    }\n   364→\n   365→    /**\n   366→     * Obtener el historial de compras de planes con creditos para una empresa.\n   367→     *\n   368→     * @param int $empresa_id ID de la empresa.\n   369→     * @param Request $request Contenido de la peticion.\n   370→     * @return Collection\n   371→     * @author Sergio Vargas\n   372→     */\n   373→    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n   374→        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n   375→\n   376→        return $historial->map(function (EmpresaPlan $plan) {\n   377→            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n   378→            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n   379→\n   380→            $plan->creditos_totales = $total_creditos;\n   381→            $plan->creditos_consumidos = $creditos_consumidos;\n   382→            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n   383→\n   384→            return $plan;\n   385→        });\n   386→    }\n   387→\n   388→    /**\n   389→     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n   390→     *\n   391→     * @param int $empresa_id ID de la empresa.\n   392→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   393→     * @return ?EmpresaPlan\n   394→     * @author Daniel Beltrán\n   395→     */\n   396→    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   397→        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n   398→            'empresa_id'             => $empresa_id,\n   399→            'tipo_prueba_id'         => $tipo_prueba_id,\n   400→            'excluir_estado_proximo' => true\n   401→        ]));\n   402→\n   403→        if (!is_null($plan)) {\n   404→            $plan_proximo       = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n   405→            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n   406→        }\n   407→\n   408→        return $plan;\n   409→    }\n   410→\n   411→    /**\n   412→     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n   413→     *\n   414→     * @param int $id ID del plan de empresa.\n   415→     * @return ?EmpresaPlan\n   416→     * @author Daniel Beltrán\n   417→     */\n   418→    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n   419→        $plan               = $this->repositorio->getUno($id);\n   420→        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n   421→        return $plan;\n   422→    }\n   423→\n   424→    /**\n   425→     * Obtener el plan activo de la empresa por tipo de prueba.\n   426→     *\n   427→     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n   428→     * La propiedad se llama 'plan_proximo' y es un booleano.\n   429→     *\n   430→     * @param int $empresa_id ID de la empresa.\n   431→     * @param int $tipo_prueba_id ID del tipo de prueba.\n   432→     * @return ?EmpresaPlan\n   433→     * @author Daniel Beltrán\n   434→     */\n   435→    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n   436→        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   437→\n   438→        if (!is_null($plan)) {\n   439→            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n   440→        }\n   441→\n   442→        return $plan;\n   443→    }\n   444→\n   445→    /**\n   446→     * Solicitar la renovación de un plan específico de una empresa específica.\n   447→     *\n   448→     * @param Request $request Solicitud HTTP.\n   449→     * @return void\n   450→     * @author Fahibram Cárcamo\n   451→     */\n   452→    public function solicitarRenovacionPlan(Request $request) {\n   453→        $plan                = $this->plan_repositorio->getUno($request->plan_id);\n   454→        $empresa             = $this->empresa_repositorio->getUno($request->empresa_id);\n   455→        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n   456→\n   457→        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   458→            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n   459→            'con_roles_ids' => true\n   460→        ]));\n   461→\n   462→        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n   463→            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n   464→            'empresa_id'    => $request->empresa_id,\n   465→            'con_roles_ids' => true\n   466→        ]));\n   467→\n   468→        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n   469→\n   470→        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n   471→    }\n   472→\n   473→    /**\n   474→     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n   475→     *\n   476→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   477→     * @return bool\n   478→     * @author Daniel Beltrán\n   479→     * @author Fahibram Cárcamo\n   480→     */\n   481→    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n   482→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   483→            return true;\n   484→        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n   485→            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n   486→                return true;\n   487→            }\n   488→        }\n   489→\n   490→        return false;\n   491→    }\n   492→\n   493→    /**\n   494→     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n   495→     *\n   496→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   497→     * @return bool\n   498→     * @author Daniel Beltrán\n   499→     * @author Fahibram Cárcamo\n   500→     */\n   501→    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   502→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n   503→            return true;\n   504→        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n   505→            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n   506→                return true;\n   507→            }\n   508→        }\n   509→\n   510→        return false;\n   511→    }\n   512→\n   513→    /**\n   514→     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n   515→     *\n   516→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   517→     * @return bool\n   518→     * @author Fahibram Cárcamo\n   519→     */\n   520→    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n   521→        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n   522→    }\n   523→\n   524→    /**\n   525→     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n   526→     *\n   527→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   528→     * @return bool\n   529→     * @author Fahibram Cárcamo\n   530→     */\n   531→    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n   532→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n   533→    }\n   534→\n   535→    /**\n   536→     * Verificar que la fecha de vencimiento del plan no haya pasado.\n   537→     *\n   538→     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n   539→     * @return bool\n   540→     * @author Andres Gonzalez\n   541→     */\n   542→    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n   543→        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n   544→            return true;\n   545→        }\n   546→\n   547→        return false;\n   548→    }\n   549→\n   550→    /**\n   551→     * Verificar que el plan tenga vacantes disponibles.\n   552→     *\n   553→     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n   554→     * @return bool\n   555→     * @author Andres Gonzalez\n   556→     */\n   557→    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n   558→        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n   559→    }\n   560→\n   561→    /**\n   562→     * Obtener creditos disponibles para un plan de empresa.\n   563→     *\n   564→     * @param int $empresa_plan_id ID del plan de empresa.\n   565→     * @return int\n   566→     * @author Sergio Vargas\n   567→     * @author Daniel Beltrán\n   568→     */\n   569→    public function creditosDisponibles(int $empresa_plan_id): int {\n   570→        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n   571→        return $empresa_plan?->creditos_restantes ?? 0;\n   572→    }\n   573→\n   574→    /**\n   575→     * Obtener creditos disponibles y plan asignado de una empresa.\n   576→     *\n   577→     * @param int $empresa_id ID de la empresa.\n   578→     * @param Request $request Contenido de la peticion.\n   579→     * @return array|null\n   580→     * @author Sergio Vargas\n   581→     */\n   582→    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n   583→        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n   584→            ? (int) $request->tipo_prueba_id\n   585→            : TipoPrueba::SELECCION_ID;\n   586→\n   587→        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n   588→\n   589→        if (!$empresa_plan) {\n   590→            return null;\n   591→        }\n   592→\n   593→        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n   594→\n   595→        return [\n   596→            'empresa_id'           => $empresa_id,\n   597→            'empresa_plan_id'      => $empresa_plan->id,\n   598→            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n   599→            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n   600→            'plan_credito'         => $empresa_plan->planCredito ? [\n   601→                'id'       => $empresa_plan->planCredito->id,\n   602→                'nombre'   => $empresa_plan->planCredito->nombre,\n   603→                'creditos' => $empresa_plan->planCredito->creditos,\n   604→                'precio'   => $empresa_plan->planCredito->precio\n   605→            ] : null\n   606→        ];\n   607→    }\n   608→\n   609→    /**\n   610→     * Validar si hay creditos suficientes.\n   611→     *\n   612→     * @param int $empresa_plan_id ID del plan de empresa.\n   613→     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n   614→     * @return bool\n   615→     * @author Sergio Vargas\n   616→     * @author Daniel Beltrán\n   617→     */\n   618→    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n   619→        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n   620→    }\n   621→}\n   622→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"adfc42ca-ce05-4561-b21c-f12f499d401b","timestamp":"2026-01-21T19:54:33.775Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaPlanService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse Illuminate\\Support\\Arr;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse App\\Mail\\CrearUsuarioMail;\nuse Illuminate\\Http\\UploadedFile;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Empresas\\EmpresaPlan;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Facades\\Notification;\nuse App\\Http\\Repositories\\Planes\\PlanRepository;\nuse Illuminate\\Support\\Facades\\{Mail, Password};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Repositories\\Planes\\PlanCreditoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Notifications\\SolicitudRenovacionPlanNotification;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse Symfony\\Component\\HttpFoundation\\File\\UploadedFile as SymfonyUploadedFile;\n\n/**\n * @property EmpresaPlanRepository $repositorio\n */\nclass EmpresaPlanService extends BaseService\n{\n    use ArchivoTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param PlanRepository $plan_repositorio Repositorio de planes.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function __construct(\n        EmpresaPlanRepository $repositorio,\n        protected EmpresaRepository $empresa_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected PlanRepository $plan_repositorio,\n        protected PlanCreditoRepository $plan_credito_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected UserRepository $usuario_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar un plan de empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     * @author Andres Morales\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): EmpresaPlan {\n        $bandera_enviar_correo = false;\n        $campos_excluidos      = ['_token', '_method', 'id', 'tipo_prueba_id', 'factura', 'vigencia', 'pruebas', 'funcionalidades'];\n        $plan                  = $this->plan_repositorio->getUno($request->plan_id);\n        $plan_activo           = $this->repositorio->planActivo($request->empresa_id, $request->tipo_prueba_id);\n        $vigencia              = $plan->vigencia;\n\n        if ($request->filled('plan_credito_id') && !$request->filled('creditos')) {\n            $plan_credito = $this->plan_credito_repositorio->getUno($request->plan_credito_id);\n\n            if ($plan_credito) {\n                $request->merge(['creditos' => $plan_credito->creditos]);\n            }\n        } elseif (!$request->filled('plan_credito_id')) {\n            $request->merge([\n                'plan_credito_id' => null,\n                'creditos'        => 0\n            ]);\n        }\n\n        if ($request->filled('vigencia')) {\n            $vigencia = $request->vigencia;\n        }\n\n        if (!is_null($plan_activo)) {\n            if ($request->filled('id')) {\n                // Si el ID recibido es igual al plan activo, no se calcula vigencia\n                if ($request->id === $plan_activo->id) {\n                    goto omitir_calcular_vigencia;\n                }\n\n                // Si la vigencia no ha sido modificada respecto al plan base, no se calcula vigencia\n                if ($vigencia == $request->vigencia) {\n                    array_push($campos_excluidos, 'fecha_inicio', 'fecha_vencimiento');\n                    goto omitir_calcular_vigencia;\n                }\n            }\n\n            // Poner el nuevo plan como próximo\n            $request->merge(['estado_id' => 3]);\n\n            // Validar si el plan activo tiene fecha de vencimiento y el plan seleccionado tiene vigencia\n            if (!is_null($plan_activo->fecha_vencimiento) && !is_null($plan->vigencia)) {\n                // Agregar las nuevas fechas al nuevo plan\n                $hoy          = now();\n                $fecha_inicio = ($hoy > $plan_activo->fecha_vencimiento) ? $hoy->copy() : Carbon::createFromDate($plan_activo->fecha_vencimiento)->addDay();\n                $request->merge($this->calcularFechasVigencia($vigencia, $fecha_inicio));\n            }\n        } else {\n            $request->merge(['estado_id' => 1]);\n\n            // Validar si el plan seleccionado tiene vigencia\n            if (!is_null($plan->vigencia)) {\n                $request->merge($this->calcularFechasVigencia($vigencia));\n            }\n        }\n\n        omitir_calcular_vigencia:\n\n        if (!$request->filled('unidades')) {\n            $request->merge(['unidades' => $plan->unidades]);\n        } elseif ($request->unidades != $plan->unidades) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_ofertas_laborales')) {\n            $request->merge(['cantidad_ofertas_laborales' => $plan->cantidad_ofertas_laborales]);\n        } elseif ($request->cantidad_ofertas_laborales != $plan->cantidad_ofertas_laborales) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_usuarios')) {\n            $request->merge(['cantidad_usuarios' => $plan->cantidad_usuarios]);\n        } elseif ($request->cantidad_usuarios != $plan->cantidad_usuarios) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        if (!$request->filled('cantidad_pruebas')) {\n            $request->merge(['cantidad_pruebas' => $plan->cantidad_pruebas]);\n        } elseif ($request->cantidad_pruebas != $plan->cantidad_pruebas) {\n            $request->merge(['plan_original' => false]);\n        }\n\n        // Comprobar si se modificaron las funcionalidades respecto al plan original\n        if (!is_null($plan->funcionalidades) && $request->filled('funcionalidades')) {\n            $funcionalidades_originales = $plan->funcionalidades->pluck('id')->toArray();\n            $primera_comparacion        = array_diff($request->funcionalidades, $funcionalidades_originales);\n            $segunda_comparacion        = array_diff($funcionalidades_originales, $request->funcionalidades);\n\n            if (count([...$primera_comparacion, ...$segunda_comparacion]) > 0) {\n                $request->merge(['plan_original' => false]);\n            }\n        }\n\n        if ($request->filled('id')) {\n            // Eliminar la factura actual\n            if ($request->hasFile('factura')) {\n                $archivo = $this->archivo_repositorio->obtenerPorModelo('App\\Models\\Empresas\\EmpresaPlan', $request->id);\n\n                if (!is_null($archivo)) {\n                    $this->eliminarArchivoDesdeRuta($archivo->ruta);\n                    $this->archivo_repositorio->eliminar($archivo->id);\n                }\n            }\n\n            $plan_asignado = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $bandera_enviar_correo = true;\n            $request->merge(['usuario_id' => auth()->user()->id]);\n            $plan_asignado = $this->repositorio->crear($request->except($campos_excluidos));\n        }\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_asignado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_asignado, $request->funcionalidades);\n        }\n\n        // Guardar la factura\n        if ($request->hasFile('factura')) {\n            $this->guardarFactura($plan_asignado->id, $request->empresa_id, $request->file('factura'));\n        }\n\n        if ($bandera_enviar_correo) {\n            $empresa      = $this->empresa_repositorio->getUno($request->empresa_id);\n            $usuario      = $empresa->usuarios[0];\n            $empresa_plan = $this->repositorio->getUno($plan_asignado->id);\n\n            $titulo = 'Usuario principal de la empresa creado';\n            Mail::send(new CrearUsuarioMail($usuario, Password::createToken($usuario), $titulo, $titulo, '', $empresa, $empresa_plan));\n        }\n\n        return $plan_asignado;\n    }\n\n    /**\n     * Renovar el plan asignado.\n     *\n     * @param int $id ID del plan de la empresa que se quiere renovar.\n     * @throws Exception Si el plan que se quiere renovar está en estado 'próximo'.\n     * @return EmpresaPlan Plan de la empresa renovado.\n     * @author Daniel Beltrán\n     */\n    public function renovar(int $id): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($empresa_plan->estado_id === 3) {\n            throw new Exception('No se puede renovar un plan que no ha entrado en vigencia');\n        }\n\n        $request = new Request(Arr::except($empresa_plan->toArray(), ['id', 'renovando', 'por_facturar', 'plan', 'estado', 'vigencia_dias']));\n        $request->merge(['por_facturar' => true]);\n\n        if (in_array($empresa_plan->estado_id, [1, 4])) {\n            // Cuando el plan actual está activo o por vencer, se asigna el estado 'próximo'\n            $request->merge(['estado_id' => 3]);\n        } elseif (in_array($empresa_plan->estado_id, [2, 5])) {\n            // Cuando el plan actual está inactivo o vencido, se asigna el estado 'activo'\n            $request->merge(['estado_id' => 1]);\n        }\n\n        $this->verificarYAsignarTiempo($empresa_plan, $request);\n        $plan_renovado = $this->repositorio->crear($request->toArray());\n\n        if ($request->filled('pruebas')) {\n            $this->repositorio->sincronizarPruebas($plan_renovado, $request->pruebas);\n        }\n\n        if ($request->filled('funcionalidades')) {\n            $this->repositorio->sincronizarFuncionalidades($plan_renovado, $request->funcionalidades);\n        }\n\n        return $plan_renovado;\n    }\n\n    /**\n     * Verificar si el plan es por tiempo y asignar el tiempo de vigencia en caso de serlo.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function verificarYAsignarTiempo(EmpresaPlan $empresa_plan, Request &$request): void {\n        if (!is_null($empresa_plan->fecha_inicio) && !is_null($empresa_plan->fecha_vencimiento)) {\n            $request->merge($this->calcularFechasVigencia($empresa_plan->plan->vigencia, $empresa_plan->fecha_vencimiento->addDay()));\n        }\n    }\n\n    /**\n     * Calcular las fechas en las que el plan estará vigente.\n     *\n     * @param int $vigencia Cantidad de días de vigencia.\n     * @param Carbon|null $fecha_inicio_vigencia Fecha en la que inicia la vigencia.\n     * @return array Fechas de inicio y vencimiento.\n     * @author Daniel Beltrán\n     */\n    public function calcularFechasVigencia(int $vigencia, ?Carbon $fecha_inicio_vigencia = null): array {\n        $hoy          = now();\n        $fecha_inicio = !is_null($fecha_inicio_vigencia) ? $fecha_inicio_vigencia : $hoy;\n\n        // Si es múltiplo de 3, entonces la vigencia es en meses\n        if (($vigencia % 3) === 0 && gettype($vigencia / 30) === 'integer') {\n            $meses             = $vigencia / 30;\n            $fecha_vencimiento = $fecha_inicio->copy()->addMonths($meses);\n\n            if ($fecha_inicio->day === 1) {\n                $fecha_vencimiento->subDay();\n            }\n        } else {\n            $vigencia          = $vigencia < 0 ? abs($vigencia) : $vigencia; // Convierte los valores negativos a positivos\n            $fecha_vencimiento = $fecha_inicio->copy()->addDays($vigencia);\n        }\n\n        return [\n            'fecha_inicio'      => $fecha_inicio->format('Y-m-d'),\n            'fecha_vencimiento' => $fecha_vencimiento->format('Y-m-d')\n        ];\n    }\n\n    /**\n     * Facturar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, Request $request): EmpresaPlan {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        if ($request->filled('vigencia')) {\n            $request->merge($this->calcularFechasVigencia($request->vigencia, $empresa_plan->fecha_inicio));\n        }\n\n        $request->merge(['por_facturar' => false]);\n\n        $this->repositorio->sincronizarPruebas($empresa_plan, $request->pruebas);\n        $this->repositorio->sincronizarFuncionalidades($empresa_plan, $request->funcionalidades);\n\n        $this->guardarFactura($id, $empresa_plan->empresa_id, $request->file('factura'));\n        return $this->repositorio->actualizar($id, $request->except('_token', '_method', 'pruebas', 'factura', 'vigencia', 'funcionalidades'));\n    }\n\n    /**\n     * Guardar factura.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param int $empresa_id ID de la empresa.\n     * @param SymfonyUploadedFile|UploadedFile $archivo Archivo de la factura.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function guardarFactura(int $id, int $empresa_id, UploadedFile|SymfonyUploadedFile $archivo): void {\n        $ruta = \"private/archivos/empresas/{$empresa_id}/facturas\";\n        $this->generarDirectorios(\"app/{$ruta}\");\n        $nombre_archivo = $this->generarNombreArchivo($archivo);\n        $this->guardarArchivoEnRuta($archivo, $ruta, $nombre_archivo);\n\n        $this->archivo_repositorio->crear([\n            'modelo'    => 'App\\Models\\Empresas\\EmpresaPlan',\n            'modelo_id' => $id,\n            'nombre'    => 'factura',\n            'ruta'      => $ruta . '/' . $nombre_archivo\n        ]);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por tipo de prueba.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function historialRecompras(Request $request): Collection {\n        $rol_usuario = $this->rol_repositorio->usuarioRolActivo();\n        $request->merge([\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return match ($rol_usuario->id) {\n            RolRepository::ROL_SUPERADMIN_ID => $this->repositorio->obtenerRecomprasEmpresaParaSuperadmin($request),\n            RolRepository::ROL_PROPIETARIO_ID,\n            RolRepository::ROL_ADMINISTRADOR_GENERAL_ID,\n            RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID,\n            RolRepository::ROL_EVALUADOR_ID => $this->repositorio->obtenerRecomprasEmpresaParaRolTipoEmpresa($request)\n        };\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos para una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return Collection\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): Collection {\n        $historial = $this->repositorio->historialComprasCreditos($empresa_id, $request);\n\n        return $historial->map(function (EmpresaPlan $plan) {\n            $total_creditos = $plan->creditos ?? $plan->planCredito?->creditos ?? 0;\n            $creditos_consumidos = (int) ($plan->creditos_consumidos ?? 0);\n\n            $plan->creditos_totales = $total_creditos;\n            $plan->creditos_consumidos = $creditos_consumidos;\n            $plan->creditos_restantes = max(0, $total_creditos - $creditos_consumidos);\n\n            return $plan;\n        });\n    }\n\n    /**\n     * Obtener el último plan de la empresa por tipo de prueba excluyendo los que tengan estado próximo.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUltimoPorTipo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->ultimoPlanAsignado(new Request([\n            'empresa_id'             => $empresa_id,\n            'tipo_prueba_id'         => $tipo_prueba_id,\n            'excluir_estado_proximo' => true\n        ]));\n\n        if (!is_null($plan)) {\n            $plan_proximo       = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id);\n            $plan->plan_proximo = !is_null($plan_proximo) && $plan->id !== $plan_proximo->id;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan de empresa con el próximo plan de ese mismo tipo.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerUnoConProximo(int $id): ?EmpresaPlan {\n        $plan               = $this->repositorio->getUno($id);\n        $plan->plan_proximo = $this->repositorio->planProximo($plan->empresa_id, $plan->plan->tipo_prueba_id);\n        return $plan;\n    }\n\n    /**\n     * Obtener el plan activo de la empresa por tipo de prueba.\n     *\n     * En la consulta se retorna una propiedad que indica si el plan encontrado tiene un plan próximo.\n     * La propiedad se llama 'plan_proximo' y es un booleano.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param int $tipo_prueba_id ID del tipo de prueba.\n     * @return ?EmpresaPlan\n     * @author Daniel Beltrán\n     */\n    public function obtenerPlanActivo(int $empresa_id, int $tipo_prueba_id): ?EmpresaPlan {\n        $plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!is_null($plan)) {\n            $plan->plan_proximo_id = $this->repositorio->planProximo($empresa_id, $tipo_prueba_id)->id ?? null;\n        }\n\n        return $plan;\n    }\n\n    /**\n     * Solicitar la renovación de un plan específico de una empresa específica.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return void\n     * @author Fahibram Cárcamo\n     */\n    public function solicitarRenovacionPlan(Request $request) {\n        $plan                = $this->plan_repositorio->getUno($request->plan_id);\n        $empresa             = $this->empresa_repositorio->getUno($request->empresa_id);\n        $usuario_solicitante = $this->usuario_repositorio->getUno($request->usuario_id);\n\n        $usuarios_superadministradores = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_SUPERADMIN_ID,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_ejecutivos_cuenta = $this->usuario_repositorio->getPorRolEmpresa(new Request([\n            'rol_id'        => RolRepository::ROL_EJECUTIVO_CUENTA_ID,\n            'empresa_id'    => $request->empresa_id,\n            'con_roles_ids' => true\n        ]));\n\n        $usuarios_destinatarios = $usuarios_superadministradores->merge($usuarios_ejecutivos_cuenta);\n\n        Notification::send($usuarios_destinatarios, new SolicitudRenovacionPlanNotification($usuario_solicitante, $empresa, $plan));\n    }\n\n    /**\n     * Verificar que el plan tenga unidades disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlan(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->unidades) && $empresa_plan->unidades > 0) {\n            if (($empresa_plan->unidades - $empresa_plan->consumos_agendas) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga unidades de ofertas laborales disponibles o que la fecha de vencimiento no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function verificarVigenciaPlanOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->diffInDays(now()) < 0) {\n            return true;\n        } elseif (!is_null($empresa_plan->cantidad_ofertas_laborales) && $empresa_plan->cantidad_ofertas_laborales > 0) {\n            if (($empresa_plan->cantidad_ofertas_laborales - $empresa_plan->consumos_ofertas_laborales) > 0) {\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene unidades disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadUnidades(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->unidades > $empresa_plan->consumos_agendas;\n    }\n\n    /**\n     * Retornar true si la instancia de EmpresaPlan tiene ofertas laborales disponibles, false en otro caso.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Fahibram Cárcamo\n     */\n    public function validarDisponibilidadOfertasLaborales(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_ofertas_laborales;\n    }\n\n    /**\n     * Verificar que la fecha de vencimiento del plan no haya pasado.\n     *\n     * @param EmpresaPlan $empresa_plan Plan de la empresa.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function verificarVigenciaPlanVacantes(EmpresaPlan $empresa_plan): bool {\n        if (!is_null($empresa_plan->fecha_vencimiento) && $empresa_plan->fecha_vencimiento->gte(now())) {\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * Verificar que el plan tenga vacantes disponibles.\n     *\n     * @param EmpresaPlan $empresa_plan Instancia de la clase EmpresaPlan.\n     * @return bool\n     * @author Andres Gonzalez\n     */\n    public function validarDisponibilidadVacantes(EmpresaPlan $empresa_plan): bool {\n        return $empresa_plan->cantidad_ofertas_laborales > $empresa_plan->consumos_vacantes;\n    }\n\n    /**\n     * Obtener creditos disponibles para un plan de empresa.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @return int\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function creditosDisponibles(int $empresa_plan_id): int {\n        $empresa_plan = $this->repositorio->getUno($empresa_plan_id);\n        return $empresa_plan?->creditos_restantes ?? 0;\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return array|null\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): ?array {\n        $tipo_prueba_id = $request->filled('tipo_prueba_id')\n            ? (int) $request->tipo_prueba_id\n            : TipoPrueba::SELECCION_ID;\n\n        $empresa_plan = $this->repositorio->planActivo($empresa_id, $tipo_prueba_id);\n\n        if (!$empresa_plan) {\n            return null;\n        }\n\n        $empresa_plan->load('planCredito:id,nombre,creditos,precio');\n\n        return [\n            'empresa_id'           => $empresa_id,\n            'empresa_plan_id'      => $empresa_plan->id,\n            'creditos_plan'        => $empresa_plan->creditos ?? 0,\n            'creditos_disponibles' => $empresa_plan->creditos_restantes,\n            'plan_credito'         => $empresa_plan->planCredito ? [\n                'id'       => $empresa_plan->planCredito->id,\n                'nombre'   => $empresa_plan->planCredito->nombre,\n                'creditos' => $empresa_plan->planCredito->creditos,\n                'precio'   => $empresa_plan->planCredito->precio\n            ] : null\n        ];\n    }\n\n    /**\n     * Validar si hay creditos suficientes.\n     *\n     * @param int $empresa_plan_id ID del plan de empresa.\n     * @param int $creditos_necesarios Créditos necesarios para realizar la acción.\n     * @return bool\n     * @author Sergio Vargas\n     * @author Daniel Beltrán\n     */\n    public function tieneCreditosSuficientes(int $empresa_plan_id, int $creditos_necesarios): bool {\n        return $this->creditosDisponibles($empresa_plan_id) >= $creditos_necesarios;\n    }\n}\n","numLines":622,"startLine":1,"totalLines":622}},"sourceToolAssistantUUID":"b30c8a01-827a-451d-b25c-94bda5d1fae7"}
{"parentUuid":"adfc42ca-ce05-4561-b21c-f12f499d401b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_017HY9KLq7DPMScthzuyZo4j","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora entiendo. El método `creditosDisponiblesEmpresa` (líneas 582-607) retorna la información de créditos. Voy a modificar el método `getTodo` en `EmpresaService` para agregar el campo `plan_creditos`."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":9890,"cache_read_input_tokens":37799,"cache_creation":{"ephemeral_5m_input_tokens":9890,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXM7KsAdHchsZ37LTHz7L","type":"assistant","uuid":"16493e67-0ae0-4dea-9669-0fe95017a416","timestamp":"2026-01-21T19:54:38.281Z"}
{"parentUuid":"16493e67-0ae0-4dea-9669-0fe95017a416","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_017HY9KLq7DPMScthzuyZo4j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YMzpSbo5S4Lg9b6dsLGqTo","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","old_string":"            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);","new_string":"            // Obtener información de créditos disponibles\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = !is_null($creditos_info) ? $creditos_info : null;\n\n            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":9890,"cache_read_input_tokens":37799,"cache_creation":{"ephemeral_5m_input_tokens":9890,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXM7KsAdHchsZ37LTHz7L","type":"assistant","uuid":"6f89dbb2-ecda-40bc-8752-75a445307555","timestamp":"2026-01-21T19:54:41.755Z"}
{"type":"file-history-snapshot","messageId":"6f89dbb2-ecda-40bc-8752-75a445307555","snapshot":{"messageId":"acdc929c-42a9-4545-9dbe-c95af0d9daf7","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaService.php":{"backupFileName":"d9f5059823924d08@v1","version":1,"backupTime":"2026-01-21T19:55:09.829Z"}},"timestamp":"2026-01-21T19:54:28.082Z"},"isSnapshotUpdate":true}
{"parentUuid":"6f89dbb2-ecda-40bc-8752-75a445307555","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YMzpSbo5S4Lg9b6dsLGqTo","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   200→                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n   201→                }\n   202→            }\n   203→\n   204→            // Obtener información de créditos disponibles\n   205→            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n   206→            $registro['plan_creditos'] = !is_null($creditos_info) ? $creditos_info : null;\n   207→\n   208→            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n   209→            array_push($coleccion, $registro);\n   210→        }\n   211→\n   212→        return collect($coleccion);\n   213→    }"}]},"uuid":"54756340-51da-423d-82b6-2ae3126e618f","timestamp":"2026-01-21T19:55:09.875Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","oldString":"            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);","newString":"            // Obtener información de créditos disponibles\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = !is_null($creditos_info) ? $creditos_info : null;\n\n            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Illuminate\\Support\\Str;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\Response;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse App\\Exports\\Empresas\\HistorialCambiosExport;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\IA\\ServicioIARepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Planes\\ConsumoRepository;\nuse App\\Http\\Repositories\\Empresas\\SectorRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse Symfony\\Component\\HttpFoundation\\StreamedResponse;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse Symfony\\Component\\HttpFoundation\\{BinaryFileResponse};\nuse App\\Http\\Repositories\\Configuraciones\\CiudadRepository;\nuse App\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository;\nuse App\\Http\\Repositories\\Usuarios\\TipoDocumentoRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Politicas\\PoliticaAceptadaRepository;\nuse App\\Jobs\\Configuraciones\\CrearPlantillasPorDefectoEmpresaJob;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionModeloRepository;\n\n/**\n * @property EmpresaRepository $repositorio\n */\nclass EmpresaService extends BaseService\n{\n    use ArchivoTrait;\n\n    private $modelo = 'App\\Models\\Empresas\\Empresa';\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaRepository $repositorio Repositorio de empresas.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param PoliticaAceptadaRepository $politica_aceptada_repositorio Repositorio de políticas aceptadas.\n     * @param CiudadRepository $ciudad_repositorio Repositorio de ciudades.\n     * @param SectorRepository $sector_repositorio Repositorio de sectores.\n     * @param TamanoEmpresaRepository $tamano_empresa_repositorio Repositorio de tamaños de empresas.\n     * @param TipoDocumentoRepository $tipo_documento_repositorio Repositorio de tipos de documentos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param ConfiguracionRepository $configuracion_repositorio Repositorio de configuraciones.\n     * @param ConfiguracionModeloRepository $configuracion_modelo_repositorio Repositorio de configuraciones de modelos.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @param ConsumoRepository $consumo_repositorio Repositorio de consumos.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        EmpresaRepository $repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected PoliticaAceptadaRepository $politica_aceptada_repositorio,\n        protected CiudadRepository $ciudad_repositorio,\n        protected SectorRepository $sector_repositorio,\n        protected TamanoEmpresaRepository $tamano_empresa_repositorio,\n        protected TipoDocumentoRepository $tipo_documento_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected TipoPruebaRepository $tipo_prueba_repositorio,\n        protected EmpresaPlanRepository $empresa_plan_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected ConfiguracionRepository $configuracion_repositorio,\n        protected ConfiguracionModeloRepository $configuracion_modelo_repositorio,\n        protected EmpresaPlanService $empresa_plan_servicio,\n        protected ConsumoRepository $consumo_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected ServicioIARepository $servicio_ia_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Obtener una empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @return Empresa|null\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?Empresa {\n        $empresa = $this->repositorio->getUnoBasico($id);\n\n        if (!is_null($empresa)) {\n            $planes        = [];\n            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n                'empresa_id'         => $id,\n                'con_relaciones'     => true,\n                'validar_relaciones' => true,\n                'en'                 => true,\n                'campo'              => 'rol_id',\n                'valores'            => [\n                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n                    $this->rol_repositorio::ROL_EVALUADOR_ID\n                ]\n            ]));\n\n            $usuarios = $usuarios->map(function ($usuario) {\n                $eliminar = false;\n\n                if (\n                    !$usuario->usuario->tiene_agendas\n                    && !$usuario->usuario->tiene_ofertas_laborales\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_etapa_usuario\n                ) {\n                    $eliminar = true;\n                }\n\n                $usuario->usuario->eliminar = $eliminar;\n                return $usuario;\n            });\n\n            $empresa->planes                         = $planes;\n            $empresa->usuarios                       = $usuarios;\n            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n                'model_type' => $this->modelo,\n                'modelo_id'  => $id\n            ]));\n            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Obtener todas las empresas.\n     *\n     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     */\n    public function getTodo(Request $request): Collection {\n        $empresas      = $this->repositorio->getTodo($request);\n        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n        $coleccion     = [];\n\n        foreach ($empresas as $empresa) {\n            $registro = $empresa;\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n\n                // Obtener el plan activo, si no tiene se obtiene el último plan asignado\n                $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n\n                if (is_null($registro[$llave])) {\n                    $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(new Request([\n                        'empresa_id'             => $empresa->id,\n                        'tipo_prueba_id'         => $tipo_prueba->id,\n                        'excluir_estado_proximo' => true\n                    ]));\n                }\n\n                // Verificar si tiene un plan próximo adicional al plan actual\n                if (!is_null($registro[$llave])) {\n                    $plan_proximo                     = $this->empresa_plan_repositorio->planProximo($empresa->id, $tipo_prueba->id);\n                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n                }\n            }\n\n            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);\n        }\n\n        return collect($coleccion);\n    }\n\n    /**\n     * Obtener el porcentaje de creación.\n     *\n     * @param int $id ID de la empresa.\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function obtenerPorcentajeCreacion(int $id): int {\n        $empresa    = $this->repositorio->getUno($id);\n        $porcentaje = 0;\n\n        if (is_null($empresa)) {\n            return $porcentaje;\n        }\n\n        if (!is_null($empresa->empresa_id)) {\n            return $porcentaje;\n        }\n\n        $porcentaje += 10;\n\n        if (count($empresa->archivos) > 0) {\n            $porcentaje += 20;\n        }\n\n        if (count($empresa->usuarios) > 0) {\n            $porcentaje += 10;\n        }\n\n        if (count($empresa->planes) > 0) {\n            $porcentaje += 30;\n        }\n\n        if (count($empresa->usuarios) > 1) {\n            $porcentaje += 30;\n        }\n\n        return $porcentaje;\n    }\n\n    /**\n     * Guardar empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Cuando un usuario que no es superadministrador, intenta modificar una empresa diferente a la que está logueado.\n     * @return Empresa\n     * @author Daniel Beltrán\n     */\n    public function guardar(Request $request): Empresa {\n        $campos_excluidos = ['_token', '_method', 'id', 'pais_id', 'departamento_id', 'digito_verificacion', 'extension', 'extension_tesorero', 'logo', 'empresa_plan_id'];\n\n        if ($request->filled('digito_verificacion')) {\n            $request->merge(['documento' => $request->documento . '-' . $request->digito_verificacion]);\n        }\n\n        if ($request->filled('telefono') && $request->filled('extension')) {\n            $request->merge(['telefono' => $request->telefono . '-' . $request->extension]);\n        }\n\n        if ($request->filled('telefono_tesorero') && $request->filled('extension_tesorero')) {\n            $request->merge(['telefono_tesorero' => $request->telefono_tesorero . '-' . $request->extension_tesorero]);\n        }\n\n        // Agregar datos a la sucursal\n        if ($request->filled('empresa_id')) {\n            $empresa_principal = $this->repositorio->getUno($request->empresa_id);\n\n            if (!is_null($empresa_principal->empresa_id)) {\n                throw new Exception('No se puede crearse una sucursal de otra sucursal');\n            }\n\n            $request->merge([\n                'tamano_empresa_id' => $empresa_principal->tamano_empresa_id,\n                'razon_social'      => $empresa_principal->razon_social\n            ]);\n\n            unset($empresa_principal);\n        }\n\n        if ($request->filled('id')) {\n            $rol_usuario = $this->rol_repositorio->usuarioRolActivo(Auth::id());\n\n            // Validar que solo el superadministrador pueda editar cualquier empresa\n            if ($rol_usuario->id != RolRepository::ROL_SUPERADMIN_ID) {\n                $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n                if ($empresa_usuario->id != $request->empresa_id) {\n                    throw new Exception('No puedes editar una empresa diferente a la que estás logueado', Response::HTTP_FORBIDDEN);\n                }\n            }\n\n            $empresa = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $empresa = $this->repositorio->crear($request->except($campos_excluidos));\n            CrearPlantillasPorDefectoEmpresaJob::dispatch($empresa->id);\n        }\n\n        // Renovación el plan\n        if ($request->filled('empresa_plan_id')) {\n            $this->empresa_plan_servicio->renovar($request->empresa_plan_id);\n        }\n\n        // Guardar el logo de la sucursal\n        if ($request->filled('empresa_id') && $request->filled('logo')) {\n            $this->cambiarLogo($empresa->id, $request->logo);\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Guardar archivos de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function guardarArchivos(int $id, Request $request): void {\n        if ($request->filled('logo')) {\n            $this->cambiarLogo($id, $request->logo);\n        }\n\n        foreach ($request->files->all() as $nombre_archivo_empresa => $archivo_empresa) {\n            $archivo_existente = $this->archivo_repositorio->getUnoAvanzado(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id,\n                'nombre'    => $nombre_archivo_empresa\n            ]));\n\n            if (!is_null($archivo_existente)) {\n                $this->archivo_servicio->eliminarPorModelo($this->modelo, $id, $nombre_archivo_empresa);\n            }\n\n            $ruta = \"private/archivos/empresas/{$id}\";\n            $this->generarDirectorios(\"app/{$ruta}\");\n\n            $nombre_archivo = $this->generarNombreArchivo($archivo_empresa);\n            $this->guardarArchivoEnRuta($archivo_empresa, $ruta, $nombre_archivo);\n\n            $this->archivo_repositorio->crear([\n                'modelo'                  => $this->modelo,\n                'modelo_id'               => $id,\n                'nombre'                  => $nombre_archivo_empresa,\n                'nombre_original_archivo' => $nombre_archivo,\n                'ruta'                    => $ruta . '/' . $nombre_archivo\n            ]);\n        }\n    }\n\n    /**\n     * Eliminar empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa tiene algún registro asociado o está archivada.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function eliminar(int $id): void {\n        $empresa = $this->repositorio->getUnoAvanzado(new Request([\n            'id'                       => $id,\n            'contar_sucursales'        => true,\n            'contar_planes'            => true,\n            'contar_procesos'          => true,\n            'contar_areas'             => true,\n            'contar_perfiles'          => true,\n            'contar_agendas'           => true,\n            'contar_encuestas'         => true,\n            'contar_soportes'          => true,\n            'contar_usuarios'          => true,\n            'contar_ordenes_servicios' => true,\n            'contar_ofertas_laborales' => true,\n            'contar_portales_empleos'  => true\n        ]));\n\n        if ($empresa->activo) {\n            // Validar que no tenga planes\n            if ($empresa->planes_count > 0) {\n                throw new Exception('La empresa tiene planes asignados');\n            }\n\n            // Validar que no tenga sucursales\n            if ($empresa->sucursales_count > 0) {\n                throw new Exception('La empresa tiene sucursales asignadas');\n            }\n\n            // Validar que no tenga procesos\n            if ($empresa->procesos_count > 0) {\n                throw new Exception('La empresa tiene procesos asignados');\n            }\n\n            // Validar que no tenga áreas\n            if ($empresa->areas_count > 0) {\n                throw new Exception('La empresa tiene áreas asignadas');\n            }\n\n            // Validar que no tenga perfiles\n            if ($empresa->perfiles_count > 0) {\n                throw new Exception('La empresa tiene perfiles asignados');\n            }\n\n            // Validar que no tenga agendas\n            if ($empresa->agendas_count > 0) {\n                throw new Exception('La empresa tiene agendas asignadas');\n            }\n\n            // Validar que no tenga encuestas\n            if ($empresa->encuestas_count > 0) {\n                throw new Exception('La empresa tiene encuestas asignadas');\n            }\n\n            // Validar que no tenga soportes\n            if ($empresa->soportes_count > 0) {\n                throw new Exception('La empresa tiene soportes asignados');\n            }\n\n            // Validar que no tenga usuarios\n            if ($empresa->usuarios_count > 0) {\n                throw new Exception('La empresa tiene usuarios asignados');\n            }\n\n            // Validar que no tenga ordenes de servicio\n            if ($empresa->ordenes_servicios_count > 0) {\n                throw new Exception('La empresa tiene ordenes de servicio asignadas');\n            }\n\n            // Validar que no tenga ofertas laborales\n            if ($empresa->ofertas_laborales_count > 0) {\n                throw new Exception('La empresa tiene ofertas laborales asignadas');\n            }\n\n            // Validar que no tenga portales de empleo\n            if ($empresa->portal_empleo_count > 0) {\n                throw new Exception('La empresa tiene portales de empleo asignados');\n            }\n\n            $this->repositorio->sincronizarConfiguraciones($empresa, []);\n            $this->repositorio->eliminar($id);\n        } else {\n            throw new Exception('La empresa está archivada');\n        }\n    }\n\n    /**\n     * Eliminar los usuarios de la empresa junto con sus políticas aceptadas.\n     *\n     * @param Empresa $empresa Empresa.\n     * @param Collection $usuarios Usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function eliminarUsuarios(Empresa $empresa, Collection $usuarios): void {\n        if (count($usuarios) > 0) {\n            foreach ($usuarios as $usuario_empresa) {\n                // Disociar el usuario de la empresa\n                $this->repositorio->disociarUsuario($empresa, $usuario_empresa->id);\n\n                // Disociar las políticas aceptadas del usuario para la empresa\n                $this->politica_aceptada_repositorio->eliminarPorUsuarioYEmpresa($usuario_empresa->id, $empresa->id);\n\n                // Obtener todas las políticas aceptadas del usuario en otras empresas\n                $politicas_otras_empresas = $this->politica_aceptada_repositorio->obtenerPorUsuarioYEmpresasDiferentes($usuario_empresa->id, [$empresa->id]);\n\n                // Obtener los datos del usuario\n                $usuario = $this->usuario_repositorio->getUno($usuario_empresa->id);\n\n                // Validar si el usuario tiene más empresas asociadas y más políticas aceptadas de otras empresas\n                if (count($usuario->empresas) == 0 && count($politicas_otras_empresas) == 0) {\n                    $this->usuario_repositorio->eliminar($usuario_empresa->id);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener el historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return Collection\n     * @author Daniel Beltrán\n     */\n    public function historialCambios(int $id): Collection {\n        $historial       = $this->repositorio->historialCambios($id);\n        $historial_final = [];\n\n        // Obtener los datos referenciados a través de llaves foráneas\n        $ciudades         = $this->obtenerDatosReferenciados($historial, 'ciudad_id', 'ciudades_ids', $this->ciudad_repositorio);\n        $ejecutivos       = $this->obtenerDatosReferenciados($historial, 'ejecutivo_id', 'usuarios_ids', $this->usuario_repositorio);\n        $sectores         = $this->obtenerDatosReferenciados($historial, 'sector_id', 'sectores_ids', $this->sector_repositorio);\n        $tamanos_empresas = $this->obtenerDatosReferenciados($historial, 'tamano_empresa_id', 'tamanos_empresas_ids', $this->tamano_empresa_repositorio);\n        $tipos_documentos = $this->obtenerDatosReferenciados($historial, 'tipo_documento_representante_id', 'tipos_documentos_ids', $this->tipo_documento_repositorio);\n\n        foreach ($historial as $item) {\n            array_push($historial_final, [\n                'id'             => $item->id,\n                'user_type'      => $item->user_type,\n                'user_id'        => $item->user_id,\n                'event'          => $item->event,\n                'auditable_type' => $item->auditable_type,\n                'auditable_id'   => $item->auditable_id,\n                'created_at'     => $item->created_at,\n                'user'           => $item->user,\n                'old_values'     => $this->asignarCambiosHistorial($item->old_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos),\n                'new_values'     => $this->asignarCambiosHistorial($item->new_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos)\n            ]);\n        }\n\n        return collect($historial_final);\n    }\n\n    /**\n     * Asignar los cambios del historial.\n     *\n     * @param array $valores Valores del historial (pueden ser antigüos o nuevos).\n     * @param Collection $ciudades Ciudades.\n     * @param Collection $ejecutivos Ejecutivos.\n     * @param Collection $sectores Sectores.\n     * @param Collection $tamanos_empresas Tamaños de empresas.\n     * @param Collection $tipos_documentos Tipos de documentos.\n     * @return array\n     * @author Daniel Beltrán\n     */\n    private function asignarCambiosHistorial(\n        array $valores,\n        Collection $ciudades,\n        Collection $ejecutivos,\n        Collection $sectores,\n        Collection $tamanos_empresas,\n        Collection $tipos_documentos\n    ): array {\n        $valores_actualizados = [];\n\n        foreach ($valores as $llave => $valor) {\n            $valores_actualizados[$llave] = $valor;\n\n            if ($llave === 'ciudad_id') {\n                $ciudad                       = $ciudades->firstWhere('id', $valor);\n                $valores_actualizados[$llave] = $ciudad->nombre . ', ' . $ciudad->departamento->nombre . ' - ' . $ciudad->departamento->pais->nombre;\n            }\n\n            if ($llave === 'ejecutivo_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $ejecutivos->firstWhere('id', $valor)->nombre_completo : null;\n            }\n\n            if ($llave === 'sector_id') {\n                $valores_actualizados[$llave] = $sectores->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tamano_empresa_id') {\n                $valores_actualizados[$llave] = $tamanos_empresas->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tipo_documento_representante_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $tipos_documentos->firstWhere('id', $valor)->nombre : null;\n            }\n        }\n\n        return $valores_actualizados;\n    }\n\n    /**\n     * Obtener el logo de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa no tiene ningún logo.\n     * @return BinaryFileResponse|StreamedResponse\n     * @author Daniel Beltrán\n     */\n    public function getLogo(int $id): BinaryFileResponse|StreamedResponse {\n        $logo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n        abort_if(is_null($logo), 404, 'Esta empresa no tiene ningún logo');\n        return $this->obtenerArchivoDesdeRuta($logo->ruta);\n    }\n\n    /**\n     * Cambiar el logo de la empresa.\n     *\n     * Elimina el logo actual y guarda el nuevo.\n     *\n     * @param int $id ID de la empresa.\n     * @param string $logo Nuevo logo en base64.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function cambiarLogo(int $id, string $logo): void {\n        $archivo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n\n        if (!is_null($archivo)) {\n            $this->archivo_servicio->eliminar($archivo->id);\n        }\n\n        $this->archivo_servicio->guardarVariosBase64($this->modelo, $id, ['logo' => $logo], 'empresas');\n    }\n\n    /**\n     * Exportar Excel del historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return BinaryFileResponse|Response\n     * @author Daniel Beltrán\n     */\n    public function exportarExcelHistorialCambios(int $id): BinaryFileResponse|Response {\n        $datos = [\n            'historial_cambios' => $this->historialCambios($id),\n            'archivos'          => $this->archivo_repositorio->getTodo(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id\n            ]))\n        ];\n\n        return Excel::download(new HistorialCambiosExport($datos), 'historial-cambios.xlsx');\n    }\n\n    /**\n     * Obtiene el conteo dependiendo de id de empresas planes.\n     *\n     * @param int $empresa_plan_id Id de empresas planes.\n     * @param Request $request Contenido de la petición.\n     * @return int\n     * @author Andres Gonzalez\n     * @author Fahibram Cárcamo\n     */\n    public function conteoConsumo(int $empresa_plan_id, Request $request): int {\n        return $this->consumo_repositorio->getTodo(\n            new Request([\n                'empresa_plan_id' => $empresa_plan_id,\n                'fecha_inicio'    => $request->fecha_inicio,\n                'fecha_fin'       => $request->fecha_fin\n            ])\n        )\n        ->count();\n    }\n\n    /**\n     * Obtiene el resumen para el panel.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function obtenerResumen(Request $request): array {\n        $resumen = $this->repositorio->obtenerResumen($request);\n        $alto    = 0;\n        $normal  = 0;\n        $bajo    = 0;\n\n        $ejecutivos_procesados = [];\n        $planes                = [];\n        $total_precio          = 0;\n        $empresas_asignadas    = 0;\n        $planes_agrupados      = [];\n\n        foreach ($resumen['empresasPlanes'] as $empresa_plan) {\n            $consumo = $this->conteoConsumo($empresa_plan->id, $request);\n\n            if ($consumo > $empresa_plan->unidades) {\n                $alto++;\n            } elseif ($consumo == $empresa_plan->unidades) {\n                $normal++;\n            } else {\n                $bajo++;\n            }\n        }\n\n        $resumen['consumo'] = [\n            'alto'   => $alto,\n            'normal' => $normal,\n            'bajo'   => $bajo,\n        ];\n\n        // Top ejecutivos\n        foreach ($resumen['empresa_ejecutivo'] as $ejecutivo) {\n            $empresas = $this->repositorio->getTodoAgrupadoPlan(new Request([\n                'ejecutivo_id' => $ejecutivo->ejecutivo_id,\n                'fecha_inicio' => $request->fecha_inicio,\n                'fecha_fin'    => $request->fecha_fin,\n            ]));\n\n            foreach ($empresas as $empresa) {\n                foreach ($empresa['empresas_planes'] as $plan) {\n                    $empresas_asignadas++;\n                    $total_precio += $plan['precio'];\n\n                    $planes[] = [\n                        'id'          => $plan['plan']['id'],\n                        'nombre'      => $plan['plan']['nombre'],\n                        'descripcion' => $plan['plan']['descripcion'],\n                        'precio'      => $plan['precio'],\n                        'conteo'      => null\n                    ];\n                }\n            }\n\n            // Agrupa los planes por el id y suma su precio y conteo.\n            foreach ($planes as $plan) {\n                $plan_id = $plan['id'];\n\n                if (!isset($planes_agrupados[$plan_id])) {\n                    $planes_agrupados[$plan_id]           = $plan;\n                    $planes_agrupados[$plan_id]['conteo'] = 1;\n                } else {\n                    $planes_agrupados[$plan_id]['precio'] += $plan['precio'];\n                    $planes_agrupados[$plan_id]['conteo'] += 1;\n                }\n            }\n\n            $planes = array_values($planes_agrupados);\n\n            // Ordena de mayor a menor precio.\n            usort($planes, function ($primero, $segundo) {\n                return $segundo['precio'] <=> $primero['precio'];\n            });\n\n            if ($total_precio > 0) {\n                $ejecutivos_procesados[] = [\n                    'id_ejecutivo'       => $ejecutivo->ejecutivo_id,\n                    'nombre'             => $ejecutivo->ejecutivo->nombre_completo,\n                    'ventas_totales'     => $total_precio,\n                    'empresas_asignadas' => $empresas_asignadas,\n                    'planes'             => $planes,\n                ];\n            }\n\n            // Reiniciar variables.\n            $empresas_asignadas = 0;\n            $total_precio       = 0;\n            $planes             = [];\n            $planes_agrupados   = [];\n        }\n\n        // Ordena de mayor a menor de ventas_totales.\n        usort($ejecutivos_procesados, function ($primero, $segundo) {\n            return $segundo['ventas_totales'] <=> $primero['ventas_totales'];\n        });\n\n        $resumen['ejecutivos'] = $ejecutivos_procesados;\n\n        unset($resumen['empresasPlanes'], $resumen['empresa_ejecutivo']);\n\n        return $resumen;\n    }\n}\n","structuredPatch":[{"oldStart":201,"oldLines":6,"newStart":201,"newLines":10,"lines":["                 }","             }"," ","+            // Obtener información de créditos disponibles","+            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());","+            $registro['plan_creditos'] = !is_null($creditos_info) ? $creditos_info : null;","+","             $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';","             array_push($coleccion, $registro);","         }"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"6f89dbb2-ecda-40bc-8752-75a445307555"}
{"parentUuid":"54756340-51da-423d-82b6-2ae3126e618f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UBjZHQKsuoaM8RcGNnGAsL","type":"message","role":"assistant","content":[{"type":"text","text":"El cambio está hecho. Ahora el método `getTodo` agregará el campo `plan_creditos` a cada empresa con esta estructura:\n\n**Cuando la empresa tiene plan con créditos:**\n```json\n\"plan_creditos\": {\n    \"empresa_id\": 2,\n    \"empresa_plan_id\": 2,\n    \"creditos_plan\": 300,\n    \"creditos_disponibles\": 300,\n    \"plan_credito\": {\n        \"id\": 3,\n        \"nombre\": \"Plan 300\",\n        \"creditos\": 300,\n        \"precio\": \"300.00\"\n    }\n}\n```\n\n**Cuando la empresa no tiene plan activo o no tiene créditos:**\n```json\n\"plan_creditos\": null\n```\n\nEl código ya maneja automáticamente el caso donde `plan_credito` es `null` dentro del array (línea 600-605 de `EmpresaPlanService`), por lo que si la empresa tiene plan pero no tiene `planCredito` asociado, retornará:\n\n```json\n\"plan_creditos\": {\n    \"empresa_id\": 2,\n    \"empresa_plan_id\": 2,\n    \"creditos_plan\": 0,\n    \"creditos_disponibles\": 0,\n    \"plan_credito\": null\n}\n```"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":677,"cache_read_input_tokens":47689,"cache_creation":{"ephemeral_5m_input_tokens":677,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXM7NeTUdx4wEio1e8Gdp","type":"assistant","uuid":"1072ddcf-d29a-4566-8fb1-02a9645aba6b","timestamp":"2026-01-21T19:55:17.985Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-21T19:57:32.882Z","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b"}
{"type":"file-history-snapshot","messageId":"ecbe734d-f44a-4880-be08-6dd32555ade3","snapshot":{"messageId":"ecbe734d-f44a-4880-be08-6dd32555ade3","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaService.php":{"backupFileName":"d9f5059823924d08@v2","version":2,"backupTime":"2026-01-21T19:57:34.568Z"}},"timestamp":"2026-01-21T19:57:34.556Z"},"isSnapshotUpdate":false}
{"parentUuid":"b30c8a01-827a-451d-b25c-94bda5d1fae7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01UxLNX6eect5Lay2GkqMFHG","parentToolUseID":"toolu_01UxLNX6eect5Lay2GkqMFHG","uuid":"92021de2-6570-4dbe-8a42-f5b1ca558c04","timestamp":"2026-01-21T19:54:32.476Z"}
{"parentUuid":"6f89dbb2-ecda-40bc-8752-75a445307555","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01YMzpSbo5S4Lg9b6dsLGqTo","parentToolUseID":"toolu_01YMzpSbo5S4Lg9b6dsLGqTo","uuid":"f398b1f0-ed88-4635-9d6d-1c7de5d23d4b","timestamp":"2026-01-21T19:54:41.906Z"}
{"parentUuid":"f398b1f0-ed88-4635-9d6d-1c7de5d23d4b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01YMzpSbo5S4Lg9b6dsLGqTo","parentToolUseID":"toolu_01YMzpSbo5S4Lg9b6dsLGqTo","uuid":"e45fc273-a8fd-424b-bbe4-7ea2c1e2523a","timestamp":"2026-01-21T19:54:41.906Z"}
{"parentUuid":"54756340-51da-423d-82b6-2ae3126e618f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01YMzpSbo5S4Lg9b6dsLGqTo","toolUseID":"toolu_01YMzpSbo5S4Lg9b6dsLGqTo","timestamp":"2026-01-21T19:55:09.877Z","uuid":"94ed7b3e-7ba3-4601-a22d-66ac88a6a413"}
{"parentUuid":"1072ddcf-d29a-4566-8fb1-02a9645aba6b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"user","message":{"role":"user","content":[{"type":"text","text":"me llega asi  \"plan_creditos\": {\n      \"empresa_id\": 1,\n      \"empresa_plan_id\": 1,\n      \"creditos_plan\": 0,\n      \"creditos_disponibles\": 0,\n      \"plan_credito\": null\n    }, pero te comente cuando sea null no me deve de llegar nada me deveria llegar asi \"plan_creditos\": null"}]},"uuid":"ecbe734d-f44a-4880-be08-6dd32555ade3","timestamp":"2026-01-21T19:57:34.553Z"}
{"parentUuid":"ecbe734d-f44a-4880-be08-6dd32555ade3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_016Eu6JRZsErisdyeMj4shHc","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo, quieres que cuando `plan_credito` sea `null`, todo el campo `plan_creditos` sea `null`. Voy a modificar la lógica."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":948,"cache_read_input_tokens":48366,"cache_creation":{"ephemeral_5m_input_tokens":948,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXM7ZBaWnf5dt48SCy6RM","type":"assistant","uuid":"9b418176-dc5c-497a-96e4-cb057b2fafc9","timestamp":"2026-01-21T19:57:37.768Z"}
{"parentUuid":"9b418176-dc5c-497a-96e4-cb057b2fafc9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_016Eu6JRZsErisdyeMj4shHc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B3UNQ8JsQGTuoisPxLG3t7","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","old_string":"            // Obtener información de créditos disponibles\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = !is_null($creditos_info) ? $creditos_info : null;","new_string":"            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = ($creditos_info && !is_null($creditos_info['plan_credito'])) ? $creditos_info : null;"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":948,"cache_read_input_tokens":48366,"cache_creation":{"ephemeral_5m_input_tokens":948,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXM7ZBaWnf5dt48SCy6RM","type":"assistant","uuid":"d88c1f53-44ed-45b7-8184-bc783c6aece1","timestamp":"2026-01-21T19:57:39.973Z"}
{"parentUuid":"d88c1f53-44ed-45b7-8184-bc783c6aece1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B3UNQ8JsQGTuoisPxLG3t7","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   200→                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n   201→                }\n   202→            }\n   203→\n   204→            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)\n   205→            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n   206→            $registro['plan_creditos'] = ($creditos_info && !is_null($creditos_info['plan_credito'])) ? $creditos_info : null;\n   207→\n   208→            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n   209→            array_push($coleccion, $registro);\n   210→        }"}]},"uuid":"3ac306cf-cfa0-42d9-9746-20616f867baa","timestamp":"2026-01-21T19:57:46.037Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","oldString":"            // Obtener información de créditos disponibles\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = !is_null($creditos_info) ? $creditos_info : null;","newString":"            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = ($creditos_info && !is_null($creditos_info['plan_credito'])) ? $creditos_info : null;","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Illuminate\\Support\\Str;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\Response;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse App\\Exports\\Empresas\\HistorialCambiosExport;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\IA\\ServicioIARepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Planes\\ConsumoRepository;\nuse App\\Http\\Repositories\\Empresas\\SectorRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse Symfony\\Component\\HttpFoundation\\StreamedResponse;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse Symfony\\Component\\HttpFoundation\\{BinaryFileResponse};\nuse App\\Http\\Repositories\\Configuraciones\\CiudadRepository;\nuse App\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository;\nuse App\\Http\\Repositories\\Usuarios\\TipoDocumentoRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Politicas\\PoliticaAceptadaRepository;\nuse App\\Jobs\\Configuraciones\\CrearPlantillasPorDefectoEmpresaJob;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionModeloRepository;\n\n/**\n * @property EmpresaRepository $repositorio\n */\nclass EmpresaService extends BaseService\n{\n    use ArchivoTrait;\n\n    private $modelo = 'App\\Models\\Empresas\\Empresa';\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaRepository $repositorio Repositorio de empresas.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param PoliticaAceptadaRepository $politica_aceptada_repositorio Repositorio de políticas aceptadas.\n     * @param CiudadRepository $ciudad_repositorio Repositorio de ciudades.\n     * @param SectorRepository $sector_repositorio Repositorio de sectores.\n     * @param TamanoEmpresaRepository $tamano_empresa_repositorio Repositorio de tamaños de empresas.\n     * @param TipoDocumentoRepository $tipo_documento_repositorio Repositorio de tipos de documentos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param ConfiguracionRepository $configuracion_repositorio Repositorio de configuraciones.\n     * @param ConfiguracionModeloRepository $configuracion_modelo_repositorio Repositorio de configuraciones de modelos.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @param ConsumoRepository $consumo_repositorio Repositorio de consumos.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        EmpresaRepository $repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected PoliticaAceptadaRepository $politica_aceptada_repositorio,\n        protected CiudadRepository $ciudad_repositorio,\n        protected SectorRepository $sector_repositorio,\n        protected TamanoEmpresaRepository $tamano_empresa_repositorio,\n        protected TipoDocumentoRepository $tipo_documento_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected TipoPruebaRepository $tipo_prueba_repositorio,\n        protected EmpresaPlanRepository $empresa_plan_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected ConfiguracionRepository $configuracion_repositorio,\n        protected ConfiguracionModeloRepository $configuracion_modelo_repositorio,\n        protected EmpresaPlanService $empresa_plan_servicio,\n        protected ConsumoRepository $consumo_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected ServicioIARepository $servicio_ia_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Obtener una empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @return Empresa|null\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?Empresa {\n        $empresa = $this->repositorio->getUnoBasico($id);\n\n        if (!is_null($empresa)) {\n            $planes        = [];\n            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n                'empresa_id'         => $id,\n                'con_relaciones'     => true,\n                'validar_relaciones' => true,\n                'en'                 => true,\n                'campo'              => 'rol_id',\n                'valores'            => [\n                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n                    $this->rol_repositorio::ROL_EVALUADOR_ID\n                ]\n            ]));\n\n            $usuarios = $usuarios->map(function ($usuario) {\n                $eliminar = false;\n\n                if (\n                    !$usuario->usuario->tiene_agendas\n                    && !$usuario->usuario->tiene_ofertas_laborales\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_etapa_usuario\n                ) {\n                    $eliminar = true;\n                }\n\n                $usuario->usuario->eliminar = $eliminar;\n                return $usuario;\n            });\n\n            $empresa->planes                         = $planes;\n            $empresa->usuarios                       = $usuarios;\n            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n                'model_type' => $this->modelo,\n                'modelo_id'  => $id\n            ]));\n            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Obtener todas las empresas.\n     *\n     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     */\n    public function getTodo(Request $request): Collection {\n        $empresas      = $this->repositorio->getTodo($request);\n        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n        $coleccion     = [];\n\n        foreach ($empresas as $empresa) {\n            $registro = $empresa;\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n\n                // Obtener el plan activo, si no tiene se obtiene el último plan asignado\n                $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n\n                if (is_null($registro[$llave])) {\n                    $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(new Request([\n                        'empresa_id'             => $empresa->id,\n                        'tipo_prueba_id'         => $tipo_prueba->id,\n                        'excluir_estado_proximo' => true\n                    ]));\n                }\n\n                // Verificar si tiene un plan próximo adicional al plan actual\n                if (!is_null($registro[$llave])) {\n                    $plan_proximo                     = $this->empresa_plan_repositorio->planProximo($empresa->id, $tipo_prueba->id);\n                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n                }\n            }\n\n            // Obtener información de créditos disponibles\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = !is_null($creditos_info) ? $creditos_info : null;\n\n            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);\n        }\n\n        return collect($coleccion);\n    }\n\n    /**\n     * Obtener el porcentaje de creación.\n     *\n     * @param int $id ID de la empresa.\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function obtenerPorcentajeCreacion(int $id): int {\n        $empresa    = $this->repositorio->getUno($id);\n        $porcentaje = 0;\n\n        if (is_null($empresa)) {\n            return $porcentaje;\n        }\n\n        if (!is_null($empresa->empresa_id)) {\n            return $porcentaje;\n        }\n\n        $porcentaje += 10;\n\n        if (count($empresa->archivos) > 0) {\n            $porcentaje += 20;\n        }\n\n        if (count($empresa->usuarios) > 0) {\n            $porcentaje += 10;\n        }\n\n        if (count($empresa->planes) > 0) {\n            $porcentaje += 30;\n        }\n\n        if (count($empresa->usuarios) > 1) {\n            $porcentaje += 30;\n        }\n\n        return $porcentaje;\n    }\n\n    /**\n     * Guardar empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Cuando un usuario que no es superadministrador, intenta modificar una empresa diferente a la que está logueado.\n     * @return Empresa\n     * @author Daniel Beltrán\n     */\n    public function guardar(Request $request): Empresa {\n        $campos_excluidos = ['_token', '_method', 'id', 'pais_id', 'departamento_id', 'digito_verificacion', 'extension', 'extension_tesorero', 'logo', 'empresa_plan_id'];\n\n        if ($request->filled('digito_verificacion')) {\n            $request->merge(['documento' => $request->documento . '-' . $request->digito_verificacion]);\n        }\n\n        if ($request->filled('telefono') && $request->filled('extension')) {\n            $request->merge(['telefono' => $request->telefono . '-' . $request->extension]);\n        }\n\n        if ($request->filled('telefono_tesorero') && $request->filled('extension_tesorero')) {\n            $request->merge(['telefono_tesorero' => $request->telefono_tesorero . '-' . $request->extension_tesorero]);\n        }\n\n        // Agregar datos a la sucursal\n        if ($request->filled('empresa_id')) {\n            $empresa_principal = $this->repositorio->getUno($request->empresa_id);\n\n            if (!is_null($empresa_principal->empresa_id)) {\n                throw new Exception('No se puede crearse una sucursal de otra sucursal');\n            }\n\n            $request->merge([\n                'tamano_empresa_id' => $empresa_principal->tamano_empresa_id,\n                'razon_social'      => $empresa_principal->razon_social\n            ]);\n\n            unset($empresa_principal);\n        }\n\n        if ($request->filled('id')) {\n            $rol_usuario = $this->rol_repositorio->usuarioRolActivo(Auth::id());\n\n            // Validar que solo el superadministrador pueda editar cualquier empresa\n            if ($rol_usuario->id != RolRepository::ROL_SUPERADMIN_ID) {\n                $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n                if ($empresa_usuario->id != $request->empresa_id) {\n                    throw new Exception('No puedes editar una empresa diferente a la que estás logueado', Response::HTTP_FORBIDDEN);\n                }\n            }\n\n            $empresa = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $empresa = $this->repositorio->crear($request->except($campos_excluidos));\n            CrearPlantillasPorDefectoEmpresaJob::dispatch($empresa->id);\n        }\n\n        // Renovación el plan\n        if ($request->filled('empresa_plan_id')) {\n            $this->empresa_plan_servicio->renovar($request->empresa_plan_id);\n        }\n\n        // Guardar el logo de la sucursal\n        if ($request->filled('empresa_id') && $request->filled('logo')) {\n            $this->cambiarLogo($empresa->id, $request->logo);\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Guardar archivos de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function guardarArchivos(int $id, Request $request): void {\n        if ($request->filled('logo')) {\n            $this->cambiarLogo($id, $request->logo);\n        }\n\n        foreach ($request->files->all() as $nombre_archivo_empresa => $archivo_empresa) {\n            $archivo_existente = $this->archivo_repositorio->getUnoAvanzado(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id,\n                'nombre'    => $nombre_archivo_empresa\n            ]));\n\n            if (!is_null($archivo_existente)) {\n                $this->archivo_servicio->eliminarPorModelo($this->modelo, $id, $nombre_archivo_empresa);\n            }\n\n            $ruta = \"private/archivos/empresas/{$id}\";\n            $this->generarDirectorios(\"app/{$ruta}\");\n\n            $nombre_archivo = $this->generarNombreArchivo($archivo_empresa);\n            $this->guardarArchivoEnRuta($archivo_empresa, $ruta, $nombre_archivo);\n\n            $this->archivo_repositorio->crear([\n                'modelo'                  => $this->modelo,\n                'modelo_id'               => $id,\n                'nombre'                  => $nombre_archivo_empresa,\n                'nombre_original_archivo' => $nombre_archivo,\n                'ruta'                    => $ruta . '/' . $nombre_archivo\n            ]);\n        }\n    }\n\n    /**\n     * Eliminar empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa tiene algún registro asociado o está archivada.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function eliminar(int $id): void {\n        $empresa = $this->repositorio->getUnoAvanzado(new Request([\n            'id'                       => $id,\n            'contar_sucursales'        => true,\n            'contar_planes'            => true,\n            'contar_procesos'          => true,\n            'contar_areas'             => true,\n            'contar_perfiles'          => true,\n            'contar_agendas'           => true,\n            'contar_encuestas'         => true,\n            'contar_soportes'          => true,\n            'contar_usuarios'          => true,\n            'contar_ordenes_servicios' => true,\n            'contar_ofertas_laborales' => true,\n            'contar_portales_empleos'  => true\n        ]));\n\n        if ($empresa->activo) {\n            // Validar que no tenga planes\n            if ($empresa->planes_count > 0) {\n                throw new Exception('La empresa tiene planes asignados');\n            }\n\n            // Validar que no tenga sucursales\n            if ($empresa->sucursales_count > 0) {\n                throw new Exception('La empresa tiene sucursales asignadas');\n            }\n\n            // Validar que no tenga procesos\n            if ($empresa->procesos_count > 0) {\n                throw new Exception('La empresa tiene procesos asignados');\n            }\n\n            // Validar que no tenga áreas\n            if ($empresa->areas_count > 0) {\n                throw new Exception('La empresa tiene áreas asignadas');\n            }\n\n            // Validar que no tenga perfiles\n            if ($empresa->perfiles_count > 0) {\n                throw new Exception('La empresa tiene perfiles asignados');\n            }\n\n            // Validar que no tenga agendas\n            if ($empresa->agendas_count > 0) {\n                throw new Exception('La empresa tiene agendas asignadas');\n            }\n\n            // Validar que no tenga encuestas\n            if ($empresa->encuestas_count > 0) {\n                throw new Exception('La empresa tiene encuestas asignadas');\n            }\n\n            // Validar que no tenga soportes\n            if ($empresa->soportes_count > 0) {\n                throw new Exception('La empresa tiene soportes asignados');\n            }\n\n            // Validar que no tenga usuarios\n            if ($empresa->usuarios_count > 0) {\n                throw new Exception('La empresa tiene usuarios asignados');\n            }\n\n            // Validar que no tenga ordenes de servicio\n            if ($empresa->ordenes_servicios_count > 0) {\n                throw new Exception('La empresa tiene ordenes de servicio asignadas');\n            }\n\n            // Validar que no tenga ofertas laborales\n            if ($empresa->ofertas_laborales_count > 0) {\n                throw new Exception('La empresa tiene ofertas laborales asignadas');\n            }\n\n            // Validar que no tenga portales de empleo\n            if ($empresa->portal_empleo_count > 0) {\n                throw new Exception('La empresa tiene portales de empleo asignados');\n            }\n\n            $this->repositorio->sincronizarConfiguraciones($empresa, []);\n            $this->repositorio->eliminar($id);\n        } else {\n            throw new Exception('La empresa está archivada');\n        }\n    }\n\n    /**\n     * Eliminar los usuarios de la empresa junto con sus políticas aceptadas.\n     *\n     * @param Empresa $empresa Empresa.\n     * @param Collection $usuarios Usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function eliminarUsuarios(Empresa $empresa, Collection $usuarios): void {\n        if (count($usuarios) > 0) {\n            foreach ($usuarios as $usuario_empresa) {\n                // Disociar el usuario de la empresa\n                $this->repositorio->disociarUsuario($empresa, $usuario_empresa->id);\n\n                // Disociar las políticas aceptadas del usuario para la empresa\n                $this->politica_aceptada_repositorio->eliminarPorUsuarioYEmpresa($usuario_empresa->id, $empresa->id);\n\n                // Obtener todas las políticas aceptadas del usuario en otras empresas\n                $politicas_otras_empresas = $this->politica_aceptada_repositorio->obtenerPorUsuarioYEmpresasDiferentes($usuario_empresa->id, [$empresa->id]);\n\n                // Obtener los datos del usuario\n                $usuario = $this->usuario_repositorio->getUno($usuario_empresa->id);\n\n                // Validar si el usuario tiene más empresas asociadas y más políticas aceptadas de otras empresas\n                if (count($usuario->empresas) == 0 && count($politicas_otras_empresas) == 0) {\n                    $this->usuario_repositorio->eliminar($usuario_empresa->id);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener el historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return Collection\n     * @author Daniel Beltrán\n     */\n    public function historialCambios(int $id): Collection {\n        $historial       = $this->repositorio->historialCambios($id);\n        $historial_final = [];\n\n        // Obtener los datos referenciados a través de llaves foráneas\n        $ciudades         = $this->obtenerDatosReferenciados($historial, 'ciudad_id', 'ciudades_ids', $this->ciudad_repositorio);\n        $ejecutivos       = $this->obtenerDatosReferenciados($historial, 'ejecutivo_id', 'usuarios_ids', $this->usuario_repositorio);\n        $sectores         = $this->obtenerDatosReferenciados($historial, 'sector_id', 'sectores_ids', $this->sector_repositorio);\n        $tamanos_empresas = $this->obtenerDatosReferenciados($historial, 'tamano_empresa_id', 'tamanos_empresas_ids', $this->tamano_empresa_repositorio);\n        $tipos_documentos = $this->obtenerDatosReferenciados($historial, 'tipo_documento_representante_id', 'tipos_documentos_ids', $this->tipo_documento_repositorio);\n\n        foreach ($historial as $item) {\n            array_push($historial_final, [\n                'id'             => $item->id,\n                'user_type'      => $item->user_type,\n                'user_id'        => $item->user_id,\n                'event'          => $item->event,\n                'auditable_type' => $item->auditable_type,\n                'auditable_id'   => $item->auditable_id,\n                'created_at'     => $item->created_at,\n                'user'           => $item->user,\n                'old_values'     => $this->asignarCambiosHistorial($item->old_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos),\n                'new_values'     => $this->asignarCambiosHistorial($item->new_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos)\n            ]);\n        }\n\n        return collect($historial_final);\n    }\n\n    /**\n     * Asignar los cambios del historial.\n     *\n     * @param array $valores Valores del historial (pueden ser antigüos o nuevos).\n     * @param Collection $ciudades Ciudades.\n     * @param Collection $ejecutivos Ejecutivos.\n     * @param Collection $sectores Sectores.\n     * @param Collection $tamanos_empresas Tamaños de empresas.\n     * @param Collection $tipos_documentos Tipos de documentos.\n     * @return array\n     * @author Daniel Beltrán\n     */\n    private function asignarCambiosHistorial(\n        array $valores,\n        Collection $ciudades,\n        Collection $ejecutivos,\n        Collection $sectores,\n        Collection $tamanos_empresas,\n        Collection $tipos_documentos\n    ): array {\n        $valores_actualizados = [];\n\n        foreach ($valores as $llave => $valor) {\n            $valores_actualizados[$llave] = $valor;\n\n            if ($llave === 'ciudad_id') {\n                $ciudad                       = $ciudades->firstWhere('id', $valor);\n                $valores_actualizados[$llave] = $ciudad->nombre . ', ' . $ciudad->departamento->nombre . ' - ' . $ciudad->departamento->pais->nombre;\n            }\n\n            if ($llave === 'ejecutivo_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $ejecutivos->firstWhere('id', $valor)->nombre_completo : null;\n            }\n\n            if ($llave === 'sector_id') {\n                $valores_actualizados[$llave] = $sectores->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tamano_empresa_id') {\n                $valores_actualizados[$llave] = $tamanos_empresas->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tipo_documento_representante_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $tipos_documentos->firstWhere('id', $valor)->nombre : null;\n            }\n        }\n\n        return $valores_actualizados;\n    }\n\n    /**\n     * Obtener el logo de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa no tiene ningún logo.\n     * @return BinaryFileResponse|StreamedResponse\n     * @author Daniel Beltrán\n     */\n    public function getLogo(int $id): BinaryFileResponse|StreamedResponse {\n        $logo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n        abort_if(is_null($logo), 404, 'Esta empresa no tiene ningún logo');\n        return $this->obtenerArchivoDesdeRuta($logo->ruta);\n    }\n\n    /**\n     * Cambiar el logo de la empresa.\n     *\n     * Elimina el logo actual y guarda el nuevo.\n     *\n     * @param int $id ID de la empresa.\n     * @param string $logo Nuevo logo en base64.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function cambiarLogo(int $id, string $logo): void {\n        $archivo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n\n        if (!is_null($archivo)) {\n            $this->archivo_servicio->eliminar($archivo->id);\n        }\n\n        $this->archivo_servicio->guardarVariosBase64($this->modelo, $id, ['logo' => $logo], 'empresas');\n    }\n\n    /**\n     * Exportar Excel del historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return BinaryFileResponse|Response\n     * @author Daniel Beltrán\n     */\n    public function exportarExcelHistorialCambios(int $id): BinaryFileResponse|Response {\n        $datos = [\n            'historial_cambios' => $this->historialCambios($id),\n            'archivos'          => $this->archivo_repositorio->getTodo(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id\n            ]))\n        ];\n\n        return Excel::download(new HistorialCambiosExport($datos), 'historial-cambios.xlsx');\n    }\n\n    /**\n     * Obtiene el conteo dependiendo de id de empresas planes.\n     *\n     * @param int $empresa_plan_id Id de empresas planes.\n     * @param Request $request Contenido de la petición.\n     * @return int\n     * @author Andres Gonzalez\n     * @author Fahibram Cárcamo\n     */\n    public function conteoConsumo(int $empresa_plan_id, Request $request): int {\n        return $this->consumo_repositorio->getTodo(\n            new Request([\n                'empresa_plan_id' => $empresa_plan_id,\n                'fecha_inicio'    => $request->fecha_inicio,\n                'fecha_fin'       => $request->fecha_fin\n            ])\n        )\n        ->count();\n    }\n\n    /**\n     * Obtiene el resumen para el panel.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function obtenerResumen(Request $request): array {\n        $resumen = $this->repositorio->obtenerResumen($request);\n        $alto    = 0;\n        $normal  = 0;\n        $bajo    = 0;\n\n        $ejecutivos_procesados = [];\n        $planes                = [];\n        $total_precio          = 0;\n        $empresas_asignadas    = 0;\n        $planes_agrupados      = [];\n\n        foreach ($resumen['empresasPlanes'] as $empresa_plan) {\n            $consumo = $this->conteoConsumo($empresa_plan->id, $request);\n\n            if ($consumo > $empresa_plan->unidades) {\n                $alto++;\n            } elseif ($consumo == $empresa_plan->unidades) {\n                $normal++;\n            } else {\n                $bajo++;\n            }\n        }\n\n        $resumen['consumo'] = [\n            'alto'   => $alto,\n            'normal' => $normal,\n            'bajo'   => $bajo,\n        ];\n\n        // Top ejecutivos\n        foreach ($resumen['empresa_ejecutivo'] as $ejecutivo) {\n            $empresas = $this->repositorio->getTodoAgrupadoPlan(new Request([\n                'ejecutivo_id' => $ejecutivo->ejecutivo_id,\n                'fecha_inicio' => $request->fecha_inicio,\n                'fecha_fin'    => $request->fecha_fin,\n            ]));\n\n            foreach ($empresas as $empresa) {\n                foreach ($empresa['empresas_planes'] as $plan) {\n                    $empresas_asignadas++;\n                    $total_precio += $plan['precio'];\n\n                    $planes[] = [\n                        'id'          => $plan['plan']['id'],\n                        'nombre'      => $plan['plan']['nombre'],\n                        'descripcion' => $plan['plan']['descripcion'],\n                        'precio'      => $plan['precio'],\n                        'conteo'      => null\n                    ];\n                }\n            }\n\n            // Agrupa los planes por el id y suma su precio y conteo.\n            foreach ($planes as $plan) {\n                $plan_id = $plan['id'];\n\n                if (!isset($planes_agrupados[$plan_id])) {\n                    $planes_agrupados[$plan_id]           = $plan;\n                    $planes_agrupados[$plan_id]['conteo'] = 1;\n                } else {\n                    $planes_agrupados[$plan_id]['precio'] += $plan['precio'];\n                    $planes_agrupados[$plan_id]['conteo'] += 1;\n                }\n            }\n\n            $planes = array_values($planes_agrupados);\n\n            // Ordena de mayor a menor precio.\n            usort($planes, function ($primero, $segundo) {\n                return $segundo['precio'] <=> $primero['precio'];\n            });\n\n            if ($total_precio > 0) {\n                $ejecutivos_procesados[] = [\n                    'id_ejecutivo'       => $ejecutivo->ejecutivo_id,\n                    'nombre'             => $ejecutivo->ejecutivo->nombre_completo,\n                    'ventas_totales'     => $total_precio,\n                    'empresas_asignadas' => $empresas_asignadas,\n                    'planes'             => $planes,\n                ];\n            }\n\n            // Reiniciar variables.\n            $empresas_asignadas = 0;\n            $total_precio       = 0;\n            $planes             = [];\n            $planes_agrupados   = [];\n        }\n\n        // Ordena de mayor a menor de ventas_totales.\n        usort($ejecutivos_procesados, function ($primero, $segundo) {\n            return $segundo['ventas_totales'] <=> $primero['ventas_totales'];\n        });\n\n        $resumen['ejecutivos'] = $ejecutivos_procesados;\n\n        unset($resumen['empresasPlanes'], $resumen['empresa_ejecutivo']);\n\n        return $resumen;\n    }\n}\n","structuredPatch":[{"oldStart":201,"oldLines":9,"newStart":201,"newLines":9,"lines":["                 }","             }"," ","-            // Obtener información de créditos disponibles","+            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)","             $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());","-            $registro['plan_creditos'] = !is_null($creditos_info) ? $creditos_info : null;","+            $registro['plan_creditos'] = ($creditos_info && !is_null($creditos_info['plan_credito'])) ? $creditos_info : null;"," ","             $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';","             array_push($coleccion, $registro);"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"d88c1f53-44ed-45b7-8184-bc783c6aece1"}
{"parentUuid":"3ac306cf-cfa0-42d9-9746-20616f867baa","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_014CmkEeAeg7BkCWk6yDcexw","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Ahora la lógica es:\n\n- Si `plan_credito` es `null` → `plan_creditos` será `null`\n- Si `plan_credito` tiene datos → `plan_creditos` mostrará toda la información\n\nResultado esperado cuando no hay plan de créditos:\n```json\n\"plan_creditos\": null\n```\n\nResultado cuando sí hay plan de créditos:\n```json\n\"plan_creditos\": {\n    \"empresa_id\": 2,\n    \"empresa_plan_id\": 2,\n    \"creditos_plan\": 300,\n    \"creditos_disponibles\": 300,\n    \"plan_credito\": {\n        \"id\": 3,\n        \"nombre\": \"Plan 300\",\n        \"creditos\": 300,\n        \"precio\": \"300.00\"\n    }\n}\n```"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":768,"cache_read_input_tokens":49314,"cache_creation":{"ephemeral_5m_input_tokens":768,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXM7aA8UkHKSJzQuP4grY","type":"assistant","uuid":"6846752e-1c17-4482-9acb-fb1c9b322811","timestamp":"2026-01-21T19:57:51.926Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-21T20:23:51.084Z","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b"}
{"type":"file-history-snapshot","messageId":"18ee53d2-d41d-4f25-bf30-028595cfe63b","snapshot":{"messageId":"18ee53d2-d41d-4f25-bf30-028595cfe63b","trackedFileBackups":{"app\\Http\\Services\\Empresas\\EmpresaService.php":{"backupFileName":"d9f5059823924d08@v3","version":3,"backupTime":"2026-01-21T20:23:53.574Z"}},"timestamp":"2026-01-21T20:23:53.557Z"},"isSnapshotUpdate":false}
{"parentUuid":"d88c1f53-44ed-45b7-8184-bc783c6aece1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01B3UNQ8JsQGTuoisPxLG3t7","parentToolUseID":"toolu_01B3UNQ8JsQGTuoisPxLG3t7","uuid":"b3f7973d-c043-4d81-8977-66d9ec2fb579","timestamp":"2026-01-21T19:57:40.114Z"}
{"parentUuid":"b3f7973d-c043-4d81-8977-66d9ec2fb579","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01B3UNQ8JsQGTuoisPxLG3t7","parentToolUseID":"toolu_01B3UNQ8JsQGTuoisPxLG3t7","uuid":"d9b295e2-d9d6-4dd5-833f-8760dfdbfb58","timestamp":"2026-01-21T19:57:40.115Z"}
{"parentUuid":"3ac306cf-cfa0-42d9-9746-20616f867baa","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01B3UNQ8JsQGTuoisPxLG3t7","toolUseID":"toolu_01B3UNQ8JsQGTuoisPxLG3t7","timestamp":"2026-01-21T19:57:46.038Z","uuid":"8f10617e-635a-4b5b-ab93-12633ea47e8c"}
{"parentUuid":"6846752e-1c17-4482-9acb-fb1c9b322811","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"listoa esos le tengo que colocar otro campo que dice estado y ese campo es calculado es activo cunado quema el 20 porcineto o mas y hay cmapo que dice criditos disponibles y dentro d eplan credito creditos esoos son los creditos del plan y el otro campo los creditos que tiene diponiuble y esoos creditos dimunuiran entonces cuando le quede el 20 porciento o mal del 20 es activo y esmenos al 20 porciento es estado PRÓXIMO A VENCER y si tiene o en creditos diponibles es vencido"}]},"uuid":"18ee53d2-d41d-4f25-bf30-028595cfe63b","timestamp":"2026-01-21T20:23:53.553Z"}
{"parentUuid":"18ee53d2-d41d-4f25-bf30-028595cfe63b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LVgaVcz8JLBkdbMTK8xCwg","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo, necesitas agregar un campo `estado` calculado basado en el porcentaje de créditos disponibles:\n\n- **Activo**: Cuando tiene >= 20% de créditos disponibles\n- **Próximo a vencer**: Cuando tiene < 20% pero > 0 créditos disponibles  \n- **Vencido**: Cuando tiene 0 créditos disponibles\n\nVoy a modificar el código:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":51301,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":51301,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXM9ZarijQgiyaL87yYvF","type":"assistant","uuid":"a9cdd124-7547-4f2e-b3f2-ad047104bad9","timestamp":"2026-01-21T20:23:58.094Z"}
{"parentUuid":"a9cdd124-7547-4f2e-b3f2-ad047104bad9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LVgaVcz8JLBkdbMTK8xCwg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Gj5F3ji3DQPGYSaRK7Zfrv","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","old_string":"            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = ($creditos_info && !is_null($creditos_info['plan_credito'])) ? $creditos_info : null;","new_string":"            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n\n            if ($creditos_info && !is_null($creditos_info['plan_credito'])) {\n                $creditos_plan       = $creditos_info['plan_credito']['creditos'];\n                $creditos_disponibles = $creditos_info['creditos_disponibles'];\n\n                // Calcular estado basado en porcentaje de créditos disponibles\n                if ($creditos_disponibles <= 0) {\n                    $estado = 'Vencido';\n                } elseif ($creditos_plan > 0 && ($creditos_disponibles / $creditos_plan) * 100 < 20) {\n                    $estado = 'Próximo a vencer';\n                } else {\n                    $estado = 'Activo';\n                }\n\n                $creditos_info['estado'] = $estado;\n                $registro['plan_creditos'] = $creditos_info;\n            } else {\n                $registro['plan_creditos'] = null;\n            }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":51301,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":51301,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXM9ZarijQgiyaL87yYvF","type":"assistant","uuid":"81ea37a6-15ed-4f05-8dc3-f6c228d75970","timestamp":"2026-01-21T20:24:02.189Z"}
{"parentUuid":"81ea37a6-15ed-4f05-8dc3-f6c228d75970","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Gj5F3ji3DQPGYSaRK7Zfrv","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   201→                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n   202→                }\n   203→            }\n   204→\n   205→            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)\n   206→            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n   207→\n   208→            if ($creditos_info && !is_null($creditos_info['plan_credito'])) {\n   209→                $creditos_plan       = $creditos_info['plan_credito']['creditos'];\n   210→                $creditos_disponibles = $creditos_info['creditos_disponibles'];\n   211→\n   212→                // Calcular estado basado en porcentaje de créditos disponibles\n   213→                if ($creditos_disponibles <= 0) {\n   214→                    $estado = 'Vencido';\n   215→                } elseif ($creditos_plan > 0 && ($creditos_disponibles / $creditos_plan) * 100 < 20) {\n   216→                    $estado = 'Próximo a vencer';\n   217→                } else {\n   218→                    $estado = 'Activo';\n   219→                }\n   220→\n   221→                $creditos_info['estado'] = $estado;\n   222→                $registro['plan_creditos'] = $creditos_info;\n   223→            } else {\n   224→                $registro['plan_creditos'] = null;\n   225→            }\n   226→\n   227→            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n   228→            array_push($coleccion, $registro);\n   229→        }"}]},"uuid":"575704a9-dcdb-40cd-aac2-6df90f7d8920","timestamp":"2026-01-21T20:24:07.721Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Empresas\\EmpresaService.php","oldString":"            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = ($creditos_info && !is_null($creditos_info['plan_credito'])) ? $creditos_info : null;","newString":"            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n\n            if ($creditos_info && !is_null($creditos_info['plan_credito'])) {\n                $creditos_plan       = $creditos_info['plan_credito']['creditos'];\n                $creditos_disponibles = $creditos_info['creditos_disponibles'];\n\n                // Calcular estado basado en porcentaje de créditos disponibles\n                if ($creditos_disponibles <= 0) {\n                    $estado = 'Vencido';\n                } elseif ($creditos_plan > 0 && ($creditos_disponibles / $creditos_plan) * 100 < 20) {\n                    $estado = 'Próximo a vencer';\n                } else {\n                    $estado = 'Activo';\n                }\n\n                $creditos_info['estado'] = $estado;\n                $registro['plan_creditos'] = $creditos_info;\n            } else {\n                $registro['plan_creditos'] = null;\n            }","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Empresas;\n\nuse Exception;\nuse Illuminate\\Support\\Str;\nuse App\\Traits\\ArchivoTrait;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\Response;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Http\\Services\\BaseService;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse App\\Exports\\Empresas\\HistorialCambiosExport;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\IA\\ServicioIARepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Planes\\ConsumoRepository;\nuse App\\Http\\Repositories\\Empresas\\SectorRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse App\\Http\\Services\\Configuraciones\\ArchivoService;\nuse Symfony\\Component\\HttpFoundation\\StreamedResponse;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse Symfony\\Component\\HttpFoundation\\{BinaryFileResponse};\nuse App\\Http\\Repositories\\Configuraciones\\CiudadRepository;\nuse App\\Http\\Repositories\\Empresas\\TamanoEmpresaRepository;\nuse App\\Http\\Repositories\\Usuarios\\TipoDocumentoRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Repositories\\Politicas\\PoliticaAceptadaRepository;\nuse App\\Jobs\\Configuraciones\\CrearPlantillasPorDefectoEmpresaJob;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ConfiguracionModeloRepository;\n\n/**\n * @property EmpresaRepository $repositorio\n */\nclass EmpresaService extends BaseService\n{\n    use ArchivoTrait;\n\n    private $modelo = 'App\\Models\\Empresas\\Empresa';\n\n    /**\n     * Constructor.\n     *\n     * @param EmpresaRepository $repositorio Repositorio de empresas.\n     * @param ArchivoService $archivo_servicio Servicio de archivos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param PoliticaAceptadaRepository $politica_aceptada_repositorio Repositorio de políticas aceptadas.\n     * @param CiudadRepository $ciudad_repositorio Repositorio de ciudades.\n     * @param SectorRepository $sector_repositorio Repositorio de sectores.\n     * @param TamanoEmpresaRepository $tamano_empresa_repositorio Repositorio de tamaños de empresas.\n     * @param TipoDocumentoRepository $tipo_documento_repositorio Repositorio de tipos de documentos.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n     * @param EmpresaPlanRepository $empresa_plan_repositorio Repositorio de planes de empresas.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param ConfiguracionRepository $configuracion_repositorio Repositorio de configuraciones.\n     * @param ConfiguracionModeloRepository $configuracion_modelo_repositorio Repositorio de configuraciones de modelos.\n     * @param EmpresaPlanService $empresa_plan_servicio Servicio de planes de empresas.\n     * @param ConsumoRepository $consumo_repositorio Repositorio de consumos.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param ServicioIARepository $servicio_ia_repositorio Repositorio de servicios IA.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        EmpresaRepository $repositorio,\n        protected ArchivoService $archivo_servicio,\n        protected UserRepository $usuario_repositorio,\n        protected PoliticaAceptadaRepository $politica_aceptada_repositorio,\n        protected CiudadRepository $ciudad_repositorio,\n        protected SectorRepository $sector_repositorio,\n        protected TamanoEmpresaRepository $tamano_empresa_repositorio,\n        protected TipoDocumentoRepository $tipo_documento_repositorio,\n        protected ArchivoRepository $archivo_repositorio,\n        protected TipoPruebaRepository $tipo_prueba_repositorio,\n        protected EmpresaPlanRepository $empresa_plan_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected ConfiguracionRepository $configuracion_repositorio,\n        protected ConfiguracionModeloRepository $configuracion_modelo_repositorio,\n        protected EmpresaPlanService $empresa_plan_servicio,\n        protected ConsumoRepository $consumo_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected ServicioIARepository $servicio_ia_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Obtener una empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @return Empresa|null\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function getUno(int $id): ?Empresa {\n        $empresa = $this->repositorio->getUnoBasico($id);\n\n        if (!is_null($empresa)) {\n            $planes        = [];\n            $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $plan = $this->empresa_plan_servicio->obtenerPlanActivo($id, $tipo_prueba->id)\n                    ?? $this->empresa_plan_servicio->obtenerUltimoPorTipo($id, $tipo_prueba->id);\n\n                if (!is_null($plan)) {\n                    array_push($planes, $plan);\n                }\n            }\n\n            $usuarios = $this->empresa_usuario_repositorio->getTodo(new Request([\n                'empresa_id'         => $id,\n                'con_relaciones'     => true,\n                'validar_relaciones' => true,\n                'en'                 => true,\n                'campo'              => 'rol_id',\n                'valores'            => [\n                    $this->rol_repositorio::ROL_SUPERADMIN_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_ID,\n                    $this->rol_repositorio::ROL_CONTROLADOR_ID,\n                    $this->rol_repositorio::ROL_PROPIETARIO_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_GENERAL_ID,\n                    $this->rol_repositorio::ROL_ADMINISTRADOR_SUCURSAL_ID,\n                    $this->rol_repositorio::ROL_EVALUADOR_ID\n                ]\n            ]));\n\n            $usuarios = $usuarios->map(function ($usuario) {\n                $eliminar = false;\n\n                if (\n                    !$usuario->usuario->tiene_agendas\n                    && !$usuario->usuario->tiene_ofertas_laborales\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_procesos\n                    && !$usuario->usuario->tiene_etapa_usuario\n                ) {\n                    $eliminar = true;\n                }\n\n                $usuario->usuario->eliminar = $eliminar;\n                return $usuario;\n            });\n\n            $empresa->planes                         = $planes;\n            $empresa->usuarios                       = $usuarios;\n            $empresa->configuraciones_defecto        = $this->configuracion_repositorio->getTodo(new Request(['modelo' => $this->modelo]));\n            $empresa->configuraciones_personalizadas = $this->configuracion_modelo_repositorio->getTodo(new Request([\n                'model_type' => $this->modelo,\n                'modelo_id'  => $id\n            ]));\n            $empresa->creditos_promedio_accion = $this->servicio_ia_repositorio->obtenerPromedioCreditos();\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Obtener todas las empresas.\n     *\n     * Obtiene todas las empresas y les agrega información de los últimos planes que han tenido por cada tipo de prueba excluyendo los planes en estado próximo.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return Collection\n     * @author Daniel Beltrán\n     * @author Andres Gonzalez\n     */\n    public function getTodo(Request $request): Collection {\n        $empresas      = $this->repositorio->getTodo($request);\n        $tipos_pruebas = $this->tipo_prueba_repositorio->getTodo(new Request());\n        $coleccion     = [];\n\n        foreach ($empresas as $empresa) {\n            $registro = $empresa;\n\n            foreach ($tipos_pruebas as $tipo_prueba) {\n                $llave = 'plan_' . Str::slug($tipo_prueba->nombre, '_');\n\n                // Obtener el plan activo, si no tiene se obtiene el último plan asignado\n                $registro[$llave] = $this->empresa_plan_repositorio->planActivo($empresa->id, $tipo_prueba->id);\n\n                if (is_null($registro[$llave])) {\n                    $registro[$llave] = $this->empresa_plan_repositorio->ultimoPlanAsignado(new Request([\n                        'empresa_id'             => $empresa->id,\n                        'tipo_prueba_id'         => $tipo_prueba->id,\n                        'excluir_estado_proximo' => true\n                    ]));\n                }\n\n                // Verificar si tiene un plan próximo adicional al plan actual\n                if (!is_null($registro[$llave])) {\n                    $plan_proximo                     = $this->empresa_plan_repositorio->planProximo($empresa->id, $tipo_prueba->id);\n                    $registro[$llave]['plan_proximo'] = !is_null($plan_proximo) && $registro[$llave]->id !== $plan_proximo->id;\n                }\n            }\n\n            // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)\n            $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());\n            $registro['plan_creditos'] = ($creditos_info && !is_null($creditos_info['plan_credito'])) ? $creditos_info : null;\n\n            $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';\n            array_push($coleccion, $registro);\n        }\n\n        return collect($coleccion);\n    }\n\n    /**\n     * Obtener el porcentaje de creación.\n     *\n     * @param int $id ID de la empresa.\n     * @return int\n     * @author Daniel Beltrán\n     */\n    public function obtenerPorcentajeCreacion(int $id): int {\n        $empresa    = $this->repositorio->getUno($id);\n        $porcentaje = 0;\n\n        if (is_null($empresa)) {\n            return $porcentaje;\n        }\n\n        if (!is_null($empresa->empresa_id)) {\n            return $porcentaje;\n        }\n\n        $porcentaje += 10;\n\n        if (count($empresa->archivos) > 0) {\n            $porcentaje += 20;\n        }\n\n        if (count($empresa->usuarios) > 0) {\n            $porcentaje += 10;\n        }\n\n        if (count($empresa->planes) > 0) {\n            $porcentaje += 30;\n        }\n\n        if (count($empresa->usuarios) > 1) {\n            $porcentaje += 30;\n        }\n\n        return $porcentaje;\n    }\n\n    /**\n     * Guardar empresa.\n     *\n     * @param Request $request Contenido de la petición.\n     * @throws Exception Cuando un usuario que no es superadministrador, intenta modificar una empresa diferente a la que está logueado.\n     * @return Empresa\n     * @author Daniel Beltrán\n     */\n    public function guardar(Request $request): Empresa {\n        $campos_excluidos = ['_token', '_method', 'id', 'pais_id', 'departamento_id', 'digito_verificacion', 'extension', 'extension_tesorero', 'logo', 'empresa_plan_id'];\n\n        if ($request->filled('digito_verificacion')) {\n            $request->merge(['documento' => $request->documento . '-' . $request->digito_verificacion]);\n        }\n\n        if ($request->filled('telefono') && $request->filled('extension')) {\n            $request->merge(['telefono' => $request->telefono . '-' . $request->extension]);\n        }\n\n        if ($request->filled('telefono_tesorero') && $request->filled('extension_tesorero')) {\n            $request->merge(['telefono_tesorero' => $request->telefono_tesorero . '-' . $request->extension_tesorero]);\n        }\n\n        // Agregar datos a la sucursal\n        if ($request->filled('empresa_id')) {\n            $empresa_principal = $this->repositorio->getUno($request->empresa_id);\n\n            if (!is_null($empresa_principal->empresa_id)) {\n                throw new Exception('No se puede crearse una sucursal de otra sucursal');\n            }\n\n            $request->merge([\n                'tamano_empresa_id' => $empresa_principal->tamano_empresa_id,\n                'razon_social'      => $empresa_principal->razon_social\n            ]);\n\n            unset($empresa_principal);\n        }\n\n        if ($request->filled('id')) {\n            $rol_usuario = $this->rol_repositorio->usuarioRolActivo(Auth::id());\n\n            // Validar que solo el superadministrador pueda editar cualquier empresa\n            if ($rol_usuario->id != RolRepository::ROL_SUPERADMIN_ID) {\n                $empresa_usuario = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n                if ($empresa_usuario->id != $request->empresa_id) {\n                    throw new Exception('No puedes editar una empresa diferente a la que estás logueado', Response::HTTP_FORBIDDEN);\n                }\n            }\n\n            $empresa = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n        } else {\n            $empresa = $this->repositorio->crear($request->except($campos_excluidos));\n            CrearPlantillasPorDefectoEmpresaJob::dispatch($empresa->id);\n        }\n\n        // Renovación el plan\n        if ($request->filled('empresa_plan_id')) {\n            $this->empresa_plan_servicio->renovar($request->empresa_plan_id);\n        }\n\n        // Guardar el logo de la sucursal\n        if ($request->filled('empresa_id') && $request->filled('logo')) {\n            $this->cambiarLogo($empresa->id, $request->logo);\n        }\n\n        return $empresa;\n    }\n\n    /**\n     * Guardar archivos de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function guardarArchivos(int $id, Request $request): void {\n        if ($request->filled('logo')) {\n            $this->cambiarLogo($id, $request->logo);\n        }\n\n        foreach ($request->files->all() as $nombre_archivo_empresa => $archivo_empresa) {\n            $archivo_existente = $this->archivo_repositorio->getUnoAvanzado(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id,\n                'nombre'    => $nombre_archivo_empresa\n            ]));\n\n            if (!is_null($archivo_existente)) {\n                $this->archivo_servicio->eliminarPorModelo($this->modelo, $id, $nombre_archivo_empresa);\n            }\n\n            $ruta = \"private/archivos/empresas/{$id}\";\n            $this->generarDirectorios(\"app/{$ruta}\");\n\n            $nombre_archivo = $this->generarNombreArchivo($archivo_empresa);\n            $this->guardarArchivoEnRuta($archivo_empresa, $ruta, $nombre_archivo);\n\n            $this->archivo_repositorio->crear([\n                'modelo'                  => $this->modelo,\n                'modelo_id'               => $id,\n                'nombre'                  => $nombre_archivo_empresa,\n                'nombre_original_archivo' => $nombre_archivo,\n                'ruta'                    => $ruta . '/' . $nombre_archivo\n            ]);\n        }\n    }\n\n    /**\n     * Eliminar empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa tiene algún registro asociado o está archivada.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function eliminar(int $id): void {\n        $empresa = $this->repositorio->getUnoAvanzado(new Request([\n            'id'                       => $id,\n            'contar_sucursales'        => true,\n            'contar_planes'            => true,\n            'contar_procesos'          => true,\n            'contar_areas'             => true,\n            'contar_perfiles'          => true,\n            'contar_agendas'           => true,\n            'contar_encuestas'         => true,\n            'contar_soportes'          => true,\n            'contar_usuarios'          => true,\n            'contar_ordenes_servicios' => true,\n            'contar_ofertas_laborales' => true,\n            'contar_portales_empleos'  => true\n        ]));\n\n        if ($empresa->activo) {\n            // Validar que no tenga planes\n            if ($empresa->planes_count > 0) {\n                throw new Exception('La empresa tiene planes asignados');\n            }\n\n            // Validar que no tenga sucursales\n            if ($empresa->sucursales_count > 0) {\n                throw new Exception('La empresa tiene sucursales asignadas');\n            }\n\n            // Validar que no tenga procesos\n            if ($empresa->procesos_count > 0) {\n                throw new Exception('La empresa tiene procesos asignados');\n            }\n\n            // Validar que no tenga áreas\n            if ($empresa->areas_count > 0) {\n                throw new Exception('La empresa tiene áreas asignadas');\n            }\n\n            // Validar que no tenga perfiles\n            if ($empresa->perfiles_count > 0) {\n                throw new Exception('La empresa tiene perfiles asignados');\n            }\n\n            // Validar que no tenga agendas\n            if ($empresa->agendas_count > 0) {\n                throw new Exception('La empresa tiene agendas asignadas');\n            }\n\n            // Validar que no tenga encuestas\n            if ($empresa->encuestas_count > 0) {\n                throw new Exception('La empresa tiene encuestas asignadas');\n            }\n\n            // Validar que no tenga soportes\n            if ($empresa->soportes_count > 0) {\n                throw new Exception('La empresa tiene soportes asignados');\n            }\n\n            // Validar que no tenga usuarios\n            if ($empresa->usuarios_count > 0) {\n                throw new Exception('La empresa tiene usuarios asignados');\n            }\n\n            // Validar que no tenga ordenes de servicio\n            if ($empresa->ordenes_servicios_count > 0) {\n                throw new Exception('La empresa tiene ordenes de servicio asignadas');\n            }\n\n            // Validar que no tenga ofertas laborales\n            if ($empresa->ofertas_laborales_count > 0) {\n                throw new Exception('La empresa tiene ofertas laborales asignadas');\n            }\n\n            // Validar que no tenga portales de empleo\n            if ($empresa->portal_empleo_count > 0) {\n                throw new Exception('La empresa tiene portales de empleo asignados');\n            }\n\n            $this->repositorio->sincronizarConfiguraciones($empresa, []);\n            $this->repositorio->eliminar($id);\n        } else {\n            throw new Exception('La empresa está archivada');\n        }\n    }\n\n    /**\n     * Eliminar los usuarios de la empresa junto con sus políticas aceptadas.\n     *\n     * @param Empresa $empresa Empresa.\n     * @param Collection $usuarios Usuarios.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function eliminarUsuarios(Empresa $empresa, Collection $usuarios): void {\n        if (count($usuarios) > 0) {\n            foreach ($usuarios as $usuario_empresa) {\n                // Disociar el usuario de la empresa\n                $this->repositorio->disociarUsuario($empresa, $usuario_empresa->id);\n\n                // Disociar las políticas aceptadas del usuario para la empresa\n                $this->politica_aceptada_repositorio->eliminarPorUsuarioYEmpresa($usuario_empresa->id, $empresa->id);\n\n                // Obtener todas las políticas aceptadas del usuario en otras empresas\n                $politicas_otras_empresas = $this->politica_aceptada_repositorio->obtenerPorUsuarioYEmpresasDiferentes($usuario_empresa->id, [$empresa->id]);\n\n                // Obtener los datos del usuario\n                $usuario = $this->usuario_repositorio->getUno($usuario_empresa->id);\n\n                // Validar si el usuario tiene más empresas asociadas y más políticas aceptadas de otras empresas\n                if (count($usuario->empresas) == 0 && count($politicas_otras_empresas) == 0) {\n                    $this->usuario_repositorio->eliminar($usuario_empresa->id);\n                }\n            }\n        }\n    }\n\n    /**\n     * Obtener el historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return Collection\n     * @author Daniel Beltrán\n     */\n    public function historialCambios(int $id): Collection {\n        $historial       = $this->repositorio->historialCambios($id);\n        $historial_final = [];\n\n        // Obtener los datos referenciados a través de llaves foráneas\n        $ciudades         = $this->obtenerDatosReferenciados($historial, 'ciudad_id', 'ciudades_ids', $this->ciudad_repositorio);\n        $ejecutivos       = $this->obtenerDatosReferenciados($historial, 'ejecutivo_id', 'usuarios_ids', $this->usuario_repositorio);\n        $sectores         = $this->obtenerDatosReferenciados($historial, 'sector_id', 'sectores_ids', $this->sector_repositorio);\n        $tamanos_empresas = $this->obtenerDatosReferenciados($historial, 'tamano_empresa_id', 'tamanos_empresas_ids', $this->tamano_empresa_repositorio);\n        $tipos_documentos = $this->obtenerDatosReferenciados($historial, 'tipo_documento_representante_id', 'tipos_documentos_ids', $this->tipo_documento_repositorio);\n\n        foreach ($historial as $item) {\n            array_push($historial_final, [\n                'id'             => $item->id,\n                'user_type'      => $item->user_type,\n                'user_id'        => $item->user_id,\n                'event'          => $item->event,\n                'auditable_type' => $item->auditable_type,\n                'auditable_id'   => $item->auditable_id,\n                'created_at'     => $item->created_at,\n                'user'           => $item->user,\n                'old_values'     => $this->asignarCambiosHistorial($item->old_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos),\n                'new_values'     => $this->asignarCambiosHistorial($item->new_values, $ciudades, $ejecutivos, $sectores, $tamanos_empresas, $tipos_documentos)\n            ]);\n        }\n\n        return collect($historial_final);\n    }\n\n    /**\n     * Asignar los cambios del historial.\n     *\n     * @param array $valores Valores del historial (pueden ser antigüos o nuevos).\n     * @param Collection $ciudades Ciudades.\n     * @param Collection $ejecutivos Ejecutivos.\n     * @param Collection $sectores Sectores.\n     * @param Collection $tamanos_empresas Tamaños de empresas.\n     * @param Collection $tipos_documentos Tipos de documentos.\n     * @return array\n     * @author Daniel Beltrán\n     */\n    private function asignarCambiosHistorial(\n        array $valores,\n        Collection $ciudades,\n        Collection $ejecutivos,\n        Collection $sectores,\n        Collection $tamanos_empresas,\n        Collection $tipos_documentos\n    ): array {\n        $valores_actualizados = [];\n\n        foreach ($valores as $llave => $valor) {\n            $valores_actualizados[$llave] = $valor;\n\n            if ($llave === 'ciudad_id') {\n                $ciudad                       = $ciudades->firstWhere('id', $valor);\n                $valores_actualizados[$llave] = $ciudad->nombre . ', ' . $ciudad->departamento->nombre . ' - ' . $ciudad->departamento->pais->nombre;\n            }\n\n            if ($llave === 'ejecutivo_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $ejecutivos->firstWhere('id', $valor)->nombre_completo : null;\n            }\n\n            if ($llave === 'sector_id') {\n                $valores_actualizados[$llave] = $sectores->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tamano_empresa_id') {\n                $valores_actualizados[$llave] = $tamanos_empresas->firstWhere('id', $valor)->nombre;\n            }\n\n            if ($llave === 'tipo_documento_representante_id') {\n                $valores_actualizados[$llave] = !is_null($valor) ? $tipos_documentos->firstWhere('id', $valor)->nombre : null;\n            }\n        }\n\n        return $valores_actualizados;\n    }\n\n    /**\n     * Obtener el logo de la empresa.\n     *\n     * @param int $id ID de la empresa.\n     * @throws Exception Cuando la empresa no tiene ningún logo.\n     * @return BinaryFileResponse|StreamedResponse\n     * @author Daniel Beltrán\n     */\n    public function getLogo(int $id): BinaryFileResponse|StreamedResponse {\n        $logo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n        abort_if(is_null($logo), 404, 'Esta empresa no tiene ningún logo');\n        return $this->obtenerArchivoDesdeRuta($logo->ruta);\n    }\n\n    /**\n     * Cambiar el logo de la empresa.\n     *\n     * Elimina el logo actual y guarda el nuevo.\n     *\n     * @param int $id ID de la empresa.\n     * @param string $logo Nuevo logo en base64.\n     * @return void\n     * @author Daniel Beltrán\n     */\n    public function cambiarLogo(int $id, string $logo): void {\n        $archivo = $this->archivo_repositorio->obtenerPorModelo($this->modelo, $id, 'logo');\n\n        if (!is_null($archivo)) {\n            $this->archivo_servicio->eliminar($archivo->id);\n        }\n\n        $this->archivo_servicio->guardarVariosBase64($this->modelo, $id, ['logo' => $logo], 'empresas');\n    }\n\n    /**\n     * Exportar Excel del historial de cambios.\n     *\n     * @param int $id ID de la empresa.\n     * @return BinaryFileResponse|Response\n     * @author Daniel Beltrán\n     */\n    public function exportarExcelHistorialCambios(int $id): BinaryFileResponse|Response {\n        $datos = [\n            'historial_cambios' => $this->historialCambios($id),\n            'archivos'          => $this->archivo_repositorio->getTodo(new Request([\n                'modelo'    => $this->modelo,\n                'modelo_id' => $id\n            ]))\n        ];\n\n        return Excel::download(new HistorialCambiosExport($datos), 'historial-cambios.xlsx');\n    }\n\n    /**\n     * Obtiene el conteo dependiendo de id de empresas planes.\n     *\n     * @param int $empresa_plan_id Id de empresas planes.\n     * @param Request $request Contenido de la petición.\n     * @return int\n     * @author Andres Gonzalez\n     * @author Fahibram Cárcamo\n     */\n    public function conteoConsumo(int $empresa_plan_id, Request $request): int {\n        return $this->consumo_repositorio->getTodo(\n            new Request([\n                'empresa_plan_id' => $empresa_plan_id,\n                'fecha_inicio'    => $request->fecha_inicio,\n                'fecha_fin'       => $request->fecha_fin\n            ])\n        )\n        ->count();\n    }\n\n    /**\n     * Obtiene el resumen para el panel.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return array\n     * @author Andres Gonzalez\n     */\n    public function obtenerResumen(Request $request): array {\n        $resumen = $this->repositorio->obtenerResumen($request);\n        $alto    = 0;\n        $normal  = 0;\n        $bajo    = 0;\n\n        $ejecutivos_procesados = [];\n        $planes                = [];\n        $total_precio          = 0;\n        $empresas_asignadas    = 0;\n        $planes_agrupados      = [];\n\n        foreach ($resumen['empresasPlanes'] as $empresa_plan) {\n            $consumo = $this->conteoConsumo($empresa_plan->id, $request);\n\n            if ($consumo > $empresa_plan->unidades) {\n                $alto++;\n            } elseif ($consumo == $empresa_plan->unidades) {\n                $normal++;\n            } else {\n                $bajo++;\n            }\n        }\n\n        $resumen['consumo'] = [\n            'alto'   => $alto,\n            'normal' => $normal,\n            'bajo'   => $bajo,\n        ];\n\n        // Top ejecutivos\n        foreach ($resumen['empresa_ejecutivo'] as $ejecutivo) {\n            $empresas = $this->repositorio->getTodoAgrupadoPlan(new Request([\n                'ejecutivo_id' => $ejecutivo->ejecutivo_id,\n                'fecha_inicio' => $request->fecha_inicio,\n                'fecha_fin'    => $request->fecha_fin,\n            ]));\n\n            foreach ($empresas as $empresa) {\n                foreach ($empresa['empresas_planes'] as $plan) {\n                    $empresas_asignadas++;\n                    $total_precio += $plan['precio'];\n\n                    $planes[] = [\n                        'id'          => $plan['plan']['id'],\n                        'nombre'      => $plan['plan']['nombre'],\n                        'descripcion' => $plan['plan']['descripcion'],\n                        'precio'      => $plan['precio'],\n                        'conteo'      => null\n                    ];\n                }\n            }\n\n            // Agrupa los planes por el id y suma su precio y conteo.\n            foreach ($planes as $plan) {\n                $plan_id = $plan['id'];\n\n                if (!isset($planes_agrupados[$plan_id])) {\n                    $planes_agrupados[$plan_id]           = $plan;\n                    $planes_agrupados[$plan_id]['conteo'] = 1;\n                } else {\n                    $planes_agrupados[$plan_id]['precio'] += $plan['precio'];\n                    $planes_agrupados[$plan_id]['conteo'] += 1;\n                }\n            }\n\n            $planes = array_values($planes_agrupados);\n\n            // Ordena de mayor a menor precio.\n            usort($planes, function ($primero, $segundo) {\n                return $segundo['precio'] <=> $primero['precio'];\n            });\n\n            if ($total_precio > 0) {\n                $ejecutivos_procesados[] = [\n                    'id_ejecutivo'       => $ejecutivo->ejecutivo_id,\n                    'nombre'             => $ejecutivo->ejecutivo->nombre_completo,\n                    'ventas_totales'     => $total_precio,\n                    'empresas_asignadas' => $empresas_asignadas,\n                    'planes'             => $planes,\n                ];\n            }\n\n            // Reiniciar variables.\n            $empresas_asignadas = 0;\n            $total_precio       = 0;\n            $planes             = [];\n            $planes_agrupados   = [];\n        }\n\n        // Ordena de mayor a menor de ventas_totales.\n        usort($ejecutivos_procesados, function ($primero, $segundo) {\n            return $segundo['ventas_totales'] <=> $primero['ventas_totales'];\n        });\n\n        $resumen['ejecutivos'] = $ejecutivos_procesados;\n\n        unset($resumen['empresasPlanes'], $resumen['empresa_ejecutivo']);\n\n        return $resumen;\n    }\n}\n","structuredPatch":[{"oldStart":204,"oldLines":8,"newStart":204,"newLines":26,"lines":[" ","             // Obtener información de créditos disponibles (solo si tiene plan_credito asignado)","             $creditos_info = $this->empresa_plan_servicio->creditosDisponiblesEmpresa($empresa->id, new Request());","-            $registro['plan_creditos'] = ($creditos_info && !is_null($creditos_info['plan_credito'])) ? $creditos_info : null;"," ","+            if ($creditos_info && !is_null($creditos_info['plan_credito'])) {","+                $creditos_plan       = $creditos_info['plan_credito']['creditos'];","+                $creditos_disponibles = $creditos_info['creditos_disponibles'];","+","+                // Calcular estado basado en porcentaje de créditos disponibles","+                if ($creditos_disponibles <= 0) {","+                    $estado = 'Vencido';","+                } elseif ($creditos_plan > 0 && ($creditos_disponibles / $creditos_plan) * 100 < 20) {","+                    $estado = 'Próximo a vencer';","+                } else {","+                    $estado = 'Activo';","+                }","+","+                $creditos_info['estado'] = $estado;","+                $registro['plan_creditos'] = $creditos_info;","+            } else {","+                $registro['plan_creditos'] = null;","+            }","+","             $registro['porcentaje_creacion'] = $this->obtenerPorcentajeCreacion($empresa->id) . '%';","             array_push($coleccion, $registro);","         }"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"81ea37a6-15ed-4f05-8dc3-f6c228d75970"}
{"parentUuid":"575704a9-dcdb-40cd-aac2-6df90f7d8920","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"fda6f005-ef76-4714-b201-82e9cf20839b","version":"2.1.11","gitBranch":"D26-260","slug":"eager-toasting-flame","message":{"model":"claude-opus-4-5-20251101","id":"msg_0194ixw28vB3AwHjRVbYgYDN","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Ahora el resultado será:\n\n**Con plan de créditos:**\n```json\n\"plan_creditos\": {\n    \"empresa_id\": 2,\n    \"empresa_plan_id\": 2,\n    \"creditos_plan\": 300,\n    \"creditos_disponibles\": 250,\n    \"plan_credito\": {\n        \"id\": 3,\n        \"nombre\": \"Plan 300\",\n        \"creditos\": 300,\n        \"precio\": \"300.00\"\n    },\n    \"estado\": \"Activo\"\n}\n```\n\n**Lógica del estado:**\n\n| Condición | Estado |\n|-----------|--------|\n| `creditos_disponibles = 0` | Vencido |\n| `creditos_disponibles / creditos_plan < 20%` | Próximo a vencer |\n| `creditos_disponibles / creditos_plan >= 20%` | Activo |\n\n**Sin plan de créditos:**\n```json\n\"plan_creditos\": null\n```"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1208,"cache_read_input_tokens":51301,"cache_creation":{"ephemeral_5m_input_tokens":1208,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXM9akc8UXoz3DbdRr5H4","type":"assistant","uuid":"967af050-1f82-4e65-a52a-df48ceda4aaf","timestamp":"2026-01-21T20:24:14.263Z"}

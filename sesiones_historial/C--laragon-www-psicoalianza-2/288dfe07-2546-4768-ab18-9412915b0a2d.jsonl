{"type":"queue-operation","operation":"dequeue","timestamp":"2026-02-06T19:02:55.370Z","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d"}
{"type":"file-history-snapshot","messageId":"2201fd02-aff6-47d7-8708-201469ca57f6","snapshot":{"messageId":"2201fd02-aff6-47d7-8708-201469ca57f6","trackedFileBackups":{},"timestamp":"2026-02-06T19:02:55.462Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 722 to 727 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Procesos\\ProcesoController.php:\n// Cargar participantes del proceso con sus relaciones\n        $participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n\n        $participantes->each(function ($participante) use ($id) {\n            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n        });\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"hola naliza esto public function showFirmada(int $id, Request $request): View {  y meteme esto en un servicio cen // Cargar participantes del proceso con sus relaciones\n        $participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n\n        $participantes->each(function ($participante) use ($id) {\n            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n        }); de usr repositorio"}]},"uuid":"2201fd02-aff6-47d7-8708-201469ca57f6","timestamp":"2026-02-06T19:02:55.459Z","permissionMode":"default"}
{"parentUuid":"2201fd02-aff6-47d7-8708-201469ca57f6","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KLNrtPLiyGcKz3kPonHVP1","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario me est√° pidiendo:\n1. Analizar el m√©todo `showFirmada` en `ProcesoController.php`\n2. Mover la l√≥gica de cargar participantes con sus relaciones (l√≠neas 722-727) a un servicio\n\nNecesito:\n1. Leer el m√©todo completo `showFirmada` para entender el contexto\n2. Ver la estructura actual del controlador\n3. Identificar si ya existe un servicio para `Proceso`\n4. Mover la l√≥gica de negocio del controlador al servicio\n\nPrimero debo leer el archivo para ver el m√©todo completo.","signature":"EogFCkYICxgCKkCy26hduMq0m+mZ08133U1s/4GDvx9ccHkMTe6IlBbMJpB7uEVyd+A+CAqE2d/aVPElDthlnVVUkZbKQfWBQIkcEgwKwUmEWj68GUPt+PEaDFBrWVrdT1m11YQb7iIwYPKMtJmvdzBTYHaMpE5egCmwhz/9KijY6KQRNFIVhV6u4sOKhkqRC4NbsMnUCqgKKu8DcbNl/fuyCoxUXPqLipvCTn3KU2bPNGx/t2jTwcqiLoOJFmXWtwQxpZDYstnCJTjJS0SLiUMxJkgTVgKCKj2/G0fdpTj0/VDMHBrcMb9F6lPyQPbS6k46PFaXx37yTa58922IwGIRy9Q9EzcPmCcB9evz9KXJ3lXVNuZ4LANmkoXCfzuiFPPmBMgirANkmUswwcrsvtt1Wh6OdG0c4aLAvToxtwM7RHoNhBK3lIwOiiFAMrV+unDCFi3jtl8FXXnqjTLlhPYumkPkId7ikQ39a3hpERU2KoqzGI4WhlRCCvUCtOcXZxPCoEVXVLRbGtZ/VmfxaD8iBHRfnsKka1tAgCsLScWoDp6ITEUEhfWgyvFa0pzJDBzudvhxTcdLPDSLNYmm40beW8CDyN/EuEg4YevaWicFO2TMS0NtPVn6xMo6TFYF0kC9T7vGOu2YDt4VghCB3UFi0auRRQOdQxsiJilgeVqheIyamkJuiuCvH51cfSulmh4bzH9Vh9KGjyZIh9ZYZLxN98UVsnFpX9eUkiEdVEYGjf+muX3zl/iZn74NMoNkCvBvfd6pQG5bDRV86oQShyEMHfW2yYcAboyB1rQACV+vObk8J/QF+UySHlaYSXObm8U2V11uU5KtaDUwxTqbw0rYE1u3MPYbKqonGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":25811,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":25811},"output_tokens":7,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLL7HKMFk47YdLsu5Yj","type":"assistant","uuid":"95077e56-4fb7-45dd-8661-1dd9aac2b304","timestamp":"2026-02-06T19:03:00.023Z"}
{"parentUuid":"95077e56-4fb7-45dd-8661-1dd9aac2b304","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KLNrtPLiyGcKz3kPonHVP1","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a analizar el m√©todo `showFirmada` y mover esa l√≥gica al servicio correspondiente."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":25811,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":25811},"output_tokens":7,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLL7HKMFk47YdLsu5Yj","type":"assistant","uuid":"99ce0748-2c10-4da8-822c-f522e3a86e12","timestamp":"2026-02-06T19:03:00.566Z"}
{"parentUuid":"99ce0748-2c10-4da8-822c-f522e3a86e12","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KLNrtPLiyGcKz3kPonHVP1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Sff8uDHuf6XrUvzGHhvRG7","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Procesos\\ProcesoController.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":25811,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":25811},"output_tokens":7,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLL7HKMFk47YdLsu5Yj","type":"assistant","uuid":"4f70cb1b-934c-469a-bc2e-dc10678db715","timestamp":"2026-02-06T19:03:01.148Z"}
{"parentUuid":"4f70cb1b-934c-469a-bc2e-dc10678db715","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Sff8uDHuf6XrUvzGHhvRG7","type":"tool_result","content":"     1‚Üí<?php\n     2‚Üí\n     3‚Üínamespace App\\Http\\Controllers\\Procesos;\n     4‚Üí\n     5‚Üíuse Exception;\n     6‚Üíuse Illuminate\\View\\View;\n     7‚Üíuse Illuminate\\Http\\Request;\n     8‚Üíuse App\\Exports\\GlobalExport;\n     9‚Üíuse Illuminate\\Http\\JsonResponse;\n    10‚Üíuse App\\Models\\Pruebas\\TipoPrueba;\n    11‚Üíuse Illuminate\\Support\\Facades\\DB;\n    12‚Üíuse App\\Http\\Controllers\\Controller;\n    13‚Üíuse Maatwebsite\\Excel\\Facades\\Excel;\n    14‚Üíuse Illuminate\\Http\\RedirectResponse;\n    15‚Üíuse App\\Http\\Services\\Usuarios\\UserService;\n    16‚Üíuse App\\Http\\Services\\Agendas\\AgendaService;\n    17‚Üíuse App\\Http\\Services\\Pruebas\\PerfilService;\n    18‚Üíuse App\\Http\\Services\\Procesos\\ProcesoService;\n    19‚Üíuse App\\Http\\Services\\Accesos\\AccesoRutaService;\n    20‚Üíuse App\\Http\\Repositories\\Permisos\\RolRepository;\n    21‚Üíuse App\\Exports\\ResultadosProcesoMultiSheetExport;\n    22‚Üíuse App\\Http\\Repositories\\Usuarios\\UserRepository;\n    23‚Üíuse App\\Http\\Services\\Configuraciones\\RutaService;\n    24‚Üíuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\n    25‚Üíuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    26‚Üíuse App\\Http\\Requests\\Procesos\\CrearProcesoRequest;\n    27‚Üíuse App\\Http\\Repositories\\Procesos\\ProcesoRepository;\n    28‚Üíuse App\\Http\\Requests\\Procesos\\DuplicarProcesoRequest;\n    29‚Üíuse App\\Http\\Requests\\Procesos\\CompartirProcesoRequest;\n    30‚Üíuse Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\n    31‚Üíuse App\\Http\\Repositories\\OfertasLaborales\\EtapaRepository;\n    32‚Üíuse App\\Http\\Repositories\\Procesos\\EstadoProcesoRepository;\n    33‚Üíuse App\\Http\\Requests\\Procesos\\AgregarParticipantesRequest;\n    34‚Üíuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    35‚Üíuse App\\Http\\Requests\\Procesos\\ExtraerDatosPlantillaRequest;\n    36‚Üíuse App\\Http\\Requests\\Procesos\\DescartarParticipantesRequest;\n    37‚Üíuse App\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest;\n    38‚Üíuse App\\Http\\Requests\\Procesos\\SeleccionarParticipanteRequest;\n    39‚Üíuse App\\Http\\Requests\\Procesos\\GenerarMejoresCandidatosIARequest;\n    40‚Üíuse App\\Http\\Requests\\Procesos\\CambiarProcesoParticipantesRequest;\n    41‚Üíuse App\\Imports\\CargaMasiva\\AgendamientoMasivoParticipantesImport;\n    42‚Üí\n    43‚Üíclass ProcesoController extends Controller\n    44‚Üí{\n    45‚Üí    /**\n    46‚Üí     * üóÇÔ∏è Ruta en la cual se encuentra la plantilla Excel que sirve como gu√≠a para almacenar datos\n    47‚Üí     * de participantes para agendamiento masivo. Este es un archivo p√∫blico.\n    48‚Üí     *\n    49‚Üí     * @var string\n    50‚Üí     * @author Fahibram C√°rcamo\n    51‚Üí     */\n    52‚Üí    public const RUTA_ARCHIVO_GUIA_PARA_CARGA_MASIVA_PARTICIPANTES = 'app/public/archivos/utils/archivo_guia_para_carga_masiva_de_participantes.xlsx';\n    53‚Üí\n    54‚Üí    /**\n    55‚Üí     * Constructor.\n    56‚Üí     *\n    57‚Üí     * @param ProcesoService $servicio Servicio de procesos.\n    58‚Üí     * @param ProcesoRepository $repositorio Repositorio de procesos.\n    59‚Üí     * @param RutaService $ruta_servicio Servicio de rutas.\n    60‚Üí     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n    61‚Üí     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n    62‚Üí     * @param AgendaService $agenda_servicio Servicio de agendas.\n    63‚Üí     * @param UserService $usuario_servicio Servicio de usuarios.\n    64‚Üí     * @param EtapaRepository $etapa_repositorio Repositorio de etapas.\n    65‚Üí     * @param AccesoRutaService $acceso_ruta_servicio Servicio de accesos a rutas.\n    66‚Üí     * @param EstadoProcesoRepository $estado_proceso_repositorio Repositorio de estados proceso.\n    67‚Üí     * @param UserRepository $usuario_repositorio Repositorio de estados proceso.\n    68‚Üí     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de estados proceso.\n    69‚Üí     * @param PerfilService $perfil_servicio Servicio de perfiles.\n    70‚Üí     * @return void\n    71‚Üí     * @author Daniel Beltr√°n\n    72‚Üí     * @author Fahibram C√°rcamo\n    73‚Üí     * @author Andres Gonzalez\n    74‚Üí     * @author Andres Morales\n    75‚Üí     */\n    76‚Üí    public function __construct(\n    77‚Üí        private ProcesoService $servicio,\n    78‚Üí        private ProcesoRepository $repositorio,\n    79‚Üí        private RutaService $ruta_servicio,\n    80‚Üí        private PruebaRepository $prueba_repositorio,\n    81‚Üí        private AgendaRepository $agenda_repositorio,\n    82‚Üí        private AgendaService $agenda_servicio,\n    83‚Üí        private UserService $usuario_servicio,\n    84‚Üí        private EtapaRepository $etapa_repositorio,\n    85‚Üí        private AccesoRutaService $acceso_ruta_servicio,\n    86‚Üí        private EstadoProcesoRepository $estado_proceso_repositorio,\n    87‚Üí        private UserRepository $usuario_repositorio,\n    88‚Üí        private EmpresaUsuarioRepository $empresa_usuario_repositorio,\n    89‚Üí        private PerfilService $perfil_servicio\n    90‚Üí    ) {\n    91‚Üí        $this->middleware('auth.proceso-propio')->only('edit');\n    92‚Üí    }\n    93‚Üí\n    94‚Üí    /**\n    95‚Üí     * Obtener el listado de procesos.\n    96‚Üí     *\n    97‚Üí     * @param Request $request Contenido de la petici√≥n.\n    98‚Üí     * @return JsonResponse\n    99‚Üí     * @author Daniel Beltr√°n\n   100‚Üí     */\n   101‚Üí    public function listado(Request $request): JsonResponse {\n   102‚Üí        return new JsonResponse([\n   103‚Üí            'data' => $this->repositorio->getListado($request)\n   104‚Üí        ], 200);\n   105‚Üí    }\n   106‚Üí\n   107‚Üí    /**\n   108‚Üí     * Obtener los datos para la tabla.\n   109‚Üí     *\n   110‚Üí     * @param Request $request Contenido de la petici√≥n.\n   111‚Üí     * @return JsonResponse\n   112‚Üí     * @author Daniel Beltr√°n\n   113‚Üí     * @author Sergio Vargas\n   114‚Üí     */\n   115‚Üí    public function datosTabla(Request $request): JsonResponse {\n   116‚Üí        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   117‚Üí\n   118‚Üí        if ($empresa) {\n   119‚Üí            $request->merge(['empresa_id' => $empresa->id]);\n   120‚Üí        } else {\n   121‚Üí            return new JsonResponse(['data' => collect()], 200);\n   122‚Üí        }\n   123‚Üí\n   124‚Üí        return new JsonResponse([\n   125‚Üí            'data' => $this->repositorio->getTodo($request)\n   126‚Üí        ], 200);\n   127‚Üí    }\n   128‚Üí\n   129‚Üí    /**\n   130‚Üí     * Cargar la p√°gina principal.\n   131‚Üí     *\n   132‚Üí     * @param Request $request Contenido de la petici√≥n.\n   133‚Üí     * @return View\n   134‚Üí     * @author Daniel Beltr√°n\n   135‚Üí     * @author Andres Morales\n   136‚Üí     * @author Andres Gonzalez\n   137‚Üí     */\n   138‚Üí    public function index(): View {\n   139‚Üí        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n   140‚Üí        return view('procesos.index')->with([\n   141‚Üí            'rutas_menu'     => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true])),\n   142‚Üí            'pruebas'        => $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($empresa->id, TipoPrueba::SELECCION_ID),\n   143‚Üí            'estados'        => $this->estado_proceso_repositorio->getTodo(new Request()),\n   144‚Üí            'usuarios'       => $this->usuario_repositorio->getPorRolEmpresa(new Request(['empresa_id' => $empresa->id, 'roles_ids' => [RolRepository::ROL_PROPIETARIO_ID, RolRepository::ROL_ADMINISTRADOR_GENERAL_ID, RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID]])),\n   145‚Üí            'empresa_actual' => $empresa\n   146‚Üí        ]);\n   147‚Üí    }\n   148‚Üí\n   149‚Üí    /**\n   150‚Üí     * Obtener un proceso.\n   151‚Üí     *\n   152‚Üí     * @param int $id ID del proceso.\n   153‚Üí     * @return RedirectResponse|View\n   154‚Üí     * @author Daniel Beltr√°n\n   155‚Üí     * @author Andres Gonzalez\n   156‚Üí     * @author Andres Morales\n   157‚Üí     */\n   158‚Üí    public function show(int $id): View|RedirectResponse {\n   159‚Üí        $proceso = $this->repositorio->getUno($id);\n   160‚Üí\n   161‚Üí        // Verificar que el proceso pertenece a la empresa del usuario autenticado\n   162‚Üí        if (!$proceso || $proceso->empresa_id !== $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id) {\n   163‚Üí            return redirect('/procesos');\n   164‚Üí        }\n   165‚Üí\n   166‚Üí        return view('procesos.paginas.detalle')->with([\n   167‚Üí            'proceso'    => $proceso,\n   168‚Üí            'etapas'     => $this->etapa_repositorio->getTodo(new Request(['para_procesos' => true])),\n   169‚Üí            'rutas_menu' => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true]))\n   170‚Üí        ]);\n   171‚Üí    }\n   172‚Üí\n   173‚Üí    /**\n   174‚Üí     * Cargar la p√°gina de creaci√≥n.\n   175‚Üí     *\n   176‚Üí     * @return View\n   177‚Üí     * @author Daniel Beltr√°n\n   178‚Üí     * @author Andres Gonzalez\n   179‚Üí     */\n   180‚Üí    public function create(): View {\n   181‚Üí        $pruebas           = $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id, TipoPrueba::SELECCION_ID);\n   182‚Üí        $datos_adicionales = $this->perfil_servicio->getDatosAdicionales();\n   183‚Üí\n   184‚Üí        return view('procesos.paginas.crear')->with([\n   185‚Üí            'pruebas_plan_activo_seleccion' => $pruebas,\n   186‚Üí            'nivel_educativo'               => $datos_adicionales['niveles_educativos'],\n   187‚Üí            'rutas_menu'                    => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true])),\n   188‚Üí            'pruebas'                       => $pruebas,\n   189‚Üí        ]);\n   190‚Üí    }\n   191‚Üí\n   192‚Üí    /**\n   193‚Üí     * Cargar la p√°gina de edici√≥n.\n   194‚Üí     *\n   195‚Üí     * @param int $id ID del proceso.\n   196‚Üí     * @return View\n   197‚Üí     * @author Daniel Beltr√°n\n   198‚Üí     * @author Andres Gonzalez\n   199‚Üí     */\n   200‚Üí    public function edit(int $id): View {\n   201‚Üí        $pruebas           = $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id, TipoPrueba::SELECCION_ID);\n   202‚Üí        $datos_adicionales = $this->perfil_servicio->getDatosAdicionales();\n   203‚Üí\n   204‚Üí        return view('procesos.paginas.crear')->with([\n   205‚Üí            'proceso'                       => $this->repositorio->getUno($id),\n   206‚Üí            'pruebas_plan_activo_seleccion' => $pruebas,\n   207‚Üí            'nivel_educativo'               => $datos_adicionales['niveles_educativos'],\n   208‚Üí            'pruebas'                       => $pruebas,\n   209‚Üí            'tiene_agendas'                 => $this->agenda_repositorio->existenAgendasEnProceso($id),\n   210‚Üí            'rutas_menu'                    => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true]))\n   211‚Üí        ]);\n   212‚Üí    }\n   213‚Üí\n   214‚Üí    /**\n   215‚Üí     * Crear proceso.\n   216‚Üí     *\n   217‚Üí     * @param CrearProcesoRequest $request Contenido de la petici√≥n.\n   218‚Üí     * @return JsonResponse\n   219‚Üí     * @author Daniel Beltr√°n\n   220‚Üí     */\n   221‚Üí    public function store(CrearProcesoRequest $request): JsonResponse {\n   222‚Üí        $codigo    = 201;\n   223‚Üí        $respuesta = [\n   224‚Üí            'message' => 'Proceso creado correctamente'\n   225‚Üí        ];\n   226‚Üí\n   227‚Üí        try {\n   228‚Üí            DB::beginTransaction();\n   229‚Üí            $this->servicio->guardar($request);\n   230‚Üí            DB::commit();\n   231‚Üí        } catch (Exception $error) {\n   232‚Üí            DB::rollBack();\n   233‚Üí\n   234‚Üí            $codigo    = 400;\n   235‚Üí            $respuesta = [\n   236‚Üí                'message' => 'Ocurri√≥ un error',\n   237‚Üí                'errors'  => $error->getMessage()\n   238‚Üí            ];\n   239‚Üí        }\n   240‚Üí\n   241‚Üí        return new JsonResponse($respuesta, $codigo);\n   242‚Üí    }\n   243‚Üí\n   244‚Üí    /**\n   245‚Üí     * Actualizar proceso.\n   246‚Üí     *\n   247‚Üí     * @param int $id ID del proceso.\n   248‚Üí     * @param CrearProcesoRequest $request Contenido de la petici√≥n.\n   249‚Üí     * @return JsonResponse\n   250‚Üí     * @author Daniel Beltr√°n\n   251‚Üí     */\n   252‚Üí    public function update(int $id, CrearProcesoRequest $request): JsonResponse {\n   253‚Üí        $codigo    = 200;\n   254‚Üí        $respuesta = [\n   255‚Üí            'message' => 'Proceso actualizado correctamente'\n   256‚Üí        ];\n   257‚Üí\n   258‚Üí        try {\n   259‚Üí            DB::beginTransaction();\n   260‚Üí            $request->merge(['id' => $id]);\n   261‚Üí            $this->servicio->guardar($request);\n   262‚Üí            DB::commit();\n   263‚Üí        } catch (Exception $error) {\n   264‚Üí            DB::rollBack();\n   265‚Üí\n   266‚Üí            $codigo    = 400;\n   267‚Üí            $respuesta = [\n   268‚Üí                'message' => 'Ocurri√≥ un error',\n   269‚Üí                'errors'  => $error->getMessage()\n   270‚Üí            ];\n   271‚Üí        }\n   272‚Üí\n   273‚Üí        return new JsonResponse($respuesta, $codigo);\n   274‚Üí    }\n   275‚Üí\n   276‚Üí    /**\n   277‚Üí     * Actualizar un proceso\n   278‚Üí     *\n   279‚Üí     * @param int $id ID del proceso.\n   280‚Üí     * @param Request $request Contenido de la petici√≥n.\n   281‚Üí     * @return JsonResponse\n   282‚Üí     * @author Daniel Beltr√°n\n   283‚Üí     */\n   284‚Üí    public function actualizarInformacion(int $id, Request $request): JsonResponse {\n   285‚Üí        $codigo    = 200;\n   286‚Üí        $respuesta = [\n   287‚Üí            'message' => 'Proceso actualizado correctamente'\n   288‚Üí        ];\n   289‚Üí\n   290‚Üí        try {\n   291‚Üí            DB::beginTransaction();\n   292‚Üí            $this->repositorio->actualizar($id, $request->except('_token', '_method'));\n   293‚Üí            DB::commit();\n   294‚Üí        } catch (Exception $error) {\n   295‚Üí            DB::rollBack();\n   296‚Üí\n   297‚Üí            $codigo    = 400;\n   298‚Üí            $respuesta = [\n   299‚Üí                'message' => 'Ocurri√≥ un error',\n   300‚Üí                'errors'  => $error->getMessage()\n   301‚Üí            ];\n   302‚Üí        }\n   303‚Üí\n   304‚Üí        return new JsonResponse($respuesta, $codigo);\n   305‚Üí    }\n   306‚Üí\n   307‚Üí    /**\n   308‚Üí     * Duplicar proceso.\n   309‚Üí     *\n   310‚Üí     * @param int $id ID del proceso.\n   311‚Üí     * @param DuplicarProcesoRequest $request Contenido de la petici√≥n.\n   312‚Üí     * @return JsonResponse\n   313‚Üí     * @author Daniel Beltr√°n\n   314‚Üí     */\n   315‚Üí    public function duplicar(int $id, DuplicarProcesoRequest $request): JsonResponse {\n   316‚Üí        $codigo    = 201;\n   317‚Üí        $respuesta = [\n   318‚Üí            'message' => 'Proceso duplicado correctamente'\n   319‚Üí        ];\n   320‚Üí\n   321‚Üí        try {\n   322‚Üí            DB::beginTransaction();\n   323‚Üí            $this->servicio->duplicar($id, $request);\n   324‚Üí            DB::commit();\n   325‚Üí        } catch (Exception $error) {\n   326‚Üí            DB::rollBack();\n   327‚Üí\n   328‚Üí            $codigo    = 400;\n   329‚Üí            $respuesta = [\n   330‚Üí                'message' => 'Ocurri√≥ un error',\n   331‚Üí                'errors'  => $error->getMessage()\n   332‚Üí            ];\n   333‚Üí        }\n   334‚Üí\n   335‚Üí        return new JsonResponse($respuesta, $codigo);\n   336‚Üí    }\n   337‚Üí\n   338‚Üí    /**\n   339‚Üí     * Suspender proceso.\n   340‚Üí     *\n   341‚Üí     * @param int $id ID del proceso.\n   342‚Üí     * @return JsonResponse\n   343‚Üí     * @author Daniel Beltr√°n\n   344‚Üí     */\n   345‚Üí    public function suspender(int $id): JsonResponse {\n   346‚Üí        $codigo    = 200;\n   347‚Üí        $respuesta = [\n   348‚Üí            'message' => 'Proceso suspendido correctamente'\n   349‚Üí        ];\n   350‚Üí\n   351‚Üí        try {\n   352‚Üí            DB::beginTransaction();\n   353‚Üí            $this->servicio->suspender($id);\n   354‚Üí            DB::commit();\n   355‚Üí        } catch (Exception $error) {\n   356‚Üí            DB::rollBack();\n   357‚Üí\n   358‚Üí            $codigo    = 400;\n   359‚Üí            $respuesta = [\n   360‚Üí                'message' => 'Ocurri√≥ un error',\n   361‚Üí                'errors'  => $error->getMessage()\n   362‚Üí            ];\n   363‚Üí        }\n   364‚Üí\n   365‚Üí        return new JsonResponse($respuesta, $codigo);\n   366‚Üí    }\n   367‚Üí\n   368‚Üí    /**\n   369‚Üí     * Activar proceso.\n   370‚Üí     *\n   371‚Üí     * @param int $id ID del proceso.\n   372‚Üí     * @return JsonResponse\n   373‚Üí     * @author Daniel Beltr√°n\n   374‚Üí     */\n   375‚Üí    public function activar(int $id): JsonResponse {\n   376‚Üí        $codigo    = 200;\n   377‚Üí        $respuesta = [\n   378‚Üí            'message' => 'Proceso activado correctamente'\n   379‚Üí        ];\n   380‚Üí\n   381‚Üí        try {\n   382‚Üí            DB::beginTransaction();\n   383‚Üí            $this->servicio->activar($id);\n   384‚Üí            DB::commit();\n   385‚Üí        } catch (Exception $error) {\n   386‚Üí            DB::rollBack();\n   387‚Üí\n   388‚Üí            $codigo    = 400;\n   389‚Üí            $respuesta = [\n   390‚Üí                'message' => 'Ocurri√≥ un error',\n   391‚Üí                'errors'  => $error->getMessage()\n   392‚Üí            ];\n   393‚Üí        }\n   394‚Üí\n   395‚Üí        return new JsonResponse($respuesta, $codigo);\n   396‚Üí    }\n   397‚Üí\n   398‚Üí    /**\n   399‚Üí     * Eliminar proceso.\n   400‚Üí     *\n   401‚Üí     * @param int $id ID del proceso.\n   402‚Üí     * @return JsonResponse\n   403‚Üí     * @author Daniel Beltr√°n\n   404‚Üí     */\n   405‚Üí    public function destroy(int $id): JsonResponse {\n   406‚Üí        $codigo    = 200;\n   407‚Üí        $respuesta = [\n   408‚Üí            'message' => 'Proceso eliminado correctamente'\n   409‚Üí        ];\n   410‚Üí\n   411‚Üí        try {\n   412‚Üí            DB::beginTransaction();\n   413‚Üí            $this->servicio->eliminar($id);\n   414‚Üí            DB::commit();\n   415‚Üí        } catch (Exception $error) {\n   416‚Üí            DB::rollBack();\n   417‚Üí\n   418‚Üí            $codigo    = 400;\n   419‚Üí            $respuesta = [\n   420‚Üí                'message' => 'Ocurri√≥ un error',\n   421‚Üí                'errors'  => $error->getMessage()\n   422‚Üí            ];\n   423‚Üí        }\n   424‚Üí\n   425‚Üí        return new JsonResponse($respuesta, $codigo);\n   426‚Üí    }\n   427‚Üí\n   428‚Üí    /**\n   429‚Üí     * Descartar participantes.\n   430‚Üí     *\n   431‚Üí     * @param DescartarParticipantesRequest $request Contenido de la petici√≥n.\n   432‚Üí     * @return JsonResponse\n   433‚Üí     * @author Daniel Beltr√°n\n   434‚Üí     */\n   435‚Üí    public function descartarParticipantes(DescartarParticipantesRequest $request): JsonResponse {\n   436‚Üí        $codigo    = 200;\n   437‚Üí        $respuesta = [\n   438‚Üí            'message' => 'Participantes descartados correctamente'\n   439‚Üí        ];\n   440‚Üí\n   441‚Üí        try {\n   442‚Üí            DB::beginTransaction();\n   443‚Üí            $this->servicio->descartarParticipantes($request);\n   444‚Üí            DB::commit();\n   445‚Üí        } catch (Exception $error) {\n   446‚Üí            DB::rollBack();\n   447‚Üí\n   448‚Üí            $codigo    = 400;\n   449‚Üí            $respuesta = [\n   450‚Üí                'message' => 'Ocurri√≥ un error',\n   451‚Üí                'errors'  => $error->getMessage()\n   452‚Üí            ];\n   453‚Üí        }\n   454‚Üí\n   455‚Üí        return new JsonResponse($respuesta, $codigo);\n   456‚Üí    }\n   457‚Üí\n   458‚Üí    /**\n   459‚Üí     * Seleccionar un participante en un proceso.\n   460‚Üí     *\n   461‚Üí     * @param SeleccionarParticipanteRequest $request Contenido de la petici√≥n.\n   462‚Üí     * @return JsonResponse\n   463‚Üí     * @author Andres Morales\n   464‚Üí     * @author Andres Gonzalez\n   465‚Üí     */\n   466‚Üí    public function seleccionarParticipante(SeleccionarParticipanteRequest $request): JsonResponse {\n   467‚Üí        $codigo    = 200;\n   468‚Üí        $respuesta = [\n   469‚Üí            'message' => 'Participante seleccionado correctamente'\n   470‚Üí        ];\n   471‚Üí\n   472‚Üí        try {\n   473‚Üí            DB::beginTransaction();\n   474‚Üí            $respuesta[\"estado_proceso\"] = $this->servicio->seleccionarParticipante($request);\n   475‚Üí            DB::commit();\n   476‚Üí        } catch (Exception $error) {\n   477‚Üí            DB::rollBack();\n   478‚Üí\n   479‚Üí            $codigo    = 400;\n   480‚Üí            $respuesta = [\n   481‚Üí                'message' => 'Ocurri√≥ un error',\n   482‚Üí                'errors'  => $error->getMessage()\n   483‚Üí            ];\n   484‚Üí        }\n   485‚Üí\n   486‚Üí        return new JsonResponse($respuesta, $codigo);\n   487‚Üí    }\n   488‚Üí\n   489‚Üí    /**\n   490‚Üí     * Mover participantes de un proceso a otro.\n   491‚Üí     *\n   492‚Üí     * @param CambiarProcesoParticipantesRequest $request Contenido de la petici√≥n.\n   493‚Üí     * @return JsonResponse\n   494‚Üí     * @author Daniel Beltr√°n\n   495‚Üí     */\n   496‚Üí    public function moverDeProceso(CambiarProcesoParticipantesRequest $request): JsonResponse {\n   497‚Üí        $codigo    = 200;\n   498‚Üí        $respuesta = [\n   499‚Üí            'message' => 'Participantes trasladados correctamente'\n   500‚Üí        ];\n   501‚Üí\n   502‚Üí        try {\n   503‚Üí            DB::beginTransaction();\n   504‚Üí            $this->servicio->moverDeProceso($request);\n   505‚Üí            DB::commit();\n   506‚Üí        } catch (Exception $error) {\n   507‚Üí            DB::rollBack();\n   508‚Üí\n   509‚Üí            $codigo    = 400;\n   510‚Üí            $respuesta = [\n   511‚Üí                'message' => 'Ocurri√≥ un error',\n   512‚Üí                'errors'  => $error->getMessage()\n   513‚Üí            ];\n   514‚Üí        }\n   515‚Üí\n   516‚Üí        return new JsonResponse($respuesta, $codigo);\n   517‚Üí    }\n   518‚Üí\n   519‚Üí    /**\n   520‚Üí     * Eliminar un participante de un proceso.\n   521‚Üí     *\n   522‚Üí     * @param int $proceso_id ID del proceso.\n   523‚Üí     * @param int $usuario_id ID del usuario.\n   524‚Üí     * @return JsonResponse\n   525‚Üí     * @author Daniel Beltr√°n\n   526‚Üí     */\n   527‚Üí    public function eliminarParticipante(int $proceso_id, int $usuario_id): JsonResponse {\n   528‚Üí        $codigo    = 200;\n   529‚Üí        $respuesta = [\n   530‚Üí            'message' => 'Participante eliminado correctamente'\n   531‚Üí        ];\n   532‚Üí\n   533‚Üí        try {\n   534‚Üí            DB::beginTransaction();\n   535‚Üí            $this->servicio->eliminarParticipante($proceso_id, $usuario_id);\n   536‚Üí            DB::commit();\n   537‚Üí        } catch (Exception $error) {\n   538‚Üí            DB::rollBack();\n   539‚Üí\n   540‚Üí            $codigo    = 400;\n   541‚Üí            $respuesta = [\n   542‚Üí                'message' => 'Ocurri√≥ un error',\n   543‚Üí                'errors'  => $error->getMessage()\n   544‚Üí            ];\n   545‚Üí        }\n   546‚Üí\n   547‚Üí        return new JsonResponse($respuesta, $codigo);\n   548‚Üí    }\n   549‚Üí\n   550‚Üí    /**\n   551‚Üí     * Agregar participantes al proceso.\n   552‚Üí     *\n   553‚Üí     * @param int $id ID del proceso.\n   554‚Üí     * @param AgregarParticipantesRequest $request Contenido de la petici√≥n.\n   555‚Üí     * @return JsonResponse\n   556‚Üí     * @author Daniel Beltr√°n\n   557‚Üí     */\n   558‚Üí    public function agregarParticipantes(int $id, AgregarParticipantesRequest $request): JsonResponse {\n   559‚Üí        $codigo    = 201;\n   560‚Üí        $respuesta = [\n   561‚Üí            'message' => 'Participantes agregados correctamente'\n   562‚Üí        ];\n   563‚Üí\n   564‚Üí        try {\n   565‚Üí            DB::beginTransaction();\n   566‚Üí            $this->servicio->agregarParticipantes($id, $request);\n   567‚Üí            DB::commit();\n   568‚Üí        } catch (Exception $error) {\n   569‚Üí            DB::rollBack();\n   570‚Üí\n   571‚Üí            $codigo    = 400;\n   572‚Üí            $respuesta = [\n   573‚Üí                'message' => 'Ocurri√≥ un error',\n   574‚Üí                'errors'  => $error->getMessage()\n   575‚Üí            ];\n   576‚Üí        }\n   577‚Üí\n   578‚Üí        return new JsonResponse($respuesta, $codigo);\n   579‚Üí    }\n   580‚Üí\n   581‚Üí    /**\n   582‚Üí     * Extraer los datos de los participantes incluidos en el archivo Excel entrante para su\n   583‚Üí     * posterior agendamiento masivo.\n   584‚Üí     *\n   585‚Üí     * @param ExtraerDatosPlantillaRequest $request Contenido de la petici√≥n HTTP.\n   586‚Üí     * @return JsonResponse\n   587‚Üí     * @author Fahibram C√°rcamo\n   588‚Üí     */\n   589‚Üí    public function extraerDatosParticipantes(ExtraerDatosPlantillaRequest $request): JsonResponse {\n   590‚Üí        $codigo    = 201;\n   591‚Üí        $respuesta = ['message' => 'Datos de participantes extraidos correctamente'];\n   592‚Üí\n   593‚Üí        try {\n   594‚Üí            $archivo             = $request->file('archivo');\n   595‚Üí            $datos_participantes = [];\n   596‚Üí\n   597‚Üí            Excel::import(new AgendamientoMasivoParticipantesImport($datos_participantes), $archivo);\n   598‚Üí\n   599‚Üí            if (empty($datos_participantes)) {\n   600‚Üí                throw new Exception('No se encontraron datos v√°lidos en el archivo');\n   601‚Üí            }\n   602‚Üí\n   603‚Üí            $respuesta['datos_participantes'] = $datos_participantes;\n   604‚Üí        } catch (Exception $excepcion) {\n   605‚Üí            $codigo    = 400;\n   606‚Üí            $respuesta = [\n   607‚Üí                'message' => 'Ocurri√≥ un error',\n   608‚Üí                'errors'  => $excepcion->getMessage()\n   609‚Üí            ];\n   610‚Üí        }\n   611‚Üí\n   612‚Üí        return new JsonResponse($respuesta, $codigo);\n   613‚Üí    }\n   614‚Üí\n   615‚Üí    /**\n   616‚Üí     * Reagendar participantes.\n   617‚Üí     *\n   618‚Üí     * @param ReagendarParticipantesRequest $request Contenido de la petici√≥n.\n   619‚Üí     * @return JsonResponse\n   620‚Üí     * @author Daniel Beltr√°n\n   621‚Üí     * @author Sergio Vargas\n   622‚Üí     */\n   623‚Üí    public function reagendarParticipantes(ReagendarParticipantesRequest $request): JsonResponse {\n   624‚Üí        $codigo    = 200;\n   625‚Üí        $respuesta = [];\n   626‚Üí\n   627‚Üí        try {\n   628‚Üí            DB::beginTransaction();\n   629‚Üí            $resultados = $this->servicio->reagendarParticipantes($request);\n   630‚Üí            DB::commit();\n   631‚Üí\n   632‚Üí            $respuesta = $this->servicio->construirRespuestaReagendamientos($resultados);\n   633‚Üí        } catch (Exception $error) {\n   634‚Üí            DB::rollBack();\n   635‚Üí\n   636‚Üí            $codigo    = 400;\n   637‚Üí            $respuesta = [\n   638‚Üí                'message' => 'Ocurri√≥ un error',\n   639‚Üí                'errors'  => $error->getMessage()\n   640‚Üí            ];\n   641‚Üí        }\n   642‚Üí\n   643‚Üí        return new JsonResponse($respuesta, $codigo);\n   644‚Üí    }\n   645‚Üí\n   646‚Üí    /**\n   647‚Üí     * Exportar Excel.\n   648‚Üí     *\n   649‚Üí     * @param Request $request Contenido de la petici√≥n.\n   650‚Üí     * @return BinaryFileResponse\n   651‚Üí     * @author Daniel Beltr√°n\n   652‚Üí     */\n   653‚Üí    public function exportarExcel(Request $request): BinaryFileResponse {\n   654‚Üí        $request->merge(['contar_etapas_usuarios' => true]);\n   655‚Üí\n   656‚Üí        return Excel::download(new GlobalExport([\n   657‚Üí            'ID',\n   658‚Üí            'Nombre',\n   659‚Üí            'Estado',\n   660‚Üí            'Prioridad',\n   661‚Üí            'Usuario creador',\n   662‚Üí            'Fecha de inicio',\n   663‚Üí            'Fecha de cierre',\n   664‚Üí            'Cantidad de vacantes',\n   665‚Üí            'Capturar c√°mara',\n   666‚Üí            'Capturar v√≠deo',\n   667‚Üí            'Activo',\n   668‚Üí            'Fecha de creaci√≥n',\n   669‚Üí            'Participantes en pruebas',\n   670‚Üí            'Participantes seleccionados',\n   671‚Üí            'Participantes descartados'\n   672‚Üí        ], $this->repositorio->getTodo($request), 'Procesos', 'excel.procesos.procesos'), 'procesos.xlsx');\n   673‚Üí    }\n   674‚Üí\n   675‚Üí    /**\n   676‚Üí     * Enviar el mensaje de correo electr√≥nico que contiene el link para acceder a los datos de un\n   677‚Üí     * proceso a todos los destinatarios.\n   678‚Üí     *\n   679‚Üí     * @param int $id Id del proceso.\n   680‚Üí     * @param CompartirProcesoRequest $request Contenido de la petici√≥n.\n   681‚Üí     * @return JsonResponse\n   682‚Üí     * @author Fahibram C√°rcamo\n   683‚Üí     */\n   684‚Üí    public function compartir(int $id, CompartirProcesoRequest $request): JsonResponse {\n   685‚Üí        $codigo    = 200;\n   686‚Üí        $respuesta = [\n   687‚Üí            'message' => 'Proceso compartido exitosamente'\n   688‚Üí        ];\n   689‚Üí\n   690‚Üí        try {\n   691‚Üí            DB::beginTransaction();\n   692‚Üí            $request->merge(['proceso_id' => $id]);\n   693‚Üí            $this->servicio->compartirProceso($request);\n   694‚Üí            DB::commit();\n   695‚Üí        } catch (Exception $error) {\n   696‚Üí            DB::rollBack();\n   697‚Üí\n   698‚Üí            $codigo    = 400;\n   699‚Üí            $respuesta = [\n   700‚Üí                'message' => 'Ocurri√≥ un error',\n   701‚Üí                'errors'  => $error->getMessage()\n   702‚Üí            ];\n   703‚Üí        }\n   704‚Üí\n   705‚Üí        return new JsonResponse($respuesta, $codigo);\n   706‚Üí    }\n   707‚Üí\n   708‚Üí    /**\n   709‚Üí     * Cargar la vista que muestra el proceso a traves de una ruta firmada.\n   710‚Üí     *\n   711‚Üí     * @param int $id ID del proceso.\n   712‚Üí     * @param Request $request Contenido de la petici√≥n.\n   713‚Üí     * @return View\n   714‚Üí     * @author Fahibram C√°rcamo\n   715‚Üí     * @author Jair Carvajal\n   716‚Üí     * @author Andres Morales\n   717‚Üí     * @author Andres Gonzalez\n   718‚Üí     */\n   719‚Üí    public function showFirmada(int $id, Request $request): View {\n   720‚Üí        $proceso = $this->repositorio->getUno($id);\n   721‚Üí\n   722‚Üí        // Cargar participantes del proceso con sus relaciones\n   723‚Üí        $participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n   724‚Üí\n   725‚Üí        $participantes->each(function ($participante) use ($id) {\n   726‚Üí            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n   727‚Üí        });\n   728‚Üí\n   729‚Üí        return view('procesos.paginas.proceso-compartido-firmada')->with([\n   730‚Üí            'proceso'       => $proceso,\n   731‚Üí            'participantes' => $participantes,\n   732‚Üí            'empresa'       => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(),\n   733‚Üí            'firma'         => $request->firma\n   734‚Üí        ]);\n   735‚Üí    }\n   736‚Üí\n   737‚Üí    /**\n   738‚Üí     * Obtener las pruebas del aplicante.\n   739‚Üí     *\n   740‚Üí     * @param Request $request Contenido de la petici√≥n.\n   741‚Üí     * @return JsonResponse\n   742‚Üí     * @author Daniel Beltr√°n\n   743‚Üí     */\n   744‚Üí    public function obtenerPruebasAplicante(Request $request): JsonResponse {\n   745‚Üí        return new JsonResponse([\n   746‚Üí            'data' => $this->servicio->obtenerPruebasAplicante($request)\n   747‚Üí        ], 200);\n   748‚Üí    }\n   749‚Üí\n   750‚Üí    /**\n   751‚Üí     * Env√≠ar el mensaje de correo electr√≥nico que contiene el link para acceder a de los resultados\n   752‚Üí     * de un usuario aplicante en un proceso a todos los destinatarios.\n   753‚Üí     *\n   754‚Üí     * @param CompartirProcesoRequest $request Contenido de la petici√≥n HTTP.\n   755‚Üí     * @return JsonResponse\n   756‚Üí     * @author Fahibram C√°rcamo\n   757‚Üí     */\n   758‚Üí    public function compartirResultadosAplicante(CompartirProcesoRequest $request): JsonResponse {\n   759‚Üí        $codigo    = 200;\n   760‚Üí        $respuesta = [\n   761‚Üí            'tipo'    => 'success',\n   762‚Üí            'mensaje' => 'Resultados del proceso compartidos correctamente'\n   763‚Üí        ];\n   764‚Üí\n   765‚Üí        try {\n   766‚Üí            DB::beginTransaction();\n   767‚Üí            $this->servicio->compartirResultadosProcesoAplicante($request);\n   768‚Üí            DB::commit();\n   769‚Üí        } catch (Exception $error) {\n   770‚Üí            $codigo    = 400;\n   771‚Üí            $respuesta = [\n   772‚Üí                'tipo'    => 'error',\n   773‚Üí                'mensaje' => 'Ocurri√≥ un error al compartir los resultados',\n   774‚Üí                'errors'  => $error->getMessage()\n   775‚Üí            ];\n   776‚Üí        }\n   777‚Üí\n   778‚Üí        return new JsonResponse($respuesta, $codigo);\n   779‚Üí    }\n   780‚Üí\n   781‚Üí    /**\n   782‚Üí     * Mostrar resultados de un usuario aplicante en un proceso dado con firma de ruta.\n   783‚Üí     *\n   784‚Üí     * @param int $proceso_id Id del proceso.\n   785‚Üí     * @param int $participante_id Id del usuario participante.\n   786‚Üí     * @param Request $request Contenido de la petici√≥n HTTP.\n   787‚Üí     * @return View\n   788‚Üí     * @author Fahibram C√°rcamo\n   789‚Üí     * @author Andres Gonzalez\n   790‚Üí     */\n   791‚Üí    public function showResultadosAplicanteFirmada(int $proceso_id, int $participante_id, Request $request): View { \n   792‚Üí        $request->merge(compact('proceso_id', 'participante_id'));\n   793‚Üí        $this->acceso_ruta_servicio->notificarAdministradorEmpresaProcesoAccesoRuta($request);\n   794‚Üí\n   795‚Üí        return view(\n   796‚Üí            'procesos.paginas.resultados-aplicante-firmada',\n   797‚Üí            [\n   798‚Üí                'resultados'     => $this->usuario_servicio->obtenerDetallesParticipanteProceso(new Request(compact('proceso_id', 'participante_id'))),\n   799‚Üí                'indice_talento' => $this->repositorio->obtenerIndiceTalento($proceso_id, $participante_id),\n   800‚Üí                'firma'          => $request->firma\n   801‚Üí            ]\n   802‚Üí        );\n   803‚Üí    }\n   804‚Üí\n   805‚Üí    /**\n   806‚Üí     * Obtener √≠ndice de talento.\n   807‚Üí     *\n   808‚Üí     * @param int $id ID del proceso.\n   809‚Üí     * @param int $aplicante_id ID del aplicante.\n   810‚Üí     * @return JsonResponse\n   811‚Üí     * @author Daniel Beltr√°n\n   812‚Üí     */\n   813‚Üí    public function obtenerIndiceTalento(int $id, int $aplicante_id): JsonResponse {\n   814‚Üí        return new JsonResponse([\n   815‚Üí            'data' => $this->repositorio->obtenerIndiceTalento($id, $aplicante_id)\n   816‚Üí        ]);\n   817‚Üí    }\n   818‚Üí\n   819‚Üí    /**\n   820‚Üí     * Exportar resultados detallados de un proceso a Excel.\n   821‚Üí     *\n   822‚Üí     * Genera un archivo Excel con m√∫ltiples hojas que incluyen:\n   823‚Üí     * - Hoja de resumen de participantes con estad√≠sticas generales\n   824‚Üí     * - Una hoja por cada prueba del proceso con resultados detallados\n   825‚Üí     * - Datos personales, puntajes de factores/dimensiones y conceptos de recomendaci√≥n\n   826‚Üí     *\n   827‚Üí     * @param Request $request Petici√≥n con el proceso_id.\n   828‚Üí     * @return BinaryFileResponse|JsonResponse Descarga del archivo Excel o error JSON.\n   829‚Üí     * @author Sergio Vargas\n   830‚Üí     * @author Fahibram C√°rcamo\n   831‚Üí     */\n   832‚Üí    public function exportarReporteResultadosExcel(Request $request): BinaryFileResponse|JsonResponse {\n   833‚Üí        try {\n   834‚Üí            $id      = $request->input('proceso_id');\n   835‚Üí            $proceso = $this->repositorio->getUno($id);\n   836‚Üí\n   837‚Üí            if (!$proceso) {\n   838‚Üí                return response()->json(['message' => 'Proceso no encontrado'], 404);\n   839‚Üí            }\n   840‚Üí\n   841‚Üí            $usuarios_ids = $request->input('ids_usuarios', []);\n   842‚Üí\n   843‚Üí            $resumen_participantes = $this->servicio->generarResumenParticipantes($id, $usuarios_ids);\n   844‚Üí            $resultados            = $this->servicio->resultadosProcesoAgendas($id, $usuarios_ids);\n   845‚Üí\n   846‚Üí            $nombre_archivo = 'Descarga_detallada_resultados_seleccion_' . $proceso->id . '_' . date('Y-m-d_H-i-s') . '.xlsx';\n   847‚Üí\n   848‚Üí            return Excel::download(\n   849‚Üí                new ResultadosProcesoMultiSheetExport($resultados, $resumen_participantes),\n   850‚Üí                $nombre_archivo\n   851‚Üí            );\n   852‚Üí        } catch (Exception $e) {\n   853‚Üí            return response()->json(['message' => 'Error al generar el archivo Excel: ' . $e->getMessage()], 500);\n   854‚Üí        }\n   855‚Üí    }\n   856‚Üí\n   857‚Üí    /**\n   858‚Üí     * Obtener un top 3 de los mejores candidatos.\n   859‚Üí     *\n   860‚Üí     * @param GenerarMejoresCandidatosIARequest $request Contenido de la petici√≥n.\n   861‚Üí     * @return JsonResponse\n   862‚Üí     * @author Andres Gonzalez\n   863‚Üí     */\n   864‚Üí    public function mejoresCandidatosIA(GenerarMejoresCandidatosIARequest $request): JsonResponse {\n   865‚Üí        $codigo    = 200;\n   866‚Üí        $respuesta = [\n   867‚Üí            'success' => true,\n   868‚Üí            'message' => 'Generados los mejores candidatos con IA'\n   869‚Üí        ];\n   870‚Üí\n   871‚Üí        try {\n   872‚Üí            $respuesta['data'] = $this->servicio->generarMejoresCandidatosIA($request);\n   873‚Üí        } catch (Exception $error) {\n   874‚Üí            $codigo    = 400;\n   875‚Üí            $respuesta = [\n   876‚Üí                'success' => false,\n   877‚Üí                'message' => 'Error al generar los mejores candidatos con IA: ' . $error->getMessage()\n   878‚Üí            ];\n   879‚Üí        }\n   880‚Üí\n   881‚Üí        return new JsonResponse($respuesta, $codigo);\n   882‚Üí    }\n   883‚Üí\n   884‚Üí    /**\n   885‚Üí     * Validar y actualizar agendas expiradas de un proceso.\n   886‚Üí     *\n   887‚Üí     * @param int $id ID del proceso.\n   888‚Üí     * @return JsonResponse\n   889‚Üí     * @author Sergio Vargas\n   890‚Üí     * @author Andres Gonzalez\n   891‚Üí     */\n   892‚Üí    public function validarAgendasExpiradas(int $id): JsonResponse {\n   893‚Üí        $proceso = $this->repositorio->getUno($id);\n   894‚Üí\n   895‚Üí        // Verificar que el proceso pertenece a la empresa del usuario autenticado\n   896‚Üí        if (!$proceso || $proceso->empresa_id !== $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id) {\n   897‚Üí            return new JsonResponse([\n   898‚Üí                'success' => false,\n   899‚Üí                'message' => 'Proceso no encontrado o no autorizado'\n   900‚Üí            ], 404);\n   901‚Üí        }\n   902‚Üí\n   903‚Üí        try {\n   904‚Üí            $agendas_actualizadas = $this->agenda_servicio->validarAgendasExpiradasPorProceso($id);\n   905‚Üí\n   906‚Üí            return new JsonResponse([\n   907‚Üí                'success' => true,\n   908‚Üí                'message' => 'Validaci√≥n completada',\n   909‚Üí                'data'    => [\n   910‚Üí                    'agendas_actualizadas' => $agendas_actualizadas\n   911‚Üí                ]\n   912‚Üí            ], 200);\n   913‚Üí        } catch (Exception $error) {\n   914‚Üí            return new JsonResponse([\n   915‚Üí                'success' => false,\n   916‚Üí                'message' => 'Error al validar agendas expiradas: ' . $error->getMessage()\n   917‚Üí            ], 500);\n   918‚Üí        }\n   919‚Üí    }\n   920‚Üí\n   921‚Üí    /**\n   922‚Üí     * Descargar archivo gu√≠a para agendamiento masivo de participantes.\n   923‚Üí     *\n   924‚Üí     * @return BinaryFileResponse|JsonResponse\n   925‚Üí     * @author Fahibram C√°rcamo\n   926‚Üí     */\n   927‚Üí    public function descargarGuiaAgendamientoMasivo(): BinaryFileResponse|JsonResponse {\n   928‚Üí        try {\n   929‚Üí            $ruta_archivo = storage_path(self::RUTA_ARCHIVO_GUIA_PARA_CARGA_MASIVA_PARTICIPANTES);\n   930‚Üí\n   931‚Üí            if (!file_exists($ruta_archivo)) {\n   932‚Üí                throw new Exception('Archivo no encontrado');\n   933‚Üí            }\n   934‚Üí\n   935‚Üí            return response()->download(\n   936‚Üí                $ruta_archivo,\n   937‚Üí                'archivo_guia_para_carga_masiva_de_participantes.xlsx',\n   938‚Üí                ['Content-Type' => 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet']\n   939‚Üí            );\n   940‚Üí        } catch (Exception $excepcion) {\n   941‚Üí            return new JsonResponse(\n   942‚Üí                [\n   943‚Üí                    'message' => 'Ocurri√≥ un error',\n   944‚Üí                    'errors'  => $excepcion->getMessage()\n   945‚Üí                ],\n   946‚Üí                400\n   947‚Üí            );\n   948‚Üí        }\n   949‚Üí    }\n   950‚Üí\n   951‚Üí    /**\n   952‚Üí     * Archivar o desarchivar un proceso.\n   953‚Üí     *\n   954‚Üí     * @param Request $request Contenido de la petici√≥n.\n   955‚Üí     * @return JsonResponse\n   956‚Üí     * @author Andres Morales\n   957‚Üí     */\n   958‚Üí    public function archivarProceso(Request $request): JsonResponse {\n   959‚Üí        $codigo = 200;\n   960‚Üí\n   961‚Üí        try {\n   962‚Üí            DB::beginTransaction();\n   963‚Üí            $respuesta = $this->servicio->archivarProceso($request->id);\n   964‚Üí            DB::commit();\n   965‚Üí        } catch (Exception $error) {\n   966‚Üí            DB::rollBack();\n   967‚Üí\n   968‚Üí            $codigo    = 400;\n   969‚Üí            $respuesta = [\n   970‚Üí                'message' => 'Ocurri√≥ un error',\n   971‚Üí                'errors'  => $error->getMessage()\n   972‚Üí            ];\n   973‚Üí        }\n   974‚Üí\n   975‚Üí        return new JsonResponse($respuesta, $codigo);\n   976‚Üí    }\n   977‚Üí}\n   978‚Üí\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1b9467f4-b243-46cc-9ea2-e9b3c6a583b7","timestamp":"2026-02-06T19:03:02.705Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Procesos\\ProcesoController.php","content":"<?php\n\nnamespace App\\Http\\Controllers\\Procesos;\n\nuse Exception;\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\Request;\nuse App\\Exports\\GlobalExport;\nuse Illuminate\\Http\\JsonResponse;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse Illuminate\\Http\\RedirectResponse;\nuse App\\Http\\Services\\Usuarios\\UserService;\nuse App\\Http\\Services\\Agendas\\AgendaService;\nuse App\\Http\\Services\\Pruebas\\PerfilService;\nuse App\\Http\\Services\\Procesos\\ProcesoService;\nuse App\\Http\\Services\\Accesos\\AccesoRutaService;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Exports\\ResultadosProcesoMultiSheetExport;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Services\\Configuraciones\\RutaService;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\nuse App\\Http\\Requests\\Procesos\\CrearProcesoRequest;\nuse App\\Http\\Repositories\\Procesos\\ProcesoRepository;\nuse App\\Http\\Requests\\Procesos\\DuplicarProcesoRequest;\nuse App\\Http\\Requests\\Procesos\\CompartirProcesoRequest;\nuse Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\nuse App\\Http\\Repositories\\OfertasLaborales\\EtapaRepository;\nuse App\\Http\\Repositories\\Procesos\\EstadoProcesoRepository;\nuse App\\Http\\Requests\\Procesos\\AgregarParticipantesRequest;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Requests\\Procesos\\ExtraerDatosPlantillaRequest;\nuse App\\Http\\Requests\\Procesos\\DescartarParticipantesRequest;\nuse App\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest;\nuse App\\Http\\Requests\\Procesos\\SeleccionarParticipanteRequest;\nuse App\\Http\\Requests\\Procesos\\GenerarMejoresCandidatosIARequest;\nuse App\\Http\\Requests\\Procesos\\CambiarProcesoParticipantesRequest;\nuse App\\Imports\\CargaMasiva\\AgendamientoMasivoParticipantesImport;\n\nclass ProcesoController extends Controller\n{\n    /**\n     * üóÇÔ∏è Ruta en la cual se encuentra la plantilla Excel que sirve como gu√≠a para almacenar datos\n     * de participantes para agendamiento masivo. Este es un archivo p√∫blico.\n     *\n     * @var string\n     * @author Fahibram C√°rcamo\n     */\n    public const RUTA_ARCHIVO_GUIA_PARA_CARGA_MASIVA_PARTICIPANTES = 'app/public/archivos/utils/archivo_guia_para_carga_masiva_de_participantes.xlsx';\n\n    /**\n     * Constructor.\n     *\n     * @param ProcesoService $servicio Servicio de procesos.\n     * @param ProcesoRepository $repositorio Repositorio de procesos.\n     * @param RutaService $ruta_servicio Servicio de rutas.\n     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param AgendaService $agenda_servicio Servicio de agendas.\n     * @param UserService $usuario_servicio Servicio de usuarios.\n     * @param EtapaRepository $etapa_repositorio Repositorio de etapas.\n     * @param AccesoRutaService $acceso_ruta_servicio Servicio de accesos a rutas.\n     * @param EstadoProcesoRepository $estado_proceso_repositorio Repositorio de estados proceso.\n     * @param UserRepository $usuario_repositorio Repositorio de estados proceso.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de estados proceso.\n     * @param PerfilService $perfil_servicio Servicio de perfiles.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     * @author Andres Morales\n     */\n    public function __construct(\n        private ProcesoService $servicio,\n        private ProcesoRepository $repositorio,\n        private RutaService $ruta_servicio,\n        private PruebaRepository $prueba_repositorio,\n        private AgendaRepository $agenda_repositorio,\n        private AgendaService $agenda_servicio,\n        private UserService $usuario_servicio,\n        private EtapaRepository $etapa_repositorio,\n        private AccesoRutaService $acceso_ruta_servicio,\n        private EstadoProcesoRepository $estado_proceso_repositorio,\n        private UserRepository $usuario_repositorio,\n        private EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        private PerfilService $perfil_servicio\n    ) {\n        $this->middleware('auth.proceso-propio')->only('edit');\n    }\n\n    /**\n     * Obtener el listado de procesos.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function listado(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->repositorio->getListado($request)\n        ], 200);\n    }\n\n    /**\n     * Obtener los datos para la tabla.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     * @author Sergio Vargas\n     */\n    public function datosTabla(Request $request): JsonResponse {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n        if ($empresa) {\n            $request->merge(['empresa_id' => $empresa->id]);\n        } else {\n            return new JsonResponse(['data' => collect()], 200);\n        }\n\n        return new JsonResponse([\n            'data' => $this->repositorio->getTodo($request)\n        ], 200);\n    }\n\n    /**\n     * Cargar la p√°gina principal.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return View\n     * @author Daniel Beltr√°n\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function index(): View {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n        return view('procesos.index')->with([\n            'rutas_menu'     => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true])),\n            'pruebas'        => $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($empresa->id, TipoPrueba::SELECCION_ID),\n            'estados'        => $this->estado_proceso_repositorio->getTodo(new Request()),\n            'usuarios'       => $this->usuario_repositorio->getPorRolEmpresa(new Request(['empresa_id' => $empresa->id, 'roles_ids' => [RolRepository::ROL_PROPIETARIO_ID, RolRepository::ROL_ADMINISTRADOR_GENERAL_ID, RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID]])),\n            'empresa_actual' => $empresa\n        ]);\n    }\n\n    /**\n     * Obtener un proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return RedirectResponse|View\n     * @author Daniel Beltr√°n\n     * @author Andres Gonzalez\n     * @author Andres Morales\n     */\n    public function show(int $id): View|RedirectResponse {\n        $proceso = $this->repositorio->getUno($id);\n\n        // Verificar que el proceso pertenece a la empresa del usuario autenticado\n        if (!$proceso || $proceso->empresa_id !== $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id) {\n            return redirect('/procesos');\n        }\n\n        return view('procesos.paginas.detalle')->with([\n            'proceso'    => $proceso,\n            'etapas'     => $this->etapa_repositorio->getTodo(new Request(['para_procesos' => true])),\n            'rutas_menu' => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Cargar la p√°gina de creaci√≥n.\n     *\n     * @return View\n     * @author Daniel Beltr√°n\n     * @author Andres Gonzalez\n     */\n    public function create(): View {\n        $pruebas           = $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id, TipoPrueba::SELECCION_ID);\n        $datos_adicionales = $this->perfil_servicio->getDatosAdicionales();\n\n        return view('procesos.paginas.crear')->with([\n            'pruebas_plan_activo_seleccion' => $pruebas,\n            'nivel_educativo'               => $datos_adicionales['niveles_educativos'],\n            'rutas_menu'                    => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true])),\n            'pruebas'                       => $pruebas,\n        ]);\n    }\n\n    /**\n     * Cargar la p√°gina de edici√≥n.\n     *\n     * @param int $id ID del proceso.\n     * @return View\n     * @author Daniel Beltr√°n\n     * @author Andres Gonzalez\n     */\n    public function edit(int $id): View {\n        $pruebas           = $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id, TipoPrueba::SELECCION_ID);\n        $datos_adicionales = $this->perfil_servicio->getDatosAdicionales();\n\n        return view('procesos.paginas.crear')->with([\n            'proceso'                       => $this->repositorio->getUno($id),\n            'pruebas_plan_activo_seleccion' => $pruebas,\n            'nivel_educativo'               => $datos_adicionales['niveles_educativos'],\n            'pruebas'                       => $pruebas,\n            'tiene_agendas'                 => $this->agenda_repositorio->existenAgendasEnProceso($id),\n            'rutas_menu'                    => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Crear proceso.\n     *\n     * @param CrearProcesoRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function store(CrearProcesoRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Proceso creado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param CrearProcesoRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function update(int $id, CrearProcesoRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['id' => $id]);\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar un proceso\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function actualizarInformacion(int $id, Request $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, $request->except('_token', '_method'));\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Duplicar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param DuplicarProcesoRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function duplicar(int $id, DuplicarProcesoRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Proceso duplicado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->duplicar($id, $request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Suspender proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function suspender(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso suspendido correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->suspender($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Activar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function activar(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso activado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->activar($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Eliminar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function destroy(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso eliminado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->eliminar($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Descartar participantes.\n     *\n     * @param DescartarParticipantesRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function descartarParticipantes(DescartarParticipantesRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Participantes descartados correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->descartarParticipantes($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Seleccionar un participante en un proceso.\n     *\n     * @param SeleccionarParticipanteRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function seleccionarParticipante(SeleccionarParticipanteRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Participante seleccionado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $respuesta[\"estado_proceso\"] = $this->servicio->seleccionarParticipante($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Mover participantes de un proceso a otro.\n     *\n     * @param CambiarProcesoParticipantesRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function moverDeProceso(CambiarProcesoParticipantesRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Participantes trasladados correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->moverDeProceso($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Eliminar un participante de un proceso.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param int $usuario_id ID del usuario.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function eliminarParticipante(int $proceso_id, int $usuario_id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Participante eliminado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->eliminarParticipante($proceso_id, $usuario_id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Agregar participantes al proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param AgregarParticipantesRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function agregarParticipantes(int $id, AgregarParticipantesRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Participantes agregados correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->agregarParticipantes($id, $request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Extraer los datos de los participantes incluidos en el archivo Excel entrante para su\n     * posterior agendamiento masivo.\n     *\n     * @param ExtraerDatosPlantillaRequest $request Contenido de la petici√≥n HTTP.\n     * @return JsonResponse\n     * @author Fahibram C√°rcamo\n     */\n    public function extraerDatosParticipantes(ExtraerDatosPlantillaRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = ['message' => 'Datos de participantes extraidos correctamente'];\n\n        try {\n            $archivo             = $request->file('archivo');\n            $datos_participantes = [];\n\n            Excel::import(new AgendamientoMasivoParticipantesImport($datos_participantes), $archivo);\n\n            if (empty($datos_participantes)) {\n                throw new Exception('No se encontraron datos v√°lidos en el archivo');\n            }\n\n            $respuesta['datos_participantes'] = $datos_participantes;\n        } catch (Exception $excepcion) {\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $excepcion->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Reagendar participantes.\n     *\n     * @param ReagendarParticipantesRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     * @author Sergio Vargas\n     */\n    public function reagendarParticipantes(ReagendarParticipantesRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [];\n\n        try {\n            DB::beginTransaction();\n            $resultados = $this->servicio->reagendarParticipantes($request);\n            DB::commit();\n\n            $respuesta = $this->servicio->construirRespuestaReagendamientos($resultados);\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Exportar Excel.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return BinaryFileResponse\n     * @author Daniel Beltr√°n\n     */\n    public function exportarExcel(Request $request): BinaryFileResponse {\n        $request->merge(['contar_etapas_usuarios' => true]);\n\n        return Excel::download(new GlobalExport([\n            'ID',\n            'Nombre',\n            'Estado',\n            'Prioridad',\n            'Usuario creador',\n            'Fecha de inicio',\n            'Fecha de cierre',\n            'Cantidad de vacantes',\n            'Capturar c√°mara',\n            'Capturar v√≠deo',\n            'Activo',\n            'Fecha de creaci√≥n',\n            'Participantes en pruebas',\n            'Participantes seleccionados',\n            'Participantes descartados'\n        ], $this->repositorio->getTodo($request), 'Procesos', 'excel.procesos.procesos'), 'procesos.xlsx');\n    }\n\n    /**\n     * Enviar el mensaje de correo electr√≥nico que contiene el link para acceder a los datos de un\n     * proceso a todos los destinatarios.\n     *\n     * @param int $id Id del proceso.\n     * @param CompartirProcesoRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Fahibram C√°rcamo\n     */\n    public function compartir(int $id, CompartirProcesoRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso compartido exitosamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['proceso_id' => $id]);\n            $this->servicio->compartirProceso($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Cargar la vista que muestra el proceso a traves de una ruta firmada.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return View\n     * @author Fahibram C√°rcamo\n     * @author Jair Carvajal\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function showFirmada(int $id, Request $request): View {\n        $proceso = $this->repositorio->getUno($id);\n\n        // Cargar participantes del proceso con sus relaciones\n        $participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n\n        $participantes->each(function ($participante) use ($id) {\n            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n        });\n\n        return view('procesos.paginas.proceso-compartido-firmada')->with([\n            'proceso'       => $proceso,\n            'participantes' => $participantes,\n            'empresa'       => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(),\n            'firma'         => $request->firma\n        ]);\n    }\n\n    /**\n     * Obtener las pruebas del aplicante.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function obtenerPruebasAplicante(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->obtenerPruebasAplicante($request)\n        ], 200);\n    }\n\n    /**\n     * Env√≠ar el mensaje de correo electr√≥nico que contiene el link para acceder a de los resultados\n     * de un usuario aplicante en un proceso a todos los destinatarios.\n     *\n     * @param CompartirProcesoRequest $request Contenido de la petici√≥n HTTP.\n     * @return JsonResponse\n     * @author Fahibram C√°rcamo\n     */\n    public function compartirResultadosAplicante(CompartirProcesoRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'tipo'    => 'success',\n            'mensaje' => 'Resultados del proceso compartidos correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->compartirResultadosProcesoAplicante($request);\n            DB::commit();\n        } catch (Exception $error) {\n            $codigo    = 400;\n            $respuesta = [\n                'tipo'    => 'error',\n                'mensaje' => 'Ocurri√≥ un error al compartir los resultados',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Mostrar resultados de un usuario aplicante en un proceso dado con firma de ruta.\n     *\n     * @param int $proceso_id Id del proceso.\n     * @param int $participante_id Id del usuario participante.\n     * @param Request $request Contenido de la petici√≥n HTTP.\n     * @return View\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     */\n    public function showResultadosAplicanteFirmada(int $proceso_id, int $participante_id, Request $request): View { \n        $request->merge(compact('proceso_id', 'participante_id'));\n        $this->acceso_ruta_servicio->notificarAdministradorEmpresaProcesoAccesoRuta($request);\n\n        return view(\n            'procesos.paginas.resultados-aplicante-firmada',\n            [\n                'resultados'     => $this->usuario_servicio->obtenerDetallesParticipanteProceso(new Request(compact('proceso_id', 'participante_id'))),\n                'indice_talento' => $this->repositorio->obtenerIndiceTalento($proceso_id, $participante_id),\n                'firma'          => $request->firma\n            ]\n        );\n    }\n\n    /**\n     * Obtener √≠ndice de talento.\n     *\n     * @param int $id ID del proceso.\n     * @param int $aplicante_id ID del aplicante.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function obtenerIndiceTalento(int $id, int $aplicante_id): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->repositorio->obtenerIndiceTalento($id, $aplicante_id)\n        ]);\n    }\n\n    /**\n     * Exportar resultados detallados de un proceso a Excel.\n     *\n     * Genera un archivo Excel con m√∫ltiples hojas que incluyen:\n     * - Hoja de resumen de participantes con estad√≠sticas generales\n     * - Una hoja por cada prueba del proceso con resultados detallados\n     * - Datos personales, puntajes de factores/dimensiones y conceptos de recomendaci√≥n\n     *\n     * @param Request $request Petici√≥n con el proceso_id.\n     * @return BinaryFileResponse|JsonResponse Descarga del archivo Excel o error JSON.\n     * @author Sergio Vargas\n     * @author Fahibram C√°rcamo\n     */\n    public function exportarReporteResultadosExcel(Request $request): BinaryFileResponse|JsonResponse {\n        try {\n            $id      = $request->input('proceso_id');\n            $proceso = $this->repositorio->getUno($id);\n\n            if (!$proceso) {\n                return response()->json(['message' => 'Proceso no encontrado'], 404);\n            }\n\n            $usuarios_ids = $request->input('ids_usuarios', []);\n\n            $resumen_participantes = $this->servicio->generarResumenParticipantes($id, $usuarios_ids);\n            $resultados            = $this->servicio->resultadosProcesoAgendas($id, $usuarios_ids);\n\n            $nombre_archivo = 'Descarga_detallada_resultados_seleccion_' . $proceso->id . '_' . date('Y-m-d_H-i-s') . '.xlsx';\n\n            return Excel::download(\n                new ResultadosProcesoMultiSheetExport($resultados, $resumen_participantes),\n                $nombre_archivo\n            );\n        } catch (Exception $e) {\n            return response()->json(['message' => 'Error al generar el archivo Excel: ' . $e->getMessage()], 500);\n        }\n    }\n\n    /**\n     * Obtener un top 3 de los mejores candidatos.\n     *\n     * @param GenerarMejoresCandidatosIARequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Andres Gonzalez\n     */\n    public function mejoresCandidatosIA(GenerarMejoresCandidatosIARequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'success' => true,\n            'message' => 'Generados los mejores candidatos con IA'\n        ];\n\n        try {\n            $respuesta['data'] = $this->servicio->generarMejoresCandidatosIA($request);\n        } catch (Exception $error) {\n            $codigo    = 400;\n            $respuesta = [\n                'success' => false,\n                'message' => 'Error al generar los mejores candidatos con IA: ' . $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Validar y actualizar agendas expiradas de un proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Andres Gonzalez\n     */\n    public function validarAgendasExpiradas(int $id): JsonResponse {\n        $proceso = $this->repositorio->getUno($id);\n\n        // Verificar que el proceso pertenece a la empresa del usuario autenticado\n        if (!$proceso || $proceso->empresa_id !== $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id) {\n            return new JsonResponse([\n                'success' => false,\n                'message' => 'Proceso no encontrado o no autorizado'\n            ], 404);\n        }\n\n        try {\n            $agendas_actualizadas = $this->agenda_servicio->validarAgendasExpiradasPorProceso($id);\n\n            return new JsonResponse([\n                'success' => true,\n                'message' => 'Validaci√≥n completada',\n                'data'    => [\n                    'agendas_actualizadas' => $agendas_actualizadas\n                ]\n            ], 200);\n        } catch (Exception $error) {\n            return new JsonResponse([\n                'success' => false,\n                'message' => 'Error al validar agendas expiradas: ' . $error->getMessage()\n            ], 500);\n        }\n    }\n\n    /**\n     * Descargar archivo gu√≠a para agendamiento masivo de participantes.\n     *\n     * @return BinaryFileResponse|JsonResponse\n     * @author Fahibram C√°rcamo\n     */\n    public function descargarGuiaAgendamientoMasivo(): BinaryFileResponse|JsonResponse {\n        try {\n            $ruta_archivo = storage_path(self::RUTA_ARCHIVO_GUIA_PARA_CARGA_MASIVA_PARTICIPANTES);\n\n            if (!file_exists($ruta_archivo)) {\n                throw new Exception('Archivo no encontrado');\n            }\n\n            return response()->download(\n                $ruta_archivo,\n                'archivo_guia_para_carga_masiva_de_participantes.xlsx',\n                ['Content-Type' => 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet']\n            );\n        } catch (Exception $excepcion) {\n            return new JsonResponse(\n                [\n                    'message' => 'Ocurri√≥ un error',\n                    'errors'  => $excepcion->getMessage()\n                ],\n                400\n            );\n        }\n    }\n\n    /**\n     * Archivar o desarchivar un proceso.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Andres Morales\n     */\n    public function archivarProceso(Request $request): JsonResponse {\n        $codigo = 200;\n\n        try {\n            DB::beginTransaction();\n            $respuesta = $this->servicio->archivarProceso($request->id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n}\n","numLines":978,"startLine":1,"totalLines":978}},"sourceToolAssistantUUID":"4f70cb1b-934c-469a-bc2e-dc10678db715"}
{"parentUuid":"1b9467f4-b243-46cc-9ea2-e9b3c6a583b7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012RmF38p7udbMZQBEaNmeQZ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfecto, ahora puedo ver el m√©todo `showFirmada` completo. El c√≥digo que el usuario quiere mover al servicio est√° en las l√≠neas 722-727:\n\n```php\n// Cargar participantes del proceso con sus relaciones\n$participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n\n$participantes->each(function ($participante) use ($id) {\n    $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n});\n```\n\nEsta l√≥gica de negocio deber√≠a estar en el servicio `ProcesoService`. Debo:\n\n1. Leer el servicio `ProcesoService` para ver su estructura\n2. Crear un m√©todo en el servicio que encapsule esta l√≥gica\n3. Actualizar el controlador para usar el nuevo m√©todo del servicio\n\nAdem√°s, veo que hay otro m√©todo similar `showResultadosAplicanteFirmada` en la l√≠nea 791 que tambi√©n podr√≠a beneficiarse de esta refactorizaci√≥n, pero el usuario solo me pidi√≥ trabajar con el c√≥digo espec√≠fico de las l√≠neas 722-727.\n\nVoy a buscar el archivo del servicio.","signature":"ErkJCkYICxgCKkBtbb+BE/iFQGg7QWiDJw6op2kjcTa7tUhJL9HppbhPdvJVy05n5LvaUW/Png+z+Z/j7ClO5oh25bn9xnkAjslyEgw2/UP+IBd4PTSE5oUaDKalCntryGsSoOuP5CIwFvesNUdYtHL30VcKa6wmCNsKFKPu/HG05looTwOT3B4VwMyJbcS+nhEbcegNW5N1KqAIEX73cWOCeF8lFX9otDfQuNTbjJtuCP3BIdQT8QUwkonmclDzTW9g26E2jEwkeujkCQ9ToWQOeRKuyBAixajk9nSVbOPwpopTfROG3S70+1DSmneWCy2IXCapTEmHwNVtzSmvWONa2Jy3a6MCAdPksXVscTEg+1NVkrGJyOAK8VRQuDMJIyx8IxfmM7IZZw8w4o+95TQMYvkcTKonKb9J9avJHihbPhv+7Q8ObH3G9b4/+xmh7xZmZFYWdSQUsyeB2UJUF/QcNkkyMczL8lXQjDNmYmN/HhG9zDrnbn58ice0STyUEnEzur4uc+69oZaEzj5hcpi8hGOopNW2IrI9VTOoWpBG/f5IjzxkyO8eINAHWMgxvr7Ce46oNxKlqfDRiZXgXaEj3NLMUDt3yqELMWRqyT4o7EtqbP/3lMgAOWOzi0nLEQTRyaGr2QWoj6kCiwMac3o+V57HJXvPkW8VtBDnFK8xEi0y2baQ1x7Tr1Hgs3hVOmwAF8VYV0+BehkSPIevHWdyvCtvAecp8pbutJcbFkt7GxKciAdtzAehU7x9fQENpR47WmOhD/QQ6xbJiUxPRe5XO/1Nry3R1GwnRQw9sWKOQVn8NEY+aATXym2Ul8BqL3pBE73caBY7iQd3LrfZG6U5/7NqjxIo4WI+IHwdPKkNgVBV78czGpfIzoP8igMyiaQjT47CdJy9Iu8b5IWaNa9jpdYDlhvtrh82RHcaTKL18Hn3DJoNJjd9+VehLAseeyPkGYmdNRzSxrp3YYA8IrSEqT+cn70n04/Ts5HuXaE5zvSnKE4z2oxyHesctomxOVgg0xw8169piSXTLGoe0p73u0t8wbfcIeDJ4qzR0COfGjFwqAfnuQYAxaQxqxGioWhEwVaqmXOfh4++N4PfU3OfM+jSPUrdN7JIkYXkrGP10T2d4nsoD/VJ/WJzdZuY+v6Ea1Hsk6QUPwobjpOksln9AhUCc5SUSBaVcYPJyFNVKOJIw8Ms64MkGP3BnRcjDyyQMYq2YXXypECCjD6hWefGEEKfan9sYGX/cddhH/cuO8zqn2EVvwY5q7DyPvgy7SQJSbZNBJ9SAHzdspYuIuP93Q0wdMX5XBqJT3z3mua0eRJ+1pAiCLbUgN2Leg7pLmRD8viWD9todur5n6UZsZVKN8uQk6nwXDvIjag0D2/tqtpyDdepKsanQy1w+vdsMF3V+ia6PZ8/PPNPtXuKclOHgzI0uCTJBynMXh5/Br5EZRdUdTjlam+XGlwBDKAb9SkXeWaJL+cOoXVJb0QOrXo2q9u0WsH+aTx4wGF1a5FQo9+IriGwJXlx3adPT98SDRS/ka3Zpx0fHSiizb/n5q5km2pKq/FwVs6QSqnPtKorr/Vx3sosBBn7YAf+1C3uOPW805Etm/iahKPrGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":13197,"cache_read_input_tokens":25811,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":13197},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLLeCRf1kiVDbpeLBjU","type":"assistant","uuid":"4e8237ce-960b-4f3e-a8cb-f8eb67238cfd","timestamp":"2026-02-06T19:03:09.734Z"}
{"parentUuid":"4e8237ce-960b-4f3e-a8cb-f8eb67238cfd","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012RmF38p7udbMZQBEaNmeQZ","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a analizar el m√©todo `showFirmada` y mover la l√≥gica al servicio. Primero d√©jame ver el servicio `ProcesoService`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":13197,"cache_read_input_tokens":25811,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":13197},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLLeCRf1kiVDbpeLBjU","type":"assistant","uuid":"af63d0ab-4b9a-4b64-a934-db14db807457","timestamp":"2026-02-06T19:03:10.492Z"}
{"parentUuid":"af63d0ab-4b9a-4b64-a934-db14db807457","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_012RmF38p7udbMZQBEaNmeQZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013Xue9soMnfC7BKzfCsvbev","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":13197,"cache_read_input_tokens":25811,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":13197},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLLeCRf1kiVDbpeLBjU","type":"assistant","uuid":"fb1324f7-61ac-43b2-9fbe-3af47e9e4f09","timestamp":"2026-02-06T19:03:11.672Z"}
{"parentUuid":"fb1324f7-61ac-43b2-9fbe-3af47e9e4f09","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013Xue9soMnfC7BKzfCsvbev","type":"tool_result","content":"     1‚Üí<?php\n     2‚Üí\n     3‚Üínamespace App\\Http\\Services\\Procesos;\n     4‚Üí\n     5‚Üíuse Exception;\n     6‚Üíuse Carbon\\Carbon;\n     7‚Üíuse GuzzleHttp\\Client;\n     8‚Üíuse App\\Traits\\IATrait;\n     9‚Üíuse App\\Traits\\FechaTrait;\n    10‚Üíuse Illuminate\\Support\\Arr;\n    11‚Üíuse Illuminate\\Support\\Str;\n    12‚Üíuse Illuminate\\Http\\Request;\n    13‚Üíuse App\\Models\\Agendas\\Agenda;\n    14‚Üíuse App\\Models\\Pruebas\\Prueba;\n    15‚Üíuse App\\Models\\Empresas\\Empresa;\n    16‚Üíuse App\\Http\\Services\\BaseService;\n    17‚Üíuse App\\Mail\\CompartirProcesoMail;\n    18‚Üíuse Illuminate\\Support\\Collection;\n    19‚Üíuse App\\Models\\Agendas\\EstadoAgenda;\n    20‚Üíuse App\\Models\\OfertasLaborales\\Etapa;\n    21‚Üíuse App\\Traits\\Pruebas\\IQFactorialTrait;\n    22‚Üíuse GuzzleHttp\\Exception\\GuzzleException;\n    23‚Üíuse GuzzleHttp\\Exception\\RequestException;\n    24‚Üíuse App\\Http\\Services\\Usuarios\\UserService;\n    25‚Üíuse App\\Http\\Services\\Agendas\\AgendaService;\n    26‚Üíuse App\\Mail\\CompartirResultadosProcesoMail;\n    27‚Üíuse Illuminate\\Support\\Facades\\{Auth, Mail};\n    28‚Üíuse App\\Mail\\DescartarParticipanteProcesoMail;\n    29‚Üíuse App\\Mail\\NotificarSeleccionParticipanteMail;\n    30‚Üíuse App\\Models\\Procesos\\{EstadoProceso,Proceso};\n    31‚Üíuse App\\Http\\Repositories\\Permisos\\RolRepository;\n    32‚Üíuse App\\Http\\Repositories\\Usuarios\\UserRepository;\n    33‚Üíuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\n    34‚Üíuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\n    35‚Üíuse App\\Http\\Repositories\\Agendas\\ResultadoAgendaRepository;\n    36‚Üíuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\n    37‚Üíuse App\\Http\\Services\\OfertasLaborales\\OfertaLaboralService;\n    38‚Üíuse App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\n    39‚Üíuse App\\Http\\Repositories\\OfertasLaborales\\EtapaUsuarioRepository;\n    40‚Üíuse App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\n    41‚Üíuse App\\Http\\Repositories\\Procesos\\{ProcesoPruebaRepository,ProcesoRepository};\n    42‚Üí\n    43‚Üí/**\n    44‚Üí * @property ProcesoRepository $repositorio\n    45‚Üí */\n    46‚Üíclass ProcesoService extends BaseService\n    47‚Üí{\n    48‚Üí    use FechaTrait, IATrait, IQFactorialTrait;\n    49‚Üí\n    50‚Üí    /**\n    51‚Üí     * Constructor.\n    52‚Üí     *\n    53‚Üí     * @param ProcesoRepository $repositorio Repositorio de procesos.\n    54‚Üí     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n    55‚Üí     * @param UserService $usuario_servicio Servicio de usuarios.\n    56‚Üí     * @param AgendaService $agenda_servicio Servicio de agendas.\n    57‚Üí     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n    58‚Üí     * @param EtapaUsuarioRepository $etapa_usuario_repositorio Repositorio de etapas de usuarios.\n    59‚Üí     * @param ProcesoPruebaRepository $proceso_prueba_repositorio Repositorio de pruebas de procesos.\n    60‚Üí     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n    61‚Üí     * @param RolRepository $rol_repositorio Repositorio de roles.\n    62‚Üí     * @param OfertaLaboralService $oferta_laboral_servicio Servicio de ofertas laborales.\n    63‚Üí     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n    64‚Üí     * @param ResultadoAgendaRepository $resultado_agenda_repositorio Repositorio de resultados de agendas.\n    65‚Üí     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n    66‚Üí     * @param PruebaRepository prueba_repositorio Repositorio de pruebas.\n    67‚Üí     * @return void\n    68‚Üí     * @author Daniel Beltr√°n\n    69‚Üí     * @author Fahibram C√°rcamo\n    70‚Üí     * @author Andres Gonzalez\n    71‚Üí     * @author Jair Carvajal\n    72‚Üí     */\n    73‚Üí    public function __construct(\n    74‚Üí        ProcesoRepository $repositorio,\n    75‚Üí        protected UserRepository $usuario_repositorio,\n    76‚Üí        protected UserService $usuario_servicio,\n    77‚Üí        protected AgendaService $agenda_servicio,\n    78‚Üí        protected AgendaRepository $agenda_repositorio,\n    79‚Üí        protected EtapaUsuarioRepository $etapa_usuario_repositorio,\n    80‚Üí        protected ProcesoPruebaRepository $proceso_prueba_repositorio,\n    81‚Üí        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n    82‚Üí        protected RolRepository $rol_repositorio,\n    83‚Üí        protected OfertaLaboralService $oferta_laboral_servicio,\n    84‚Üí        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n    85‚Üí        protected ResultadoAgendaRepository $resultado_agenda_repositorio,\n    86‚Üí        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n    87‚Üí        protected PruebaRepository $prueba_repositorio\n    88‚Üí    ) {\n    89‚Üí        parent::__construct($repositorio);\n    90‚Üí    }\n    91‚Üí\n    92‚Üí    /**\n    93‚Üí     * Guardar proceso.\n    94‚Üí     *\n    95‚Üí     * @param Request $request Contenido de la petici√≥n.\n    96‚Üí     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalizaci√≥n del proceso.\n    97‚Üí     * @throws Exception Si la fecha de finalizaci√≥n del proceso es anterior a la fecha de las agendas existentes.\n    98‚Üí     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n    99‚Üí     * @return Proceso\n   100‚Üí     * @author Daniel Beltr√°n\n   101‚Üí     * @author Fahibram C√°rcamo\n   102‚Üí     * @author Andres Morales\n   103‚Üí     * @author Andres Gonzalez\n   104‚Üí     */\n   105‚Üí    public function guardar(Request $request): Proceso {\n   106‚Üí        $campos_excluidos = ['_token', '_method', 'id', 'pruebas', 'titulo_mensaje', 'descripcion_mensaje', 'participantes'];\n   107‚Üí        $fecha_limite     = $this->calcularFechaCierreAgendas($request);\n   108‚Üí\n   109‚Üí        if (!is_null($fecha_limite)) {\n   110‚Üí            $this->validarFechas($fecha_limite, $request->fecha_cierre, $request->id);\n   111‚Üí        }\n   112‚Üí\n   113‚Üí        // Guardar solo una de las dos opciones de vencimiento de agendas\n   114‚Üí        if ($request->filled('dias_vencimiento_agendas')) {\n   115‚Üí            $request->merge(['fecha_vencimiento_agendas' => null]);\n   116‚Üí        } elseif ($request->filled('fecha_vencimiento_agendas')) {\n   117‚Üí            $request->merge(['dias_vencimiento_agendas' => null]);\n   118‚Üí        }\n   119‚Üí\n   120‚Üí        if ($request->filled('id')) {\n   121‚Üí            $proceso = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n   122‚Üí\n   123‚Üí            // Actualizar agendas con estado AGENDADA (1) cuando se modifiquen los campos de captura\n   124‚Üí            if ($request->filled('capturar_camara') || $request->filled('capturar_video')) {\n   125‚Üí                $this->actualizarCamposCapturarEnAgendas(\n   126‚Üí                    $request->id,\n   127‚Üí                    $request->capturar_camara ?? false,\n   128‚Üí                    $request->capturar_video ?? false\n   129‚Üí                );\n   130‚Üí            }\n   131‚Üí        } else {\n   132‚Üí            $usuario = Auth::user();\n   133‚Üí\n   134‚Üí            $request->merge([\n   135‚Üí                'empresa_id'   => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id,\n   136‚Üí                'usuario_id'   => $usuario->id,\n   137‚Üí                'estado_id'    => EstadoProceso::PENDIENTE_ID,\n   138‚Üí                'fecha_inicio' => Carbon::now()\n   139‚Üí            ]);\n   140‚Üí\n   141‚Üí            $proceso = $this->repositorio->crear($request->except($campos_excluidos));\n   142‚Üí\n   143‚Üí            $proceso->refresh();\n   144‚Üí        }\n   145‚Üí\n   146‚Üí        // Calcular la fecha l√≠mite\n   147‚Üí        $pruebas = [];\n   148‚Üí\n   149‚Üí        foreach ($request->pruebas as $prueba) {\n   150‚Üí            $pruebas[$prueba['id']] = [\n   151‚Üí                'perfil_id'    => $prueba['perfil_id'],\n   152‚Üí                'porcentaje'   => $prueba['porcentaje'],\n   153‚Üí                'fecha_limite' => $fecha_limite\n   154‚Üí            ];\n   155‚Üí        }\n   156‚Üí\n   157‚Üí        $this->repositorio->sincronizarPruebas($proceso, $pruebas);\n   158‚Üí\n   159‚Üí        if ($request->filled('participantes') && count($request->participantes) > 0) {\n   160‚Üí            $request->merge(['fecha_limite' => $fecha_limite]);\n   161‚Üí            $this->guardarParticipantes($proceso, $request);\n   162‚Üí            $this->repositorio->actualizar($proceso->id, ['estado_id' => 2]);\n   163‚Üí        }\n   164‚Üí\n   165‚Üí        return $proceso;\n   166‚Üí    }\n   167‚Üí\n   168‚Üí    /**\n   169‚Üí     * Guardar participantes.\n   170‚Üí     *\n   171‚Üí     * @param Proceso $proceso Proceso.\n   172‚Üí     * @param Request $request Contenido de la petici√≥n.\n   173‚Üí     * @throws Exception Si la direcci√≥n de correo electr√≥nico de nuevo participante ya fue tomada por otro usuario.\n   174‚Üí     * @return void\n   175‚Üí     * @author Daniel Beltr√°n\n   176‚Üí     * @author Fahibram C√°rcamo\n   177‚Üí     */\n   178‚Üí    public function guardarParticipantes(Proceso $proceso, Request $request): void {\n   179‚Üí        $participantes = [];\n   180‚Üí\n   181‚Üí        foreach ($request->participantes as $participante) {\n   182‚Üí            $usuario                     = $this->agenda_servicio->guardarParticipante($proceso, $participante, $request, true, true);\n   183‚Üí            $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n   184‚Üí        }\n   185‚Üí\n   186‚Üí        // Agregar los participantes a la etapa inicial\n   187‚Üí        $this->asociarEtapasUsuarios($proceso, $participantes);\n   188‚Üí\n   189‚Üí        // Asignar la etapa inicial de la oferta laboral a los participantes (cuando el proceso es de una oferta laboral)\n   190‚Üí        if (!is_null($proceso->oferta_laboral_id)) {\n   191‚Üí            foreach ($participantes as $usuario_id => $item) {\n   192‚Üí                $this->oferta_laboral_servicio->postularAplicante($proceso->oferta_laboral_id, null, $usuario_id);\n   193‚Üí            }\n   194‚Üí        }\n   195‚Üí    }\n   196‚Üí\n   197‚Üí    /**\n   198‚Üí     * Duplicar proceso.\n   199‚Üí     *\n   200‚Üí     * @param int $id ID del proceso.\n   201‚Üí     * @param Request $request Contenido de la petici√≥n.\n   202‚Üí     * @return Proceso\n   203‚Üí     * @author Daniel Beltr√°n\n   204‚Üí     * @author Sergio Vargas\n   205‚Üí     * @author Andres Gonzalez\n   206‚Üí     */\n   207‚Üí    public function duplicar(int $id, Request $request): Proceso {\n   208‚Üí        $proceso             = $this->repositorio->getUno($id);\n   209‚Üí        $datos               = Arr::only($proceso->toArray(), ['empresa_id', 'evaluador_id', 'nombre', 'fecha_inicio', 'fecha_cierre', 'cantidad_vacantes', 'intentos_permitidos', 'capturar_camara', 'capturar_video', 'mostrar_logo_aplicante', 'dias_vencimiento_agendas', 'fecha_vencimiento_agendas']);\n   210‚Üí        $datos['nombre']     = $request->filled('nombre') ? $request->nombre : $proceso->nombre . ' (Copia)';\n   211‚Üí        $datos['usuario_id'] = Auth::id();\n   212‚Üí        $datos['estado_id']  = EstadoProceso::PENDIENTE_ID;\n   213‚Üí        $datos['vacante_id'] = $request->filled('vacante_id') ? $request->vacante_id : null;\n   214‚Üí\n   215‚Üí        $proceso_nuevo = $this->repositorio->crear($datos);\n   216‚Üí        $pruebas       = [];\n   217‚Üí\n   218‚Üí        foreach ($proceso->pruebas as $prueba) {\n   219‚Üí            $pruebas[$prueba->id] = [\n   220‚Üí                'perfil_id'    => $prueba->pivot->perfil_id,\n   221‚Üí                'porcentaje'   => $prueba->pivot->porcentaje,\n   222‚Üí                'fecha_limite' => $prueba->pivot->fecha_limite\n   223‚Üí            ];\n   224‚Üí        }\n   225‚Üí\n   226‚Üí        $this->repositorio->sincronizarPruebas($proceso_nuevo, $pruebas);\n   227‚Üí\n   228‚Üí        return $this->repositorio->getUno($proceso_nuevo->id);\n   229‚Üí    }\n   230‚Üí\n   231‚Üí    /**\n   232‚Üí     * Suspender proceso.\n   233‚Üí     *\n   234‚Üí     * @param int $id ID del proceso.\n   235‚Üí     * @return Proceso\n   236‚Üí     * @author Daniel Beltr√°n\n   237‚Üí     */\n   238‚Üí    public function suspender(int $id): Proceso {\n   239‚Üí        $this->repositorio->actualizar($id, ['estado_id' => 5]);\n   240‚Üí\n   241‚Üí        // Inactivar las agendas\n   242‚Üí        $agendas     = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $id]));\n   243‚Üí        $agendas_ids = $agendas->pluck('id')->toArray();\n   244‚Üí        $this->agenda_repositorio->actualizarVarios($agendas_ids, ['activo' => false]);\n   245‚Üí\n   246‚Üí        return $this->repositorio->getUno($id);\n   247‚Üí    }\n   248‚Üí\n   249‚Üí    /**\n   250‚Üí     * Activar proceso.\n   251‚Üí     *\n   252‚Üí     * @param int $id ID del proceso.\n   253‚Üí     * @return Proceso\n   254‚Üí     * @author Daniel Beltr√°n\n   255‚Üí     */\n   256‚Üí    public function activar(int $id): Proceso {\n   257‚Üí        $proceso = $this->repositorio->getUno($id);\n   258‚Üí        $agendas = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $proceso->id]));\n   259‚Üí\n   260‚Üí        foreach ($agendas as $agenda) {\n   261‚Üí            // Expirar agendas vencidas\n   262‚Üí            if ($agenda->fecha_cierre < now()) {\n   263‚Üí                $this->agenda_repositorio->actualizar($agenda->id, ['estado_id' => 4, 'activo' => true]);\n   264‚Üí                continue;\n   265‚Üí            }\n   266‚Üí\n   267‚Üí            // Activar las agendas\n   268‚Üí            $this->agenda_repositorio->actualizar($agenda->id, ['activo' => true]);\n   269‚Üí        }\n   270‚Üí\n   271‚Üí        $this->repositorio->actualizar($proceso->id, ['estado_id' => (count($agendas) > 0 ? 2 : 1)]);\n   272‚Üí\n   273‚Üí        return $proceso->fresh();\n   274‚Üí    }\n   275‚Üí\n   276‚Üí    /**\n   277‚Üí     * Eliminar proceso.\n   278‚Üí     *\n   279‚Üí     * @param int $id ID del proceso.\n   280‚Üí     * @throws Exception Cuando el proceso tiene agendas asociadas.\n   281‚Üí     * @return void\n   282‚Üí     * @author Daniel Beltr√°n\n   283‚Üí     */\n   284‚Üí    public function eliminar(int $id): void {\n   285‚Üí        $agendas = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $id]));\n   286‚Üí\n   287‚Üí        if (count($agendas) > 0) {\n   288‚Üí            throw new Exception('No se puede eliminar un proceso con agendas asociadas.', 400);\n   289‚Üí        }\n   290‚Üí\n   291‚Üí        $this->repositorio->eliminar($id);\n   292‚Üí    }\n   293‚Üí\n   294‚Üí    /**\n   295‚Üí     * Descartar participantes.\n   296‚Üí     *\n   297‚Üí     * @param Request $request Contenido de la petici√≥n.\n   298‚Üí     * @return void\n   299‚Üí     * @author Daniel Beltr√°n\n   300‚Üí     * @author Fahibram C√°rcamo\n   301‚Üí     * @author Andres Gonzalez\n   302‚Üí     */\n   303‚Üí    public function descartarParticipantes(Request $request): void {\n   304‚Üí        $proceso       = $this->repositorio->getUno($request->id);\n   305‚Üí        $participantes = [];\n   306‚Üí\n   307‚Üí        foreach ($request->participantes as $participante_id) {\n   308‚Üí            $usuario = $this->usuario_repositorio->getUno($participante_id);\n   309‚Üí\n   310‚Üí            // Obtener la etapa actual del participante\n   311‚Üí            $etapa_actual = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n   312‚Üí                'usuario_id' => $usuario->id,\n   313‚Üí                'proceso_id' => $proceso->id\n   314‚Üí            ]));\n   315‚Üí\n   316‚Üí            // Determinar la nueva etapa basada en la etapa actual\n   317‚Üí            if ($etapa_actual && $etapa_actual->etapa_id == Etapa::DESCARTADO_PROCESO_ID) {\n   318‚Üí                // Si ya est√° descartado, cambiar a en pruebas\n   319‚Üí                $nueva_etapa_id              = Etapa::EN_PRUEBAS_ID;\n   320‚Üí                $participantes[$usuario->id] = ['etapa_id' => $nueva_etapa_id];\n   321‚Üí                $es_descartado = false;\n   322‚Üí\n   323‚Üí                // Eliminar de procesos_seleccionados (por si estaba seleccionado)\n   324‚Üí                $proceso->seleccionados()->detach($usuario->id);\n   325‚Üí            } else {\n   326‚Üí                // Si no est√° descartado, descartarlo\n   327‚Üí                $nueva_etapa_id              = Etapa::DESCARTADO_PROCESO_ID;\n   328‚Üí                $participantes[$usuario->id] = ['etapa_id' => $nueva_etapa_id];\n   329‚Üí                $es_descartado = true;\n   330‚Üí\n   331‚Üí                // Eliminar participante de procesos_seleccionados\n   332‚Üí                $proceso->seleccionados()->detach($usuario->id);\n   333‚Üí            }\n   334‚Üí\n   335‚Üí            // Enviar correo\n   336‚Üí            Mail::queue(new DescartarParticipanteProcesoMail($usuario, $proceso, $es_descartado));\n   337‚Üí\n   338‚Üí            // Actualizar la etapa del participante\n   339‚Üí            $this->etapa_usuario_repositorio->actualizar($etapa_actual->id, ['etapa_id' => $nueva_etapa_id]);\n   340‚Üí        }\n   341‚Üí    }\n   342‚Üí\n   343‚Üí    /**\n   344‚Üí     * Seleccionar un participante en un proceso.\n   345‚Üí     *\n   346‚Üí     * @param Request $request Contenido de la petici√≥n.\n   347‚Üí     * @return bool\n   348‚Üí     * @author Andres Morales\n   349‚Üí     * @author Andres Gonzalez\n   350‚Üí     * @author Fahibram C√°rcamo\n   351‚Üí     */\n   352‚Üí    public function seleccionarParticipante(Request $request): bool {\n   353‚Üí        $proceso = $this->repositorio->getUno($request->proceso_id);\n   354‚Üí        $usuario = $this->usuario_repositorio->getUno($request->participante_id);\n   355‚Üí\n   356‚Üí        // Validar que no se hayan completado las vacantes del proceso\n   357‚Üí        if ($proceso->seleccionados_count >= $proceso->cantidad_vacantes) {\n   358‚Üí            throw new Exception('No se puede seleccionar al participante porque ya se han completado todas las vacantes del proceso.');\n   359‚Üí        }\n   360‚Üí\n   361‚Üí        // Validar que todas las agendas del participante en este proceso est√©n finalizadas\n   362‚Üí        $agendas = $this->agenda_repositorio->getTodo(new Request([\n   363‚Üí            'proceso_id'  => $proceso->id,\n   364‚Üí            'evaluado_id' => $usuario->id\n   365‚Üí        ]));\n   366‚Üí\n   367‚Üí        $agendas_no_finalizadas = $agendas->filter(function ($agenda) {\n   368‚Üí            return $agenda->estado_id !== EstadoAgenda::FINALIZADA_ID;\n   369‚Üí        });\n   370‚Üí\n   371‚Üí        if ($agendas_no_finalizadas->isNotEmpty()) {\n   372‚Üí            throw new Exception('No se puede seleccionar el participante porque tiene agendas pendientes sin finalizar');\n   373‚Üí        }\n   374‚Üí\n   375‚Üí        // Cambiar la etapa del participante a \"Seleccionados\"\n   376‚Üí        $etapa = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n   377‚Üí            'usuario_id' => $usuario->id,\n   378‚Üí            'proceso_id' => $proceso->id\n   379‚Üí        ]));\n   380‚Üí\n   381‚Üí        if ($etapa) {\n   382‚Üí            $this->etapa_usuario_repositorio->actualizar($etapa->id, ['etapa_id' => Etapa::SELECCIONADOS_ID]);\n   383‚Üí        }\n   384‚Üí\n   385‚Üí        // Obtener el √≠ndice de talento del participante\n   386‚Üí        $indice_talento_resultado = $this->repositorio->obtenerIndiceTalento($proceso->id, $usuario->id);\n   387‚Üí        $indice_talento           = $indice_talento_resultado->indice_talento ?? 0;\n   388‚Üí\n   389‚Üí        // Agregar el participante a la tabla procesos_seleccionados si no existe\n   390‚Üí        if (!$this->repositorio->estaSeleccionado($proceso->id, $usuario->id)) {\n   391‚Üí            $this->repositorio->agregarSeleccionado($proceso->id, $usuario->id, [\n   392‚Üí                'indice_talento' => $indice_talento\n   393‚Üí            ]);\n   394‚Üí        }\n   395‚Üí\n   396‚Üí        // Env√≠a el mensaje de correo electr√≥nico de notificaci√≥n de selecci√≥n al participante.\n   397‚Üí        Mail::to($usuario->email)->queue(new NotificarSeleccionParticipanteMail($usuario, $proceso));\n   398‚Üí\n   399‚Üí        // Valida si ya se seleccionaron todos los usuarios para el proceso y cierra el proceso\n   400‚Üí        $proceso = $this->repositorio->getUno($request->proceso_id);\n   401‚Üí\n   402‚Üí        if ($proceso->seleccionados_count == $proceso->cantidad_vacantes) {\n   403‚Üí            $proceso_cerrado = true;\n   404‚Üí            $this->repositorio->actualizar($request->proceso_id, ['estado_id' => EstadoProceso::CERRADO_ID]);\n   405‚Üí        }\n   406‚Üí\n   407‚Üí        return $proceso_cerrado ?? false;\n   408‚Üí    }\n   409‚Üí\n   410‚Üí    /**\n   411‚Üí     * Mover participantes de un proceso a otro.\n   412‚Üí     *\n   413‚Üí     * @param Request $request Contenido de la petici√≥n.\n   414‚Üí     * @return void\n   415‚Üí     * @author Daniel Beltr√°n\n   416‚Üí     * @author Fahibram C√°rcamo\n   417‚Üí     */\n   418‚Üí    public function moverDeProceso(Request $request): void {\n   419‚Üí        $proceso_actual   = $this->repositorio->getUno($request->proceso_actual_id);\n   420‚Üí        $proceso_destino  = $this->repositorio->getUno($request->proceso_destino_id);\n   421‚Üí        $pruebas_actuales = $proceso_actual->pruebas->pluck('id')->toArray();\n   422‚Üí        $pruebas_destino  = $proceso_destino->pruebas->pluck('id')->toArray();\n   423‚Üí        $fecha_limite     = $this->calcularFechaCierreAgendas($request);\n   424‚Üí        $this->validarFechas($fecha_limite, $proceso_destino->fecha_cierre, $proceso_destino->id);\n   425‚Üí\n   426‚Üí        // Validar si se agrega el participante al nuevo proceso manteniendo tambi√©n sus\n   427‚Üí        // agendamientos en el proceso actual.\n   428‚Üí        if (filter_var($request->mantener_en_proceso, FILTER_VALIDATE_BOOLEAN)) {\n   429‚Üí            $participantes = [];\n   430‚Üí\n   431‚Üí            foreach ($request->participantes as $participante_id) {\n   432‚Üí                $usuario = $this->usuario_repositorio->getUno($participante_id);\n   433‚Üí\n   434‚Üí                foreach ($pruebas_destino as $prueba_id) {\n   435‚Üí                    // Validar que el participante no tenga una agenda de la misma prueba en el\n   436‚Üí                    // proceso destino.\n   437‚Üí                    $agendas_participante_proceso_actual = $this->agenda_repositorio->getTodo(new Request([\n   438‚Üí                        'proceso_id'  => $proceso_destino->id,\n   439‚Üí                        'evaluado_id' => $usuario->id,\n   440‚Üí                        'prueba_id'   => $prueba_id\n   441‚Üí                    ]));\n   442‚Üí\n   443‚Üí                    if (count($agendas_participante_proceso_actual) > 0) {\n   444‚Üí                        continue;\n   445‚Üí                    }\n   446‚Üí\n   447‚Üí                    $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n   448‚Üí                        'proceso_id' => $proceso_destino->id,\n   449‚Üí                        'prueba_id'  => $prueba_id\n   450‚Üí                    ]));\n   451‚Üí\n   452‚Üí                    $this->agenda_servicio->agendar($proceso_destino, $usuario, $prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n   453‚Üí                    $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n   454‚Üí                }\n   455‚Üí\n   456‚Üí                // Enviar correo de notificaci√≥n\n   457‚Üí                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso_destino);\n   458‚Üí            }\n   459‚Üí\n   460‚Üí            // Agregar la etapa a los participantes\n   461‚Üí            $this->asociarEtapasUsuarios($proceso_destino, $participantes);\n   462‚Üí        } else {\n   463‚Üí            $participantes = [];\n   464‚Üí\n   465‚Üí            foreach ($request->participantes as $participante_id) {\n   466‚Üí                $usuario                     = $this->usuario_repositorio->getUno($participante_id);\n   467‚Üí                $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n   468‚Üí\n   469‚Üí                // Obtener las agendas del participante en el proceso actual\n   470‚Üí                $agendas_participante_proceso_actual = $this->agenda_repositorio->getTodo(new Request([\n   471‚Üí                    'proceso_id'  => $proceso_actual->id,\n   472‚Üí                    'evaluado_id' => $usuario->id\n   473‚Üí                ]));\n   474‚Üí\n   475‚Üí                foreach ($agendas_participante_proceso_actual as $agenda_participante_proceso_actual) {\n   476‚Üí                    if (in_array($agenda_participante_proceso_actual->prueba_id, $pruebas_destino)) {\n   477‚Üí                        // Si la prueba de la agenda del proceso actual existe en el proceso de\n   478‚Üí                        // destino se modifica la agenda para que est√© relacionada con el proceso de\n   479‚Üí                        // destino, con su empresa y con su perfil asociado.\n   480‚Üí                        $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n   481‚Üí                            'proceso_id' => $proceso_destino->id,\n   482‚Üí                            'prueba_id'  => $agenda_participante_proceso_actual->prueba_id\n   483‚Üí                        ]));\n   484‚Üí\n   485‚Üí                        if (!is_null($proceso_prueba_destino)) {\n   486‚Üí                            $this->agenda_repositorio->actualizar($agenda_participante_proceso_actual->id, [\n   487‚Üí                                'empresa_id'      => $proceso_destino->empresa_id,\n   488‚Üí                                'proceso_id'      => $proceso_destino->id,\n   489‚Üí                                'perfil_id'       => $proceso_prueba_destino->perfil_id,\n   490‚Üí                                'fecha_cierre'    => $fecha_limite,\n   491‚Üí                                'capturar_camara' => $proceso_destino->capturar_camara,\n   492‚Üí                                'capturar_video'  => $proceso_destino->capturar_video\n   493‚Üí                            ]);\n   494‚Üí\n   495‚Üí                            // Si la agenda est√° invalidada se crea una nueva en el proceso nuevo\n   496‚Üí                            if ($agenda_participante_proceso_actual->estado_id == EstadoAgenda::INVALIDADA_ID) {\n   497‚Üí                                $this->agenda_servicio->agendar($proceso_destino, $usuario, $proceso_prueba_destino->prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n   498‚Üí                            }\n   499‚Üí                        }\n   500‚Üí                    } else {\n   501‚Üí                        // Si no es as√≠ solamente se relaciona la agenda con el proceso de destino y\n   502‚Üí                        // con su empresa.\n   503‚Üí                        $this->agenda_repositorio->actualizar($agenda_participante_proceso_actual->id, [\n   504‚Üí                            'empresa_id'   => $proceso_destino->empresa_id,\n   505‚Üí                            'proceso_id'   => $proceso_destino->id,\n   506‚Üí                            'fecha_cierre' => $fecha_limite\n   507‚Üí                        ]);\n   508‚Üí                    }\n   509‚Üí                }\n   510‚Üí\n   511‚Üí                // Crear las agendas en el nuevo proceso, validando que no se dupliquen\n   512‚Üí                foreach ($pruebas_destino as $prueba_id) {\n   513‚Üí                    $existe_agenda = $this->agenda_repositorio->getUnoAvanzado(new Request([\n   514‚Üí                        'proceso_id'  => $proceso_destino->id,\n   515‚Üí                        'prueba_id'   => $prueba_id,\n   516‚Üí                        'evaluado_id' => $usuario->id\n   517‚Üí                    ]));\n   518‚Üí\n   519‚Üí                    if (!$existe_agenda) {\n   520‚Üí                        $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n   521‚Üí                            'proceso_id' => $proceso_destino->id,\n   522‚Üí                            'prueba_id'  => $prueba_id\n   523‚Üí                        ]));\n   524‚Üí\n   525‚Üí                        $this->agenda_servicio->agendar($proceso_destino, $usuario, $prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n   526‚Üí                    }\n   527‚Üí                }\n   528‚Üí\n   529‚Üí                // Enviar correo de notificaci√≥n\n   530‚Üí                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso_destino);\n   531‚Üí            }\n   532‚Üí\n   533‚Üí            // Actualizar las etapas de los participantes\n   534‚Üí            $this->repositorio->disociarEtapasUsuarios($proceso_actual, array_keys($participantes));\n   535‚Üí            $this->asociarEtapasUsuarios($proceso_destino, $participantes);\n   536‚Üí        }\n   537‚Üí    }\n   538‚Üí\n   539‚Üí    /**\n   540‚Üí     * Eliminar un participante de un proceso.\n   541‚Üí     *\n   542‚Üí     * @param int $proceso_id ID del proceso.\n   543‚Üí     * @param int $usuario_id ID del usuario.\n   544‚Üí     * @return void\n   545‚Üí     * @author Daniel Beltr√°n\n   546‚Üí     */\n   547‚Üí    public function eliminarParticipante(int $proceso_id, int $usuario_id): void {\n   548‚Üí        $proceso = $this->repositorio->getUno($proceso_id);\n   549‚Üí\n   550‚Üí        $this->repositorio->disociarEtapasUsuarios($proceso, [$usuario_id]);\n   551‚Üí        $this->agenda_repositorio->eliminarAvanzado(new Request([\n   552‚Üí            'proceso_id'  => $proceso_id,\n   553‚Üí            'evaluado_id' => $usuario_id\n   554‚Üí        ]), true);\n   555‚Üí\n   556‚Üí        $agendas = $this->agenda_repositorio->getTodo(new Request([\n   557‚Üí            'empresa_id'  => $proceso->empresa_id,\n   558‚Üí            'evaluado_id' => $usuario_id\n   559‚Üí        ]));\n   560‚Üí\n   561‚Üí        // Si no existen agendas para la misma empresa, entonces se elimina el usuario como candidato de esa empresa\n   562‚Üí        if (count($agendas) == 0) {\n   563‚Üí            $this->empresa_usuario_repositorio->eliminarPorEmpresaUsuarioRol(new Request([\n   564‚Üí                'empresa_id' => $proceso->empresa_id,\n   565‚Üí                'usuario_id' => $usuario_id,\n   566‚Üí                'rol_id'     => $this->rol_repositorio::ROL_EVALUADO_ID\n   567‚Üí            ]));\n   568‚Üí        }\n   569‚Üí    }\n   570‚Üí\n   571‚Üí    /**\n   572‚Üí     * Agregar participantes al proceso.\n   573‚Üí     *\n   574‚Üí     * @param int $id ID del proceso.\n   575‚Üí     * @param Request $request Contenido de la petici√≥n.\n   576‚Üí     * @throws Exception Si la direcci√≥n de correo electr√≥nico de nuevo participante ya fue tomada por otro usuario.\n   577‚Üí     * @return void\n   578‚Üí     * @author Daniel Beltr√°n\n   579‚Üí     * @author Fahibram C√°rcamo\n   580‚Üí     */\n   581‚Üí    public function agregarParticipantes(int $id, Request $request): void {\n   582‚Üí        $proceso              = $this->repositorio->getUno($id);\n   583‚Üí        $fecha_cierre_agendas = $this->calcularFechaCierreAgendas($request);\n   584‚Üí        $this->validarFechas($fecha_cierre_agendas, $proceso->fecha_cierre, $id);\n   585‚Üí        $request->merge([\n   586‚Üí            'fecha_limite'    => $fecha_cierre_agendas,\n   587‚Üí            'capturar_camara' => $proceso->capturar_camara,\n   588‚Üí            'capturar_video'  => $proceso->capturar_video\n   589‚Üí        ]);\n   590‚Üí\n   591‚Üí        // Guardar participantes\n   592‚Üí        $this->guardarParticipantes($proceso, $request);\n   593‚Üí        $this->repositorio->actualizar($proceso->id, ['estado_id' => EstadoProceso::ACTIVO_ID]);\n   594‚Üí    }\n   595‚Üí\n   596‚Üí    /**\n   597‚Üí     * Validar las fechas de cierre del proceso y sus agendas.\n   598‚Üí     *\n   599‚Üí     * @param string $fecha_cierre_agendas Fecha de cierre de agendas.\n   600‚Üí     * @param string|null $fecha_cierre_proceso Fecha de cierre del proceso.\n   601‚Üí     * @param int|null $id ID del proceso.\n   602‚Üí     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n   603‚Üí     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalizaci√≥n del proceso.\n   604‚Üí     * @throws Exception Si la fecha de finalizaci√≥n del proceso es anterior a la fecha de las agendas existentes.\n   605‚Üí     * @return void\n   606‚Üí     * @author Daniel Beltr√°n\n   607‚Üí     */\n   608‚Üí    private function validarFechas(string $fecha_cierre_agendas, ?string $fecha_cierre_proceso = null, ?int $id = null): void {\n   609‚Üí        $fecha_cierre_agendas = Carbon::createFromDate($fecha_cierre_agendas);\n   610‚Üí\n   611‚Üí        if ($fecha_cierre_agendas < now()) {\n   612‚Üí            throw new Exception('La fecha de vencimiento de las agendas no puede ser anterior a la fecha actual.', 400);\n   613‚Üí        }\n   614‚Üí\n   615‚Üí        if (!is_null($fecha_cierre_proceso)) {\n   616‚Üí            // Validar que la fecha de vencimiento de las agendas no sea posterior a la fecha de cierre del proceso\n   617‚Üí            if ($fecha_cierre_agendas > $fecha_cierre_proceso) {\n   618‚Üí                throw new Exception('La fecha de vencimiento de las agendas no puede ser posterior a la fecha de finalizaci√≥n del proceso.', 400);\n   619‚Üí            }\n   620‚Üí\n   621‚Üí            // Validar que la fecha de cierre del proceso no sea anterior a la fecha de las agendas existentes\n   622‚Üí            if (!is_null($id) && $this->agenda_repositorio->existenAgendasPosterioresAlCierreDelProceso($id, $fecha_cierre_proceso)) {\n   623‚Üí                throw new Exception('La fecha de finalizaci√≥n del proceso no puede ser anterior a la fecha de las agendas existentes.', 400);\n   624‚Üí            }\n   625‚Üí        }\n   626‚Üí    }\n   627‚Üí\n   628‚Üí    /**\n   629‚Üí     * Reagendar participantes.\n   630‚Üí     *\n   631‚Üí     * @param Request $request Contenido de la petici√≥n.\n   632‚Üí     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n   633‚Üí     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalizaci√≥n del proceso.\n   634‚Üí     * @throws Exception Si la fecha de finalizaci√≥n del proceso es anterior a la fecha de las agendas existentes.\n   635‚Üí     * @return array Informaci√≥n sobre el reagendamiento realizado.\n   636‚Üí     * @author Daniel Beltr√°n\n   637‚Üí     * @author Fahibram C√°rcamo\n   638‚Üí     * @author Andres Gonzalez\n   639‚Üí     * @author Sergio Vargas\n   640‚Üí     * @author Jair Carvajal\n   641‚Üí     */\n   642‚Üí    public function reagendarParticipantes(Request $request): array {\n   643‚Üí        $proceso = $this->repositorio->getUno($request->proceso_id);\n   644‚Üí\n   645‚Üí        // Validar la configuraci√≥n de captura de c√°mara y v√≠deo\n   646‚Üí        if ($request->filled('capturar_camara') && filter_var($request->capturar_camara, FILTER_VALIDATE_BOOLEAN) && !$proceso->capturar_camara) {\n   647‚Üí            $request->merge(['capturar_camara' => false]);\n   648‚Üí        }\n   649‚Üí\n   650‚Üí        if ($request->filled('capturar_video') && filter_var($request->capturar_video, FILTER_VALIDATE_BOOLEAN) && !$proceso->capturar_video) {\n   651‚Üí            $request->merge(['capturar_video' => false]);\n   652‚Üí        }\n   653‚Üí\n   654‚Üí        $request->merge(['fecha_cierre' => $this->calcularFechaCierreAgendas($request)]);\n   655‚Üí        $this->validarFechas($request->fecha_cierre, $proceso->fecha_cierre, $proceso->id);\n   656‚Üí\n   657‚Üí        $resultado = [\n   658‚Üí            'agendas_reagendadas'       => 0,\n   659‚Üí            'agendas_reprogramadas'     => 0,\n   660‚Üí            'agendas_omitidas'          => 0,\n   661‚Üí            'participantes_notificados' => 0,\n   662‚Üí            'limite_agendas'            => 0,\n   663‚Üí            'mensajes_limite'           => []\n   664‚Üí        ];\n   665‚Üí\n   666‚Üí        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);\n   667‚Üí\n   668‚Üí        foreach ($request->participantes as $participante_id) {\n   669‚Üí            $usuario                       = $this->usuario_repositorio->getUno($participante_id);\n   670‚Üí            $agendas_usuario_reagendadas   = 0;\n   671‚Üí            $agendas_usuario_reprogramadas = 0;\n   672‚Üí            $agendas_usuario_omitidas      = 0;\n   673‚Üí\n   674‚Üí            if ($request->filled('email')) {\n   675‚Üí                $usuario->email = $request->email;\n   676‚Üí            }\n   677‚Üí\n   678‚Üí            foreach ($request->pruebas as $prueba_id) {\n   679‚Üí                // Obtener agendas en estado agendadas, iniciadas o expiradas para esta prueba espec√≠fica\n   680‚Üí                $agendas_activas = $this->agenda_repositorio->getTodo(new Request([\n   681‚Üí                    'proceso_id'  => $proceso->id,\n   682‚Üí                    'evaluado_id' => $participante_id,\n   683‚Üí                    'prueba_id'   => $prueba_id,\n   684‚Üí                    'estados_ids' => [EstadoAgenda::AGENDADA_ID, EstadoAgenda::INICIADA_ID, EstadoAgenda::EXPIRADA_ID]\n   685‚Üí                ]));\n   686‚Üí\n   687‚Üí                if ($agendas_activas->isNotEmpty()) {\n   688‚Üí                    // Si ya existe una agenda AGENDADA, INICIADA o EXPIRADA, solo actualizar la primera\n   689‚Üí                    $agenda_activa = $agendas_activas->first();\n   690‚Üí\n   691‚Üí                    // Cuando la agenda tiene estado expirada, se resetea todo y se devuelve a estado sin iniciar\n   692‚Üí                    if ($agenda_activa->estado_id === EstadoAgenda::EXPIRADA_ID) {\n   693‚Üí                        $this->agenda_servicio->restablecerAgenda($agenda_activa->id);\n   694‚Üí                    }\n   695‚Üí\n   696‚Üí                    $this->agenda_repositorio->actualizar($agenda_activa->id, Arr::only($request->all(), ['estado_id', 'fecha_cierre', 'capturar_camara', 'capturar_video']));\n   697‚Üí                    $agendas_usuario_reprogramadas++;\n   698‚Üí                } else {\n   699‚Üí                    // Si no existe agenda activa, buscar la agenda principal m√°s reciente para reagendar\n   700‚Üí                    $agenda_principal = $this->agenda_repositorio->getTodo(new Request([\n   701‚Üí                        'proceso_id'             => $proceso->id,\n   702‚Üí                        'evaluado_id'            => $participante_id,\n   703‚Üí                        'prueba_id'              => $prueba_id,\n   704‚Üí                        'solo_principales'       => true,\n   705‚Üí                        'contar_reagendamientos' => true\n   706‚Üí                    ]))->first();\n   707‚Üí\n   708‚Üí                    if (!$agenda_principal) {\n   709‚Üí                        continue; // Si no existe agenda para esta prueba, continuar con la siguiente\n   710‚Üí                    }\n   711‚Üí                    // Se agrega 1 conteo m√°s porque el l√≠mite de reagendamientos es el l√≠mite de pruebas - Hablado con yhey 25/09/2025\n   712‚Üí                    $agenda_principal->reagendamientos++;\n   713‚Üí                    $resultado['limite_agendas'] = intval($configuracion->valor);\n   714‚Üí\n   715‚Üí                    // Validar l√≠mite m√°ximo de 3 reagendamientos\n   716‚Üí                    if ($agenda_principal->reagendamientos >= intval($configuracion->valor)) {\n   717‚Üí                        $agendas_usuario_omitidas++;\n   718‚Üí\n   719‚Üí                        $resultado['mensajes_limite'][] = [\n   720‚Üí                            'participante'    => $usuario->nombre_completo,\n   721‚Üí                            'prueba'          => $agenda_principal->prueba->nombre ?? 'Prueba sin nombre',\n   722‚Üí                            'reagendamientos' => $agenda_principal->reagendamientos\n   723‚Üí                        ];\n   724‚Üí\n   725‚Üí                        continue;\n   726‚Üí                    }\n   727‚Üí\n   728‚Üí                    // Crear nueva agenda (reagendamiento)\n   729‚Üí                    $datos                    = Arr::only($agenda_principal->toArray(), ['empresa_id', 'proceso_id', 'prueba_id', 'baremo_id', 'perfil_id', 'evaluador_id', 'evaluado_id', 'cargo_id', 'clasificacion_id', 'ajuste']);\n   730‚Üí                    $datos['agenda_id']       = $agenda_principal->id;\n   731‚Üí                    $datos['estado_id']       = EstadoAgenda::AGENDADA_ID;\n   732‚Üí                    $datos['fecha_inicio']    = now();\n   733‚Üí                    $datos['fecha_cierre']    = $request->fecha_cierre;\n   734‚Üí                    $datos['capturar_camara'] = $request->capturar_camara ?? false;\n   735‚Üí                    $datos['capturar_video']  = $request->capturar_video ?? false;\n   736‚Üí                    $this->agenda_repositorio->crear($datos);\n   737‚Üí\n   738‚Üí                    $agendas_usuario_reagendadas++;\n   739‚Üí                }\n   740‚Üí            }\n   741‚Üí\n   742‚Üí            $resultado['agendas_reagendadas']   += $agendas_usuario_reagendadas;\n   743‚Üí            $resultado['agendas_reprogramadas'] += $agendas_usuario_reprogramadas;\n   744‚Üí            $resultado['agendas_omitidas']      += $agendas_usuario_omitidas;\n   745‚Üí\n   746‚Üí            // Enviar correo de notificaci√≥n si se reagend√≥ o reprogram√≥ al menos una agenda para este usuario\n   747‚Üí            if ($agendas_usuario_reagendadas > 0 || $agendas_usuario_reprogramadas > 0) {\n   748‚Üí                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso, $proceso->mostrar_logo_aplicante);\n   749‚Üí                $resultado['participantes_notificados']++;\n   750‚Üí            }\n   751‚Üí        }\n   752‚Üí\n   753‚Üí        return $resultado;\n   754‚Üí    }\n   755‚Üí\n   756‚Üí    /**\n   757‚Üí     * Asociar etapas de usuarios al proceso.\n   758‚Üí     *\n   759‚Üí     * Si el usuario ya tiene una etapa asociada al proceso, entonces no se guardar√° el registro.\n   760‚Üí     *\n   761‚Üí     * @param Proceso $proceso Proceso.\n   762‚Üí     * @param array $usuarios ID's de los usuarios con sus etapas.\n   763‚Üí     * @return void\n   764‚Üí     * @author Daniel Beltr√°n\n   765‚Üí     */\n   766‚Üí    public function asociarEtapasUsuarios(Proceso $proceso, array $usuarios): void {\n   767‚Üí        foreach (array_keys($usuarios) as $usuario_id) {\n   768‚Üí            $existe = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n   769‚Üí                'usuario_id' => $usuario_id,\n   770‚Üí                'proceso_id' => $proceso->id\n   771‚Üí            ]));\n   772‚Üí\n   773‚Üí            if ($existe) {\n   774‚Üí                unset($usuarios[$usuario_id]);\n   775‚Üí            }\n   776‚Üí        }\n   777‚Üí\n   778‚Üí        $this->repositorio->asociarEtapasUsuarios($proceso, $usuarios);\n   779‚Üí    }\n   780‚Üí\n   781‚Üí    /**\n   782‚Üí     * Env√≠ar el mensaje de correo electr√≥nico que contiene el link del proceso a todos los destinatarios.\n   783‚Üí     *\n   784‚Üí     * @param Request $request Contenido de la petici√≥n HTTP.\n   785‚Üí     * @return void\n   786‚Üí     * @author Fahibram C√°rcamo\n   787‚Üí     */\n   788‚Üí    public function compartirProceso(Request $request): void {\n   789‚Üí        $proceso = $this->repositorio->getUno($request->proceso_id);\n   790‚Üí\n   791‚Üí        foreach ($request->emails_destinatarios as $email_destinatario) {\n   792‚Üí            Mail::to($email_destinatario)\n   793‚Üí                ->queue(new CompartirProcesoMail(\n   794‚Üí                    $proceso,\n   795‚Üí                    trim(strtolower($email_destinatario)),\n   796‚Üí                    $request->fecha_hora_expiracion,\n   797‚Üí                    $request->contenido\n   798‚Üí                ));\n   799‚Üí        }\n   800‚Üí    }\n   801‚Üí\n   802‚Üí    /**\n   803‚Üí     * Env√≠ar el mensaje de correo electr√≥nico que contiene el link de los resultados de un usuario aplicante en un proceso a todos los destinatarios.\n   804‚Üí     *\n   805‚Üí     * @param Request $request Contenido de la petici√≥n HTTP.\n   806‚Üí     * @return void\n   807‚Üí     * @author Fahibram C√°rcamo\n   808‚Üí     */\n   809‚Üí    public function compartirResultadosProcesoAplicante(Request $request): void {\n   810‚Üí        foreach ($request->emails_destinatarios as $email_destinatario) {\n   811‚Üí            Mail::to($email_destinatario)\n   812‚Üí                ->queue(new CompartirResultadosProcesoMail(\n   813‚Üí                    $this->repositorio->getUno($request->proceso_id),\n   814‚Üí                    $this->usuario_repositorio->getUno($request->aplicante_id),\n   815‚Üí                    trim(strtolower($email_destinatario)),\n   816‚Üí                    $request->fecha_hora_expiracion,\n   817‚Üí                    $request->contenido\n   818‚Üí                ));\n   819‚Üí        }\n   820‚Üí    }\n   821‚Üí\n   822‚Üí    /**\n   823‚Üí     * Obtener las pruebas que tiene que realizar el aplicante, agrupadas por proceso.\n   824‚Üí     *\n   825‚Üí     * Se filtran los resultados de tal manera que obtenga √∫nicamente los que tienen agendas\n   826‚Üí     * pendientes por completar.\n   827‚Üí     *\n   828‚Üí     * Se modific√≥ esta funci√≥n para retornar no solamente las pruebas de los usuarios con rol\n   829‚Üí     * aplicante si no tambien los que tienen rol de tipo empresa.\n   830‚Üí     *\n   831‚Üí     * @param Request $request Contenido de la petici√≥n.\n   832‚Üí     * @return Collection\n   833‚Üí     * @author Daniel Beltr√°n\n   834‚Üí     * @author Fahibram C√°rcamo\n   835‚Üí     * @author Andres Gonzalez\n   836‚Üí     * @author Jair Carvajal\n   837‚Üí     */\n   838‚Üí    public function obtenerPruebasAplicante(Request $request): Collection {\n   839‚Üí        $orden_pruebas = [\n   840‚Üí            Prueba::IQ_FACTORIAL_ID,\n   841‚Üí            Prueba::TEN_DISC_PLUS_ID,\n   842‚Üí            Prueba::TEN_DISC_ID,\n   843‚Üí            Prueba::POTENCIAL_COMERCIAL_ID,\n   844‚Üí            Prueba::PRUEBA_ESTATAL_ID,\n   845‚Üí            Prueba::ETHIKOS_ID,\n   846‚Üí            Prueba::ETHIKOS_RIESGOS_ID,\n   847‚Üí            Prueba::VYP_ID\n   848‚Üí        ];\n   849‚Üí\n   850‚Üí        $procesos = $this->repositorio->obtenerPruebasAplicante($request)\n   851‚Üí            ->filter(function ($proceso) {\n   852‚Üí                $agendas_completadas = $proceso->agendas->filter(function ($agenda) {\n   853‚Üí                    return in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n   854‚Üí                });\n   855‚Üí\n   856‚Üí                return $agendas_completadas->count() !== $proceso->agendas->count();\n   857‚Üí            })\n   858‚Üí            ->each(function ($proceso) use ($orden_pruebas) { // Ordenar las agendas seg√∫n la prueba a la que pertenezcan\n   859‚Üí                $agendas_pendientes = $proceso->agendas->filter(function ($agenda) {\n   860‚Üí                    return !in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n   861‚Üí                });\n   862‚Üí\n   863‚Üí                $agendas_ordenadas = $agendas_pendientes->sortBy(function ($agenda) use ($orden_pruebas) {\n   864‚Üí                    $posicion = array_search($agenda->prueba_id, $orden_pruebas);\n   865‚Üí                    return !$posicion ? $posicion : 999;\n   866‚Üí                })->values();\n   867‚Üí\n   868‚Üí                // Se asigna de esta forma, ya que, de no hacerlo, nunca se asigna el valor modificado a la relaci√≥n\n   869‚Üí                $proceso->setRelation('agendas', $agendas_ordenadas);\n   870‚Üí            })\n   871‚Üí            ->filter(function ($proceso) {\n   872‚Üí                return $proceso->agendas->isNotEmpty();\n   873‚Üí            });\n   874‚Üí\n   875‚Üí        return $procesos;\n   876‚Üí    }\n   877‚Üí\n   878‚Üí    /**\n   879‚Üí     * Obtener pruebas completadas del aplicante (agendas finalizadas o expiradas).\n   880‚Üí     *\n   881‚Üí     * @param Request $request Contenido de la petici√≥n.\n   882‚Üí     * @return Collection\n   883‚Üí     * @author Jair Carvajal\n   884‚Üí     * @author Andres Gonzalez\n   885‚Üí     */\n   886‚Üí    public function obtenerPruebasAplicanteCompletadas(Request $request): Collection {\n   887‚Üí        $orden_pruebas = [\n   888‚Üí            Prueba::IQ_FACTORIAL_ID,\n   889‚Üí            Prueba::TEN_DISC_PLUS_ID,\n   890‚Üí            Prueba::TEN_DISC_ID,\n   891‚Üí            Prueba::POTENCIAL_COMERCIAL_ID,\n   892‚Üí            Prueba::PRUEBA_ESTATAL_ID,\n   893‚Üí            Prueba::ETHIKOS_ID,\n   894‚Üí            Prueba::ETHIKOS_RIESGOS_ID,\n   895‚Üí            Prueba::VYP_ID\n   896‚Üí        ];\n   897‚Üí\n   898‚Üí        // Agregar el par√°metro para incluir procesos cerrados\n   899‚Üí        $request->merge(['incluir_procesos_cerrados' => true]);\n   900‚Üí\n   901‚Üí        $procesos = $this->repositorio->obtenerPruebasAplicante($request)\n   902‚Üí            ->each(function ($proceso) use ($orden_pruebas) { // Filtrar y ordenar solo agendas completadas\n   903‚Üí                // Filtrar solo agendas completadas (finalizadas o expiradas)\n   904‚Üí                $agendas_completadas = $proceso->agendas->filter(function ($agenda) {\n   905‚Üí                    return in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n   906‚Üí                });\n   907‚Üí\n   908‚Üí                $agendas_ordenadas = $agendas_completadas->sortBy(function ($agenda) use ($orden_pruebas) {\n   909‚Üí                    $posicion = array_search($agenda->prueba_id, $orden_pruebas);\n   910‚Üí                    return !$posicion ? $posicion : 999;\n   911‚Üí                })->values();\n   912‚Üí\n   913‚Üí                // Calcular IQ para agendas de IQ Factorial finalizadas\n   914‚Üí                $agendas_ordenadas = $agendas_ordenadas->map(function ($agenda) {\n   915‚Üí                    if ($agenda->prueba_id == Prueba::IQ_FACTORIAL_ID && $agenda->estado_id == Agenda::ESTADO_FINALIZADA_ID) {\n   916‚Üí                        // Cargar la relaci√≥n dimension.factor si no est√° cargada\n   917‚Üí                        if (!$agenda->resultados->first()?->relationLoaded('dimension')) {\n   918‚Üí                            $agenda->load('resultados.dimension.factor');\n   919‚Üí                        }\n   920‚Üí\n   921‚Üí                        // Agrupar resultados por factor_id y obtener todas las dimensiones\n   922‚Üí                        $resultados_por_factor = $agenda->resultados->groupBy(function ($resultado) {\n   923‚Üí                            return $resultado->dimension->factor_id ?? null;\n   924‚Üí                        })->filter(fn($grupo, $llave) => !is_null($llave));\n   925‚Üí\n   926‚Üí                        $dimensiones = $resultados_por_factor->flatten()->values();\n   927‚Üí\n   928‚Üí                        if ($dimensiones->count() > 0 && $resultados_por_factor->count() > 0) {\n   929‚Üí                            $agenda->iq = round($this->calcularIQ($dimensiones->toArray(), $resultados_por_factor->count()));\n   930‚Üí                        }\n   931‚Üí                    }\n   932‚Üí\n   933‚Üí                    return $agenda;\n   934‚Üí                });\n   935‚Üí\n   936‚Üí                // Se asigna de esta forma, ya que, de no hacerlo, nunca se asigna el valor modificado a la relaci√≥n\n   937‚Üí                $proceso->setRelation('agendas', $agendas_ordenadas);\n   938‚Üí            })\n   939‚Üí            ->filter(function ($proceso) {\n   940‚Üí                // Solo incluir procesos que tengan al menos una agenda completada\n   941‚Üí                return $proceso->agendas->isNotEmpty();\n   942‚Üí            });\n   943‚Üí\n   944‚Üí        return $procesos;\n   945‚Üí    }\n   946‚Üí\n   947‚Üí    /**\n   948‚Üí     * Obtener resultados de las agendas finalizadas de un proceso para exportar a Excel.\n   949‚Üí     *\n   950‚Üí     * Genera un array con la informaci√≥n de cada participante incluyendo datos personales,\n   951‚Üí     * puntajes de factores y dimensiones, y conceptos de recomendaci√≥n basados en rangos.\n   952‚Üí     *\n   953‚Üí     * @param int $proceso_id Id del proceso.\n   954‚Üí     * @param array $evaluados_ids Array de IDs de evaluados a filtrar (opcional).\n   955‚Üí     * @param bool $reporte_comparativo Indica si es para reporte comparativo (opcional).\n   956‚Üí     * @return array Array con resultados agrupados por prueba con estructura:\n   957‚Üí     *               ['prueba_id' => ['nombre_prueba' => string, 'resultados' => array]]\n   958‚Üí     * @author Sergio Vargas\n   959‚Üí     * @author Andres Morales\n   960‚Üí     */\n   961‚Üí    public function resultadosProcesoAgendas(int $proceso_id, array $evaluados_ids = [], bool $reporte_comparativo = false): array {\n   962‚Üí        $resultados                       = [];\n   963‚Üí        $datos_resultados_proceso_agendas = $this->agenda_repositorio->obtenerDatosResultadosProcesoAgendas($proceso_id, $evaluados_ids);\n   964‚Üí\n   965‚Üí        if (count($datos_resultados_proceso_agendas) === 0) {\n   966‚Üí            return [];\n   967‚Üí        }\n   968‚Üí\n   969‚Üí        foreach ($datos_resultados_proceso_agendas as $datos_agenda) {\n   970‚Üí            if (!array_key_exists($datos_agenda->prueba_id, $resultados)) {\n   971‚Üí                $resultados[$datos_agenda->prueba_id] = [\n   972‚Üí                    'nombre_prueba'      => $datos_agenda->prueba->nombre,\n   973‚Üí                    'nombre_prueba_slug' => Str::slug($datos_agenda->prueba->nombre),\n   974‚Üí                    'resultados'         => []\n   975‚Üí                ];\n   976‚Üí            }\n   977‚Üí\n   978‚Üí            $ajuste        = $datos_agenda->ajuste ?? 0;\n   979‚Üí            $concepto      = $this->calcularConcepto($ajuste);\n   980‚Üí            $nombre_perfil = $datos_agenda->perfil ? $datos_agenda->perfil->nombre : '';\n   981‚Üí\n   982‚Üí            $campos = $reporte_comparativo ? ['id_agenda', 'nombre', 'documento', 'perfil', 'correo', 'ajuste', 'concepto'] : ['ID Agenda', 'Nombre', 'Documento', 'Perfil', 'Correo', 'Ajuste', 'Concepto'];\n   983‚Üí\n   984‚Üí            $valores = [\n   985‚Üí                $datos_agenda->id,\n   986‚Üí                $datos_agenda->evaluado->nombres . ' ' . $datos_agenda->evaluado->apellidos,\n   987‚Üí                $datos_agenda->evaluado->documento ?? '',\n   988‚Üí                $nombre_perfil,\n   989‚Üí                $datos_agenda->evaluado->email ?? '',\n   990‚Üí                round($ajuste, 2),\n   991‚Üí                $concepto\n   992‚Üí            ];\n   993‚Üí\n   994‚Üí            $nueva_fila_prueba = array_combine($campos, $valores);\n   995‚Üí\n   996‚Üí            if ($datos_agenda->perfil) {\n   997‚Üí                foreach ($datos_agenda->perfil->factoresPerfiles as $factor_perfil) {\n   998‚Üí                    $factor         = $factor_perfil->factor;\n   999‚Üí                    $puntaje_factor = $this->calcularPuntajeFactorPerfil($factor_perfil, $datos_agenda);\n  1000‚Üí\n  1001‚Üí                    if ($reporte_comparativo) {\n  1002‚Üí                        $factor_data = [\n  1003‚Üí                            'nombre'      => $factor->nombre,\n  1004‚Üí                            'nombre_slug' => Str::slug($factor->nombre),\n  1005‚Üí                            'value'       => round($puntaje_factor, 2),\n  1006‚Üí                            'type'        => 'factor',\n  1007‚Üí                            'dimensiones' => []\n  1008‚Üí                        ];\n  1009‚Üí\n  1010‚Üí                        foreach ($factor_perfil->dimensionesFactoresPerfiles as $dimension_factor_perfil) {\n  1011‚Üí                            $dimension                    = $dimension_factor_perfil->dimension;\n  1012‚Üí                            $resultado                    = $datos_agenda->resultados->where('dimension_id', $dimension->id)->first();\n  1013‚Üí                            $factor_data['dimensiones'][] = [\n  1014‚Üí                                'nombre'      => $dimension->nombre,\n  1015‚Üí                                'nombre_slug' => Str::slug($dimension->nombre),\n  1016‚Üí                                'value'       => $resultado ? round($resultado->puntaje_transformado, 2) : '',\n  1017‚Üí                                'type'        => 'dimension'\n  1018‚Üí                            ];\n  1019‚Üí                        }\n  1020‚Üí\n  1021‚Üí                        $nueva_fila_prueba['factores'][] = $factor_data;\n  1022‚Üí                    } else {\n  1023‚Üí                        $nueva_fila_prueba[$factor->nombre] = [\n  1024‚Üí                            'value' => round($puntaje_factor, 2),\n  1025‚Üí                            'type'  => 'factor'\n  1026‚Üí                        ];\n  1027‚Üí\n  1028‚Üí                        foreach ($factor_perfil->dimensionesFactoresPerfiles as $dimension_factor_perfil) {\n  1029‚Üí                            $dimension                             = $dimension_factor_perfil->dimension;\n  1030‚Üí                            $resultado                             = $datos_agenda->resultados->where('dimension_id', $dimension->id)->first();\n  1031‚Üí                            $nueva_fila_prueba[$dimension->nombre] = [\n  1032‚Üí                                'value' => $resultado ? round($resultado->puntaje_transformado, 2) : '',\n  1033‚Üí                                'type'  => 'dimension'\n  1034‚Üí                            ];\n  1035‚Üí                        }\n  1036‚Üí                    }\n  1037‚Üí                }\n  1038‚Üí            }\n  1039‚Üí\n  1040‚Üí            $resultados[$datos_agenda->prueba_id]['resultados'][] = $nueva_fila_prueba;\n  1041‚Üí        }\n  1042‚Üí\n  1043‚Üí        return $resultados;\n  1044‚Üí    }\n  1045‚Üí\n  1046‚Üí    /**\n  1047‚Üí     * Generar datos de resumen de participantes para exportaci√≥n Excel.\n  1048‚Üí     *\n  1049‚Üí     * @param int $proceso_id ID del proceso.\n  1050‚Üí     * @param array $evaluados_ids Array de IDs de evaluados a filtrar (opcional).\n  1051‚Üí     * @return array Array con datos de resumen por participante.\n  1052‚Üí     * @author Sergio Vargas\n  1053‚Üí     */\n  1054‚Üí    public function generarResumenParticipantes(int $proceso_id, array $evaluados_ids = []): array {\n  1055‚Üí        $todas_las_agendas        = $this->agenda_repositorio->obtenerAgendasParaResumenParticipantes($proceso_id, $evaluados_ids);\n  1056‚Üí        $proceso                  = $this->repositorio->getUno($proceso_id);\n  1057‚Üí        $resumen_participantes    = [];\n  1058‚Üí        $agendas_por_participante = $todas_las_agendas->groupBy('evaluado_id');\n  1059‚Üí\n  1060‚Üí        $resultados_detallados = $this->resultadosProcesoAgendas($proceso_id, $evaluados_ids);\n  1061‚Üí\n  1062‚Üí        foreach ($agendas_por_participante as $evaluado_id => $agendas_participante) {\n  1063‚Üí            $primer_agenda = $agendas_participante->first();\n  1064‚Üí            $evaluado      = $primer_agenda->evaluado;\n  1065‚Üí\n  1066‚Üí            $total_asignadas   = $agendas_participante->count();\n  1067‚Üí            $finalizadas       = $agendas_participante->where('estado_id', Agenda::ESTADO_FINALIZADA_ID);\n  1068‚Üí            $total_finalizadas = $finalizadas->count();\n  1069‚Üí\n  1070‚Üí            $porcentaje = $total_asignadas > 0 ? round(($total_finalizadas / $total_asignadas) * 100, 1) : 0;\n  1071‚Üí\n  1072‚Üí            $nombres_pruebas_finalizadas = $finalizadas->map(function ($agenda) {\n  1073‚Üí                return $agenda->prueba->nombre ?? 'Prueba sin nombre';\n  1074‚Üí            })->unique()->implode(', ');\n  1075‚Üí\n  1076‚Üí            $ultima_finalizacion = $finalizadas->max('fecha_procesamiento') ?? $finalizadas->max('updated_at');\n  1077‚Üí\n  1078‚Üí            $indice_talento         = $this->repositorio->obtenerIndiceTalento($proceso_id, $evaluado_id);\n  1079‚Üí            $indice_talento_valor   = $indice_talento->indice_talento ?? 0;\n  1080‚Üí            $indice_talento_display = $indice_talento_valor;\n  1081‚Üí\n  1082‚Üí            if ($indice_talento_valor == -2) {\n  1083‚Üí                $indice_talento_display = 'Pruebas pendientes';\n  1084‚Üí            } elseif ($indice_talento_valor == -1) {\n  1085‚Üí                $indice_talento_display = 'Procesamiento pendiente';\n  1086‚Üí            }\n  1087‚Üí\n  1088‚Üí            $concepto = '';\n  1089‚Üí\n  1090‚Üí            if (is_numeric($indice_talento_valor)) {\n  1091‚Üí                $concepto = $this->calcularConcepto($indice_talento_valor);\n  1092‚Üí            }\n  1093‚Üí\n  1094‚Üí            $fila_participante = [\n  1095‚Üí                'nombre'         => $evaluado->nombre_completo,\n  1096‚Üí                'documento'      => $evaluado->documento ?? '',\n  1097‚Üí                'correo'         => $evaluado->email ?? '',\n  1098‚Üí                'edad'           => $evaluado->edad,\n  1099‚Üí                'proceso'        => $proceso->nombre ?? '',\n  1100‚Üí                'indice_talento' => $indice_talento_display,\n  1101‚Üí                'concepto'       => $concepto\n  1102‚Üí            ];\n  1103‚Üí\n  1104‚Üí            foreach ($resultados_detallados as $prueba_id => $datos_prueba) {\n  1105‚Üí                $nombre_prueba = $datos_prueba['nombre_prueba'];\n  1106‚Üí                $ajuste_prueba = '';\n  1107‚Üí\n  1108‚Üí                foreach ($datos_prueba['resultados'] as $resultado) {\n  1109‚Üí                    $nombre_participante    = $resultado['Nombre'];\n  1110‚Üí                    $documento_participante = $resultado['Documento'];\n  1111‚Üí\n  1112‚Üí                    if ($evaluado->nombre_completo === $nombre_participante || $evaluado->documento === $documento_participante) {\n  1113‚Üí                        $ajuste_prueba = $resultado['Ajuste'];\n  1114‚Üí                        break;\n  1115‚Üí                    }\n  1116‚Üí                }\n  1117‚Üí\n  1118‚Üí                $fila_participante[$nombre_prueba] = $ajuste_prueba;\n  1119‚Üí            }\n  1120‚Üí\n  1121‚Üí            $resumen_participantes[] = $fila_participante;\n  1122‚Üí        }\n  1123‚Üí\n  1124‚Üí        return $resumen_participantes;\n  1125‚Üí    }\n  1126‚Üí\n  1127‚Üí    /**\n  1128‚Üí     * Calcular concepto de recomendaci√≥n basado en el puntaje de ajuste.\n  1129‚Üí     *\n  1130‚Üí     * Determina el nivel de recomendaci√≥n de un candidato seg√∫n su puntaje de ajuste:\n  1131‚Üí     * - 0-60: No recomendado\n  1132‚Üí     * - 60-76: Recomendado con sugerencias\n  1133‚Üí     * - 76-100: Recomendado\n  1134‚Üí     *\n  1135‚Üí     * @param float $ajuste Puntaje de ajuste del candidato (0-100).\n  1136‚Üí     * @return string Concepto de recomendaci√≥n correspondiente.\n  1137‚Üí     * @author Sergio Vargas\n  1138‚Üí     */\n  1139‚Üí    private function calcularConcepto(float $ajuste): string {\n  1140‚Üí        if ($ajuste >= 0 && $ajuste < 60) {\n  1141‚Üí            return 'No recomendado';\n  1142‚Üí        } elseif ($ajuste >= 60 && $ajuste < 76) {\n  1143‚Üí            return 'Recomendado con sugerencias';\n  1144‚Üí        } elseif ($ajuste >= 76 && $ajuste <= 100) {\n  1145‚Üí            return 'Recomendado';\n  1146‚Üí        }\n  1147‚Üí\n  1148‚Üí        return 'Sin evaluar';\n  1149‚Üí    }\n  1150‚Üí\n  1151‚Üí    /**\n  1152‚Üí     * Calcular puntaje de un factor basado en los pesos de sus dimensiones.\n  1153‚Üí     *\n  1154‚Üí     * Utiliza la configuraci√≥n de pesos del perfil asignado a la agenda para calcular\n  1155‚Üí     * el puntaje ponderado del factor. Cada dimensi√≥n contribuye al puntaje final\n  1156‚Üí     * seg√∫n su peso configurado en el perfil.\n  1157‚Üí     *\n  1158‚Üí     * @param object $factor Factor a calcular.\n  1159‚Üí     * @param object $agenda Agenda con los resultados y perfil asignado.\n  1160‚Üí     * @return float Puntaje calculado del factor, 0.0 si no hay configuraci√≥n o datos.\n  1161‚Üí     * @author Sergio Vargas\n  1162‚Üí     */\n  1163‚Üí    private function calcularPuntajeFactor($factor, $agenda): float {\n  1164‚Üí        if (!$agenda->perfil_id) {\n  1165‚Üí            return 0.0;\n  1166‚Üí        }\n  1167‚Üí\n  1168‚Üí        $factor_perfil = $factor->factoresPerfiles->where('perfil_id', $agenda->perfil_id)->first();\n  1169‚Üí\n  1170‚Üí        if (!$factor_perfil) {\n  1171‚Üí            return 0.0;\n  1172‚Üí        }\n  1173‚Üí\n  1174‚Üí        $dimensiones_factor_perfil = $factor_perfil->dimensionesFactoresPerfiles ?? collect();\n  1175‚Üí        $puntaje_total             = 0.0;\n  1176‚Üí        $peso_total                = 0.0;\n  1177‚Üí\n  1178‚Üí        foreach ($factor->dimensiones as $dimension) {\n  1179‚Üí            $resultado = $agenda->resultados->where('dimension_id', $dimension->id)->first();\n  1180‚Üí\n  1181‚Üí            if ($resultado) {\n  1182‚Üí                $dimension_factor_perfil = $dimensiones_factor_perfil->where('dimension_id', $dimension->id)->first();\n  1183‚Üí                $peso                    = $dimension_factor_perfil ? $dimension_factor_perfil->peso : 0;\n  1184‚Üí\n  1185‚Üí                $puntaje_total += $resultado->puntaje_transformado * $peso;\n  1186‚Üí                $peso_total    += $peso;\n  1187‚Üí            }\n  1188‚Üí        }\n  1189‚Üí\n  1190‚Üí        return $peso_total > 0 ? $puntaje_total / $peso_total : 0.0;\n  1191‚Üí    }\n  1192‚Üí\n  1193‚Üí    /**\n  1194‚Üí     * Calcular el puntaje de un factor espec√≠fico usando el FactorPerfil directamente.\n  1195‚Üí     *\n  1196‚Üí     * @param object $factor_perfil FactorPerfil con dimensiones cargadas.\n  1197‚Üí     * @param object $agenda Agenda con los resultados.\n  1198‚Üí     * @return float Puntaje calculado del factor.\n  1199‚Üí     * @author Sergio Vargas\n  1200‚Üí     */\n  1201‚Üí    private function calcularPuntajeFactorPerfil($factor_perfil, $agenda): float {\n  1202‚Üí        $dimensiones_factor_perfil = $factor_perfil->dimensionesFactoresPerfiles;\n  1203‚Üí        $puntaje_total             = 0.0;\n  1204‚Üí        $peso_total                = 0.0;\n  1205‚Üí\n  1206‚Üí        foreach ($dimensiones_factor_perfil as $dimension_factor_perfil) {\n  1207‚Üí            $resultado = $agenda->resultados->where('dimension_id', $dimension_factor_perfil->dimension_id)->first();\n  1208‚Üí\n  1209‚Üí            if ($resultado) {\n  1210‚Üí                $peso = $dimension_factor_perfil->peso;\n  1211‚Üí                $puntaje_total += $resultado->puntaje_transformado * $peso;\n  1212‚Üí                $peso_total    += $peso;\n  1213‚Üí            }\n  1214‚Üí        }\n  1215‚Üí\n  1216‚Üí        return $peso_total > 0 ? $puntaje_total / $peso_total : 0.0;\n  1217‚Üí    }\n  1218‚Üí\n  1219‚Üí    /**\n  1220‚Üí     * Actualizar campos de captura de c√°mara y video en agendas con estado AGENDADA.\n  1221‚Üí     *\n  1222‚Üí     * @param int $proceso_id ID del proceso.\n  1223‚Üí     * @param bool $capturar_camara Configuraci√≥n para capturar c√°mara.\n  1224‚Üí     * @param bool $capturar_video Configuraci√≥n para capturar video.\n  1225‚Üí     * @return void\n  1226‚Üí     * @author Andres Morales\n  1227‚Üí     */\n  1228‚Üí    private function actualizarCamposCapturarEnAgendas(int $proceso_id, bool $capturar_camara, bool $capturar_video): void {\n  1229‚Üí        $agendas = $this->agenda_repositorio->getTodo(new Request([\n  1230‚Üí            'proceso_id' => $proceso_id,\n  1231‚Üí            'estado_id'  => EstadoAgenda::AGENDADA_ID\n  1232‚Üí        ]));\n  1233‚Üí\n  1234‚Üí        if ($agendas->count() > 0) {\n  1235‚Üí            $agendas_ids = $agendas->pluck('id')->toArray();\n  1236‚Üí            $this->agenda_repositorio->actualizarVarios($agendas_ids, [\n  1237‚Üí                'capturar_camara' => $capturar_camara,\n  1238‚Üí                'capturar_video'  => $capturar_video\n  1239‚Üí            ]);\n  1240‚Üí        }\n  1241‚Üí    }\n  1242‚Üí\n  1243‚Üí    /**\n  1244‚Üí     * Obtener un top 3 de los mejores candidatos.\n  1245‚Üí     *\n  1246‚Üí     * @param Request $request Contenido de la petici√≥n.\n  1247‚Üí     * @throws Exception|GuzzleException Cuando la IA no genera el listado.\n  1248‚Üí     * @throws RequestException Cuando ocurre un error de conexi√≥n con el servicio de IA.\n  1249‚Üí     * @return array\n  1250‚Üí     * @author Andres Gonzalez\n  1251‚Üí     * @author Fahibram C√°rcamo\n  1252‚Üí     */\n  1253‚Üí    public function generarMejoresCandidatosIA(Request $request): array {\n  1254‚Üí        $pruebas = $this->prueba_repositorio->getDatosBasicos(new Request(['activo' => true]));\n  1255‚Üí        $pruebas = $pruebas->map(function ($prueba) {\n  1256‚Üí            return $prueba->only(['nombre', 'descripcion']);\n  1257‚Üí        });\n  1258‚Üí\n  1259‚Üí        $candidatos = [];\n  1260‚Üí\n  1261‚Üí        foreach ($request->candidatos as $candidato) {\n  1262‚Üí            $resultados_agendas = $this->resultado_agenda_repositorio->getTodo(new Request(['agendas_ids' => $candidato['agendas']]));\n  1263‚Üí\n  1264‚Üí            $resultados_agendas_procesados = $resultados_agendas->map(function ($item) {\n  1265‚Üí                return [\n  1266‚Üí                    'competencia'         => $item->dimension->nombre,\n  1267‚Üí                    'puntaje_competencia' => $item->puntaje_transformado,\n  1268‚Üí                    'prueba_competencia'  => $item->agenda->prueba->nombre\n  1269‚Üí                ];\n  1270‚Üí            })->toArray();\n  1271‚Üí\n  1272‚Üí            $candidatos[] = [\n  1273‚Üí                'nombre'      => $candidato['nombre'],\n  1274‚Üí                'puntajes'    => $resultados_agendas_procesados,\n  1275‚Üí                'comentarios' => $candidato['comentarios'] ?? []\n  1276‚Üí            ];\n  1277‚Üí        }\n  1278‚Üí\n  1279‚Üí        $cliente = new Client([\n  1280‚Üí            'timeout' => 120,\n  1281‚Üí            'headers' => [\n  1282‚Üí                'Content-Type' => 'application/json',\n  1283‚Üí                'Accept'       => 'application/json'\n  1284‚Üí            ]\n  1285‚Üí        ]);\n  1286‚Üí\n  1287‚Üí        $tiempo_inicio = microtime(true);\n  1288‚Üí        $payload_peticion = json_encode([\n  1289‚Üí            'vacante'             => trim($request->vacante),\n  1290‚Üí            'pregunta_especifica' => trim($request->pregunta_especifica),\n  1291‚Üí            'candidatos'          => $candidatos,\n  1292‚Üí            'pruebas'             => $pruebas\n  1293‚Üí        ]);\n  1294‚Üí\n  1295‚Üí        try {\n  1296‚Üí            $respuesta = $cliente->post(env('FASTAPI_BASE_URL', 'http://localhost:8001') . '/mejores-candidatos/', [\n  1297‚Üí                'json' => [\n  1298‚Üí                    'vacante'             => trim($request->vacante),\n  1299‚Üí                    'pregunta_especifica' => trim($request->pregunta_especifica),\n  1300‚Üí                    'candidatos'          => $candidatos,\n  1301‚Üí                    'pruebas'             => $pruebas\n  1302‚Üí                ]\n  1303‚Üí            ]);\n  1304‚Üí\n  1305‚Üí            $respuesta_ia = json_decode($respuesta->getBody()->getContents(), true);\n  1306‚Üí        } catch (RequestException $error) {\n  1307‚Üí            $mensaje_error = 'Error de conexi√≥n con el servicio de IA';\n  1308‚Üí\n  1309‚Üí            if ($error->hasResponse()) {\n  1310‚Üí                $respuesta_error = json_decode($error->getResponse()->getBody()->getContents(), true);\n  1311‚Üí                $mensaje_error   = 'Error en el servicio de IA: ' . ($respuesta_error['detail'] ?? 'Error desconocido');\n  1312‚Üí            }\n  1313‚Üí\n  1314‚Üí            throw new Exception($mensaje_error);\n  1315‚Üí        }\n  1316‚Üí\n  1317‚Üí        if (!$respuesta_ia) {\n  1318‚Üí            throw new Exception('Respuesta inv√°lida del servicio de IA');\n  1319‚Üí        }\n  1320‚Üí\n  1321‚Üí        // Normalizar estructura y extraer usage desde top_3 si viene anidado\n  1322‚Üí        $usage = $respuesta_ia['usage'] ?? null;\n  1323‚Üí        if (! $usage && isset($respuesta_ia['top_3']) && is_array($respuesta_ia['top_3'])) {\n  1324‚Üí            $usage = $respuesta_ia['top_3']['usage'] ?? null;\n  1325‚Üí            if ($usage) {\n  1326‚Üí                $respuesta_ia['usage'] = $usage;\n  1327‚Üí            }\n  1328‚Üí            if (! isset($respuesta_ia['data']) && isset($respuesta_ia['top_3']['data'])) {\n  1329‚Üí                $respuesta_ia['data'] = $respuesta_ia['top_3']['data'];\n  1330‚Üí            }\n  1331‚Üí        }\n  1332‚Üí\n  1333‚Üí        if (! $usage) {\n  1334‚Üí        }\n  1335‚Üí\n  1336‚Üí        $this->registrarConsumoTokens(\n  1337‚Üí            ruta_endpoint: 'mejores-candidatos',\n  1338‚Üí            respuesta_ia: $respuesta_ia,\n  1339‚Üí            payload_peticion: $payload_peticion,\n  1340‚Üí            latencia_ms: (int) ((microtime(true) - $tiempo_inicio) * 1000),\n  1341‚Üí            contexto: [\n  1342‚Üí                'vacante_id' => $request->vacante_id ?? null\n  1343‚Üí            ]\n  1344‚Üí        );\n  1345‚Üí\n  1346‚Üí        return $respuesta_ia ?? [];\n  1347‚Üí    }\n  1348‚Üí\n  1349‚Üí    /**\n  1350‚Üí     * Construir respuesta para reagendamientos seg√∫n los resultados.\n  1351‚Üí     *\n  1352‚Üí     * @param array $resultados Resultados de los reagendamientos.\n  1353‚Üí     * @return array\n  1354‚Üí     * @author Daniel Beltr√°n\n  1355‚Üí     */\n  1356‚Üí    public function construirRespuestaReagendamientos(array $resultados): array {\n  1357‚Üí        $mensaje              = '';\n  1358‚Üí        $operaciones_exitosas = $resultados['agendas_reagendadas'] + $resultados['agendas_reprogramadas'];\n  1359‚Üí\n  1360‚Üí        if ($operaciones_exitosas > 0) {\n  1361‚Üí            $partes_mensaje = [];\n  1362‚Üí\n  1363‚Üí            if ($resultados['agendas_reagendadas'] > 0) {\n  1364‚Üí                $partes_mensaje[] = $resultados['agendas_reagendadas'] . ' agenda(s) reagendada(s)';\n  1365‚Üí            }\n  1366‚Üí\n  1367‚Üí            if ($resultados['agendas_reprogramadas'] > 0) {\n  1368‚Üí                $partes_mensaje[] = $resultados['agendas_reprogramadas'] . ' agenda(s) reprogramada(s)';\n  1369‚Üí            }\n  1370‚Üí\n  1371‚Üí            $mensaje = 'Operaciones realizadas correctamente. ' . implode(' y ', $partes_mensaje);\n  1372‚Üí\n  1373‚Üí            if ($resultados['participantes_notificados'] > 0) {\n  1374‚Üí                $mensaje .= ' y ' . $resultados['participantes_notificados'] . ' participante(s) notificado(s)';\n  1375‚Üí            }\n  1376‚Üí\n  1377‚Üí            $mensaje .= '.';\n  1378‚Üí        }\n  1379‚Üí\n  1380‚Üí        // Agregar informaci√≥n sobre agendas omitidas por l√≠mite\n  1381‚Üí        $mensajes_limite = [];\n  1382‚Üí\n  1383‚Üí        if ($resultados['agendas_omitidas'] > 0) {\n  1384‚Üí            $mensajes_limite[] = $resultados['agendas_omitidas'] . ' agenda(s) no se reagendaron por haber alcanzado el l√≠mite m√°ximo de ' . $resultados['limite_agendas'] . ' reagendamientos.';\n  1385‚Üí\n  1386‚Üí            foreach ($resultados['mensajes_limite'] as $detalle) {\n  1387‚Üí                $mensajes_limite[] = \"‚Ä¢ {$detalle['participante']} - {$detalle['prueba']}: {$detalle['reagendamientos']} reagendamientos previos.\";\n  1388‚Üí            }\n  1389‚Üí        }\n  1390‚Üí\n  1391‚Üí        if ($operaciones_exitosas === 0) {\n  1392‚Üí            if ($resultados['agendas_omitidas'] > 0) {\n  1393‚Üí                $mensaje = 'No se pudo reagendar ninguna agenda debido a que todas han alcanzado el l√≠mite m√°ximo de ' . $resultados['limite_agendas'] . ' reagendamientos.';\n  1394‚Üí            } else {\n  1395‚Üí                $mensaje = 'No se encontraron agendas para reagendar o reprogramar.';\n  1396‚Üí            }\n  1397‚Üí        }\n  1398‚Üí\n  1399‚Üí        $respuesta = [\n  1400‚Üí            'message'  => $mensaje,\n  1401‚Üí            'detalles' => [\n  1402‚Üí                'limite_agendas'            => $resultados['limite_agendas'],\n  1403‚Üí                'agendas_reagendadas'       => $resultados['agendas_reagendadas'],\n  1404‚Üí                'agendas_reprogramadas'     => $resultados['agendas_reprogramadas'],\n  1405‚Üí                'agendas_omitidas'          => $resultados['agendas_omitidas'],\n  1406‚Üí                'participantes_notificados' => $resultados['participantes_notificados']\n  1407‚Üí            ]\n  1408‚Üí        ];\n  1409‚Üí\n  1410‚Üí        if (!empty($mensajes_limite)) {\n  1411‚Üí            $respuesta['advertencias'] = $mensajes_limite;\n  1412‚Üí        }\n  1413‚Üí\n  1414‚Üí        return $respuesta;\n  1415‚Üí    }\n  1416‚Üí\n  1417‚Üí    /**\n  1418‚Üí     * Archivar o desarchivar un proceso.\n  1419‚Üí     *\n  1420‚Üí     * @param int $proceso_id ID del proceso.\n  1421‚Üí     * @return array\n  1422‚Üí     * @author Andres Morales\n  1423‚Üí     */\n  1424‚Üí    public function archivarProceso(int $proceso_id): array {\n  1425‚Üí        $proceso             = $this->repositorio->getUno($proceso_id);\n  1426‚Üí        $nuevo_estado_activo = !$proceso->activo;\n  1427‚Üí        $this->repositorio->actualizar($proceso_id, ['activo' => $nuevo_estado_activo]);\n  1428‚Üí\n  1429‚Üí        return [\n  1430‚Üí            'message' => $nuevo_estado_activo\n  1431‚Üí                ? 'Proceso activado correctamente'\n  1432‚Üí                : 'Proceso archivado correctamente'\n  1433‚Üí        ];\n  1434‚Üí    }\n  1435‚Üí\n  1436‚Üí    /**\n  1437‚Üí     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n  1438‚Üí     *\n  1439‚Üí     * L√≥gica de actualizaci√≥n:\n  1440‚Üí     * - Si todas las agendas est√°n en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) ‚Üí COMPLETADO\n  1441‚Üí     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) ‚Üí ACTIVO\n  1442‚Üí     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n  1443‚Üí     * - No actualiza procesos sin agendas\n  1444‚Üí     *\n  1445‚Üí     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n  1446‚Üí     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n  1447‚Üí     *\n  1448‚Üí     * @param int $proceso_id ID del proceso.\n  1449‚Üí     * @return void\n  1450‚Üí     * @author Sergio Vargas\n  1451‚Üí     */\n  1452‚Üí    public function actualizarEstadoPorAgendas(int $proceso_id): void\n  1453‚Üí    {\n  1454‚Üí        $proceso = $this->repositorio->getUno($proceso_id);\n  1455‚Üí\n  1456‚Üí        if (!$proceso) {\n  1457‚Üí            return;\n  1458‚Üí        }\n  1459‚Üí\n  1460‚Üí        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n  1461‚Üí            return;\n  1462‚Üí        }\n  1463‚Üí\n  1464‚Üí        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n  1465‚Üí\n  1466‚Üí        if ($estadisticas->total_agendas === 0) {\n  1467‚Üí            return;\n  1468‚Üí        }\n  1469‚Üí\n  1470‚Üí        $nuevo_estado_id = null;\n  1471‚Üí\n  1472‚Üí        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n  1473‚Üí            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n  1474‚Üí        } elseif ($estadisticas->agendas_activas > 0) {\n  1475‚Üí            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n  1476‚Üí        }\n  1477‚Üí\n  1478‚Üí        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n  1479‚Üí            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n  1480‚Üí        }\n  1481‚Üí    }\n  1482‚Üí}\n  1483‚Üí\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b1f7b71e-8abd-4419-98cc-d8e0aa56a676","timestamp":"2026-02-06T19:03:13.152Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php","content":"<?php\n\nnamespace App\\Http\\Services\\Procesos;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse GuzzleHttp\\Client;\nuse App\\Traits\\IATrait;\nuse App\\Traits\\FechaTrait;\nuse Illuminate\\Support\\Arr;\nuse Illuminate\\Support\\Str;\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Agendas\\Agenda;\nuse App\\Models\\Pruebas\\Prueba;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Http\\Services\\BaseService;\nuse App\\Mail\\CompartirProcesoMail;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Agendas\\EstadoAgenda;\nuse App\\Models\\OfertasLaborales\\Etapa;\nuse App\\Traits\\Pruebas\\IQFactorialTrait;\nuse GuzzleHttp\\Exception\\GuzzleException;\nuse GuzzleHttp\\Exception\\RequestException;\nuse App\\Http\\Services\\Usuarios\\UserService;\nuse App\\Http\\Services\\Agendas\\AgendaService;\nuse App\\Mail\\CompartirResultadosProcesoMail;\nuse Illuminate\\Support\\Facades\\{Auth, Mail};\nuse App\\Mail\\DescartarParticipanteProcesoMail;\nuse App\\Mail\\NotificarSeleccionParticipanteMail;\nuse App\\Models\\Procesos\\{EstadoProceso,Proceso};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\nuse App\\Http\\Repositories\\Agendas\\ResultadoAgendaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Services\\OfertasLaborales\\OfertaLaboralService;\nuse App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\nuse App\\Http\\Repositories\\OfertasLaborales\\EtapaUsuarioRepository;\nuse App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\nuse App\\Http\\Repositories\\Procesos\\{ProcesoPruebaRepository,ProcesoRepository};\n\n/**\n * @property ProcesoRepository $repositorio\n */\nclass ProcesoService extends BaseService\n{\n    use FechaTrait, IATrait, IQFactorialTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param ProcesoRepository $repositorio Repositorio de procesos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param UserService $usuario_servicio Servicio de usuarios.\n     * @param AgendaService $agenda_servicio Servicio de agendas.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param EtapaUsuarioRepository $etapa_usuario_repositorio Repositorio de etapas de usuarios.\n     * @param ProcesoPruebaRepository $proceso_prueba_repositorio Repositorio de pruebas de procesos.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param OfertaLaboralService $oferta_laboral_servicio Servicio de ofertas laborales.\n     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n     * @param ResultadoAgendaRepository $resultado_agenda_repositorio Repositorio de resultados de agendas.\n     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n     * @param PruebaRepository prueba_repositorio Repositorio de pruebas.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        ProcesoRepository $repositorio,\n        protected UserRepository $usuario_repositorio,\n        protected UserService $usuario_servicio,\n        protected AgendaService $agenda_servicio,\n        protected AgendaRepository $agenda_repositorio,\n        protected EtapaUsuarioRepository $etapa_usuario_repositorio,\n        protected ProcesoPruebaRepository $proceso_prueba_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected OfertaLaboralService $oferta_laboral_servicio,\n        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n        protected ResultadoAgendaRepository $resultado_agenda_repositorio,\n        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n        protected PruebaRepository $prueba_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar proceso.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalizaci√≥n del proceso.\n     * @throws Exception Si la fecha de finalizaci√≥n del proceso es anterior a la fecha de las agendas existentes.\n     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n     * @return Proceso\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): Proceso {\n        $campos_excluidos = ['_token', '_method', 'id', 'pruebas', 'titulo_mensaje', 'descripcion_mensaje', 'participantes'];\n        $fecha_limite     = $this->calcularFechaCierreAgendas($request);\n\n        if (!is_null($fecha_limite)) {\n            $this->validarFechas($fecha_limite, $request->fecha_cierre, $request->id);\n        }\n\n        // Guardar solo una de las dos opciones de vencimiento de agendas\n        if ($request->filled('dias_vencimiento_agendas')) {\n            $request->merge(['fecha_vencimiento_agendas' => null]);\n        } elseif ($request->filled('fecha_vencimiento_agendas')) {\n            $request->merge(['dias_vencimiento_agendas' => null]);\n        }\n\n        if ($request->filled('id')) {\n            $proceso = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n\n            // Actualizar agendas con estado AGENDADA (1) cuando se modifiquen los campos de captura\n            if ($request->filled('capturar_camara') || $request->filled('capturar_video')) {\n                $this->actualizarCamposCapturarEnAgendas(\n                    $request->id,\n                    $request->capturar_camara ?? false,\n                    $request->capturar_video ?? false\n                );\n            }\n        } else {\n            $usuario = Auth::user();\n\n            $request->merge([\n                'empresa_id'   => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id,\n                'usuario_id'   => $usuario->id,\n                'estado_id'    => EstadoProceso::PENDIENTE_ID,\n                'fecha_inicio' => Carbon::now()\n            ]);\n\n            $proceso = $this->repositorio->crear($request->except($campos_excluidos));\n\n            $proceso->refresh();\n        }\n\n        // Calcular la fecha l√≠mite\n        $pruebas = [];\n\n        foreach ($request->pruebas as $prueba) {\n            $pruebas[$prueba['id']] = [\n                'perfil_id'    => $prueba['perfil_id'],\n                'porcentaje'   => $prueba['porcentaje'],\n                'fecha_limite' => $fecha_limite\n            ];\n        }\n\n        $this->repositorio->sincronizarPruebas($proceso, $pruebas);\n\n        if ($request->filled('participantes') && count($request->participantes) > 0) {\n            $request->merge(['fecha_limite' => $fecha_limite]);\n            $this->guardarParticipantes($proceso, $request);\n            $this->repositorio->actualizar($proceso->id, ['estado_id' => 2]);\n        }\n\n        return $proceso;\n    }\n\n    /**\n     * Guardar participantes.\n     *\n     * @param Proceso $proceso Proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception Si la direcci√≥n de correo electr√≥nico de nuevo participante ya fue tomada por otro usuario.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     */\n    public function guardarParticipantes(Proceso $proceso, Request $request): void {\n        $participantes = [];\n\n        foreach ($request->participantes as $participante) {\n            $usuario                     = $this->agenda_servicio->guardarParticipante($proceso, $participante, $request, true, true);\n            $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n        }\n\n        // Agregar los participantes a la etapa inicial\n        $this->asociarEtapasUsuarios($proceso, $participantes);\n\n        // Asignar la etapa inicial de la oferta laboral a los participantes (cuando el proceso es de una oferta laboral)\n        if (!is_null($proceso->oferta_laboral_id)) {\n            foreach ($participantes as $usuario_id => $item) {\n                $this->oferta_laboral_servicio->postularAplicante($proceso->oferta_laboral_id, null, $usuario_id);\n            }\n        }\n    }\n\n    /**\n     * Duplicar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return Proceso\n     * @author Daniel Beltr√°n\n     * @author Sergio Vargas\n     * @author Andres Gonzalez\n     */\n    public function duplicar(int $id, Request $request): Proceso {\n        $proceso             = $this->repositorio->getUno($id);\n        $datos               = Arr::only($proceso->toArray(), ['empresa_id', 'evaluador_id', 'nombre', 'fecha_inicio', 'fecha_cierre', 'cantidad_vacantes', 'intentos_permitidos', 'capturar_camara', 'capturar_video', 'mostrar_logo_aplicante', 'dias_vencimiento_agendas', 'fecha_vencimiento_agendas']);\n        $datos['nombre']     = $request->filled('nombre') ? $request->nombre : $proceso->nombre . ' (Copia)';\n        $datos['usuario_id'] = Auth::id();\n        $datos['estado_id']  = EstadoProceso::PENDIENTE_ID;\n        $datos['vacante_id'] = $request->filled('vacante_id') ? $request->vacante_id : null;\n\n        $proceso_nuevo = $this->repositorio->crear($datos);\n        $pruebas       = [];\n\n        foreach ($proceso->pruebas as $prueba) {\n            $pruebas[$prueba->id] = [\n                'perfil_id'    => $prueba->pivot->perfil_id,\n                'porcentaje'   => $prueba->pivot->porcentaje,\n                'fecha_limite' => $prueba->pivot->fecha_limite\n            ];\n        }\n\n        $this->repositorio->sincronizarPruebas($proceso_nuevo, $pruebas);\n\n        return $this->repositorio->getUno($proceso_nuevo->id);\n    }\n\n    /**\n     * Suspender proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return Proceso\n     * @author Daniel Beltr√°n\n     */\n    public function suspender(int $id): Proceso {\n        $this->repositorio->actualizar($id, ['estado_id' => 5]);\n\n        // Inactivar las agendas\n        $agendas     = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $id]));\n        $agendas_ids = $agendas->pluck('id')->toArray();\n        $this->agenda_repositorio->actualizarVarios($agendas_ids, ['activo' => false]);\n\n        return $this->repositorio->getUno($id);\n    }\n\n    /**\n     * Activar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return Proceso\n     * @author Daniel Beltr√°n\n     */\n    public function activar(int $id): Proceso {\n        $proceso = $this->repositorio->getUno($id);\n        $agendas = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $proceso->id]));\n\n        foreach ($agendas as $agenda) {\n            // Expirar agendas vencidas\n            if ($agenda->fecha_cierre < now()) {\n                $this->agenda_repositorio->actualizar($agenda->id, ['estado_id' => 4, 'activo' => true]);\n                continue;\n            }\n\n            // Activar las agendas\n            $this->agenda_repositorio->actualizar($agenda->id, ['activo' => true]);\n        }\n\n        $this->repositorio->actualizar($proceso->id, ['estado_id' => (count($agendas) > 0 ? 2 : 1)]);\n\n        return $proceso->fresh();\n    }\n\n    /**\n     * Eliminar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @throws Exception Cuando el proceso tiene agendas asociadas.\n     * @return void\n     * @author Daniel Beltr√°n\n     */\n    public function eliminar(int $id): void {\n        $agendas = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $id]));\n\n        if (count($agendas) > 0) {\n            throw new Exception('No se puede eliminar un proceso con agendas asociadas.', 400);\n        }\n\n        $this->repositorio->eliminar($id);\n    }\n\n    /**\n     * Descartar participantes.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     */\n    public function descartarParticipantes(Request $request): void {\n        $proceso       = $this->repositorio->getUno($request->id);\n        $participantes = [];\n\n        foreach ($request->participantes as $participante_id) {\n            $usuario = $this->usuario_repositorio->getUno($participante_id);\n\n            // Obtener la etapa actual del participante\n            $etapa_actual = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n                'usuario_id' => $usuario->id,\n                'proceso_id' => $proceso->id\n            ]));\n\n            // Determinar la nueva etapa basada en la etapa actual\n            if ($etapa_actual && $etapa_actual->etapa_id == Etapa::DESCARTADO_PROCESO_ID) {\n                // Si ya est√° descartado, cambiar a en pruebas\n                $nueva_etapa_id              = Etapa::EN_PRUEBAS_ID;\n                $participantes[$usuario->id] = ['etapa_id' => $nueva_etapa_id];\n                $es_descartado = false;\n\n                // Eliminar de procesos_seleccionados (por si estaba seleccionado)\n                $proceso->seleccionados()->detach($usuario->id);\n            } else {\n                // Si no est√° descartado, descartarlo\n                $nueva_etapa_id              = Etapa::DESCARTADO_PROCESO_ID;\n                $participantes[$usuario->id] = ['etapa_id' => $nueva_etapa_id];\n                $es_descartado = true;\n\n                // Eliminar participante de procesos_seleccionados\n                $proceso->seleccionados()->detach($usuario->id);\n            }\n\n            // Enviar correo\n            Mail::queue(new DescartarParticipanteProcesoMail($usuario, $proceso, $es_descartado));\n\n            // Actualizar la etapa del participante\n            $this->etapa_usuario_repositorio->actualizar($etapa_actual->id, ['etapa_id' => $nueva_etapa_id]);\n        }\n    }\n\n    /**\n     * Seleccionar un participante en un proceso.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return bool\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     * @author Fahibram C√°rcamo\n     */\n    public function seleccionarParticipante(Request $request): bool {\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n        $usuario = $this->usuario_repositorio->getUno($request->participante_id);\n\n        // Validar que no se hayan completado las vacantes del proceso\n        if ($proceso->seleccionados_count >= $proceso->cantidad_vacantes) {\n            throw new Exception('No se puede seleccionar al participante porque ya se han completado todas las vacantes del proceso.');\n        }\n\n        // Validar que todas las agendas del participante en este proceso est√©n finalizadas\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id'  => $proceso->id,\n            'evaluado_id' => $usuario->id\n        ]));\n\n        $agendas_no_finalizadas = $agendas->filter(function ($agenda) {\n            return $agenda->estado_id !== EstadoAgenda::FINALIZADA_ID;\n        });\n\n        if ($agendas_no_finalizadas->isNotEmpty()) {\n            throw new Exception('No se puede seleccionar el participante porque tiene agendas pendientes sin finalizar');\n        }\n\n        // Cambiar la etapa del participante a \"Seleccionados\"\n        $etapa = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n            'usuario_id' => $usuario->id,\n            'proceso_id' => $proceso->id\n        ]));\n\n        if ($etapa) {\n            $this->etapa_usuario_repositorio->actualizar($etapa->id, ['etapa_id' => Etapa::SELECCIONADOS_ID]);\n        }\n\n        // Obtener el √≠ndice de talento del participante\n        $indice_talento_resultado = $this->repositorio->obtenerIndiceTalento($proceso->id, $usuario->id);\n        $indice_talento           = $indice_talento_resultado->indice_talento ?? 0;\n\n        // Agregar el participante a la tabla procesos_seleccionados si no existe\n        if (!$this->repositorio->estaSeleccionado($proceso->id, $usuario->id)) {\n            $this->repositorio->agregarSeleccionado($proceso->id, $usuario->id, [\n                'indice_talento' => $indice_talento\n            ]);\n        }\n\n        // Env√≠a el mensaje de correo electr√≥nico de notificaci√≥n de selecci√≥n al participante.\n        Mail::to($usuario->email)->queue(new NotificarSeleccionParticipanteMail($usuario, $proceso));\n\n        // Valida si ya se seleccionaron todos los usuarios para el proceso y cierra el proceso\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n\n        if ($proceso->seleccionados_count == $proceso->cantidad_vacantes) {\n            $proceso_cerrado = true;\n            $this->repositorio->actualizar($request->proceso_id, ['estado_id' => EstadoProceso::CERRADO_ID]);\n        }\n\n        return $proceso_cerrado ?? false;\n    }\n\n    /**\n     * Mover participantes de un proceso a otro.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     */\n    public function moverDeProceso(Request $request): void {\n        $proceso_actual   = $this->repositorio->getUno($request->proceso_actual_id);\n        $proceso_destino  = $this->repositorio->getUno($request->proceso_destino_id);\n        $pruebas_actuales = $proceso_actual->pruebas->pluck('id')->toArray();\n        $pruebas_destino  = $proceso_destino->pruebas->pluck('id')->toArray();\n        $fecha_limite     = $this->calcularFechaCierreAgendas($request);\n        $this->validarFechas($fecha_limite, $proceso_destino->fecha_cierre, $proceso_destino->id);\n\n        // Validar si se agrega el participante al nuevo proceso manteniendo tambi√©n sus\n        // agendamientos en el proceso actual.\n        if (filter_var($request->mantener_en_proceso, FILTER_VALIDATE_BOOLEAN)) {\n            $participantes = [];\n\n            foreach ($request->participantes as $participante_id) {\n                $usuario = $this->usuario_repositorio->getUno($participante_id);\n\n                foreach ($pruebas_destino as $prueba_id) {\n                    // Validar que el participante no tenga una agenda de la misma prueba en el\n                    // proceso destino.\n                    $agendas_participante_proceso_actual = $this->agenda_repositorio->getTodo(new Request([\n                        'proceso_id'  => $proceso_destino->id,\n                        'evaluado_id' => $usuario->id,\n                        'prueba_id'   => $prueba_id\n                    ]));\n\n                    if (count($agendas_participante_proceso_actual) > 0) {\n                        continue;\n                    }\n\n                    $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n                        'proceso_id' => $proceso_destino->id,\n                        'prueba_id'  => $prueba_id\n                    ]));\n\n                    $this->agenda_servicio->agendar($proceso_destino, $usuario, $prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n                    $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n                }\n\n                // Enviar correo de notificaci√≥n\n                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso_destino);\n            }\n\n            // Agregar la etapa a los participantes\n            $this->asociarEtapasUsuarios($proceso_destino, $participantes);\n        } else {\n            $participantes = [];\n\n            foreach ($request->participantes as $participante_id) {\n                $usuario                     = $this->usuario_repositorio->getUno($participante_id);\n                $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n\n                // Obtener las agendas del participante en el proceso actual\n                $agendas_participante_proceso_actual = $this->agenda_repositorio->getTodo(new Request([\n                    'proceso_id'  => $proceso_actual->id,\n                    'evaluado_id' => $usuario->id\n                ]));\n\n                foreach ($agendas_participante_proceso_actual as $agenda_participante_proceso_actual) {\n                    if (in_array($agenda_participante_proceso_actual->prueba_id, $pruebas_destino)) {\n                        // Si la prueba de la agenda del proceso actual existe en el proceso de\n                        // destino se modifica la agenda para que est√© relacionada con el proceso de\n                        // destino, con su empresa y con su perfil asociado.\n                        $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n                            'proceso_id' => $proceso_destino->id,\n                            'prueba_id'  => $agenda_participante_proceso_actual->prueba_id\n                        ]));\n\n                        if (!is_null($proceso_prueba_destino)) {\n                            $this->agenda_repositorio->actualizar($agenda_participante_proceso_actual->id, [\n                                'empresa_id'      => $proceso_destino->empresa_id,\n                                'proceso_id'      => $proceso_destino->id,\n                                'perfil_id'       => $proceso_prueba_destino->perfil_id,\n                                'fecha_cierre'    => $fecha_limite,\n                                'capturar_camara' => $proceso_destino->capturar_camara,\n                                'capturar_video'  => $proceso_destino->capturar_video\n                            ]);\n\n                            // Si la agenda est√° invalidada se crea una nueva en el proceso nuevo\n                            if ($agenda_participante_proceso_actual->estado_id == EstadoAgenda::INVALIDADA_ID) {\n                                $this->agenda_servicio->agendar($proceso_destino, $usuario, $proceso_prueba_destino->prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n                            }\n                        }\n                    } else {\n                        // Si no es as√≠ solamente se relaciona la agenda con el proceso de destino y\n                        // con su empresa.\n                        $this->agenda_repositorio->actualizar($agenda_participante_proceso_actual->id, [\n                            'empresa_id'   => $proceso_destino->empresa_id,\n                            'proceso_id'   => $proceso_destino->id,\n                            'fecha_cierre' => $fecha_limite\n                        ]);\n                    }\n                }\n\n                // Crear las agendas en el nuevo proceso, validando que no se dupliquen\n                foreach ($pruebas_destino as $prueba_id) {\n                    $existe_agenda = $this->agenda_repositorio->getUnoAvanzado(new Request([\n                        'proceso_id'  => $proceso_destino->id,\n                        'prueba_id'   => $prueba_id,\n                        'evaluado_id' => $usuario->id\n                    ]));\n\n                    if (!$existe_agenda) {\n                        $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n                            'proceso_id' => $proceso_destino->id,\n                            'prueba_id'  => $prueba_id\n                        ]));\n\n                        $this->agenda_servicio->agendar($proceso_destino, $usuario, $prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n                    }\n                }\n\n                // Enviar correo de notificaci√≥n\n                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso_destino);\n            }\n\n            // Actualizar las etapas de los participantes\n            $this->repositorio->disociarEtapasUsuarios($proceso_actual, array_keys($participantes));\n            $this->asociarEtapasUsuarios($proceso_destino, $participantes);\n        }\n    }\n\n    /**\n     * Eliminar un participante de un proceso.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param int $usuario_id ID del usuario.\n     * @return void\n     * @author Daniel Beltr√°n\n     */\n    public function eliminarParticipante(int $proceso_id, int $usuario_id): void {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        $this->repositorio->disociarEtapasUsuarios($proceso, [$usuario_id]);\n        $this->agenda_repositorio->eliminarAvanzado(new Request([\n            'proceso_id'  => $proceso_id,\n            'evaluado_id' => $usuario_id\n        ]), true);\n\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'empresa_id'  => $proceso->empresa_id,\n            'evaluado_id' => $usuario_id\n        ]));\n\n        // Si no existen agendas para la misma empresa, entonces se elimina el usuario como candidato de esa empresa\n        if (count($agendas) == 0) {\n            $this->empresa_usuario_repositorio->eliminarPorEmpresaUsuarioRol(new Request([\n                'empresa_id' => $proceso->empresa_id,\n                'usuario_id' => $usuario_id,\n                'rol_id'     => $this->rol_repositorio::ROL_EVALUADO_ID\n            ]));\n        }\n    }\n\n    /**\n     * Agregar participantes al proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception Si la direcci√≥n de correo electr√≥nico de nuevo participante ya fue tomada por otro usuario.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     */\n    public function agregarParticipantes(int $id, Request $request): void {\n        $proceso              = $this->repositorio->getUno($id);\n        $fecha_cierre_agendas = $this->calcularFechaCierreAgendas($request);\n        $this->validarFechas($fecha_cierre_agendas, $proceso->fecha_cierre, $id);\n        $request->merge([\n            'fecha_limite'    => $fecha_cierre_agendas,\n            'capturar_camara' => $proceso->capturar_camara,\n            'capturar_video'  => $proceso->capturar_video\n        ]);\n\n        // Guardar participantes\n        $this->guardarParticipantes($proceso, $request);\n        $this->repositorio->actualizar($proceso->id, ['estado_id' => EstadoProceso::ACTIVO_ID]);\n    }\n\n    /**\n     * Validar las fechas de cierre del proceso y sus agendas.\n     *\n     * @param string $fecha_cierre_agendas Fecha de cierre de agendas.\n     * @param string|null $fecha_cierre_proceso Fecha de cierre del proceso.\n     * @param int|null $id ID del proceso.\n     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalizaci√≥n del proceso.\n     * @throws Exception Si la fecha de finalizaci√≥n del proceso es anterior a la fecha de las agendas existentes.\n     * @return void\n     * @author Daniel Beltr√°n\n     */\n    private function validarFechas(string $fecha_cierre_agendas, ?string $fecha_cierre_proceso = null, ?int $id = null): void {\n        $fecha_cierre_agendas = Carbon::createFromDate($fecha_cierre_agendas);\n\n        if ($fecha_cierre_agendas < now()) {\n            throw new Exception('La fecha de vencimiento de las agendas no puede ser anterior a la fecha actual.', 400);\n        }\n\n        if (!is_null($fecha_cierre_proceso)) {\n            // Validar que la fecha de vencimiento de las agendas no sea posterior a la fecha de cierre del proceso\n            if ($fecha_cierre_agendas > $fecha_cierre_proceso) {\n                throw new Exception('La fecha de vencimiento de las agendas no puede ser posterior a la fecha de finalizaci√≥n del proceso.', 400);\n            }\n\n            // Validar que la fecha de cierre del proceso no sea anterior a la fecha de las agendas existentes\n            if (!is_null($id) && $this->agenda_repositorio->existenAgendasPosterioresAlCierreDelProceso($id, $fecha_cierre_proceso)) {\n                throw new Exception('La fecha de finalizaci√≥n del proceso no puede ser anterior a la fecha de las agendas existentes.', 400);\n            }\n        }\n    }\n\n    /**\n     * Reagendar participantes.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalizaci√≥n del proceso.\n     * @throws Exception Si la fecha de finalizaci√≥n del proceso es anterior a la fecha de las agendas existentes.\n     * @return array Informaci√≥n sobre el reagendamiento realizado.\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function reagendarParticipantes(Request $request): array {\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n\n        // Validar la configuraci√≥n de captura de c√°mara y v√≠deo\n        if ($request->filled('capturar_camara') && filter_var($request->capturar_camara, FILTER_VALIDATE_BOOLEAN) && !$proceso->capturar_camara) {\n            $request->merge(['capturar_camara' => false]);\n        }\n\n        if ($request->filled('capturar_video') && filter_var($request->capturar_video, FILTER_VALIDATE_BOOLEAN) && !$proceso->capturar_video) {\n            $request->merge(['capturar_video' => false]);\n        }\n\n        $request->merge(['fecha_cierre' => $this->calcularFechaCierreAgendas($request)]);\n        $this->validarFechas($request->fecha_cierre, $proceso->fecha_cierre, $proceso->id);\n\n        $resultado = [\n            'agendas_reagendadas'       => 0,\n            'agendas_reprogramadas'     => 0,\n            'agendas_omitidas'          => 0,\n            'participantes_notificados' => 0,\n            'limite_agendas'            => 0,\n            'mensajes_limite'           => []\n        ];\n\n        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);\n\n        foreach ($request->participantes as $participante_id) {\n            $usuario                       = $this->usuario_repositorio->getUno($participante_id);\n            $agendas_usuario_reagendadas   = 0;\n            $agendas_usuario_reprogramadas = 0;\n            $agendas_usuario_omitidas      = 0;\n\n            if ($request->filled('email')) {\n                $usuario->email = $request->email;\n            }\n\n            foreach ($request->pruebas as $prueba_id) {\n                // Obtener agendas en estado agendadas, iniciadas o expiradas para esta prueba espec√≠fica\n                $agendas_activas = $this->agenda_repositorio->getTodo(new Request([\n                    'proceso_id'  => $proceso->id,\n                    'evaluado_id' => $participante_id,\n                    'prueba_id'   => $prueba_id,\n                    'estados_ids' => [EstadoAgenda::AGENDADA_ID, EstadoAgenda::INICIADA_ID, EstadoAgenda::EXPIRADA_ID]\n                ]));\n\n                if ($agendas_activas->isNotEmpty()) {\n                    // Si ya existe una agenda AGENDADA, INICIADA o EXPIRADA, solo actualizar la primera\n                    $agenda_activa = $agendas_activas->first();\n\n                    // Cuando la agenda tiene estado expirada, se resetea todo y se devuelve a estado sin iniciar\n                    if ($agenda_activa->estado_id === EstadoAgenda::EXPIRADA_ID) {\n                        $this->agenda_servicio->restablecerAgenda($agenda_activa->id);\n                    }\n\n                    $this->agenda_repositorio->actualizar($agenda_activa->id, Arr::only($request->all(), ['estado_id', 'fecha_cierre', 'capturar_camara', 'capturar_video']));\n                    $agendas_usuario_reprogramadas++;\n                } else {\n                    // Si no existe agenda activa, buscar la agenda principal m√°s reciente para reagendar\n                    $agenda_principal = $this->agenda_repositorio->getTodo(new Request([\n                        'proceso_id'             => $proceso->id,\n                        'evaluado_id'            => $participante_id,\n                        'prueba_id'              => $prueba_id,\n                        'solo_principales'       => true,\n                        'contar_reagendamientos' => true\n                    ]))->first();\n\n                    if (!$agenda_principal) {\n                        continue; // Si no existe agenda para esta prueba, continuar con la siguiente\n                    }\n                    // Se agrega 1 conteo m√°s porque el l√≠mite de reagendamientos es el l√≠mite de pruebas - Hablado con yhey 25/09/2025\n                    $agenda_principal->reagendamientos++;\n                    $resultado['limite_agendas'] = intval($configuracion->valor);\n\n                    // Validar l√≠mite m√°ximo de 3 reagendamientos\n                    if ($agenda_principal->reagendamientos >= intval($configuracion->valor)) {\n                        $agendas_usuario_omitidas++;\n\n                        $resultado['mensajes_limite'][] = [\n                            'participante'    => $usuario->nombre_completo,\n                            'prueba'          => $agenda_principal->prueba->nombre ?? 'Prueba sin nombre',\n                            'reagendamientos' => $agenda_principal->reagendamientos\n                        ];\n\n                        continue;\n                    }\n\n                    // Crear nueva agenda (reagendamiento)\n                    $datos                    = Arr::only($agenda_principal->toArray(), ['empresa_id', 'proceso_id', 'prueba_id', 'baremo_id', 'perfil_id', 'evaluador_id', 'evaluado_id', 'cargo_id', 'clasificacion_id', 'ajuste']);\n                    $datos['agenda_id']       = $agenda_principal->id;\n                    $datos['estado_id']       = EstadoAgenda::AGENDADA_ID;\n                    $datos['fecha_inicio']    = now();\n                    $datos['fecha_cierre']    = $request->fecha_cierre;\n                    $datos['capturar_camara'] = $request->capturar_camara ?? false;\n                    $datos['capturar_video']  = $request->capturar_video ?? false;\n                    $this->agenda_repositorio->crear($datos);\n\n                    $agendas_usuario_reagendadas++;\n                }\n            }\n\n            $resultado['agendas_reagendadas']   += $agendas_usuario_reagendadas;\n            $resultado['agendas_reprogramadas'] += $agendas_usuario_reprogramadas;\n            $resultado['agendas_omitidas']      += $agendas_usuario_omitidas;\n\n            // Enviar correo de notificaci√≥n si se reagend√≥ o reprogram√≥ al menos una agenda para este usuario\n            if ($agendas_usuario_reagendadas > 0 || $agendas_usuario_reprogramadas > 0) {\n                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso, $proceso->mostrar_logo_aplicante);\n                $resultado['participantes_notificados']++;\n            }\n        }\n\n        return $resultado;\n    }\n\n    /**\n     * Asociar etapas de usuarios al proceso.\n     *\n     * Si el usuario ya tiene una etapa asociada al proceso, entonces no se guardar√° el registro.\n     *\n     * @param Proceso $proceso Proceso.\n     * @param array $usuarios ID's de los usuarios con sus etapas.\n     * @return void\n     * @author Daniel Beltr√°n\n     */\n    public function asociarEtapasUsuarios(Proceso $proceso, array $usuarios): void {\n        foreach (array_keys($usuarios) as $usuario_id) {\n            $existe = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n                'usuario_id' => $usuario_id,\n                'proceso_id' => $proceso->id\n            ]));\n\n            if ($existe) {\n                unset($usuarios[$usuario_id]);\n            }\n        }\n\n        $this->repositorio->asociarEtapasUsuarios($proceso, $usuarios);\n    }\n\n    /**\n     * Env√≠ar el mensaje de correo electr√≥nico que contiene el link del proceso a todos los destinatarios.\n     *\n     * @param Request $request Contenido de la petici√≥n HTTP.\n     * @return void\n     * @author Fahibram C√°rcamo\n     */\n    public function compartirProceso(Request $request): void {\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n\n        foreach ($request->emails_destinatarios as $email_destinatario) {\n            Mail::to($email_destinatario)\n                ->queue(new CompartirProcesoMail(\n                    $proceso,\n                    trim(strtolower($email_destinatario)),\n                    $request->fecha_hora_expiracion,\n                    $request->contenido\n                ));\n        }\n    }\n\n    /**\n     * Env√≠ar el mensaje de correo electr√≥nico que contiene el link de los resultados de un usuario aplicante en un proceso a todos los destinatarios.\n     *\n     * @param Request $request Contenido de la petici√≥n HTTP.\n     * @return void\n     * @author Fahibram C√°rcamo\n     */\n    public function compartirResultadosProcesoAplicante(Request $request): void {\n        foreach ($request->emails_destinatarios as $email_destinatario) {\n            Mail::to($email_destinatario)\n                ->queue(new CompartirResultadosProcesoMail(\n                    $this->repositorio->getUno($request->proceso_id),\n                    $this->usuario_repositorio->getUno($request->aplicante_id),\n                    trim(strtolower($email_destinatario)),\n                    $request->fecha_hora_expiracion,\n                    $request->contenido\n                ));\n        }\n    }\n\n    /**\n     * Obtener las pruebas que tiene que realizar el aplicante, agrupadas por proceso.\n     *\n     * Se filtran los resultados de tal manera que obtenga √∫nicamente los que tienen agendas\n     * pendientes por completar.\n     *\n     * Se modific√≥ esta funci√≥n para retornar no solamente las pruebas de los usuarios con rol\n     * aplicante si no tambien los que tienen rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return Collection\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerPruebasAplicante(Request $request): Collection {\n        $orden_pruebas = [\n            Prueba::IQ_FACTORIAL_ID,\n            Prueba::TEN_DISC_PLUS_ID,\n            Prueba::TEN_DISC_ID,\n            Prueba::POTENCIAL_COMERCIAL_ID,\n            Prueba::PRUEBA_ESTATAL_ID,\n            Prueba::ETHIKOS_ID,\n            Prueba::ETHIKOS_RIESGOS_ID,\n            Prueba::VYP_ID\n        ];\n\n        $procesos = $this->repositorio->obtenerPruebasAplicante($request)\n            ->filter(function ($proceso) {\n                $agendas_completadas = $proceso->agendas->filter(function ($agenda) {\n                    return in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n                });\n\n                return $agendas_completadas->count() !== $proceso->agendas->count();\n            })\n            ->each(function ($proceso) use ($orden_pruebas) { // Ordenar las agendas seg√∫n la prueba a la que pertenezcan\n                $agendas_pendientes = $proceso->agendas->filter(function ($agenda) {\n                    return !in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n                });\n\n                $agendas_ordenadas = $agendas_pendientes->sortBy(function ($agenda) use ($orden_pruebas) {\n                    $posicion = array_search($agenda->prueba_id, $orden_pruebas);\n                    return !$posicion ? $posicion : 999;\n                })->values();\n\n                // Se asigna de esta forma, ya que, de no hacerlo, nunca se asigna el valor modificado a la relaci√≥n\n                $proceso->setRelation('agendas', $agendas_ordenadas);\n            })\n            ->filter(function ($proceso) {\n                return $proceso->agendas->isNotEmpty();\n            });\n\n        return $procesos;\n    }\n\n    /**\n     * Obtener pruebas completadas del aplicante (agendas finalizadas o expiradas).\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return Collection\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function obtenerPruebasAplicanteCompletadas(Request $request): Collection {\n        $orden_pruebas = [\n            Prueba::IQ_FACTORIAL_ID,\n            Prueba::TEN_DISC_PLUS_ID,\n            Prueba::TEN_DISC_ID,\n            Prueba::POTENCIAL_COMERCIAL_ID,\n            Prueba::PRUEBA_ESTATAL_ID,\n            Prueba::ETHIKOS_ID,\n            Prueba::ETHIKOS_RIESGOS_ID,\n            Prueba::VYP_ID\n        ];\n\n        // Agregar el par√°metro para incluir procesos cerrados\n        $request->merge(['incluir_procesos_cerrados' => true]);\n\n        $procesos = $this->repositorio->obtenerPruebasAplicante($request)\n            ->each(function ($proceso) use ($orden_pruebas) { // Filtrar y ordenar solo agendas completadas\n                // Filtrar solo agendas completadas (finalizadas o expiradas)\n                $agendas_completadas = $proceso->agendas->filter(function ($agenda) {\n                    return in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n                });\n\n                $agendas_ordenadas = $agendas_completadas->sortBy(function ($agenda) use ($orden_pruebas) {\n                    $posicion = array_search($agenda->prueba_id, $orden_pruebas);\n                    return !$posicion ? $posicion : 999;\n                })->values();\n\n                // Calcular IQ para agendas de IQ Factorial finalizadas\n                $agendas_ordenadas = $agendas_ordenadas->map(function ($agenda) {\n                    if ($agenda->prueba_id == Prueba::IQ_FACTORIAL_ID && $agenda->estado_id == Agenda::ESTADO_FINALIZADA_ID) {\n                        // Cargar la relaci√≥n dimension.factor si no est√° cargada\n                        if (!$agenda->resultados->first()?->relationLoaded('dimension')) {\n                            $agenda->load('resultados.dimension.factor');\n                        }\n\n                        // Agrupar resultados por factor_id y obtener todas las dimensiones\n                        $resultados_por_factor = $agenda->resultados->groupBy(function ($resultado) {\n                            return $resultado->dimension->factor_id ?? null;\n                        })->filter(fn($grupo, $llave) => !is_null($llave));\n\n                        $dimensiones = $resultados_por_factor->flatten()->values();\n\n                        if ($dimensiones->count() > 0 && $resultados_por_factor->count() > 0) {\n                            $agenda->iq = round($this->calcularIQ($dimensiones->toArray(), $resultados_por_factor->count()));\n                        }\n                    }\n\n                    return $agenda;\n                });\n\n                // Se asigna de esta forma, ya que, de no hacerlo, nunca se asigna el valor modificado a la relaci√≥n\n                $proceso->setRelation('agendas', $agendas_ordenadas);\n            })\n            ->filter(function ($proceso) {\n                // Solo incluir procesos que tengan al menos una agenda completada\n                return $proceso->agendas->isNotEmpty();\n            });\n\n        return $procesos;\n    }\n\n    /**\n     * Obtener resultados de las agendas finalizadas de un proceso para exportar a Excel.\n     *\n     * Genera un array con la informaci√≥n de cada participante incluyendo datos personales,\n     * puntajes de factores y dimensiones, y conceptos de recomendaci√≥n basados en rangos.\n     *\n     * @param int $proceso_id Id del proceso.\n     * @param array $evaluados_ids Array de IDs de evaluados a filtrar (opcional).\n     * @param bool $reporte_comparativo Indica si es para reporte comparativo (opcional).\n     * @return array Array con resultados agrupados por prueba con estructura:\n     *               ['prueba_id' => ['nombre_prueba' => string, 'resultados' => array]]\n     * @author Sergio Vargas\n     * @author Andres Morales\n     */\n    public function resultadosProcesoAgendas(int $proceso_id, array $evaluados_ids = [], bool $reporte_comparativo = false): array {\n        $resultados                       = [];\n        $datos_resultados_proceso_agendas = $this->agenda_repositorio->obtenerDatosResultadosProcesoAgendas($proceso_id, $evaluados_ids);\n\n        if (count($datos_resultados_proceso_agendas) === 0) {\n            return [];\n        }\n\n        foreach ($datos_resultados_proceso_agendas as $datos_agenda) {\n            if (!array_key_exists($datos_agenda->prueba_id, $resultados)) {\n                $resultados[$datos_agenda->prueba_id] = [\n                    'nombre_prueba'      => $datos_agenda->prueba->nombre,\n                    'nombre_prueba_slug' => Str::slug($datos_agenda->prueba->nombre),\n                    'resultados'         => []\n                ];\n            }\n\n            $ajuste        = $datos_agenda->ajuste ?? 0;\n            $concepto      = $this->calcularConcepto($ajuste);\n            $nombre_perfil = $datos_agenda->perfil ? $datos_agenda->perfil->nombre : '';\n\n            $campos = $reporte_comparativo ? ['id_agenda', 'nombre', 'documento', 'perfil', 'correo', 'ajuste', 'concepto'] : ['ID Agenda', 'Nombre', 'Documento', 'Perfil', 'Correo', 'Ajuste', 'Concepto'];\n\n            $valores = [\n                $datos_agenda->id,\n                $datos_agenda->evaluado->nombres . ' ' . $datos_agenda->evaluado->apellidos,\n                $datos_agenda->evaluado->documento ?? '',\n                $nombre_perfil,\n                $datos_agenda->evaluado->email ?? '',\n                round($ajuste, 2),\n                $concepto\n            ];\n\n            $nueva_fila_prueba = array_combine($campos, $valores);\n\n            if ($datos_agenda->perfil) {\n                foreach ($datos_agenda->perfil->factoresPerfiles as $factor_perfil) {\n                    $factor         = $factor_perfil->factor;\n                    $puntaje_factor = $this->calcularPuntajeFactorPerfil($factor_perfil, $datos_agenda);\n\n                    if ($reporte_comparativo) {\n                        $factor_data = [\n                            'nombre'      => $factor->nombre,\n                            'nombre_slug' => Str::slug($factor->nombre),\n                            'value'       => round($puntaje_factor, 2),\n                            'type'        => 'factor',\n                            'dimensiones' => []\n                        ];\n\n                        foreach ($factor_perfil->dimensionesFactoresPerfiles as $dimension_factor_perfil) {\n                            $dimension                    = $dimension_factor_perfil->dimension;\n                            $resultado                    = $datos_agenda->resultados->where('dimension_id', $dimension->id)->first();\n                            $factor_data['dimensiones'][] = [\n                                'nombre'      => $dimension->nombre,\n                                'nombre_slug' => Str::slug($dimension->nombre),\n                                'value'       => $resultado ? round($resultado->puntaje_transformado, 2) : '',\n                                'type'        => 'dimension'\n                            ];\n                        }\n\n                        $nueva_fila_prueba['factores'][] = $factor_data;\n                    } else {\n                        $nueva_fila_prueba[$factor->nombre] = [\n                            'value' => round($puntaje_factor, 2),\n                            'type'  => 'factor'\n                        ];\n\n                        foreach ($factor_perfil->dimensionesFactoresPerfiles as $dimension_factor_perfil) {\n                            $dimension                             = $dimension_factor_perfil->dimension;\n                            $resultado                             = $datos_agenda->resultados->where('dimension_id', $dimension->id)->first();\n                            $nueva_fila_prueba[$dimension->nombre] = [\n                                'value' => $resultado ? round($resultado->puntaje_transformado, 2) : '',\n                                'type'  => 'dimension'\n                            ];\n                        }\n                    }\n                }\n            }\n\n            $resultados[$datos_agenda->prueba_id]['resultados'][] = $nueva_fila_prueba;\n        }\n\n        return $resultados;\n    }\n\n    /**\n     * Generar datos de resumen de participantes para exportaci√≥n Excel.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param array $evaluados_ids Array de IDs de evaluados a filtrar (opcional).\n     * @return array Array con datos de resumen por participante.\n     * @author Sergio Vargas\n     */\n    public function generarResumenParticipantes(int $proceso_id, array $evaluados_ids = []): array {\n        $todas_las_agendas        = $this->agenda_repositorio->obtenerAgendasParaResumenParticipantes($proceso_id, $evaluados_ids);\n        $proceso                  = $this->repositorio->getUno($proceso_id);\n        $resumen_participantes    = [];\n        $agendas_por_participante = $todas_las_agendas->groupBy('evaluado_id');\n\n        $resultados_detallados = $this->resultadosProcesoAgendas($proceso_id, $evaluados_ids);\n\n        foreach ($agendas_por_participante as $evaluado_id => $agendas_participante) {\n            $primer_agenda = $agendas_participante->first();\n            $evaluado      = $primer_agenda->evaluado;\n\n            $total_asignadas   = $agendas_participante->count();\n            $finalizadas       = $agendas_participante->where('estado_id', Agenda::ESTADO_FINALIZADA_ID);\n            $total_finalizadas = $finalizadas->count();\n\n            $porcentaje = $total_asignadas > 0 ? round(($total_finalizadas / $total_asignadas) * 100, 1) : 0;\n\n            $nombres_pruebas_finalizadas = $finalizadas->map(function ($agenda) {\n                return $agenda->prueba->nombre ?? 'Prueba sin nombre';\n            })->unique()->implode(', ');\n\n            $ultima_finalizacion = $finalizadas->max('fecha_procesamiento') ?? $finalizadas->max('updated_at');\n\n            $indice_talento         = $this->repositorio->obtenerIndiceTalento($proceso_id, $evaluado_id);\n            $indice_talento_valor   = $indice_talento->indice_talento ?? 0;\n            $indice_talento_display = $indice_talento_valor;\n\n            if ($indice_talento_valor == -2) {\n                $indice_talento_display = 'Pruebas pendientes';\n            } elseif ($indice_talento_valor == -1) {\n                $indice_talento_display = 'Procesamiento pendiente';\n            }\n\n            $concepto = '';\n\n            if (is_numeric($indice_talento_valor)) {\n                $concepto = $this->calcularConcepto($indice_talento_valor);\n            }\n\n            $fila_participante = [\n                'nombre'         => $evaluado->nombre_completo,\n                'documento'      => $evaluado->documento ?? '',\n                'correo'         => $evaluado->email ?? '',\n                'edad'           => $evaluado->edad,\n                'proceso'        => $proceso->nombre ?? '',\n                'indice_talento' => $indice_talento_display,\n                'concepto'       => $concepto\n            ];\n\n            foreach ($resultados_detallados as $prueba_id => $datos_prueba) {\n                $nombre_prueba = $datos_prueba['nombre_prueba'];\n                $ajuste_prueba = '';\n\n                foreach ($datos_prueba['resultados'] as $resultado) {\n                    $nombre_participante    = $resultado['Nombre'];\n                    $documento_participante = $resultado['Documento'];\n\n                    if ($evaluado->nombre_completo === $nombre_participante || $evaluado->documento === $documento_participante) {\n                        $ajuste_prueba = $resultado['Ajuste'];\n                        break;\n                    }\n                }\n\n                $fila_participante[$nombre_prueba] = $ajuste_prueba;\n            }\n\n            $resumen_participantes[] = $fila_participante;\n        }\n\n        return $resumen_participantes;\n    }\n\n    /**\n     * Calcular concepto de recomendaci√≥n basado en el puntaje de ajuste.\n     *\n     * Determina el nivel de recomendaci√≥n de un candidato seg√∫n su puntaje de ajuste:\n     * - 0-60: No recomendado\n     * - 60-76: Recomendado con sugerencias\n     * - 76-100: Recomendado\n     *\n     * @param float $ajuste Puntaje de ajuste del candidato (0-100).\n     * @return string Concepto de recomendaci√≥n correspondiente.\n     * @author Sergio Vargas\n     */\n    private function calcularConcepto(float $ajuste): string {\n        if ($ajuste >= 0 && $ajuste < 60) {\n            return 'No recomendado';\n        } elseif ($ajuste >= 60 && $ajuste < 76) {\n            return 'Recomendado con sugerencias';\n        } elseif ($ajuste >= 76 && $ajuste <= 100) {\n            return 'Recomendado';\n        }\n\n        return 'Sin evaluar';\n    }\n\n    /**\n     * Calcular puntaje de un factor basado en los pesos de sus dimensiones.\n     *\n     * Utiliza la configuraci√≥n de pesos del perfil asignado a la agenda para calcular\n     * el puntaje ponderado del factor. Cada dimensi√≥n contribuye al puntaje final\n     * seg√∫n su peso configurado en el perfil.\n     *\n     * @param object $factor Factor a calcular.\n     * @param object $agenda Agenda con los resultados y perfil asignado.\n     * @return float Puntaje calculado del factor, 0.0 si no hay configuraci√≥n o datos.\n     * @author Sergio Vargas\n     */\n    private function calcularPuntajeFactor($factor, $agenda): float {\n        if (!$agenda->perfil_id) {\n            return 0.0;\n        }\n\n        $factor_perfil = $factor->factoresPerfiles->where('perfil_id', $agenda->perfil_id)->first();\n\n        if (!$factor_perfil) {\n            return 0.0;\n        }\n\n        $dimensiones_factor_perfil = $factor_perfil->dimensionesFactoresPerfiles ?? collect();\n        $puntaje_total             = 0.0;\n        $peso_total                = 0.0;\n\n        foreach ($factor->dimensiones as $dimension) {\n            $resultado = $agenda->resultados->where('dimension_id', $dimension->id)->first();\n\n            if ($resultado) {\n                $dimension_factor_perfil = $dimensiones_factor_perfil->where('dimension_id', $dimension->id)->first();\n                $peso                    = $dimension_factor_perfil ? $dimension_factor_perfil->peso : 0;\n\n                $puntaje_total += $resultado->puntaje_transformado * $peso;\n                $peso_total    += $peso;\n            }\n        }\n\n        return $peso_total > 0 ? $puntaje_total / $peso_total : 0.0;\n    }\n\n    /**\n     * Calcular el puntaje de un factor espec√≠fico usando el FactorPerfil directamente.\n     *\n     * @param object $factor_perfil FactorPerfil con dimensiones cargadas.\n     * @param object $agenda Agenda con los resultados.\n     * @return float Puntaje calculado del factor.\n     * @author Sergio Vargas\n     */\n    private function calcularPuntajeFactorPerfil($factor_perfil, $agenda): float {\n        $dimensiones_factor_perfil = $factor_perfil->dimensionesFactoresPerfiles;\n        $puntaje_total             = 0.0;\n        $peso_total                = 0.0;\n\n        foreach ($dimensiones_factor_perfil as $dimension_factor_perfil) {\n            $resultado = $agenda->resultados->where('dimension_id', $dimension_factor_perfil->dimension_id)->first();\n\n            if ($resultado) {\n                $peso = $dimension_factor_perfil->peso;\n                $puntaje_total += $resultado->puntaje_transformado * $peso;\n                $peso_total    += $peso;\n            }\n        }\n\n        return $peso_total > 0 ? $puntaje_total / $peso_total : 0.0;\n    }\n\n    /**\n     * Actualizar campos de captura de c√°mara y video en agendas con estado AGENDADA.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param bool $capturar_camara Configuraci√≥n para capturar c√°mara.\n     * @param bool $capturar_video Configuraci√≥n para capturar video.\n     * @return void\n     * @author Andres Morales\n     */\n    private function actualizarCamposCapturarEnAgendas(int $proceso_id, bool $capturar_camara, bool $capturar_video): void {\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id' => $proceso_id,\n            'estado_id'  => EstadoAgenda::AGENDADA_ID\n        ]));\n\n        if ($agendas->count() > 0) {\n            $agendas_ids = $agendas->pluck('id')->toArray();\n            $this->agenda_repositorio->actualizarVarios($agendas_ids, [\n                'capturar_camara' => $capturar_camara,\n                'capturar_video'  => $capturar_video\n            ]);\n        }\n    }\n\n    /**\n     * Obtener un top 3 de los mejores candidatos.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception|GuzzleException Cuando la IA no genera el listado.\n     * @throws RequestException Cuando ocurre un error de conexi√≥n con el servicio de IA.\n     * @return array\n     * @author Andres Gonzalez\n     * @author Fahibram C√°rcamo\n     */\n    public function generarMejoresCandidatosIA(Request $request): array {\n        $pruebas = $this->prueba_repositorio->getDatosBasicos(new Request(['activo' => true]));\n        $pruebas = $pruebas->map(function ($prueba) {\n            return $prueba->only(['nombre', 'descripcion']);\n        });\n\n        $candidatos = [];\n\n        foreach ($request->candidatos as $candidato) {\n            $resultados_agendas = $this->resultado_agenda_repositorio->getTodo(new Request(['agendas_ids' => $candidato['agendas']]));\n\n            $resultados_agendas_procesados = $resultados_agendas->map(function ($item) {\n                return [\n                    'competencia'         => $item->dimension->nombre,\n                    'puntaje_competencia' => $item->puntaje_transformado,\n                    'prueba_competencia'  => $item->agenda->prueba->nombre\n                ];\n            })->toArray();\n\n            $candidatos[] = [\n                'nombre'      => $candidato['nombre'],\n                'puntajes'    => $resultados_agendas_procesados,\n                'comentarios' => $candidato['comentarios'] ?? []\n            ];\n        }\n\n        $cliente = new Client([\n            'timeout' => 120,\n            'headers' => [\n                'Content-Type' => 'application/json',\n                'Accept'       => 'application/json'\n            ]\n        ]);\n\n        $tiempo_inicio = microtime(true);\n        $payload_peticion = json_encode([\n            'vacante'             => trim($request->vacante),\n            'pregunta_especifica' => trim($request->pregunta_especifica),\n            'candidatos'          => $candidatos,\n            'pruebas'             => $pruebas\n        ]);\n\n        try {\n            $respuesta = $cliente->post(env('FASTAPI_BASE_URL', 'http://localhost:8001') . '/mejores-candidatos/', [\n                'json' => [\n                    'vacante'             => trim($request->vacante),\n                    'pregunta_especifica' => trim($request->pregunta_especifica),\n                    'candidatos'          => $candidatos,\n                    'pruebas'             => $pruebas\n                ]\n            ]);\n\n            $respuesta_ia = json_decode($respuesta->getBody()->getContents(), true);\n        } catch (RequestException $error) {\n            $mensaje_error = 'Error de conexi√≥n con el servicio de IA';\n\n            if ($error->hasResponse()) {\n                $respuesta_error = json_decode($error->getResponse()->getBody()->getContents(), true);\n                $mensaje_error   = 'Error en el servicio de IA: ' . ($respuesta_error['detail'] ?? 'Error desconocido');\n            }\n\n            throw new Exception($mensaje_error);\n        }\n\n        if (!$respuesta_ia) {\n            throw new Exception('Respuesta inv√°lida del servicio de IA');\n        }\n\n        // Normalizar estructura y extraer usage desde top_3 si viene anidado\n        $usage = $respuesta_ia['usage'] ?? null;\n        if (! $usage && isset($respuesta_ia['top_3']) && is_array($respuesta_ia['top_3'])) {\n            $usage = $respuesta_ia['top_3']['usage'] ?? null;\n            if ($usage) {\n                $respuesta_ia['usage'] = $usage;\n            }\n            if (! isset($respuesta_ia['data']) && isset($respuesta_ia['top_3']['data'])) {\n                $respuesta_ia['data'] = $respuesta_ia['top_3']['data'];\n            }\n        }\n\n        if (! $usage) {\n        }\n\n        $this->registrarConsumoTokens(\n            ruta_endpoint: 'mejores-candidatos',\n            respuesta_ia: $respuesta_ia,\n            payload_peticion: $payload_peticion,\n            latencia_ms: (int) ((microtime(true) - $tiempo_inicio) * 1000),\n            contexto: [\n                'vacante_id' => $request->vacante_id ?? null\n            ]\n        );\n\n        return $respuesta_ia ?? [];\n    }\n\n    /**\n     * Construir respuesta para reagendamientos seg√∫n los resultados.\n     *\n     * @param array $resultados Resultados de los reagendamientos.\n     * @return array\n     * @author Daniel Beltr√°n\n     */\n    public function construirRespuestaReagendamientos(array $resultados): array {\n        $mensaje              = '';\n        $operaciones_exitosas = $resultados['agendas_reagendadas'] + $resultados['agendas_reprogramadas'];\n\n        if ($operaciones_exitosas > 0) {\n            $partes_mensaje = [];\n\n            if ($resultados['agendas_reagendadas'] > 0) {\n                $partes_mensaje[] = $resultados['agendas_reagendadas'] . ' agenda(s) reagendada(s)';\n            }\n\n            if ($resultados['agendas_reprogramadas'] > 0) {\n                $partes_mensaje[] = $resultados['agendas_reprogramadas'] . ' agenda(s) reprogramada(s)';\n            }\n\n            $mensaje = 'Operaciones realizadas correctamente. ' . implode(' y ', $partes_mensaje);\n\n            if ($resultados['participantes_notificados'] > 0) {\n                $mensaje .= ' y ' . $resultados['participantes_notificados'] . ' participante(s) notificado(s)';\n            }\n\n            $mensaje .= '.';\n        }\n\n        // Agregar informaci√≥n sobre agendas omitidas por l√≠mite\n        $mensajes_limite = [];\n\n        if ($resultados['agendas_omitidas'] > 0) {\n            $mensajes_limite[] = $resultados['agendas_omitidas'] . ' agenda(s) no se reagendaron por haber alcanzado el l√≠mite m√°ximo de ' . $resultados['limite_agendas'] . ' reagendamientos.';\n\n            foreach ($resultados['mensajes_limite'] as $detalle) {\n                $mensajes_limite[] = \"‚Ä¢ {$detalle['participante']} - {$detalle['prueba']}: {$detalle['reagendamientos']} reagendamientos previos.\";\n            }\n        }\n\n        if ($operaciones_exitosas === 0) {\n            if ($resultados['agendas_omitidas'] > 0) {\n                $mensaje = 'No se pudo reagendar ninguna agenda debido a que todas han alcanzado el l√≠mite m√°ximo de ' . $resultados['limite_agendas'] . ' reagendamientos.';\n            } else {\n                $mensaje = 'No se encontraron agendas para reagendar o reprogramar.';\n            }\n        }\n\n        $respuesta = [\n            'message'  => $mensaje,\n            'detalles' => [\n                'limite_agendas'            => $resultados['limite_agendas'],\n                'agendas_reagendadas'       => $resultados['agendas_reagendadas'],\n                'agendas_reprogramadas'     => $resultados['agendas_reprogramadas'],\n                'agendas_omitidas'          => $resultados['agendas_omitidas'],\n                'participantes_notificados' => $resultados['participantes_notificados']\n            ]\n        ];\n\n        if (!empty($mensajes_limite)) {\n            $respuesta['advertencias'] = $mensajes_limite;\n        }\n\n        return $respuesta;\n    }\n\n    /**\n     * Archivar o desarchivar un proceso.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return array\n     * @author Andres Morales\n     */\n    public function archivarProceso(int $proceso_id): array {\n        $proceso             = $this->repositorio->getUno($proceso_id);\n        $nuevo_estado_activo = !$proceso->activo;\n        $this->repositorio->actualizar($proceso_id, ['activo' => $nuevo_estado_activo]);\n\n        return [\n            'message' => $nuevo_estado_activo\n                ? 'Proceso activado correctamente'\n                : 'Proceso archivado correctamente'\n        ];\n    }\n\n    /**\n     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n     *\n     * L√≥gica de actualizaci√≥n:\n     * - Si todas las agendas est√°n en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) ‚Üí COMPLETADO\n     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) ‚Üí ACTIVO\n     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n     * - No actualiza procesos sin agendas\n     *\n     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return void\n     * @author Sergio Vargas\n     */\n    public function actualizarEstadoPorAgendas(int $proceso_id): void\n    {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        if (!$proceso) {\n            return;\n        }\n\n        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n            return;\n        }\n\n        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n\n        if ($estadisticas->total_agendas === 0) {\n            return;\n        }\n\n        $nuevo_estado_id = null;\n\n        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n        } elseif ($estadisticas->agendas_activas > 0) {\n            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n        }\n\n        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n        }\n    }\n}\n","numLines":1483,"startLine":1,"totalLines":1483}},"sourceToolAssistantUUID":"fb1324f7-61ac-43b2-9fbe-3af47e9e4f09"}
{"parentUuid":"b1f7b71e-8abd-4419-98cc-d8e0aa56a676","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KiRSeu2iFNbdnjpF3g9Zco","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfecto, ahora tengo el servicio `ProcesoService`. Necesito:\n\n1. Crear un m√©todo en el servicio que encapsule la l√≥gica de obtener participantes con sus √≠ndices de talento\n2. Actualizar el controlador para usar este nuevo m√©todo\n\nLa l√≥gica que debe moverse al servicio es:\n\n```php\n// Cargar participantes del proceso con sus relaciones\n$participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n\n$participantes->each(function ($participante) use ($id) {\n    $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n});\n```\n\nVoy a:\n1. Crear un m√©todo en `ProcesoService` llamado `obtenerParticipantesConIndiceTalento`\n2. Actualizar el controlador para usar este nuevo m√©todo\n\nVeamos tambi√©n si `showResultadosAplicanteFirmada` tiene l√≥gica similar que deber√≠a moverse.","signature":"EpUICkYICxgCKkAw7vvJ5+BM4f+S7Fi18V4JiFdhnytL77j7aiPv44ki8eIH6PnoRIfrPWulR8Pmnw6qfUq0hofg0f148Z6sqdlaEgzHwgAlltLc+XGMqKoaDB6fw1t6wG/ys8b46yIwJo/jJLce3HXg8ALeIcJwSLPrHll7ykwZWG6suovQAgXcc+EhkMakQGVR2pc1LZtKKvwGwhTUxUfOXEPPt/ofeJ7Qcj9eFJEb1k+na8/Ta0ABfeuUEOSgZzqRyLFGkcbmt4ZfsfZffp8qkeQM0PVpYNklJ53c4lOX1Sbx+OmFQJVyhDFFDCrNLCXNTOY6knpiAEmidruGW/TTZgj/v2k4IQ46vwsv2ZaW6PQRs9cPsdalt3njWpeM+IU1IH6rN4iRz/4W3lfMcQHnVcAxPD+q3M9AyaSP5dMFtuhH+K4we3OwWnFnrTUTQqlAJm0Fs4MDAuka4WexOZhP6N5wQ9sNY1q7CdXGT03ZCZ8CJT8Xc80gRBW3LagljDRvrPBOOsnAh85HVxu8TxJ+NZKf86783DPMDmK2MBeBH0Uu/BMvUS+xwLTTxdpgYc/kl7YUq0sAqVuqYlCWrtUDp4FraPGg8aBPnKHIHvDbjztnZSxUwWdzPwGQznStb12RJJY1n02yOIukbPbLPHpOJTsgX8gtJUBJDat7o17IanNySMSzf8I94+lNWUD59X4ZQiOW2z31DIyLRIEzDwRKKG0tWtLYQiTcFVqQppwB90UT0+u0hUbjhTOy13EEjz1zzbMcnq+Wqy4eibrmeC3tFnKLewMqtcYaA7zmHFjXCXl9BGuvSDtGkDxrIt4iTKhpTGJXy0zQVv8cImBEMWFcZoFldo+4yi6YGqlIynGwhbs5JlHSO34dF/FT+nxB/tuylh/ABkmLZksq9UPdSw6JRnVdTVtp0fIomNnROzPjPNP1mO/v3rMgTGD8ORBMtRmBy4MLteZeh/zKm/+P6xlUkHqR0Ww4KNUrFAr5xXvHsSwxKZNvrcj7kvMaDo0/355kdjrlTZ3BDxXPNbIXsZ77LWmezKK4eXvm4+XEJlclHfYNBbEP5TRsQ4CYIi4CXowVsHK+sO1Yj4Tb2xJ1+jUVbFh8sdRiJo6MNODivZlMMV/gzwVwBKy0s2oPmso5f7TvuFEIkGsU3Ov8nr9bd06YEf3typawcQJ/yYMfji37eibwFjNWpceuB5iExLr6xtgzdmyAlxxWrQ+px6BYM6FyjCaLrxNiUSuI5281UMi0Y+jc0EDSiGmVzFzYcwabf43+DlnOuPIGZZGSTGDM/eNoODzdO+ml6QKMt84izPp7YM1p2+6arH6LEZ3CtB4LlDhGAQxENPT5JvRUafk12ln6joM0j/rIiqZLFaJLX9qgtgqa8vwYqBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":25037,"cache_read_input_tokens":39008,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":25037},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLMQtzsr6NCF2tdgTT3","type":"assistant","uuid":"def408a3-1d73-419b-ba01-366b98e0d6ec","timestamp":"2026-02-06T19:03:21.447Z"}
{"parentUuid":"def408a3-1d73-419b-ba01-366b98e0d6ec","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KiRSeu2iFNbdnjpF3g9Zco","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto, voy a mover esa l√≥gica de negocio del controlador al servicio. Analizando el c√≥digo:\n\n**M√©todo `showFirmada` (l√≠neas 719-735):**\n- Carga participantes con sus relaciones\n- Calcula el √≠ndice de talento para cada participante\n- Esta es **l√≥gica de negocio** que debe estar en el servicio\n\nVoy a crear un m√©todo en el servicio y refactorizar el controlador:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":25037,"cache_read_input_tokens":39008,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":25037},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLMQtzsr6NCF2tdgTT3","type":"assistant","uuid":"8ef81b70-9812-452e-919c-7a922efcda7c","timestamp":"2026-02-06T19:03:24.036Z"}
{"parentUuid":"8ef81b70-9812-452e-919c-7a922efcda7c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01KiRSeu2iFNbdnjpF3g9Zco","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TukBp2N3NknK9vVGpjwAiV","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php","old_string":"    /**\n     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n     *\n     * L√≥gica de actualizaci√≥n:\n     * - Si todas las agendas est√°n en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) ‚Üí COMPLETADO\n     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) ‚Üí ACTIVO\n     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n     * - No actualiza procesos sin agendas\n     *\n     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return void\n     * @author Sergio Vargas\n     */\n    public function actualizarEstadoPorAgendas(int $proceso_id): void\n    {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        if (!$proceso) {\n            return;\n        }\n\n        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n            return;\n        }\n\n        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n\n        if ($estadisticas->total_agendas === 0) {\n            return;\n        }\n\n        $nuevo_estado_id = null;\n\n        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n        } elseif ($estadisticas->agendas_activas > 0) {\n            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n        }\n\n        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n        }\n    }\n}","new_string":"    /**\n     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n     *\n     * L√≥gica de actualizaci√≥n:\n     * - Si todas las agendas est√°n en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) ‚Üí COMPLETADO\n     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) ‚Üí ACTIVO\n     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n     * - No actualiza procesos sin agendas\n     *\n     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return void\n     * @author Sergio Vargas\n     */\n    public function actualizarEstadoPorAgendas(int $proceso_id): void\n    {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        if (!$proceso) {\n            return;\n        }\n\n        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n            return;\n        }\n\n        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n\n        if ($estadisticas->total_agendas === 0) {\n            return;\n        }\n\n        $nuevo_estado_id = null;\n\n        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n        } elseif ($estadisticas->agendas_activas > 0) {\n            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n        }\n\n        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n        }\n    }\n\n    /**\n     * Obtener participantes del proceso con sus √≠ndices de talento calculados.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return Collection\n     * @author Claude Code\n     */\n    public function obtenerParticipantesConIndiceTalento(int $proceso_id): Collection {\n        // Cargar participantes del proceso con sus relaciones\n        $participantes = $this->usuario_repositorio->obtenerPorProceso($proceso_id, new Request(['incluir_procesos_pruebas' => true]));\n\n        // Calcular el √≠ndice de talento para cada participante\n        $participantes->each(function ($participante) use ($proceso_id) {\n            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($proceso_id, $participante->id);\n        });\n\n        return $participantes;\n    }\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":25037,"cache_read_input_tokens":39008,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":25037},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLMQtzsr6NCF2tdgTT3","type":"assistant","uuid":"03eb1752-56c5-4ba2-9ddf-d48f26780349","timestamp":"2026-02-06T19:03:36.237Z"}
{"parentUuid":"03eb1752-56c5-4ba2-9ddf-d48f26780349","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). The user provided the following reason for the rejection:  que el autro sea andres gonzalez","is_error":true,"tool_use_id":"toolu_01TukBp2N3NknK9vVGpjwAiV"}]},"uuid":"d87222ce-5c1e-4ab7-bfc8-d33b00dae9eb","timestamp":"2026-02-06T19:04:02.625Z","toolUseResult":"Error: The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). The user provided the following reason for the rejection:  que el autro sea andres gonzalez","sourceToolAssistantUUID":"03eb1752-56c5-4ba2-9ddf-d48f26780349"}
{"parentUuid":"d87222ce-5c1e-4ab7-bfc8-d33b00dae9eb","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TUyM5XvjEgoPqFVns4Cwhm","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario quiere que el autor sea \"Andres Gonzalez\" en lugar de \"Claude Code\". Voy a corregir eso.","signature":"EosCCkYICxgCKkBFJFDCbeRK3XXmqa7HH2BVJRxzi0QJmPn3/WQS9Vkm9tRVuU6yr4Uwy+YSUYXCsBucNOGFnp97S1LKKFy+AjjVEgzuqxETtQ6PL/qrXVgaDAjrS57ZhQ7ZtXlR3SIw2dCwWZzjcLmZPIDnbYBXhymNapBCPglmlVoMCUxhvJBIJ8TegT7wz/DCZJMv3PUhKnOXsETHsLeNDeSDN/sH3McBvcqckRQ1WeGUdtikqCk1QE0Algrs6o1A9ngX9bGM1RedqxzxKB6LfXQeYRhRuzXCUqeb2r87aXXoSnYRJbvSFTxydTXzc9VJCSzP2AYr9JbgQeKPX0B7R5sPBWo3vnreITT3GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1981,"cache_read_input_tokens":64045,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1981},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLR4T3ig9fM7GaVVMxH","type":"assistant","uuid":"f9827a6a-4063-4838-8d13-10d2758a62ae","timestamp":"2026-02-06T19:04:05.296Z"}
{"parentUuid":"f9827a6a-4063-4838-8d13-10d2758a62ae","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01TUyM5XvjEgoPqFVns4Cwhm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php","old_string":"    /**\n     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n     *\n     * L√≥gica de actualizaci√≥n:\n     * - Si todas las agendas est√°n en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) ‚Üí COMPLETADO\n     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) ‚Üí ACTIVO\n     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n     * - No actualiza procesos sin agendas\n     *\n     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return void\n     * @author Sergio Vargas\n     */\n    public function actualizarEstadoPorAgendas(int $proceso_id): void\n    {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        if (!$proceso) {\n            return;\n        }\n\n        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n            return;\n        }\n\n        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n\n        if ($estadisticas->total_agendas === 0) {\n            return;\n        }\n\n        $nuevo_estado_id = null;\n\n        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n        } elseif ($estadisticas->agendas_activas > 0) {\n            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n        }\n\n        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n        }\n    }\n}","new_string":"    /**\n     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n     *\n     * L√≥gica de actualizaci√≥n:\n     * - Si todas las agendas est√°n en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) ‚Üí COMPLETADO\n     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) ‚Üí ACTIVO\n     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n     * - No actualiza procesos sin agendas\n     *\n     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return void\n     * @author Sergio Vargas\n     */\n    public function actualizarEstadoPorAgendas(int $proceso_id): void\n    {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        if (!$proceso) {\n            return;\n        }\n\n        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n            return;\n        }\n\n        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n\n        if ($estadisticas->total_agendas === 0) {\n            return;\n        }\n\n        $nuevo_estado_id = null;\n\n        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n        } elseif ($estadisticas->agendas_activas > 0) {\n            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n        }\n\n        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n        }\n    }\n\n    /**\n     * Obtener participantes del proceso con sus √≠ndices de talento calculados.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return Collection\n     * @author Andres Gonzalez\n     */\n    public function obtenerParticipantesConIndiceTalento(int $proceso_id): Collection {\n        // Cargar participantes del proceso con sus relaciones\n        $participantes = $this->usuario_repositorio->obtenerPorProceso($proceso_id, new Request(['incluir_procesos_pruebas' => true]));\n\n        // Calcular el √≠ndice de talento para cada participante\n        $participantes->each(function ($participante) use ($proceso_id) {\n            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($proceso_id, $participante->id);\n        });\n\n        return $participantes;\n    }\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1981,"cache_read_input_tokens":64045,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1981},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLR4T3ig9fM7GaVVMxH","type":"assistant","uuid":"db5e5833-83f3-44ea-8b0d-94ed394773c1","timestamp":"2026-02-06T19:04:17.230Z"}
{"type":"file-history-snapshot","messageId":"db5e5833-83f3-44ea-8b0d-94ed394773c1","snapshot":{"messageId":"2201fd02-aff6-47d7-8708-201469ca57f6","trackedFileBackups":{"app\\Http\\Services\\Procesos\\ProcesoService.php":{"backupFileName":"69142ad6b3725dc8@v1","version":1,"backupTime":"2026-02-06T19:05:30.127Z"}},"timestamp":"2026-02-06T19:02:55.462Z"},"isSnapshotUpdate":true}
{"parentUuid":"db5e5833-83f3-44ea-8b0d-94ed394773c1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php has been updated successfully."}]},"uuid":"c74f60eb-c76d-4aa7-9c48-faf50f6d3fe9","timestamp":"2026-02-06T19:05:30.147Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Services\\Procesos\\ProcesoService.php","oldString":"    /**\n     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n     *\n     * L√≥gica de actualizaci√≥n:\n     * - Si todas las agendas est√°n en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) ‚Üí COMPLETADO\n     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) ‚Üí ACTIVO\n     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n     * - No actualiza procesos sin agendas\n     *\n     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return void\n     * @author Sergio Vargas\n     */\n    public function actualizarEstadoPorAgendas(int $proceso_id): void\n    {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        if (!$proceso) {\n            return;\n        }\n\n        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n            return;\n        }\n\n        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n\n        if ($estadisticas->total_agendas === 0) {\n            return;\n        }\n\n        $nuevo_estado_id = null;\n\n        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n        } elseif ($estadisticas->agendas_activas > 0) {\n            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n        }\n\n        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n        }\n    }\n}","newString":"    /**\n     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n     *\n     * L√≥gica de actualizaci√≥n:\n     * - Si todas las agendas est√°n en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) ‚Üí COMPLETADO\n     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) ‚Üí ACTIVO\n     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n     * - No actualiza procesos sin agendas\n     *\n     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return void\n     * @author Sergio Vargas\n     */\n    public function actualizarEstadoPorAgendas(int $proceso_id): void\n    {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        if (!$proceso) {\n            return;\n        }\n\n        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n            return;\n        }\n\n        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n\n        if ($estadisticas->total_agendas === 0) {\n            return;\n        }\n\n        $nuevo_estado_id = null;\n\n        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n        } elseif ($estadisticas->agendas_activas > 0) {\n            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n        }\n\n        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n        }\n    }\n\n    /**\n     * Obtener participantes del proceso con sus √≠ndices de talento calculados.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return Collection\n     * @author Andres Gonzalez\n     */\n    public function obtenerParticipantesConIndiceTalento(int $proceso_id): Collection {\n        // Cargar participantes del proceso con sus relaciones\n        $participantes = $this->usuario_repositorio->obtenerPorProceso($proceso_id, new Request(['incluir_procesos_pruebas' => true]));\n\n        // Calcular el √≠ndice de talento para cada participante\n        $participantes->each(function ($participante) use ($proceso_id) {\n            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($proceso_id, $participante->id);\n        });\n\n        return $participantes;\n    }\n}","originalFile":"<?php\n\nnamespace App\\Http\\Services\\Procesos;\n\nuse Exception;\nuse Carbon\\Carbon;\nuse GuzzleHttp\\Client;\nuse App\\Traits\\IATrait;\nuse App\\Traits\\FechaTrait;\nuse Illuminate\\Support\\Arr;\nuse Illuminate\\Support\\Str;\nuse Illuminate\\Http\\Request;\nuse App\\Models\\Agendas\\Agenda;\nuse App\\Models\\Pruebas\\Prueba;\nuse App\\Models\\Empresas\\Empresa;\nuse App\\Http\\Services\\BaseService;\nuse App\\Mail\\CompartirProcesoMail;\nuse Illuminate\\Support\\Collection;\nuse App\\Models\\Agendas\\EstadoAgenda;\nuse App\\Models\\OfertasLaborales\\Etapa;\nuse App\\Traits\\Pruebas\\IQFactorialTrait;\nuse GuzzleHttp\\Exception\\GuzzleException;\nuse GuzzleHttp\\Exception\\RequestException;\nuse App\\Http\\Services\\Usuarios\\UserService;\nuse App\\Http\\Services\\Agendas\\AgendaService;\nuse App\\Mail\\CompartirResultadosProcesoMail;\nuse Illuminate\\Support\\Facades\\{Auth, Mail};\nuse App\\Mail\\DescartarParticipanteProcesoMail;\nuse App\\Mail\\NotificarSeleccionParticipanteMail;\nuse App\\Models\\Procesos\\{EstadoProceso,Proceso};\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\nuse App\\Http\\Repositories\\Agendas\\ResultadoAgendaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Services\\OfertasLaborales\\OfertaLaboralService;\nuse App\\Http\\Services\\Configuraciones\\ConfiguracionModeloService;\nuse App\\Http\\Repositories\\OfertasLaborales\\EtapaUsuarioRepository;\nuse App\\Http\\Repositories\\Usuarios\\PerfilesLaborales\\PerfilLaboralRepository;\nuse App\\Http\\Repositories\\Procesos\\{ProcesoPruebaRepository,ProcesoRepository};\n\n/**\n * @property ProcesoRepository $repositorio\n */\nclass ProcesoService extends BaseService\n{\n    use FechaTrait, IATrait, IQFactorialTrait;\n\n    /**\n     * Constructor.\n     *\n     * @param ProcesoRepository $repositorio Repositorio de procesos.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param UserService $usuario_servicio Servicio de usuarios.\n     * @param AgendaService $agenda_servicio Servicio de agendas.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param EtapaUsuarioRepository $etapa_usuario_repositorio Repositorio de etapas de usuarios.\n     * @param ProcesoPruebaRepository $proceso_prueba_repositorio Repositorio de pruebas de procesos.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de usuarios de empresas.\n     * @param RolRepository $rol_repositorio Repositorio de roles.\n     * @param OfertaLaboralService $oferta_laboral_servicio Servicio de ofertas laborales.\n     * @param PerfilLaboralRepository $perfil_laboral_repositorio Repositorio de perfiles laborales.\n     * @param ResultadoAgendaRepository $resultado_agenda_repositorio Repositorio de resultados de agendas.\n     * @param ConfiguracionModeloService $configuracion_modelo_servicio Servicio de configuraciones de modelos.\n     * @param PruebaRepository prueba_repositorio Repositorio de pruebas.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function __construct(\n        ProcesoRepository $repositorio,\n        protected UserRepository $usuario_repositorio,\n        protected UserService $usuario_servicio,\n        protected AgendaService $agenda_servicio,\n        protected AgendaRepository $agenda_repositorio,\n        protected EtapaUsuarioRepository $etapa_usuario_repositorio,\n        protected ProcesoPruebaRepository $proceso_prueba_repositorio,\n        protected EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        protected RolRepository $rol_repositorio,\n        protected OfertaLaboralService $oferta_laboral_servicio,\n        protected PerfilLaboralRepository $perfil_laboral_repositorio,\n        protected ResultadoAgendaRepository $resultado_agenda_repositorio,\n        protected ConfiguracionModeloService $configuracion_modelo_servicio,\n        protected PruebaRepository $prueba_repositorio\n    ) {\n        parent::__construct($repositorio);\n    }\n\n    /**\n     * Guardar proceso.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalizaci√≥n del proceso.\n     * @throws Exception Si la fecha de finalizaci√≥n del proceso es anterior a la fecha de las agendas existentes.\n     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n     * @return Proceso\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function guardar(Request $request): Proceso {\n        $campos_excluidos = ['_token', '_method', 'id', 'pruebas', 'titulo_mensaje', 'descripcion_mensaje', 'participantes'];\n        $fecha_limite     = $this->calcularFechaCierreAgendas($request);\n\n        if (!is_null($fecha_limite)) {\n            $this->validarFechas($fecha_limite, $request->fecha_cierre, $request->id);\n        }\n\n        // Guardar solo una de las dos opciones de vencimiento de agendas\n        if ($request->filled('dias_vencimiento_agendas')) {\n            $request->merge(['fecha_vencimiento_agendas' => null]);\n        } elseif ($request->filled('fecha_vencimiento_agendas')) {\n            $request->merge(['dias_vencimiento_agendas' => null]);\n        }\n\n        if ($request->filled('id')) {\n            $proceso = $this->repositorio->actualizar($request->id, $request->except($campos_excluidos));\n\n            // Actualizar agendas con estado AGENDADA (1) cuando se modifiquen los campos de captura\n            if ($request->filled('capturar_camara') || $request->filled('capturar_video')) {\n                $this->actualizarCamposCapturarEnAgendas(\n                    $request->id,\n                    $request->capturar_camara ?? false,\n                    $request->capturar_video ?? false\n                );\n            }\n        } else {\n            $usuario = Auth::user();\n\n            $request->merge([\n                'empresa_id'   => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id,\n                'usuario_id'   => $usuario->id,\n                'estado_id'    => EstadoProceso::PENDIENTE_ID,\n                'fecha_inicio' => Carbon::now()\n            ]);\n\n            $proceso = $this->repositorio->crear($request->except($campos_excluidos));\n\n            $proceso->refresh();\n        }\n\n        // Calcular la fecha l√≠mite\n        $pruebas = [];\n\n        foreach ($request->pruebas as $prueba) {\n            $pruebas[$prueba['id']] = [\n                'perfil_id'    => $prueba['perfil_id'],\n                'porcentaje'   => $prueba['porcentaje'],\n                'fecha_limite' => $fecha_limite\n            ];\n        }\n\n        $this->repositorio->sincronizarPruebas($proceso, $pruebas);\n\n        if ($request->filled('participantes') && count($request->participantes) > 0) {\n            $request->merge(['fecha_limite' => $fecha_limite]);\n            $this->guardarParticipantes($proceso, $request);\n            $this->repositorio->actualizar($proceso->id, ['estado_id' => 2]);\n        }\n\n        return $proceso;\n    }\n\n    /**\n     * Guardar participantes.\n     *\n     * @param Proceso $proceso Proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception Si la direcci√≥n de correo electr√≥nico de nuevo participante ya fue tomada por otro usuario.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     */\n    public function guardarParticipantes(Proceso $proceso, Request $request): void {\n        $participantes = [];\n\n        foreach ($request->participantes as $participante) {\n            $usuario                     = $this->agenda_servicio->guardarParticipante($proceso, $participante, $request, true, true);\n            $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n        }\n\n        // Agregar los participantes a la etapa inicial\n        $this->asociarEtapasUsuarios($proceso, $participantes);\n\n        // Asignar la etapa inicial de la oferta laboral a los participantes (cuando el proceso es de una oferta laboral)\n        if (!is_null($proceso->oferta_laboral_id)) {\n            foreach ($participantes as $usuario_id => $item) {\n                $this->oferta_laboral_servicio->postularAplicante($proceso->oferta_laboral_id, null, $usuario_id);\n            }\n        }\n    }\n\n    /**\n     * Duplicar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return Proceso\n     * @author Daniel Beltr√°n\n     * @author Sergio Vargas\n     * @author Andres Gonzalez\n     */\n    public function duplicar(int $id, Request $request): Proceso {\n        $proceso             = $this->repositorio->getUno($id);\n        $datos               = Arr::only($proceso->toArray(), ['empresa_id', 'evaluador_id', 'nombre', 'fecha_inicio', 'fecha_cierre', 'cantidad_vacantes', 'intentos_permitidos', 'capturar_camara', 'capturar_video', 'mostrar_logo_aplicante', 'dias_vencimiento_agendas', 'fecha_vencimiento_agendas']);\n        $datos['nombre']     = $request->filled('nombre') ? $request->nombre : $proceso->nombre . ' (Copia)';\n        $datos['usuario_id'] = Auth::id();\n        $datos['estado_id']  = EstadoProceso::PENDIENTE_ID;\n        $datos['vacante_id'] = $request->filled('vacante_id') ? $request->vacante_id : null;\n\n        $proceso_nuevo = $this->repositorio->crear($datos);\n        $pruebas       = [];\n\n        foreach ($proceso->pruebas as $prueba) {\n            $pruebas[$prueba->id] = [\n                'perfil_id'    => $prueba->pivot->perfil_id,\n                'porcentaje'   => $prueba->pivot->porcentaje,\n                'fecha_limite' => $prueba->pivot->fecha_limite\n            ];\n        }\n\n        $this->repositorio->sincronizarPruebas($proceso_nuevo, $pruebas);\n\n        return $this->repositorio->getUno($proceso_nuevo->id);\n    }\n\n    /**\n     * Suspender proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return Proceso\n     * @author Daniel Beltr√°n\n     */\n    public function suspender(int $id): Proceso {\n        $this->repositorio->actualizar($id, ['estado_id' => 5]);\n\n        // Inactivar las agendas\n        $agendas     = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $id]));\n        $agendas_ids = $agendas->pluck('id')->toArray();\n        $this->agenda_repositorio->actualizarVarios($agendas_ids, ['activo' => false]);\n\n        return $this->repositorio->getUno($id);\n    }\n\n    /**\n     * Activar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return Proceso\n     * @author Daniel Beltr√°n\n     */\n    public function activar(int $id): Proceso {\n        $proceso = $this->repositorio->getUno($id);\n        $agendas = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $proceso->id]));\n\n        foreach ($agendas as $agenda) {\n            // Expirar agendas vencidas\n            if ($agenda->fecha_cierre < now()) {\n                $this->agenda_repositorio->actualizar($agenda->id, ['estado_id' => 4, 'activo' => true]);\n                continue;\n            }\n\n            // Activar las agendas\n            $this->agenda_repositorio->actualizar($agenda->id, ['activo' => true]);\n        }\n\n        $this->repositorio->actualizar($proceso->id, ['estado_id' => (count($agendas) > 0 ? 2 : 1)]);\n\n        return $proceso->fresh();\n    }\n\n    /**\n     * Eliminar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @throws Exception Cuando el proceso tiene agendas asociadas.\n     * @return void\n     * @author Daniel Beltr√°n\n     */\n    public function eliminar(int $id): void {\n        $agendas = $this->agenda_repositorio->getTodo(new Request(['proceso_id' => $id]));\n\n        if (count($agendas) > 0) {\n            throw new Exception('No se puede eliminar un proceso con agendas asociadas.', 400);\n        }\n\n        $this->repositorio->eliminar($id);\n    }\n\n    /**\n     * Descartar participantes.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     */\n    public function descartarParticipantes(Request $request): void {\n        $proceso       = $this->repositorio->getUno($request->id);\n        $participantes = [];\n\n        foreach ($request->participantes as $participante_id) {\n            $usuario = $this->usuario_repositorio->getUno($participante_id);\n\n            // Obtener la etapa actual del participante\n            $etapa_actual = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n                'usuario_id' => $usuario->id,\n                'proceso_id' => $proceso->id\n            ]));\n\n            // Determinar la nueva etapa basada en la etapa actual\n            if ($etapa_actual && $etapa_actual->etapa_id == Etapa::DESCARTADO_PROCESO_ID) {\n                // Si ya est√° descartado, cambiar a en pruebas\n                $nueva_etapa_id              = Etapa::EN_PRUEBAS_ID;\n                $participantes[$usuario->id] = ['etapa_id' => $nueva_etapa_id];\n                $es_descartado = false;\n\n                // Eliminar de procesos_seleccionados (por si estaba seleccionado)\n                $proceso->seleccionados()->detach($usuario->id);\n            } else {\n                // Si no est√° descartado, descartarlo\n                $nueva_etapa_id              = Etapa::DESCARTADO_PROCESO_ID;\n                $participantes[$usuario->id] = ['etapa_id' => $nueva_etapa_id];\n                $es_descartado = true;\n\n                // Eliminar participante de procesos_seleccionados\n                $proceso->seleccionados()->detach($usuario->id);\n            }\n\n            // Enviar correo\n            Mail::queue(new DescartarParticipanteProcesoMail($usuario, $proceso, $es_descartado));\n\n            // Actualizar la etapa del participante\n            $this->etapa_usuario_repositorio->actualizar($etapa_actual->id, ['etapa_id' => $nueva_etapa_id]);\n        }\n    }\n\n    /**\n     * Seleccionar un participante en un proceso.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return bool\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     * @author Fahibram C√°rcamo\n     */\n    public function seleccionarParticipante(Request $request): bool {\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n        $usuario = $this->usuario_repositorio->getUno($request->participante_id);\n\n        // Validar que no se hayan completado las vacantes del proceso\n        if ($proceso->seleccionados_count >= $proceso->cantidad_vacantes) {\n            throw new Exception('No se puede seleccionar al participante porque ya se han completado todas las vacantes del proceso.');\n        }\n\n        // Validar que todas las agendas del participante en este proceso est√©n finalizadas\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id'  => $proceso->id,\n            'evaluado_id' => $usuario->id\n        ]));\n\n        $agendas_no_finalizadas = $agendas->filter(function ($agenda) {\n            return $agenda->estado_id !== EstadoAgenda::FINALIZADA_ID;\n        });\n\n        if ($agendas_no_finalizadas->isNotEmpty()) {\n            throw new Exception('No se puede seleccionar el participante porque tiene agendas pendientes sin finalizar');\n        }\n\n        // Cambiar la etapa del participante a \"Seleccionados\"\n        $etapa = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n            'usuario_id' => $usuario->id,\n            'proceso_id' => $proceso->id\n        ]));\n\n        if ($etapa) {\n            $this->etapa_usuario_repositorio->actualizar($etapa->id, ['etapa_id' => Etapa::SELECCIONADOS_ID]);\n        }\n\n        // Obtener el √≠ndice de talento del participante\n        $indice_talento_resultado = $this->repositorio->obtenerIndiceTalento($proceso->id, $usuario->id);\n        $indice_talento           = $indice_talento_resultado->indice_talento ?? 0;\n\n        // Agregar el participante a la tabla procesos_seleccionados si no existe\n        if (!$this->repositorio->estaSeleccionado($proceso->id, $usuario->id)) {\n            $this->repositorio->agregarSeleccionado($proceso->id, $usuario->id, [\n                'indice_talento' => $indice_talento\n            ]);\n        }\n\n        // Env√≠a el mensaje de correo electr√≥nico de notificaci√≥n de selecci√≥n al participante.\n        Mail::to($usuario->email)->queue(new NotificarSeleccionParticipanteMail($usuario, $proceso));\n\n        // Valida si ya se seleccionaron todos los usuarios para el proceso y cierra el proceso\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n\n        if ($proceso->seleccionados_count == $proceso->cantidad_vacantes) {\n            $proceso_cerrado = true;\n            $this->repositorio->actualizar($request->proceso_id, ['estado_id' => EstadoProceso::CERRADO_ID]);\n        }\n\n        return $proceso_cerrado ?? false;\n    }\n\n    /**\n     * Mover participantes de un proceso a otro.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     */\n    public function moverDeProceso(Request $request): void {\n        $proceso_actual   = $this->repositorio->getUno($request->proceso_actual_id);\n        $proceso_destino  = $this->repositorio->getUno($request->proceso_destino_id);\n        $pruebas_actuales = $proceso_actual->pruebas->pluck('id')->toArray();\n        $pruebas_destino  = $proceso_destino->pruebas->pluck('id')->toArray();\n        $fecha_limite     = $this->calcularFechaCierreAgendas($request);\n        $this->validarFechas($fecha_limite, $proceso_destino->fecha_cierre, $proceso_destino->id);\n\n        // Validar si se agrega el participante al nuevo proceso manteniendo tambi√©n sus\n        // agendamientos en el proceso actual.\n        if (filter_var($request->mantener_en_proceso, FILTER_VALIDATE_BOOLEAN)) {\n            $participantes = [];\n\n            foreach ($request->participantes as $participante_id) {\n                $usuario = $this->usuario_repositorio->getUno($participante_id);\n\n                foreach ($pruebas_destino as $prueba_id) {\n                    // Validar que el participante no tenga una agenda de la misma prueba en el\n                    // proceso destino.\n                    $agendas_participante_proceso_actual = $this->agenda_repositorio->getTodo(new Request([\n                        'proceso_id'  => $proceso_destino->id,\n                        'evaluado_id' => $usuario->id,\n                        'prueba_id'   => $prueba_id\n                    ]));\n\n                    if (count($agendas_participante_proceso_actual) > 0) {\n                        continue;\n                    }\n\n                    $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n                        'proceso_id' => $proceso_destino->id,\n                        'prueba_id'  => $prueba_id\n                    ]));\n\n                    $this->agenda_servicio->agendar($proceso_destino, $usuario, $prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n                    $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n                }\n\n                // Enviar correo de notificaci√≥n\n                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso_destino);\n            }\n\n            // Agregar la etapa a los participantes\n            $this->asociarEtapasUsuarios($proceso_destino, $participantes);\n        } else {\n            $participantes = [];\n\n            foreach ($request->participantes as $participante_id) {\n                $usuario                     = $this->usuario_repositorio->getUno($participante_id);\n                $participantes[$usuario->id] = ['etapa_id' => Etapa::EN_PRUEBAS_ID];\n\n                // Obtener las agendas del participante en el proceso actual\n                $agendas_participante_proceso_actual = $this->agenda_repositorio->getTodo(new Request([\n                    'proceso_id'  => $proceso_actual->id,\n                    'evaluado_id' => $usuario->id\n                ]));\n\n                foreach ($agendas_participante_proceso_actual as $agenda_participante_proceso_actual) {\n                    if (in_array($agenda_participante_proceso_actual->prueba_id, $pruebas_destino)) {\n                        // Si la prueba de la agenda del proceso actual existe en el proceso de\n                        // destino se modifica la agenda para que est√© relacionada con el proceso de\n                        // destino, con su empresa y con su perfil asociado.\n                        $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n                            'proceso_id' => $proceso_destino->id,\n                            'prueba_id'  => $agenda_participante_proceso_actual->prueba_id\n                        ]));\n\n                        if (!is_null($proceso_prueba_destino)) {\n                            $this->agenda_repositorio->actualizar($agenda_participante_proceso_actual->id, [\n                                'empresa_id'      => $proceso_destino->empresa_id,\n                                'proceso_id'      => $proceso_destino->id,\n                                'perfil_id'       => $proceso_prueba_destino->perfil_id,\n                                'fecha_cierre'    => $fecha_limite,\n                                'capturar_camara' => $proceso_destino->capturar_camara,\n                                'capturar_video'  => $proceso_destino->capturar_video\n                            ]);\n\n                            // Si la agenda est√° invalidada se crea una nueva en el proceso nuevo\n                            if ($agenda_participante_proceso_actual->estado_id == EstadoAgenda::INVALIDADA_ID) {\n                                $this->agenda_servicio->agendar($proceso_destino, $usuario, $proceso_prueba_destino->prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n                            }\n                        }\n                    } else {\n                        // Si no es as√≠ solamente se relaciona la agenda con el proceso de destino y\n                        // con su empresa.\n                        $this->agenda_repositorio->actualizar($agenda_participante_proceso_actual->id, [\n                            'empresa_id'   => $proceso_destino->empresa_id,\n                            'proceso_id'   => $proceso_destino->id,\n                            'fecha_cierre' => $fecha_limite\n                        ]);\n                    }\n                }\n\n                // Crear las agendas en el nuevo proceso, validando que no se dupliquen\n                foreach ($pruebas_destino as $prueba_id) {\n                    $existe_agenda = $this->agenda_repositorio->getUnoAvanzado(new Request([\n                        'proceso_id'  => $proceso_destino->id,\n                        'prueba_id'   => $prueba_id,\n                        'evaluado_id' => $usuario->id\n                    ]));\n\n                    if (!$existe_agenda) {\n                        $proceso_prueba_destino = $this->proceso_prueba_repositorio->getUnoAvanzado(new Request([\n                            'proceso_id' => $proceso_destino->id,\n                            'prueba_id'  => $prueba_id\n                        ]));\n\n                        $this->agenda_servicio->agendar($proceso_destino, $usuario, $prueba_id, $proceso_prueba_destino->perfil_id, $fecha_limite);\n                    }\n                }\n\n                // Enviar correo de notificaci√≥n\n                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso_destino);\n            }\n\n            // Actualizar las etapas de los participantes\n            $this->repositorio->disociarEtapasUsuarios($proceso_actual, array_keys($participantes));\n            $this->asociarEtapasUsuarios($proceso_destino, $participantes);\n        }\n    }\n\n    /**\n     * Eliminar un participante de un proceso.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param int $usuario_id ID del usuario.\n     * @return void\n     * @author Daniel Beltr√°n\n     */\n    public function eliminarParticipante(int $proceso_id, int $usuario_id): void {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        $this->repositorio->disociarEtapasUsuarios($proceso, [$usuario_id]);\n        $this->agenda_repositorio->eliminarAvanzado(new Request([\n            'proceso_id'  => $proceso_id,\n            'evaluado_id' => $usuario_id\n        ]), true);\n\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'empresa_id'  => $proceso->empresa_id,\n            'evaluado_id' => $usuario_id\n        ]));\n\n        // Si no existen agendas para la misma empresa, entonces se elimina el usuario como candidato de esa empresa\n        if (count($agendas) == 0) {\n            $this->empresa_usuario_repositorio->eliminarPorEmpresaUsuarioRol(new Request([\n                'empresa_id' => $proceso->empresa_id,\n                'usuario_id' => $usuario_id,\n                'rol_id'     => $this->rol_repositorio::ROL_EVALUADO_ID\n            ]));\n        }\n    }\n\n    /**\n     * Agregar participantes al proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception Si la direcci√≥n de correo electr√≥nico de nuevo participante ya fue tomada por otro usuario.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     */\n    public function agregarParticipantes(int $id, Request $request): void {\n        $proceso              = $this->repositorio->getUno($id);\n        $fecha_cierre_agendas = $this->calcularFechaCierreAgendas($request);\n        $this->validarFechas($fecha_cierre_agendas, $proceso->fecha_cierre, $id);\n        $request->merge([\n            'fecha_limite'    => $fecha_cierre_agendas,\n            'capturar_camara' => $proceso->capturar_camara,\n            'capturar_video'  => $proceso->capturar_video\n        ]);\n\n        // Guardar participantes\n        $this->guardarParticipantes($proceso, $request);\n        $this->repositorio->actualizar($proceso->id, ['estado_id' => EstadoProceso::ACTIVO_ID]);\n    }\n\n    /**\n     * Validar las fechas de cierre del proceso y sus agendas.\n     *\n     * @param string $fecha_cierre_agendas Fecha de cierre de agendas.\n     * @param string|null $fecha_cierre_proceso Fecha de cierre del proceso.\n     * @param int|null $id ID del proceso.\n     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalizaci√≥n del proceso.\n     * @throws Exception Si la fecha de finalizaci√≥n del proceso es anterior a la fecha de las agendas existentes.\n     * @return void\n     * @author Daniel Beltr√°n\n     */\n    private function validarFechas(string $fecha_cierre_agendas, ?string $fecha_cierre_proceso = null, ?int $id = null): void {\n        $fecha_cierre_agendas = Carbon::createFromDate($fecha_cierre_agendas);\n\n        if ($fecha_cierre_agendas < now()) {\n            throw new Exception('La fecha de vencimiento de las agendas no puede ser anterior a la fecha actual.', 400);\n        }\n\n        if (!is_null($fecha_cierre_proceso)) {\n            // Validar que la fecha de vencimiento de las agendas no sea posterior a la fecha de cierre del proceso\n            if ($fecha_cierre_agendas > $fecha_cierre_proceso) {\n                throw new Exception('La fecha de vencimiento de las agendas no puede ser posterior a la fecha de finalizaci√≥n del proceso.', 400);\n            }\n\n            // Validar que la fecha de cierre del proceso no sea anterior a la fecha de las agendas existentes\n            if (!is_null($id) && $this->agenda_repositorio->existenAgendasPosterioresAlCierreDelProceso($id, $fecha_cierre_proceso)) {\n                throw new Exception('La fecha de finalizaci√≥n del proceso no puede ser anterior a la fecha de las agendas existentes.', 400);\n            }\n        }\n    }\n\n    /**\n     * Reagendar participantes.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception Si la fecha de vencimiento de las agendas es anterior a la fecha actual.\n     * @throws Exception Si la fecha de vencimiento de las agendas es posterior a la fecha de finalizaci√≥n del proceso.\n     * @throws Exception Si la fecha de finalizaci√≥n del proceso es anterior a la fecha de las agendas existentes.\n     * @return array Informaci√≥n sobre el reagendamiento realizado.\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     * @author Sergio Vargas\n     * @author Jair Carvajal\n     */\n    public function reagendarParticipantes(Request $request): array {\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n\n        // Validar la configuraci√≥n de captura de c√°mara y v√≠deo\n        if ($request->filled('capturar_camara') && filter_var($request->capturar_camara, FILTER_VALIDATE_BOOLEAN) && !$proceso->capturar_camara) {\n            $request->merge(['capturar_camara' => false]);\n        }\n\n        if ($request->filled('capturar_video') && filter_var($request->capturar_video, FILTER_VALIDATE_BOOLEAN) && !$proceso->capturar_video) {\n            $request->merge(['capturar_video' => false]);\n        }\n\n        $request->merge(['fecha_cierre' => $this->calcularFechaCierreAgendas($request)]);\n        $this->validarFechas($request->fecha_cierre, $proceso->fecha_cierre, $proceso->id);\n\n        $resultado = [\n            'agendas_reagendadas'       => 0,\n            'agendas_reprogramadas'     => 0,\n            'agendas_omitidas'          => 0,\n            'participantes_notificados' => 0,\n            'limite_agendas'            => 0,\n            'mensajes_limite'           => []\n        ];\n\n        $configuracion = $this->configuracion_modelo_servicio->obtenerConfiguracion(Empresa::class, $request->empresa_id, 45);\n\n        foreach ($request->participantes as $participante_id) {\n            $usuario                       = $this->usuario_repositorio->getUno($participante_id);\n            $agendas_usuario_reagendadas   = 0;\n            $agendas_usuario_reprogramadas = 0;\n            $agendas_usuario_omitidas      = 0;\n\n            if ($request->filled('email')) {\n                $usuario->email = $request->email;\n            }\n\n            foreach ($request->pruebas as $prueba_id) {\n                // Obtener agendas en estado agendadas, iniciadas o expiradas para esta prueba espec√≠fica\n                $agendas_activas = $this->agenda_repositorio->getTodo(new Request([\n                    'proceso_id'  => $proceso->id,\n                    'evaluado_id' => $participante_id,\n                    'prueba_id'   => $prueba_id,\n                    'estados_ids' => [EstadoAgenda::AGENDADA_ID, EstadoAgenda::INICIADA_ID, EstadoAgenda::EXPIRADA_ID]\n                ]));\n\n                if ($agendas_activas->isNotEmpty()) {\n                    // Si ya existe una agenda AGENDADA, INICIADA o EXPIRADA, solo actualizar la primera\n                    $agenda_activa = $agendas_activas->first();\n\n                    // Cuando la agenda tiene estado expirada, se resetea todo y se devuelve a estado sin iniciar\n                    if ($agenda_activa->estado_id === EstadoAgenda::EXPIRADA_ID) {\n                        $this->agenda_servicio->restablecerAgenda($agenda_activa->id);\n                    }\n\n                    $this->agenda_repositorio->actualizar($agenda_activa->id, Arr::only($request->all(), ['estado_id', 'fecha_cierre', 'capturar_camara', 'capturar_video']));\n                    $agendas_usuario_reprogramadas++;\n                } else {\n                    // Si no existe agenda activa, buscar la agenda principal m√°s reciente para reagendar\n                    $agenda_principal = $this->agenda_repositorio->getTodo(new Request([\n                        'proceso_id'             => $proceso->id,\n                        'evaluado_id'            => $participante_id,\n                        'prueba_id'              => $prueba_id,\n                        'solo_principales'       => true,\n                        'contar_reagendamientos' => true\n                    ]))->first();\n\n                    if (!$agenda_principal) {\n                        continue; // Si no existe agenda para esta prueba, continuar con la siguiente\n                    }\n                    // Se agrega 1 conteo m√°s porque el l√≠mite de reagendamientos es el l√≠mite de pruebas - Hablado con yhey 25/09/2025\n                    $agenda_principal->reagendamientos++;\n                    $resultado['limite_agendas'] = intval($configuracion->valor);\n\n                    // Validar l√≠mite m√°ximo de 3 reagendamientos\n                    if ($agenda_principal->reagendamientos >= intval($configuracion->valor)) {\n                        $agendas_usuario_omitidas++;\n\n                        $resultado['mensajes_limite'][] = [\n                            'participante'    => $usuario->nombre_completo,\n                            'prueba'          => $agenda_principal->prueba->nombre ?? 'Prueba sin nombre',\n                            'reagendamientos' => $agenda_principal->reagendamientos\n                        ];\n\n                        continue;\n                    }\n\n                    // Crear nueva agenda (reagendamiento)\n                    $datos                    = Arr::only($agenda_principal->toArray(), ['empresa_id', 'proceso_id', 'prueba_id', 'baremo_id', 'perfil_id', 'evaluador_id', 'evaluado_id', 'cargo_id', 'clasificacion_id', 'ajuste']);\n                    $datos['agenda_id']       = $agenda_principal->id;\n                    $datos['estado_id']       = EstadoAgenda::AGENDADA_ID;\n                    $datos['fecha_inicio']    = now();\n                    $datos['fecha_cierre']    = $request->fecha_cierre;\n                    $datos['capturar_camara'] = $request->capturar_camara ?? false;\n                    $datos['capturar_video']  = $request->capturar_video ?? false;\n                    $this->agenda_repositorio->crear($datos);\n\n                    $agendas_usuario_reagendadas++;\n                }\n            }\n\n            $resultado['agendas_reagendadas']   += $agendas_usuario_reagendadas;\n            $resultado['agendas_reprogramadas'] += $agendas_usuario_reprogramadas;\n            $resultado['agendas_omitidas']      += $agendas_usuario_omitidas;\n\n            // Enviar correo de notificaci√≥n si se reagend√≥ o reprogram√≥ al menos una agenda para este usuario\n            if ($agendas_usuario_reagendadas > 0 || $agendas_usuario_reprogramadas > 0) {\n                $this->agenda_servicio->notificarAgendamientos($usuario, $proceso, $proceso->mostrar_logo_aplicante);\n                $resultado['participantes_notificados']++;\n            }\n        }\n\n        return $resultado;\n    }\n\n    /**\n     * Asociar etapas de usuarios al proceso.\n     *\n     * Si el usuario ya tiene una etapa asociada al proceso, entonces no se guardar√° el registro.\n     *\n     * @param Proceso $proceso Proceso.\n     * @param array $usuarios ID's de los usuarios con sus etapas.\n     * @return void\n     * @author Daniel Beltr√°n\n     */\n    public function asociarEtapasUsuarios(Proceso $proceso, array $usuarios): void {\n        foreach (array_keys($usuarios) as $usuario_id) {\n            $existe = $this->etapa_usuario_repositorio->getUnoAvanzado(new Request([\n                'usuario_id' => $usuario_id,\n                'proceso_id' => $proceso->id\n            ]));\n\n            if ($existe) {\n                unset($usuarios[$usuario_id]);\n            }\n        }\n\n        $this->repositorio->asociarEtapasUsuarios($proceso, $usuarios);\n    }\n\n    /**\n     * Env√≠ar el mensaje de correo electr√≥nico que contiene el link del proceso a todos los destinatarios.\n     *\n     * @param Request $request Contenido de la petici√≥n HTTP.\n     * @return void\n     * @author Fahibram C√°rcamo\n     */\n    public function compartirProceso(Request $request): void {\n        $proceso = $this->repositorio->getUno($request->proceso_id);\n\n        foreach ($request->emails_destinatarios as $email_destinatario) {\n            Mail::to($email_destinatario)\n                ->queue(new CompartirProcesoMail(\n                    $proceso,\n                    trim(strtolower($email_destinatario)),\n                    $request->fecha_hora_expiracion,\n                    $request->contenido\n                ));\n        }\n    }\n\n    /**\n     * Env√≠ar el mensaje de correo electr√≥nico que contiene el link de los resultados de un usuario aplicante en un proceso a todos los destinatarios.\n     *\n     * @param Request $request Contenido de la petici√≥n HTTP.\n     * @return void\n     * @author Fahibram C√°rcamo\n     */\n    public function compartirResultadosProcesoAplicante(Request $request): void {\n        foreach ($request->emails_destinatarios as $email_destinatario) {\n            Mail::to($email_destinatario)\n                ->queue(new CompartirResultadosProcesoMail(\n                    $this->repositorio->getUno($request->proceso_id),\n                    $this->usuario_repositorio->getUno($request->aplicante_id),\n                    trim(strtolower($email_destinatario)),\n                    $request->fecha_hora_expiracion,\n                    $request->contenido\n                ));\n        }\n    }\n\n    /**\n     * Obtener las pruebas que tiene que realizar el aplicante, agrupadas por proceso.\n     *\n     * Se filtran los resultados de tal manera que obtenga √∫nicamente los que tienen agendas\n     * pendientes por completar.\n     *\n     * Se modific√≥ esta funci√≥n para retornar no solamente las pruebas de los usuarios con rol\n     * aplicante si no tambien los que tienen rol de tipo empresa.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return Collection\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     * @author Jair Carvajal\n     */\n    public function obtenerPruebasAplicante(Request $request): Collection {\n        $orden_pruebas = [\n            Prueba::IQ_FACTORIAL_ID,\n            Prueba::TEN_DISC_PLUS_ID,\n            Prueba::TEN_DISC_ID,\n            Prueba::POTENCIAL_COMERCIAL_ID,\n            Prueba::PRUEBA_ESTATAL_ID,\n            Prueba::ETHIKOS_ID,\n            Prueba::ETHIKOS_RIESGOS_ID,\n            Prueba::VYP_ID\n        ];\n\n        $procesos = $this->repositorio->obtenerPruebasAplicante($request)\n            ->filter(function ($proceso) {\n                $agendas_completadas = $proceso->agendas->filter(function ($agenda) {\n                    return in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n                });\n\n                return $agendas_completadas->count() !== $proceso->agendas->count();\n            })\n            ->each(function ($proceso) use ($orden_pruebas) { // Ordenar las agendas seg√∫n la prueba a la que pertenezcan\n                $agendas_pendientes = $proceso->agendas->filter(function ($agenda) {\n                    return !in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n                });\n\n                $agendas_ordenadas = $agendas_pendientes->sortBy(function ($agenda) use ($orden_pruebas) {\n                    $posicion = array_search($agenda->prueba_id, $orden_pruebas);\n                    return !$posicion ? $posicion : 999;\n                })->values();\n\n                // Se asigna de esta forma, ya que, de no hacerlo, nunca se asigna el valor modificado a la relaci√≥n\n                $proceso->setRelation('agendas', $agendas_ordenadas);\n            })\n            ->filter(function ($proceso) {\n                return $proceso->agendas->isNotEmpty();\n            });\n\n        return $procesos;\n    }\n\n    /**\n     * Obtener pruebas completadas del aplicante (agendas finalizadas o expiradas).\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return Collection\n     * @author Jair Carvajal\n     * @author Andres Gonzalez\n     */\n    public function obtenerPruebasAplicanteCompletadas(Request $request): Collection {\n        $orden_pruebas = [\n            Prueba::IQ_FACTORIAL_ID,\n            Prueba::TEN_DISC_PLUS_ID,\n            Prueba::TEN_DISC_ID,\n            Prueba::POTENCIAL_COMERCIAL_ID,\n            Prueba::PRUEBA_ESTATAL_ID,\n            Prueba::ETHIKOS_ID,\n            Prueba::ETHIKOS_RIESGOS_ID,\n            Prueba::VYP_ID\n        ];\n\n        // Agregar el par√°metro para incluir procesos cerrados\n        $request->merge(['incluir_procesos_cerrados' => true]);\n\n        $procesos = $this->repositorio->obtenerPruebasAplicante($request)\n            ->each(function ($proceso) use ($orden_pruebas) { // Filtrar y ordenar solo agendas completadas\n                // Filtrar solo agendas completadas (finalizadas o expiradas)\n                $agendas_completadas = $proceso->agendas->filter(function ($agenda) {\n                    return in_array($agenda->estado_id, [Agenda::ESTADO_FINALIZADA_ID, Agenda::ESTADO_EXPIRADA_ID]);\n                });\n\n                $agendas_ordenadas = $agendas_completadas->sortBy(function ($agenda) use ($orden_pruebas) {\n                    $posicion = array_search($agenda->prueba_id, $orden_pruebas);\n                    return !$posicion ? $posicion : 999;\n                })->values();\n\n                // Calcular IQ para agendas de IQ Factorial finalizadas\n                $agendas_ordenadas = $agendas_ordenadas->map(function ($agenda) {\n                    if ($agenda->prueba_id == Prueba::IQ_FACTORIAL_ID && $agenda->estado_id == Agenda::ESTADO_FINALIZADA_ID) {\n                        // Cargar la relaci√≥n dimension.factor si no est√° cargada\n                        if (!$agenda->resultados->first()?->relationLoaded('dimension')) {\n                            $agenda->load('resultados.dimension.factor');\n                        }\n\n                        // Agrupar resultados por factor_id y obtener todas las dimensiones\n                        $resultados_por_factor = $agenda->resultados->groupBy(function ($resultado) {\n                            return $resultado->dimension->factor_id ?? null;\n                        })->filter(fn($grupo, $llave) => !is_null($llave));\n\n                        $dimensiones = $resultados_por_factor->flatten()->values();\n\n                        if ($dimensiones->count() > 0 && $resultados_por_factor->count() > 0) {\n                            $agenda->iq = round($this->calcularIQ($dimensiones->toArray(), $resultados_por_factor->count()));\n                        }\n                    }\n\n                    return $agenda;\n                });\n\n                // Se asigna de esta forma, ya que, de no hacerlo, nunca se asigna el valor modificado a la relaci√≥n\n                $proceso->setRelation('agendas', $agendas_ordenadas);\n            })\n            ->filter(function ($proceso) {\n                // Solo incluir procesos que tengan al menos una agenda completada\n                return $proceso->agendas->isNotEmpty();\n            });\n\n        return $procesos;\n    }\n\n    /**\n     * Obtener resultados de las agendas finalizadas de un proceso para exportar a Excel.\n     *\n     * Genera un array con la informaci√≥n de cada participante incluyendo datos personales,\n     * puntajes de factores y dimensiones, y conceptos de recomendaci√≥n basados en rangos.\n     *\n     * @param int $proceso_id Id del proceso.\n     * @param array $evaluados_ids Array de IDs de evaluados a filtrar (opcional).\n     * @param bool $reporte_comparativo Indica si es para reporte comparativo (opcional).\n     * @return array Array con resultados agrupados por prueba con estructura:\n     *               ['prueba_id' => ['nombre_prueba' => string, 'resultados' => array]]\n     * @author Sergio Vargas\n     * @author Andres Morales\n     */\n    public function resultadosProcesoAgendas(int $proceso_id, array $evaluados_ids = [], bool $reporte_comparativo = false): array {\n        $resultados                       = [];\n        $datos_resultados_proceso_agendas = $this->agenda_repositorio->obtenerDatosResultadosProcesoAgendas($proceso_id, $evaluados_ids);\n\n        if (count($datos_resultados_proceso_agendas) === 0) {\n            return [];\n        }\n\n        foreach ($datos_resultados_proceso_agendas as $datos_agenda) {\n            if (!array_key_exists($datos_agenda->prueba_id, $resultados)) {\n                $resultados[$datos_agenda->prueba_id] = [\n                    'nombre_prueba'      => $datos_agenda->prueba->nombre,\n                    'nombre_prueba_slug' => Str::slug($datos_agenda->prueba->nombre),\n                    'resultados'         => []\n                ];\n            }\n\n            $ajuste        = $datos_agenda->ajuste ?? 0;\n            $concepto      = $this->calcularConcepto($ajuste);\n            $nombre_perfil = $datos_agenda->perfil ? $datos_agenda->perfil->nombre : '';\n\n            $campos = $reporte_comparativo ? ['id_agenda', 'nombre', 'documento', 'perfil', 'correo', 'ajuste', 'concepto'] : ['ID Agenda', 'Nombre', 'Documento', 'Perfil', 'Correo', 'Ajuste', 'Concepto'];\n\n            $valores = [\n                $datos_agenda->id,\n                $datos_agenda->evaluado->nombres . ' ' . $datos_agenda->evaluado->apellidos,\n                $datos_agenda->evaluado->documento ?? '',\n                $nombre_perfil,\n                $datos_agenda->evaluado->email ?? '',\n                round($ajuste, 2),\n                $concepto\n            ];\n\n            $nueva_fila_prueba = array_combine($campos, $valores);\n\n            if ($datos_agenda->perfil) {\n                foreach ($datos_agenda->perfil->factoresPerfiles as $factor_perfil) {\n                    $factor         = $factor_perfil->factor;\n                    $puntaje_factor = $this->calcularPuntajeFactorPerfil($factor_perfil, $datos_agenda);\n\n                    if ($reporte_comparativo) {\n                        $factor_data = [\n                            'nombre'      => $factor->nombre,\n                            'nombre_slug' => Str::slug($factor->nombre),\n                            'value'       => round($puntaje_factor, 2),\n                            'type'        => 'factor',\n                            'dimensiones' => []\n                        ];\n\n                        foreach ($factor_perfil->dimensionesFactoresPerfiles as $dimension_factor_perfil) {\n                            $dimension                    = $dimension_factor_perfil->dimension;\n                            $resultado                    = $datos_agenda->resultados->where('dimension_id', $dimension->id)->first();\n                            $factor_data['dimensiones'][] = [\n                                'nombre'      => $dimension->nombre,\n                                'nombre_slug' => Str::slug($dimension->nombre),\n                                'value'       => $resultado ? round($resultado->puntaje_transformado, 2) : '',\n                                'type'        => 'dimension'\n                            ];\n                        }\n\n                        $nueva_fila_prueba['factores'][] = $factor_data;\n                    } else {\n                        $nueva_fila_prueba[$factor->nombre] = [\n                            'value' => round($puntaje_factor, 2),\n                            'type'  => 'factor'\n                        ];\n\n                        foreach ($factor_perfil->dimensionesFactoresPerfiles as $dimension_factor_perfil) {\n                            $dimension                             = $dimension_factor_perfil->dimension;\n                            $resultado                             = $datos_agenda->resultados->where('dimension_id', $dimension->id)->first();\n                            $nueva_fila_prueba[$dimension->nombre] = [\n                                'value' => $resultado ? round($resultado->puntaje_transformado, 2) : '',\n                                'type'  => 'dimension'\n                            ];\n                        }\n                    }\n                }\n            }\n\n            $resultados[$datos_agenda->prueba_id]['resultados'][] = $nueva_fila_prueba;\n        }\n\n        return $resultados;\n    }\n\n    /**\n     * Generar datos de resumen de participantes para exportaci√≥n Excel.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param array $evaluados_ids Array de IDs de evaluados a filtrar (opcional).\n     * @return array Array con datos de resumen por participante.\n     * @author Sergio Vargas\n     */\n    public function generarResumenParticipantes(int $proceso_id, array $evaluados_ids = []): array {\n        $todas_las_agendas        = $this->agenda_repositorio->obtenerAgendasParaResumenParticipantes($proceso_id, $evaluados_ids);\n        $proceso                  = $this->repositorio->getUno($proceso_id);\n        $resumen_participantes    = [];\n        $agendas_por_participante = $todas_las_agendas->groupBy('evaluado_id');\n\n        $resultados_detallados = $this->resultadosProcesoAgendas($proceso_id, $evaluados_ids);\n\n        foreach ($agendas_por_participante as $evaluado_id => $agendas_participante) {\n            $primer_agenda = $agendas_participante->first();\n            $evaluado      = $primer_agenda->evaluado;\n\n            $total_asignadas   = $agendas_participante->count();\n            $finalizadas       = $agendas_participante->where('estado_id', Agenda::ESTADO_FINALIZADA_ID);\n            $total_finalizadas = $finalizadas->count();\n\n            $porcentaje = $total_asignadas > 0 ? round(($total_finalizadas / $total_asignadas) * 100, 1) : 0;\n\n            $nombres_pruebas_finalizadas = $finalizadas->map(function ($agenda) {\n                return $agenda->prueba->nombre ?? 'Prueba sin nombre';\n            })->unique()->implode(', ');\n\n            $ultima_finalizacion = $finalizadas->max('fecha_procesamiento') ?? $finalizadas->max('updated_at');\n\n            $indice_talento         = $this->repositorio->obtenerIndiceTalento($proceso_id, $evaluado_id);\n            $indice_talento_valor   = $indice_talento->indice_talento ?? 0;\n            $indice_talento_display = $indice_talento_valor;\n\n            if ($indice_talento_valor == -2) {\n                $indice_talento_display = 'Pruebas pendientes';\n            } elseif ($indice_talento_valor == -1) {\n                $indice_talento_display = 'Procesamiento pendiente';\n            }\n\n            $concepto = '';\n\n            if (is_numeric($indice_talento_valor)) {\n                $concepto = $this->calcularConcepto($indice_talento_valor);\n            }\n\n            $fila_participante = [\n                'nombre'         => $evaluado->nombre_completo,\n                'documento'      => $evaluado->documento ?? '',\n                'correo'         => $evaluado->email ?? '',\n                'edad'           => $evaluado->edad,\n                'proceso'        => $proceso->nombre ?? '',\n                'indice_talento' => $indice_talento_display,\n                'concepto'       => $concepto\n            ];\n\n            foreach ($resultados_detallados as $prueba_id => $datos_prueba) {\n                $nombre_prueba = $datos_prueba['nombre_prueba'];\n                $ajuste_prueba = '';\n\n                foreach ($datos_prueba['resultados'] as $resultado) {\n                    $nombre_participante    = $resultado['Nombre'];\n                    $documento_participante = $resultado['Documento'];\n\n                    if ($evaluado->nombre_completo === $nombre_participante || $evaluado->documento === $documento_participante) {\n                        $ajuste_prueba = $resultado['Ajuste'];\n                        break;\n                    }\n                }\n\n                $fila_participante[$nombre_prueba] = $ajuste_prueba;\n            }\n\n            $resumen_participantes[] = $fila_participante;\n        }\n\n        return $resumen_participantes;\n    }\n\n    /**\n     * Calcular concepto de recomendaci√≥n basado en el puntaje de ajuste.\n     *\n     * Determina el nivel de recomendaci√≥n de un candidato seg√∫n su puntaje de ajuste:\n     * - 0-60: No recomendado\n     * - 60-76: Recomendado con sugerencias\n     * - 76-100: Recomendado\n     *\n     * @param float $ajuste Puntaje de ajuste del candidato (0-100).\n     * @return string Concepto de recomendaci√≥n correspondiente.\n     * @author Sergio Vargas\n     */\n    private function calcularConcepto(float $ajuste): string {\n        if ($ajuste >= 0 && $ajuste < 60) {\n            return 'No recomendado';\n        } elseif ($ajuste >= 60 && $ajuste < 76) {\n            return 'Recomendado con sugerencias';\n        } elseif ($ajuste >= 76 && $ajuste <= 100) {\n            return 'Recomendado';\n        }\n\n        return 'Sin evaluar';\n    }\n\n    /**\n     * Calcular puntaje de un factor basado en los pesos de sus dimensiones.\n     *\n     * Utiliza la configuraci√≥n de pesos del perfil asignado a la agenda para calcular\n     * el puntaje ponderado del factor. Cada dimensi√≥n contribuye al puntaje final\n     * seg√∫n su peso configurado en el perfil.\n     *\n     * @param object $factor Factor a calcular.\n     * @param object $agenda Agenda con los resultados y perfil asignado.\n     * @return float Puntaje calculado del factor, 0.0 si no hay configuraci√≥n o datos.\n     * @author Sergio Vargas\n     */\n    private function calcularPuntajeFactor($factor, $agenda): float {\n        if (!$agenda->perfil_id) {\n            return 0.0;\n        }\n\n        $factor_perfil = $factor->factoresPerfiles->where('perfil_id', $agenda->perfil_id)->first();\n\n        if (!$factor_perfil) {\n            return 0.0;\n        }\n\n        $dimensiones_factor_perfil = $factor_perfil->dimensionesFactoresPerfiles ?? collect();\n        $puntaje_total             = 0.0;\n        $peso_total                = 0.0;\n\n        foreach ($factor->dimensiones as $dimension) {\n            $resultado = $agenda->resultados->where('dimension_id', $dimension->id)->first();\n\n            if ($resultado) {\n                $dimension_factor_perfil = $dimensiones_factor_perfil->where('dimension_id', $dimension->id)->first();\n                $peso                    = $dimension_factor_perfil ? $dimension_factor_perfil->peso : 0;\n\n                $puntaje_total += $resultado->puntaje_transformado * $peso;\n                $peso_total    += $peso;\n            }\n        }\n\n        return $peso_total > 0 ? $puntaje_total / $peso_total : 0.0;\n    }\n\n    /**\n     * Calcular el puntaje de un factor espec√≠fico usando el FactorPerfil directamente.\n     *\n     * @param object $factor_perfil FactorPerfil con dimensiones cargadas.\n     * @param object $agenda Agenda con los resultados.\n     * @return float Puntaje calculado del factor.\n     * @author Sergio Vargas\n     */\n    private function calcularPuntajeFactorPerfil($factor_perfil, $agenda): float {\n        $dimensiones_factor_perfil = $factor_perfil->dimensionesFactoresPerfiles;\n        $puntaje_total             = 0.0;\n        $peso_total                = 0.0;\n\n        foreach ($dimensiones_factor_perfil as $dimension_factor_perfil) {\n            $resultado = $agenda->resultados->where('dimension_id', $dimension_factor_perfil->dimension_id)->first();\n\n            if ($resultado) {\n                $peso = $dimension_factor_perfil->peso;\n                $puntaje_total += $resultado->puntaje_transformado * $peso;\n                $peso_total    += $peso;\n            }\n        }\n\n        return $peso_total > 0 ? $puntaje_total / $peso_total : 0.0;\n    }\n\n    /**\n     * Actualizar campos de captura de c√°mara y video en agendas con estado AGENDADA.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param bool $capturar_camara Configuraci√≥n para capturar c√°mara.\n     * @param bool $capturar_video Configuraci√≥n para capturar video.\n     * @return void\n     * @author Andres Morales\n     */\n    private function actualizarCamposCapturarEnAgendas(int $proceso_id, bool $capturar_camara, bool $capturar_video): void {\n        $agendas = $this->agenda_repositorio->getTodo(new Request([\n            'proceso_id' => $proceso_id,\n            'estado_id'  => EstadoAgenda::AGENDADA_ID\n        ]));\n\n        if ($agendas->count() > 0) {\n            $agendas_ids = $agendas->pluck('id')->toArray();\n            $this->agenda_repositorio->actualizarVarios($agendas_ids, [\n                'capturar_camara' => $capturar_camara,\n                'capturar_video'  => $capturar_video\n            ]);\n        }\n    }\n\n    /**\n     * Obtener un top 3 de los mejores candidatos.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @throws Exception|GuzzleException Cuando la IA no genera el listado.\n     * @throws RequestException Cuando ocurre un error de conexi√≥n con el servicio de IA.\n     * @return array\n     * @author Andres Gonzalez\n     * @author Fahibram C√°rcamo\n     */\n    public function generarMejoresCandidatosIA(Request $request): array {\n        $pruebas = $this->prueba_repositorio->getDatosBasicos(new Request(['activo' => true]));\n        $pruebas = $pruebas->map(function ($prueba) {\n            return $prueba->only(['nombre', 'descripcion']);\n        });\n\n        $candidatos = [];\n\n        foreach ($request->candidatos as $candidato) {\n            $resultados_agendas = $this->resultado_agenda_repositorio->getTodo(new Request(['agendas_ids' => $candidato['agendas']]));\n\n            $resultados_agendas_procesados = $resultados_agendas->map(function ($item) {\n                return [\n                    'competencia'         => $item->dimension->nombre,\n                    'puntaje_competencia' => $item->puntaje_transformado,\n                    'prueba_competencia'  => $item->agenda->prueba->nombre\n                ];\n            })->toArray();\n\n            $candidatos[] = [\n                'nombre'      => $candidato['nombre'],\n                'puntajes'    => $resultados_agendas_procesados,\n                'comentarios' => $candidato['comentarios'] ?? []\n            ];\n        }\n\n        $cliente = new Client([\n            'timeout' => 120,\n            'headers' => [\n                'Content-Type' => 'application/json',\n                'Accept'       => 'application/json'\n            ]\n        ]);\n\n        $tiempo_inicio = microtime(true);\n        $payload_peticion = json_encode([\n            'vacante'             => trim($request->vacante),\n            'pregunta_especifica' => trim($request->pregunta_especifica),\n            'candidatos'          => $candidatos,\n            'pruebas'             => $pruebas\n        ]);\n\n        try {\n            $respuesta = $cliente->post(env('FASTAPI_BASE_URL', 'http://localhost:8001') . '/mejores-candidatos/', [\n                'json' => [\n                    'vacante'             => trim($request->vacante),\n                    'pregunta_especifica' => trim($request->pregunta_especifica),\n                    'candidatos'          => $candidatos,\n                    'pruebas'             => $pruebas\n                ]\n            ]);\n\n            $respuesta_ia = json_decode($respuesta->getBody()->getContents(), true);\n        } catch (RequestException $error) {\n            $mensaje_error = 'Error de conexi√≥n con el servicio de IA';\n\n            if ($error->hasResponse()) {\n                $respuesta_error = json_decode($error->getResponse()->getBody()->getContents(), true);\n                $mensaje_error   = 'Error en el servicio de IA: ' . ($respuesta_error['detail'] ?? 'Error desconocido');\n            }\n\n            throw new Exception($mensaje_error);\n        }\n\n        if (!$respuesta_ia) {\n            throw new Exception('Respuesta inv√°lida del servicio de IA');\n        }\n\n        // Normalizar estructura y extraer usage desde top_3 si viene anidado\n        $usage = $respuesta_ia['usage'] ?? null;\n        if (! $usage && isset($respuesta_ia['top_3']) && is_array($respuesta_ia['top_3'])) {\n            $usage = $respuesta_ia['top_3']['usage'] ?? null;\n            if ($usage) {\n                $respuesta_ia['usage'] = $usage;\n            }\n            if (! isset($respuesta_ia['data']) && isset($respuesta_ia['top_3']['data'])) {\n                $respuesta_ia['data'] = $respuesta_ia['top_3']['data'];\n            }\n        }\n\n        if (! $usage) {\n        }\n\n        $this->registrarConsumoTokens(\n            ruta_endpoint: 'mejores-candidatos',\n            respuesta_ia: $respuesta_ia,\n            payload_peticion: $payload_peticion,\n            latencia_ms: (int) ((microtime(true) - $tiempo_inicio) * 1000),\n            contexto: [\n                'vacante_id' => $request->vacante_id ?? null\n            ]\n        );\n\n        return $respuesta_ia ?? [];\n    }\n\n    /**\n     * Construir respuesta para reagendamientos seg√∫n los resultados.\n     *\n     * @param array $resultados Resultados de los reagendamientos.\n     * @return array\n     * @author Daniel Beltr√°n\n     */\n    public function construirRespuestaReagendamientos(array $resultados): array {\n        $mensaje              = '';\n        $operaciones_exitosas = $resultados['agendas_reagendadas'] + $resultados['agendas_reprogramadas'];\n\n        if ($operaciones_exitosas > 0) {\n            $partes_mensaje = [];\n\n            if ($resultados['agendas_reagendadas'] > 0) {\n                $partes_mensaje[] = $resultados['agendas_reagendadas'] . ' agenda(s) reagendada(s)';\n            }\n\n            if ($resultados['agendas_reprogramadas'] > 0) {\n                $partes_mensaje[] = $resultados['agendas_reprogramadas'] . ' agenda(s) reprogramada(s)';\n            }\n\n            $mensaje = 'Operaciones realizadas correctamente. ' . implode(' y ', $partes_mensaje);\n\n            if ($resultados['participantes_notificados'] > 0) {\n                $mensaje .= ' y ' . $resultados['participantes_notificados'] . ' participante(s) notificado(s)';\n            }\n\n            $mensaje .= '.';\n        }\n\n        // Agregar informaci√≥n sobre agendas omitidas por l√≠mite\n        $mensajes_limite = [];\n\n        if ($resultados['agendas_omitidas'] > 0) {\n            $mensajes_limite[] = $resultados['agendas_omitidas'] . ' agenda(s) no se reagendaron por haber alcanzado el l√≠mite m√°ximo de ' . $resultados['limite_agendas'] . ' reagendamientos.';\n\n            foreach ($resultados['mensajes_limite'] as $detalle) {\n                $mensajes_limite[] = \"‚Ä¢ {$detalle['participante']} - {$detalle['prueba']}: {$detalle['reagendamientos']} reagendamientos previos.\";\n            }\n        }\n\n        if ($operaciones_exitosas === 0) {\n            if ($resultados['agendas_omitidas'] > 0) {\n                $mensaje = 'No se pudo reagendar ninguna agenda debido a que todas han alcanzado el l√≠mite m√°ximo de ' . $resultados['limite_agendas'] . ' reagendamientos.';\n            } else {\n                $mensaje = 'No se encontraron agendas para reagendar o reprogramar.';\n            }\n        }\n\n        $respuesta = [\n            'message'  => $mensaje,\n            'detalles' => [\n                'limite_agendas'            => $resultados['limite_agendas'],\n                'agendas_reagendadas'       => $resultados['agendas_reagendadas'],\n                'agendas_reprogramadas'     => $resultados['agendas_reprogramadas'],\n                'agendas_omitidas'          => $resultados['agendas_omitidas'],\n                'participantes_notificados' => $resultados['participantes_notificados']\n            ]\n        ];\n\n        if (!empty($mensajes_limite)) {\n            $respuesta['advertencias'] = $mensajes_limite;\n        }\n\n        return $respuesta;\n    }\n\n    /**\n     * Archivar o desarchivar un proceso.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return array\n     * @author Andres Morales\n     */\n    public function archivarProceso(int $proceso_id): array {\n        $proceso             = $this->repositorio->getUno($proceso_id);\n        $nuevo_estado_activo = !$proceso->activo;\n        $this->repositorio->actualizar($proceso_id, ['activo' => $nuevo_estado_activo]);\n\n        return [\n            'message' => $nuevo_estado_activo\n                ? 'Proceso activado correctamente'\n                : 'Proceso archivado correctamente'\n        ];\n    }\n\n    /**\n     * Actualizar el estado de un proceso basado en el estado de sus agendas.\n     *\n     * L√≥gica de actualizaci√≥n:\n     * - Si todas las agendas est√°n en estado terminal (FINALIZADA, EXPIRADA, INVALIDADA) ‚Üí COMPLETADO\n     * - Si hay al menos una agenda activa (AGENDADA, INICIADA, SIN_PAGO) ‚Üí ACTIVO\n     * - No actualiza procesos en estado CERRADO o SUSPENDIDO (estados protegidos)\n     * - No actualiza procesos sin agendas\n     *\n     * Estados terminales: FINALIZADA (3), EXPIRADA (4), INVALIDADA (5)\n     * Estados activos: AGENDADA (1), INICIADA (2), SIN_PAGO (6)\n     *\n     * @param int $proceso_id ID del proceso.\n     * @return void\n     * @author Sergio Vargas\n     */\n    public function actualizarEstadoPorAgendas(int $proceso_id): void\n    {\n        $proceso = $this->repositorio->getUno($proceso_id);\n\n        if (!$proceso) {\n            return;\n        }\n\n        if (in_array($proceso->estado_id, [EstadoProceso::CERRADO_ID, EstadoProceso::SUSPENDIDO_ID])) {\n            return;\n        }\n\n        $estadisticas = $this->repositorio->obtenerEstadisticasAgendas($proceso_id);\n\n        if ($estadisticas->total_agendas === 0) {\n            return;\n        }\n\n        $nuevo_estado_id = null;\n\n        if ($estadisticas->agendas_activas === 0 && $estadisticas->agendas_terminadas > 0) {\n            $nuevo_estado_id = EstadoProceso::COMPLETADO_ID;\n        } elseif ($estadisticas->agendas_activas > 0) {\n            $nuevo_estado_id = EstadoProceso::ACTIVO_ID;\n        }\n\n        if ($nuevo_estado_id !== null && $proceso->estado_id !== $nuevo_estado_id) {\n            $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);\n        }\n    }\n}\n","structuredPatch":[{"oldStart":1479,"oldLines":4,"newStart":1479,"newLines":23,"lines":["             $this->repositorio->actualizar($proceso_id, ['estado_id' => $nuevo_estado_id]);","         }","     }","+","+    /**","+     * Obtener participantes del proceso con sus √≠ndices de talento calculados.","+     *","+     * @param int $proceso_id ID del proceso.","+     * @return Collection","+     * @author Andres Gonzalez","+     */","+    public function obtenerParticipantesConIndiceTalento(int $proceso_id): Collection {","+        // Cargar participantes del proceso con sus relaciones","+        $participantes = $this->usuario_repositorio->obtenerPorProceso($proceso_id, new Request(['incluir_procesos_pruebas' => true]));","+","+        // Calcular el √≠ndice de talento para cada participante","+        $participantes->each(function ($participante) use ($proceso_id) {","+            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($proceso_id, $participante->id);","+        });","+","+        return $participantes;","+    }"," }"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"db5e5833-83f3-44ea-8b0d-94ed394773c1"}
{"parentUuid":"c74f60eb-c76d-4aa7-9c48-faf50f6d3fe9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QKK9PkGxTXjVRvAqZNgeyN","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Perfecto, ahora debo actualizar el controlador para usar este nuevo m√©todo del servicio en lugar de tener la l√≥gica de negocio directamente en el controlador.","signature":"EskCCkYICxgCKkBxAC+0qDQNR5f9dobGCK70lrE+W9vgqc6UK96y9siqFkJw0Ptbnz+gxJfFBDhu1VlTjFPDUUPL1O6Kmy9DO8koEgy8jlb1b6fkB1NC9tEaDCRNwCK2bYTbRwUekyIwkRf+EYFxFq84uU3jz/PeI0QmHJP8rRlLznq8arFK/BkMJUJkdh7eLvlmSMnS0l5MKrABuvoRxWrJaWST35fOiwJdt2VDWAhCcNGRQSwKmxZCxy3GyE58m+mG2iH6/zCzmzROLE1+ecjnMqGOsbrYzwIRiNLAb9i6UerudTOuniNsPMr9O/GCSBqE1zpiBLv2JdVJ0a7KaOmXnHjlb+MQbZyxuKc3/yZcXXNMyrlltkXpAy4nVHjdGnTQ2xNkJd01CyKz3dqcuyk/yOaGvg5yUW2Mn7w3hNHoVNHi7ZfVhepUaJgYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1605,"cache_read_input_tokens":66026,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1605},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLXbUXGAyeaVpf44u5P","type":"assistant","uuid":"c3596706-4d7a-4362-83f2-08e556f62904","timestamp":"2026-02-06T19:05:33.826Z"}
{"parentUuid":"c3596706-4d7a-4362-83f2-08e556f62904","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QKK9PkGxTXjVRvAqZNgeyN","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a actualizar el controlador para usar este nuevo m√©todo del servicio:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1605,"cache_read_input_tokens":66026,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1605},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLXbUXGAyeaVpf44u5P","type":"assistant","uuid":"0f7ee3e8-4301-4d9d-9ee2-c3c595314bf9","timestamp":"2026-02-06T19:05:34.141Z"}
{"parentUuid":"0f7ee3e8-4301-4d9d-9ee2-c3c595314bf9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01QKK9PkGxTXjVRvAqZNgeyN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Procesos\\ProcesoController.php","old_string":"    /**\n     * Cargar la vista que muestra el proceso a traves de una ruta firmada.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return View\n     * @author Fahibram C√°rcamo\n     * @author Jair Carvajal\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function showFirmada(int $id, Request $request): View {\n        $proceso = $this->repositorio->getUno($id);\n\n        // Cargar participantes del proceso con sus relaciones\n        $participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n\n        $participantes->each(function ($participante) use ($id) {\n            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n        });\n\n        return view('procesos.paginas.proceso-compartido-firmada')->with([\n            'proceso'       => $proceso,\n            'participantes' => $participantes,\n            'empresa'       => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(),\n            'firma'         => $request->firma\n        ]);\n    }","new_string":"    /**\n     * Cargar la vista que muestra el proceso a traves de una ruta firmada.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return View\n     * @author Fahibram C√°rcamo\n     * @author Jair Carvajal\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function showFirmada(int $id, Request $request): View {\n        $proceso       = $this->repositorio->getUno($id);\n        $participantes = $this->servicio->obtenerParticipantesConIndiceTalento($id);\n\n        return view('procesos.paginas.proceso-compartido-firmada')->with([\n            'proceso'       => $proceso,\n            'participantes' => $participantes,\n            'empresa'       => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(),\n            'firma'         => $request->firma\n        ]);\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1605,"cache_read_input_tokens":66026,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":1605},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLXbUXGAyeaVpf44u5P","type":"assistant","uuid":"de7b06f3-9a2c-4a0b-b260-9a2ece00c6e7","timestamp":"2026-02-06T19:05:42.211Z"}
{"type":"file-history-snapshot","messageId":"de7b06f3-9a2c-4a0b-b260-9a2ece00c6e7","snapshot":{"messageId":"2201fd02-aff6-47d7-8708-201469ca57f6","trackedFileBackups":{"app\\Http\\Services\\Procesos\\ProcesoService.php":{"backupFileName":"69142ad6b3725dc8@v1","version":1,"backupTime":"2026-02-06T19:05:30.127Z"},"app\\Http\\Controllers\\Procesos\\ProcesoController.php":{"backupFileName":"8f1fc671d57c4c6c@v1","version":1,"backupTime":"2026-02-06T19:05:59.174Z"}},"timestamp":"2026-02-06T19:02:55.462Z"},"isSnapshotUpdate":true}
{"parentUuid":"de7b06f3-9a2c-4a0b-b260-9a2ece00c6e7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Procesos\\ProcesoController.php has been updated successfully."}]},"uuid":"6738fbee-38db-412c-a2a2-4c12a97d7419","timestamp":"2026-02-06T19:05:59.200Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Procesos\\ProcesoController.php","oldString":"    /**\n     * Cargar la vista que muestra el proceso a traves de una ruta firmada.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return View\n     * @author Fahibram C√°rcamo\n     * @author Jair Carvajal\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function showFirmada(int $id, Request $request): View {\n        $proceso = $this->repositorio->getUno($id);\n\n        // Cargar participantes del proceso con sus relaciones\n        $participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n\n        $participantes->each(function ($participante) use ($id) {\n            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n        });\n\n        return view('procesos.paginas.proceso-compartido-firmada')->with([\n            'proceso'       => $proceso,\n            'participantes' => $participantes,\n            'empresa'       => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(),\n            'firma'         => $request->firma\n        ]);\n    }","newString":"    /**\n     * Cargar la vista que muestra el proceso a traves de una ruta firmada.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return View\n     * @author Fahibram C√°rcamo\n     * @author Jair Carvajal\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function showFirmada(int $id, Request $request): View {\n        $proceso       = $this->repositorio->getUno($id);\n        $participantes = $this->servicio->obtenerParticipantesConIndiceTalento($id);\n\n        return view('procesos.paginas.proceso-compartido-firmada')->with([\n            'proceso'       => $proceso,\n            'participantes' => $participantes,\n            'empresa'       => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(),\n            'firma'         => $request->firma\n        ]);\n    }","originalFile":"<?php\n\nnamespace App\\Http\\Controllers\\Procesos;\n\nuse Exception;\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\Request;\nuse App\\Exports\\GlobalExport;\nuse Illuminate\\Http\\JsonResponse;\nuse App\\Models\\Pruebas\\TipoPrueba;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse Illuminate\\Http\\RedirectResponse;\nuse App\\Http\\Services\\Usuarios\\UserService;\nuse App\\Http\\Services\\Agendas\\AgendaService;\nuse App\\Http\\Services\\Pruebas\\PerfilService;\nuse App\\Http\\Services\\Procesos\\ProcesoService;\nuse App\\Http\\Services\\Accesos\\AccesoRutaService;\nuse App\\Http\\Repositories\\Permisos\\RolRepository;\nuse App\\Exports\\ResultadosProcesoMultiSheetExport;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Services\\Configuraciones\\RutaService;\nuse App\\Http\\Repositories\\Agendas\\AgendaRepository;\nuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\nuse App\\Http\\Requests\\Procesos\\CrearProcesoRequest;\nuse App\\Http\\Repositories\\Procesos\\ProcesoRepository;\nuse App\\Http\\Requests\\Procesos\\DuplicarProcesoRequest;\nuse App\\Http\\Requests\\Procesos\\CompartirProcesoRequest;\nuse Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\nuse App\\Http\\Repositories\\OfertasLaborales\\EtapaRepository;\nuse App\\Http\\Repositories\\Procesos\\EstadoProcesoRepository;\nuse App\\Http\\Requests\\Procesos\\AgregarParticipantesRequest;\nuse App\\Http\\Repositories\\Empresas\\EmpresaUsuarioRepository;\nuse App\\Http\\Requests\\Procesos\\ExtraerDatosPlantillaRequest;\nuse App\\Http\\Requests\\Procesos\\DescartarParticipantesRequest;\nuse App\\Http\\Requests\\Procesos\\ReagendarParticipantesRequest;\nuse App\\Http\\Requests\\Procesos\\SeleccionarParticipanteRequest;\nuse App\\Http\\Requests\\Procesos\\GenerarMejoresCandidatosIARequest;\nuse App\\Http\\Requests\\Procesos\\CambiarProcesoParticipantesRequest;\nuse App\\Imports\\CargaMasiva\\AgendamientoMasivoParticipantesImport;\n\nclass ProcesoController extends Controller\n{\n    /**\n     * üóÇÔ∏è Ruta en la cual se encuentra la plantilla Excel que sirve como gu√≠a para almacenar datos\n     * de participantes para agendamiento masivo. Este es un archivo p√∫blico.\n     *\n     * @var string\n     * @author Fahibram C√°rcamo\n     */\n    public const RUTA_ARCHIVO_GUIA_PARA_CARGA_MASIVA_PARTICIPANTES = 'app/public/archivos/utils/archivo_guia_para_carga_masiva_de_participantes.xlsx';\n\n    /**\n     * Constructor.\n     *\n     * @param ProcesoService $servicio Servicio de procesos.\n     * @param ProcesoRepository $repositorio Repositorio de procesos.\n     * @param RutaService $ruta_servicio Servicio de rutas.\n     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n     * @param AgendaRepository $agenda_repositorio Repositorio de agendas.\n     * @param AgendaService $agenda_servicio Servicio de agendas.\n     * @param UserService $usuario_servicio Servicio de usuarios.\n     * @param EtapaRepository $etapa_repositorio Repositorio de etapas.\n     * @param AccesoRutaService $acceso_ruta_servicio Servicio de accesos a rutas.\n     * @param EstadoProcesoRepository $estado_proceso_repositorio Repositorio de estados proceso.\n     * @param UserRepository $usuario_repositorio Repositorio de estados proceso.\n     * @param EmpresaUsuarioRepository $empresa_usuario_repositorio Repositorio de estados proceso.\n     * @param PerfilService $perfil_servicio Servicio de perfiles.\n     * @return void\n     * @author Daniel Beltr√°n\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     * @author Andres Morales\n     */\n    public function __construct(\n        private ProcesoService $servicio,\n        private ProcesoRepository $repositorio,\n        private RutaService $ruta_servicio,\n        private PruebaRepository $prueba_repositorio,\n        private AgendaRepository $agenda_repositorio,\n        private AgendaService $agenda_servicio,\n        private UserService $usuario_servicio,\n        private EtapaRepository $etapa_repositorio,\n        private AccesoRutaService $acceso_ruta_servicio,\n        private EstadoProcesoRepository $estado_proceso_repositorio,\n        private UserRepository $usuario_repositorio,\n        private EmpresaUsuarioRepository $empresa_usuario_repositorio,\n        private PerfilService $perfil_servicio\n    ) {\n        $this->middleware('auth.proceso-propio')->only('edit');\n    }\n\n    /**\n     * Obtener el listado de procesos.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function listado(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->repositorio->getListado($request)\n        ], 200);\n    }\n\n    /**\n     * Obtener los datos para la tabla.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     * @author Sergio Vargas\n     */\n    public function datosTabla(Request $request): JsonResponse {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n\n        if ($empresa) {\n            $request->merge(['empresa_id' => $empresa->id]);\n        } else {\n            return new JsonResponse(['data' => collect()], 200);\n        }\n\n        return new JsonResponse([\n            'data' => $this->repositorio->getTodo($request)\n        ], 200);\n    }\n\n    /**\n     * Cargar la p√°gina principal.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return View\n     * @author Daniel Beltr√°n\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function index(): View {\n        $empresa = $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario();\n        return view('procesos.index')->with([\n            'rutas_menu'     => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true])),\n            'pruebas'        => $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($empresa->id, TipoPrueba::SELECCION_ID),\n            'estados'        => $this->estado_proceso_repositorio->getTodo(new Request()),\n            'usuarios'       => $this->usuario_repositorio->getPorRolEmpresa(new Request(['empresa_id' => $empresa->id, 'roles_ids' => [RolRepository::ROL_PROPIETARIO_ID, RolRepository::ROL_ADMINISTRADOR_GENERAL_ID, RolRepository::ROL_ADMINISTRADOR_SUCURSAL_ID]])),\n            'empresa_actual' => $empresa\n        ]);\n    }\n\n    /**\n     * Obtener un proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return RedirectResponse|View\n     * @author Daniel Beltr√°n\n     * @author Andres Gonzalez\n     * @author Andres Morales\n     */\n    public function show(int $id): View|RedirectResponse {\n        $proceso = $this->repositorio->getUno($id);\n\n        // Verificar que el proceso pertenece a la empresa del usuario autenticado\n        if (!$proceso || $proceso->empresa_id !== $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id) {\n            return redirect('/procesos');\n        }\n\n        return view('procesos.paginas.detalle')->with([\n            'proceso'    => $proceso,\n            'etapas'     => $this->etapa_repositorio->getTodo(new Request(['para_procesos' => true])),\n            'rutas_menu' => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Cargar la p√°gina de creaci√≥n.\n     *\n     * @return View\n     * @author Daniel Beltr√°n\n     * @author Andres Gonzalez\n     */\n    public function create(): View {\n        $pruebas           = $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id, TipoPrueba::SELECCION_ID);\n        $datos_adicionales = $this->perfil_servicio->getDatosAdicionales();\n\n        return view('procesos.paginas.crear')->with([\n            'pruebas_plan_activo_seleccion' => $pruebas,\n            'nivel_educativo'               => $datos_adicionales['niveles_educativos'],\n            'rutas_menu'                    => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true])),\n            'pruebas'                       => $pruebas,\n        ]);\n    }\n\n    /**\n     * Cargar la p√°gina de edici√≥n.\n     *\n     * @param int $id ID del proceso.\n     * @return View\n     * @author Daniel Beltr√°n\n     * @author Andres Gonzalez\n     */\n    public function edit(int $id): View {\n        $pruebas           = $this->prueba_repositorio->obtenerPorPlanActivoEmpresa($this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id, TipoPrueba::SELECCION_ID);\n        $datos_adicionales = $this->perfil_servicio->getDatosAdicionales();\n\n        return view('procesos.paginas.crear')->with([\n            'proceso'                       => $this->repositorio->getUno($id),\n            'pruebas_plan_activo_seleccion' => $pruebas,\n            'nivel_educativo'               => $datos_adicionales['niveles_educativos'],\n            'pruebas'                       => $pruebas,\n            'tiene_agendas'                 => $this->agenda_repositorio->existenAgendasEnProceso($id),\n            'rutas_menu'                    => $this->ruta_servicio->obtenerTodas(new Request(['rutas_principales' => true]))\n        ]);\n    }\n\n    /**\n     * Crear proceso.\n     *\n     * @param CrearProcesoRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function store(CrearProcesoRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Proceso creado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param CrearProcesoRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function update(int $id, CrearProcesoRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['id' => $id]);\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar un proceso\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function actualizarInformacion(int $id, Request $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, $request->except('_token', '_method'));\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Duplicar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param DuplicarProcesoRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function duplicar(int $id, DuplicarProcesoRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Proceso duplicado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->duplicar($id, $request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Suspender proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function suspender(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso suspendido correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->suspender($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Activar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function activar(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso activado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->activar($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Eliminar proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function destroy(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso eliminado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->eliminar($id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Descartar participantes.\n     *\n     * @param DescartarParticipantesRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function descartarParticipantes(DescartarParticipantesRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Participantes descartados correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->descartarParticipantes($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Seleccionar un participante en un proceso.\n     *\n     * @param SeleccionarParticipanteRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function seleccionarParticipante(SeleccionarParticipanteRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Participante seleccionado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $respuesta[\"estado_proceso\"] = $this->servicio->seleccionarParticipante($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Mover participantes de un proceso a otro.\n     *\n     * @param CambiarProcesoParticipantesRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function moverDeProceso(CambiarProcesoParticipantesRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Participantes trasladados correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->moverDeProceso($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Eliminar un participante de un proceso.\n     *\n     * @param int $proceso_id ID del proceso.\n     * @param int $usuario_id ID del usuario.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function eliminarParticipante(int $proceso_id, int $usuario_id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Participante eliminado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->eliminarParticipante($proceso_id, $usuario_id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Agregar participantes al proceso.\n     *\n     * @param int $id ID del proceso.\n     * @param AgregarParticipantesRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function agregarParticipantes(int $id, AgregarParticipantesRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Participantes agregados correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->agregarParticipantes($id, $request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Extraer los datos de los participantes incluidos en el archivo Excel entrante para su\n     * posterior agendamiento masivo.\n     *\n     * @param ExtraerDatosPlantillaRequest $request Contenido de la petici√≥n HTTP.\n     * @return JsonResponse\n     * @author Fahibram C√°rcamo\n     */\n    public function extraerDatosParticipantes(ExtraerDatosPlantillaRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = ['message' => 'Datos de participantes extraidos correctamente'];\n\n        try {\n            $archivo             = $request->file('archivo');\n            $datos_participantes = [];\n\n            Excel::import(new AgendamientoMasivoParticipantesImport($datos_participantes), $archivo);\n\n            if (empty($datos_participantes)) {\n                throw new Exception('No se encontraron datos v√°lidos en el archivo');\n            }\n\n            $respuesta['datos_participantes'] = $datos_participantes;\n        } catch (Exception $excepcion) {\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $excepcion->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Reagendar participantes.\n     *\n     * @param ReagendarParticipantesRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     * @author Sergio Vargas\n     */\n    public function reagendarParticipantes(ReagendarParticipantesRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [];\n\n        try {\n            DB::beginTransaction();\n            $resultados = $this->servicio->reagendarParticipantes($request);\n            DB::commit();\n\n            $respuesta = $this->servicio->construirRespuestaReagendamientos($resultados);\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Exportar Excel.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return BinaryFileResponse\n     * @author Daniel Beltr√°n\n     */\n    public function exportarExcel(Request $request): BinaryFileResponse {\n        $request->merge(['contar_etapas_usuarios' => true]);\n\n        return Excel::download(new GlobalExport([\n            'ID',\n            'Nombre',\n            'Estado',\n            'Prioridad',\n            'Usuario creador',\n            'Fecha de inicio',\n            'Fecha de cierre',\n            'Cantidad de vacantes',\n            'Capturar c√°mara',\n            'Capturar v√≠deo',\n            'Activo',\n            'Fecha de creaci√≥n',\n            'Participantes en pruebas',\n            'Participantes seleccionados',\n            'Participantes descartados'\n        ], $this->repositorio->getTodo($request), 'Procesos', 'excel.procesos.procesos'), 'procesos.xlsx');\n    }\n\n    /**\n     * Enviar el mensaje de correo electr√≥nico que contiene el link para acceder a los datos de un\n     * proceso a todos los destinatarios.\n     *\n     * @param int $id Id del proceso.\n     * @param CompartirProcesoRequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Fahibram C√°rcamo\n     */\n    public function compartir(int $id, CompartirProcesoRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Proceso compartido exitosamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['proceso_id' => $id]);\n            $this->servicio->compartirProceso($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Cargar la vista que muestra el proceso a traves de una ruta firmada.\n     *\n     * @param int $id ID del proceso.\n     * @param Request $request Contenido de la petici√≥n.\n     * @return View\n     * @author Fahibram C√°rcamo\n     * @author Jair Carvajal\n     * @author Andres Morales\n     * @author Andres Gonzalez\n     */\n    public function showFirmada(int $id, Request $request): View {\n        $proceso = $this->repositorio->getUno($id);\n\n        // Cargar participantes del proceso con sus relaciones\n        $participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n\n        $participantes->each(function ($participante) use ($id) {\n            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n        });\n\n        return view('procesos.paginas.proceso-compartido-firmada')->with([\n            'proceso'       => $proceso,\n            'participantes' => $participantes,\n            'empresa'       => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(),\n            'firma'         => $request->firma\n        ]);\n    }\n\n    /**\n     * Obtener las pruebas del aplicante.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function obtenerPruebasAplicante(Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->obtenerPruebasAplicante($request)\n        ], 200);\n    }\n\n    /**\n     * Env√≠ar el mensaje de correo electr√≥nico que contiene el link para acceder a de los resultados\n     * de un usuario aplicante en un proceso a todos los destinatarios.\n     *\n     * @param CompartirProcesoRequest $request Contenido de la petici√≥n HTTP.\n     * @return JsonResponse\n     * @author Fahibram C√°rcamo\n     */\n    public function compartirResultadosAplicante(CompartirProcesoRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'tipo'    => 'success',\n            'mensaje' => 'Resultados del proceso compartidos correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->compartirResultadosProcesoAplicante($request);\n            DB::commit();\n        } catch (Exception $error) {\n            $codigo    = 400;\n            $respuesta = [\n                'tipo'    => 'error',\n                'mensaje' => 'Ocurri√≥ un error al compartir los resultados',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Mostrar resultados de un usuario aplicante en un proceso dado con firma de ruta.\n     *\n     * @param int $proceso_id Id del proceso.\n     * @param int $participante_id Id del usuario participante.\n     * @param Request $request Contenido de la petici√≥n HTTP.\n     * @return View\n     * @author Fahibram C√°rcamo\n     * @author Andres Gonzalez\n     */\n    public function showResultadosAplicanteFirmada(int $proceso_id, int $participante_id, Request $request): View { \n        $request->merge(compact('proceso_id', 'participante_id'));\n        $this->acceso_ruta_servicio->notificarAdministradorEmpresaProcesoAccesoRuta($request);\n\n        return view(\n            'procesos.paginas.resultados-aplicante-firmada',\n            [\n                'resultados'     => $this->usuario_servicio->obtenerDetallesParticipanteProceso(new Request(compact('proceso_id', 'participante_id'))),\n                'indice_talento' => $this->repositorio->obtenerIndiceTalento($proceso_id, $participante_id),\n                'firma'          => $request->firma\n            ]\n        );\n    }\n\n    /**\n     * Obtener √≠ndice de talento.\n     *\n     * @param int $id ID del proceso.\n     * @param int $aplicante_id ID del aplicante.\n     * @return JsonResponse\n     * @author Daniel Beltr√°n\n     */\n    public function obtenerIndiceTalento(int $id, int $aplicante_id): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->repositorio->obtenerIndiceTalento($id, $aplicante_id)\n        ]);\n    }\n\n    /**\n     * Exportar resultados detallados de un proceso a Excel.\n     *\n     * Genera un archivo Excel con m√∫ltiples hojas que incluyen:\n     * - Hoja de resumen de participantes con estad√≠sticas generales\n     * - Una hoja por cada prueba del proceso con resultados detallados\n     * - Datos personales, puntajes de factores/dimensiones y conceptos de recomendaci√≥n\n     *\n     * @param Request $request Petici√≥n con el proceso_id.\n     * @return BinaryFileResponse|JsonResponse Descarga del archivo Excel o error JSON.\n     * @author Sergio Vargas\n     * @author Fahibram C√°rcamo\n     */\n    public function exportarReporteResultadosExcel(Request $request): BinaryFileResponse|JsonResponse {\n        try {\n            $id      = $request->input('proceso_id');\n            $proceso = $this->repositorio->getUno($id);\n\n            if (!$proceso) {\n                return response()->json(['message' => 'Proceso no encontrado'], 404);\n            }\n\n            $usuarios_ids = $request->input('ids_usuarios', []);\n\n            $resumen_participantes = $this->servicio->generarResumenParticipantes($id, $usuarios_ids);\n            $resultados            = $this->servicio->resultadosProcesoAgendas($id, $usuarios_ids);\n\n            $nombre_archivo = 'Descarga_detallada_resultados_seleccion_' . $proceso->id . '_' . date('Y-m-d_H-i-s') . '.xlsx';\n\n            return Excel::download(\n                new ResultadosProcesoMultiSheetExport($resultados, $resumen_participantes),\n                $nombre_archivo\n            );\n        } catch (Exception $e) {\n            return response()->json(['message' => 'Error al generar el archivo Excel: ' . $e->getMessage()], 500);\n        }\n    }\n\n    /**\n     * Obtener un top 3 de los mejores candidatos.\n     *\n     * @param GenerarMejoresCandidatosIARequest $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Andres Gonzalez\n     */\n    public function mejoresCandidatosIA(GenerarMejoresCandidatosIARequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'success' => true,\n            'message' => 'Generados los mejores candidatos con IA'\n        ];\n\n        try {\n            $respuesta['data'] = $this->servicio->generarMejoresCandidatosIA($request);\n        } catch (Exception $error) {\n            $codigo    = 400;\n            $respuesta = [\n                'success' => false,\n                'message' => 'Error al generar los mejores candidatos con IA: ' . $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Validar y actualizar agendas expiradas de un proceso.\n     *\n     * @param int $id ID del proceso.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     * @author Andres Gonzalez\n     */\n    public function validarAgendasExpiradas(int $id): JsonResponse {\n        $proceso = $this->repositorio->getUno($id);\n\n        // Verificar que el proceso pertenece a la empresa del usuario autenticado\n        if (!$proceso || $proceso->empresa_id !== $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario()->id) {\n            return new JsonResponse([\n                'success' => false,\n                'message' => 'Proceso no encontrado o no autorizado'\n            ], 404);\n        }\n\n        try {\n            $agendas_actualizadas = $this->agenda_servicio->validarAgendasExpiradasPorProceso($id);\n\n            return new JsonResponse([\n                'success' => true,\n                'message' => 'Validaci√≥n completada',\n                'data'    => [\n                    'agendas_actualizadas' => $agendas_actualizadas\n                ]\n            ], 200);\n        } catch (Exception $error) {\n            return new JsonResponse([\n                'success' => false,\n                'message' => 'Error al validar agendas expiradas: ' . $error->getMessage()\n            ], 500);\n        }\n    }\n\n    /**\n     * Descargar archivo gu√≠a para agendamiento masivo de participantes.\n     *\n     * @return BinaryFileResponse|JsonResponse\n     * @author Fahibram C√°rcamo\n     */\n    public function descargarGuiaAgendamientoMasivo(): BinaryFileResponse|JsonResponse {\n        try {\n            $ruta_archivo = storage_path(self::RUTA_ARCHIVO_GUIA_PARA_CARGA_MASIVA_PARTICIPANTES);\n\n            if (!file_exists($ruta_archivo)) {\n                throw new Exception('Archivo no encontrado');\n            }\n\n            return response()->download(\n                $ruta_archivo,\n                'archivo_guia_para_carga_masiva_de_participantes.xlsx',\n                ['Content-Type' => 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet']\n            );\n        } catch (Exception $excepcion) {\n            return new JsonResponse(\n                [\n                    'message' => 'Ocurri√≥ un error',\n                    'errors'  => $excepcion->getMessage()\n                ],\n                400\n            );\n        }\n    }\n\n    /**\n     * Archivar o desarchivar un proceso.\n     *\n     * @param Request $request Contenido de la petici√≥n.\n     * @return JsonResponse\n     * @author Andres Morales\n     */\n    public function archivarProceso(Request $request): JsonResponse {\n        $codigo = 200;\n\n        try {\n            DB::beginTransaction();\n            $respuesta = $this->servicio->archivarProceso($request->id);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurri√≥ un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n}\n","structuredPatch":[{"oldStart":717,"oldLines":15,"newStart":717,"newLines":9,"lines":["      * @author Andres Gonzalez","      */","     public function showFirmada(int $id, Request $request): View {","-        $proceso = $this->repositorio->getUno($id);","+        $proceso       = $this->repositorio->getUno($id);","+        $participantes = $this->servicio->obtenerParticipantesConIndiceTalento($id);"," ","-        // Cargar participantes del proceso con sus relaciones","-        $participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));","-","-        $participantes->each(function ($participante) use ($id) {","-            $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);","-        });","-","         return view('procesos.paginas.proceso-compartido-firmada')->with([","             'proceso'       => $proceso,","             'participantes' => $participantes,"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"de7b06f3-9a2c-4a0b-b260-9a2ece00c6e7"}
{"parentUuid":"6738fbee-38db-412c-a2a2-4c12a97d7419","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01YaMjnKBTLynVeTctP6mcan","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Excelente, he completado la refactorizaci√≥n. Ahora el controlador est√° limpio y delega la l√≥gica de negocio al servicio. \n\nD√©jame verificar si hay alg√∫n otro lugar donde se use la misma l√≥gica que tambi√©n deber√≠a ser refactorizada. Voy a revisar el m√©todo `showResultadosAplicanteFirmada` en la l√≠nea 791 para ver si tambi√©n necesita refactorizaci√≥n similar.\n\nMirando el c√≥digo:\n```php\npublic function showResultadosAplicanteFirmada(int $proceso_id, int $participante_id, Request $request): View { \n    $request->merge(compact('proceso_id', 'participante_id'));\n    $this->acceso_ruta_servicio->notificarAdministradorEmpresaProcesoAccesoRuta($request);\n\n    return view(\n        'procesos.paginas.resultados-aplicante-firmada',\n        [\n            'resultados'     => $this->usuario_servicio->obtenerDetallesParticipanteProceso(new Request(compact('proceso_id', 'participante_id'))),\n            'indice_talento' => $this->repositorio->obtenerIndiceTalento($proceso_id, $participante_id),\n            'firma'          => $request->firma\n        ]\n    );\n}\n```\n\nEste m√©todo tambi√©n tiene l√≥gica de negocio (obtiene detalles del participante y el √≠ndice de talento), pero ya est√° usando m√©todos de servicio (`usuario_servicio->obtenerDetallesParticipanteProceso`), as√≠ que est√° bien. La llamada al repositorio para obtener el √≠ndice de talento podr√≠a moverse al servicio tambi√©n, pero como es solo una l√≠nea y no hay m√°s l√≥gica de negocio, puede quedar as√≠.\n\nResumen de lo que hice:\n\n\nHe extra√≠do la l√≥gica de carga de participantes con sus √≠ndices de talento en un nuevo m√©todo `obtenerParticipantesConIndiceTalento` dentro de `ProcesoService`, y actualic√© el controlador para usarlo. Ahora la arquitectura sigue correctamente la separaci√≥n entre capas: el controlador solo orquesta, el servicio contiene la l√≥gica de negocio, y el repositorio accede a los datos.","signature":"EtoPCkYICxgCKkBCKRiPg6AptXfzNKWYg9FBzfwCt0t8OM7F64MIp2utowJqiR9wjTTeBIP9332Envn3ojm4vMorXyceTXoi1ta5EgxFk0/MtgE1HDIJ3HMaDKcyylBazIQgngrFxCIwQJRPi4J6pykYuLXvkwONIWBycoJ18ihgmJAxSEv4ouMFaR4DPoRu+2GecRYRCJi7KsEObR7dzE/6VzH8qoKeLL0FvZJUs40uX7uS7wahJdT4drrMW0/Fc2KtuEdTy26kTkGAjwiu2L29/nweED0V7L7e0mjXIeTF6DFHupBp4tXMsEjFVgjZHtuQ6Cy8MpvW1ZUr2V/k+GBYFJ82R+KxnY2Wi5KTBLeXtmm2dE+//AC7as5CEAUMbzzZkVYus8bx+BSRpfZNTEIN8gwhTtlXWYB4jpK59yAKLAwBeiCn9WbCjSiCpyCcPi9MHo28ZFTp+BcVkhawRfhbhblXNs9N1jBTgfVQTaKyTalNC7odAXAjFskHXO2stuMWS5ls27zRxvdTxuY8x0I8GszIt9NRHvXBWYLJvhV/ewLlmEXsEvUUhIA+IXTXsSqJ4wEBMjiIMv+TO4F3X04xamePLxWzqx5Oe66o9cd73QVHB2EnZmY44PU4qW5xykDycijH8kpItA9EaqswAWGpmZ0NoLsIu+LDneFpskQb/FTXD2WETbLQ/Ii1Nc2xLgtnhWogtBu8N/JZRyBnZb5yjEmXaXpUw9GjCFjhCyZZ0OxTSeiijmd+smxKmJmvHXsfl0hHNbTKTpyE12mACVhxHO131NQy5iJfNjBK1odwH9AKAcCHEZrS5vs9j8aTtiKAJPck9K6T4bTj+S3oTBCDiDqG4yAwfDG7YGOFUIU7+zndxBXwz/0aKKWxRasmYmcVBlT2vCrkzuWEKSd95duAR61ek/sxkarmJyj6316a9RevrTRpzCUgXkShFp7lKZIzo7FyAHy2zGuaAHDwm1E7EvhxhnxD1JO5ClrwQDnftShFAQpeICLqe/eCBrE10hHderHV7WaKYE+vwjUL5AzGPdji+sfIJda54AHPYVnwmSSlOwSF/JE0jIu+WEG6rdzY+p062Md3Ax0tbBDgJEAJazUELh5y5OHtng8E6MUi6rZmvW5CxIR9EeYOGyTeYe/pIT2te19LO+fhtK9K76PzyNzx2wfqQQ9q/h7W77/BZ6nM1XLk5Ch5qPU+nQf1cQLHp/IEPCBIIRhQRY1vn2mnHl7051KfhOiY9pE/CGe9aYIjPwqqjkiSsNiMM9Vb2uH8xWIB1h9aEcCVPAU4s+oMoGvcdwGoISlUcohedJaiJcaGIxkQVo+j5wLiJkiYJGlDCiELrcm7Ch4kf9y556NEy/xsjdajg43Jw5Fs4lgbR7K2x4np6Ubx1VFYoTR6aPvZP11IPOEzc//Xfs+EjHhZrwHE2YjrK6/rvW//v5/H4k6Wlf4m5xOrJlg7KyNhqfjXth4QKqen+lhsu2RmcKpt74w2IJyhfc4PgSAyXR35I0Ntk4msThcJFZwSKc3iZHTE/XmxPZgpXQRvB18PsHu6NLbsLRJq0w6kd5wynUmIFt+toQVu8NCTIj7f5Nir8MD5k/GUPqhrBnJZs3OKv70RshKWnnQu4IhUy2dtu1rvjhsP9JI6FsZHNYAV4CaPDI6kTJzKziuwabvPr2Vo8JLzgf6/HbedEFT5DH1ksCfhH4GAAUIulVUv011TNayje1WqwRNJwQHdjwnfBJQigvsg6ToFsommTWBsds7YoyX3KvUpg43E4exbgCmTcrWXqMpI7yEXYzhRMA49qq7r+IKFqlQLcuSTkiVLeR5l3pgQK/GN5PMpxpTrIFjHR3FUN5FS5fXixn9GY48aA2jxLbePeDckNuPHR+tjD0vUjBIvXxvolg0rSBV/yrN6MmS31U/Tlia+yNM8r8ORuC6UEUj/KTzKrfIVg8gBsA9Zu7kvU/KMVe3cqrQxtqcf969H4x7j/Zv2l1msuFYN75zhIdrPzKqhnFJ/Cce27bo3JNQmGEeiGcytN3jinK4lGvOQUE3p37DqpPkoGZdKz+rwXoOXQ/ufrNuuIqTRBnWthrxGh9mUjQLZy7P3wgC4Uc1ZIY2BxCBOMNPgOo2JF3Pslve/CcBWwaoQRguvDK4V/rWoefjZikXxdw29yC9NzQ8a6jKwFQ3vEEvcqH6bwIRyjMQXpETRWz6svY/7ti3F1xynx7Ck/RJC2dYkw6ZXaMyw+2sFOncwMGLPAa52cVYR65rpu5R3H1/quTxcZ9EIEsDyasOs2eYjiHtrywLFd8sxgUk1GgI17ttoCnHhAKa3hn2rStAvciWXkgbJyqGMnQG7htfnm+p0Fmy8aDXoXfCd1Q0mMEQ/R9tEg4m+Byg3iNhekGk18yIGZNsqSQnq0JSFgRk8712sUij6DcmlWOnw3JcRgv7gORHBapdTe+fsNwqpiFpFreFdNgl2k3wPdlBp80p93OL+sTh5D4/ROWb1kGvD9KK9z885dZH8MTDEp52jXsscBmW+1QR0FXSyma8v+ezGCb+0r/5L8M48XGPxVDwSglrQI1+V8MttWHt6Av8CBvXzx2dGqDZw6SON8Dgrp0ewszWT5kJ/VAcvq2RhHWGvn55T8no+gzZCm4LCD+CE34pHiU5wkGOBADNLzJGRInmVqjinEFL4APPLGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":879,"cache_read_input_tokens":67631,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":879},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLZmzMAEbqq1qjjEk4U","type":"assistant","uuid":"96f0cc31-4c60-4c2b-b956-fc8ac220551e","timestamp":"2026-02-06T19:06:13.529Z"}
{"parentUuid":"96f0cc31-4c60-4c2b-b956-fc8ac220551e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01YaMjnKBTLynVeTctP6mcan","type":"message","role":"assistant","content":[{"type":"text","text":"Perfecto! He completado la refactorizaci√≥n. Aqu√≠ est√° el resumen de los cambios:\n\n## ‚úÖ Refactorizaci√≥n Completada\n\n### üìÅ **Archivo: ProcesoService.php**\n**Nuevo m√©todo agregado:**\n```php\n/**\n * Obtener participantes del proceso con sus √≠ndices de talento calculados.\n *\n * @param int $proceso_id ID del proceso.\n * @return Collection\n * @author Andres Gonzalez\n */\npublic function obtenerParticipantesConIndiceTalento(int $proceso_id): Collection {\n    // Cargar participantes del proceso con sus relaciones\n    $participantes = $this->usuario_repositorio->obtenerPorProceso($proceso_id, new Request(['incluir_procesos_pruebas' => true]));\n\n    // Calcular el √≠ndice de talento para cada participante\n    $participantes->each(function ($participante) use ($proceso_id) {\n        $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($proceso_id, $participante->id);\n    });\n\n    return $participantes;\n}\n```\n\n### üìÅ **Archivo: ProcesoController.php**\n**M√©todo `showFirmada` refactorizado:**\n- **Antes:** 8 l√≠neas de c√≥digo con l√≥gica de negocio\n- **Despu√©s:** 3 l√≠neas delegando al servicio\n\n```php\npublic function showFirmada(int $id, Request $request): View {\n    $proceso       = $this->repositorio->getUno($id);\n    $participantes = $this->servicio->obtenerParticipantesConIndiceTalento($id);\n\n    return view('procesos.paginas.proceso-compartido-firmada')->with([\n        'proceso'       => $proceso,\n        'participantes' => $participantes,\n        'empresa'       => $this->empresa_usuario_repositorio->obtenerEmpresaActualUsuario(),\n        'firma'         => $request->firma\n    ]);\n}\n```\n\n## üéØ Beneficios de la Refactorizaci√≥n\n\n1. ‚úÖ **Cumple con la arquitectura obligatoria** Controlador-Servicio-Repositorio\n2. ‚úÖ **L√≥gica de negocio centralizada** en el servicio (reutilizable)\n3. ‚úÖ **Controlador m√°s limpio** y enfocado solo en manejar la petici√≥n HTTP\n4. ‚úÖ **C√≥digo m√°s mantenible** y f√°cil de probar\n5. ‚úÖ **Separaci√≥n de responsabilidades** clara"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":879,"cache_read_input_tokens":67631,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":879},"output_tokens":2,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLZmzMAEbqq1qjjEk4U","type":"assistant","uuid":"0932de5d-67e3-4421-858d-c24a908943f5","timestamp":"2026-02-06T19:06:19.262Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-02-06T19:06:19.309Z","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d"}
{"type":"file-history-snapshot","messageId":"5af9a8f7-4a1d-4a73-af54-ea5aa3456f82","snapshot":{"messageId":"5af9a8f7-4a1d-4a73-af54-ea5aa3456f82","trackedFileBackups":{"app\\Http\\Services\\Procesos\\ProcesoService.php":{"backupFileName":"69142ad6b3725dc8@v2","version":2,"backupTime":"2026-02-06T19:06:19.804Z"},"app\\Http\\Controllers\\Procesos\\ProcesoController.php":{"backupFileName":"8f1fc671d57c4c6c@v2","version":2,"backupTime":"2026-02-06T19:06:19.815Z"}},"timestamp":"2026-02-06T19:06:19.785Z"},"isSnapshotUpdate":false}
{"parentUuid":"0932de5d-67e3-4421-858d-c24a908943f5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01Sff8uDHuf6XrUvzGHhvRG7","parentToolUseID":"toolu_01Sff8uDHuf6XrUvzGHhvRG7","uuid":"9c826083-266b-4ed3-89d6-562e63ddf053","timestamp":"2026-02-06T19:03:01.239Z"}
{"parentUuid":"9c826083-266b-4ed3-89d6-562e63ddf053","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01Sff8uDHuf6XrUvzGHhvRG7","toolUseID":"toolu_01Sff8uDHuf6XrUvzGHhvRG7","timestamp":"2026-02-06T19:03:02.706Z","uuid":"51bc0531-8438-4453-b017-23886eb1d8cf"}
{"parentUuid":"51bc0531-8438-4453-b017-23886eb1d8cf","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_013Xue9soMnfC7BKzfCsvbev","parentToolUseID":"toolu_013Xue9soMnfC7BKzfCsvbev","uuid":"44064b3f-db56-4d73-ad6d-ba39144adf04","timestamp":"2026-02-06T19:03:11.752Z"}
{"parentUuid":"44064b3f-db56-4d73-ad6d-ba39144adf04","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_013Xue9soMnfC7BKzfCsvbev","toolUseID":"toolu_013Xue9soMnfC7BKzfCsvbev","timestamp":"2026-02-06T19:03:13.153Z","uuid":"d7c9c7f1-dc62-46e9-b56a-af5a4cbd4203"}
{"parentUuid":"d7c9c7f1-dc62-46e9-b56a-af5a4cbd4203","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01TukBp2N3NknK9vVGpjwAiV","parentToolUseID":"toolu_01TukBp2N3NknK9vVGpjwAiV","uuid":"3051b6c9-9a04-4358-9a83-b54b8e837c5d","timestamp":"2026-02-06T19:03:36.308Z"}
{"parentUuid":"3051b6c9-9a04-4358-9a83-b54b8e837c5d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01TukBp2N3NknK9vVGpjwAiV","parentToolUseID":"toolu_01TukBp2N3NknK9vVGpjwAiV","uuid":"3e9c8aae-488d-4433-b4e7-b7f71e107e6c","timestamp":"2026-02-06T19:03:36.309Z"}
{"parentUuid":"3e9c8aae-488d-4433-b4e7-b7f71e107e6c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","parentToolUseID":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","uuid":"7e4ec670-5d5a-467b-a932-d883abed18b4","timestamp":"2026-02-06T19:04:17.307Z"}
{"parentUuid":"7e4ec670-5d5a-467b-a932-d883abed18b4","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","parentToolUseID":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","uuid":"d6477113-2726-4cd0-9f6c-107b4dd634b1","timestamp":"2026-02-06T19:04:17.307Z"}
{"parentUuid":"d6477113-2726-4cd0-9f6c-107b4dd634b1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","toolUseID":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","timestamp":"2026-02-06T19:05:30.147Z","uuid":"2b136bc4-ffdb-4cf8-9851-6aa91a5f0221"}
{"parentUuid":"2b136bc4-ffdb-4cf8-9851-6aa91a5f0221","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","toolUseID":"toolu_0171hZijJ6AB7ZDQDQf7zsAq","timestamp":"2026-02-06T19:05:30.148Z","uuid":"ecadb514-0fc7-4528-b708-90ecf551d493"}
{"parentUuid":"ecadb514-0fc7-4528-b708-90ecf551d493","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","parentToolUseID":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","uuid":"dafdfce8-3690-4d01-b1ee-66352f626655","timestamp":"2026-02-06T19:05:42.298Z"}
{"parentUuid":"dafdfce8-3690-4d01-b1ee-66352f626655","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","parentToolUseID":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","uuid":"36261345-319e-46c2-9dfa-5f14c5885c2a","timestamp":"2026-02-06T19:05:42.298Z"}
{"parentUuid":"36261345-319e-46c2-9dfa-5f14c5885c2a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","toolUseID":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","timestamp":"2026-02-06T19:05:59.202Z","uuid":"55565564-cfab-45eb-aea2-ff76bfec4a01"}
{"parentUuid":"55565564-cfab-45eb-aea2-ff76bfec4a01","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","toolUseID":"toolu_01Qttj8ccYXKQoE3UyMC6zTB","timestamp":"2026-02-06T19:05:59.202Z","uuid":"b640f4a4-cbac-4666-a48f-648ed9762e97"}
{"parentUuid":"b640f4a4-cbac-4666-a48f-648ed9762e97","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Procesos\\ProcesoController.php in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"listo ese juste no afecta su funcionamiento?"}]},"uuid":"5af9a8f7-4a1d-4a73-af54-ea5aa3456f82","timestamp":"2026-02-06T19:06:19.782Z","permissionMode":"default"}
{"parentUuid":"5af9a8f7-4a1d-4a73-af54-ea5aa3456f82","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LjjHj9bbzTXKDnbeuNjoXB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"El usuario me pregunta si ese ajuste no afecta el funcionamiento. Quiere confirmar que la refactorizaci√≥n que hicimos no rompe nada.\n\nD√©jame analizar:\n\n1. **Antes**: El controlador obten√≠a los participantes directamente del repositorio y luego iteraba sobre ellos para agregar el √≠ndice de talento\n2. **Despu√©s**: El controlador llama a un m√©todo del servicio que hace exactamente lo mismo\n\nLa l√≥gica es id√©ntica, solo se movi√≥ de ubicaci√≥n. El resultado deber√≠a ser el mismo. Los datos que se pasan a la vista son exactamente los mismos:\n- `$proceso` - sigue siendo el mismo\n- `$participantes` - es la misma colecci√≥n con el mismo contenido (incluyendo `indice_talento`)\n- `$empresa` - sigue siendo el mismo\n- `$firma` - sigue siendo el mismo\n\nNo hay cambio en la funcionalidad, solo en la organizaci√≥n del c√≥digo.","signature":"Et0HCkYICxgCKkBc0KYcLi/s3T+wEU1tKrulGgb7Zmm3prykBV3SKwlaSH5N3Pj64+9BvzX0FedLAbNi0IcITDMH5XJyxKm/PL1mEgwfFGL/nkDMpLxXngEaDHnO16P8dSOGRcdN8yIwmV2jezxqaVKcwuHWvMTs6gTF/tr6/mRukM6/U8Egqh288RqO2eHaK/Me8zS0LKAnKsQG9NS4BGpL82kXKaczbcqBwZOsR2Uhnygv6Phfv2jfQCKOFA4VsegBmO6BDasqJXwy78LnizKVxRYhoRyodBwoJdyhcfIJJRjQwbHmDXNyncHm4pFg0knK1Nog+bFdi8VK3nWySzJwa0i6DXEtIi4tTZ2sOTY4sukIePJ/mJD3y8hTZLPoS3XeKL110M+4FafOmLZvhtB7aHBR7/qUaHcTdIXJGDHQ+SsR2NDBxOIdroB1SYbdCJmCxDnZ1p8eCikmUVKHsl5+aOryEm1u7XgbLsQPCwlJzqr+G9TmTZQCZhjqTt/C3anwSCpfOitDUcPDvj2qjevrjp1mnMVbiz5LXewe+RxVgubL8jzcuC0M2rUqxLydxE8spjtVlgrfcjrVNSfkhPqO7aXz8XJxdXqTBZX+EWICC7W5HAocgeFedXOpwA7R/ScFgf8hG36Y9+0A0bEfcrTFeKka2bJg19adEPhI7K97OEjOrbdQ4qRcipWU0ObUTT9s3kVlgt6a2m5Qr52XU0LGTF4NFkKrn8y81ELdsbtt23N1k45VKU5m68uf/nV25Dth5MXmSAkzOrTjIyK4GMWbyoZq8KzarxXR5YtVDcRpPiXXoYr4WXUDJ67UKfry8LtnCYVzeHeurksS63iAjfRBp2lCNx6Kdr9QsP903ybSmdCbN7UuJFxHWYLIcDurtL2tR6PPZ1UAaIpIaWaYkTOgimZr5J0rTcgUklYFdXVElupsXrJ3Ix74OkByzY9N1QzTiRwfXHRPgjls71maq4HSSlbxkk5C8K9o8LQj5yEix2WlIIGRhLuJU3FGpaIEWfAgYi3+u1tHOKt2fE9nuGWSFt2xuMUnGwsWVJOd5wwicrDDgJoD7+arXJVmAgmpN54yQtOrweYu31Mafhn/IlfQin47MaySlQV1jvaY8i7Tf4Iuh2V1ciSNhtxY5VmNH5NMASHbuhcD78wEG9/ThnFvs/RY0R+/PEAJhM5wR3oDD5HA3Qu4OzOW/fpM6tiH+9Yg7pZ6t+eCIfPR4YgTQf4qsELUDvAMotSuC6TEbllrSlOGuXeI5WBv2qBc4LtWBS5HCvEhf/w26IEuFP0VB34dbwtMTJBKmO9aP/oigQ0YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2458,"cache_read_input_tokens":68510,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2458},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLbBRXTQWe1eSEXrzJY","type":"assistant","uuid":"a276267d-fa6f-412e-90fe-53d1cf9bb4c1","timestamp":"2026-02-06T19:06:26.420Z"}
{"parentUuid":"a276267d-fa6f-412e-90fe-53d1cf9bb4c1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"288dfe07-2546-4768-ab18-9412915b0a2d","version":"2.1.31","gitBranch":"D26-489","slug":"purring-kindling-hamming","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01LjjHj9bbzTXKDnbeuNjoXB","type":"message","role":"assistant","content":[{"type":"text","text":"¬°No, el ajuste **NO afecta el funcionamiento**! Es una refactorizaci√≥n segura. Te explico por qu√©:\n\n## üîç An√°lisis del Cambio\n\n### **Antes:**\n```php\n// EN EL CONTROLADOR\n$participantes = $this->usuario_repositorio->obtenerPorProceso($id, new Request(['incluir_procesos_pruebas' => true]));\n\n$participantes->each(function ($participante) use ($id) {\n    $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($id, $participante->id);\n});\n```\n\n### **Despu√©s:**\n```php\n// EN EL CONTROLADOR\n$participantes = $this->servicio->obtenerParticipantesConIndiceTalento($id);\n\n// EN EL SERVICIO (ProcesoService)\npublic function obtenerParticipantesConIndiceTalento(int $proceso_id): Collection {\n    $participantes = $this->usuario_repositorio->obtenerPorProceso($proceso_id, new Request(['incluir_procesos_pruebas' => true]));\n    \n    $participantes->each(function ($participante) use ($proceso_id) {\n        $participante->indice_talento = $this->repositorio->obtenerIndiceTalento($proceso_id, $participante->id);\n    });\n    \n    return $participantes;\n}\n```\n\n## ‚úÖ Por qu√© es Seguro\n\n1. **Misma l√≥gica exacta** - El c√≥digo hace exactamente lo mismo, solo cambi√≥ de ubicaci√≥n\n2. **Mismos par√°metros** - Se pasan los mismos datos (`$id` / `$proceso_id`)\n3. **Mismo resultado** - Devuelve la misma colecci√≥n de participantes con `indice_talento`\n4. **Sin cambios en la vista** - La vista recibe exactamente los mismos datos\n\n## üéØ Ventajas Adicionales\n\n- **Reutilizable**: Ahora si otro m√©todo necesita participantes con √≠ndice de talento, puede usar el servicio\n- **Testeable**: M√°s f√°cil hacer pruebas unitarias del servicio\n- **Mantenible**: Si hay que cambiar la l√≥gica, solo se cambia en un lugar\n\n**Conclusi√≥n:** El funcionamiento es id√©ntico, solo mejor√≥ la arquitectura del c√≥digo. üëç"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":2458,"cache_read_input_tokens":68510,"cache_creation":{"ephemeral_5m_input_tokens":0,"ephemeral_1h_input_tokens":2458},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXsLbBRXTQWe1eSEXrzJY","type":"assistant","uuid":"0f687e41-383a-446a-b912-4b25037fbfb7","timestamp":"2026-02-06T19:06:34.166Z"}

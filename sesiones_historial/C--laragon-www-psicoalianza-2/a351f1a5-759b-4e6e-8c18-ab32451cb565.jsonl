{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-20T17:31:26.286Z","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565"}
{"type":"file-history-snapshot","messageId":"71fc1598-bf71-4ad1-aa09-e8063ee06149","snapshot":{"messageId":"71fc1598-bf71-4ad1-aa09-e8063ee06149","trackedFileBackups":{},"timestamp":"2026-01-20T17:31:26.355Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"hola anliza este archivo"}]},"uuid":"71fc1598-bf71-4ad1-aa09-e8063ee06149","timestamp":"2026-01-20T17:31:26.352Z"}
{"parentUuid":"71fc1598-bf71-4ad1-aa09-e8063ee06149","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01116SayuZy41nngbwj8X3Kv","type":"message","role":"assistant","content":[{"type":"text","text":"Hola, voy a analizar el archivo que tienes abierto."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":25074,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25074,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK2bvsE2APGjD1ByBUH5","type":"assistant","uuid":"93d85ffa-581b-4fbc-a8df-75a9b71a3a79","timestamp":"2026-01-20T17:31:29.570Z"}
{"parentUuid":"93d85ffa-581b-4fbc-a8df-75a9b71a3a79","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","message":{"model":"claude-opus-4-5-20251101","id":"msg_01116SayuZy41nngbwj8X3Kv","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018VWKfr1oBZpFY9XDTjry7W","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":25074,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":25074,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK2bvsE2APGjD1ByBUH5","type":"assistant","uuid":"8c253f6d-330e-48e6-9bc4-66ab0e2eea16","timestamp":"2026-01-20T17:31:30.117Z"}
{"parentUuid":"8c253f6d-330e-48e6-9bc4-66ab0e2eea16","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018VWKfr1oBZpFY9XDTjry7W","type":"tool_result","content":"     1→table = null;\n     2→planes = [];\n     3→planes_creditos = [];\n     4→pruebas = [];\n     5→modificado = false;\n     6→funcionalidades_predefinidos = [];\n     7→plan_creditos_seleccionado = null;\n     8→\n     9→/**\n    10→ * Establecer el tipo de prueba en el selector del formulario.\n    11→ *\n    12→ * @param {number} tipo_prueba_id ID del tipo de prueba.\n    13→ * @returns {void}\n    14→ * @author José Manuel Jiménez\n    15→ * @author Daniel Beltrán\n    16→ * @author Andres Morales\n    17→ * @author Jair Carvajal\n    18→ */\n    19→function seleccionarTipoPrueba(tipo_prueba_id) {\n    20→    $('#contenedor-plan').empty();\n    21→    $('#seccion-pruebas').addClass('d-none');\n    22→    $('#plan_id').val('');\n    23→    pruebas = [];\n    24→\n    25→    // Convertir tipo_prueba_id a array si no lo es\n    26→    let tipos_prueba = Array.isArray(tipo_prueba_id) ? tipo_prueba_id : [tipo_prueba_id];\n    27→\n    28→    // Crear los botones según los tipos de prueba seleccionados\n    29→    let botones_html = '<div class=\"card-body text-center\">';\n    30→\n    31→    tipos_prueba.forEach(function(tipo_id) {\n    32→        let texto_boton = 'Elegir plan';\n    33→        let clase_boton = 'btn-outline-primary';\n    34→\n    35→        if (tipo_id == 1) {\n    36→            texto_boton = 'Elegir Plan de Selección';\n    37→            clase_boton = 'btn-outline-primary';\n    38→        } else if (tipo_id == 2) {\n    39→            texto_boton = 'Elegir Plan de Créditos IA';\n    40→            clase_boton = 'btn-outline-info';\n    41→        }\n    42→\n    43→        botones_html += `\n    44→            <button type=\"button\" id=\"elegir-plan-${tipo_id}\" class=\"btn ${clase_boton} mx-1 my-1\" disabled onclick=\"modalElegirPlan(${tipo_id});\">\n    45→                ${texto_boton}\n    46→            </button>\n    47→        `;\n    48→    });\n    49→\n    50→    botones_html += '</div>';\n    51→    $('#contenedor-plan').append(botones_html);\n    52→\n    53→    $('#tipo_prueba_id').val(tipo_prueba_id).trigger('select2');\n    54→\n    55→    if (tipo_prueba_id && (Array.isArray(tipo_prueba_id) ? tipo_prueba_id.length > 0 : tipo_prueba_id)) {\n    56→        // Habilitar todos los botones creados\n    57→        tipos_prueba.forEach(function(tipo_id) {\n    58→            $(`#elegir-plan-${tipo_id}`).prop('disabled', false);\n    59→        });\n    60→\n    61→        $.ajax({\n    62→            type: 'GET',\n    63→            url : `/pruebas-listado`,\n    64→            data: {\n    65→                tipo_prueba_id: tipo_prueba_id,\n    66→                activo: 1\n    67→            }\n    68→        }).then((respuesta) => {\n    69→            limpiarAdicional();\n    70→            $('#contenedor-pruebas').empty();\n    71→            pruebas = respuesta.data;\n    72→            for (let i = 0; i < pruebas.length; i++) {\n    73→                $('#contenedor-pruebas').append(`\n    74→                    <div class=\"col-12 col-md-6\">\n    75→                        <div class=\"d-flex align-items-center\">\n    76→                            <div class=\"check-container my-1 me-1\">\n    77→                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n    78→                            </div>\n    79→                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n    80→                        </div>\n    81→                    </div>\n    82→                `);\n    83→            }\n    84→\n    85→            if (opcion == 'facturar' || opcion == 'editar') {\n    86→                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n    87→                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n    88→                }\n    89→                $('#seccion-pruebas').removeClass('d-none');\n    90→                mostrarPlanSeleccionado();\n    91→            }\n    92→\n    93→            if (opcion == 'editar') {\n    94→                $('#tipo_prueba_id').prop('disabled', true);\n    95→            }\n    96→        }).catch((error) => {\n    97→            mostrarToast('danger', 'Ocurrió un error');\n    98→        });\n    99→    } else {\n   100→        // Deshabilitar todos los botones si no hay tipo de prueba\n   101→        tipos_prueba.forEach(function(tipo_id) {\n   102→            $(`#elegir-plan-${tipo_id}`).prop('disabled', true);\n   103→        });\n   104→    }\n   105→}\n   106→\n   107→/**\n   108→ * Establecer el tipo de prueba en el selector del formulario.\n   109→ *\n   110→ * @param {number} tipo_prueba_id ID del tipo de prueba.\n   111→ * @returns {void}\n   112→ * @author Jair Carvajal\n   113→ */\n   114→function seleccionarTipoPruebaMultiple() {\n   115→    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n   116→\n   117→    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n   118→        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n   119→    });\n   120→\n   121→    if (tipos_prueba.length === 0) {\n   122→        // Si no hay tipos seleccionados, limpiar todo\n   123→        $('#contenedor-plan').empty();\n   124→        $('#contenedor-creditos').empty();\n   125→        $('#seccion-pruebas').addClass('d-none');\n   126→        $('#plan_id').val('');\n   127→        $('#plan_credito_id').val('');\n   128→        $('#creditos').val('');\n   129→        plan_seleccionado = null;\n   130→        plan_creditos_seleccionado = null;\n   131→        pruebas = [];\n   132→        return;\n   133→    }\n   134→\n   135→    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n   136→    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n   137→\n   138→    // Manejo del plan de selección\n   139→    if (tiene_seleccion) {\n   140→        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n   141→        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n   142→            let seccion_seleccion = `\n   143→                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n   144→                <div class=\"card rounded rounded-3\">\n   145→                    <div class=\"card-body text-center\">\n   146→                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n   147→                            Elegir Plan de Selección\n   148→                        </button>\n   149→                    </div>\n   150→                </div>\n   151→            `;\n   152→            $('#contenedor-plan').html(seccion_seleccion);\n   153→        }\n   154→    } else {\n   155→        // Si se deseleccionó el tipo de selección, limpiar el plan\n   156→        $('#contenedor-plan').empty();\n   157→        plan_seleccionado = null;\n   158→        $('#plan_id').val('');\n   159→    }\n   160→\n   161→    // Manejo del plan de créditos\n   162→    if (tiene_creditos) {\n   163→        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n   164→        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n   165→            let seccion_creditos = `\n   166→                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n   167→                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n   168→                    <div class=\"card rounded rounded-3\">\n   169→                        <div class=\"card-body text-center\">\n   170→                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n   171→                                Elegir Plan de Créditos IA\n   172→                            </button>\n   173→                        </div>\n   174→                    </div>\n   175→                </div>\n   176→            `;\n   177→            $('#contenedor-creditos').html(seccion_creditos);\n   178→        }\n   179→    } else {\n   180→        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n   181→        $('#contenedor-creditos').empty();\n   182→        $('#contenedor-plan-creditos').remove();\n   183→        plan_creditos_seleccionado = null;\n   184→        $('#plan_credito_id').val('');\n   185→        $('#creditos').val('');\n   186→    }\n   187→\n   188→    $.ajax({\n   189→        type: 'GET',\n   190→        url : `/pruebas-listado`,\n   191→        data: {\n   192→            tipo_prueba_id: tipos_prueba,\n   193→            activo: 1\n   194→        }\n   195→    }).then((respuesta) => {\n   196→        limpiarAdicional();\n   197→        $('#contenedor-pruebas').empty();\n   198→        pruebas = respuesta.data;\n   199→        for (let i = 0; i < pruebas.length; i++) {\n   200→            $('#contenedor-pruebas').append(`\n   201→                <div class=\"col-12 col-md-6\">\n   202→                    <div class=\"d-flex align-items-center\">\n   203→                        <div class=\"check-container my-1 me-1\">\n   204→                            <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n   205→                        </div>\n   206→                        <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n   207→                    </div>\n   208→                </div>\n   209→            `);\n   210→        }\n   211→\n   212→        if (opcion == 'facturar' || opcion == 'editar') {\n   213→            for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n   214→                $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n   215→            }\n   216→            $('#seccion-pruebas').removeClass('d-none');\n   217→            mostrarPlanSeleccionado();\n   218→        }\n   219→\n   220→        if (opcion == 'editar') {\n   221→            $('#tipo_prueba_id').prop('disabled', true);\n   222→        }\n   223→    }).catch((error) => {\n   224→        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n   225→    });\n   226→}\n   227→\n   228→/**\n   229→ * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n   230→ *\n   231→ * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n   232→ * @returns {void}\n   233→ * @author José Manuel Jiménez\n   234→ * @author Jair Carvajal\n   235→ */\n   236→function modalElegirPlan(tipo_especifico = null) {\n   237→    let tipo_prueba_para_consulta = tipo_especifico !== null ? tipo_especifico : $('#tipo_prueba_id').val();\n   238→\n   239→    // Si es tipo 2 (Créditos IA), cargar planes de créditos\n   240→    if (tipo_prueba_para_consulta == 2 || tipo_prueba_para_consulta == '2') {\n   241→        $.ajax({\n   242→            type: 'GET',\n   243→            url: '/api/planes-creditos',\n   244→            data: {\n   245→                activo: true\n   246→            }\n   247→        }).then((respuesta) => {\n   248→            planes_creditos = respuesta.data.planes;            \n   249→            mostrarPlanesCreditos();\n   250→        }).catch((error) => {\n   251→            mostrarToast('danger', 'Ocurrió un error');\n   252→        });\n   253→        return;\n   254→    }\n   255→\n   256→    $.ajax({\n   257→        type: 'GET',\n   258→        url : `/planes-listado`,\n   259→        data: {\n   260→            tipo_prueba_id: tipo_prueba_para_consulta\n   261→        }\n   262→    }).then((respuesta) => {\n   263→        planes = respuesta.data;\n   264→        mostrarPlanes(tipo_especifico);\n   265→    }).catch((error) => {\n   266→        mostrarToast('danger', 'Ocurrió un error');\n   267→    });\n   268→}\n   269→\n   270→/**\n   271→ * Mostrar los planes de créditos en el modal.\n   272→ *\n   273→ * @returns {void}\n   274→ * @author Jair Carvajal\n   275→ */\n   276→function mostrarPlanesCreditos() {\n   277→    let filtro_orden = $('#filtro-plan-credito').val();\n   278→    let buscar = $('#buscador-plan-credito').val() || '';\n   279→\n   280→    // Ordenar planes según el filtro\n   281→    let planes_ordenados = [...planes_creditos];\n   282→    if (filtro_orden === 'Mayor') {\n   283→        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n   284→    } else if (filtro_orden === 'Menor') {\n   285→        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n   286→    }\n   287→    if (buscar !== '') {\n   288→        planes_ordenados = planes_ordenados.filter(plan =>\n   289→            plan.nombre.toLowerCase().includes(buscar.toLowerCase())\n   290→        );\n   291→    }\n   292→\n   293→    $('#contenedor-planes-creditos').empty();\n   294→\n   295→    if (planes_ordenados.length === 0) {\n   296→        $('#contenedor-planes-creditos').append(`\n   297→            <div class=\"text-center py-5\">\n   298→                <p class=\"text-muted\">No se encontraron planes</p>\n   299→            </div>\n   300→        `);\n   301→    }\n   302→\n   303→    for (let i = 0; i < planes_ordenados.length; i++) {\n   304→        let plan = planes_ordenados[i];\n   305→        let creditos_disponibles = plan.creditos_disponibles || plan.creditos || 0;\n   306→        let creditos_promedio = plan.creditos_promedio_accion || 0;\n   307→        let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n   308→            ? Math.floor(creditos_disponibles / creditos_promedio)\n   309→            : 0;\n   310→\n   311→        $('#contenedor-planes-creditos').append(`\n   312→            <div class=\"card rounded rounded-3 border-hover pointer mb-3\" onclick=\"elegirPlanCreditos(${i}, ${filtro_orden === 'Mayor' ? 'true' : 'false'});\">\n   313→                <div class=\"row align-items-center m-0 w-100 px-3 py-4\">\n   314→                    <div class=\"col\">\n   315→                        <div class=\"text-headline-6 text-gray-10\">${plan.nombre}</div>\n   316→                    </div>\n   317→                    <div class=\"col-auto\">\n   318→                        ${crearTag({\n   319→                            texto: 'Créditos disponibles: ' + plan.creditos.toLocaleString('es-CO'),\n   320→                            class: 'tag-tonal-yellow',\n   321→                        })}\n   322→                    </div>\n   323→                    <div class=\"col-auto text-primary fw-bold\">\n   324→                        ${crearTag({\n   325→                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n   326→                            class: 'tag-tonal-yellow',\n   327→                        })}\n   328→                    </div>\n   329→                </div>\n   330→            </div>\n   331→        `);\n   332→    }\n   333→\n   334→    if (typeof $.fn.modal !== 'undefined') {\n   335→        $('#modal-planes-creditos').modal('show');\n   336→    }\n   337→\n   338→    $('#buscador-plan-credito').off('input').on('input', function() {\n   339→        mostrarPlanesCreditos();\n   340→    });\n   341→}\n   342→\n   343→/**\n   344→ * Elegir un plan de créditos IA.\n   345→ *\n   346→ * @param {number} indice Índice del plan en el array.\n   347→ * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n   348→ * @returns {void}\n   349→ * @author Jair Carvajal\n   350→ */\n   351→function elegirPlanCreditos(indice, orden_mayor = false) {\n   352→    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n   353→    let planes_ordenados = [...planes_creditos];\n   354→    if (orden_mayor) {\n   355→        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n   356→    } else {\n   357→        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n   358→    }\n   359→\n   360→    plan_creditos_seleccionado = planes_ordenados[indice];\n   361→\n   362→    // Establecer los valores en los campos hidden\n   363→    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n   364→    $('#creditos').val(plan_creditos_seleccionado.creditos);\n   365→\n   366→    mostrarPlanCreditosSeleccionado();\n   367→\n   368→    if (typeof $.fn.modal !== 'undefined') {\n   369→        $('#modal-planes-creditos').modal('hide');\n   370→    }\n   371→}\n   372→\n   373→/**\n   374→ * Mostrar el plan de créditos seleccionado en el contenedor.\n   375→ *\n   376→ * @returns {void}\n   377→ * @author Jair Carvajal\n   378→ */\n   379→function mostrarPlanCreditosSeleccionado() {\n   380→    if (!plan_creditos_seleccionado || !plan_creditos_seleccionado.creditos) {\n   381→        mostrarToast('danger', 'Ocurrió un error'+plan_creditos_seleccionado);\n   382→        return;\n   383→    }\n   384→\n   385→    let creditos_disponibles = plan_creditos_seleccionado.creditos_disponibles || plan_creditos_seleccionado.creditos || 0;\n   386→    let creditos_promedio = plan_creditos_seleccionado.creditos_promedio_accion || 0;\n   387→    let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n   388→        ? Math.floor(creditos_disponibles / creditos_promedio)\n   389→        : 0;\n   390→\n   391→    let seccion_creditos = `\n   392→        <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n   393→            <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n   394→            <div class=\"card rounded rounded-3\">\n   395→                <div class=\"row align-items-center m-0 w-100 px-3 py-4 pointer\" onclick=\"modalElegirPlan(2);\">\n   396→                    <div class=\"col\">\n   397→                        <div class=\"text-headline-6\">${plan_creditos_seleccionado.nombre || 'Plan de Créditos'}</div>\n   398→                    </div>\n   399→                    <div class=\"col-auto\">\n   400→                        ${crearTag({\n   401→                            texto: 'Créditos disponibles: ' + plan_creditos_seleccionado.creditos.toLocaleString('es-CO'),\n   402→                            class: 'tag-tonal-yellow',\n   403→                        })}\n   404→                    </div>\n   405→                    <div class=\"col-auto text-primary fw-bold\">\n   406→                        ${crearTag({\n   407→                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n   408→                            class: 'tag-tonal-yellow',\n   409→                        })}\n   410→                    </div>\n   411→                </div>\n   412→            </div>\n   413→        </div>\n   414→    `;\n   415→\n   416→    // Remover el contenedor anterior si existe\n   417→    $('#contenedor-plan-creditos').remove();\n   418→\n   419→    // Agregar después del contenedor-plan o dentro de contenedor-creditos\n   420→    if ($('#contenedor-creditos').length) {\n   421→        $('#contenedor-creditos').html(seccion_creditos);\n   422→    } else {\n   423→        $('#contenedor-plan').after(seccion_creditos);\n   424→    }\n   425→}\n   426→\n   427→/**\n   428→ * Mostrar en el modal los planes obtenidos en el listado.\n   429→ *\n   430→ * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n   431→ * @returns {void}\n   432→ * @author José Manuel Jiménez\n   433→ * @author Daniel Beltrán\n   434→ * @author Jair Carvajal\n   435→ */\n   436→function mostrarPlanes(tipo_especifico = null) {\n   437→    let buscar = $('#buscador-plan').val();\n   438→    let filtro_plan = $('#filtro-plan').val();\n   439→    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n   440→        table.destroy();\n   441→    }\n   442→    $('#buscador-plan').remove();\n   443→    $('#tbody-planes').empty();\n   444→    for (let i = 0; i < planes.length; i++) {\n   445→        if (\n   446→            (filtro_plan == 'Todos') ||\n   447→            (filtro_plan == 'Ofertas' && planes[i].cantidad_ofertas_laborales != null) ||\n   448→            (filtro_plan == 'Unidades' && planes[i].unidades != null) ||\n   449→            (filtro_plan == 'Tiempo' && planes[i].vigencia != null)\n   450→        ) {\n   451→            let cantidad_usuarios = '';\n   452→            if (planes[i].cantidad_usuarios != null) {\n   453→                cantidad_usuarios = `<div class=\"col-auto w-90px\"><i class=\"bi bi-person\"></i> ${planes[i].cantidad_usuarios}</div>`;\n   454→            }\n   455→            let cantidad_ofertas_laborales = '';\n   456→            if (planes[i].cantidad_ofertas_laborales != null) {\n   457→                cantidad_ofertas_laborales = `<div class=\"col-auto w-90px\"><i class=\"bi bi-briefcase\"></i> ${planes[i].cantidad_ofertas_laborales}</div>`;\n   458→            }\n   459→            let cantidad_pruebas = '';\n   460→            if (planes[i].cantidad_pruebas != null) {\n   461→                cantidad_pruebas = `<div class=\"col-auto w-90px\"><i class=\"bi bi-clipboard2-check\"></i> ${planes[i].cantidad_pruebas}</div>`;\n   462→            }\n   463→            let unidades = '';\n   464→            if (planes[i].unidades != null) {\n   465→                unidades = `<div class=\"col-auto w-90px\"><i class=\"bi bi-box\"></i> ${planes[i].unidades}</div>`;\n   466→            }\n   467→            let vigencia = '';\n   468→            if (planes[i].vigencia == 90) {\n   469→                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n   470→            } else if (planes[i].vigencia == 180) {\n   471→                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n   472→            }  else if (planes[i].vigencia == 365) {\n   473→                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n   474→            } else if (planes[i].vigencia == null || planes[i].vigencia == 0) {\n   475→                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n   476→            } else {\n   477→                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${planes[i].vigencia} días</div>`;\n   478→            }\n   479→            $('#tbody-planes').append(`\n   480→                <tr>\n   481→                    <td style=\"border-bottom: 0px!important;\">\n   482→                        <div class=\"border border-1 rounded rounded-2 pointer border-hover\" onclick=\"elegirPlan(${i});\">\n   483→                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6\">\n   484→                                <div class=\"col\">${planes[i].nombre !== null ? planes[i].nombre : ''}</div>\n   485→                                ${cantidad_ofertas_laborales}\n   486→                                ${unidades}\n   487→                                ${cantidad_usuarios}\n   488→                                ${cantidad_pruebas}\n   489→                                ${vigencia}\n   490→                            </div>\n   491→                        </div>\n   492→                    </td>\n   493→                </tr>\n   494→            `);\n   495→        }\n   496→    }\n   497→\n   498→    // Verificar si Bootstrap modal está disponible antes de usar\n   499→    if (typeof $.fn.modal !== 'undefined') {\n   500→        $('#modal-planes').modal('show');\n   501→    }\n   502→\n   503→    table = $('#tabla-planes').DataTable({\n   504→        \"paging\": false,\n   505→        \"searching\": true,\n   506→        \"ordering\": false,\n   507→        \"info\": false\n   508→    });\n   509→    let buscador = $('#tabla-planes_wrapper input');\n   510→    $(buscador).addClass('rounded-2 text-body-2');\n   511→    $(buscador).prop('placeholder', 'Buscar');\n   512→    $(buscador).prop('id', 'buscador-plan');\n   513→    $('#input-busqueda').append(buscador);\n   514→    $(buscador).val(buscar).trigger('input');\n   515→}\n   516→\n   517→/**\n   518→ * Elegir un plan del listado.\n   519→ *\n   520→ * @returns {void}\n   521→ * @author José Manuel Jiménez\n   522→ */\n   523→function elegirPlan(i) {\n   524→    plan_seleccionado = planes[i];\n   525→    mostrarPlanSeleccionado();\n   526→}\n   527→\n   528→/**\n   529→ * Mostrar el plan seleccionado en el contenedor y en las opciones del modificar.\n   530→ *\n   531→ * @returns {void}\n   532→ * @author José Manuel Jiménez\n   533→ * @author Daniel Beltrán\n   534→ */\n   535→function mostrarPlanSeleccionado() {\n   536→    let cantidad_usuarios = '';\n   537→    let cantidad_usuarios_modal = $('#cantidad_usuarios_modal').val();\n   538→    if (cantidad_usuarios_modal != '') {\n   539→        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${cantidad_usuarios_modal}</div>`;\n   540→    } else if (plan_seleccionado.cantidad_usuarios != null) {\n   541→        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${plan_seleccionado.cantidad_usuarios}</div>`;\n   542→    }\n   543→    let cantidad_ofertas_laborales = '';\n   544→    let cantidad_ofertas_laborales_modal = $('#cantidad_ofertas_laborales_modal').val();\n   545→    if (cantidad_ofertas_laborales_modal != '') {\n   546→        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${cantidad_ofertas_laborales_modal}</div>`;\n   547→    } else if (plan_seleccionado.cantidad_ofertas_laborales != null) {\n   548→        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${plan_seleccionado.cantidad_ofertas_laborales}</div>`;\n   549→    }\n   550→    let cantidad_pruebas = '';\n   551→    let cantidad_pruebas_modal = $('#cantidad_pruebas_modal').val();\n   552→    if (cantidad_pruebas_modal != '') {\n   553→        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${cantidad_pruebas_modal}</div>`;\n   554→        $('.cantidad-pruebas').text(cantidad_pruebas_modal);\n   555→    } else if (plan_seleccionado.cantidad_pruebas != null) {\n   556→        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${plan_seleccionado.cantidad_pruebas}</div>`;\n   557→        $('.cantidad-pruebas').text(plan_seleccionado.cantidad_pruebas);\n   558→    }\n   559→    let unidades = '';\n   560→    let unidades_modal = $('#unidades_modal').val();\n   561→    if (unidades_modal != '') {\n   562→        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${unidades_modal}</div>`;\n   563→    } else if (plan_seleccionado.unidades != null) {\n   564→        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${plan_seleccionado.unidades}</div>`;\n   565→    }\n   566→    let vigencia = '';\n   567→    let vigencia_modal = $('#vigencia_modal').val();\n   568→    if (plan_seleccionado.vigencia == 90 || vigencia_modal == '90') {\n   569→        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n   570→    } else if (plan_seleccionado.vigencia == 180 || vigencia_modal == '180') {\n   571→        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n   572→    }  else if (plan_seleccionado.vigencia == 365 || vigencia_modal == '365') {\n   573→        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n   574→    } else if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n   575→        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n   576→    } else if (vigencia_modal != '') {\n   577→        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${vigencia_modal} días</div>`;\n   578→    } else {\n   579→        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${plan_seleccionado.vigencia} días</div>`;\n   580→    }\n   581→    let abrir_modal_elegir_plan = '';\n   582→    let icono_editar = `\n   583→        <div class=\"col-auto w-90px\">\n   584→            <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalModificar(event);\" title=\"Modificar plan\">\n   585→                <i class=\"bi bi-wrench\"></i>\n   586→            </button>\n   587→        </div>\n   588→    `;\n   589→    if (opcion == 'asignar') {\n   590→        abrir_modal_elegir_plan = `onclick=\"modalElegirPlan();\"`;\n   591→        icono_editar = '';\n   592→    }\n   593→    $('#contenedor-plan').empty();\n   594→    $('#contenedor-plan').append(`\n   595→        <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n   596→        <div class=\"card rounded rounded-3\">\n   597→            <div class=\"row align-items-center m-0 w-100 px-3 py-5 text-headline-6 pointer\" ${abrir_modal_elegir_plan}>\n   598→                <div class=\"col\">${plan_seleccionado.nombre !== null ? plan_seleccionado.nombre : ''} <span id=\"plan-modificado\"></span></div>\n   599→                ${cantidad_ofertas_laborales}\n   600→                ${unidades}\n   601→                ${cantidad_usuarios}\n   602→                ${cantidad_pruebas}\n   603→                ${vigencia}\n   604→                ${icono_editar}\n   605→            </div>\n   606→        </div>\n   607→    `);\n   608→\n   609→    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n   610→    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n   611→    // Solo agregar el botón de elegir plan de créditos si no hay uno seleccionado y se requiere\n   612→    if (tiene_creditos && plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n   613→        let seccion_creditos = `\n   614→            <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n   615→                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n   616→                <div class=\"card rounded rounded-3\">\n   617→                    <div class=\"card-body text-center\">\n   618→                        <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n   619→                            Elegir Plan de Créditos IA\n   620→                        </button>\n   621→                    </div>\n   622→                </div>\n   623→            </div>\n   624→        `;\n   625→        $('#contenedor-creditos').append(seccion_creditos);\n   626→    }\n   627→\n   628→    $('#plan_id').val(plan_seleccionado.id);\n   629→    $('#seccion-pruebas').removeClass('d-none');\n   630→\n   631→    // Establecer el precio por defecto en el formulario principal\n   632→    $('#precio').val(plan_seleccionado.precio);\n   633→\n   634→    // Verificar si Bootstrap modal está disponible antes de usar\n   635→    if (typeof $.fn.modal !== 'undefined') {\n   636→        $('#modal-planes').modal('hide');\n   637→    }\n   638→\n   639→    ValidarPruebas();\n   640→    $('#boton-guardar-modificaciones').prop('disabled', true);\n   641→}\n   642→\n   643→/**\n   644→ * Abrir la factura del plan en una nueva pestaña del navegador.\n   645→ *\n   646→ * @param {number} factura_id Id de la factura.\n   647→ * @returns {void}\n   648→ * @author Andres Morales\n   649→ */\n   650→async function abrirFacturaPlan(factura_id) {\n   651→    if (!factura_id) {\n   652→        mostrarToast('danger', 'No se encontró la factura');\n   653→        return;\n   654→    }\n   655→\n   656→    try {\n   657→        const respuesta = await $.ajax({\n   658→            type: 'GET',\n   659→            url: `/archivos-abrir/${factura_id}`,\n   660→            xhrFields: { responseType: 'blob' }\n   661→        });\n   662→\n   663→        const blobUrl = window.URL.createObjectURL(respuesta);\n   664→        window.open(blobUrl, '_blank');\n   665→    } catch (error) {\n   666→        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n   667→    }\n   668→}\n   669→\n   670→/**\n   671→ * Buscar las funcionalidades por tipo de prueba.\n   672→ *\n   673→ * @param {number} tipo_prueba_id ID del tipo de prueba.\n   674→ * @returns {void}\n   675→ * @author José Manuel Jiménez\n   676→ * @author Daniel Beltrán\n   677→ */\n   678→function buscarfuncionalidades(tipo_prueba_id) {\n   679→    $.ajax({\n   680→        type : 'GET',\n   681→        url : `/funcionalidades-listado`,\n   682→        data : {\n   683→            tipo_prueba_id: tipo_prueba_id,\n   684→            incluir_tipo_prueba_null: true\n   685→        },\n   686→        success: function(respuesta) {\n   687→            let beneficios = respuesta.data;\n   688→            const adicionales = beneficios\n   689→                .filter(item => item.predeterminado === 0)\n   690→                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n   691→                .sort((a, b) => b.id - a.id);\n   692→            const predefinidos = beneficios\n   693→                .filter(item => item.predeterminado === 1)\n   694→                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n   695→                .sort((a, b) => b.id - a.id);\n   696→            funcionalidades_predefinidos = predefinidos;\n   697→\n   698→            // Verificar si el multiselect está inicializado antes de destruir\n   699→            if ($('#adicionales_modal').data('multiselect')) {\n   700→                $('#adicionales_modal').multiselect('destroy');\n   701→            }\n   702→\n   703→            if ($('#predefinidos_modal').data('multiselect')) {\n   704→                $('#predefinidos_modal').multiselect('destroy');\n   705→            }\n   706→\n   707→            adicionales.forEach((item) => {\n   708→                $('#adicionales_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n   709→            });\n   710→            predefinidos.forEach((item) => {\n   711→                $('#predefinidos_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n   712→            });\n   713→            inizializarMultiselect();\n   714→            if (opcion == 'facturar' || opcion == 'editar') {\n   715→                buscarfuncionalidadesPlanEmpresa($('#id').val());\n   716→            }\n   717→        },\n   718→        error: function(error) {\n   719→            mostrarToast('danger', 'Ocurrió un error');\n   720→        }\n   721→    });\n   722→}\n   723→\n   724→/**\n   725→ * Buscar las funcionalidades del plan de la empresa.\n   726→ *\n   727→ * @param {number} empresa_plan_id ID del plan de empresa.\n   728→ * @returns {void}\n   729→ * @author José Manuel Jiménez\n   730→ * @author Daniel Beltrán\n   731→ */\n   732→function buscarfuncionalidadesPlanEmpresa(empresa_plan_id) {\n   733→    $.ajax({\n   734→        type : 'GET',\n   735→        url : `/empresas-planes-funcionalidades-listado`,\n   736→        data : {\n   737→            empresa_plan_id: empresa_plan_id,\n   738→            incluir_tipo_prueba_null: true\n   739→        },\n   740→        success: function(respuesta) {\n   741→            let funcionalidades = respuesta.data.map(item => item.funcionalidad_id);\n   742→            $('#adicionales_modal').val(funcionalidades);\n   743→\n   744→            // Verificar si el multiselect está inicializado antes de refrescar\n   745→            if ($('#adicionales_modal').data('multiselect')) {\n   746→                $('#adicionales_modal').multiselect(\"refresh\");\n   747→            }\n   748→\n   749→            $('#predefinidos_modal').val(funcionalidades);\n   750→\n   751→            if ($('#predefinidos_modal').data('multiselect')) {\n   752→                $('#predefinidos_modal').multiselect(\"refresh\");\n   753→            }\n   754→        },\n   755→        error: function(error) {\n   756→            mostrarToast('danger', 'Ocurrió un error');\n   757→        }\n   758→    });\n   759→}\n   760→\n   761→/**\n   762→ * Función para agregar validaciones adicionales y data adicional en el envío del form.\n   763→ *\n   764→ * @returns {void}\n   765→ * @author José Manuel Jiménez\n   766→ */\n   767→function validacionAdicional() {\n   768→    let valido = true;\n   769→    $('#vigencia').val($('#vigencia_modal').val());\n   770→    if ($('#unidades_modal').val() == 'Ilimitadas') {\n   771→        $('#unidades').val('');\n   772→    } else {\n   773→        $('#unidades').val($('#unidades_modal').val());\n   774→    }\n   775→    if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n   776→        $('#cantidad_ofertas_laborales').val('');\n   777→    } else {\n   778→        $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n   779→    }\n   780→    $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n   781→    $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n   782→    if (opcion == 'facturar' || opcion == 'editar') {\n   783→        let adicionales = $('#adicionales_modal').val();\n   784→        let predefinidos = $('#predefinidos_modal').val();\n   785→        let funcionalidades = adicionales.concat(predefinidos);\n   786→        $('#funcionalidades').val(JSON.stringify(funcionalidades));\n   787→        if (funcionalidades.length == 0) {\n   788→            valido = false;\n   789→            mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n   790→        }\n   791→    } else {\n   792→        let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n   793→        $('#funcionalidades').val(JSON.stringify(ids));\n   794→    }\n   795→    var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n   796→        return this.value;\n   797→    }).get();\n   798→    $('#pruebas').val('');\n   799→    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n   800→    if (maximo_pruebas == '') {\n   801→        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n   802→    }\n   803→    if (pruebas_seleccionadas.length == 0) {\n   804→        valido = false;\n   805→        mostrarToast('danger', 'Seleccione al menos una prueba.');\n   806→    } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n   807→        valido = false;\n   808→        mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n   809→    }\n   810→    if (valido) {\n   811→        $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n   812→    }\n   813→    return valido;\n   814→}\n   815→\n   816→\n   817→/**\n   818→ * Función para validar que no se exceda al seleccionar limite de pruebas.\n   819→ *\n   820→ * @returns {void}\n   821→ * @author José Manuel Jiménez\n   822→ */\n   823→function ValidarPruebas() {\n   824→    let cantidad_seleccionadas = $('.pruebas:checked').length;\n   825→    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n   826→    if (maximo_pruebas == '') {\n   827→        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n   828→    }\n   829→    if (cantidad_seleccionadas > maximo_pruebas) {\n   830→        $('#alerta-pruebas').removeClass('d-none');\n   831→    } else {\n   832→        $('#alerta-pruebas').addClass('d-none');\n   833→    }\n   834→}\n   835→\n   836→/**\n   837→ * Abrir el modal con los campos para modificar plan.\n   838→ *\n   839→ * @param {Event} evento Evento desencadenado.\n   840→ * @returns {void}\n   841→ * @author José Manuel Jiménez\n   842→ * @author Daniel Beltrán\n   843→ */\n   844→function abrirModalModificar(evento) {\n   845→    evento.stopPropagation();\n   846→    if (modificado == false) {\n   847→        $('#nombre-plan-modal').text(plan_seleccionado.nombre);\n   848→        $('#cantidad_pruebas_modal').empty();\n   849→        $('#cantidad_pruebas_modal').append(`\n   850→            <option value=\"\">Seleccione</option>\n   851→        `);\n   852→        for (let j = 1; j <= pruebas.length; j++) {\n   853→            $('#cantidad_pruebas_modal').append(`\n   854→                <option value=\"${j}\">${j} Pruebas</option>\n   855→            `);\n   856→        }\n   857→        $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n   858→        if ([90, 180, 365].includes(plan_seleccionado.vigencia)) {\n   859→            $('#tiempo_modal').prop('disabled', false);\n   860→            $('#tiempo_modal').val(plan_seleccionado.vigencia).trigger('change').trigger('select2:select');\n   861→            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n   862→        } else if (plan_seleccionado.vigencia != null && plan_seleccionado.vigencia != 0) {\n   863→            $('#tiempo_modal').prop('disabled', false);\n   864→            $('#tiempo_modal').val('personalizado').trigger('change').trigger('select2:select');\n   865→            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n   866→        } else {\n   867→            $('#tiempo_modal').prop('disabled', true);\n   868→            $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n   869→            $('#vigencia_modal').val('');\n   870→        }\n   871→        if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n   872→            $('#unidades_modal').val(plan_seleccionado.unidades);\n   873→            $('#unidades_modal').prop('disabled', false);\n   874→            if (opcion == 'asignar') {\n   875→                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n   876→            } else {\n   877→                $('#cantidad_ofertas_laborales_modal').val(empresa_plan.cantidad_ofertas_laborales);\n   878→            }\n   879→            $('#cantidad_ofertas_laborales_modal').prop('disabled', false);\n   880→        } else {\n   881→            $('#unidades_modal').val(empresa.procesos_estimados_mensuales);\n   882→            $('#unidades_modal').prop('disabled', true);\n   883→            if (opcion == 'facturar' || opcion == 'editar') {\n   884→                $('#unidades_modal').val(plan_seleccionado.unidades);\n   885→                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n   886→            } else {\n   887→                $('#cantidad_ofertas_laborales_modal').val(empresa.pruebas_estimadas_mensuales);\n   888→            }\n   889→            $('#cantidad_ofertas_laborales_modal').prop('disabled', true);\n   890→        }\n   891→        $('#cantidad_usuarios_modal').val(plan_seleccionado.cantidad_usuarios);\n   892→        if (opcion == 'facturar' || opcion == 'editar') {\n   893→            $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n   894→            buscarfuncionalidadesPlanEmpresa($('#id').val());\n   895→        }\n   896→        $('#boton-guardar-modificaciones').prop('disabled', true);\n   897→    }\n   898→\n   899→    // Verificar si Bootstrap modal está disponible antes de usar\n   900→    if (typeof $.fn.modal !== 'undefined') {\n   901→        $('#modal-modificar-planes').modal('show');\n   902→    }\n   903→}\n   904→\n   905→/**\n   906→ * Función que habilita el boton de guardar un plan modificado.\n   907→ *\n   908→ * @returns {void}\n   909→ * @author José Manuel Jiménez\n   910→ */\n   911→function habilitarBotonGuardar() {\n   912→    $('#boton-guardar-modificaciones').prop('disabled', false);\n   913→}\n   914→\n   915→/**\n   916→ * Función que controla los campos de vigencia en el modal de editar.\n   917→ *\n   918→ * @returns {void}\n   919→ * @author José Manuel Jiménez\n   920→ */\n   921→function seleccionarTiempo(vigencia) {\n   922→    $('.texto-label-tiempo').text('máximas permitidas');\n   923→    $('#input-container-tiempo').removeClass('d-none');\n   924→    $('#input-container-tiempo').addClass('col-md-6');\n   925→    if (vigencia == 'personalizado') {\n   926→        $('#input-container-vigencia').removeClass('d-none');\n   927→        $('#vigencia_modal').val('');\n   928→    } else if ((vigencia == '' || vigencia == null || vigencia == 0) && plan_seleccionado != null && (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0)) {\n   929→        $('.texto-label-tiempo').text('');\n   930→        $('#input-container-tiempo').addClass('d-none');\n   931→        $('#input-container-vigencia').addClass('d-none');\n   932→        $('#vigencia_modal').val('');\n   933→        $('#input-container-tiempo').removeClass('col-md-6');\n   934→    } else if (['90', '180', '365'].includes(vigencia)) {\n   935→        $('#input-container-tiempo').removeClass('col-md-6');\n   936→        $('#input-container-vigencia').addClass('d-none');\n   937→        $('#vigencia_modal').val(vigencia);\n   938→    } else {\n   939→        $('#vigencia_modal').val(vigencia);\n   940→        $('#input-container-vigencia').addClass('d-none');\n   941→        $('#input-container-tiempo').removeClass('col-md-6');\n   942→    }\n   943→}\n   944→\n   945→/**\n   946→ * Abrir el modal de confirmación.\n   947→ *\n   948→ * @returns {void}\n   949→ * @author José Manuel Jiménez\n   950→ * @author Daniel Beltrán\n   951→ */\n   952→function abrirModalEstasSeguro() {\n   953→    // Verificar si Bootstrap modal está disponible antes de usar\n   954→    if (typeof $.fn.modal !== 'undefined') {\n   955→        $('#modal-modificar-planes').modal('hide');\n   956→        $('#modal-estas-seguro').modal('show');\n   957→    }\n   958→}\n   959→\n   960→/**\n   961→ * Cancelar la edición de un plan.\n   962→ *\n   963→ * @returns {void}\n   964→ * @author José Manuel Jiménez\n   965→ * @author Daniel Beltrán\n   966→ */\n   967→function cancelarEdicion() {\n   968→    modificado = false;\n   969→\n   970→    // Verificar si Bootstrap modal está disponible antes de usar\n   971→    if (typeof $.fn.modal !== 'undefined') {\n   972→        $('#modal-estas-seguro').modal('hide');\n   973→    }\n   974→\n   975→    limpiarAdicional();\n   976→    mostrarPlanSeleccionado();\n   977→}\n   978→\n   979→/**\n   980→ * Confirmar los datos editados.\n   981→ *\n   982→ * @returns {void}\n   983→ * @author José Manuel Jiménez\n   984→ * @author Daniel Beltrán\n   985→ */\n   986→function confirmarEdicion() {\n   987→    modificado = true;\n   988→\n   989→    // Verificar si Bootstrap modal está disponible antes de usar\n   990→    if (typeof $.fn.modal !== 'undefined') {\n   991→        $('#modal-estas-seguro').modal('hide');\n   992→    }\n   993→\n   994→    $('#plan-modificado').text('(modificado)');\n   995→    mostrarPlanSeleccionado();\n   996→}\n   997→\n   998→/**\n   999→ * Limpiar los campos del modal.\n  1000→ *\n  1001→ * @returns {void}\n  1002→ * @author José Manuel Jiménez\n  1003→ * @author Daniel Beltrán\n  1004→ */\n  1005→function limpiarAdicional() {\n  1006→    $('#cantidad_pruebas_modal').val('').trigger('change').trigger('select2:select');\n  1007→    $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n  1008→    $('#unidades_modal').val('');\n  1009→    $('#cantidad_ofertas_laborales_modal').val('');\n  1010→    $('#cantidad_usuarios_modal').val('');\n  1011→\n  1012→    // Verificar si el multiselect está inicializado antes de llamar uncheckAll\n  1013→    if ($('#adicionales_modal').data('multiselect')) {\n  1014→        $('#adicionales_modal').multiselect(\"uncheckAll\");\n  1015→    }\n  1016→\n  1017→    if ($('#predefinidos_modal').data('multiselect')) {\n  1018→        $('#predefinidos_modal').multiselect(\"uncheckAll\");\n  1019→    }\n  1020→}\n  1021→\n  1022→/**\n  1023→ * Función para ejecutar acciones luego de guardar.\n  1024→ *\n  1025→ * @returns {void}\n  1026→ * @author José Manuel Jiménez\n  1027→ */\n  1028→function postSuccess(respuesta) {\n  1029→    limpiarFormulario(respuesta.formulario);\n  1030→    if (opcion == 'asignar') {\n  1031→        localStorage.setItem('notificacionToast', JSON.stringify({\n  1032→            tipo_alerta: 'success',\n  1033→            texto_1: `El plan se asignó con éxito a la empresa`,\n  1034→        }));\n  1035→    } else if (opcion == 'facturar') {\n  1036→        localStorage.setItem('notificacionToast', JSON.stringify({\n  1037→            tipo_alerta: 'success',\n  1038→            texto_1: `El plan se facturó con éxito`,\n  1039→        }));\n  1040→    } else if (opcion == 'editar') {\n  1041→        localStorage.setItem('notificacionToast', JSON.stringify({\n  1042→            tipo_alerta: 'success',\n  1043→            texto_1: `El plan se actualizó con éxito`,\n  1044→        }));\n  1045→    }\n  1046→    window.location.href='/empresas-gestionar/' + empresa.id;\n  1047→}\n  1048→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1b9127cc-94f4-4ab9-95d2-0e12fa30a182","timestamp":"2026-01-20T17:31:32.408Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","content":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPrueba(tipo_prueba_id) {\n    $('#contenedor-plan').empty();\n    $('#seccion-pruebas').addClass('d-none');\n    $('#plan_id').val('');\n    pruebas = [];\n\n    // Convertir tipo_prueba_id a array si no lo es\n    let tipos_prueba = Array.isArray(tipo_prueba_id) ? tipo_prueba_id : [tipo_prueba_id];\n\n    // Crear los botones según los tipos de prueba seleccionados\n    let botones_html = '<div class=\"card-body text-center\">';\n\n    tipos_prueba.forEach(function(tipo_id) {\n        let texto_boton = 'Elegir plan';\n        let clase_boton = 'btn-outline-primary';\n\n        if (tipo_id == 1) {\n            texto_boton = 'Elegir Plan de Selección';\n            clase_boton = 'btn-outline-primary';\n        } else if (tipo_id == 2) {\n            texto_boton = 'Elegir Plan de Créditos IA';\n            clase_boton = 'btn-outline-info';\n        }\n\n        botones_html += `\n            <button type=\"button\" id=\"elegir-plan-${tipo_id}\" class=\"btn ${clase_boton} mx-1 my-1\" disabled onclick=\"modalElegirPlan(${tipo_id});\">\n                ${texto_boton}\n            </button>\n        `;\n    });\n\n    botones_html += '</div>';\n    $('#contenedor-plan').append(botones_html);\n\n    $('#tipo_prueba_id').val(tipo_prueba_id).trigger('select2');\n\n    if (tipo_prueba_id && (Array.isArray(tipo_prueba_id) ? tipo_prueba_id.length > 0 : tipo_prueba_id)) {\n        // Habilitar todos los botones creados\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', false);\n        });\n\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipo_prueba_id,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n    } else {\n        // Deshabilitar todos los botones si no hay tipo de prueba\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', true);\n        });\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan\n        $('#contenedor-plan').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/pruebas-listado`,\n        data: {\n            tipo_prueba_id: tipos_prueba,\n            activo: 1\n        }\n    }).then((respuesta) => {\n        limpiarAdicional();\n        $('#contenedor-pruebas').empty();\n        pruebas = respuesta.data;\n        for (let i = 0; i < pruebas.length; i++) {\n            $('#contenedor-pruebas').append(`\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"d-flex align-items-center\">\n                        <div class=\"check-container my-1 me-1\">\n                            <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                        </div>\n                        <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                    </div>\n                </div>\n            `);\n        }\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n            }\n            $('#seccion-pruebas').removeClass('d-none');\n            mostrarPlanSeleccionado();\n        }\n\n        if (opcion == 'editar') {\n            $('#tipo_prueba_id').prop('disabled', true);\n        }\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    });\n}\n\n/**\n * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Jair Carvajal\n */\nfunction modalElegirPlan(tipo_especifico = null) {\n    let tipo_prueba_para_consulta = tipo_especifico !== null ? tipo_especifico : $('#tipo_prueba_id').val();\n\n    // Si es tipo 2 (Créditos IA), cargar planes de créditos\n    if (tipo_prueba_para_consulta == 2 || tipo_prueba_para_consulta == '2') {\n        $.ajax({\n            type: 'GET',\n            url: '/api/planes-creditos',\n            data: {\n                activo: true\n            }\n        }).then((respuesta) => {\n            planes_creditos = respuesta.data.planes;            \n            mostrarPlanesCreditos();\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n        return;\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/planes-listado`,\n        data: {\n            tipo_prueba_id: tipo_prueba_para_consulta\n        }\n    }).then((respuesta) => {\n        planes = respuesta.data;\n        mostrarPlanes(tipo_especifico);\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error');\n    });\n}\n\n/**\n * Mostrar los planes de créditos en el modal.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanesCreditos() {\n    let filtro_orden = $('#filtro-plan-credito').val();\n    let buscar = $('#buscador-plan-credito').val() || '';\n\n    // Ordenar planes según el filtro\n    let planes_ordenados = [...planes_creditos];\n    if (filtro_orden === 'Mayor') {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else if (filtro_orden === 'Menor') {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n    if (buscar !== '') {\n        planes_ordenados = planes_ordenados.filter(plan =>\n            plan.nombre.toLowerCase().includes(buscar.toLowerCase())\n        );\n    }\n\n    $('#contenedor-planes-creditos').empty();\n\n    if (planes_ordenados.length === 0) {\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"text-center py-5\">\n                <p class=\"text-muted\">No se encontraron planes</p>\n            </div>\n        `);\n    }\n\n    for (let i = 0; i < planes_ordenados.length; i++) {\n        let plan = planes_ordenados[i];\n        let creditos_disponibles = plan.creditos_disponibles || plan.creditos || 0;\n        let creditos_promedio = plan.creditos_promedio_accion || 0;\n        let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n            ? Math.floor(creditos_disponibles / creditos_promedio)\n            : 0;\n\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"card rounded rounded-3 border-hover pointer mb-3\" onclick=\"elegirPlanCreditos(${i}, ${filtro_orden === 'Mayor' ? 'true' : 'false'});\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6 text-gray-10\">${plan.nombre}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        `);\n    }\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('show');\n    }\n\n    $('#buscador-plan-credito').off('input').on('input', function() {\n        mostrarPlanesCreditos();\n    });\n}\n\n/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}\n\n/**\n * Mostrar el plan de créditos seleccionado en el contenedor.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanCreditosSeleccionado() {\n    if (!plan_creditos_seleccionado || !plan_creditos_seleccionado.creditos) {\n        mostrarToast('danger', 'Ocurrió un error'+plan_creditos_seleccionado);\n        return;\n    }\n\n    let creditos_disponibles = plan_creditos_seleccionado.creditos_disponibles || plan_creditos_seleccionado.creditos || 0;\n    let creditos_promedio = plan_creditos_seleccionado.creditos_promedio_accion || 0;\n    let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n        ? Math.floor(creditos_disponibles / creditos_promedio)\n        : 0;\n\n    let seccion_creditos = `\n        <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n            <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n            <div class=\"card rounded rounded-3\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4 pointer\" onclick=\"modalElegirPlan(2);\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6\">${plan_creditos_seleccionado.nombre || 'Plan de Créditos'}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan_creditos_seleccionado.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    // Remover el contenedor anterior si existe\n    $('#contenedor-plan-creditos').remove();\n\n    // Agregar después del contenedor-plan o dentro de contenedor-creditos\n    if ($('#contenedor-creditos').length) {\n        $('#contenedor-creditos').html(seccion_creditos);\n    } else {\n        $('#contenedor-plan').after(seccion_creditos);\n    }\n}\n\n/**\n * Mostrar en el modal los planes obtenidos en el listado.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction mostrarPlanes(tipo_especifico = null) {\n    let buscar = $('#buscador-plan').val();\n    let filtro_plan = $('#filtro-plan').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        table.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    for (let i = 0; i < planes.length; i++) {\n        if (\n            (filtro_plan == 'Todos') ||\n            (filtro_plan == 'Ofertas' && planes[i].cantidad_ofertas_laborales != null) ||\n            (filtro_plan == 'Unidades' && planes[i].unidades != null) ||\n            (filtro_plan == 'Tiempo' && planes[i].vigencia != null)\n        ) {\n            let cantidad_usuarios = '';\n            if (planes[i].cantidad_usuarios != null) {\n                cantidad_usuarios = `<div class=\"col-auto w-90px\"><i class=\"bi bi-person\"></i> ${planes[i].cantidad_usuarios}</div>`;\n            }\n            let cantidad_ofertas_laborales = '';\n            if (planes[i].cantidad_ofertas_laborales != null) {\n                cantidad_ofertas_laborales = `<div class=\"col-auto w-90px\"><i class=\"bi bi-briefcase\"></i> ${planes[i].cantidad_ofertas_laborales}</div>`;\n            }\n            let cantidad_pruebas = '';\n            if (planes[i].cantidad_pruebas != null) {\n                cantidad_pruebas = `<div class=\"col-auto w-90px\"><i class=\"bi bi-clipboard2-check\"></i> ${planes[i].cantidad_pruebas}</div>`;\n            }\n            let unidades = '';\n            if (planes[i].unidades != null) {\n                unidades = `<div class=\"col-auto w-90px\"><i class=\"bi bi-box\"></i> ${planes[i].unidades}</div>`;\n            }\n            let vigencia = '';\n            if (planes[i].vigencia == 90) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n            } else if (planes[i].vigencia == 180) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n            }  else if (planes[i].vigencia == 365) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n            } else if (planes[i].vigencia == null || planes[i].vigencia == 0) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n            } else {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${planes[i].vigencia} días</div>`;\n            }\n            $('#tbody-planes').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-2 pointer border-hover\" onclick=\"elegirPlan(${i});\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6\">\n                                <div class=\"col\">${planes[i].nombre !== null ? planes[i].nombre : ''}</div>\n                                ${cantidad_ofertas_laborales}\n                                ${unidades}\n                                ${cantidad_usuarios}\n                                ${cantidad_pruebas}\n                                ${vigencia}\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('show');\n    }\n\n    table = $('#tabla-planes').DataTable({\n        \"paging\": false,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": false\n    });\n    let buscador = $('#tabla-planes_wrapper input');\n    $(buscador).addClass('rounded-2 text-body-2');\n    $(buscador).prop('placeholder', 'Buscar');\n    $(buscador).prop('id', 'buscador-plan');\n    $('#input-busqueda').append(buscador);\n    $(buscador).val(buscar).trigger('input');\n}\n\n/**\n * Elegir un plan del listado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction elegirPlan(i) {\n    plan_seleccionado = planes[i];\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Mostrar el plan seleccionado en el contenedor y en las opciones del modificar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction mostrarPlanSeleccionado() {\n    let cantidad_usuarios = '';\n    let cantidad_usuarios_modal = $('#cantidad_usuarios_modal').val();\n    if (cantidad_usuarios_modal != '') {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${cantidad_usuarios_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_usuarios != null) {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${plan_seleccionado.cantidad_usuarios}</div>`;\n    }\n    let cantidad_ofertas_laborales = '';\n    let cantidad_ofertas_laborales_modal = $('#cantidad_ofertas_laborales_modal').val();\n    if (cantidad_ofertas_laborales_modal != '') {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${cantidad_ofertas_laborales_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_ofertas_laborales != null) {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${plan_seleccionado.cantidad_ofertas_laborales}</div>`;\n    }\n    let cantidad_pruebas = '';\n    let cantidad_pruebas_modal = $('#cantidad_pruebas_modal').val();\n    if (cantidad_pruebas_modal != '') {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${cantidad_pruebas_modal}</div>`;\n        $('.cantidad-pruebas').text(cantidad_pruebas_modal);\n    } else if (plan_seleccionado.cantidad_pruebas != null) {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${plan_seleccionado.cantidad_pruebas}</div>`;\n        $('.cantidad-pruebas').text(plan_seleccionado.cantidad_pruebas);\n    }\n    let unidades = '';\n    let unidades_modal = $('#unidades_modal').val();\n    if (unidades_modal != '') {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${unidades_modal}</div>`;\n    } else if (plan_seleccionado.unidades != null) {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${plan_seleccionado.unidades}</div>`;\n    }\n    let vigencia = '';\n    let vigencia_modal = $('#vigencia_modal').val();\n    if (plan_seleccionado.vigencia == 90 || vigencia_modal == '90') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n    } else if (plan_seleccionado.vigencia == 180 || vigencia_modal == '180') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n    }  else if (plan_seleccionado.vigencia == 365 || vigencia_modal == '365') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n    } else if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n    } else if (vigencia_modal != '') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${vigencia_modal} días</div>`;\n    } else {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${plan_seleccionado.vigencia} días</div>`;\n    }\n    let abrir_modal_elegir_plan = '';\n    let icono_editar = `\n        <div class=\"col-auto w-90px\">\n            <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalModificar(event);\" title=\"Modificar plan\">\n                <i class=\"bi bi-wrench\"></i>\n            </button>\n        </div>\n    `;\n    if (opcion == 'asignar') {\n        abrir_modal_elegir_plan = `onclick=\"modalElegirPlan();\"`;\n        icono_editar = '';\n    }\n    $('#contenedor-plan').empty();\n    $('#contenedor-plan').append(`\n        <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n        <div class=\"card rounded rounded-3\">\n            <div class=\"row align-items-center m-0 w-100 px-3 py-5 text-headline-6 pointer\" ${abrir_modal_elegir_plan}>\n                <div class=\"col\">${plan_seleccionado.nombre !== null ? plan_seleccionado.nombre : ''} <span id=\"plan-modificado\"></span></div>\n                ${cantidad_ofertas_laborales}\n                ${unidades}\n                ${cantidad_usuarios}\n                ${cantidad_pruebas}\n                ${vigencia}\n                ${icono_editar}\n            </div>\n        </div>\n    `);\n\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n    // Solo agregar el botón de elegir plan de créditos si no hay uno seleccionado y se requiere\n    if (tiene_creditos && plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n        let seccion_creditos = `\n            <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                            Elegir Plan de Créditos IA\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;\n        $('#contenedor-creditos').append(seccion_creditos);\n    }\n\n    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\n/**\n * Buscar las funcionalidades por tipo de prueba.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidades(tipo_prueba_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/funcionalidades-listado`,\n        data : {\n            tipo_prueba_id: tipo_prueba_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let beneficios = respuesta.data;\n            const adicionales = beneficios\n                .filter(item => item.predeterminado === 0)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            const predefinidos = beneficios\n                .filter(item => item.predeterminado === 1)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            funcionalidades_predefinidos = predefinidos;\n\n            // Verificar si el multiselect está inicializado antes de destruir\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect('destroy');\n            }\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect('destroy');\n            }\n\n            adicionales.forEach((item) => {\n                $('#adicionales_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            predefinidos.forEach((item) => {\n                $('#predefinidos_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            inizializarMultiselect();\n            if (opcion == 'facturar' || opcion == 'editar') {\n                buscarfuncionalidadesPlanEmpresa($('#id').val());\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Buscar las funcionalidades del plan de la empresa.\n *\n * @param {number} empresa_plan_id ID del plan de empresa.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidadesPlanEmpresa(empresa_plan_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-planes-funcionalidades-listado`,\n        data : {\n            empresa_plan_id: empresa_plan_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let funcionalidades = respuesta.data.map(item => item.funcionalidad_id);\n            $('#adicionales_modal').val(funcionalidades);\n\n            // Verificar si el multiselect está inicializado antes de refrescar\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect(\"refresh\");\n            }\n\n            $('#predefinidos_modal').val(funcionalidades);\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect(\"refresh\");\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    $('#vigencia').val($('#vigencia_modal').val());\n    if ($('#unidades_modal').val() == 'Ilimitadas') {\n        $('#unidades').val('');\n    } else {\n        $('#unidades').val($('#unidades_modal').val());\n    }\n    if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n        $('#cantidad_ofertas_laborales').val('');\n    } else {\n        $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n    }\n    $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n    $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n    if (opcion == 'facturar' || opcion == 'editar') {\n        let adicionales = $('#adicionales_modal').val();\n        let predefinidos = $('#predefinidos_modal').val();\n        let funcionalidades = adicionales.concat(predefinidos);\n        $('#funcionalidades').val(JSON.stringify(funcionalidades));\n        if (funcionalidades.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n        }\n    } else {\n        let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n        $('#funcionalidades').val(JSON.stringify(ids));\n    }\n    var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n        return this.value;\n    }).get();\n    $('#pruebas').val('');\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (pruebas_seleccionadas.length == 0) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos una prueba.');\n    } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n    }\n    if (valido) {\n        $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n    }\n    return valido;\n}\n\n\n/**\n * Función para validar que no se exceda al seleccionar limite de pruebas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction ValidarPruebas() {\n    let cantidad_seleccionadas = $('.pruebas:checked').length;\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (cantidad_seleccionadas > maximo_pruebas) {\n        $('#alerta-pruebas').removeClass('d-none');\n    } else {\n        $('#alerta-pruebas').addClass('d-none');\n    }\n}\n\n/**\n * Abrir el modal con los campos para modificar plan.\n *\n * @param {Event} evento Evento desencadenado.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalModificar(evento) {\n    evento.stopPropagation();\n    if (modificado == false) {\n        $('#nombre-plan-modal').text(plan_seleccionado.nombre);\n        $('#cantidad_pruebas_modal').empty();\n        $('#cantidad_pruebas_modal').append(`\n            <option value=\"\">Seleccione</option>\n        `);\n        for (let j = 1; j <= pruebas.length; j++) {\n            $('#cantidad_pruebas_modal').append(`\n                <option value=\"${j}\">${j} Pruebas</option>\n            `);\n        }\n        $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n        if ([90, 180, 365].includes(plan_seleccionado.vigencia)) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val(plan_seleccionado.vigencia).trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else if (plan_seleccionado.vigencia != null && plan_seleccionado.vigencia != 0) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val('personalizado').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else {\n            $('#tiempo_modal').prop('disabled', true);\n            $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val('');\n        }\n        if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n            $('#unidades_modal').val(plan_seleccionado.unidades);\n            $('#unidades_modal').prop('disabled', false);\n            if (opcion == 'asignar') {\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa_plan.cantidad_ofertas_laborales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', false);\n        } else {\n            $('#unidades_modal').val(empresa.procesos_estimados_mensuales);\n            $('#unidades_modal').prop('disabled', true);\n            if (opcion == 'facturar' || opcion == 'editar') {\n                $('#unidades_modal').val(plan_seleccionado.unidades);\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa.pruebas_estimadas_mensuales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', true);\n        }\n        $('#cantidad_usuarios_modal').val(plan_seleccionado.cantidad_usuarios);\n        if (opcion == 'facturar' || opcion == 'editar') {\n            $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n            buscarfuncionalidadesPlanEmpresa($('#id').val());\n        }\n        $('#boton-guardar-modificaciones').prop('disabled', true);\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('show');\n    }\n}\n\n/**\n * Función que habilita el boton de guardar un plan modificado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction habilitarBotonGuardar() {\n    $('#boton-guardar-modificaciones').prop('disabled', false);\n}\n\n/**\n * Función que controla los campos de vigencia en el modal de editar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTiempo(vigencia) {\n    $('.texto-label-tiempo').text('máximas permitidas');\n    $('#input-container-tiempo').removeClass('d-none');\n    $('#input-container-tiempo').addClass('col-md-6');\n    if (vigencia == 'personalizado') {\n        $('#input-container-vigencia').removeClass('d-none');\n        $('#vigencia_modal').val('');\n    } else if ((vigencia == '' || vigencia == null || vigencia == 0) && plan_seleccionado != null && (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0)) {\n        $('.texto-label-tiempo').text('');\n        $('#input-container-tiempo').addClass('d-none');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val('');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    } else if (['90', '180', '365'].includes(vigencia)) {\n        $('#input-container-tiempo').removeClass('col-md-6');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val(vigencia);\n    } else {\n        $('#vigencia_modal').val(vigencia);\n        $('#input-container-vigencia').addClass('d-none');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    }\n}\n\n/**\n * Abrir el modal de confirmación.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalEstasSeguro() {\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('hide');\n        $('#modal-estas-seguro').modal('show');\n    }\n}\n\n/**\n * Cancelar la edición de un plan.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction cancelarEdicion() {\n    modificado = false;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    limpiarAdicional();\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Confirmar los datos editados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction confirmarEdicion() {\n    modificado = true;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    $('#plan-modificado').text('(modificado)');\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Limpiar los campos del modal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction limpiarAdicional() {\n    $('#cantidad_pruebas_modal').val('').trigger('change').trigger('select2:select');\n    $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n    $('#unidades_modal').val('');\n    $('#cantidad_ofertas_laborales_modal').val('');\n    $('#cantidad_usuarios_modal').val('');\n\n    // Verificar si el multiselect está inicializado antes de llamar uncheckAll\n    if ($('#adicionales_modal').data('multiselect')) {\n        $('#adicionales_modal').multiselect(\"uncheckAll\");\n    }\n\n    if ($('#predefinidos_modal').data('multiselect')) {\n        $('#predefinidos_modal').multiselect(\"uncheckAll\");\n    }\n}\n\n/**\n * Función para ejecutar acciones luego de guardar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction postSuccess(respuesta) {\n    limpiarFormulario(respuesta.formulario);\n    if (opcion == 'asignar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se asignó con éxito a la empresa`,\n        }));\n    } else if (opcion == 'facturar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se facturó con éxito`,\n        }));\n    } else if (opcion == 'editar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se actualizó con éxito`,\n        }));\n    }\n    window.location.href='/empresas-gestionar/' + empresa.id;\n}\n","numLines":1048,"startLine":1,"totalLines":1048}},"sourceToolAssistantUUID":"8c253f6d-330e-48e6-9bc4-66ab0e2eea16"}
{"parentUuid":"1b9127cc-94f4-4ab9-95d2-0e12fa30a182","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LGTnwidr2nJEPXoT5Q1VEG","type":"message","role":"assistant","content":[{"type":"text","text":"## Análisis del archivo `asignar-plan.js`\n\nEste archivo JavaScript maneja la lógica de **asignación, facturación y edición de planes** para empresas en el sistema PsicoAlianza. Aquí está el análisis:\n\n### **Propósito General**\nGestiona la interfaz de usuario para asignar planes de suscripción a empresas, incluyendo:\n- Planes de Selección (pruebas psicométricas)\n- Planes de Créditos IA\n\n### **Variables Globales** (líneas 1-7)\n| Variable | Descripción |\n|----------|-------------|\n| `table` | Instancia de DataTable para el listado de planes |\n| `planes` | Array de planes de selección disponibles |\n| `planes_creditos` | Array de planes de créditos IA |\n| `pruebas` | Array de pruebas disponibles |\n| `modificado` | Flag que indica si el plan fue modificado |\n| `funcionalidades_predefinidos` | Funcionalidades por defecto del plan |\n| `plan_creditos_seleccionado` | Plan de créditos actualmente seleccionado |\n\n### **Funciones Principales**\n\n| Función | Línea | Descripción |\n|---------|-------|-------------|\n| `seleccionarTipoPrueba()` | 19 | Carga pruebas y botones según tipo de prueba seleccionado |\n| `seleccionarTipoPruebaMultiple()` | 114 | Versión para selección múltiple de tipos de prueba |\n| `modalElegirPlan()` | 236 | Abre modal para elegir plan (selección o créditos) |\n| `mostrarPlanesCreditos()` | 276 | Renderiza lista de planes de créditos con filtrado |\n| `elegirPlanCreditos()` | 351 | Selecciona un plan de créditos |\n| `mostrarPlanes()` | 436 | Renderiza planes en DataTable con filtros |\n| `elegirPlan()` | 523 | Selecciona un plan de selección |\n| `mostrarPlanSeleccionado()` | 535 | Muestra el plan elegido en la UI |\n| `validacionAdicional()` | 767 | Valida datos antes del envío del formulario |\n| `ValidarPruebas()` | 823 | Valida que no se excedan las pruebas permitidas |\n| `abrirModalModificar()` | 844 | Abre modal para editar configuración del plan |\n\n### **Observaciones y Recomendaciones**\n\n1. **Buenas prácticas seguidas:**\n   - Uso de JSDoc para documentación de funciones\n   - Validación de existencia de plugins (Bootstrap modal, multiselect) antes de usarlos\n   - Separación de responsabilidades por función\n\n2. **Posibles mejoras:**\n   - **Línea 381**: El mensaje de error concatena el objeto directamente: `'Ocurrió un error'+plan_creditos_seleccionado` - debería usar `JSON.stringify()` o remover la concatenación\n   - **Código duplicado**: Las funciones `seleccionarTipoPrueba()` y `seleccionarTipoPruebaMultiple()` comparten mucha lógica que podría refactorizarse\n   - **Variables globales implícitas**: Se usan variables como `opcion`, `empresa`, `empresa_plan`, `plan_seleccionado` y `pruebas_empresa_plan` sin declararlas en este archivo (probablemente vienen de la vista Blade)\n\n3. **Dependencias externas:**\n   - jQuery y Select2\n   - Bootstrap Modals\n   - DataTables\n   - Multiselect plugin\n   - Funciones del sistema: `crearTag()`, `mostrarToast()`, `limpiarFormulario()`\n\n¿Te gustaría que profundice en alguna función específica o que sugiera mejoras concretas?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":16288,"cache_read_input_tokens":25074,"cache_creation":{"ephemeral_5m_input_tokens":16288,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXK2cNuta4D4GPnccyTRe","type":"assistant","uuid":"47719216-e165-4892-9a49-6a3f1b652ea5","timestamp":"2026-01-20T17:31:50.581Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-20T17:35:53.389Z","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565"}
{"type":"file-history-snapshot","messageId":"aa497599-5867-40a8-a52e-fddfe3b7a72b","snapshot":{"messageId":"aa497599-5867-40a8-a52e-fddfe3b7a72b","trackedFileBackups":{},"timestamp":"2026-01-20T17:35:54.562Z"},"isSnapshotUpdate":false}
{"parentUuid":"8c253f6d-330e-48e6-9bc4-66ab0e2eea16","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_018VWKfr1oBZpFY9XDTjry7W","parentToolUseID":"toolu_018VWKfr1oBZpFY9XDTjry7W","uuid":"2d5460dc-6ccd-4b16-8d88-cc346eec20ea","timestamp":"2026-01-20T17:31:30.866Z"}
{"parentUuid":"47719216-e165-4892-9a49-6a3f1b652ea5","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 44 to 56 from c:\\laragon\\www\\psicoalianza-2\\resources\\views\\empresas\\paginas\\asignar-plan.blade.php:\n${crearMultiselect({\n                        opciones: [\n                            { nombre: 'Planes de selección', id: '1' },\n                            { nombre: 'Planes de créditos (IA)', id: '2' }\n                        ],\n                        id: 'tipo_prueba_id',\n                        name: 'tipo_prueba_id',\n                        class: 'clase-personalizada',\n                        onchange: 'seleccionarTipoPruebaMultiple();',\n                        placeholder: 'Tipo de plan',\n                        icono: '<i class=\"bi bi-check-circle input-icono1\"></i>',\n                        label: 'Tipo de plan',\n                    })}\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"listo y este es el blade empresas.paginas.asignar-plan tambien anlizado y tengo un problema y esyque aqui ${crearMultiselect({\n                        opciones: [\n                            { nombre: 'Planes de selección', id: '1' },\n                            { nombre: 'Planes de créditos (IA)', id: '2' }\n                        ],\n                        id: 'tipo_prueba_id',\n                        name: 'tipo_prueba_id',\n                        class: 'clase-personalizada',\n                        onchange: 'seleccionarTipoPruebaMultiple();',\n                        placeholder: 'Tipo de plan',\n                        icono: '<i class=\"bi bi-check-circle input-icono1\"></i>',\n                        label: 'Tipo de plan',\n                    })} vuando selciono la del plan con ia y coloca todos los campos y le doy enviar me dice que este campo es obligatorio y el campo que masco como obligatorio es la seccion que paarece cuando en ese mismo che le doy clik a planes de seleccion entonces que sea campos obligatorios cuando esta chekia ya sea selecion o ya o los dos"}]},"uuid":"aa497599-5867-40a8-a52e-fddfe3b7a72b","timestamp":"2026-01-20T17:35:54.560Z"}
{"parentUuid":"aa497599-5867-40a8-a52e-fddfe3b7a72b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MWghQd1qkQ4kZqGPRQ3pvf","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo el problema. Cuando seleccionas solo \"Planes de créditos (IA)\" sin seleccionar \"Planes de selección\", el formulario te marca como obligatorios campos que pertenecen a la sección de planes de selección.\n\nDéjame revisar el archivo Blade completo para entender la estructura del formulario y las validaciones."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1559,"cache_read_input_tokens":41362,"cache_creation":{"ephemeral_5m_input_tokens":1559,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK2wknZJ61ookyyCReDH","type":"assistant","uuid":"ebfa1a36-f64f-48eb-b198-e6418f8b2a0e","timestamp":"2026-01-20T17:35:59.148Z"}
{"parentUuid":"ebfa1a36-f64f-48eb-b198-e6418f8b2a0e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MWghQd1qkQ4kZqGPRQ3pvf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0133L18s723Ceg8ui8g5s9Ry","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\resources\\views\\empresas\\paginas\\asignar-plan.blade.php"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":1559,"cache_read_input_tokens":41362,"cache_creation":{"ephemeral_5m_input_tokens":1559,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK2wknZJ61ookyyCReDH","type":"assistant","uuid":"4d3b2e48-285d-45e5-a841-b62f2168fc2c","timestamp":"2026-01-20T17:35:59.686Z"}
{"parentUuid":"4d3b2e48-285d-45e5-a841-b62f2168fc2c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0133L18s723Ceg8ui8g5s9Ry","type":"tool_result","content":"     1→@extends('layouts.app')\n     2→@php\n     3→    $titulo_pagina = isset($empresa_id) ? 'Asignar plan' : 'Facturar';\n     4→@endphp\n     5→@section('titulo', $titulo_pagina)\n     6→\n     7→@section('estilos')\n     8→    <link href=\"{{ asset('css/empresas/empresas.css') }}\" rel=\"stylesheet\">\n     9→@endsection\n    10→\n    11→@section('contenido')\n    12→    <div class=\"container-fluid mt-4\">\n    13→        <div class=\"text-headline-6 mb-0\">\n    14→            <i class=\"bi bi-chevron-left h4 mb-0 text-primary me-5 pointer\" onclick=\"window.history.back();\"></i>\n    15→            @if ($opcion == 'asignar')\n    16→                Asignar plan\n    17→            @elseif ($opcion == 'facturar')\n    18→                Facturar plan\n    19→            @elseif ($opcion == 'editar')\n    20→                Editar asignación de plan\n    21→            @endif\n    22→        </div>\n    23→    </div>\n    24→    <div class=\"container mt-8\">\n    25→        <form id=\"formulario\" enctype=\"multipart/form-data\">\n    26→            @csrf\n    27→            @isset ($empresa_id)\n    28→                <input type=\"hidden\" id=\"empresa_id\" name=\"empresa_id\" value=\"{{ $empresa_id }}\">\n    29→            @endisset\n    30→            @isset ($empresa_plan)\n    31→                <input type=\"hidden\" id=\"id\" name=\"id\" class=\"input-dinamico\" value=\"{{ $empresa_plan->id }}\">\n    32→            @endisset\n    33→            <input type=\"hidden\" id=\"pruebas\" name=\"pruebas\" value=\"\">\n    34→            <input type=\"hidden\" id=\"vigencia\" name=\"vigencia\">\n    35→            <input type=\"hidden\" id=\"unidades\" name=\"unidades\">\n    36→            <input type=\"hidden\" id=\"cantidad_ofertas_laborales\" name=\"cantidad_ofertas_laborales\">\n    37→            <input type=\"hidden\" id=\"cantidad_usuarios\" name=\"cantidad_usuarios\">\n    38→            <input type=\"hidden\" id=\"cantidad_pruebas\" name=\"cantidad_pruebas\">\n    39→            <input type=\"hidden\" id=\"plan_credito_id\" name=\"plan_credito_id\" value=\"\">\n    40→            <input type=\"hidden\" id=\"creditos\" name=\"creditos\" value=\"\">\n    41→            <input type=\"hidden\" id=\"funcionalidades\" name=\"funcionalidades\" value=\"\">\n    42→            <div class=\"row mt-6\">\n    43→                <div class=\"col-12\">\n    44→                    ${crearMultiselect({\n    45→                        opciones: [\n    46→                            { nombre: 'Planes de selección', id: '1' },\n    47→                            { nombre: 'Planes de créditos (IA)', id: '2' }\n    48→                        ],\n    49→                        id: 'tipo_prueba_id',\n    50→                        name: 'tipo_prueba_id',\n    51→                        class: 'clase-personalizada',\n    52→                        onchange: 'seleccionarTipoPruebaMultiple();',\n    53→                        placeholder: 'Tipo de plan',\n    54→                        icono: '<i class=\"bi bi-check-circle input-icono1\"></i>',\n    55→                        label: 'Tipo de plan',\n    56→                    })}\n    57→                </div>\n    58→            </div>\n    59→            <div class=\"row mt-3\">\n    60→                <div class=\"col-12\">\n    61→                    <div id=\"contenedor-plan\">\n    62→                    </div>\n    63→                </div>\n    64→                <div class=\"col-6\">\n    65→                    ${crearInput({\n    66→                        id: 'plan_id',\n    67→                        name: 'plan_id',\n    68→                        adicional: 'style=\"width: 0px; height: 0px;\"',\n    69→                        class: 'p-0 border-0',\n    70→                        required: true,\n    71→                        input_container_class: 'mb-0'\n    72→                    })}\n    73→                </div>\n    74→            </div>\n    75→            <div class=\"row mt-7 d-none\" id=\"seccion-pruebas\">\n    76→                <div class=\"col-12 mb-2\">\n    77→                    <h4 class=\"text-headline-4 mb-5\">Pruebas</h4>\n    78→                    <span class=\"text-body-2\">Selecciona las <span class=\"cantidad-pruebas\"></span> prueba(s) que vas a asignar a esta empresa.</span>\n    79→                </div>\n    80→                <div class=\"col-12 col-lg-6\">\n    81→                    <div class=\"row\" id=\"contenedor-pruebas\">\n    82→                    </div>\n    83→                </div>\n    84→            </div>\n    85→\n    86→            <div class=\"row mt-5 d-none\" id=\"alerta-pruebas\">\n    87→                <div class=\"col-12\">\n    88→                    ${crearAlerta(\n    89→                        'warning',\n    90→                        'Recuerda que solo tienes <span class=\"cantidad-pruebas\">{{ $empresa_plan->cantidad_pruebas ?? ''}}</span> prueba(s) disponibles.',\n    91→                        'w-100 mb-0'\n    92→                    )}\n    93→                </div>\n    94→            </div>\n    95→            \n    96→            <div class=\"row mt-3\">\n    97→                <div class=\"col-12\">\n    98→                    <div id=\"contenedor-creditos\">\n    99→                    </div>\n   100→                </div>\n   101→            </div>\n   102→\n   103→            <div class=\"row mt-7\">\n   104→                <div class=\"col-12 mt-5 mb-4\">\n   105→                    <h4 class=\"text-headline-4\">Valor</h4>\n   106→                    <span class=\"text-body-2\">Asignar un valor final de la venta, un descuento si aplica y adjunta la factura.</span>\n   107→                </div>\n   108→                <div class=\"col-6\">\n   109→                    ${crearInput({\n   110→                        id: 'porcentaje_descuento',\n   111→                        name: 'porcentaje_descuento',\n   112→                        type: 'number',\n   113→                        autocomplete: 'off',\n   114→                        max: 100,\n   115→                        value: '{{ isset($empresa_plan) ? $empresa_plan->porcentaje_descuento : '' }}',\n   116→                        label: 'Porcentaje de descuento',\n   117→                        label_class: 'optional'\n   118→                    })}\n   119→                </div>\n   120→                <div class=\"col-6\">\n   121→                    ${crearInput({\n   122→                        id: 'precio',\n   123→                        name: 'precio',\n   124→                        class: 'cleave',\n   125→                        autocomplete: 'off',\n   126→                        minlength: 3,\n   127→                        maxlength: 12,\n   128→                        value: '{{ isset($empresa_plan) ? $empresa_plan->precio : '' }}',\n   129→                        required: true,\n   130→                        label: 'Valor de venta'\n   131→                    })}\n   132→                </div>\n   133→            </div>\n   134→\n   135→            <div class=\"row mt-3\">\n   136→                <div class=\"col-6\">\n   137→                    ${crearInput({\n   138→                        id: 'numero_factura',\n   139→                        name: 'numero_factura',\n   140→                        type: 'text',\n   141→                        autocomplete: 'off',\n   142→                        maxlength: 12,\n   143→                        value: '{{ isset($empresa_plan) ? $empresa_plan->numero_factura : '' }}',\n   144→                        required: true,\n   145→                        label: 'Número de factura o concepto'\n   146→                    })}\n   147→                </div>\n   148→                <div class=\"col-6\">\n   149→                    @if ($opcion == 'editar' && isset($empresa_plan['archivos'][0]))\n   150→                        <div class=\"card h-auto border-secondary\">\n   151→                            <div class=\"card-body p-2 rounded-4\">\n   152→                                ${crearBoton({\n   153→                                    url: '#',\n   154→                                    clases: 'w-100 d-flex justify-content-between pointer bg-transparent border-0 p-0',\n   155→                                    texto: `\n   156→                                        <div class=\"px-4 text-cta-blue text-decoration-none\">\n   157→                                            {{$empresa_plan['archivos'][0]['nombre']}}\n   158→                                        </div>\n   159→                                        <div class=\"px-4\">\n   160→                                            <i class=\"bi bi-eye-fill text-cta-blue\"></i>\n   161→                                        </div>\n   162→                                    `,\n   163→                                    onclick: `abrirFacturaPlan('{{$empresa_plan['archivos'][0]['id']}}')`\n   164→                                })}\n   165→                            </div>\n   166→                        </div>\n   167→                    @else\n   168→                        ${crearInputFile({\n   169→                            id: 'factura',\n   170→                            name: 'factura',\n   171→                            class: 'input-form',\n   172→                            placeholder: '',\n   173→                            required: false,\n   174→                            accept: 'application/pdf',\n   175→                        })}\n   176→                    @endif\n   177→                </div>\n   178→            </div>\n   179→\n   180→            <div class=\"row mt-3\">\n   181→                <div class=\"col-12\">\n   182→                    ${crearTextarea({\n   183→                        id: 'comentario',\n   184→                        name: 'comentario',\n   185→                        maxlength: 255,\n   186→                        value: '{{ isset($empresa_plan) ? $empresa_plan->comentario : '' }}',\n   187→                        label: 'Comentario o detalle de uso',\n   188→                        label_class: 'optional'\n   189→                    })}\n   190→                </div>\n   191→            </div>\n   192→\n   193→            @if ($opcion == 'asignar')\n   194→                <div class=\"row mt-3\">\n   195→                    <div class=\"col-12 mt-5 mb-4\">\n   196→                        <h4 class=\"text-headline-4\">Usuario que está asignando el plan: </h4>\n   197→                        <span class=\"text-body-2\">{{ Auth::user()->nombre_completo }}</span>\n   198→                    </div>\n   199→                </div>\n   200→            @endif\n   201→\n   202→            <div class=\"row mt-3\">\n   203→                <div class=\"col-12 text-center\">\n   204→                    ${crearBoton({\n   205→                        type: 'button',\n   206→                        clases: 'btn-outline-primary me-2 px-14 text-blue-40',\n   207→                        texto: 'Cancelar',\n   208→                        url: `/empresas-gestionar/{{ isset($empresa_id) ? $empresa_id : '' }}`\n   209→                    })}\n   210→                    ${crearBoton({\n   211→                        id: `boton-asignar`,\n   212→                        type: `submit`,\n   213→                        clases: `btn-primary px-12`,\n   214→                        texto: `@if ($opcion == \"asignar\") Asignar plan @elseif ($opcion == \"facturar\") Guardar @elseif ($opcion == \"editar\") Guardar @endif`\n   215→                    })}\n   216→                </div>\n   217→            </div>\n   218→        </form>\n   219→    </div>\n   220→@section('modals')\n   221→    ${crearModal({\n   222→        id: 'modal-planes',\n   223→        adiconales_modals_header: 'tabindex=\"-1\" aria-labelledby=\"modal-planesLabel\" aria-hidden=\"true\"',\n   224→        dialog_class: 'modal-lg',\n   225→        titulo_header: 'Elegir plan',\n   226→        modal_body: `\n   227→            <div class=\"col-12\">\n   228→                <div class=\"row m-0 w-100\">\n   229→                    <div class=\"col-12 col-md-6 col-lg-4 px-3\">\n   230→                        <div class=\"input-container input-icon mb-0\" id=\"input-busqueda\">\n   231→                            <i class=\"bi bi-search\"></i>\n   232→                        </div>\n   233→                    </div>\n   234→                    <div class=\"col-12 col-md-6 col-lg-4 col-xl-3\">\n   235→                        ${crearSelect2({\n   236→                            id: 'filtro-plan',\n   237→                            name: 'filtro-plan',\n   238→                            class: 'select2-filtro',\n   239→                            onchange: 'mostrarPlanes();',\n   240→                            opciones: [\n   241→                                { nombre: 'Todos', id: 'Todos' },\n   242→                                { nombre: 'Por vacantes', id: 'Ofertas' },\n   243→                                { nombre: 'Por unidades', id: 'Unidades' },\n   244→                                { nombre: 'Por tiempo', id: 'Tiempo' }\n   245→                            ],\n   246→                            input_container_class: 'mb-0',\n   247→                            opcion_vacia: false\n   248→                        })}\n   249→                    </div>\n   250→                </div>\n   251→                <div class=\"table-responsive w-100\" id=\"tabla-responsive-planes\">\n   252→                    <table class=\"table table-borderless w-100\" id=\"tabla-planes\">\n   253→                        <thead class=\"d-none\">\n   254→                            <tr>\n   255→                                <th></th>\n   256→                            </tr>\n   257→                        </thead>\n   258→                        <tbody id=\"tbody-planes\">\n   259→                        </tbody>\n   260→                    </table>\n   261→                </div>\n   262→            </div>\n   263→        `\n   264→    })}\n   265→    ${crearModal({\n   266→        id: 'modal-modificar-planes',\n   267→        adiconales_modals_header: 'data-bs-backdrop=\"static\" tabindex=\"-1\" aria-labelledby=\"modal-modificar-planesLabel\" aria-hidden=\"true\"',\n   268→        dialog_class: 'modal-md',\n   269→        titulo_header: 'Modificar plan - <span id=\"nombre-plan-modal\">{{ isset($empresa_plan) ? \" \" . $empresa_plan->plan->nombre : \"\" }}</span>',\n   270→        modal_body_class: 'pt-0',\n   271→        modal_body: `\n   272→            <div class=\"col-12 px-4 mb-5\">\n   273→                <span class=\"text-body-2\">Personaliza tu plan para esta empresa.</span>\n   274→            </div>\n   275→            <div class=\"row m-0 w-100\">\n   276→                <div class=\"col-12\" id=\"input-container-pruebas\">\n   277→                    ${crearSelect2({\n   278→                        id: 'cantidad_pruebas_modal',\n   279→                        name: 'cantidad_pruebas_modal',\n   280→                        class: 'select2-filtro',\n   281→                        onchange: 'habilitarBotonGuardar();',\n   282→                        opciones: [\n   283→                            { nombre: '', id: '' },\n   284→                            @if (isset($empresa_plan))\n   285→                                @for ($i = 1; $i <= 8; $i++)\n   286→                                    { nombre: '{{ $i }} Pruebas', id: '{{ $i }}', selected: {{ $empresa_plan->cantidad_pruebas == $i ? 'true' : 'false' }} },\n   287→                                @endfor\n   288→                            @endif\n   289→                        ],\n   290→                        label: 'Pruebas disponibles'\n   291→                    })}\n   292→                </div>\n   293→                <div class=\"col-12 col-md-6\" id=\"input-container-tiempo\">\n   294→                    ${crearSelect2({\n   295→                        id: 'tiempo_modal',\n   296→                        name: 'tiempo_modal',\n   297→                        class: 'select2-filtro',\n   298→                        onchange: 'habilitarBotonGuardar(); seleccionarTiempo(this.value);',\n   299→                        opciones: [\n   300→                            { nombre: 'Seleccione', id: '' },\n   301→                            { nombre: '3 Meses', id: '90', selected: {{ isset($empresa_plan) && $empresa_plan->plan->vigencia == 90 ? 'true' : 'false' }} },\n   302→                            { nombre: '6 Meses', id: '180', selected: {{ isset($empresa_plan) && $empresa_plan->plan->vigencia == 180 ? 'true' : 'false' }} },\n   303→                            { nombre: '1 Año', id: '365', selected: {{ isset($empresa_plan) && $empresa_plan->plan->vigencia == 365 ? 'true' : 'false' }} },\n   304→                            { nombre: 'Personalizado', id: 'personalizado' }\n   305→                        ],\n   306→                        label: 'Tiempo'\n   307→                    })}\n   308→                </div>\n   309→                <div class=\"col-12 col-md-6 d-none\" id=\"input-container-vigencia\">\n   310→                    ${crearInput({\n   311→                        id: 'vigencia_modal',\n   312→                        name: 'vigencia_modal',\n   313→                        class: 'solo-numeros',\n   314→                        autocomplete: 'off',\n   315→                        max: 1000000,\n   316→                        onkeyup: 'habilitarBotonGuardar();',\n   317→                        label: 'Días'\n   318→                    })}\n   319→                </div>\n   320→                <div class=\"col-12 col-md-6\">\n   321→                    ${crearInput({\n   322→                        id: 'unidades_modal',\n   323→                        name: 'unidades_modal',\n   324→                        class: 'solo-numeros',\n   325→                        autocomplete: 'off',\n   326→                        max: 1000000,\n   327→                        value: '{{ isset($empresa_plan) ? $empresa_plan->unidades : '' }}',\n   328→                        onkeyup: 'habilitarBotonGuardar();',\n   329→                        disabled: {{ !(isset($empresa_plan) && ($empresa_plan->unidades != null || $empresa_plan->cantidad_ofertas_laborales != null)) ? 'true' : 'false' }},\n   330→                        label: 'Unidades <span class=\"texto-label-tiempo\"></span>'\n   331→                    })}\n   332→                </div>\n   333→                <div class=\"col-12 col-md-6\">\n   334→                    ${crearInput({\n   335→                        id: 'cantidad_ofertas_laborales_modal',\n   336→                        name: 'cantidad_ofertas_laborales_modal',\n   337→                        class: 'solo-numeros',\n   338→                        autocomplete: 'off',\n   339→                        max: 1000000,\n   340→                        value: '{{ isset($empresa_plan) ? $empresa_plan->cantidad_ofertas_laborales : '' }}',\n   341→                        onkeyup: 'habilitarBotonGuardar();',\n   342→                        disabled: {{ !(isset($empresa_plan) && ($empresa_plan->unidades != null || $empresa_plan->cantidad_ofertas_laborales != null)) ? 'true' : 'false' }},\n   343→                        label: 'Vacantes <span class=\"texto-label-tiempo\"></span>'\n   344→                    })}\n   345→                </div>\n   346→                <div class=\"col-12 mb-2\">\n   347→                    <h4 class=\"text-headline-4\">Beneficios</h4>\n   348→                </div>\n   349→                <div class=\"col-12 col-md-6\">\n   350→                    <div class=\"input-container\">\n   351→                        <select class=\"multiselect rounded-2 text-body-2\" multiple=\"multiple\" id=\"adicionales_modal\" name=\"adicionales_modal[]\" data-placeholder=\"Adicionales\" onchange=\"habilitarBotonGuardar();\"></select>\n   352→                    </div>\n   353→                </div>\n   354→                <div class=\"col-12 col-md-6\">\n   355→                    <div class=\"input-container\">\n   356→                        <select class=\"multiselect rounded-2 text-body-2\" multiple=\"multiple\" id=\"predefinidos_modal\" name=\"predefinidos_modal[]\" data-placeholder=\"Predefinidos\" onchange=\"habilitarBotonGuardar();\"></select>\n   357→                    </div>\n   358→                </div>\n   359→                <div class=\"col-12\">\n   360→                    ${crearInput({\n   361→                        id: 'cantidad_usuarios_modal',\n   362→                        name: 'cantidad_usuarios_modal',\n   363→                        type: 'number',\n   364→                        autocomplete: 'off',\n   365→                        max: 1000000,\n   366→                        value: '{{ isset($empresa_plan) ? $empresa_plan->cantidad_usuarios : '' }}',\n   367→                        onkeyup: 'habilitarBotonGuardar();',\n   368→                        label: 'Usuarios'\n   369→                    })}\n   370→                </div>\n   371→                <div class=\"col-12\">\n   372→                    <div class=\"alert badge-estado-renovado fw-bold\">\n   373→                        Recuerda que no es posible cambiar entre planes con cantidades fijas a ilimitados o viceversa.\n   374→                    </div>\n   375→                </div>\n   376→                <div class=\"col-12\">\n   377→                    <div class=\"row m-0 w-100\">\n   378→                        ${crearBoton({\n   379→                            type: 'button',\n   380→                            clases: 'col btn-outline-primary me-1 pt-2 text-center d-block',\n   381→                            texto: 'Cancelar',\n   382→                            onclick: 'cancelarEdicion();',\n   383→                            adicional: 'data-bs-dismiss=\"modal\" aria-label=\"Close\"'\n   384→                        })}\n   385→                        ${crearBoton({\n   386→                            id: 'boton-guardar-modificaciones',\n   387→                            type: 'button',\n   388→                            clases: 'col btn-primary ms-1 pt-2 text-center d-block',\n   389→                            texto: 'Guardar modificaciones',\n   390→                            onclick: 'abrirModalEstasSeguro();',\n   391→                            disabled: true\n   392→                        })}\n   393→                    </div>\n   394→                </div>\n   395→            </div>\n   396→            <div class=\"table-responsive w-100\" id=\"tabla-responsive-planes\">\n   397→                <table class=\"table table-borderless w-100\" id=\"tabla-planes\">\n   398→                    <thead class=\"d-none\">\n   399→                        <tr>\n   400→                            <th></th>\n   401→                        </tr>\n   402→                    </thead>\n   403→                    <tbody id=\"tbody-planes\">\n   404→                    </tbody>\n   405→                </table>\n   406→            </div>\n   407→        `\n   408→    })}\n   409→    ${crearModal({\n   410→        id: 'modal-estas-seguro',\n   411→        adiconales_modals_header: 'data-bs-backdrop=\"static\" tabindex=\"-1\" aria-labelledby=\"modal-estas-seguroLabel\" aria-hidden=\"true\"',\n   412→        dialog_class: 'modal-md',\n   413→        titulo_header: '¿Estás seguro?',\n   414→        modal_body_class: 'pt-0',\n   415→        modal_body: `\n   416→            <div class=\"col-12 px-4 mb-5\">\n   417→                <span class=\"text-body-2\">\n   418→                    se modificará el plan actual para la empresa, ten en cuenta que la información de consumo puede variar entre este plan modificado y los que no lo están pero tienen el mismo nombre.\n   419→                    <br>\n   420→                    <br>\n   421→                    Personaliza tu plan para esta empresa.\n   422→                </span>\n   423→            </div>\n   424→            <div class=\"col-12 px-4 mb-4 mt-3\">\n   425→                <div class=\"row m-0 w-100\">\n   426→                    ${crearBoton({\n   427→                        type: 'button',\n   428→                        clases: 'col btn-outline-primary me-1 pt-2 text-center d-block',\n   429→                        texto: 'Cancelar',\n   430→                        onclick: 'cancelarEdicion();',\n   431→                        adicional: 'data-bs-dismiss=\"modal\" aria-label=\"Close\"'\n   432→                    })}\n   433→                    ${crearBoton({\n   434→                        id: 'boton-estoy-seguro',\n   435→                        type: 'button',\n   436→                        clases: 'col btn-primary ms-1 pt-2 text-center d-block',\n   437→                        texto: 'Si, estoy seguro',\n   438→                        onclick: 'confirmarEdicion();'\n   439→                    })}\n   440→                </div>\n   441→            </div>\n   442→        `\n   443→    })}\n   444→    ${crearModal({\n   445→        id: 'modal-planes-creditos',\n   446→        adiconales_modals_header: 'tabindex=\"-1\" aria-labelledby=\"modal-planes-creditosLabel\" aria-hidden=\"true\"',\n   447→        dialog_class: 'modal-lg',\n   448→        titulo_header: 'Elegir Plan de Créditos IA',\n   449→        modal_body: `\n   450→            <div class=\"col-12\">\n   451→                <div class=\"row m-0 w-100 mb-3\">\n   452→                    <div class=\"col-12 col-md-6 col-lg-4 px-3\">\n   453→                        <div class=\"input-container input-icon mb-0\" id=\"input-busqueda-credito\">\n   454→                            <i class=\"bi bi-search\"></i>\n   455→                            <input type=\"text\" id=\"buscador-plan-credito\" class=\"rounded-2 text-body-2\" placeholder=\"Buscar\">\n   456→                        </div>\n   457→                    </div>\n   458→                    <div class=\"col-12 col-md-6 col-lg-4 col-xl-3\">\n   459→                        ${crearSelect2({\n   460→                            id: 'filtro-plan-credito',\n   461→                            name: 'filtro-plan-credito',\n   462→                            class: 'select2-filtro',\n   463→                            onchange: 'mostrarPlanesCreditos();',\n   464→                            opciones: [\n   465→                                { nombre: 'Mayor a menor', id: 'Mayor' },\n   466→                                { nombre: 'Menor a mayor', id: 'Menor' },\n   467→                            ],\n   468→                            input_container_class: 'mb-0',\n   469→                            opcion_vacia: false\n   470→                        })}\n   471→                    </div>\n   472→                </div>\n   473→                <div id=\"contenedor-planes-creditos\">\n   474→                    <!-- Los planes se cargarán dinámicamente aquí -->\n   475→                </div>\n   476→            </div>\n   477→        `\n   478→    })}\n   479→@endsection\n   480→@endsection\n   481→\n   482→@section('scripts')\n   483→    <script src=\"{{ asset('js/empresas/asignar-plan.js') }}\" type=\"text/javascript\"></script>\n   484→    <script type=\"text/javascript\">\n   485→        @if ($opcion == 'asignar')\n   486→            opcion = 'asignar';\n   487→            empresa = @json($empresa);\n   488→            resource_url = '/empresas-planes';\n   489→            plan_seleccionado = null;\n   490→        @elseif ($opcion == 'facturar')\n   491→            opcion = 'facturar';\n   492→            empresa = @json($empresa);\n   493→            resource_url = '/facturar-plan';\n   494→            empresa_plan = @json($empresa_plan);\n   495→            plan_seleccionado = @json($empresa_plan->plan);\n   496→            plan_seleccionado.cantidad_pruebas = empresa_plan.cantidad_pruebas;\n   497→            plan_seleccionado.cantidad_usuarios = empresa_plan.cantidad_usuarios;\n   498→            plan_seleccionado.unidades = empresa_plan.unidades\n   499→            plan_seleccionado.cantidad_ofertas_laborales = empresa_plan.cantidad_ofertas_laborales;\n   500→            plan_seleccionado.vigencia = empresa_plan.vigencia_dias;\n   501→            plan_seleccionado.precio = empresa_plan.precio;\n   502→            pruebas_empresa_plan = @json($empresa_plan->pruebas);\n   503→\n   504→            @if(isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n   505→                plan_creditos_seleccionado = @json($empresa_plan->planCredito);\n   506→            @endif\n   507→\n   508→            // Determinar los tipos de prueba a seleccionar\n   509→            let tipos_a_seleccionar_facturar = ['{{$empresa_plan->plan->tipoPrueba->id}}'];\n   510→            @if(isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n   511→                tipos_a_seleccionar_facturar.push('2');\n   512→            @endif\n   513→\n   514→            // Establecer los tipos de prueba en el select\n   515→            $('#tipo_prueba_id').val(tipos_a_seleccionar_facturar).trigger('change');\n   516→\n   517→            seleccionarTipoPruebaMultiple();\n   518→            buscarfuncionalidades('{{$empresa_plan->plan->tipoPrueba->id}}');\n   519→\n   520→            // Esperar a que el DOM esté listo para establecer valores\n   521→            $(document).ready(function() {\n   522→                @if(isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n   523→                    $('#plan_credito_id').val('{{ $empresa_plan->plan_credito_id }}');\n   524→                    $('#creditos').val('{{ $empresa_plan->creditos }}');\n   525→\n   526→                    // Dar tiempo para que se cargue seleccionarTipoPruebaMultiple() y sus AJAX\n   527→                    setTimeout(function() {\n   528→                        if (plan_creditos_seleccionado && plan_creditos_seleccionado.id) {\n   529→                            mostrarPlanCreditosSeleccionado();\n   530→                        }\n   531→                    }, 1000);\n   532→                @endif\n   533→            });\n   534→        @elseif ($opcion == 'editar')\n   535→            opcion = 'editar';\n   536→            empresa = @json($empresa);\n   537→            resource_url = '/empresas-planes';\n   538→            empresa_plan = @json($empresa_plan);\n   539→\n   540→            // Obtener el tipo de edición desde la URL\n   541→            let tipo_edicion = '{{ request()->get(\"tipo\", \"seleccion\") }}';\n   542→\n   543→            @if(request()->get('tipo') == 'creditos' && isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n   544→                // Editar plan de créditos\n   545→                plan_creditos_seleccionado = @json($empresa_plan->planCredito);\n   546→                plan_creditos_seleccionado.creditos = empresa_plan.creditos;\n   547→                plan_seleccionado = null;\n   548→                pruebas_empresa_plan = [];\n   549→\n   550→                // Establecer tipo 2 (créditos) en el select\n   551→                $('#tipo_prueba_id').val(['2']).trigger('change');\n   552→\n   553→                $(document).ready(function() {\n   554→                    $('#plan_credito_id').val('{{ $empresa_plan->plan_credito_id }}');\n   555→                    $('#creditos').val('{{ $empresa_plan->creditos }}');\n   556→\n   557→                    setTimeout(function() {\n   558→                        if (plan_creditos_seleccionado && plan_creditos_seleccionado.id) {\n   559→                            mostrarPlanCreditosSeleccionado();\n   560→                        }\n   561→                    }, 500);\n   562→                });\n   563→            @else\n   564→                // Editar plan de selección\n   565→                plan_seleccionado = @json($empresa_plan->plan);\n   566→                plan_seleccionado.cantidad_pruebas = empresa_plan.cantidad_pruebas;\n   567→                plan_seleccionado.cantidad_usuarios = empresa_plan.cantidad_usuarios;\n   568→                plan_seleccionado.unidades = empresa_plan.unidades\n   569→                plan_seleccionado.cantidad_ofertas_laborales = empresa_plan.cantidad_ofertas_laborales;\n   570→                plan_seleccionado.vigencia = empresa_plan.vigencia_dias;\n   571→                plan_seleccionado.precio = empresa_plan.precio;\n   572→                pruebas_empresa_plan = @json($empresa_plan->pruebas);\n   573→\n   574→                // Establecer tipo de selección en el select\n   575→                let tipos_a_seleccionar = ['{{$empresa_plan->plan->tipoPrueba->id}}'];\n   576→                $('#tipo_prueba_id').val(tipos_a_seleccionar).trigger('change');\n   577→\n   578→                seleccionarTipoPruebaMultiple();\n   579→                buscarfuncionalidades('{{$empresa_plan->plan->tipoPrueba->id}}');\n   580→            @endif\n   581→        @endif\n   582→    </script>\n   583→@endsection\n   584→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8f39138b-d6a6-4dcf-8421-bc10bff62e67","timestamp":"2026-01-20T17:36:01.157Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\resources\\views\\empresas\\paginas\\asignar-plan.blade.php","content":"@extends('layouts.app')\n@php\n    $titulo_pagina = isset($empresa_id) ? 'Asignar plan' : 'Facturar';\n@endphp\n@section('titulo', $titulo_pagina)\n\n@section('estilos')\n    <link href=\"{{ asset('css/empresas/empresas.css') }}\" rel=\"stylesheet\">\n@endsection\n\n@section('contenido')\n    <div class=\"container-fluid mt-4\">\n        <div class=\"text-headline-6 mb-0\">\n            <i class=\"bi bi-chevron-left h4 mb-0 text-primary me-5 pointer\" onclick=\"window.history.back();\"></i>\n            @if ($opcion == 'asignar')\n                Asignar plan\n            @elseif ($opcion == 'facturar')\n                Facturar plan\n            @elseif ($opcion == 'editar')\n                Editar asignación de plan\n            @endif\n        </div>\n    </div>\n    <div class=\"container mt-8\">\n        <form id=\"formulario\" enctype=\"multipart/form-data\">\n            @csrf\n            @isset ($empresa_id)\n                <input type=\"hidden\" id=\"empresa_id\" name=\"empresa_id\" value=\"{{ $empresa_id }}\">\n            @endisset\n            @isset ($empresa_plan)\n                <input type=\"hidden\" id=\"id\" name=\"id\" class=\"input-dinamico\" value=\"{{ $empresa_plan->id }}\">\n            @endisset\n            <input type=\"hidden\" id=\"pruebas\" name=\"pruebas\" value=\"\">\n            <input type=\"hidden\" id=\"vigencia\" name=\"vigencia\">\n            <input type=\"hidden\" id=\"unidades\" name=\"unidades\">\n            <input type=\"hidden\" id=\"cantidad_ofertas_laborales\" name=\"cantidad_ofertas_laborales\">\n            <input type=\"hidden\" id=\"cantidad_usuarios\" name=\"cantidad_usuarios\">\n            <input type=\"hidden\" id=\"cantidad_pruebas\" name=\"cantidad_pruebas\">\n            <input type=\"hidden\" id=\"plan_credito_id\" name=\"plan_credito_id\" value=\"\">\n            <input type=\"hidden\" id=\"creditos\" name=\"creditos\" value=\"\">\n            <input type=\"hidden\" id=\"funcionalidades\" name=\"funcionalidades\" value=\"\">\n            <div class=\"row mt-6\">\n                <div class=\"col-12\">\n                    ${crearMultiselect({\n                        opciones: [\n                            { nombre: 'Planes de selección', id: '1' },\n                            { nombre: 'Planes de créditos (IA)', id: '2' }\n                        ],\n                        id: 'tipo_prueba_id',\n                        name: 'tipo_prueba_id',\n                        class: 'clase-personalizada',\n                        onchange: 'seleccionarTipoPruebaMultiple();',\n                        placeholder: 'Tipo de plan',\n                        icono: '<i class=\"bi bi-check-circle input-icono1\"></i>',\n                        label: 'Tipo de plan',\n                    })}\n                </div>\n            </div>\n            <div class=\"row mt-3\">\n                <div class=\"col-12\">\n                    <div id=\"contenedor-plan\">\n                    </div>\n                </div>\n                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'plan_id',\n                        name: 'plan_id',\n                        adicional: 'style=\"width: 0px; height: 0px;\"',\n                        class: 'p-0 border-0',\n                        required: true,\n                        input_container_class: 'mb-0'\n                    })}\n                </div>\n            </div>\n            <div class=\"row mt-7 d-none\" id=\"seccion-pruebas\">\n                <div class=\"col-12 mb-2\">\n                    <h4 class=\"text-headline-4 mb-5\">Pruebas</h4>\n                    <span class=\"text-body-2\">Selecciona las <span class=\"cantidad-pruebas\"></span> prueba(s) que vas a asignar a esta empresa.</span>\n                </div>\n                <div class=\"col-12 col-lg-6\">\n                    <div class=\"row\" id=\"contenedor-pruebas\">\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"row mt-5 d-none\" id=\"alerta-pruebas\">\n                <div class=\"col-12\">\n                    ${crearAlerta(\n                        'warning',\n                        'Recuerda que solo tienes <span class=\"cantidad-pruebas\">{{ $empresa_plan->cantidad_pruebas ?? ''}}</span> prueba(s) disponibles.',\n                        'w-100 mb-0'\n                    )}\n                </div>\n            </div>\n            \n            <div class=\"row mt-3\">\n                <div class=\"col-12\">\n                    <div id=\"contenedor-creditos\">\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"row mt-7\">\n                <div class=\"col-12 mt-5 mb-4\">\n                    <h4 class=\"text-headline-4\">Valor</h4>\n                    <span class=\"text-body-2\">Asignar un valor final de la venta, un descuento si aplica y adjunta la factura.</span>\n                </div>\n                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'porcentaje_descuento',\n                        name: 'porcentaje_descuento',\n                        type: 'number',\n                        autocomplete: 'off',\n                        max: 100,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->porcentaje_descuento : '' }}',\n                        label: 'Porcentaje de descuento',\n                        label_class: 'optional'\n                    })}\n                </div>\n                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'precio',\n                        name: 'precio',\n                        class: 'cleave',\n                        autocomplete: 'off',\n                        minlength: 3,\n                        maxlength: 12,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->precio : '' }}',\n                        required: true,\n                        label: 'Valor de venta'\n                    })}\n                </div>\n            </div>\n\n            <div class=\"row mt-3\">\n                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'numero_factura',\n                        name: 'numero_factura',\n                        type: 'text',\n                        autocomplete: 'off',\n                        maxlength: 12,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->numero_factura : '' }}',\n                        required: true,\n                        label: 'Número de factura o concepto'\n                    })}\n                </div>\n                <div class=\"col-6\">\n                    @if ($opcion == 'editar' && isset($empresa_plan['archivos'][0]))\n                        <div class=\"card h-auto border-secondary\">\n                            <div class=\"card-body p-2 rounded-4\">\n                                ${crearBoton({\n                                    url: '#',\n                                    clases: 'w-100 d-flex justify-content-between pointer bg-transparent border-0 p-0',\n                                    texto: `\n                                        <div class=\"px-4 text-cta-blue text-decoration-none\">\n                                            {{$empresa_plan['archivos'][0]['nombre']}}\n                                        </div>\n                                        <div class=\"px-4\">\n                                            <i class=\"bi bi-eye-fill text-cta-blue\"></i>\n                                        </div>\n                                    `,\n                                    onclick: `abrirFacturaPlan('{{$empresa_plan['archivos'][0]['id']}}')`\n                                })}\n                            </div>\n                        </div>\n                    @else\n                        ${crearInputFile({\n                            id: 'factura',\n                            name: 'factura',\n                            class: 'input-form',\n                            placeholder: '',\n                            required: false,\n                            accept: 'application/pdf',\n                        })}\n                    @endif\n                </div>\n            </div>\n\n            <div class=\"row mt-3\">\n                <div class=\"col-12\">\n                    ${crearTextarea({\n                        id: 'comentario',\n                        name: 'comentario',\n                        maxlength: 255,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->comentario : '' }}',\n                        label: 'Comentario o detalle de uso',\n                        label_class: 'optional'\n                    })}\n                </div>\n            </div>\n\n            @if ($opcion == 'asignar')\n                <div class=\"row mt-3\">\n                    <div class=\"col-12 mt-5 mb-4\">\n                        <h4 class=\"text-headline-4\">Usuario que está asignando el plan: </h4>\n                        <span class=\"text-body-2\">{{ Auth::user()->nombre_completo }}</span>\n                    </div>\n                </div>\n            @endif\n\n            <div class=\"row mt-3\">\n                <div class=\"col-12 text-center\">\n                    ${crearBoton({\n                        type: 'button',\n                        clases: 'btn-outline-primary me-2 px-14 text-blue-40',\n                        texto: 'Cancelar',\n                        url: `/empresas-gestionar/{{ isset($empresa_id) ? $empresa_id : '' }}`\n                    })}\n                    ${crearBoton({\n                        id: `boton-asignar`,\n                        type: `submit`,\n                        clases: `btn-primary px-12`,\n                        texto: `@if ($opcion == \"asignar\") Asignar plan @elseif ($opcion == \"facturar\") Guardar @elseif ($opcion == \"editar\") Guardar @endif`\n                    })}\n                </div>\n            </div>\n        </form>\n    </div>\n@section('modals')\n    ${crearModal({\n        id: 'modal-planes',\n        adiconales_modals_header: 'tabindex=\"-1\" aria-labelledby=\"modal-planesLabel\" aria-hidden=\"true\"',\n        dialog_class: 'modal-lg',\n        titulo_header: 'Elegir plan',\n        modal_body: `\n            <div class=\"col-12\">\n                <div class=\"row m-0 w-100\">\n                    <div class=\"col-12 col-md-6 col-lg-4 px-3\">\n                        <div class=\"input-container input-icon mb-0\" id=\"input-busqueda\">\n                            <i class=\"bi bi-search\"></i>\n                        </div>\n                    </div>\n                    <div class=\"col-12 col-md-6 col-lg-4 col-xl-3\">\n                        ${crearSelect2({\n                            id: 'filtro-plan',\n                            name: 'filtro-plan',\n                            class: 'select2-filtro',\n                            onchange: 'mostrarPlanes();',\n                            opciones: [\n                                { nombre: 'Todos', id: 'Todos' },\n                                { nombre: 'Por vacantes', id: 'Ofertas' },\n                                { nombre: 'Por unidades', id: 'Unidades' },\n                                { nombre: 'Por tiempo', id: 'Tiempo' }\n                            ],\n                            input_container_class: 'mb-0',\n                            opcion_vacia: false\n                        })}\n                    </div>\n                </div>\n                <div class=\"table-responsive w-100\" id=\"tabla-responsive-planes\">\n                    <table class=\"table table-borderless w-100\" id=\"tabla-planes\">\n                        <thead class=\"d-none\">\n                            <tr>\n                                <th></th>\n                            </tr>\n                        </thead>\n                        <tbody id=\"tbody-planes\">\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        `\n    })}\n    ${crearModal({\n        id: 'modal-modificar-planes',\n        adiconales_modals_header: 'data-bs-backdrop=\"static\" tabindex=\"-1\" aria-labelledby=\"modal-modificar-planesLabel\" aria-hidden=\"true\"',\n        dialog_class: 'modal-md',\n        titulo_header: 'Modificar plan - <span id=\"nombre-plan-modal\">{{ isset($empresa_plan) ? \" \" . $empresa_plan->plan->nombre : \"\" }}</span>',\n        modal_body_class: 'pt-0',\n        modal_body: `\n            <div class=\"col-12 px-4 mb-5\">\n                <span class=\"text-body-2\">Personaliza tu plan para esta empresa.</span>\n            </div>\n            <div class=\"row m-0 w-100\">\n                <div class=\"col-12\" id=\"input-container-pruebas\">\n                    ${crearSelect2({\n                        id: 'cantidad_pruebas_modal',\n                        name: 'cantidad_pruebas_modal',\n                        class: 'select2-filtro',\n                        onchange: 'habilitarBotonGuardar();',\n                        opciones: [\n                            { nombre: '', id: '' },\n                            @if (isset($empresa_plan))\n                                @for ($i = 1; $i <= 8; $i++)\n                                    { nombre: '{{ $i }} Pruebas', id: '{{ $i }}', selected: {{ $empresa_plan->cantidad_pruebas == $i ? 'true' : 'false' }} },\n                                @endfor\n                            @endif\n                        ],\n                        label: 'Pruebas disponibles'\n                    })}\n                </div>\n                <div class=\"col-12 col-md-6\" id=\"input-container-tiempo\">\n                    ${crearSelect2({\n                        id: 'tiempo_modal',\n                        name: 'tiempo_modal',\n                        class: 'select2-filtro',\n                        onchange: 'habilitarBotonGuardar(); seleccionarTiempo(this.value);',\n                        opciones: [\n                            { nombre: 'Seleccione', id: '' },\n                            { nombre: '3 Meses', id: '90', selected: {{ isset($empresa_plan) && $empresa_plan->plan->vigencia == 90 ? 'true' : 'false' }} },\n                            { nombre: '6 Meses', id: '180', selected: {{ isset($empresa_plan) && $empresa_plan->plan->vigencia == 180 ? 'true' : 'false' }} },\n                            { nombre: '1 Año', id: '365', selected: {{ isset($empresa_plan) && $empresa_plan->plan->vigencia == 365 ? 'true' : 'false' }} },\n                            { nombre: 'Personalizado', id: 'personalizado' }\n                        ],\n                        label: 'Tiempo'\n                    })}\n                </div>\n                <div class=\"col-12 col-md-6 d-none\" id=\"input-container-vigencia\">\n                    ${crearInput({\n                        id: 'vigencia_modal',\n                        name: 'vigencia_modal',\n                        class: 'solo-numeros',\n                        autocomplete: 'off',\n                        max: 1000000,\n                        onkeyup: 'habilitarBotonGuardar();',\n                        label: 'Días'\n                    })}\n                </div>\n                <div class=\"col-12 col-md-6\">\n                    ${crearInput({\n                        id: 'unidades_modal',\n                        name: 'unidades_modal',\n                        class: 'solo-numeros',\n                        autocomplete: 'off',\n                        max: 1000000,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->unidades : '' }}',\n                        onkeyup: 'habilitarBotonGuardar();',\n                        disabled: {{ !(isset($empresa_plan) && ($empresa_plan->unidades != null || $empresa_plan->cantidad_ofertas_laborales != null)) ? 'true' : 'false' }},\n                        label: 'Unidades <span class=\"texto-label-tiempo\"></span>'\n                    })}\n                </div>\n                <div class=\"col-12 col-md-6\">\n                    ${crearInput({\n                        id: 'cantidad_ofertas_laborales_modal',\n                        name: 'cantidad_ofertas_laborales_modal',\n                        class: 'solo-numeros',\n                        autocomplete: 'off',\n                        max: 1000000,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->cantidad_ofertas_laborales : '' }}',\n                        onkeyup: 'habilitarBotonGuardar();',\n                        disabled: {{ !(isset($empresa_plan) && ($empresa_plan->unidades != null || $empresa_plan->cantidad_ofertas_laborales != null)) ? 'true' : 'false' }},\n                        label: 'Vacantes <span class=\"texto-label-tiempo\"></span>'\n                    })}\n                </div>\n                <div class=\"col-12 mb-2\">\n                    <h4 class=\"text-headline-4\">Beneficios</h4>\n                </div>\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"input-container\">\n                        <select class=\"multiselect rounded-2 text-body-2\" multiple=\"multiple\" id=\"adicionales_modal\" name=\"adicionales_modal[]\" data-placeholder=\"Adicionales\" onchange=\"habilitarBotonGuardar();\"></select>\n                    </div>\n                </div>\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"input-container\">\n                        <select class=\"multiselect rounded-2 text-body-2\" multiple=\"multiple\" id=\"predefinidos_modal\" name=\"predefinidos_modal[]\" data-placeholder=\"Predefinidos\" onchange=\"habilitarBotonGuardar();\"></select>\n                    </div>\n                </div>\n                <div class=\"col-12\">\n                    ${crearInput({\n                        id: 'cantidad_usuarios_modal',\n                        name: 'cantidad_usuarios_modal',\n                        type: 'number',\n                        autocomplete: 'off',\n                        max: 1000000,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->cantidad_usuarios : '' }}',\n                        onkeyup: 'habilitarBotonGuardar();',\n                        label: 'Usuarios'\n                    })}\n                </div>\n                <div class=\"col-12\">\n                    <div class=\"alert badge-estado-renovado fw-bold\">\n                        Recuerda que no es posible cambiar entre planes con cantidades fijas a ilimitados o viceversa.\n                    </div>\n                </div>\n                <div class=\"col-12\">\n                    <div class=\"row m-0 w-100\">\n                        ${crearBoton({\n                            type: 'button',\n                            clases: 'col btn-outline-primary me-1 pt-2 text-center d-block',\n                            texto: 'Cancelar',\n                            onclick: 'cancelarEdicion();',\n                            adicional: 'data-bs-dismiss=\"modal\" aria-label=\"Close\"'\n                        })}\n                        ${crearBoton({\n                            id: 'boton-guardar-modificaciones',\n                            type: 'button',\n                            clases: 'col btn-primary ms-1 pt-2 text-center d-block',\n                            texto: 'Guardar modificaciones',\n                            onclick: 'abrirModalEstasSeguro();',\n                            disabled: true\n                        })}\n                    </div>\n                </div>\n            </div>\n            <div class=\"table-responsive w-100\" id=\"tabla-responsive-planes\">\n                <table class=\"table table-borderless w-100\" id=\"tabla-planes\">\n                    <thead class=\"d-none\">\n                        <tr>\n                            <th></th>\n                        </tr>\n                    </thead>\n                    <tbody id=\"tbody-planes\">\n                    </tbody>\n                </table>\n            </div>\n        `\n    })}\n    ${crearModal({\n        id: 'modal-estas-seguro',\n        adiconales_modals_header: 'data-bs-backdrop=\"static\" tabindex=\"-1\" aria-labelledby=\"modal-estas-seguroLabel\" aria-hidden=\"true\"',\n        dialog_class: 'modal-md',\n        titulo_header: '¿Estás seguro?',\n        modal_body_class: 'pt-0',\n        modal_body: `\n            <div class=\"col-12 px-4 mb-5\">\n                <span class=\"text-body-2\">\n                    se modificará el plan actual para la empresa, ten en cuenta que la información de consumo puede variar entre este plan modificado y los que no lo están pero tienen el mismo nombre.\n                    <br>\n                    <br>\n                    Personaliza tu plan para esta empresa.\n                </span>\n            </div>\n            <div class=\"col-12 px-4 mb-4 mt-3\">\n                <div class=\"row m-0 w-100\">\n                    ${crearBoton({\n                        type: 'button',\n                        clases: 'col btn-outline-primary me-1 pt-2 text-center d-block',\n                        texto: 'Cancelar',\n                        onclick: 'cancelarEdicion();',\n                        adicional: 'data-bs-dismiss=\"modal\" aria-label=\"Close\"'\n                    })}\n                    ${crearBoton({\n                        id: 'boton-estoy-seguro',\n                        type: 'button',\n                        clases: 'col btn-primary ms-1 pt-2 text-center d-block',\n                        texto: 'Si, estoy seguro',\n                        onclick: 'confirmarEdicion();'\n                    })}\n                </div>\n            </div>\n        `\n    })}\n    ${crearModal({\n        id: 'modal-planes-creditos',\n        adiconales_modals_header: 'tabindex=\"-1\" aria-labelledby=\"modal-planes-creditosLabel\" aria-hidden=\"true\"',\n        dialog_class: 'modal-lg',\n        titulo_header: 'Elegir Plan de Créditos IA',\n        modal_body: `\n            <div class=\"col-12\">\n                <div class=\"row m-0 w-100 mb-3\">\n                    <div class=\"col-12 col-md-6 col-lg-4 px-3\">\n                        <div class=\"input-container input-icon mb-0\" id=\"input-busqueda-credito\">\n                            <i class=\"bi bi-search\"></i>\n                            <input type=\"text\" id=\"buscador-plan-credito\" class=\"rounded-2 text-body-2\" placeholder=\"Buscar\">\n                        </div>\n                    </div>\n                    <div class=\"col-12 col-md-6 col-lg-4 col-xl-3\">\n                        ${crearSelect2({\n                            id: 'filtro-plan-credito',\n                            name: 'filtro-plan-credito',\n                            class: 'select2-filtro',\n                            onchange: 'mostrarPlanesCreditos();',\n                            opciones: [\n                                { nombre: 'Mayor a menor', id: 'Mayor' },\n                                { nombre: 'Menor a mayor', id: 'Menor' },\n                            ],\n                            input_container_class: 'mb-0',\n                            opcion_vacia: false\n                        })}\n                    </div>\n                </div>\n                <div id=\"contenedor-planes-creditos\">\n                    <!-- Los planes se cargarán dinámicamente aquí -->\n                </div>\n            </div>\n        `\n    })}\n@endsection\n@endsection\n\n@section('scripts')\n    <script src=\"{{ asset('js/empresas/asignar-plan.js') }}\" type=\"text/javascript\"></script>\n    <script type=\"text/javascript\">\n        @if ($opcion == 'asignar')\n            opcion = 'asignar';\n            empresa = @json($empresa);\n            resource_url = '/empresas-planes';\n            plan_seleccionado = null;\n        @elseif ($opcion == 'facturar')\n            opcion = 'facturar';\n            empresa = @json($empresa);\n            resource_url = '/facturar-plan';\n            empresa_plan = @json($empresa_plan);\n            plan_seleccionado = @json($empresa_plan->plan);\n            plan_seleccionado.cantidad_pruebas = empresa_plan.cantidad_pruebas;\n            plan_seleccionado.cantidad_usuarios = empresa_plan.cantidad_usuarios;\n            plan_seleccionado.unidades = empresa_plan.unidades\n            plan_seleccionado.cantidad_ofertas_laborales = empresa_plan.cantidad_ofertas_laborales;\n            plan_seleccionado.vigencia = empresa_plan.vigencia_dias;\n            plan_seleccionado.precio = empresa_plan.precio;\n            pruebas_empresa_plan = @json($empresa_plan->pruebas);\n\n            @if(isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n                plan_creditos_seleccionado = @json($empresa_plan->planCredito);\n            @endif\n\n            // Determinar los tipos de prueba a seleccionar\n            let tipos_a_seleccionar_facturar = ['{{$empresa_plan->plan->tipoPrueba->id}}'];\n            @if(isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n                tipos_a_seleccionar_facturar.push('2');\n            @endif\n\n            // Establecer los tipos de prueba en el select\n            $('#tipo_prueba_id').val(tipos_a_seleccionar_facturar).trigger('change');\n\n            seleccionarTipoPruebaMultiple();\n            buscarfuncionalidades('{{$empresa_plan->plan->tipoPrueba->id}}');\n\n            // Esperar a que el DOM esté listo para establecer valores\n            $(document).ready(function() {\n                @if(isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n                    $('#plan_credito_id').val('{{ $empresa_plan->plan_credito_id }}');\n                    $('#creditos').val('{{ $empresa_plan->creditos }}');\n\n                    // Dar tiempo para que se cargue seleccionarTipoPruebaMultiple() y sus AJAX\n                    setTimeout(function() {\n                        if (plan_creditos_seleccionado && plan_creditos_seleccionado.id) {\n                            mostrarPlanCreditosSeleccionado();\n                        }\n                    }, 1000);\n                @endif\n            });\n        @elseif ($opcion == 'editar')\n            opcion = 'editar';\n            empresa = @json($empresa);\n            resource_url = '/empresas-planes';\n            empresa_plan = @json($empresa_plan);\n\n            // Obtener el tipo de edición desde la URL\n            let tipo_edicion = '{{ request()->get(\"tipo\", \"seleccion\") }}';\n\n            @if(request()->get('tipo') == 'creditos' && isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n                // Editar plan de créditos\n                plan_creditos_seleccionado = @json($empresa_plan->planCredito);\n                plan_creditos_seleccionado.creditos = empresa_plan.creditos;\n                plan_seleccionado = null;\n                pruebas_empresa_plan = [];\n\n                // Establecer tipo 2 (créditos) en el select\n                $('#tipo_prueba_id').val(['2']).trigger('change');\n\n                $(document).ready(function() {\n                    $('#plan_credito_id').val('{{ $empresa_plan->plan_credito_id }}');\n                    $('#creditos').val('{{ $empresa_plan->creditos }}');\n\n                    setTimeout(function() {\n                        if (plan_creditos_seleccionado && plan_creditos_seleccionado.id) {\n                            mostrarPlanCreditosSeleccionado();\n                        }\n                    }, 500);\n                });\n            @else\n                // Editar plan de selección\n                plan_seleccionado = @json($empresa_plan->plan);\n                plan_seleccionado.cantidad_pruebas = empresa_plan.cantidad_pruebas;\n                plan_seleccionado.cantidad_usuarios = empresa_plan.cantidad_usuarios;\n                plan_seleccionado.unidades = empresa_plan.unidades\n                plan_seleccionado.cantidad_ofertas_laborales = empresa_plan.cantidad_ofertas_laborales;\n                plan_seleccionado.vigencia = empresa_plan.vigencia_dias;\n                plan_seleccionado.precio = empresa_plan.precio;\n                pruebas_empresa_plan = @json($empresa_plan->pruebas);\n\n                // Establecer tipo de selección en el select\n                let tipos_a_seleccionar = ['{{$empresa_plan->plan->tipoPrueba->id}}'];\n                $('#tipo_prueba_id').val(tipos_a_seleccionar).trigger('change');\n\n                seleccionarTipoPruebaMultiple();\n                buscarfuncionalidades('{{$empresa_plan->plan->tipoPrueba->id}}');\n            @endif\n        @endif\n    </script>\n@endsection\n","numLines":584,"startLine":1,"totalLines":584}},"sourceToolAssistantUUID":"4d3b2e48-285d-45e5-a841-b62f2168fc2c"}
{"parentUuid":"8f39138b-d6a6-4dcf-8421-bc10bff62e67","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_018FnrqDgRXupaZgRziVMi4E","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora entiendo el problema. El campo `plan_id` (línea 65-73) tiene `required: true`, lo que hace que siempre sea obligatorio, incluso cuando solo seleccionas \"Planes de créditos (IA)\" sin seleccionar \"Planes de selección\".\n\nLa solución es hacer que la validación sea dinámica: el `plan_id` debe ser obligatorio solo cuando se selecciona \"Planes de selección\", y el `plan_credito_id` debe ser obligatorio solo cuando se selecciona \"Planes de créditos (IA)\"."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":9794,"cache_read_input_tokens":42921,"cache_creation":{"ephemeral_5m_input_tokens":9794,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK2xCLTYFgWvXGwX9mmu","type":"assistant","uuid":"6e409ead-6957-4dc0-9eec-0a79a5c61909","timestamp":"2026-01-20T17:36:06.420Z"}
{"parentUuid":"6e409ead-6957-4dc0-9eec-0a79a5c61909","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_018FnrqDgRXupaZgRziVMi4E","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019K2QcEG17BXeCNjFiiV42L","name":"TodoWrite","input":{"todos":[{"content":"Modificar el campo plan_id para que no sea required por defecto","status":"in_progress","activeForm":"Modificando campo plan_id en el Blade"},{"content":"Agregar lógica JS para validar campos según tipo de plan seleccionado","status":"pending","activeForm":"Agregando validación dinámica en JS"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":9794,"cache_read_input_tokens":42921,"cache_creation":{"ephemeral_5m_input_tokens":9794,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK2xCLTYFgWvXGwX9mmu","type":"assistant","uuid":"92f67dc1-550f-4c0b-8ff8-3071b1a8b334","timestamp":"2026-01-20T17:36:08.630Z"}
{"parentUuid":"92f67dc1-550f-4c0b-8ff8-3071b1a8b334","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019K2QcEG17BXeCNjFiiV42L","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"ac829d75-f809-455e-b154-97910dfd3173","timestamp":"2026-01-20T17:36:08.762Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Modificar el campo plan_id para que no sea required por defecto","status":"in_progress","activeForm":"Modificando campo plan_id en el Blade"},{"content":"Agregar lógica JS para validar campos según tipo de plan seleccionado","status":"pending","activeForm":"Agregando validación dinámica en JS"}]},"sourceToolAssistantUUID":"92f67dc1-550f-4c0b-8ff8-3071b1a8b334"}
{"parentUuid":"ac829d75-f809-455e-b154-97910dfd3173","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01S1eya4amKAK6nk7hujeBen","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JiYPcs6fzBb4RQMqgcstqJ","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\resources\\views\\empresas\\paginas\\asignar-plan.blade.php","old_string":"                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'plan_id',\n                        name: 'plan_id',\n                        adicional: 'style=\"width: 0px; height: 0px;\"',\n                        class: 'p-0 border-0',\n                        required: true,\n                        input_container_class: 'mb-0'\n                    })}\n                </div>","new_string":"                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'plan_id',\n                        name: 'plan_id',\n                        adicional: 'style=\"width: 0px; height: 0px;\"',\n                        class: 'p-0 border-0',\n                        required: false,\n                        input_container_class: 'mb-0'\n                    })}\n                </div>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":349,"cache_read_input_tokens":52715,"cache_creation":{"ephemeral_5m_input_tokens":349,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXK2xkx1XBvd7n4S9XaVD","type":"assistant","uuid":"5572f882-1ead-4097-8c0e-70eade9d0c7f","timestamp":"2026-01-20T17:36:14.380Z"}
{"type":"file-history-snapshot","messageId":"5572f882-1ead-4097-8c0e-70eade9d0c7f","snapshot":{"messageId":"aa497599-5867-40a8-a52e-fddfe3b7a72b","trackedFileBackups":{"resources\\views\\empresas\\paginas\\asignar-plan.blade.php":{"backupFileName":"23a0b404d58f48f6@v1","version":1,"backupTime":"2026-01-20T17:37:10.571Z"}},"timestamp":"2026-01-20T17:35:54.562Z"},"isSnapshotUpdate":true}
{"parentUuid":"5572f882-1ead-4097-8c0e-70eade9d0c7f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JiYPcs6fzBb4RQMqgcstqJ","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\resources\\views\\empresas\\paginas\\asignar-plan.blade.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    60→                <div class=\"col-12\">\n    61→                    <div id=\"contenedor-plan\">\n    62→                    </div>\n    63→                </div>\n    64→                <div class=\"col-6\">\n    65→                    ${crearInput({\n    66→                        id: 'plan_id',\n    67→                        name: 'plan_id',\n    68→                        adicional: 'style=\"width: 0px; height: 0px;\"',\n    69→                        class: 'p-0 border-0',\n    70→                        required: false,\n    71→                        input_container_class: 'mb-0'\n    72→                    })}\n    73→                </div>\n    74→            </div>\n    75→            <div class=\"row mt-7 d-none\" id=\"seccion-pruebas\">\n    76→                <div class=\"col-12 mb-2\">\n    77→                    <h4 class=\"text-headline-4 mb-5\">Pruebas</h4>"}]},"uuid":"e5ef8956-3d95-4fd5-98a9-5a22b963ac64","timestamp":"2026-01-20T17:37:10.625Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\resources\\views\\empresas\\paginas\\asignar-plan.blade.php","oldString":"                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'plan_id',\n                        name: 'plan_id',\n                        adicional: 'style=\"width: 0px; height: 0px;\"',\n                        class: 'p-0 border-0',\n                        required: true,\n                        input_container_class: 'mb-0'\n                    })}\n                </div>","newString":"                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'plan_id',\n                        name: 'plan_id',\n                        adicional: 'style=\"width: 0px; height: 0px;\"',\n                        class: 'p-0 border-0',\n                        required: false,\n                        input_container_class: 'mb-0'\n                    })}\n                </div>","originalFile":"@extends('layouts.app')\n@php\n    $titulo_pagina = isset($empresa_id) ? 'Asignar plan' : 'Facturar';\n@endphp\n@section('titulo', $titulo_pagina)\n\n@section('estilos')\n    <link href=\"{{ asset('css/empresas/empresas.css') }}\" rel=\"stylesheet\">\n@endsection\n\n@section('contenido')\n    <div class=\"container-fluid mt-4\">\n        <div class=\"text-headline-6 mb-0\">\n            <i class=\"bi bi-chevron-left h4 mb-0 text-primary me-5 pointer\" onclick=\"window.history.back();\"></i>\n            @if ($opcion == 'asignar')\n                Asignar plan\n            @elseif ($opcion == 'facturar')\n                Facturar plan\n            @elseif ($opcion == 'editar')\n                Editar asignación de plan\n            @endif\n        </div>\n    </div>\n    <div class=\"container mt-8\">\n        <form id=\"formulario\" enctype=\"multipart/form-data\">\n            @csrf\n            @isset ($empresa_id)\n                <input type=\"hidden\" id=\"empresa_id\" name=\"empresa_id\" value=\"{{ $empresa_id }}\">\n            @endisset\n            @isset ($empresa_plan)\n                <input type=\"hidden\" id=\"id\" name=\"id\" class=\"input-dinamico\" value=\"{{ $empresa_plan->id }}\">\n            @endisset\n            <input type=\"hidden\" id=\"pruebas\" name=\"pruebas\" value=\"\">\n            <input type=\"hidden\" id=\"vigencia\" name=\"vigencia\">\n            <input type=\"hidden\" id=\"unidades\" name=\"unidades\">\n            <input type=\"hidden\" id=\"cantidad_ofertas_laborales\" name=\"cantidad_ofertas_laborales\">\n            <input type=\"hidden\" id=\"cantidad_usuarios\" name=\"cantidad_usuarios\">\n            <input type=\"hidden\" id=\"cantidad_pruebas\" name=\"cantidad_pruebas\">\n            <input type=\"hidden\" id=\"plan_credito_id\" name=\"plan_credito_id\" value=\"\">\n            <input type=\"hidden\" id=\"creditos\" name=\"creditos\" value=\"\">\n            <input type=\"hidden\" id=\"funcionalidades\" name=\"funcionalidades\" value=\"\">\n            <div class=\"row mt-6\">\n                <div class=\"col-12\">\n                    ${crearMultiselect({\n                        opciones: [\n                            { nombre: 'Planes de selección', id: '1' },\n                            { nombre: 'Planes de créditos (IA)', id: '2' }\n                        ],\n                        id: 'tipo_prueba_id',\n                        name: 'tipo_prueba_id',\n                        class: 'clase-personalizada',\n                        onchange: 'seleccionarTipoPruebaMultiple();',\n                        placeholder: 'Tipo de plan',\n                        icono: '<i class=\"bi bi-check-circle input-icono1\"></i>',\n                        label: 'Tipo de plan',\n                    })}\n                </div>\n            </div>\n            <div class=\"row mt-3\">\n                <div class=\"col-12\">\n                    <div id=\"contenedor-plan\">\n                    </div>\n                </div>\n                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'plan_id',\n                        name: 'plan_id',\n                        adicional: 'style=\"width: 0px; height: 0px;\"',\n                        class: 'p-0 border-0',\n                        required: true,\n                        input_container_class: 'mb-0'\n                    })}\n                </div>\n            </div>\n            <div class=\"row mt-7 d-none\" id=\"seccion-pruebas\">\n                <div class=\"col-12 mb-2\">\n                    <h4 class=\"text-headline-4 mb-5\">Pruebas</h4>\n                    <span class=\"text-body-2\">Selecciona las <span class=\"cantidad-pruebas\"></span> prueba(s) que vas a asignar a esta empresa.</span>\n                </div>\n                <div class=\"col-12 col-lg-6\">\n                    <div class=\"row\" id=\"contenedor-pruebas\">\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"row mt-5 d-none\" id=\"alerta-pruebas\">\n                <div class=\"col-12\">\n                    ${crearAlerta(\n                        'warning',\n                        'Recuerda que solo tienes <span class=\"cantidad-pruebas\">{{ $empresa_plan->cantidad_pruebas ?? ''}}</span> prueba(s) disponibles.',\n                        'w-100 mb-0'\n                    )}\n                </div>\n            </div>\n            \n            <div class=\"row mt-3\">\n                <div class=\"col-12\">\n                    <div id=\"contenedor-creditos\">\n                    </div>\n                </div>\n            </div>\n\n            <div class=\"row mt-7\">\n                <div class=\"col-12 mt-5 mb-4\">\n                    <h4 class=\"text-headline-4\">Valor</h4>\n                    <span class=\"text-body-2\">Asignar un valor final de la venta, un descuento si aplica y adjunta la factura.</span>\n                </div>\n                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'porcentaje_descuento',\n                        name: 'porcentaje_descuento',\n                        type: 'number',\n                        autocomplete: 'off',\n                        max: 100,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->porcentaje_descuento : '' }}',\n                        label: 'Porcentaje de descuento',\n                        label_class: 'optional'\n                    })}\n                </div>\n                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'precio',\n                        name: 'precio',\n                        class: 'cleave',\n                        autocomplete: 'off',\n                        minlength: 3,\n                        maxlength: 12,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->precio : '' }}',\n                        required: true,\n                        label: 'Valor de venta'\n                    })}\n                </div>\n            </div>\n\n            <div class=\"row mt-3\">\n                <div class=\"col-6\">\n                    ${crearInput({\n                        id: 'numero_factura',\n                        name: 'numero_factura',\n                        type: 'text',\n                        autocomplete: 'off',\n                        maxlength: 12,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->numero_factura : '' }}',\n                        required: true,\n                        label: 'Número de factura o concepto'\n                    })}\n                </div>\n                <div class=\"col-6\">\n                    @if ($opcion == 'editar' && isset($empresa_plan['archivos'][0]))\n                        <div class=\"card h-auto border-secondary\">\n                            <div class=\"card-body p-2 rounded-4\">\n                                ${crearBoton({\n                                    url: '#',\n                                    clases: 'w-100 d-flex justify-content-between pointer bg-transparent border-0 p-0',\n                                    texto: `\n                                        <div class=\"px-4 text-cta-blue text-decoration-none\">\n                                            {{$empresa_plan['archivos'][0]['nombre']}}\n                                        </div>\n                                        <div class=\"px-4\">\n                                            <i class=\"bi bi-eye-fill text-cta-blue\"></i>\n                                        </div>\n                                    `,\n                                    onclick: `abrirFacturaPlan('{{$empresa_plan['archivos'][0]['id']}}')`\n                                })}\n                            </div>\n                        </div>\n                    @else\n                        ${crearInputFile({\n                            id: 'factura',\n                            name: 'factura',\n                            class: 'input-form',\n                            placeholder: '',\n                            required: false,\n                            accept: 'application/pdf',\n                        })}\n                    @endif\n                </div>\n            </div>\n\n            <div class=\"row mt-3\">\n                <div class=\"col-12\">\n                    ${crearTextarea({\n                        id: 'comentario',\n                        name: 'comentario',\n                        maxlength: 255,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->comentario : '' }}',\n                        label: 'Comentario o detalle de uso',\n                        label_class: 'optional'\n                    })}\n                </div>\n            </div>\n\n            @if ($opcion == 'asignar')\n                <div class=\"row mt-3\">\n                    <div class=\"col-12 mt-5 mb-4\">\n                        <h4 class=\"text-headline-4\">Usuario que está asignando el plan: </h4>\n                        <span class=\"text-body-2\">{{ Auth::user()->nombre_completo }}</span>\n                    </div>\n                </div>\n            @endif\n\n            <div class=\"row mt-3\">\n                <div class=\"col-12 text-center\">\n                    ${crearBoton({\n                        type: 'button',\n                        clases: 'btn-outline-primary me-2 px-14 text-blue-40',\n                        texto: 'Cancelar',\n                        url: `/empresas-gestionar/{{ isset($empresa_id) ? $empresa_id : '' }}`\n                    })}\n                    ${crearBoton({\n                        id: `boton-asignar`,\n                        type: `submit`,\n                        clases: `btn-primary px-12`,\n                        texto: `@if ($opcion == \"asignar\") Asignar plan @elseif ($opcion == \"facturar\") Guardar @elseif ($opcion == \"editar\") Guardar @endif`\n                    })}\n                </div>\n            </div>\n        </form>\n    </div>\n@section('modals')\n    ${crearModal({\n        id: 'modal-planes',\n        adiconales_modals_header: 'tabindex=\"-1\" aria-labelledby=\"modal-planesLabel\" aria-hidden=\"true\"',\n        dialog_class: 'modal-lg',\n        titulo_header: 'Elegir plan',\n        modal_body: `\n            <div class=\"col-12\">\n                <div class=\"row m-0 w-100\">\n                    <div class=\"col-12 col-md-6 col-lg-4 px-3\">\n                        <div class=\"input-container input-icon mb-0\" id=\"input-busqueda\">\n                            <i class=\"bi bi-search\"></i>\n                        </div>\n                    </div>\n                    <div class=\"col-12 col-md-6 col-lg-4 col-xl-3\">\n                        ${crearSelect2({\n                            id: 'filtro-plan',\n                            name: 'filtro-plan',\n                            class: 'select2-filtro',\n                            onchange: 'mostrarPlanes();',\n                            opciones: [\n                                { nombre: 'Todos', id: 'Todos' },\n                                { nombre: 'Por vacantes', id: 'Ofertas' },\n                                { nombre: 'Por unidades', id: 'Unidades' },\n                                { nombre: 'Por tiempo', id: 'Tiempo' }\n                            ],\n                            input_container_class: 'mb-0',\n                            opcion_vacia: false\n                        })}\n                    </div>\n                </div>\n                <div class=\"table-responsive w-100\" id=\"tabla-responsive-planes\">\n                    <table class=\"table table-borderless w-100\" id=\"tabla-planes\">\n                        <thead class=\"d-none\">\n                            <tr>\n                                <th></th>\n                            </tr>\n                        </thead>\n                        <tbody id=\"tbody-planes\">\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        `\n    })}\n    ${crearModal({\n        id: 'modal-modificar-planes',\n        adiconales_modals_header: 'data-bs-backdrop=\"static\" tabindex=\"-1\" aria-labelledby=\"modal-modificar-planesLabel\" aria-hidden=\"true\"',\n        dialog_class: 'modal-md',\n        titulo_header: 'Modificar plan - <span id=\"nombre-plan-modal\">{{ isset($empresa_plan) ? \" \" . $empresa_plan->plan->nombre : \"\" }}</span>',\n        modal_body_class: 'pt-0',\n        modal_body: `\n            <div class=\"col-12 px-4 mb-5\">\n                <span class=\"text-body-2\">Personaliza tu plan para esta empresa.</span>\n            </div>\n            <div class=\"row m-0 w-100\">\n                <div class=\"col-12\" id=\"input-container-pruebas\">\n                    ${crearSelect2({\n                        id: 'cantidad_pruebas_modal',\n                        name: 'cantidad_pruebas_modal',\n                        class: 'select2-filtro',\n                        onchange: 'habilitarBotonGuardar();',\n                        opciones: [\n                            { nombre: '', id: '' },\n                            @if (isset($empresa_plan))\n                                @for ($i = 1; $i <= 8; $i++)\n                                    { nombre: '{{ $i }} Pruebas', id: '{{ $i }}', selected: {{ $empresa_plan->cantidad_pruebas == $i ? 'true' : 'false' }} },\n                                @endfor\n                            @endif\n                        ],\n                        label: 'Pruebas disponibles'\n                    })}\n                </div>\n                <div class=\"col-12 col-md-6\" id=\"input-container-tiempo\">\n                    ${crearSelect2({\n                        id: 'tiempo_modal',\n                        name: 'tiempo_modal',\n                        class: 'select2-filtro',\n                        onchange: 'habilitarBotonGuardar(); seleccionarTiempo(this.value);',\n                        opciones: [\n                            { nombre: 'Seleccione', id: '' },\n                            { nombre: '3 Meses', id: '90', selected: {{ isset($empresa_plan) && $empresa_plan->plan->vigencia == 90 ? 'true' : 'false' }} },\n                            { nombre: '6 Meses', id: '180', selected: {{ isset($empresa_plan) && $empresa_plan->plan->vigencia == 180 ? 'true' : 'false' }} },\n                            { nombre: '1 Año', id: '365', selected: {{ isset($empresa_plan) && $empresa_plan->plan->vigencia == 365 ? 'true' : 'false' }} },\n                            { nombre: 'Personalizado', id: 'personalizado' }\n                        ],\n                        label: 'Tiempo'\n                    })}\n                </div>\n                <div class=\"col-12 col-md-6 d-none\" id=\"input-container-vigencia\">\n                    ${crearInput({\n                        id: 'vigencia_modal',\n                        name: 'vigencia_modal',\n                        class: 'solo-numeros',\n                        autocomplete: 'off',\n                        max: 1000000,\n                        onkeyup: 'habilitarBotonGuardar();',\n                        label: 'Días'\n                    })}\n                </div>\n                <div class=\"col-12 col-md-6\">\n                    ${crearInput({\n                        id: 'unidades_modal',\n                        name: 'unidades_modal',\n                        class: 'solo-numeros',\n                        autocomplete: 'off',\n                        max: 1000000,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->unidades : '' }}',\n                        onkeyup: 'habilitarBotonGuardar();',\n                        disabled: {{ !(isset($empresa_plan) && ($empresa_plan->unidades != null || $empresa_plan->cantidad_ofertas_laborales != null)) ? 'true' : 'false' }},\n                        label: 'Unidades <span class=\"texto-label-tiempo\"></span>'\n                    })}\n                </div>\n                <div class=\"col-12 col-md-6\">\n                    ${crearInput({\n                        id: 'cantidad_ofertas_laborales_modal',\n                        name: 'cantidad_ofertas_laborales_modal',\n                        class: 'solo-numeros',\n                        autocomplete: 'off',\n                        max: 1000000,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->cantidad_ofertas_laborales : '' }}',\n                        onkeyup: 'habilitarBotonGuardar();',\n                        disabled: {{ !(isset($empresa_plan) && ($empresa_plan->unidades != null || $empresa_plan->cantidad_ofertas_laborales != null)) ? 'true' : 'false' }},\n                        label: 'Vacantes <span class=\"texto-label-tiempo\"></span>'\n                    })}\n                </div>\n                <div class=\"col-12 mb-2\">\n                    <h4 class=\"text-headline-4\">Beneficios</h4>\n                </div>\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"input-container\">\n                        <select class=\"multiselect rounded-2 text-body-2\" multiple=\"multiple\" id=\"adicionales_modal\" name=\"adicionales_modal[]\" data-placeholder=\"Adicionales\" onchange=\"habilitarBotonGuardar();\"></select>\n                    </div>\n                </div>\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"input-container\">\n                        <select class=\"multiselect rounded-2 text-body-2\" multiple=\"multiple\" id=\"predefinidos_modal\" name=\"predefinidos_modal[]\" data-placeholder=\"Predefinidos\" onchange=\"habilitarBotonGuardar();\"></select>\n                    </div>\n                </div>\n                <div class=\"col-12\">\n                    ${crearInput({\n                        id: 'cantidad_usuarios_modal',\n                        name: 'cantidad_usuarios_modal',\n                        type: 'number',\n                        autocomplete: 'off',\n                        max: 1000000,\n                        value: '{{ isset($empresa_plan) ? $empresa_plan->cantidad_usuarios : '' }}',\n                        onkeyup: 'habilitarBotonGuardar();',\n                        label: 'Usuarios'\n                    })}\n                </div>\n                <div class=\"col-12\">\n                    <div class=\"alert badge-estado-renovado fw-bold\">\n                        Recuerda que no es posible cambiar entre planes con cantidades fijas a ilimitados o viceversa.\n                    </div>\n                </div>\n                <div class=\"col-12\">\n                    <div class=\"row m-0 w-100\">\n                        ${crearBoton({\n                            type: 'button',\n                            clases: 'col btn-outline-primary me-1 pt-2 text-center d-block',\n                            texto: 'Cancelar',\n                            onclick: 'cancelarEdicion();',\n                            adicional: 'data-bs-dismiss=\"modal\" aria-label=\"Close\"'\n                        })}\n                        ${crearBoton({\n                            id: 'boton-guardar-modificaciones',\n                            type: 'button',\n                            clases: 'col btn-primary ms-1 pt-2 text-center d-block',\n                            texto: 'Guardar modificaciones',\n                            onclick: 'abrirModalEstasSeguro();',\n                            disabled: true\n                        })}\n                    </div>\n                </div>\n            </div>\n            <div class=\"table-responsive w-100\" id=\"tabla-responsive-planes\">\n                <table class=\"table table-borderless w-100\" id=\"tabla-planes\">\n                    <thead class=\"d-none\">\n                        <tr>\n                            <th></th>\n                        </tr>\n                    </thead>\n                    <tbody id=\"tbody-planes\">\n                    </tbody>\n                </table>\n            </div>\n        `\n    })}\n    ${crearModal({\n        id: 'modal-estas-seguro',\n        adiconales_modals_header: 'data-bs-backdrop=\"static\" tabindex=\"-1\" aria-labelledby=\"modal-estas-seguroLabel\" aria-hidden=\"true\"',\n        dialog_class: 'modal-md',\n        titulo_header: '¿Estás seguro?',\n        modal_body_class: 'pt-0',\n        modal_body: `\n            <div class=\"col-12 px-4 mb-5\">\n                <span class=\"text-body-2\">\n                    se modificará el plan actual para la empresa, ten en cuenta que la información de consumo puede variar entre este plan modificado y los que no lo están pero tienen el mismo nombre.\n                    <br>\n                    <br>\n                    Personaliza tu plan para esta empresa.\n                </span>\n            </div>\n            <div class=\"col-12 px-4 mb-4 mt-3\">\n                <div class=\"row m-0 w-100\">\n                    ${crearBoton({\n                        type: 'button',\n                        clases: 'col btn-outline-primary me-1 pt-2 text-center d-block',\n                        texto: 'Cancelar',\n                        onclick: 'cancelarEdicion();',\n                        adicional: 'data-bs-dismiss=\"modal\" aria-label=\"Close\"'\n                    })}\n                    ${crearBoton({\n                        id: 'boton-estoy-seguro',\n                        type: 'button',\n                        clases: 'col btn-primary ms-1 pt-2 text-center d-block',\n                        texto: 'Si, estoy seguro',\n                        onclick: 'confirmarEdicion();'\n                    })}\n                </div>\n            </div>\n        `\n    })}\n    ${crearModal({\n        id: 'modal-planes-creditos',\n        adiconales_modals_header: 'tabindex=\"-1\" aria-labelledby=\"modal-planes-creditosLabel\" aria-hidden=\"true\"',\n        dialog_class: 'modal-lg',\n        titulo_header: 'Elegir Plan de Créditos IA',\n        modal_body: `\n            <div class=\"col-12\">\n                <div class=\"row m-0 w-100 mb-3\">\n                    <div class=\"col-12 col-md-6 col-lg-4 px-3\">\n                        <div class=\"input-container input-icon mb-0\" id=\"input-busqueda-credito\">\n                            <i class=\"bi bi-search\"></i>\n                            <input type=\"text\" id=\"buscador-plan-credito\" class=\"rounded-2 text-body-2\" placeholder=\"Buscar\">\n                        </div>\n                    </div>\n                    <div class=\"col-12 col-md-6 col-lg-4 col-xl-3\">\n                        ${crearSelect2({\n                            id: 'filtro-plan-credito',\n                            name: 'filtro-plan-credito',\n                            class: 'select2-filtro',\n                            onchange: 'mostrarPlanesCreditos();',\n                            opciones: [\n                                { nombre: 'Mayor a menor', id: 'Mayor' },\n                                { nombre: 'Menor a mayor', id: 'Menor' },\n                            ],\n                            input_container_class: 'mb-0',\n                            opcion_vacia: false\n                        })}\n                    </div>\n                </div>\n                <div id=\"contenedor-planes-creditos\">\n                    <!-- Los planes se cargarán dinámicamente aquí -->\n                </div>\n            </div>\n        `\n    })}\n@endsection\n@endsection\n\n@section('scripts')\n    <script src=\"{{ asset('js/empresas/asignar-plan.js') }}\" type=\"text/javascript\"></script>\n    <script type=\"text/javascript\">\n        @if ($opcion == 'asignar')\n            opcion = 'asignar';\n            empresa = @json($empresa);\n            resource_url = '/empresas-planes';\n            plan_seleccionado = null;\n        @elseif ($opcion == 'facturar')\n            opcion = 'facturar';\n            empresa = @json($empresa);\n            resource_url = '/facturar-plan';\n            empresa_plan = @json($empresa_plan);\n            plan_seleccionado = @json($empresa_plan->plan);\n            plan_seleccionado.cantidad_pruebas = empresa_plan.cantidad_pruebas;\n            plan_seleccionado.cantidad_usuarios = empresa_plan.cantidad_usuarios;\n            plan_seleccionado.unidades = empresa_plan.unidades\n            plan_seleccionado.cantidad_ofertas_laborales = empresa_plan.cantidad_ofertas_laborales;\n            plan_seleccionado.vigencia = empresa_plan.vigencia_dias;\n            plan_seleccionado.precio = empresa_plan.precio;\n            pruebas_empresa_plan = @json($empresa_plan->pruebas);\n\n            @if(isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n                plan_creditos_seleccionado = @json($empresa_plan->planCredito);\n            @endif\n\n            // Determinar los tipos de prueba a seleccionar\n            let tipos_a_seleccionar_facturar = ['{{$empresa_plan->plan->tipoPrueba->id}}'];\n            @if(isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n                tipos_a_seleccionar_facturar.push('2');\n            @endif\n\n            // Establecer los tipos de prueba en el select\n            $('#tipo_prueba_id').val(tipos_a_seleccionar_facturar).trigger('change');\n\n            seleccionarTipoPruebaMultiple();\n            buscarfuncionalidades('{{$empresa_plan->plan->tipoPrueba->id}}');\n\n            // Esperar a que el DOM esté listo para establecer valores\n            $(document).ready(function() {\n                @if(isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n                    $('#plan_credito_id').val('{{ $empresa_plan->plan_credito_id }}');\n                    $('#creditos').val('{{ $empresa_plan->creditos }}');\n\n                    // Dar tiempo para que se cargue seleccionarTipoPruebaMultiple() y sus AJAX\n                    setTimeout(function() {\n                        if (plan_creditos_seleccionado && plan_creditos_seleccionado.id) {\n                            mostrarPlanCreditosSeleccionado();\n                        }\n                    }, 1000);\n                @endif\n            });\n        @elseif ($opcion == 'editar')\n            opcion = 'editar';\n            empresa = @json($empresa);\n            resource_url = '/empresas-planes';\n            empresa_plan = @json($empresa_plan);\n\n            // Obtener el tipo de edición desde la URL\n            let tipo_edicion = '{{ request()->get(\"tipo\", \"seleccion\") }}';\n\n            @if(request()->get('tipo') == 'creditos' && isset($empresa_plan->plan_credito_id) && $empresa_plan->plan_credito_id)\n                // Editar plan de créditos\n                plan_creditos_seleccionado = @json($empresa_plan->planCredito);\n                plan_creditos_seleccionado.creditos = empresa_plan.creditos;\n                plan_seleccionado = null;\n                pruebas_empresa_plan = [];\n\n                // Establecer tipo 2 (créditos) en el select\n                $('#tipo_prueba_id').val(['2']).trigger('change');\n\n                $(document).ready(function() {\n                    $('#plan_credito_id').val('{{ $empresa_plan->plan_credito_id }}');\n                    $('#creditos').val('{{ $empresa_plan->creditos }}');\n\n                    setTimeout(function() {\n                        if (plan_creditos_seleccionado && plan_creditos_seleccionado.id) {\n                            mostrarPlanCreditosSeleccionado();\n                        }\n                    }, 500);\n                });\n            @else\n                // Editar plan de selección\n                plan_seleccionado = @json($empresa_plan->plan);\n                plan_seleccionado.cantidad_pruebas = empresa_plan.cantidad_pruebas;\n                plan_seleccionado.cantidad_usuarios = empresa_plan.cantidad_usuarios;\n                plan_seleccionado.unidades = empresa_plan.unidades\n                plan_seleccionado.cantidad_ofertas_laborales = empresa_plan.cantidad_ofertas_laborales;\n                plan_seleccionado.vigencia = empresa_plan.vigencia_dias;\n                plan_seleccionado.precio = empresa_plan.precio;\n                pruebas_empresa_plan = @json($empresa_plan->pruebas);\n\n                // Establecer tipo de selección en el select\n                let tipos_a_seleccionar = ['{{$empresa_plan->plan->tipoPrueba->id}}'];\n                $('#tipo_prueba_id').val(tipos_a_seleccionar).trigger('change');\n\n                seleccionarTipoPruebaMultiple();\n                buscarfuncionalidades('{{$empresa_plan->plan->tipoPrueba->id}}');\n            @endif\n        @endif\n    </script>\n@endsection\n","structuredPatch":[{"oldStart":67,"oldLines":7,"newStart":67,"newLines":7,"lines":["                         name: 'plan_id',","                         adicional: 'style=\"width: 0px; height: 0px;\"',","                         class: 'p-0 border-0',","-                        required: true,","+                        required: false,","                         input_container_class: 'mb-0'","                     })}","                 </div>"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"5572f882-1ead-4097-8c0e-70eade9d0c7f"}
{"parentUuid":"e5ef8956-3d95-4fd5-98a9-5a22b963ac64","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_015cSSAVK51K8hfBUR9stvXu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RbfSQtEUpaHJWJAD5ZaQMg","name":"TodoWrite","input":{"todos":[{"content":"Modificar el campo plan_id para que no sea required por defecto","status":"completed","activeForm":"Modificando campo plan_id en el Blade"},{"content":"Agregar lógica JS para validar campos según tipo de plan seleccionado","status":"in_progress","activeForm":"Agregando validación dinámica en JS"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":694,"cache_read_input_tokens":53064,"cache_creation":{"ephemeral_5m_input_tokens":694,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXK33VftSmGymVFFVRqkL","type":"assistant","uuid":"46a4374b-9c14-413c-bf10-712aab29c580","timestamp":"2026-01-20T17:37:16.769Z"}
{"parentUuid":"46a4374b-9c14-413c-bf10-712aab29c580","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RbfSQtEUpaHJWJAD5ZaQMg","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"770d6f67-1f51-4525-848e-046dd0b91c08","timestamp":"2026-01-20T17:37:17.000Z","toolUseResult":{"oldTodos":[{"content":"Modificar el campo plan_id para que no sea required por defecto","status":"in_progress","activeForm":"Modificando campo plan_id en el Blade"},{"content":"Agregar lógica JS para validar campos según tipo de plan seleccionado","status":"pending","activeForm":"Agregando validación dinámica en JS"}],"newTodos":[{"content":"Modificar el campo plan_id para que no sea required por defecto","status":"completed","activeForm":"Modificando campo plan_id en el Blade"},{"content":"Agregar lógica JS para validar campos según tipo de plan seleccionado","status":"in_progress","activeForm":"Agregando validación dinámica en JS"}]},"sourceToolAssistantUUID":"46a4374b-9c14-413c-bf10-712aab29c580"}
{"parentUuid":"770d6f67-1f51-4525-848e-046dd0b91c08","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01C4R13TnbhZNjTUvvhS63gK","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora voy a modificar el archivo JavaScript para agregar la validación dinámica en la función `validacionAdicional()` y también en `seleccionarTipoPruebaMultiple()`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":208,"cache_read_input_tokens":53758,"cache_creation":{"ephemeral_5m_input_tokens":208,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXK33op3fdcAZFGoLiSjd","type":"assistant","uuid":"a83377c3-c69b-445e-b916-8aaeeb4397aa","timestamp":"2026-01-20T17:37:20.491Z"}
{"parentUuid":"a83377c3-c69b-445e-b916-8aaeeb4397aa","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01C4R13TnbhZNjTUvvhS63gK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014RRpLah27ryLYRrXWcvvqg","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","old_string":"/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    $('#vigencia').val($('#vigencia_modal').val());\n    if ($('#unidades_modal').val() == 'Ilimitadas') {\n        $('#unidades').val('');\n    } else {\n        $('#unidades').val($('#unidades_modal').val());\n    }\n    if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n        $('#cantidad_ofertas_laborales').val('');\n    } else {\n        $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n    }\n    $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n    $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n    if (opcion == 'facturar' || opcion == 'editar') {\n        let adicionales = $('#adicionales_modal').val();\n        let predefinidos = $('#predefinidos_modal').val();\n        let funcionalidades = adicionales.concat(predefinidos);\n        $('#funcionalidades').val(JSON.stringify(funcionalidades));\n        if (funcionalidades.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n        }\n    } else {\n        let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n        $('#funcionalidades').val(JSON.stringify(ids));\n    }\n    var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n        return this.value;\n    }).get();\n    $('#pruebas').val('');\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (pruebas_seleccionadas.length == 0) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos una prueba.');\n    } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n    }\n    if (valido) {\n        $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n    }\n    return valido;\n}","new_string":"/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Jair Carvajal\n */\nfunction validacionAdicional() {\n    let valido = true;\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Validar que al menos un tipo de plan esté seleccionado\n    if (!tiene_seleccion && !tiene_creditos) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos un tipo de plan.');\n        return valido;\n    }\n\n    // Validar plan de selección solo si está seleccionado el tipo 1\n    if (tiene_seleccion) {\n        if (!$('#plan_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de selección.');\n            return valido;\n        }\n\n        $('#vigencia').val($('#vigencia_modal').val());\n        if ($('#unidades_modal').val() == 'Ilimitadas') {\n            $('#unidades').val('');\n        } else {\n            $('#unidades').val($('#unidades_modal').val());\n        }\n        if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n            $('#cantidad_ofertas_laborales').val('');\n        } else {\n            $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n        }\n        $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n        $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            let adicionales = $('#adicionales_modal').val() || [];\n            let predefinidos = $('#predefinidos_modal').val() || [];\n            let funcionalidades = adicionales.concat(predefinidos);\n            $('#funcionalidades').val(JSON.stringify(funcionalidades));\n            if (funcionalidades.length == 0) {\n                valido = false;\n                mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n                return valido;\n            }\n        } else {\n            let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n            $('#funcionalidades').val(JSON.stringify(ids));\n        }\n\n        var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n            return this.value;\n        }).get();\n        $('#pruebas').val('');\n        let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n        if (maximo_pruebas == '') {\n            maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n        }\n        if (pruebas_seleccionadas.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una prueba.');\n            return valido;\n        } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n            return valido;\n        }\n        if (valido) {\n            $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n        }\n    }\n\n    // Validar plan de créditos solo si está seleccionado el tipo 2\n    if (tiene_creditos) {\n        if (!$('#plan_credito_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de créditos IA.');\n            return valido;\n        }\n    }\n\n    return valido;\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":208,"cache_read_input_tokens":53758,"cache_creation":{"ephemeral_5m_input_tokens":208,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CXK33op3fdcAZFGoLiSjd","type":"assistant","uuid":"0ca77240-2171-45b3-b0c1-62e68ab6301b","timestamp":"2026-01-20T17:37:38.136Z"}
{"parentUuid":"0ca77240-2171-45b3-b0c1-62e68ab6301b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). The user provided the following reason for the rejection:  que al autor sea andres gonzalez","is_error":true,"tool_use_id":"toolu_014RRpLah27ryLYRrXWcvvqg"}]},"uuid":"0f21d371-0614-4bc7-85de-3d4af2154d5f","timestamp":"2026-01-20T17:38:20.155Z","toolUseResult":"Error: The user doesn't want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). The user provided the following reason for the rejection:  que al autor sea andres gonzalez","sourceToolAssistantUUID":"0ca77240-2171-45b3-b0c1-62e68ab6301b"}
{"parentUuid":"0f21d371-0614-4bc7-85de-3d4af2154d5f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DnPgfvt6yxKQLdVv4B2zQF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0173n9wQAXn6wcT2jgR4SX48","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","old_string":"/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    $('#vigencia').val($('#vigencia_modal').val());\n    if ($('#unidades_modal').val() == 'Ilimitadas') {\n        $('#unidades').val('');\n    } else {\n        $('#unidades').val($('#unidades_modal').val());\n    }\n    if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n        $('#cantidad_ofertas_laborales').val('');\n    } else {\n        $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n    }\n    $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n    $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n    if (opcion == 'facturar' || opcion == 'editar') {\n        let adicionales = $('#adicionales_modal').val();\n        let predefinidos = $('#predefinidos_modal').val();\n        let funcionalidades = adicionales.concat(predefinidos);\n        $('#funcionalidades').val(JSON.stringify(funcionalidades));\n        if (funcionalidades.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n        }\n    } else {\n        let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n        $('#funcionalidades').val(JSON.stringify(ids));\n    }\n    var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n        return this.value;\n    }).get();\n    $('#pruebas').val('');\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (pruebas_seleccionadas.length == 0) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos una prueba.');\n    } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n    }\n    if (valido) {\n        $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n    }\n    return valido;\n}","new_string":"/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Validar que al menos un tipo de plan esté seleccionado\n    if (!tiene_seleccion && !tiene_creditos) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos un tipo de plan.');\n        return valido;\n    }\n\n    // Validar plan de selección solo si está seleccionado el tipo 1\n    if (tiene_seleccion) {\n        if (!$('#plan_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de selección.');\n            return valido;\n        }\n\n        $('#vigencia').val($('#vigencia_modal').val());\n        if ($('#unidades_modal').val() == 'Ilimitadas') {\n            $('#unidades').val('');\n        } else {\n            $('#unidades').val($('#unidades_modal').val());\n        }\n        if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n            $('#cantidad_ofertas_laborales').val('');\n        } else {\n            $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n        }\n        $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n        $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            let adicionales = $('#adicionales_modal').val() || [];\n            let predefinidos = $('#predefinidos_modal').val() || [];\n            let funcionalidades = adicionales.concat(predefinidos);\n            $('#funcionalidades').val(JSON.stringify(funcionalidades));\n            if (funcionalidades.length == 0) {\n                valido = false;\n                mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n                return valido;\n            }\n        } else {\n            let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n            $('#funcionalidades').val(JSON.stringify(ids));\n        }\n\n        var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n            return this.value;\n        }).get();\n        $('#pruebas').val('');\n        let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n        if (maximo_pruebas == '') {\n            maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n        }\n        if (pruebas_seleccionadas.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una prueba.');\n            return valido;\n        } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n            return valido;\n        }\n        if (valido) {\n            $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n        }\n    }\n\n    // Validar plan de créditos solo si está seleccionado el tipo 2\n    if (tiene_creditos) {\n        if (!$('#plan_credito_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de créditos IA.');\n            return valido;\n        }\n    }\n\n    return valido;\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1998,"cache_read_input_tokens":53966,"cache_creation":{"ephemeral_5m_input_tokens":1998,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXK38XqkLH9uajGxcu1Bw","type":"assistant","uuid":"94d09081-4bc5-49cd-a71b-3b1684e08562","timestamp":"2026-01-20T17:38:36.714Z"}
{"type":"file-history-snapshot","messageId":"94d09081-4bc5-49cd-a71b-3b1684e08562","snapshot":{"messageId":"aa497599-5867-40a8-a52e-fddfe3b7a72b","trackedFileBackups":{"resources\\views\\empresas\\paginas\\asignar-plan.blade.php":{"backupFileName":"23a0b404d58f48f6@v1","version":1,"backupTime":"2026-01-20T17:37:10.571Z"},"public\\js\\empresas\\asignar-plan.js":{"backupFileName":"25fa1d462d51e622@v1","version":1,"backupTime":"2026-01-20T17:38:49.399Z"}},"timestamp":"2026-01-20T17:35:54.562Z"},"isSnapshotUpdate":true}
{"parentUuid":"94d09081-4bc5-49cd-a71b-3b1684e08562","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0173n9wQAXn6wcT2jgR4SX48","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   757→        }\n   758→    });\n   759→}\n   760→\n   761→/**\n   762→ * Función para agregar validaciones adicionales y data adicional en el envío del form.\n   763→ *\n   764→ * @returns {void}\n   765→ * @author José Manuel Jiménez\n   766→ * @author Andres Gonzalez\n   767→ */\n   768→function validacionAdicional() {\n   769→    let valido = true;\n   770→    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n   771→    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n   772→    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n   773→\n   774→    // Validar que al menos un tipo de plan esté seleccionado\n   775→    if (!tiene_seleccion && !tiene_creditos) {\n   776→        valido = false;\n   777→        mostrarToast('danger', 'Seleccione al menos un tipo de plan.');\n   778→        return valido;\n   779→    }\n   780→\n   781→    // Validar plan de selección solo si está seleccionado el tipo 1\n   782→    if (tiene_seleccion) {\n   783→        if (!$('#plan_id').val()) {\n   784→            valido = false;\n   785→            mostrarToast('danger', 'Seleccione un plan de selección.');\n   786→            return valido;\n   787→        }\n   788→\n   789→        $('#vigencia').val($('#vigencia_modal').val());\n   790→        if ($('#unidades_modal').val() == 'Ilimitadas') {\n   791→            $('#unidades').val('');\n   792→        } else {\n   793→            $('#unidades').val($('#unidades_modal').val());\n   794→        }\n   795→        if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n   796→            $('#cantidad_ofertas_laborales').val('');\n   797→        } else {\n   798→            $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n   799→        }\n   800→        $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n   801→        $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n   802→\n   803→        if (opcion == 'facturar' || opcion == 'editar') {\n   804→            let adicionales = $('#adicionales_modal').val() || [];\n   805→            let predefinidos = $('#predefinidos_modal').val() || [];\n   806→            let funcionalidades = adicionales.concat(predefinidos);\n   807→            $('#funcionalidades').val(JSON.stringify(funcionalidades));\n   808→            if (funcionalidades.length == 0) {\n   809→                valido = false;\n   810→                mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n   811→                return valido;\n   812→            }\n   813→        } else {\n   814→            let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n   815→            $('#funcionalidades').val(JSON.stringify(ids));\n   816→        }\n   817→\n   818→        var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n   819→            return this.value;\n   820→        }).get();\n   821→        $('#pruebas').val('');\n   822→        let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n   823→        if (maximo_pruebas == '') {\n   824→            maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n   825→        }\n   826→        if (pruebas_seleccionadas.length == 0) {\n   827→            valido = false;\n   828→            mostrarToast('danger', 'Seleccione al menos una prueba.');\n   829→            return valido;\n   830→        } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n   831→            valido = false;\n   832→            mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n   833→            return valido;\n   834→        }\n   835→        if (valido) {\n   836→            $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n   837→        }\n   838→    }\n   839→\n   840→    // Validar plan de créditos solo si está seleccionado el tipo 2\n   841→    if (tiene_creditos) {\n   842→        if (!$('#plan_credito_id').val()) {\n   843→            valido = false;\n   844→            mostrarToast('danger', 'Seleccione un plan de créditos IA.');\n   845→            return valido;\n   846→        }\n   847→    }\n   848→\n   849→    return valido;\n   850→}\n   851→\n   852→\n   853→/**\n   854→ * Función para validar que no se exceda al seleccionar limite de pruebas."}]},"uuid":"7f32e827-829f-47ac-8680-e0ca5eddbbd2","timestamp":"2026-01-20T17:38:49.476Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","oldString":"/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    $('#vigencia').val($('#vigencia_modal').val());\n    if ($('#unidades_modal').val() == 'Ilimitadas') {\n        $('#unidades').val('');\n    } else {\n        $('#unidades').val($('#unidades_modal').val());\n    }\n    if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n        $('#cantidad_ofertas_laborales').val('');\n    } else {\n        $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n    }\n    $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n    $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n    if (opcion == 'facturar' || opcion == 'editar') {\n        let adicionales = $('#adicionales_modal').val();\n        let predefinidos = $('#predefinidos_modal').val();\n        let funcionalidades = adicionales.concat(predefinidos);\n        $('#funcionalidades').val(JSON.stringify(funcionalidades));\n        if (funcionalidades.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n        }\n    } else {\n        let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n        $('#funcionalidades').val(JSON.stringify(ids));\n    }\n    var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n        return this.value;\n    }).get();\n    $('#pruebas').val('');\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (pruebas_seleccionadas.length == 0) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos una prueba.');\n    } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n    }\n    if (valido) {\n        $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n    }\n    return valido;\n}","newString":"/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Validar que al menos un tipo de plan esté seleccionado\n    if (!tiene_seleccion && !tiene_creditos) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos un tipo de plan.');\n        return valido;\n    }\n\n    // Validar plan de selección solo si está seleccionado el tipo 1\n    if (tiene_seleccion) {\n        if (!$('#plan_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de selección.');\n            return valido;\n        }\n\n        $('#vigencia').val($('#vigencia_modal').val());\n        if ($('#unidades_modal').val() == 'Ilimitadas') {\n            $('#unidades').val('');\n        } else {\n            $('#unidades').val($('#unidades_modal').val());\n        }\n        if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n            $('#cantidad_ofertas_laborales').val('');\n        } else {\n            $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n        }\n        $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n        $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            let adicionales = $('#adicionales_modal').val() || [];\n            let predefinidos = $('#predefinidos_modal').val() || [];\n            let funcionalidades = adicionales.concat(predefinidos);\n            $('#funcionalidades').val(JSON.stringify(funcionalidades));\n            if (funcionalidades.length == 0) {\n                valido = false;\n                mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n                return valido;\n            }\n        } else {\n            let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n            $('#funcionalidades').val(JSON.stringify(ids));\n        }\n\n        var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n            return this.value;\n        }).get();\n        $('#pruebas').val('');\n        let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n        if (maximo_pruebas == '') {\n            maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n        }\n        if (pruebas_seleccionadas.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una prueba.');\n            return valido;\n        } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n            return valido;\n        }\n        if (valido) {\n            $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n        }\n    }\n\n    // Validar plan de créditos solo si está seleccionado el tipo 2\n    if (tiene_creditos) {\n        if (!$('#plan_credito_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de créditos IA.');\n            return valido;\n        }\n    }\n\n    return valido;\n}","originalFile":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPrueba(tipo_prueba_id) {\n    $('#contenedor-plan').empty();\n    $('#seccion-pruebas').addClass('d-none');\n    $('#plan_id').val('');\n    pruebas = [];\n\n    // Convertir tipo_prueba_id a array si no lo es\n    let tipos_prueba = Array.isArray(tipo_prueba_id) ? tipo_prueba_id : [tipo_prueba_id];\n\n    // Crear los botones según los tipos de prueba seleccionados\n    let botones_html = '<div class=\"card-body text-center\">';\n\n    tipos_prueba.forEach(function(tipo_id) {\n        let texto_boton = 'Elegir plan';\n        let clase_boton = 'btn-outline-primary';\n\n        if (tipo_id == 1) {\n            texto_boton = 'Elegir Plan de Selección';\n            clase_boton = 'btn-outline-primary';\n        } else if (tipo_id == 2) {\n            texto_boton = 'Elegir Plan de Créditos IA';\n            clase_boton = 'btn-outline-info';\n        }\n\n        botones_html += `\n            <button type=\"button\" id=\"elegir-plan-${tipo_id}\" class=\"btn ${clase_boton} mx-1 my-1\" disabled onclick=\"modalElegirPlan(${tipo_id});\">\n                ${texto_boton}\n            </button>\n        `;\n    });\n\n    botones_html += '</div>';\n    $('#contenedor-plan').append(botones_html);\n\n    $('#tipo_prueba_id').val(tipo_prueba_id).trigger('select2');\n\n    if (tipo_prueba_id && (Array.isArray(tipo_prueba_id) ? tipo_prueba_id.length > 0 : tipo_prueba_id)) {\n        // Habilitar todos los botones creados\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', false);\n        });\n\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipo_prueba_id,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n    } else {\n        // Deshabilitar todos los botones si no hay tipo de prueba\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', true);\n        });\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan\n        $('#contenedor-plan').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/pruebas-listado`,\n        data: {\n            tipo_prueba_id: tipos_prueba,\n            activo: 1\n        }\n    }).then((respuesta) => {\n        limpiarAdicional();\n        $('#contenedor-pruebas').empty();\n        pruebas = respuesta.data;\n        for (let i = 0; i < pruebas.length; i++) {\n            $('#contenedor-pruebas').append(`\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"d-flex align-items-center\">\n                        <div class=\"check-container my-1 me-1\">\n                            <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                        </div>\n                        <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                    </div>\n                </div>\n            `);\n        }\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n            }\n            $('#seccion-pruebas').removeClass('d-none');\n            mostrarPlanSeleccionado();\n        }\n\n        if (opcion == 'editar') {\n            $('#tipo_prueba_id').prop('disabled', true);\n        }\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    });\n}\n\n/**\n * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Jair Carvajal\n */\nfunction modalElegirPlan(tipo_especifico = null) {\n    let tipo_prueba_para_consulta = tipo_especifico !== null ? tipo_especifico : $('#tipo_prueba_id').val();\n\n    // Si es tipo 2 (Créditos IA), cargar planes de créditos\n    if (tipo_prueba_para_consulta == 2 || tipo_prueba_para_consulta == '2') {\n        $.ajax({\n            type: 'GET',\n            url: '/api/planes-creditos',\n            data: {\n                activo: true\n            }\n        }).then((respuesta) => {\n            planes_creditos = respuesta.data.planes;            \n            mostrarPlanesCreditos();\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n        return;\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/planes-listado`,\n        data: {\n            tipo_prueba_id: tipo_prueba_para_consulta\n        }\n    }).then((respuesta) => {\n        planes = respuesta.data;\n        mostrarPlanes(tipo_especifico);\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error');\n    });\n}\n\n/**\n * Mostrar los planes de créditos en el modal.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanesCreditos() {\n    let filtro_orden = $('#filtro-plan-credito').val();\n    let buscar = $('#buscador-plan-credito').val() || '';\n\n    // Ordenar planes según el filtro\n    let planes_ordenados = [...planes_creditos];\n    if (filtro_orden === 'Mayor') {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else if (filtro_orden === 'Menor') {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n    if (buscar !== '') {\n        planes_ordenados = planes_ordenados.filter(plan =>\n            plan.nombre.toLowerCase().includes(buscar.toLowerCase())\n        );\n    }\n\n    $('#contenedor-planes-creditos').empty();\n\n    if (planes_ordenados.length === 0) {\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"text-center py-5\">\n                <p class=\"text-muted\">No se encontraron planes</p>\n            </div>\n        `);\n    }\n\n    for (let i = 0; i < planes_ordenados.length; i++) {\n        let plan = planes_ordenados[i];\n        let creditos_disponibles = plan.creditos_disponibles || plan.creditos || 0;\n        let creditos_promedio = plan.creditos_promedio_accion || 0;\n        let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n            ? Math.floor(creditos_disponibles / creditos_promedio)\n            : 0;\n\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"card rounded rounded-3 border-hover pointer mb-3\" onclick=\"elegirPlanCreditos(${i}, ${filtro_orden === 'Mayor' ? 'true' : 'false'});\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6 text-gray-10\">${plan.nombre}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        `);\n    }\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('show');\n    }\n\n    $('#buscador-plan-credito').off('input').on('input', function() {\n        mostrarPlanesCreditos();\n    });\n}\n\n/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}\n\n/**\n * Mostrar el plan de créditos seleccionado en el contenedor.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanCreditosSeleccionado() {\n    if (!plan_creditos_seleccionado || !plan_creditos_seleccionado.creditos) {\n        mostrarToast('danger', 'Ocurrió un error'+plan_creditos_seleccionado);\n        return;\n    }\n\n    let creditos_disponibles = plan_creditos_seleccionado.creditos_disponibles || plan_creditos_seleccionado.creditos || 0;\n    let creditos_promedio = plan_creditos_seleccionado.creditos_promedio_accion || 0;\n    let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n        ? Math.floor(creditos_disponibles / creditos_promedio)\n        : 0;\n\n    let seccion_creditos = `\n        <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n            <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n            <div class=\"card rounded rounded-3\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4 pointer\" onclick=\"modalElegirPlan(2);\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6\">${plan_creditos_seleccionado.nombre || 'Plan de Créditos'}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan_creditos_seleccionado.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    // Remover el contenedor anterior si existe\n    $('#contenedor-plan-creditos').remove();\n\n    // Agregar después del contenedor-plan o dentro de contenedor-creditos\n    if ($('#contenedor-creditos').length) {\n        $('#contenedor-creditos').html(seccion_creditos);\n    } else {\n        $('#contenedor-plan').after(seccion_creditos);\n    }\n}\n\n/**\n * Mostrar en el modal los planes obtenidos en el listado.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction mostrarPlanes(tipo_especifico = null) {\n    let buscar = $('#buscador-plan').val();\n    let filtro_plan = $('#filtro-plan').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        table.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    for (let i = 0; i < planes.length; i++) {\n        if (\n            (filtro_plan == 'Todos') ||\n            (filtro_plan == 'Ofertas' && planes[i].cantidad_ofertas_laborales != null) ||\n            (filtro_plan == 'Unidades' && planes[i].unidades != null) ||\n            (filtro_plan == 'Tiempo' && planes[i].vigencia != null)\n        ) {\n            let cantidad_usuarios = '';\n            if (planes[i].cantidad_usuarios != null) {\n                cantidad_usuarios = `<div class=\"col-auto w-90px\"><i class=\"bi bi-person\"></i> ${planes[i].cantidad_usuarios}</div>`;\n            }\n            let cantidad_ofertas_laborales = '';\n            if (planes[i].cantidad_ofertas_laborales != null) {\n                cantidad_ofertas_laborales = `<div class=\"col-auto w-90px\"><i class=\"bi bi-briefcase\"></i> ${planes[i].cantidad_ofertas_laborales}</div>`;\n            }\n            let cantidad_pruebas = '';\n            if (planes[i].cantidad_pruebas != null) {\n                cantidad_pruebas = `<div class=\"col-auto w-90px\"><i class=\"bi bi-clipboard2-check\"></i> ${planes[i].cantidad_pruebas}</div>`;\n            }\n            let unidades = '';\n            if (planes[i].unidades != null) {\n                unidades = `<div class=\"col-auto w-90px\"><i class=\"bi bi-box\"></i> ${planes[i].unidades}</div>`;\n            }\n            let vigencia = '';\n            if (planes[i].vigencia == 90) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n            } else if (planes[i].vigencia == 180) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n            }  else if (planes[i].vigencia == 365) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n            } else if (planes[i].vigencia == null || planes[i].vigencia == 0) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n            } else {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${planes[i].vigencia} días</div>`;\n            }\n            $('#tbody-planes').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-2 pointer border-hover\" onclick=\"elegirPlan(${i});\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6\">\n                                <div class=\"col\">${planes[i].nombre !== null ? planes[i].nombre : ''}</div>\n                                ${cantidad_ofertas_laborales}\n                                ${unidades}\n                                ${cantidad_usuarios}\n                                ${cantidad_pruebas}\n                                ${vigencia}\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('show');\n    }\n\n    table = $('#tabla-planes').DataTable({\n        \"paging\": false,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": false\n    });\n    let buscador = $('#tabla-planes_wrapper input');\n    $(buscador).addClass('rounded-2 text-body-2');\n    $(buscador).prop('placeholder', 'Buscar');\n    $(buscador).prop('id', 'buscador-plan');\n    $('#input-busqueda').append(buscador);\n    $(buscador).val(buscar).trigger('input');\n}\n\n/**\n * Elegir un plan del listado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction elegirPlan(i) {\n    plan_seleccionado = planes[i];\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Mostrar el plan seleccionado en el contenedor y en las opciones del modificar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction mostrarPlanSeleccionado() {\n    let cantidad_usuarios = '';\n    let cantidad_usuarios_modal = $('#cantidad_usuarios_modal').val();\n    if (cantidad_usuarios_modal != '') {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${cantidad_usuarios_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_usuarios != null) {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${plan_seleccionado.cantidad_usuarios}</div>`;\n    }\n    let cantidad_ofertas_laborales = '';\n    let cantidad_ofertas_laborales_modal = $('#cantidad_ofertas_laborales_modal').val();\n    if (cantidad_ofertas_laborales_modal != '') {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${cantidad_ofertas_laborales_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_ofertas_laborales != null) {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${plan_seleccionado.cantidad_ofertas_laborales}</div>`;\n    }\n    let cantidad_pruebas = '';\n    let cantidad_pruebas_modal = $('#cantidad_pruebas_modal').val();\n    if (cantidad_pruebas_modal != '') {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${cantidad_pruebas_modal}</div>`;\n        $('.cantidad-pruebas').text(cantidad_pruebas_modal);\n    } else if (plan_seleccionado.cantidad_pruebas != null) {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${plan_seleccionado.cantidad_pruebas}</div>`;\n        $('.cantidad-pruebas').text(plan_seleccionado.cantidad_pruebas);\n    }\n    let unidades = '';\n    let unidades_modal = $('#unidades_modal').val();\n    if (unidades_modal != '') {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${unidades_modal}</div>`;\n    } else if (plan_seleccionado.unidades != null) {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${plan_seleccionado.unidades}</div>`;\n    }\n    let vigencia = '';\n    let vigencia_modal = $('#vigencia_modal').val();\n    if (plan_seleccionado.vigencia == 90 || vigencia_modal == '90') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n    } else if (plan_seleccionado.vigencia == 180 || vigencia_modal == '180') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n    }  else if (plan_seleccionado.vigencia == 365 || vigencia_modal == '365') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n    } else if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n    } else if (vigencia_modal != '') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${vigencia_modal} días</div>`;\n    } else {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${plan_seleccionado.vigencia} días</div>`;\n    }\n    let abrir_modal_elegir_plan = '';\n    let icono_editar = `\n        <div class=\"col-auto w-90px\">\n            <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalModificar(event);\" title=\"Modificar plan\">\n                <i class=\"bi bi-wrench\"></i>\n            </button>\n        </div>\n    `;\n    if (opcion == 'asignar') {\n        abrir_modal_elegir_plan = `onclick=\"modalElegirPlan();\"`;\n        icono_editar = '';\n    }\n    $('#contenedor-plan').empty();\n    $('#contenedor-plan').append(`\n        <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n        <div class=\"card rounded rounded-3\">\n            <div class=\"row align-items-center m-0 w-100 px-3 py-5 text-headline-6 pointer\" ${abrir_modal_elegir_plan}>\n                <div class=\"col\">${plan_seleccionado.nombre !== null ? plan_seleccionado.nombre : ''} <span id=\"plan-modificado\"></span></div>\n                ${cantidad_ofertas_laborales}\n                ${unidades}\n                ${cantidad_usuarios}\n                ${cantidad_pruebas}\n                ${vigencia}\n                ${icono_editar}\n            </div>\n        </div>\n    `);\n\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n    // Solo agregar el botón de elegir plan de créditos si no hay uno seleccionado y se requiere\n    if (tiene_creditos && plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n        let seccion_creditos = `\n            <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                            Elegir Plan de Créditos IA\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;\n        $('#contenedor-creditos').append(seccion_creditos);\n    }\n\n    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\n/**\n * Buscar las funcionalidades por tipo de prueba.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidades(tipo_prueba_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/funcionalidades-listado`,\n        data : {\n            tipo_prueba_id: tipo_prueba_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let beneficios = respuesta.data;\n            const adicionales = beneficios\n                .filter(item => item.predeterminado === 0)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            const predefinidos = beneficios\n                .filter(item => item.predeterminado === 1)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            funcionalidades_predefinidos = predefinidos;\n\n            // Verificar si el multiselect está inicializado antes de destruir\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect('destroy');\n            }\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect('destroy');\n            }\n\n            adicionales.forEach((item) => {\n                $('#adicionales_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            predefinidos.forEach((item) => {\n                $('#predefinidos_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            inizializarMultiselect();\n            if (opcion == 'facturar' || opcion == 'editar') {\n                buscarfuncionalidadesPlanEmpresa($('#id').val());\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Buscar las funcionalidades del plan de la empresa.\n *\n * @param {number} empresa_plan_id ID del plan de empresa.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidadesPlanEmpresa(empresa_plan_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-planes-funcionalidades-listado`,\n        data : {\n            empresa_plan_id: empresa_plan_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let funcionalidades = respuesta.data.map(item => item.funcionalidad_id);\n            $('#adicionales_modal').val(funcionalidades);\n\n            // Verificar si el multiselect está inicializado antes de refrescar\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect(\"refresh\");\n            }\n\n            $('#predefinidos_modal').val(funcionalidades);\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect(\"refresh\");\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    $('#vigencia').val($('#vigencia_modal').val());\n    if ($('#unidades_modal').val() == 'Ilimitadas') {\n        $('#unidades').val('');\n    } else {\n        $('#unidades').val($('#unidades_modal').val());\n    }\n    if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n        $('#cantidad_ofertas_laborales').val('');\n    } else {\n        $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n    }\n    $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n    $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n    if (opcion == 'facturar' || opcion == 'editar') {\n        let adicionales = $('#adicionales_modal').val();\n        let predefinidos = $('#predefinidos_modal').val();\n        let funcionalidades = adicionales.concat(predefinidos);\n        $('#funcionalidades').val(JSON.stringify(funcionalidades));\n        if (funcionalidades.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n        }\n    } else {\n        let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n        $('#funcionalidades').val(JSON.stringify(ids));\n    }\n    var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n        return this.value;\n    }).get();\n    $('#pruebas').val('');\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (pruebas_seleccionadas.length == 0) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos una prueba.');\n    } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n    }\n    if (valido) {\n        $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n    }\n    return valido;\n}\n\n\n/**\n * Función para validar que no se exceda al seleccionar limite de pruebas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction ValidarPruebas() {\n    let cantidad_seleccionadas = $('.pruebas:checked').length;\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (cantidad_seleccionadas > maximo_pruebas) {\n        $('#alerta-pruebas').removeClass('d-none');\n    } else {\n        $('#alerta-pruebas').addClass('d-none');\n    }\n}\n\n/**\n * Abrir el modal con los campos para modificar plan.\n *\n * @param {Event} evento Evento desencadenado.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalModificar(evento) {\n    evento.stopPropagation();\n    if (modificado == false) {\n        $('#nombre-plan-modal').text(plan_seleccionado.nombre);\n        $('#cantidad_pruebas_modal').empty();\n        $('#cantidad_pruebas_modal').append(`\n            <option value=\"\">Seleccione</option>\n        `);\n        for (let j = 1; j <= pruebas.length; j++) {\n            $('#cantidad_pruebas_modal').append(`\n                <option value=\"${j}\">${j} Pruebas</option>\n            `);\n        }\n        $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n        if ([90, 180, 365].includes(plan_seleccionado.vigencia)) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val(plan_seleccionado.vigencia).trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else if (plan_seleccionado.vigencia != null && plan_seleccionado.vigencia != 0) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val('personalizado').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else {\n            $('#tiempo_modal').prop('disabled', true);\n            $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val('');\n        }\n        if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n            $('#unidades_modal').val(plan_seleccionado.unidades);\n            $('#unidades_modal').prop('disabled', false);\n            if (opcion == 'asignar') {\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa_plan.cantidad_ofertas_laborales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', false);\n        } else {\n            $('#unidades_modal').val(empresa.procesos_estimados_mensuales);\n            $('#unidades_modal').prop('disabled', true);\n            if (opcion == 'facturar' || opcion == 'editar') {\n                $('#unidades_modal').val(plan_seleccionado.unidades);\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa.pruebas_estimadas_mensuales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', true);\n        }\n        $('#cantidad_usuarios_modal').val(plan_seleccionado.cantidad_usuarios);\n        if (opcion == 'facturar' || opcion == 'editar') {\n            $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n            buscarfuncionalidadesPlanEmpresa($('#id').val());\n        }\n        $('#boton-guardar-modificaciones').prop('disabled', true);\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('show');\n    }\n}\n\n/**\n * Función que habilita el boton de guardar un plan modificado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction habilitarBotonGuardar() {\n    $('#boton-guardar-modificaciones').prop('disabled', false);\n}\n\n/**\n * Función que controla los campos de vigencia en el modal de editar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTiempo(vigencia) {\n    $('.texto-label-tiempo').text('máximas permitidas');\n    $('#input-container-tiempo').removeClass('d-none');\n    $('#input-container-tiempo').addClass('col-md-6');\n    if (vigencia == 'personalizado') {\n        $('#input-container-vigencia').removeClass('d-none');\n        $('#vigencia_modal').val('');\n    } else if ((vigencia == '' || vigencia == null || vigencia == 0) && plan_seleccionado != null && (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0)) {\n        $('.texto-label-tiempo').text('');\n        $('#input-container-tiempo').addClass('d-none');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val('');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    } else if (['90', '180', '365'].includes(vigencia)) {\n        $('#input-container-tiempo').removeClass('col-md-6');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val(vigencia);\n    } else {\n        $('#vigencia_modal').val(vigencia);\n        $('#input-container-vigencia').addClass('d-none');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    }\n}\n\n/**\n * Abrir el modal de confirmación.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalEstasSeguro() {\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('hide');\n        $('#modal-estas-seguro').modal('show');\n    }\n}\n\n/**\n * Cancelar la edición de un plan.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction cancelarEdicion() {\n    modificado = false;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    limpiarAdicional();\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Confirmar los datos editados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction confirmarEdicion() {\n    modificado = true;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    $('#plan-modificado').text('(modificado)');\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Limpiar los campos del modal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction limpiarAdicional() {\n    $('#cantidad_pruebas_modal').val('').trigger('change').trigger('select2:select');\n    $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n    $('#unidades_modal').val('');\n    $('#cantidad_ofertas_laborales_modal').val('');\n    $('#cantidad_usuarios_modal').val('');\n\n    // Verificar si el multiselect está inicializado antes de llamar uncheckAll\n    if ($('#adicionales_modal').data('multiselect')) {\n        $('#adicionales_modal').multiselect(\"uncheckAll\");\n    }\n\n    if ($('#predefinidos_modal').data('multiselect')) {\n        $('#predefinidos_modal').multiselect(\"uncheckAll\");\n    }\n}\n\n/**\n * Función para ejecutar acciones luego de guardar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction postSuccess(respuesta) {\n    limpiarFormulario(respuesta.formulario);\n    if (opcion == 'asignar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se asignó con éxito a la empresa`,\n        }));\n    } else if (opcion == 'facturar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se facturó con éxito`,\n        }));\n    } else if (opcion == 'editar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se actualizó con éxito`,\n        }));\n    }\n    window.location.href='/empresas-gestionar/' + empresa.id;\n}\n","structuredPatch":[{"oldStart":763,"oldLines":53,"newStart":763,"newLines":89,"lines":["  *","  * @returns {void}","  * @author José Manuel Jiménez","+ * @author Andres Gonzalez","  */"," function validacionAdicional() {","     let valido = true;","-    $('#vigencia').val($('#vigencia_modal').val());","-    if ($('#unidades_modal').val() == 'Ilimitadas') {","-        $('#unidades').val('');","-    } else {","-        $('#unidades').val($('#unidades_modal').val());","+    let tipos_prueba = $('#tipo_prueba_id').val() || [];","+    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);","+    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);","+","+    // Validar que al menos un tipo de plan esté seleccionado","+    if (!tiene_seleccion && !tiene_creditos) {","+        valido = false;","+        mostrarToast('danger', 'Seleccione al menos un tipo de plan.');","+        return valido;","     }","-    if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {","-        $('#cantidad_ofertas_laborales').val('');","-    } else {","-        $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());","+","+    // Validar plan de selección solo si está seleccionado el tipo 1","+    if (tiene_seleccion) {","+        if (!$('#plan_id').val()) {","+            valido = false;","+            mostrarToast('danger', 'Seleccione un plan de selección.');","+            return valido;","+        }","+","+        $('#vigencia').val($('#vigencia_modal').val());","+        if ($('#unidades_modal').val() == 'Ilimitadas') {","+            $('#unidades').val('');","+        } else {","+            $('#unidades').val($('#unidades_modal').val());","+        }","+        if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {","+            $('#cantidad_ofertas_laborales').val('');","+        } else {","+            $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());","+        }","+        $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());","+        $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());","+","+        if (opcion == 'facturar' || opcion == 'editar') {","+            let adicionales = $('#adicionales_modal').val() || [];","+            let predefinidos = $('#predefinidos_modal').val() || [];","+            let funcionalidades = adicionales.concat(predefinidos);","+            $('#funcionalidades').val(JSON.stringify(funcionalidades));","+            if (funcionalidades.length == 0) {","+                valido = false;","+                mostrarToast('danger', 'Seleccione al menos una funcionalidad.');","+                return valido;","+            }","+        } else {","+            let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);","+            $('#funcionalidades').val(JSON.stringify(ids));","+        }","+","+        var pruebas_seleccionadas = $('.pruebas:checked').map(function() {","+            return this.value;","+        }).get();","+        $('#pruebas').val('');","+        let maximo_pruebas = $('#cantidad_pruebas_modal').val();","+        if (maximo_pruebas == '') {","+            maximo_pruebas = plan_seleccionado.cantidad_pruebas;","+        }","+        if (pruebas_seleccionadas.length == 0) {","+            valido = false;","+            mostrarToast('danger', 'Seleccione al menos una prueba.');","+            return valido;","+        } else if (pruebas_seleccionadas.length > maximo_pruebas) {","+            valido = false;","+            mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');","+            return valido;","+        }","+        if (valido) {","+            $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));","+        }","     }","-    $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());","-    $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());","-    if (opcion == 'facturar' || opcion == 'editar') {","-        let adicionales = $('#adicionales_modal').val();","-        let predefinidos = $('#predefinidos_modal').val();","-        let funcionalidades = adicionales.concat(predefinidos);","-        $('#funcionalidades').val(JSON.stringify(funcionalidades));","-        if (funcionalidades.length == 0) {","+","+    // Validar plan de créditos solo si está seleccionado el tipo 2","+    if (tiene_creditos) {","+        if (!$('#plan_credito_id').val()) {","             valido = false;","-            mostrarToast('danger', 'Seleccione al menos una funcionalidad.');","+            mostrarToast('danger', 'Seleccione un plan de créditos IA.');","+            return valido;","         }","-    } else {","-        let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);","-        $('#funcionalidades').val(JSON.stringify(ids));","     }","-    var pruebas_seleccionadas = $('.pruebas:checked').map(function() {","-        return this.value;","-    }).get();","-    $('#pruebas').val('');","-    let maximo_pruebas = $('#cantidad_pruebas_modal').val();","-    if (maximo_pruebas == '') {","-        maximo_pruebas = plan_seleccionado.cantidad_pruebas;","-    }","-    if (pruebas_seleccionadas.length == 0) {","-        valido = false;","-        mostrarToast('danger', 'Seleccione al menos una prueba.');","-    } else if (pruebas_seleccionadas.length > maximo_pruebas) {","-        valido = false;","-        mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');","-    }","-    if (valido) {","-        $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));","-    }","+","     return valido;"," }"," "]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"94d09081-4bc5-49cd-a71b-3b1684e08562"}
{"parentUuid":"7f32e827-829f-47ac-8680-e0ca5eddbbd2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Rg2H1z1LQt3A1ScSrmUkHJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019RgN3gEBW7ecV7KNp5bTJM","name":"TodoWrite","input":{"todos":[{"content":"Modificar el campo plan_id para que no sea required por defecto","status":"completed","activeForm":"Modificando campo plan_id en el Blade"},{"content":"Agregar lógica JS para validar campos según tipo de plan seleccionado","status":"completed","activeForm":"Agregando validación dinámica en JS"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":3476,"cache_read_input_tokens":55964,"cache_creation":{"ephemeral_5m_input_tokens":3476,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXK3AhRX1txTpm37SYbKr","type":"assistant","uuid":"d6c0ff7f-640c-43cb-a479-2331ccea8875","timestamp":"2026-01-20T17:38:55.467Z"}
{"parentUuid":"d6c0ff7f-640c-43cb-a479-2331ccea8875","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019RgN3gEBW7ecV7KNp5bTJM","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"a3b0dc77-7839-4012-92a3-ffe83822a490","timestamp":"2026-01-20T17:38:55.612Z","toolUseResult":{"oldTodos":[{"content":"Modificar el campo plan_id para que no sea required por defecto","status":"completed","activeForm":"Modificando campo plan_id en el Blade"},{"content":"Agregar lógica JS para validar campos según tipo de plan seleccionado","status":"in_progress","activeForm":"Agregando validación dinámica en JS"}],"newTodos":[{"content":"Modificar el campo plan_id para que no sea required por defecto","status":"completed","activeForm":"Modificando campo plan_id en el Blade"},{"content":"Agregar lógica JS para validar campos según tipo de plan seleccionado","status":"completed","activeForm":"Agregando validación dinámica en JS"}]},"sourceToolAssistantUUID":"d6c0ff7f-640c-43cb-a479-2331ccea8875"}
{"parentUuid":"a3b0dc77-7839-4012-92a3-ffe83822a490","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MpeXj7s9jF2XtjRBqE3T4P","type":"message","role":"assistant","content":[{"type":"text","text":"Los cambios están listos. Te explico lo que hice:\n\n## Resumen de cambios\n\n### 1. [asignar-plan.blade.php:70](resources/views/empresas/paginas/asignar-plan.blade.php#L70)\n- Cambié `required: true` a `required: false` en el campo oculto `plan_id`\n- Esto evita que el navegador valide el campo como obligatorio siempre\n\n### 2. [asignar-plan.js:768-850](public/js/empresas/asignar-plan.js#L768-L850)\n- Modifiqué la función `validacionAdicional()` para hacer validación dinámica según los tipos de plan seleccionados:\n\n**Nueva lógica:**\n1. Detecta qué tipos de plan están seleccionados (`tiene_seleccion` y `tiene_creditos`)\n2. Si no hay ningún tipo seleccionado → muestra error \"Seleccione al menos un tipo de plan\"\n3. **Si solo está seleccionado \"Planes de selección\" (tipo 1):**\n   - Valida que se haya elegido un plan de selección\n   - Valida pruebas, funcionalidades, etc.\n4. **Si solo está seleccionado \"Planes de créditos IA\" (tipo 2):**\n   - Solo valida que se haya elegido un plan de créditos\n   - NO valida pruebas ni plan de selección\n5. **Si ambos están seleccionados:**\n   - Valida ambos planes\n\nAhora puedes:\n- Seleccionar solo \"Planes de créditos (IA)\" → elegir plan de créditos → guardar ✓\n- Seleccionar solo \"Planes de selección\" → elegir plan y pruebas → guardar ✓\n- Seleccionar ambos → elegir ambos planes y pruebas → guardar ✓"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":209,"cache_read_input_tokens":59440,"cache_creation":{"ephemeral_5m_input_tokens":209,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXK3B56FeEPBUfjmD1xA5","type":"assistant","uuid":"feba2b01-ecaf-4b5d-9154-f8d58b6aeade","timestamp":"2026-01-20T17:39:05.463Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-20T17:45:42.683Z","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565"}
{"type":"file-history-snapshot","messageId":"12416f4c-f180-4801-b82f-851af7cf7d70","snapshot":{"messageId":"12416f4c-f180-4801-b82f-851af7cf7d70","trackedFileBackups":{"resources\\views\\empresas\\paginas\\asignar-plan.blade.php":{"backupFileName":"23a0b404d58f48f6@v2","version":2,"backupTime":"2026-01-20T17:45:44.948Z"},"public\\js\\empresas\\asignar-plan.js":{"backupFileName":"25fa1d462d51e622@v2","version":2,"backupTime":"2026-01-20T17:45:44.979Z"}},"timestamp":"2026-01-20T17:45:44.902Z"},"isSnapshotUpdate":false}
{"parentUuid":"4d3b2e48-285d-45e5-a841-b62f2168fc2c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_0133L18s723Ceg8ui8g5s9Ry","parentToolUseID":"toolu_0133L18s723Ceg8ui8g5s9Ry","uuid":"671f9e31-13a1-4839-8a08-2da7ad123181","timestamp":"2026-01-20T17:35:59.833Z"}
{"parentUuid":"5572f882-1ead-4097-8c0e-70eade9d0c7f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01JiYPcs6fzBb4RQMqgcstqJ","parentToolUseID":"toolu_01JiYPcs6fzBb4RQMqgcstqJ","uuid":"ca3e9df5-ac3d-43cc-beb9-2f26df262716","timestamp":"2026-01-20T17:36:14.525Z"}
{"parentUuid":"ca3e9df5-ac3d-43cc-beb9-2f26df262716","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01JiYPcs6fzBb4RQMqgcstqJ","parentToolUseID":"toolu_01JiYPcs6fzBb4RQMqgcstqJ","uuid":"fac81957-fbd6-435a-8ee1-0225f5617d27","timestamp":"2026-01-20T17:36:14.525Z"}
{"parentUuid":"e5ef8956-3d95-4fd5-98a9-5a22b963ac64","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01JiYPcs6fzBb4RQMqgcstqJ","toolUseID":"toolu_01JiYPcs6fzBb4RQMqgcstqJ","timestamp":"2026-01-20T17:37:10.626Z","uuid":"ca91c9d2-7e39-439e-a5f1-973086f31f5e"}
{"parentUuid":"0ca77240-2171-45b3-b0c1-62e68ab6301b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_014RRpLah27ryLYRrXWcvvqg","parentToolUseID":"toolu_014RRpLah27ryLYRrXWcvvqg","uuid":"7d43b21e-ebf4-431b-ae04-7f74f7e926eb","timestamp":"2026-01-20T17:37:38.507Z"}
{"parentUuid":"7d43b21e-ebf4-431b-ae04-7f74f7e926eb","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_014RRpLah27ryLYRrXWcvvqg","parentToolUseID":"toolu_014RRpLah27ryLYRrXWcvvqg","uuid":"5b84200c-7fec-4e75-9d78-1e8dbb3ee670","timestamp":"2026-01-20T17:37:38.509Z"}
{"parentUuid":"94d09081-4bc5-49cd-a71b-3b1684e08562","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_0173n9wQAXn6wcT2jgR4SX48","parentToolUseID":"toolu_0173n9wQAXn6wcT2jgR4SX48","uuid":"e4ddb5f5-4474-4d3e-a99b-fcc2f8559cde","timestamp":"2026-01-20T17:38:36.877Z"}
{"parentUuid":"e4ddb5f5-4474-4d3e-a99b-fcc2f8559cde","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_0173n9wQAXn6wcT2jgR4SX48","parentToolUseID":"toolu_0173n9wQAXn6wcT2jgR4SX48","uuid":"2e9613cf-4e21-42a7-9341-ea5c7c08ae12","timestamp":"2026-01-20T17:38:36.877Z"}
{"parentUuid":"7f32e827-829f-47ac-8680-e0ca5eddbbd2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_0173n9wQAXn6wcT2jgR4SX48","toolUseID":"toolu_0173n9wQAXn6wcT2jgR4SX48","timestamp":"2026-01-20T17:38:49.477Z","uuid":"d8514053-c7f1-4dcb-858a-b9c8aa4ab790"}
{"parentUuid":"feba2b01-ecaf-4b5d-9154-f8d58b6aeade","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_opened_file>The user opened the file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js in the IDE. This may or may not be related to the current task.</ide_opened_file>"},{"type":"text","text":"listo funciona pero quiero que despues de que se elja un plan ya sea de ia o el otro y para cen como lo slecionado en esa seccion y si se desmarca que se borre todo lo de ese oplan"}]},"uuid":"12416f4c-f180-4801-b82f-851af7cf7d70","timestamp":"2026-01-20T17:45:44.899Z","todos":[]}
{"parentUuid":"12416f4c-f180-4801-b82f-851af7cf7d70","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_012BpxWnMPBMptLBkG8tUbsc","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo, quieres que cuando se deseleccione un tipo de plan del multiselect, se limpien los datos de ese plan que ya estaba seleccionado. Voy a modificar la función `seleccionarTipoPruebaMultiple()` para que limpie correctamente los planes cuando se desmarquen."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":62427,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":62427,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK3hEGFA7mEqdFYgfCZm","type":"assistant","uuid":"0b949d50-1eea-4e2d-81b3-307419897514","timestamp":"2026-01-20T17:45:49.089Z"}
{"parentUuid":"0b949d50-1eea-4e2d-81b3-307419897514","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_012BpxWnMPBMptLBkG8tUbsc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FLGpNAyTvrzWEVBBehYVxE","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","offset":107,"limit":130}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":62427,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":62427,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK3hEGFA7mEqdFYgfCZm","type":"assistant","uuid":"48462ead-4885-4a95-850c-d5a98039852a","timestamp":"2026-01-20T17:45:49.930Z"}
{"parentUuid":"48462ead-4885-4a95-850c-d5a98039852a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FLGpNAyTvrzWEVBBehYVxE","type":"tool_result","content":"   107→/**\n   108→ * Establecer el tipo de prueba en el selector del formulario.\n   109→ *\n   110→ * @param {number} tipo_prueba_id ID del tipo de prueba.\n   111→ * @returns {void}\n   112→ * @author Jair Carvajal\n   113→ */\n   114→function seleccionarTipoPruebaMultiple() {\n   115→    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n   116→\n   117→    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n   118→        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n   119→    });\n   120→\n   121→    if (tipos_prueba.length === 0) {\n   122→        // Si no hay tipos seleccionados, limpiar todo\n   123→        $('#contenedor-plan').empty();\n   124→        $('#contenedor-creditos').empty();\n   125→        $('#seccion-pruebas').addClass('d-none');\n   126→        $('#plan_id').val('');\n   127→        $('#plan_credito_id').val('');\n   128→        $('#creditos').val('');\n   129→        plan_seleccionado = null;\n   130→        plan_creditos_seleccionado = null;\n   131→        pruebas = [];\n   132→        return;\n   133→    }\n   134→\n   135→    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n   136→    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n   137→\n   138→    // Manejo del plan de selección\n   139→    if (tiene_seleccion) {\n   140→        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n   141→        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n   142→            let seccion_seleccion = `\n   143→                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n   144→                <div class=\"card rounded rounded-3\">\n   145→                    <div class=\"card-body text-center\">\n   146→                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n   147→                            Elegir Plan de Selección\n   148→                        </button>\n   149→                    </div>\n   150→                </div>\n   151→            `;\n   152→            $('#contenedor-plan').html(seccion_seleccion);\n   153→        }\n   154→    } else {\n   155→        // Si se deseleccionó el tipo de selección, limpiar el plan\n   156→        $('#contenedor-plan').empty();\n   157→        plan_seleccionado = null;\n   158→        $('#plan_id').val('');\n   159→    }\n   160→\n   161→    // Manejo del plan de créditos\n   162→    if (tiene_creditos) {\n   163→        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n   164→        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n   165→            let seccion_creditos = `\n   166→                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n   167→                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n   168→                    <div class=\"card rounded rounded-3\">\n   169→                        <div class=\"card-body text-center\">\n   170→                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n   171→                                Elegir Plan de Créditos IA\n   172→                            </button>\n   173→                        </div>\n   174→                    </div>\n   175→                </div>\n   176→            `;\n   177→            $('#contenedor-creditos').html(seccion_creditos);\n   178→        }\n   179→    } else {\n   180→        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n   181→        $('#contenedor-creditos').empty();\n   182→        $('#contenedor-plan-creditos').remove();\n   183→        plan_creditos_seleccionado = null;\n   184→        $('#plan_credito_id').val('');\n   185→        $('#creditos').val('');\n   186→    }\n   187→\n   188→    $.ajax({\n   189→        type: 'GET',\n   190→        url : `/pruebas-listado`,\n   191→        data: {\n   192→            tipo_prueba_id: tipos_prueba,\n   193→            activo: 1\n   194→        }\n   195→    }).then((respuesta) => {\n   196→        limpiarAdicional();\n   197→        $('#contenedor-pruebas').empty();\n   198→        pruebas = respuesta.data;\n   199→        for (let i = 0; i < pruebas.length; i++) {\n   200→            $('#contenedor-pruebas').append(`\n   201→                <div class=\"col-12 col-md-6\">\n   202→                    <div class=\"d-flex align-items-center\">\n   203→                        <div class=\"check-container my-1 me-1\">\n   204→                            <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n   205→                        </div>\n   206→                        <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n   207→                    </div>\n   208→                </div>\n   209→            `);\n   210→        }\n   211→\n   212→        if (opcion == 'facturar' || opcion == 'editar') {\n   213→            for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n   214→                $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n   215→            }\n   216→            $('#seccion-pruebas').removeClass('d-none');\n   217→            mostrarPlanSeleccionado();\n   218→        }\n   219→\n   220→        if (opcion == 'editar') {\n   221→            $('#tipo_prueba_id').prop('disabled', true);\n   222→        }\n   223→    }).catch((error) => {\n   224→        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n   225→    });\n   226→}\n   227→\n   228→/**\n   229→ * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n   230→ *\n   231→ * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n   232→ * @returns {void}\n   233→ * @author José Manuel Jiménez\n   234→ * @author Jair Carvajal\n   235→ */\n   236→function modalElegirPlan(tipo_especifico = null) {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1a8fc2ff-a1df-4b31-8c91-cc45a79248fc","timestamp":"2026-01-20T17:45:51.206Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","content":"/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan\n        $('#contenedor-plan').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/pruebas-listado`,\n        data: {\n            tipo_prueba_id: tipos_prueba,\n            activo: 1\n        }\n    }).then((respuesta) => {\n        limpiarAdicional();\n        $('#contenedor-pruebas').empty();\n        pruebas = respuesta.data;\n        for (let i = 0; i < pruebas.length; i++) {\n            $('#contenedor-pruebas').append(`\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"d-flex align-items-center\">\n                        <div class=\"check-container my-1 me-1\">\n                            <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                        </div>\n                        <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                    </div>\n                </div>\n            `);\n        }\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n            }\n            $('#seccion-pruebas').removeClass('d-none');\n            mostrarPlanSeleccionado();\n        }\n\n        if (opcion == 'editar') {\n            $('#tipo_prueba_id').prop('disabled', true);\n        }\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    });\n}\n\n/**\n * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Jair Carvajal\n */\nfunction modalElegirPlan(tipo_especifico = null) {","numLines":130,"startLine":107,"totalLines":1084}},"sourceToolAssistantUUID":"48462ead-4885-4a95-850c-d5a98039852a"}
{"parentUuid":"1a8fc2ff-a1df-4b31-8c91-cc45a79248fc","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J8zCfWUgQ5QkksQ4ZmSnY9","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora veo el código. La función ya tiene lógica para limpiar cuando se deselecciona, pero necesita también limpiar la sección de pruebas y otros campos relacionados. Voy a mejorar la función:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2307,"cache_read_input_tokens":62427,"cache_creation":{"ephemeral_5m_input_tokens":2307,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXK3hivfhx439kyg8EaVR","type":"assistant","uuid":"cd2a2e07-4e82-4046-ad95-3daa64c73b3b","timestamp":"2026-01-20T17:45:55.285Z"}
{"parentUuid":"cd2a2e07-4e82-4046-ad95-3daa64c73b3b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J8zCfWUgQ5QkksQ4ZmSnY9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019A5r9ikCopzcJTRiBZBYUR","name":"TodoWrite","input":{"todos":[{"content":"Mejorar limpieza de datos al deseleccionar tipo de plan en seleccionarTipoPruebaMultiple()","status":"in_progress","activeForm":"Mejorando limpieza de datos al deseleccionar planes"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2307,"cache_read_input_tokens":62427,"cache_creation":{"ephemeral_5m_input_tokens":2307,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXK3hivfhx439kyg8EaVR","type":"assistant","uuid":"69972e4e-f45f-4028-99c0-ffe1e6906c67","timestamp":"2026-01-20T17:45:56.735Z"}
{"parentUuid":"69972e4e-f45f-4028-99c0-ffe1e6906c67","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019A5r9ikCopzcJTRiBZBYUR","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"d9f5fdd8-9404-4a76-b402-88cb3f8635a3","timestamp":"2026-01-20T17:45:56.881Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Mejorar limpieza de datos al deseleccionar tipo de plan en seleccionarTipoPruebaMultiple()","status":"in_progress","activeForm":"Mejorando limpieza de datos al deseleccionar planes"}]},"sourceToolAssistantUUID":"69972e4e-f45f-4028-99c0-ffe1e6906c67"}
{"parentUuid":"d9f5fdd8-9404-4a76-b402-88cb3f8635a3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BpVzFds4dt5dNFxiUPftbj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015HrfPUFrA4VY7xBKvxQuow","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","old_string":"/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan\n        $('#contenedor-plan').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/pruebas-listado`,\n        data: {\n            tipo_prueba_id: tipos_prueba,\n            activo: 1\n        }\n    }).then((respuesta) => {\n        limpiarAdicional();\n        $('#contenedor-pruebas').empty();\n        pruebas = respuesta.data;\n        for (let i = 0; i < pruebas.length; i++) {\n            $('#contenedor-pruebas').append(`\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"d-flex align-items-center\">\n                        <div class=\"check-container my-1 me-1\">\n                            <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                        </div>\n                        <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                    </div>\n                </div>\n            `);\n        }\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n            }\n            $('#seccion-pruebas').removeClass('d-none');\n            mostrarPlanSeleccionado();\n        }\n\n        if (opcion == 'editar') {\n            $('#tipo_prueba_id').prop('disabled', true);\n        }\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    });\n}","new_string":"/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n * @author Andres Gonzalez\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        limpiarAdicional();\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan y campos relacionados\n        $('#contenedor-plan').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        pruebas = [];\n        limpiarAdicional();\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    // Solo cargar pruebas si hay plan de selección\n    if (tiene_seleccion) {\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipos_prueba,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error al cargar las pruebas');\n        });\n    }\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":217,"cache_read_input_tokens":64734,"cache_creation":{"ephemeral_5m_input_tokens":217,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXK3i6n4ntL9pTYbgGG97","type":"assistant","uuid":"fd13cdd0-61db-43ce-85bb-ec9162df1040","timestamp":"2026-01-20T17:46:23.692Z"}
{"parentUuid":"fd13cdd0-61db-43ce-85bb-ec9162df1040","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015HrfPUFrA4VY7xBKvxQuow","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   103→        });\n   104→    }\n   105→}\n   106→\n   107→/**\n   108→ * Establecer el tipo de prueba en el selector del formulario.\n   109→ *\n   110→ * @param {number} tipo_prueba_id ID del tipo de prueba.\n   111→ * @returns {void}\n   112→ * @author Jair Carvajal\n   113→ * @author Andres Gonzalez\n   114→ */\n   115→function seleccionarTipoPruebaMultiple() {\n   116→    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n   117→\n   118→    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n   119→        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n   120→    });\n   121→\n   122→    if (tipos_prueba.length === 0) {\n   123→        // Si no hay tipos seleccionados, limpiar todo\n   124→        $('#contenedor-plan').empty();\n   125→        $('#contenedor-creditos').empty();\n   126→        $('#seccion-pruebas').addClass('d-none');\n   127→        $('#contenedor-pruebas').empty();\n   128→        $('#plan_id').val('');\n   129→        $('#plan_credito_id').val('');\n   130→        $('#creditos').val('');\n   131→        $('#pruebas').val('');\n   132→        $('#vigencia').val('');\n   133→        $('#unidades').val('');\n   134→        $('#cantidad_ofertas_laborales').val('');\n   135→        $('#cantidad_usuarios').val('');\n   136→        $('#cantidad_pruebas').val('');\n   137→        $('#funcionalidades').val('');\n   138→        plan_seleccionado = null;\n   139→        plan_creditos_seleccionado = null;\n   140→        pruebas = [];\n   141→        limpiarAdicional();\n   142→        return;\n   143→    }\n   144→\n   145→    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n   146→    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n   147→\n   148→    // Manejo del plan de selección\n   149→    if (tiene_seleccion) {\n   150→        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n   151→        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n   152→            let seccion_seleccion = `\n   153→                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n   154→                <div class=\"card rounded rounded-3\">\n   155→                    <div class=\"card-body text-center\">\n   156→                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n   157→                            Elegir Plan de Selección\n   158→                        </button>\n   159→                    </div>\n   160→                </div>\n   161→            `;\n   162→            $('#contenedor-plan').html(seccion_seleccion);\n   163→        }\n   164→    } else {\n   165→        // Si se deseleccionó el tipo de selección, limpiar el plan y campos relacionados\n   166→        $('#contenedor-plan').empty();\n   167→        $('#seccion-pruebas').addClass('d-none');\n   168→        $('#contenedor-pruebas').empty();\n   169→        plan_seleccionado = null;\n   170→        $('#plan_id').val('');\n   171→        $('#pruebas').val('');\n   172→        $('#vigencia').val('');\n   173→        $('#unidades').val('');\n   174→        $('#cantidad_ofertas_laborales').val('');\n   175→        $('#cantidad_usuarios').val('');\n   176→        $('#cantidad_pruebas').val('');\n   177→        $('#funcionalidades').val('');\n   178→        pruebas = [];\n   179→        limpiarAdicional();\n   180→    }\n   181→\n   182→    // Manejo del plan de créditos\n   183→    if (tiene_creditos) {\n   184→        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n   185→        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n   186→            let seccion_creditos = `\n   187→                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n   188→                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n   189→                    <div class=\"card rounded rounded-3\">\n   190→                        <div class=\"card-body text-center\">\n   191→                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n   192→                                Elegir Plan de Créditos IA\n   193→                            </button>\n   194→                        </div>\n   195→                    </div>\n   196→                </div>\n   197→            `;\n   198→            $('#contenedor-creditos').html(seccion_creditos);\n   199→        }\n   200→    } else {\n   201→        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n   202→        $('#contenedor-creditos').empty();\n   203→        $('#contenedor-plan-creditos').remove();\n   204→        plan_creditos_seleccionado = null;\n   205→        $('#plan_credito_id').val('');\n   206→        $('#creditos').val('');\n   207→    }\n   208→\n   209→    // Solo cargar pruebas si hay plan de selección\n   210→    if (tiene_seleccion) {\n   211→        $.ajax({\n   212→            type: 'GET',\n   213→            url : `/pruebas-listado`,\n   214→            data: {\n   215→                tipo_prueba_id: tipos_prueba,\n   216→                activo: 1\n   217→            }\n   218→        }).then((respuesta) => {\n   219→            limpiarAdicional();\n   220→            $('#contenedor-pruebas').empty();\n   221→            pruebas = respuesta.data;\n   222→            for (let i = 0; i < pruebas.length; i++) {\n   223→                $('#contenedor-pruebas').append(`\n   224→                    <div class=\"col-12 col-md-6\">\n   225→                        <div class=\"d-flex align-items-center\">\n   226→                            <div class=\"check-container my-1 me-1\">\n   227→                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n   228→                            </div>\n   229→                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n   230→                        </div>\n   231→                    </div>\n   232→                `);\n   233→            }\n   234→\n   235→            if (opcion == 'facturar' || opcion == 'editar') {\n   236→                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n   237→                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n   238→                }\n   239→                $('#seccion-pruebas').removeClass('d-none');\n   240→                mostrarPlanSeleccionado();\n   241→            }\n   242→\n   243→            if (opcion == 'editar') {\n   244→                $('#tipo_prueba_id').prop('disabled', true);\n   245→            }\n   246→        }).catch((error) => {\n   247→            mostrarToast('danger', 'Ocurrió un error al cargar las pruebas');\n   248→        });\n   249→    }\n   250→}\n   251→\n   252→/**\n   253→ * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n   254→ *"}]},"uuid":"e20be97f-d89d-4689-85e2-29c2504c8497","timestamp":"2026-01-20T17:46:43.775Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","oldString":"/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan\n        $('#contenedor-plan').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/pruebas-listado`,\n        data: {\n            tipo_prueba_id: tipos_prueba,\n            activo: 1\n        }\n    }).then((respuesta) => {\n        limpiarAdicional();\n        $('#contenedor-pruebas').empty();\n        pruebas = respuesta.data;\n        for (let i = 0; i < pruebas.length; i++) {\n            $('#contenedor-pruebas').append(`\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"d-flex align-items-center\">\n                        <div class=\"check-container my-1 me-1\">\n                            <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                        </div>\n                        <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                    </div>\n                </div>\n            `);\n        }\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n            }\n            $('#seccion-pruebas').removeClass('d-none');\n            mostrarPlanSeleccionado();\n        }\n\n        if (opcion == 'editar') {\n            $('#tipo_prueba_id').prop('disabled', true);\n        }\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    });\n}","newString":"/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n * @author Andres Gonzalez\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        limpiarAdicional();\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan y campos relacionados\n        $('#contenedor-plan').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        pruebas = [];\n        limpiarAdicional();\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    // Solo cargar pruebas si hay plan de selección\n    if (tiene_seleccion) {\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipos_prueba,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error al cargar las pruebas');\n        });\n    }\n}","originalFile":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPrueba(tipo_prueba_id) {\n    $('#contenedor-plan').empty();\n    $('#seccion-pruebas').addClass('d-none');\n    $('#plan_id').val('');\n    pruebas = [];\n\n    // Convertir tipo_prueba_id a array si no lo es\n    let tipos_prueba = Array.isArray(tipo_prueba_id) ? tipo_prueba_id : [tipo_prueba_id];\n\n    // Crear los botones según los tipos de prueba seleccionados\n    let botones_html = '<div class=\"card-body text-center\">';\n\n    tipos_prueba.forEach(function(tipo_id) {\n        let texto_boton = 'Elegir plan';\n        let clase_boton = 'btn-outline-primary';\n\n        if (tipo_id == 1) {\n            texto_boton = 'Elegir Plan de Selección';\n            clase_boton = 'btn-outline-primary';\n        } else if (tipo_id == 2) {\n            texto_boton = 'Elegir Plan de Créditos IA';\n            clase_boton = 'btn-outline-info';\n        }\n\n        botones_html += `\n            <button type=\"button\" id=\"elegir-plan-${tipo_id}\" class=\"btn ${clase_boton} mx-1 my-1\" disabled onclick=\"modalElegirPlan(${tipo_id});\">\n                ${texto_boton}\n            </button>\n        `;\n    });\n\n    botones_html += '</div>';\n    $('#contenedor-plan').append(botones_html);\n\n    $('#tipo_prueba_id').val(tipo_prueba_id).trigger('select2');\n\n    if (tipo_prueba_id && (Array.isArray(tipo_prueba_id) ? tipo_prueba_id.length > 0 : tipo_prueba_id)) {\n        // Habilitar todos los botones creados\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', false);\n        });\n\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipo_prueba_id,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n    } else {\n        // Deshabilitar todos los botones si no hay tipo de prueba\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', true);\n        });\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan\n        $('#contenedor-plan').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/pruebas-listado`,\n        data: {\n            tipo_prueba_id: tipos_prueba,\n            activo: 1\n        }\n    }).then((respuesta) => {\n        limpiarAdicional();\n        $('#contenedor-pruebas').empty();\n        pruebas = respuesta.data;\n        for (let i = 0; i < pruebas.length; i++) {\n            $('#contenedor-pruebas').append(`\n                <div class=\"col-12 col-md-6\">\n                    <div class=\"d-flex align-items-center\">\n                        <div class=\"check-container my-1 me-1\">\n                            <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                        </div>\n                        <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                    </div>\n                </div>\n            `);\n        }\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n            }\n            $('#seccion-pruebas').removeClass('d-none');\n            mostrarPlanSeleccionado();\n        }\n\n        if (opcion == 'editar') {\n            $('#tipo_prueba_id').prop('disabled', true);\n        }\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    });\n}\n\n/**\n * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Jair Carvajal\n */\nfunction modalElegirPlan(tipo_especifico = null) {\n    let tipo_prueba_para_consulta = tipo_especifico !== null ? tipo_especifico : $('#tipo_prueba_id').val();\n\n    // Si es tipo 2 (Créditos IA), cargar planes de créditos\n    if (tipo_prueba_para_consulta == 2 || tipo_prueba_para_consulta == '2') {\n        $.ajax({\n            type: 'GET',\n            url: '/api/planes-creditos',\n            data: {\n                activo: true\n            }\n        }).then((respuesta) => {\n            planes_creditos = respuesta.data.planes;            \n            mostrarPlanesCreditos();\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n        return;\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/planes-listado`,\n        data: {\n            tipo_prueba_id: tipo_prueba_para_consulta\n        }\n    }).then((respuesta) => {\n        planes = respuesta.data;\n        mostrarPlanes(tipo_especifico);\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error');\n    });\n}\n\n/**\n * Mostrar los planes de créditos en el modal.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanesCreditos() {\n    let filtro_orden = $('#filtro-plan-credito').val();\n    let buscar = $('#buscador-plan-credito').val() || '';\n\n    // Ordenar planes según el filtro\n    let planes_ordenados = [...planes_creditos];\n    if (filtro_orden === 'Mayor') {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else if (filtro_orden === 'Menor') {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n    if (buscar !== '') {\n        planes_ordenados = planes_ordenados.filter(plan =>\n            plan.nombre.toLowerCase().includes(buscar.toLowerCase())\n        );\n    }\n\n    $('#contenedor-planes-creditos').empty();\n\n    if (planes_ordenados.length === 0) {\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"text-center py-5\">\n                <p class=\"text-muted\">No se encontraron planes</p>\n            </div>\n        `);\n    }\n\n    for (let i = 0; i < planes_ordenados.length; i++) {\n        let plan = planes_ordenados[i];\n        let creditos_disponibles = plan.creditos_disponibles || plan.creditos || 0;\n        let creditos_promedio = plan.creditos_promedio_accion || 0;\n        let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n            ? Math.floor(creditos_disponibles / creditos_promedio)\n            : 0;\n\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"card rounded rounded-3 border-hover pointer mb-3\" onclick=\"elegirPlanCreditos(${i}, ${filtro_orden === 'Mayor' ? 'true' : 'false'});\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6 text-gray-10\">${plan.nombre}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        `);\n    }\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('show');\n    }\n\n    $('#buscador-plan-credito').off('input').on('input', function() {\n        mostrarPlanesCreditos();\n    });\n}\n\n/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}\n\n/**\n * Mostrar el plan de créditos seleccionado en el contenedor.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanCreditosSeleccionado() {\n    if (!plan_creditos_seleccionado || !plan_creditos_seleccionado.creditos) {\n        mostrarToast('danger', 'Ocurrió un error'+plan_creditos_seleccionado);\n        return;\n    }\n\n    let creditos_disponibles = plan_creditos_seleccionado.creditos_disponibles || plan_creditos_seleccionado.creditos || 0;\n    let creditos_promedio = plan_creditos_seleccionado.creditos_promedio_accion || 0;\n    let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n        ? Math.floor(creditos_disponibles / creditos_promedio)\n        : 0;\n\n    let seccion_creditos = `\n        <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n            <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n            <div class=\"card rounded rounded-3\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4 pointer\" onclick=\"modalElegirPlan(2);\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6\">${plan_creditos_seleccionado.nombre || 'Plan de Créditos'}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan_creditos_seleccionado.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    // Remover el contenedor anterior si existe\n    $('#contenedor-plan-creditos').remove();\n\n    // Agregar después del contenedor-plan o dentro de contenedor-creditos\n    if ($('#contenedor-creditos').length) {\n        $('#contenedor-creditos').html(seccion_creditos);\n    } else {\n        $('#contenedor-plan').after(seccion_creditos);\n    }\n}\n\n/**\n * Mostrar en el modal los planes obtenidos en el listado.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction mostrarPlanes(tipo_especifico = null) {\n    let buscar = $('#buscador-plan').val();\n    let filtro_plan = $('#filtro-plan').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        table.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    for (let i = 0; i < planes.length; i++) {\n        if (\n            (filtro_plan == 'Todos') ||\n            (filtro_plan == 'Ofertas' && planes[i].cantidad_ofertas_laborales != null) ||\n            (filtro_plan == 'Unidades' && planes[i].unidades != null) ||\n            (filtro_plan == 'Tiempo' && planes[i].vigencia != null)\n        ) {\n            let cantidad_usuarios = '';\n            if (planes[i].cantidad_usuarios != null) {\n                cantidad_usuarios = `<div class=\"col-auto w-90px\"><i class=\"bi bi-person\"></i> ${planes[i].cantidad_usuarios}</div>`;\n            }\n            let cantidad_ofertas_laborales = '';\n            if (planes[i].cantidad_ofertas_laborales != null) {\n                cantidad_ofertas_laborales = `<div class=\"col-auto w-90px\"><i class=\"bi bi-briefcase\"></i> ${planes[i].cantidad_ofertas_laborales}</div>`;\n            }\n            let cantidad_pruebas = '';\n            if (planes[i].cantidad_pruebas != null) {\n                cantidad_pruebas = `<div class=\"col-auto w-90px\"><i class=\"bi bi-clipboard2-check\"></i> ${planes[i].cantidad_pruebas}</div>`;\n            }\n            let unidades = '';\n            if (planes[i].unidades != null) {\n                unidades = `<div class=\"col-auto w-90px\"><i class=\"bi bi-box\"></i> ${planes[i].unidades}</div>`;\n            }\n            let vigencia = '';\n            if (planes[i].vigencia == 90) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n            } else if (planes[i].vigencia == 180) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n            }  else if (planes[i].vigencia == 365) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n            } else if (planes[i].vigencia == null || planes[i].vigencia == 0) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n            } else {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${planes[i].vigencia} días</div>`;\n            }\n            $('#tbody-planes').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-2 pointer border-hover\" onclick=\"elegirPlan(${i});\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6\">\n                                <div class=\"col\">${planes[i].nombre !== null ? planes[i].nombre : ''}</div>\n                                ${cantidad_ofertas_laborales}\n                                ${unidades}\n                                ${cantidad_usuarios}\n                                ${cantidad_pruebas}\n                                ${vigencia}\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('show');\n    }\n\n    table = $('#tabla-planes').DataTable({\n        \"paging\": false,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": false\n    });\n    let buscador = $('#tabla-planes_wrapper input');\n    $(buscador).addClass('rounded-2 text-body-2');\n    $(buscador).prop('placeholder', 'Buscar');\n    $(buscador).prop('id', 'buscador-plan');\n    $('#input-busqueda').append(buscador);\n    $(buscador).val(buscar).trigger('input');\n}\n\n/**\n * Elegir un plan del listado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction elegirPlan(i) {\n    plan_seleccionado = planes[i];\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Mostrar el plan seleccionado en el contenedor y en las opciones del modificar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction mostrarPlanSeleccionado() {\n    let cantidad_usuarios = '';\n    let cantidad_usuarios_modal = $('#cantidad_usuarios_modal').val();\n    if (cantidad_usuarios_modal != '') {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${cantidad_usuarios_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_usuarios != null) {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${plan_seleccionado.cantidad_usuarios}</div>`;\n    }\n    let cantidad_ofertas_laborales = '';\n    let cantidad_ofertas_laborales_modal = $('#cantidad_ofertas_laborales_modal').val();\n    if (cantidad_ofertas_laborales_modal != '') {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${cantidad_ofertas_laborales_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_ofertas_laborales != null) {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${plan_seleccionado.cantidad_ofertas_laborales}</div>`;\n    }\n    let cantidad_pruebas = '';\n    let cantidad_pruebas_modal = $('#cantidad_pruebas_modal').val();\n    if (cantidad_pruebas_modal != '') {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${cantidad_pruebas_modal}</div>`;\n        $('.cantidad-pruebas').text(cantidad_pruebas_modal);\n    } else if (plan_seleccionado.cantidad_pruebas != null) {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${plan_seleccionado.cantidad_pruebas}</div>`;\n        $('.cantidad-pruebas').text(plan_seleccionado.cantidad_pruebas);\n    }\n    let unidades = '';\n    let unidades_modal = $('#unidades_modal').val();\n    if (unidades_modal != '') {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${unidades_modal}</div>`;\n    } else if (plan_seleccionado.unidades != null) {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${plan_seleccionado.unidades}</div>`;\n    }\n    let vigencia = '';\n    let vigencia_modal = $('#vigencia_modal').val();\n    if (plan_seleccionado.vigencia == 90 || vigencia_modal == '90') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n    } else if (plan_seleccionado.vigencia == 180 || vigencia_modal == '180') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n    }  else if (plan_seleccionado.vigencia == 365 || vigencia_modal == '365') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n    } else if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n    } else if (vigencia_modal != '') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${vigencia_modal} días</div>`;\n    } else {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${plan_seleccionado.vigencia} días</div>`;\n    }\n    let abrir_modal_elegir_plan = '';\n    let icono_editar = `\n        <div class=\"col-auto w-90px\">\n            <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalModificar(event);\" title=\"Modificar plan\">\n                <i class=\"bi bi-wrench\"></i>\n            </button>\n        </div>\n    `;\n    if (opcion == 'asignar') {\n        abrir_modal_elegir_plan = `onclick=\"modalElegirPlan();\"`;\n        icono_editar = '';\n    }\n    $('#contenedor-plan').empty();\n    $('#contenedor-plan').append(`\n        <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n        <div class=\"card rounded rounded-3\">\n            <div class=\"row align-items-center m-0 w-100 px-3 py-5 text-headline-6 pointer\" ${abrir_modal_elegir_plan}>\n                <div class=\"col\">${plan_seleccionado.nombre !== null ? plan_seleccionado.nombre : ''} <span id=\"plan-modificado\"></span></div>\n                ${cantidad_ofertas_laborales}\n                ${unidades}\n                ${cantidad_usuarios}\n                ${cantidad_pruebas}\n                ${vigencia}\n                ${icono_editar}\n            </div>\n        </div>\n    `);\n\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n    // Solo agregar el botón de elegir plan de créditos si no hay uno seleccionado y se requiere\n    if (tiene_creditos && plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n        let seccion_creditos = `\n            <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                            Elegir Plan de Créditos IA\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;\n        $('#contenedor-creditos').append(seccion_creditos);\n    }\n\n    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\n/**\n * Buscar las funcionalidades por tipo de prueba.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidades(tipo_prueba_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/funcionalidades-listado`,\n        data : {\n            tipo_prueba_id: tipo_prueba_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let beneficios = respuesta.data;\n            const adicionales = beneficios\n                .filter(item => item.predeterminado === 0)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            const predefinidos = beneficios\n                .filter(item => item.predeterminado === 1)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            funcionalidades_predefinidos = predefinidos;\n\n            // Verificar si el multiselect está inicializado antes de destruir\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect('destroy');\n            }\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect('destroy');\n            }\n\n            adicionales.forEach((item) => {\n                $('#adicionales_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            predefinidos.forEach((item) => {\n                $('#predefinidos_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            inizializarMultiselect();\n            if (opcion == 'facturar' || opcion == 'editar') {\n                buscarfuncionalidadesPlanEmpresa($('#id').val());\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Buscar las funcionalidades del plan de la empresa.\n *\n * @param {number} empresa_plan_id ID del plan de empresa.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidadesPlanEmpresa(empresa_plan_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-planes-funcionalidades-listado`,\n        data : {\n            empresa_plan_id: empresa_plan_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let funcionalidades = respuesta.data.map(item => item.funcionalidad_id);\n            $('#adicionales_modal').val(funcionalidades);\n\n            // Verificar si el multiselect está inicializado antes de refrescar\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect(\"refresh\");\n            }\n\n            $('#predefinidos_modal').val(funcionalidades);\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect(\"refresh\");\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Validar que al menos un tipo de plan esté seleccionado\n    if (!tiene_seleccion && !tiene_creditos) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos un tipo de plan.');\n        return valido;\n    }\n\n    // Validar plan de selección solo si está seleccionado el tipo 1\n    if (tiene_seleccion) {\n        if (!$('#plan_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de selección.');\n            return valido;\n        }\n\n        $('#vigencia').val($('#vigencia_modal').val());\n        if ($('#unidades_modal').val() == 'Ilimitadas') {\n            $('#unidades').val('');\n        } else {\n            $('#unidades').val($('#unidades_modal').val());\n        }\n        if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n            $('#cantidad_ofertas_laborales').val('');\n        } else {\n            $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n        }\n        $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n        $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            let adicionales = $('#adicionales_modal').val() || [];\n            let predefinidos = $('#predefinidos_modal').val() || [];\n            let funcionalidades = adicionales.concat(predefinidos);\n            $('#funcionalidades').val(JSON.stringify(funcionalidades));\n            if (funcionalidades.length == 0) {\n                valido = false;\n                mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n                return valido;\n            }\n        } else {\n            let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n            $('#funcionalidades').val(JSON.stringify(ids));\n        }\n\n        var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n            return this.value;\n        }).get();\n        $('#pruebas').val('');\n        let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n        if (maximo_pruebas == '') {\n            maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n        }\n        if (pruebas_seleccionadas.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una prueba.');\n            return valido;\n        } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n            return valido;\n        }\n        if (valido) {\n            $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n        }\n    }\n\n    // Validar plan de créditos solo si está seleccionado el tipo 2\n    if (tiene_creditos) {\n        if (!$('#plan_credito_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de créditos IA.');\n            return valido;\n        }\n    }\n\n    return valido;\n}\n\n\n/**\n * Función para validar que no se exceda al seleccionar limite de pruebas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction ValidarPruebas() {\n    let cantidad_seleccionadas = $('.pruebas:checked').length;\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (cantidad_seleccionadas > maximo_pruebas) {\n        $('#alerta-pruebas').removeClass('d-none');\n    } else {\n        $('#alerta-pruebas').addClass('d-none');\n    }\n}\n\n/**\n * Abrir el modal con los campos para modificar plan.\n *\n * @param {Event} evento Evento desencadenado.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalModificar(evento) {\n    evento.stopPropagation();\n    if (modificado == false) {\n        $('#nombre-plan-modal').text(plan_seleccionado.nombre);\n        $('#cantidad_pruebas_modal').empty();\n        $('#cantidad_pruebas_modal').append(`\n            <option value=\"\">Seleccione</option>\n        `);\n        for (let j = 1; j <= pruebas.length; j++) {\n            $('#cantidad_pruebas_modal').append(`\n                <option value=\"${j}\">${j} Pruebas</option>\n            `);\n        }\n        $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n        if ([90, 180, 365].includes(plan_seleccionado.vigencia)) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val(plan_seleccionado.vigencia).trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else if (plan_seleccionado.vigencia != null && plan_seleccionado.vigencia != 0) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val('personalizado').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else {\n            $('#tiempo_modal').prop('disabled', true);\n            $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val('');\n        }\n        if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n            $('#unidades_modal').val(plan_seleccionado.unidades);\n            $('#unidades_modal').prop('disabled', false);\n            if (opcion == 'asignar') {\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa_plan.cantidad_ofertas_laborales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', false);\n        } else {\n            $('#unidades_modal').val(empresa.procesos_estimados_mensuales);\n            $('#unidades_modal').prop('disabled', true);\n            if (opcion == 'facturar' || opcion == 'editar') {\n                $('#unidades_modal').val(plan_seleccionado.unidades);\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa.pruebas_estimadas_mensuales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', true);\n        }\n        $('#cantidad_usuarios_modal').val(plan_seleccionado.cantidad_usuarios);\n        if (opcion == 'facturar' || opcion == 'editar') {\n            $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n            buscarfuncionalidadesPlanEmpresa($('#id').val());\n        }\n        $('#boton-guardar-modificaciones').prop('disabled', true);\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('show');\n    }\n}\n\n/**\n * Función que habilita el boton de guardar un plan modificado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction habilitarBotonGuardar() {\n    $('#boton-guardar-modificaciones').prop('disabled', false);\n}\n\n/**\n * Función que controla los campos de vigencia en el modal de editar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTiempo(vigencia) {\n    $('.texto-label-tiempo').text('máximas permitidas');\n    $('#input-container-tiempo').removeClass('d-none');\n    $('#input-container-tiempo').addClass('col-md-6');\n    if (vigencia == 'personalizado') {\n        $('#input-container-vigencia').removeClass('d-none');\n        $('#vigencia_modal').val('');\n    } else if ((vigencia == '' || vigencia == null || vigencia == 0) && plan_seleccionado != null && (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0)) {\n        $('.texto-label-tiempo').text('');\n        $('#input-container-tiempo').addClass('d-none');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val('');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    } else if (['90', '180', '365'].includes(vigencia)) {\n        $('#input-container-tiempo').removeClass('col-md-6');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val(vigencia);\n    } else {\n        $('#vigencia_modal').val(vigencia);\n        $('#input-container-vigencia').addClass('d-none');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    }\n}\n\n/**\n * Abrir el modal de confirmación.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalEstasSeguro() {\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('hide');\n        $('#modal-estas-seguro').modal('show');\n    }\n}\n\n/**\n * Cancelar la edición de un plan.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction cancelarEdicion() {\n    modificado = false;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    limpiarAdicional();\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Confirmar los datos editados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction confirmarEdicion() {\n    modificado = true;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    $('#plan-modificado').text('(modificado)');\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Limpiar los campos del modal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction limpiarAdicional() {\n    $('#cantidad_pruebas_modal').val('').trigger('change').trigger('select2:select');\n    $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n    $('#unidades_modal').val('');\n    $('#cantidad_ofertas_laborales_modal').val('');\n    $('#cantidad_usuarios_modal').val('');\n\n    // Verificar si el multiselect está inicializado antes de llamar uncheckAll\n    if ($('#adicionales_modal').data('multiselect')) {\n        $('#adicionales_modal').multiselect(\"uncheckAll\");\n    }\n\n    if ($('#predefinidos_modal').data('multiselect')) {\n        $('#predefinidos_modal').multiselect(\"uncheckAll\");\n    }\n}\n\n/**\n * Función para ejecutar acciones luego de guardar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction postSuccess(respuesta) {\n    limpiarFormulario(respuesta.formulario);\n    if (opcion == 'asignar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se asignó con éxito a la empresa`,\n        }));\n    } else if (opcion == 'facturar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se facturó con éxito`,\n        }));\n    } else if (opcion == 'editar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se actualizó con éxito`,\n        }));\n    }\n    window.location.href='/empresas-gestionar/' + empresa.id;\n}\n","structuredPatch":[{"oldStart":110,"oldLines":6,"newStart":110,"newLines":7,"lines":["  * @param {number} tipo_prueba_id ID del tipo de prueba.","  * @returns {void}","  * @author Jair Carvajal","+ * @author Andres Gonzalez","  */"," function seleccionarTipoPruebaMultiple() {","     let tipos_prueba = $('#tipo_prueba_id').val() || [];"]},{"oldStart":123,"oldLines":12,"newStart":124,"newLines":21,"lines":["         $('#contenedor-plan').empty();","         $('#contenedor-creditos').empty();","         $('#seccion-pruebas').addClass('d-none');","+        $('#contenedor-pruebas').empty();","         $('#plan_id').val('');","         $('#plan_credito_id').val('');","         $('#creditos').val('');","+        $('#pruebas').val('');","+        $('#vigencia').val('');","+        $('#unidades').val('');","+        $('#cantidad_ofertas_laborales').val('');","+        $('#cantidad_usuarios').val('');","+        $('#cantidad_pruebas').val('');","+        $('#funcionalidades').val('');","         plan_seleccionado = null;","         plan_creditos_seleccionado = null;","         pruebas = [];","+        limpiarAdicional();","         return;","     }"," "]},{"oldStart":152,"oldLines":10,"newStart":162,"newLines":21,"lines":["             $('#contenedor-plan').html(seccion_seleccion);","         }","     } else {","-        // Si se deseleccionó el tipo de selección, limpiar el plan","+        // Si se deseleccionó el tipo de selección, limpiar el plan y campos relacionados","         $('#contenedor-plan').empty();","+        $('#seccion-pruebas').addClass('d-none');","+        $('#contenedor-pruebas').empty();","         plan_seleccionado = null;","         $('#plan_id').val('');","+        $('#pruebas').val('');","+        $('#vigencia').val('');","+        $('#unidades').val('');","+        $('#cantidad_ofertas_laborales').val('');","+        $('#cantidad_usuarios').val('');","+        $('#cantidad_pruebas').val('');","+        $('#funcionalidades').val('');","+        pruebas = [];","+        limpiarAdicional();","     }"," ","     // Manejo del plan de créditos"]},{"oldStart":185,"oldLines":44,"newStart":206,"newLines":47,"lines":["         $('#creditos').val('');","     }"," ","-    $.ajax({","-        type: 'GET',","-        url : `/pruebas-listado`,","-        data: {","-            tipo_prueba_id: tipos_prueba,","-            activo: 1","-        }","-    }).then((respuesta) => {","-        limpiarAdicional();","-        $('#contenedor-pruebas').empty();","-        pruebas = respuesta.data;","-        for (let i = 0; i < pruebas.length; i++) {","-            $('#contenedor-pruebas').append(`","-                <div class=\"col-12 col-md-6\">","-                    <div class=\"d-flex align-items-center\">","-                        <div class=\"check-container my-1 me-1\">","-                            <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">","+    // Solo cargar pruebas si hay plan de selección","+    if (tiene_seleccion) {","+        $.ajax({","+            type: 'GET',","+            url : `/pruebas-listado`,","+            data: {","+                tipo_prueba_id: tipos_prueba,","+                activo: 1","+            }","+        }).then((respuesta) => {","+            limpiarAdicional();","+            $('#contenedor-pruebas').empty();","+            pruebas = respuesta.data;","+            for (let i = 0; i < pruebas.length; i++) {","+                $('#contenedor-pruebas').append(`","+                    <div class=\"col-12 col-md-6\">","+                        <div class=\"d-flex align-items-center\">","+                            <div class=\"check-container my-1 me-1\">","+                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">","+                            </div>","+                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>","                         </div>","-                        <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>","                     </div>","-                </div>","-            `);","-        }","+                `);","+            }"," ","-        if (opcion == 'facturar' || opcion == 'editar') {","-            for (let i = 0; i < pruebas_empresa_plan.length; i++) {","-                $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);","+            if (opcion == 'facturar' || opcion == 'editar') {","+                for (let i = 0; i < pruebas_empresa_plan.length; i++) {","+                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);","+                }","+                $('#seccion-pruebas').removeClass('d-none');","+                mostrarPlanSeleccionado();","             }","-            $('#seccion-pruebas').removeClass('d-none');","-            mostrarPlanSeleccionado();","-        }"," ","-        if (opcion == 'editar') {","-            $('#tipo_prueba_id').prop('disabled', true);","-        }","-    }).catch((error) => {","-        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');","-    });","+            if (opcion == 'editar') {","+                $('#tipo_prueba_id').prop('disabled', true);","+            }","+        }).catch((error) => {","+            mostrarToast('danger', 'Ocurrió un error al cargar las pruebas');","+        });","+    }"," }"," "," /**"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"fd13cdd0-61db-43ce-85bb-ec9162df1040"}
{"parentUuid":"e20be97f-d89d-4689-85e2-29c2504c8497","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_017n5ep4h9xgae86d1nHCNqr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018cBGYss9BexhRPtn8MXFVv","name":"TodoWrite","input":{"todos":[{"content":"Mejorar limpieza de datos al deseleccionar tipo de plan en seleccionarTipoPruebaMultiple()","status":"completed","activeForm":"Mejorando limpieza de datos al deseleccionar planes"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":5750,"cache_read_input_tokens":64951,"cache_creation":{"ephemeral_5m_input_tokens":5750,"ephemeral_1h_input_tokens":0},"output_tokens":26,"service_tier":"standard"}},"requestId":"req_011CXK3mpG1Fr3fLggNhUY5o","type":"assistant","uuid":"6cd89140-503f-4607-897d-d37d2b66c4dc","timestamp":"2026-01-20T17:46:51.710Z"}
{"parentUuid":"6cd89140-503f-4607-897d-d37d2b66c4dc","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018cBGYss9BexhRPtn8MXFVv","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"64e84c7c-1227-4b03-93b1-3003eccdb6c0","timestamp":"2026-01-20T17:46:51.928Z","toolUseResult":{"oldTodos":[{"content":"Mejorar limpieza de datos al deseleccionar tipo de plan en seleccionarTipoPruebaMultiple()","status":"in_progress","activeForm":"Mejorando limpieza de datos al deseleccionar planes"}],"newTodos":[{"content":"Mejorar limpieza de datos al deseleccionar tipo de plan en seleccionarTipoPruebaMultiple()","status":"completed","activeForm":"Mejorando limpieza de datos al deseleccionar planes"}]},"sourceToolAssistantUUID":"6cd89140-503f-4607-897d-d37d2b66c4dc"}
{"parentUuid":"64e84c7c-1227-4b03-93b1-3003eccdb6c0","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Ri7AmW6aN3rmLP6NUPDi1J","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He modificado la función `seleccionarTipoPruebaMultiple()` para que limpie correctamente todos los datos cuando se deselecciona un tipo de plan.\n\n## Cambios realizados en [asignar-plan.js:115-250](public/js/empresas/asignar-plan.js#L115-L250)\n\n### Cuando se deseleccionan TODOS los tipos:\n- Limpia `contenedor-plan` y `contenedor-creditos`\n- Oculta la sección de pruebas\n- Limpia todos los campos hidden: `plan_id`, `plan_credito_id`, `creditos`, `pruebas`, `vigencia`, `unidades`, `cantidad_ofertas_laborales`, `cantidad_usuarios`, `cantidad_pruebas`, `funcionalidades`\n- Resetea las variables `plan_seleccionado` y `plan_creditos_seleccionado` a `null`\n- Limpia el array de `pruebas`\n- Ejecuta `limpiarAdicional()` para limpiar los campos del modal\n\n### Cuando se deselecciona \"Planes de selección\" (tipo 1):\n- Limpia `contenedor-plan`\n- Oculta la sección de pruebas y limpia `contenedor-pruebas`\n- Limpia campos: `plan_id`, `pruebas`, `vigencia`, `unidades`, `cantidad_ofertas_laborales`, `cantidad_usuarios`, `cantidad_pruebas`, `funcionalidades`\n- Resetea `plan_seleccionado = null`\n- Limpia el array de `pruebas`\n\n### Cuando se deselecciona \"Planes de créditos IA\" (tipo 2):\n- Limpia `contenedor-creditos` y elimina `contenedor-plan-creditos`\n- Limpia campos: `plan_credito_id`, `creditos`\n- Resetea `plan_creditos_seleccionado = null`\n\n### Mejora adicional:\n- Las pruebas solo se cargan si está seleccionado el tipo de \"Planes de selección\", evitando llamadas AJAX innecesarias cuando solo se selecciona créditos IA."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":158,"cache_read_input_tokens":70701,"cache_creation":{"ephemeral_5m_input_tokens":158,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK3nBbQ9K9musRMY26H5","type":"assistant","uuid":"e39c0559-0aaa-4311-80e2-6f61fe3c3729","timestamp":"2026-01-20T17:47:01.785Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-20T17:48:14.551Z","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565"}
{"type":"file-history-snapshot","messageId":"240da201-c86e-4c56-8e15-2049ab8109c7","snapshot":{"messageId":"240da201-c86e-4c56-8e15-2049ab8109c7","trackedFileBackups":{"resources\\views\\empresas\\paginas\\asignar-plan.blade.php":{"backupFileName":"23a0b404d58f48f6@v2","version":2,"backupTime":"2026-01-20T17:45:44.948Z"},"public\\js\\empresas\\asignar-plan.js":{"backupFileName":"25fa1d462d51e622@v3","version":3,"backupTime":"2026-01-20T17:48:16.476Z"}},"timestamp":"2026-01-20T17:48:16.439Z"},"isSnapshotUpdate":false}
{"parentUuid":"48462ead-4885-4a95-850c-d5a98039852a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_01FLGpNAyTvrzWEVBBehYVxE","parentToolUseID":"toolu_01FLGpNAyTvrzWEVBBehYVxE","uuid":"55e70ef3-6da0-4c93-b058-cbb3367412d3","timestamp":"2026-01-20T17:45:50.129Z"}
{"parentUuid":"fd13cdd0-61db-43ce-85bb-ec9162df1040","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_015HrfPUFrA4VY7xBKvxQuow","parentToolUseID":"toolu_015HrfPUFrA4VY7xBKvxQuow","uuid":"5c8af75e-dd13-4fd5-ac26-cb01151db998","timestamp":"2026-01-20T17:46:23.889Z"}
{"parentUuid":"5c8af75e-dd13-4fd5-ac26-cb01151db998","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_015HrfPUFrA4VY7xBKvxQuow","parentToolUseID":"toolu_015HrfPUFrA4VY7xBKvxQuow","uuid":"875b2371-5ebf-492a-a28f-9e07c6dd1cc8","timestamp":"2026-01-20T17:46:23.890Z"}
{"parentUuid":"e20be97f-d89d-4689-85e2-29c2504c8497","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_015HrfPUFrA4VY7xBKvxQuow","toolUseID":"toolu_015HrfPUFrA4VY7xBKvxQuow","timestamp":"2026-01-20T17:46:43.776Z","uuid":"744c9389-04d9-4ca9-b6bd-9ebfd7ef9783"}
{"parentUuid":"e39c0559-0aaa-4311-80e2-6f61fe3c3729","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 197 to 197 from c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php:\npublic function store(AsignarPlanRequest $request): JsonResponse {\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"losto aqui colocame un ecemcionpublic function store(AsignarPlanRequest $request): JsonResponse { antes del codigo 201 para que no se me gurne daa en bd"}]},"uuid":"240da201-c86e-4c56-8e15-2049ab8109c7","timestamp":"2026-01-20T17:48:16.433Z","todos":[]}
{"parentUuid":"240da201-c86e-4c56-8e15-2049ab8109c7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_0177CYPwozBM1RJ8U1TXFD8T","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo, quieres agregar una excepción para probar sin guardar en la base de datos. Déjame ver el método completo primero."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":4787,"cache_read_input_tokens":70859,"cache_creation":{"ephemeral_5m_input_tokens":4787,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK3tREbvaMkaLnRV8nLq","type":"assistant","uuid":"a29ba551-64cc-4b9d-a386-74ce80835646","timestamp":"2026-01-20T17:48:21.203Z"}
{"parentUuid":"a29ba551-64cc-4b9d-a386-74ce80835646","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_0177CYPwozBM1RJ8U1TXFD8T","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017jB2y18RZZ1aU8APzCSQsZ","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","offset":190,"limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":4787,"cache_read_input_tokens":70859,"cache_creation":{"ephemeral_5m_input_tokens":4787,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK3tREbvaMkaLnRV8nLq","type":"assistant","uuid":"73fc6058-72df-4599-8adf-6a27285c2f06","timestamp":"2026-01-20T17:48:22.255Z"}
{"parentUuid":"73fc6058-72df-4599-8adf-6a27285c2f06","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017jB2y18RZZ1aU8APzCSQsZ","type":"tool_result","content":"   190→    /**\n   191→     * Asignar plan a una empresa.\n   192→     *\n   193→     * @param AsignarPlanRequest $request Contenido de la petición.\n   194→     * @return JsonResponse\n   195→     * @author Daniel Beltrán\n   196→     */\n   197→    public function store(AsignarPlanRequest $request): JsonResponse {\n   198→        $codigo    = 201;\n   199→        $respuesta = [\n   200→            'message' => 'Plan asignado correctamente'\n   201→        ];\n   202→\n   203→        try {\n   204→            DB::beginTransaction();\n   205→            $this->servicio->guardar($request);\n   206→            DB::commit();\n   207→        } catch (Exception $error) {\n   208→            DB::rollBack();\n   209→\n   210→            $codigo    = 400;\n   211→            $respuesta = [\n   212→                'message' => 'Ocurrió un error',\n   213→                'errors'  => $error->getMessage()\n   214→            ];\n   215→        }\n   216→\n   217→        return new JsonResponse($respuesta, $codigo);\n   218→    }\n   219→\n   220→    /**\n   221→     * Cargar página para facturar un plan.\n   222→     *\n   223→     * @param int $id ID del plan de empresa.\n   224→     * @return View\n   225→     * @author Daniel Beltrán\n   226→     */\n   227→    public function formularioFacturar(int $id): View {\n   228→        $empresa_plan = $this->repositorio->getUno($id);\n   229→\n   230→        return view('empresas.paginas.asignar-plan')->with([\n   231→            'empresa_plan'  => $empresa_plan,\n   232→            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n   233→            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n   234→            'empresa'       => $this->empresa_repositorio->getUno($empresa_plan->empresa_id),\n   235→            'opcion'        => 'facturar'\n   236→        ]);\n   237→    }\n   238→\n   239→    /**\n   240→     * Facturar plan de empresa.\n   241→     *\n   242→     * @param int $id ID del plan de empresa.\n   243→     * @param FacturarPlanRequest $request Contenido de la petición.\n   244→     * @return JsonResponse\n   245→     * @author Daniel Beltrán\n   246→     */\n   247→    public function facturar(int $id, FacturarPlanRequest $request): JsonResponse {\n   248→        $codigo    = 201;\n   249→        $respuesta = [\n   250→            'message' => 'Plan facturado correctamente'\n   251→        ];\n   252→\n   253→        try {\n   254→            DB::beginTransaction();\n   255→            $this->servicio->facturar($id, $request);\n   256→            DB::commit();\n   257→        } catch (Exception $error) {\n   258→            DB::rollBack();\n   259→\n   260→            $codigo    = 400;\n   261→            $respuesta = [\n   262→                'message' => 'Ocurrió un error',\n   263→                'errors'  => $error->getMessage()\n   264→            ];\n   265→        }\n   266→\n   267→        return new JsonResponse($respuesta, $codigo);\n   268→    }\n   269→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a792e53c-3c55-4b63-950b-30275ab10fd1","timestamp":"2026-01-20T17:48:25.039Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","content":"    /**\n     * Asignar plan a una empresa.\n     *\n     * @param AsignarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function store(AsignarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan asignado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Cargar página para facturar un plan.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function formularioFacturar(int $id): View {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        return view('empresas.paginas.asignar-plan')->with([\n            'empresa_plan'  => $empresa_plan,\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresa'       => $this->empresa_repositorio->getUno($empresa_plan->empresa_id),\n            'opcion'        => 'facturar'\n        ]);\n    }\n\n    /**\n     * Facturar plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param FacturarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, FacturarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan facturado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->facturar($id, $request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n","numLines":80,"startLine":190,"totalLines":491}},"sourceToolAssistantUUID":"73fc6058-72df-4599-8adf-6a27285c2f06"}
{"parentUuid":"a792e53c-3c55-4b63-950b-30275ab10fd1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YaYzErRJQhssexhcW98q5y","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora agregaré una excepción temporal para que puedas probar sin guardar datos en la base de datos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1201,"cache_read_input_tokens":75646,"cache_creation":{"ephemeral_5m_input_tokens":1201,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK3u3LVzNHduEE9BrF6x","type":"assistant","uuid":"7aca1d67-9036-4f01-a99b-29bb66451ed3","timestamp":"2026-01-20T17:48:28.150Z"}
{"parentUuid":"7aca1d67-9036-4f01-a99b-29bb66451ed3","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YaYzErRJQhssexhcW98q5y","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Fii1nBZRqGJic87y2JByDR","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","old_string":"    public function store(AsignarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan asignado correctamente'\n        ];\n\n        try {","new_string":"    public function store(AsignarPlanRequest $request): JsonResponse {\n        // TODO: Eliminar esta excepción después de probar\n        throw new Exception('Prueba de validación - datos recibidos: ' . json_encode($request->all()));\n\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan asignado correctamente'\n        ];\n\n        try {"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1201,"cache_read_input_tokens":75646,"cache_creation":{"ephemeral_5m_input_tokens":1201,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK3u3LVzNHduEE9BrF6x","type":"assistant","uuid":"32e95474-ae62-44db-af7c-be8c61138b26","timestamp":"2026-01-20T17:48:30.854Z"}
{"type":"file-history-snapshot","messageId":"32e95474-ae62-44db-af7c-be8c61138b26","snapshot":{"messageId":"240da201-c86e-4c56-8e15-2049ab8109c7","trackedFileBackups":{"resources\\views\\empresas\\paginas\\asignar-plan.blade.php":{"backupFileName":"23a0b404d58f48f6@v2","version":2,"backupTime":"2026-01-20T17:45:44.948Z"},"public\\js\\empresas\\asignar-plan.js":{"backupFileName":"25fa1d462d51e622@v3","version":3,"backupTime":"2026-01-20T17:48:16.476Z"},"app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php":{"backupFileName":"71d1198be92c5143@v1","version":1,"backupTime":"2026-01-20T18:05:24.313Z"}},"timestamp":"2026-01-20T17:48:16.439Z"},"isSnapshotUpdate":true}
{"parentUuid":"32e95474-ae62-44db-af7c-be8c61138b26","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Fii1nBZRqGJic87y2JByDR","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   193→     * @param AsignarPlanRequest $request Contenido de la petición.\n   194→     * @return JsonResponse\n   195→     * @author Daniel Beltrán\n   196→     */\n   197→    public function store(AsignarPlanRequest $request): JsonResponse {\n   198→        // TODO: Eliminar esta excepción después de probar\n   199→        throw new Exception('Prueba de validación - datos recibidos: ' . json_encode($request->all()));\n   200→\n   201→        $codigo    = 201;\n   202→        $respuesta = [\n   203→            'message' => 'Plan asignado correctamente'\n   204→        ];\n   205→\n   206→        try {\n   207→            DB::beginTransaction();\n   208→            $this->servicio->guardar($request);\n   209→            DB::commit();\n   210→        } catch (Exception $error) {"}]},"uuid":"b72abf84-0ec6-4854-9433-3d35878c3835","timestamp":"2026-01-20T18:05:24.386Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php","oldString":"    public function store(AsignarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan asignado correctamente'\n        ];\n\n        try {","newString":"    public function store(AsignarPlanRequest $request): JsonResponse {\n        // TODO: Eliminar esta excepción después de probar\n        throw new Exception('Prueba de validación - datos recibidos: ' . json_encode($request->all()));\n\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan asignado correctamente'\n        ];\n\n        try {","originalFile":"<?php\n\nnamespace App\\Http\\Controllers\\Empresas;\n\nuse Exception;\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\Request;\nuse App\\Exports\\GlobalExport;\nuse Illuminate\\Http\\JsonResponse;\nuse Illuminate\\Support\\Facades\\DB;\nuse App\\Http\\Controllers\\Controller;\nuse Maatwebsite\\Excel\\Facades\\Excel;\nuse Illuminate\\Support\\Facades\\Storage;\nuse App\\Http\\Repositories\\Usuarios\\UserRepository;\nuse App\\Http\\Requests\\Empresas\\AsignarPlanRequest;\nuse App\\Http\\Services\\Empresas\\EmpresaPlanService;\nuse App\\Http\\Repositories\\Pruebas\\PerfilRepository;\nuse App\\Http\\Repositories\\Pruebas\\PruebaRepository;\nuse App\\Http\\Requests\\Empresas\\FacturarPlanRequest;\nuse App\\Http\\Repositories\\Empresas\\EmpresaRepository;\nuse Symfony\\Component\\HttpFoundation\\StreamedResponse;\nuse App\\Http\\Services\\IA\\ConsumoCreditoService;\nuse App\\Http\\Repositories\\Pruebas\\TipoPruebaRepository;\nuse Symfony\\Component\\HttpFoundation\\BinaryFileResponse;\nuse App\\Http\\Repositories\\Configuraciones\\RutaRepository;\nuse App\\Http\\Repositories\\Empresas\\EmpresaPlanRepository;\nuse App\\Http\\Repositories\\Configuraciones\\ArchivoRepository;\nuse App\\Http\\Requests\\Empresas\\DescargarEmpresasPlanesRequest;\n\nclass EmpresaPlanController extends Controller\n{\n    /**\n     * Constructor.\n     *\n     * @param EmpresaPlanService $servicio Servicio de planes de empresa.\n     * @param EmpresaPlanRepository $repositorio Repositorio de planes de empresa.\n     * @param TipoPruebaRepository $tipo_prueba_repositorio Repositorio de tipos de pruebas.\n     * @param RutaRepository $ruta_repositorio Repositorio de rutas.\n     * @param EmpresaRepository $empresa_repositorio Repositorio de empresas.\n     * @param UserRepository $usuario_repositorio Repositorio de usuarios.\n     * @param PruebaRepository $prueba_repositorio Repositorio de pruebas.\n     * @param PerfilRepository $perfil_repositorio Repositorio de perfiles.\n     * @param ArchivoRepository $archivo_repositorio Repositorio de archivos.\n     * @return void\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function __construct(\n        private EmpresaPlanService $servicio,\n        private EmpresaPlanRepository $repositorio,\n        private TipoPruebaRepository $tipo_prueba_repositorio,\n        private RutaRepository $ruta_repositorio,\n        private EmpresaRepository $empresa_repositorio,\n        private UserRepository $usuario_repositorio,\n        private PruebaRepository $prueba_repositorio,\n        private PerfilRepository $perfil_repositorio,\n        private ArchivoRepository $archivo_repositorio,\n        private ConsumoCreditoService $consumo_credito_servicio\n    ) {}\n\n    /**\n     * Retornar la vista principal de los empresas_planes de todas las empresas.\n     *\n     * @return View\n     * @author Fahibram Cárcamo\n     */\n    public function index(): View {\n        // FIXME: Esta vista no debería estar en este controlador, debe estar en el controlador de consumos al igual que todo lo relacionado con ello\n        return view('empresas.empresas-planes.index')->with([\n            'rutas_menu'      => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresas_planes' => $this->repositorio->datosConsumosEmpresas(new Request()),\n            'ejecutivos'      => $this->usuario_repositorio->getEjecutivos(),\n            'pruebas'         => $this->prueba_repositorio->getTodo(new Request()),\n            'perfiles'        => $this->perfil_repositorio->getTodo(new Request())\n        ]);\n    }\n\n    /**\n     * Datos de empresas_planes de todas las empresas como respuesta json.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la petición HTTP.\n     * @return JsonResponse\n     * @author Fahibram Cárcamo\n     * @author Daniel Beltrán\n     */\n    public function planesEmpresas(DescargarEmpresasPlanesRequest $request): JsonResponse {\n        return datatables()->of($this->repositorio->datosConsumosEmpresas($request))->toJson();\n    }\n\n    /**\n     * Exportar Excel de los datos de empresas_planes de todas las empresas.\n     *\n     * @param DescargarEmpresasPlanesRequest $request Contenido de la solicitud HTTP.\n     * @return BinaryFileResponse\n     * @author Fahibram Cárcamo\n     */\n    public function exportarExcelEmpresasPlanesEmpresas(DescargarEmpresasPlanesRequest $request): BinaryFileResponse {\n        return Excel::download(\n            new GlobalExport(\n                ['ID', 'Número de sucursales', 'Empresa', 'Ejecutivo de cuenta', 'Plan', 'Pruebas', 'Unidades', 'Ofertas laborales', 'Tiempo', 'Usuarios', 'Vigencia', 'Estado', 'Costo', 'Descuento', 'Valor de venta'],\n                $this->repositorio->datosConsumosEmpresas($request),\n                'Empresas-planes de todas las empresas',\n                'excel.empresas-planes.empresas-planes'\n            ),\n            'consumos-pruebas.xlsx'\n        );\n    }\n\n    /**\n     * Obtener los planes de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function datosTabla(int $empresa_id, Request $request): JsonResponse {\n        $request->merge([\n            'empresa_id'                            => $empresa_id,\n            'con_conteo_consumos_agendas'           => true,\n            'con_conteo_consumos_ofertas_laborales' => true\n        ]);\n\n        return new JsonResponse([\n            'data' => [\n                'empresas_planes'             => $this->repositorio->getTodo($request),\n                'sucursales_consumos_agendas' => $this->empresa_repositorio\n                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n                        'empresa_id'       => $empresa_id,\n                        'consumos_agendas' => true\n                    ])),\n                'sucursales_consumos_ofertas_laborales' => $this->empresa_repositorio\n                    ->obtenerConteosConsumosSucursalesEmpresasPlanes(new Request([\n                        'empresa_id'                 => $empresa_id,\n                        'consumos_ofertas_laborales' => true\n                    ]))\n            ]\n        ], 200);\n    }\n\n    /**\n     * Obtener un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function show(int $id): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->obtenerUnoConProximo($id)\n        ]);\n    }\n\n    /**\n     * Cargar la página para asignar un plan a una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function formularioAsignar(int $empresa_id): View {\n        return view('empresas.paginas.asignar-plan')->with([\n            'empresa_id'    => $empresa_id,\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresa'       => $this->empresa_repositorio->getUno($empresa_id),\n            'opcion'        => 'asignar'\n        ]);\n    }\n\n    /**\n     * Cargar la página para editar un plan de empresa.\n     *\n     * @param int $id ID de el plan de empresa.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function edit(int $id): View {\n        $empresa_plan = $this->repositorio->getUno($id);\n        return view('empresas.paginas.asignar-plan')->with([\n            'empresa_id'    => $empresa_plan->empresa_id,\n            'empresa_plan'  => $empresa_plan,\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresa'       => $this->empresa_repositorio->getUno($empresa_plan->empresa_id),\n            'opcion'        => 'editar'\n        ]);\n    }\n\n    /**\n     * Asignar plan a una empresa.\n     *\n     * @param AsignarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function store(AsignarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan asignado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Cargar página para facturar un plan.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return View\n     * @author Daniel Beltrán\n     */\n    public function formularioFacturar(int $id): View {\n        $empresa_plan = $this->repositorio->getUno($id);\n\n        return view('empresas.paginas.asignar-plan')->with([\n            'empresa_plan'  => $empresa_plan,\n            'tipos_pruebas' => $this->tipo_prueba_repositorio->getTodo(new Request()),\n            'rutas_menu'    => $this->ruta_repositorio->getTodo(new Request(['rutas_principales' => true])),\n            'empresa'       => $this->empresa_repositorio->getUno($empresa_plan->empresa_id),\n            'opcion'        => 'facturar'\n        ]);\n    }\n\n    /**\n     * Facturar plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param FacturarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function facturar(int $id, FacturarPlanRequest $request): JsonResponse {\n        $codigo    = 201;\n        $respuesta = [\n            'message' => 'Plan facturado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->servicio->facturar($id, $request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Obtener el historial de recompras de una empresa por plan.\n     *\n     * @param Request $request Contenido de la petición HTTP entrante.\n     * @param int|null $empresa_id Id de la empresa.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function historialRecompras(Request $request, int $empresa_id = null): JsonResponse {\n        if (!is_null($empresa_id)) {\n            $request->merge(compact('empresa_id'));\n        }\n\n        return datatables()->of($this->servicio->historialRecompras($request))->toJson();\n    }\n\n    /**\n     * Obtener el historial de compras de planes con creditos.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     */\n    public function historialComprasCreditos(int $empresa_id, Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->servicio->historialComprasCreditos($empresa_id, $request)\n        ], JsonResponse::HTTP_OK);\n    }\n\n    /**\n     * Exportar Excel del historial de recompras.\n     *\n     * @param Request $request Contenido de la petición.\n     * @return BinaryFileResponse\n     * @author Daniel Beltrán\n     * @author Fahibram Cárcamo\n     */\n    public function exportarExcelHistorialRecompras(Request $request): BinaryFileResponse {\n        return Excel::download(\n            // Por el momento no se mostrará el conteo de consumos ni nada relacionado con ofertas laborales.\n            new GlobalExport(\n                ['Plan', 'Plan modificado', 'Creación', 'Activación', 'Vencimiento', 'Duración', 'Uso de unidades/agendas', /* 'Consumo de ofertas laborales', */ 'Uso de usuarios', 'Uso de tiempo', 'Número de factura', 'Costo', 'Descuento', 'Valor de venta', 'Detalle de uso'],\n                $this->servicio->historialRecompras($request),\n                'Historial de recompras',\n                'excel.empresas.historial-recompras'\n            ),\n            'historial-recompras.xlsx'\n        );\n    }\n\n    /**\n     * Inactivar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function inactivar(int $id): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan inactivado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, ['estado_id' => 2]);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param AsignarPlanRequest $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function update(int $id, AsignarPlanRequest $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $request->merge(['id' => $id]);\n            $this->servicio->guardar($request);\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Actualizar un plan de empresa.\n     *\n     * @param int $id ID del plan de empresa.\n     * @param Request $request Contenido de la petición.\n     * @return JsonResponse\n     * @author Daniel Beltrán\n     */\n    public function actualizarInformacion(int $id, Request $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = [\n            'message' => 'Plan actualizado correctamente'\n        ];\n\n        try {\n            DB::beginTransaction();\n            $this->repositorio->actualizar($id, $request->except('_token', '_method'));\n            DB::commit();\n        } catch (Exception $error) {\n            DB::rollBack();\n\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Envíar la notificación de solicitud de renovación de plan.\n     *\n     * @param Request $request Solicitud HTTP.\n     * @return JsonResponse\n     * @author Fahibram Cárcamo\n     */\n    public function solicitudRenovacionPlan(Request $request): JsonResponse {\n        $codigo    = 200;\n        $respuesta = ['message' => 'Solicitud de renovación de plan enviada correctamente'];\n\n        try {\n            $this->servicio->solicitarRenovacionPlan($request);\n        } catch (Exception $error) {\n            $codigo    = 400;\n            $respuesta = [\n                'message' => 'Ocurrió un error',\n                'errors'  => $error->getMessage(),\n                'trace'   => $error->getTrace()\n            ];\n        }\n\n        return new JsonResponse($respuesta, $codigo);\n    }\n\n    /**\n     * Descargar archivo de factura de plan.\n     *\n     * @param int $id Id del archivo de la factura.\n     * @return StreamedResponse\n     * @author Fahibram Cárcamo\n     */\n    public function descargarFactura(int $archivo_id): StreamedResponse {\n        $archivo_factura = $this->archivo_repositorio->getUno($archivo_id);\n        return Storage::download($archivo_factura->ruta);\n    }\n\n    /**\n     * Obtener creditos disponibles y plan asignado de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     */\n    public function creditosDisponiblesEmpresa(int $empresa_id, Request $request): JsonResponse {\n        $datos = $this->servicio->creditosDisponiblesEmpresa($empresa_id, $request);\n\n        if (!$datos) {\n            return new JsonResponse([\n                'message' => 'Plan de empresa no encontrado'\n            ], JsonResponse::HTTP_NOT_FOUND);\n        }\n\n        return new JsonResponse([\n            'data' => $datos\n        ], JsonResponse::HTTP_OK);\n    }\n\n    /**\n     * Obtener historial de consumos de creditos de una empresa.\n     *\n     * @param int $empresa_id ID de la empresa.\n     * @param Request $request Contenido de la peticion.\n     * @return JsonResponse\n     * @author Sergio Vargas\n     */\n    public function historialConsumosCreditos(int $empresa_id, Request $request): JsonResponse {\n        return new JsonResponse([\n            'data' => $this->consumo_credito_servicio->historialConsumosEmpresa(\n                $empresa_id,\n                $request->only(['desde', 'hasta'])\n            )\n        ], JsonResponse::HTTP_OK);\n    }\n}\n","structuredPatch":[{"oldStart":195,"oldLines":6,"newStart":195,"newLines":9,"lines":["      * @author Daniel Beltrán","      */","     public function store(AsignarPlanRequest $request): JsonResponse {","+        // TODO: Eliminar esta excepción después de probar","+        throw new Exception('Prueba de validación - datos recibidos: ' . json_encode($request->all()));","+","         $codigo    = 201;","         $respuesta = [","             'message' => 'Plan asignado correctamente'"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"32e95474-ae62-44db-af7c-be8c61138b26"}
{"parentUuid":"b72abf84-0ec6-4854-9433-3d35878c3835","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XxMso69Vtvw4FvFZbVJrLs","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. Ahora cuando envíes el formulario:\n\n1. Se lanzará una excepción antes de guardar cualquier dato en la BD\n2. Verás en la respuesta de error los datos que se recibieron en formato JSON\n\nEsto te permitirá verificar que los datos se están enviando correctamente según el tipo de plan seleccionado.\n\n**Recuerda eliminar esta línea cuando termines de probar:**\n```php\nthrow new Exception('Prueba de validación - datos recibidos: ' . json_encode($request->all()));\n```"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":77473,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":77473,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK5CK2AQoncMvnDYsJYX","type":"assistant","uuid":"6802f7e4-e7e8-452b-9078-5ab67617d61f","timestamp":"2026-01-20T18:05:31.703Z"}
{"type":"queue-operation","operation":"dequeue","timestamp":"2026-01-20T18:51:48.087Z","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565"}
{"type":"file-history-snapshot","messageId":"c021b202-d0f6-46d4-9821-8095ec96331b","snapshot":{"messageId":"c021b202-d0f6-46d4-9821-8095ec96331b","trackedFileBackups":{"resources\\views\\empresas\\paginas\\asignar-plan.blade.php":{"backupFileName":"23a0b404d58f48f6@v2","version":2,"backupTime":"2026-01-20T17:45:44.948Z"},"public\\js\\empresas\\asignar-plan.js":{"backupFileName":"25fa1d462d51e622@v3","version":3,"backupTime":"2026-01-20T17:48:16.476Z"},"app\\Http\\Controllers\\Empresas\\EmpresaPlanController.php":{"backupFileName":"71d1198be92c5143@v2","version":2,"backupTime":"2026-01-20T18:51:49.885Z"}},"timestamp":"2026-01-20T18:51:49.862Z"},"isSnapshotUpdate":false}
{"parentUuid":"73fc6058-72df-4599-8adf-6a27285c2f06","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Read","command":"callback"},"toolUseID":"toolu_017jB2y18RZZ1aU8APzCSQsZ","parentToolUseID":"toolu_017jB2y18RZZ1aU8APzCSQsZ","uuid":"0d216d54-500c-4cc0-8db7-7bba8d031462","timestamp":"2026-01-20T17:48:22.574Z"}
{"parentUuid":"32e95474-ae62-44db-af7c-be8c61138b26","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01Fii1nBZRqGJic87y2JByDR","parentToolUseID":"toolu_01Fii1nBZRqGJic87y2JByDR","uuid":"b6c64856-0d03-4dc3-a5d0-c5e9fa2f84dd","timestamp":"2026-01-20T17:48:31.162Z"}
{"parentUuid":"b6c64856-0d03-4dc3-a5d0-c5e9fa2f84dd","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PreToolUse","hookName":"PreToolUse:Edit","command":"callback"},"toolUseID":"toolu_01Fii1nBZRqGJic87y2JByDR","parentToolUseID":"toolu_01Fii1nBZRqGJic87y2JByDR","uuid":"c621b89e-7ef8-4600-9ad8-a8bafb4fcb34","timestamp":"2026-01-20T17:48:31.164Z"}
{"parentUuid":"b72abf84-0ec6-4854-9433-3d35878c3835","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Edit","command":"callback"},"parentToolUseID":"toolu_01Fii1nBZRqGJic87y2JByDR","toolUseID":"toolu_01Fii1nBZRqGJic87y2JByDR","timestamp":"2026-01-20T18:05:24.390Z","uuid":"551ba439-e766-45aa-b90d-2602844bbee9"}
{"parentUuid":"6802f7e4-e7e8-452b-9078-5ab67617d61f","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"type":"text","text":"<ide_selection>The user selected the lines 210 to 210 from c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js:\ntiene_seleccion\n\nThis may or may not be related to the current task.</ide_selection>"},{"type":"text","text":"listo cuandosel lecciona un plan que no se aia se coloca un valor en el campode de venta pero si es ia no coloca nada entonces quiro colocar el vlaor del plan normal mal el de la ia"}]},"uuid":"c021b202-d0f6-46d4-9821-8095ec96331b","timestamp":"2026-01-20T18:51:49.860Z","todos":[]}
{"parentUuid":"c021b202-d0f6-46d4-9821-8095ec96331b","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_019WNpoujKajW3HJjDbjdgQX","type":"message","role":"assistant","content":[{"type":"text","text":"Entiendo, quieres que cuando se seleccione un plan de créditos IA, también se coloque su precio en el campo \"Valor de venta\", y si se seleccionan ambos planes, que se sumen los precios.\n\nPrimero déjame revisar cómo se maneja el precio en el plan de créditos:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":81846,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":81846,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK8jW4Q54iBnChZS2qKq","type":"assistant","uuid":"bf5ada68-a6b2-434b-bddf-66be3b6c87ab","timestamp":"2026-01-20T18:51:55.629Z"}
{"parentUuid":"bf5ada68-a6b2-434b-bddf-66be3b6c87ab","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_019WNpoujKajW3HJjDbjdgQX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LfjYLFG3MerFjjjpfc4AYJ","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","offset":370,"limit":60}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":81846,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":81846,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK8jW4Q54iBnChZS2qKq","type":"assistant","uuid":"718e10b1-bfa1-4e45-b6b7-c77bd6bcbd37","timestamp":"2026-01-20T18:51:56.463Z"}
{"parentUuid":"718e10b1-bfa1-4e45-b6b7-c77bd6bcbd37","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LfjYLFG3MerFjjjpfc4AYJ","type":"tool_result","content":"   370→ * @param {number} indice Índice del plan en el array.\n   371→ * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n   372→ * @returns {void}\n   373→ * @author Jair Carvajal\n   374→ */\n   375→function elegirPlanCreditos(indice, orden_mayor = false) {\n   376→    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n   377→    let planes_ordenados = [...planes_creditos];\n   378→    if (orden_mayor) {\n   379→        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n   380→    } else {\n   381→        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n   382→    }\n   383→\n   384→    plan_creditos_seleccionado = planes_ordenados[indice];\n   385→\n   386→    // Establecer los valores en los campos hidden\n   387→    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n   388→    $('#creditos').val(plan_creditos_seleccionado.creditos);\n   389→\n   390→    mostrarPlanCreditosSeleccionado();\n   391→\n   392→    if (typeof $.fn.modal !== 'undefined') {\n   393→        $('#modal-planes-creditos').modal('hide');\n   394→    }\n   395→}\n   396→\n   397→/**\n   398→ * Mostrar el plan de créditos seleccionado en el contenedor.\n   399→ *\n   400→ * @returns {void}\n   401→ * @author Jair Carvajal\n   402→ */\n   403→function mostrarPlanCreditosSeleccionado() {\n   404→    if (!plan_creditos_seleccionado || !plan_creditos_seleccionado.creditos) {\n   405→        mostrarToast('danger', 'Ocurrió un error'+plan_creditos_seleccionado);\n   406→        return;\n   407→    }\n   408→\n   409→    let creditos_disponibles = plan_creditos_seleccionado.creditos_disponibles || plan_creditos_seleccionado.creditos || 0;\n   410→    let creditos_promedio = plan_creditos_seleccionado.creditos_promedio_accion || 0;\n   411→    let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n   412→        ? Math.floor(creditos_disponibles / creditos_promedio)\n   413→        : 0;\n   414→\n   415→    let seccion_creditos = `\n   416→        <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n   417→            <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n   418→            <div class=\"card rounded rounded-3\">\n   419→                <div class=\"row align-items-center m-0 w-100 px-3 py-4 pointer\" onclick=\"modalElegirPlan(2);\">\n   420→                    <div class=\"col\">\n   421→                        <div class=\"text-headline-6\">${plan_creditos_seleccionado.nombre || 'Plan de Créditos'}</div>\n   422→                    </div>\n   423→                    <div class=\"col-auto\">\n   424→                        ${crearTag({\n   425→                            texto: 'Créditos disponibles: ' + plan_creditos_seleccionado.creditos.toLocaleString('es-CO'),\n   426→                            class: 'tag-tonal-yellow',\n   427→                        })}\n   428→                    </div>\n   429→                    <div class=\"col-auto text-primary fw-bold\">\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b14af53e-ff8b-4005-b14c-bf51f5bc0f35","timestamp":"2026-01-20T18:51:57.737Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","content":" * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}\n\n/**\n * Mostrar el plan de créditos seleccionado en el contenedor.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanCreditosSeleccionado() {\n    if (!plan_creditos_seleccionado || !plan_creditos_seleccionado.creditos) {\n        mostrarToast('danger', 'Ocurrió un error'+plan_creditos_seleccionado);\n        return;\n    }\n\n    let creditos_disponibles = plan_creditos_seleccionado.creditos_disponibles || plan_creditos_seleccionado.creditos || 0;\n    let creditos_promedio = plan_creditos_seleccionado.creditos_promedio_accion || 0;\n    let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n        ? Math.floor(creditos_disponibles / creditos_promedio)\n        : 0;\n\n    let seccion_creditos = `\n        <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n            <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n            <div class=\"card rounded rounded-3\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4 pointer\" onclick=\"modalElegirPlan(2);\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6\">${plan_creditos_seleccionado.nombre || 'Plan de Créditos'}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan_creditos_seleccionado.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">","numLines":60,"startLine":370,"totalLines":1108}},"sourceToolAssistantUUID":"718e10b1-bfa1-4e45-b6b7-c77bd6bcbd37"}
{"parentUuid":"b14af53e-ff8b-4005-b14c-bf51f5bc0f35","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01D9XjQ65vLVdxNZipnHzYgB","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora veo la función `elegirPlanCreditos`. También necesito ver cómo se establece el precio en `mostrarPlanSeleccionado`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1305,"cache_read_input_tokens":81846,"cache_creation":{"ephemeral_5m_input_tokens":1305,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXK8k6EiLuwt65NVPAGCD","type":"assistant","uuid":"d2277655-6421-44c1-910e-4c4713bff875","timestamp":"2026-01-20T18:52:01.340Z"}
{"parentUuid":"d2277655-6421-44c1-910e-4c4713bff875","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01D9XjQ65vLVdxNZipnHzYgB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CvNDdRjXTwBpJw77BY1ZeY","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","offset":640,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1305,"cache_read_input_tokens":81846,"cache_creation":{"ephemeral_5m_input_tokens":1305,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXK8k6EiLuwt65NVPAGCD","type":"assistant","uuid":"2a74d0ea-950c-4fa7-bcab-e6a11decd57a","timestamp":"2026-01-20T18:52:02.086Z"}
{"parentUuid":"2a74d0ea-950c-4fa7-bcab-e6a11decd57a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CvNDdRjXTwBpJw77BY1ZeY","type":"tool_result","content":"   640→                <div class=\"card rounded rounded-3\">\n   641→                    <div class=\"card-body text-center\">\n   642→                        <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n   643→                            Elegir Plan de Créditos IA\n   644→                        </button>\n   645→                    </div>\n   646→                </div>\n   647→            </div>\n   648→        `;\n   649→        $('#contenedor-creditos').append(seccion_creditos);\n   650→    }\n   651→\n   652→    $('#plan_id').val(plan_seleccionado.id);\n   653→    $('#seccion-pruebas').removeClass('d-none');\n   654→\n   655→    // Establecer el precio por defecto en el formulario principal\n   656→    $('#precio').val(plan_seleccionado.precio);\n   657→\n   658→    // Verificar si Bootstrap modal está disponible antes de usar\n   659→    if (typeof $.fn.modal !== 'undefined') {\n   660→        $('#modal-planes').modal('hide');\n   661→    }\n   662→\n   663→    ValidarPruebas();\n   664→    $('#boton-guardar-modificaciones').prop('disabled', true);\n   665→}\n   666→\n   667→/**\n   668→ * Abrir la factura del plan en una nueva pestaña del navegador.\n   669→ *\n   670→ * @param {number} factura_id Id de la factura.\n   671→ * @returns {void}\n   672→ * @author Andres Morales\n   673→ */\n   674→async function abrirFacturaPlan(factura_id) {\n   675→    if (!factura_id) {\n   676→        mostrarToast('danger', 'No se encontró la factura');\n   677→        return;\n   678→    }\n   679→\n   680→    try {\n   681→        const respuesta = await $.ajax({\n   682→            type: 'GET',\n   683→            url: `/archivos-abrir/${factura_id}`,\n   684→            xhrFields: { responseType: 'blob' }\n   685→        });\n   686→\n   687→        const blobUrl = window.URL.createObjectURL(respuesta);\n   688→        window.open(blobUrl, '_blank');\n   689→    } catch (error) {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"c34a892e-e995-471f-aff0-2105c9ce8161","timestamp":"2026-01-20T18:52:03.348Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","content":"                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                            Elegir Plan de Créditos IA\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;\n        $('#contenedor-creditos').append(seccion_creditos);\n    }\n\n    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {","numLines":50,"startLine":640,"totalLines":1108}},"sourceToolAssistantUUID":"2a74d0ea-950c-4fa7-bcab-e6a11decd57a"}
{"parentUuid":"c34a892e-e995-471f-aff0-2105c9ce8161","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_011xH3iNFobtMJNNGM5kNju9","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora entiendo. El precio se establece en la línea 656 solo para el plan de selección. Voy a crear una función para actualizar el precio total y modificar tanto `elegirPlanCreditos` como `mostrarPlanSeleccionado` para que sumen los precios."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":989,"cache_read_input_tokens":83151,"cache_creation":{"ephemeral_5m_input_tokens":989,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK8kVVSzwjFaoicXWTLX","type":"assistant","uuid":"6bde06c6-e2b9-4360-b80d-dea9f39ccad1","timestamp":"2026-01-20T18:52:07.144Z"}
{"parentUuid":"6bde06c6-e2b9-4360-b80d-dea9f39ccad1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_011xH3iNFobtMJNNGM5kNju9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KZMb9YXqRLznv3Wf4g121F","name":"TodoWrite","input":{"todos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"in_progress","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"pending","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"pending","activeForm":"Modificando mostrarPlanSeleccionado()"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":989,"cache_read_input_tokens":83151,"cache_creation":{"ephemeral_5m_input_tokens":989,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK8kVVSzwjFaoicXWTLX","type":"assistant","uuid":"85b9094d-d245-43c2-ad98-15337a803b06","timestamp":"2026-01-20T18:52:09.309Z"}
{"parentUuid":"85b9094d-d245-43c2-ad98-15337a803b06","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KZMb9YXqRLznv3Wf4g121F","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"870903c4-af4f-4a6d-a932-6e831a0ce980","timestamp":"2026-01-20T18:52:09.461Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"in_progress","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"pending","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"pending","activeForm":"Modificando mostrarPlanSeleccionado()"}]},"sourceToolAssistantUUID":"85b9094d-d245-43c2-ad98-15337a803b06"}
{"parentUuid":"870903c4-af4f-4a6d-a932-6e831a0ce980","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PhwtGuzH9iiJbBxP6EpvQV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UC6FQdTkopQ9eQf1tHkLAp","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","offset":1,"limit":15}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":335,"cache_read_input_tokens":84140,"cache_creation":{"ephemeral_5m_input_tokens":335,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXK8kxZ8Xw9zKntvTgJ61","type":"assistant","uuid":"2ebccc06-5fc8-4e34-bf5a-554e88ca6932","timestamp":"2026-01-20T18:52:13.046Z"}
{"parentUuid":"2ebccc06-5fc8-4e34-bf5a-554e88ca6932","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UC6FQdTkopQ9eQf1tHkLAp","type":"tool_result","content":"     1→table = null;\n     2→planes = [];\n     3→planes_creditos = [];\n     4→pruebas = [];\n     5→modificado = false;\n     6→funcionalidades_predefinidos = [];\n     7→plan_creditos_seleccionado = null;\n     8→\n     9→/**\n    10→ * Establecer el tipo de prueba en el selector del formulario.\n    11→ *\n    12→ * @param {number} tipo_prueba_id ID del tipo de prueba.\n    13→ * @returns {void}\n    14→ * @author José Manuel Jiménez\n    15→ * @author Daniel Beltrán\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5a11c715-d68e-409f-bdb9-38bb5fb3044a","timestamp":"2026-01-20T18:52:14.309Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","content":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán","numLines":15,"startLine":1,"totalLines":1108}},"sourceToolAssistantUUID":"2ebccc06-5fc8-4e34-bf5a-554e88ca6932"}
{"parentUuid":"5a11c715-d68e-409f-bdb9-38bb5fb3044a","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VS57GrxvXExj59mC2MycyK","type":"message","role":"assistant","content":[{"type":"text","text":"Voy a agregar la función `actualizarPrecioTotal()` después de las variables globales y luego modificar las funciones que establecen el precio:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":376,"cache_read_input_tokens":84475,"cache_creation":{"ephemeral_5m_input_tokens":376,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXK8mJUCSMY6B78orHgf8","type":"assistant","uuid":"03a04b2a-3040-4167-93f4-dee019085f59","timestamp":"2026-01-20T18:52:17.683Z"}
{"parentUuid":"03a04b2a-3040-4167-93f4-dee019085f59","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VS57GrxvXExj59mC2MycyK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WuPmsRhGPrHYuLFYDTSfyV","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","old_string":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.","new_string":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Actualizar el precio total sumando el plan de selección y el plan de créditos IA.\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction actualizarPrecioTotal() {\n    let precio_total = 0;\n\n    // Sumar precio del plan de selección si está seleccionado\n    if (plan_seleccionado && plan_seleccionado.precio) {\n        precio_total += parseFloat(plan_seleccionado.precio) || 0;\n    }\n\n    // Sumar precio del plan de créditos IA si está seleccionado\n    if (plan_creditos_seleccionado && plan_creditos_seleccionado.precio) {\n        precio_total += parseFloat(plan_creditos_seleccionado.precio) || 0;\n    }\n\n    // Establecer el precio total en el campo\n    if (precio_total > 0) {\n        $('#precio').val(precio_total);\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario."}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":376,"cache_read_input_tokens":84475,"cache_creation":{"ephemeral_5m_input_tokens":376,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXK8mJUCSMY6B78orHgf8","type":"assistant","uuid":"e5224817-84ac-43f8-9f58-9d4e8dda152c","timestamp":"2026-01-20T18:52:22.198Z"}
{"parentUuid":"e5224817-84ac-43f8-9f58-9d4e8dda152c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WuPmsRhGPrHYuLFYDTSfyV","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→table = null;\n     2→planes = [];\n     3→planes_creditos = [];\n     4→pruebas = [];\n     5→modificado = false;\n     6→funcionalidades_predefinidos = [];\n     7→plan_creditos_seleccionado = null;\n     8→\n     9→/**\n    10→ * Actualizar el precio total sumando el plan de selección y el plan de créditos IA.\n    11→ *\n    12→ * @returns {void}\n    13→ * @author Andres Gonzalez\n    14→ */\n    15→function actualizarPrecioTotal() {\n    16→    let precio_total = 0;\n    17→\n    18→    // Sumar precio del plan de selección si está seleccionado\n    19→    if (plan_seleccionado && plan_seleccionado.precio) {\n    20→        precio_total += parseFloat(plan_seleccionado.precio) || 0;\n    21→    }\n    22→\n    23→    // Sumar precio del plan de créditos IA si está seleccionado\n    24→    if (plan_creditos_seleccionado && plan_creditos_seleccionado.precio) {\n    25→        precio_total += parseFloat(plan_creditos_seleccionado.precio) || 0;\n    26→    }\n    27→\n    28→    // Establecer el precio total en el campo\n    29→    if (precio_total > 0) {\n    30→        $('#precio').val(precio_total);\n    31→    }\n    32→}\n    33→\n    34→/**\n    35→ * Establecer el tipo de prueba en el selector del formulario.\n    36→ *\n    37→ * @param {number} tipo_prueba_id ID del tipo de prueba.\n    38→ * @returns {void}\n    39→ * @author José Manuel Jiménez"}]},"uuid":"fb0f0dc4-7685-42fc-9ee5-d534f1c718f1","timestamp":"2026-01-20T18:52:46.464Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","oldString":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.","newString":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Actualizar el precio total sumando el plan de selección y el plan de créditos IA.\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction actualizarPrecioTotal() {\n    let precio_total = 0;\n\n    // Sumar precio del plan de selección si está seleccionado\n    if (plan_seleccionado && plan_seleccionado.precio) {\n        precio_total += parseFloat(plan_seleccionado.precio) || 0;\n    }\n\n    // Sumar precio del plan de créditos IA si está seleccionado\n    if (plan_creditos_seleccionado && plan_creditos_seleccionado.precio) {\n        precio_total += parseFloat(plan_creditos_seleccionado.precio) || 0;\n    }\n\n    // Establecer el precio total en el campo\n    if (precio_total > 0) {\n        $('#precio').val(precio_total);\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.","originalFile":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPrueba(tipo_prueba_id) {\n    $('#contenedor-plan').empty();\n    $('#seccion-pruebas').addClass('d-none');\n    $('#plan_id').val('');\n    pruebas = [];\n\n    // Convertir tipo_prueba_id a array si no lo es\n    let tipos_prueba = Array.isArray(tipo_prueba_id) ? tipo_prueba_id : [tipo_prueba_id];\n\n    // Crear los botones según los tipos de prueba seleccionados\n    let botones_html = '<div class=\"card-body text-center\">';\n\n    tipos_prueba.forEach(function(tipo_id) {\n        let texto_boton = 'Elegir plan';\n        let clase_boton = 'btn-outline-primary';\n\n        if (tipo_id == 1) {\n            texto_boton = 'Elegir Plan de Selección';\n            clase_boton = 'btn-outline-primary';\n        } else if (tipo_id == 2) {\n            texto_boton = 'Elegir Plan de Créditos IA';\n            clase_boton = 'btn-outline-info';\n        }\n\n        botones_html += `\n            <button type=\"button\" id=\"elegir-plan-${tipo_id}\" class=\"btn ${clase_boton} mx-1 my-1\" disabled onclick=\"modalElegirPlan(${tipo_id});\">\n                ${texto_boton}\n            </button>\n        `;\n    });\n\n    botones_html += '</div>';\n    $('#contenedor-plan').append(botones_html);\n\n    $('#tipo_prueba_id').val(tipo_prueba_id).trigger('select2');\n\n    if (tipo_prueba_id && (Array.isArray(tipo_prueba_id) ? tipo_prueba_id.length > 0 : tipo_prueba_id)) {\n        // Habilitar todos los botones creados\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', false);\n        });\n\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipo_prueba_id,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n    } else {\n        // Deshabilitar todos los botones si no hay tipo de prueba\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', true);\n        });\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n * @author Andres Gonzalez\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        limpiarAdicional();\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan y campos relacionados\n        $('#contenedor-plan').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        pruebas = [];\n        limpiarAdicional();\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    // Solo cargar pruebas si hay plan de selección\n    if (tiene_seleccion) {\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipos_prueba,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error al cargar las pruebas');\n        });\n    }\n}\n\n/**\n * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Jair Carvajal\n */\nfunction modalElegirPlan(tipo_especifico = null) {\n    let tipo_prueba_para_consulta = tipo_especifico !== null ? tipo_especifico : $('#tipo_prueba_id').val();\n\n    // Si es tipo 2 (Créditos IA), cargar planes de créditos\n    if (tipo_prueba_para_consulta == 2 || tipo_prueba_para_consulta == '2') {\n        $.ajax({\n            type: 'GET',\n            url: '/api/planes-creditos',\n            data: {\n                activo: true\n            }\n        }).then((respuesta) => {\n            planes_creditos = respuesta.data.planes;            \n            mostrarPlanesCreditos();\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n        return;\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/planes-listado`,\n        data: {\n            tipo_prueba_id: tipo_prueba_para_consulta\n        }\n    }).then((respuesta) => {\n        planes = respuesta.data;\n        mostrarPlanes(tipo_especifico);\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error');\n    });\n}\n\n/**\n * Mostrar los planes de créditos en el modal.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanesCreditos() {\n    let filtro_orden = $('#filtro-plan-credito').val();\n    let buscar = $('#buscador-plan-credito').val() || '';\n\n    // Ordenar planes según el filtro\n    let planes_ordenados = [...planes_creditos];\n    if (filtro_orden === 'Mayor') {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else if (filtro_orden === 'Menor') {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n    if (buscar !== '') {\n        planes_ordenados = planes_ordenados.filter(plan =>\n            plan.nombre.toLowerCase().includes(buscar.toLowerCase())\n        );\n    }\n\n    $('#contenedor-planes-creditos').empty();\n\n    if (planes_ordenados.length === 0) {\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"text-center py-5\">\n                <p class=\"text-muted\">No se encontraron planes</p>\n            </div>\n        `);\n    }\n\n    for (let i = 0; i < planes_ordenados.length; i++) {\n        let plan = planes_ordenados[i];\n        let creditos_disponibles = plan.creditos_disponibles || plan.creditos || 0;\n        let creditos_promedio = plan.creditos_promedio_accion || 0;\n        let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n            ? Math.floor(creditos_disponibles / creditos_promedio)\n            : 0;\n\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"card rounded rounded-3 border-hover pointer mb-3\" onclick=\"elegirPlanCreditos(${i}, ${filtro_orden === 'Mayor' ? 'true' : 'false'});\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6 text-gray-10\">${plan.nombre}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        `);\n    }\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('show');\n    }\n\n    $('#buscador-plan-credito').off('input').on('input', function() {\n        mostrarPlanesCreditos();\n    });\n}\n\n/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}\n\n/**\n * Mostrar el plan de créditos seleccionado en el contenedor.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanCreditosSeleccionado() {\n    if (!plan_creditos_seleccionado || !plan_creditos_seleccionado.creditos) {\n        mostrarToast('danger', 'Ocurrió un error'+plan_creditos_seleccionado);\n        return;\n    }\n\n    let creditos_disponibles = plan_creditos_seleccionado.creditos_disponibles || plan_creditos_seleccionado.creditos || 0;\n    let creditos_promedio = plan_creditos_seleccionado.creditos_promedio_accion || 0;\n    let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n        ? Math.floor(creditos_disponibles / creditos_promedio)\n        : 0;\n\n    let seccion_creditos = `\n        <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n            <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n            <div class=\"card rounded rounded-3\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4 pointer\" onclick=\"modalElegirPlan(2);\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6\">${plan_creditos_seleccionado.nombre || 'Plan de Créditos'}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan_creditos_seleccionado.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    // Remover el contenedor anterior si existe\n    $('#contenedor-plan-creditos').remove();\n\n    // Agregar después del contenedor-plan o dentro de contenedor-creditos\n    if ($('#contenedor-creditos').length) {\n        $('#contenedor-creditos').html(seccion_creditos);\n    } else {\n        $('#contenedor-plan').after(seccion_creditos);\n    }\n}\n\n/**\n * Mostrar en el modal los planes obtenidos en el listado.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction mostrarPlanes(tipo_especifico = null) {\n    let buscar = $('#buscador-plan').val();\n    let filtro_plan = $('#filtro-plan').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        table.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    for (let i = 0; i < planes.length; i++) {\n        if (\n            (filtro_plan == 'Todos') ||\n            (filtro_plan == 'Ofertas' && planes[i].cantidad_ofertas_laborales != null) ||\n            (filtro_plan == 'Unidades' && planes[i].unidades != null) ||\n            (filtro_plan == 'Tiempo' && planes[i].vigencia != null)\n        ) {\n            let cantidad_usuarios = '';\n            if (planes[i].cantidad_usuarios != null) {\n                cantidad_usuarios = `<div class=\"col-auto w-90px\"><i class=\"bi bi-person\"></i> ${planes[i].cantidad_usuarios}</div>`;\n            }\n            let cantidad_ofertas_laborales = '';\n            if (planes[i].cantidad_ofertas_laborales != null) {\n                cantidad_ofertas_laborales = `<div class=\"col-auto w-90px\"><i class=\"bi bi-briefcase\"></i> ${planes[i].cantidad_ofertas_laborales}</div>`;\n            }\n            let cantidad_pruebas = '';\n            if (planes[i].cantidad_pruebas != null) {\n                cantidad_pruebas = `<div class=\"col-auto w-90px\"><i class=\"bi bi-clipboard2-check\"></i> ${planes[i].cantidad_pruebas}</div>`;\n            }\n            let unidades = '';\n            if (planes[i].unidades != null) {\n                unidades = `<div class=\"col-auto w-90px\"><i class=\"bi bi-box\"></i> ${planes[i].unidades}</div>`;\n            }\n            let vigencia = '';\n            if (planes[i].vigencia == 90) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n            } else if (planes[i].vigencia == 180) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n            }  else if (planes[i].vigencia == 365) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n            } else if (planes[i].vigencia == null || planes[i].vigencia == 0) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n            } else {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${planes[i].vigencia} días</div>`;\n            }\n            $('#tbody-planes').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-2 pointer border-hover\" onclick=\"elegirPlan(${i});\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6\">\n                                <div class=\"col\">${planes[i].nombre !== null ? planes[i].nombre : ''}</div>\n                                ${cantidad_ofertas_laborales}\n                                ${unidades}\n                                ${cantidad_usuarios}\n                                ${cantidad_pruebas}\n                                ${vigencia}\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('show');\n    }\n\n    table = $('#tabla-planes').DataTable({\n        \"paging\": false,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": false\n    });\n    let buscador = $('#tabla-planes_wrapper input');\n    $(buscador).addClass('rounded-2 text-body-2');\n    $(buscador).prop('placeholder', 'Buscar');\n    $(buscador).prop('id', 'buscador-plan');\n    $('#input-busqueda').append(buscador);\n    $(buscador).val(buscar).trigger('input');\n}\n\n/**\n * Elegir un plan del listado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction elegirPlan(i) {\n    plan_seleccionado = planes[i];\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Mostrar el plan seleccionado en el contenedor y en las opciones del modificar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction mostrarPlanSeleccionado() {\n    let cantidad_usuarios = '';\n    let cantidad_usuarios_modal = $('#cantidad_usuarios_modal').val();\n    if (cantidad_usuarios_modal != '') {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${cantidad_usuarios_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_usuarios != null) {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${plan_seleccionado.cantidad_usuarios}</div>`;\n    }\n    let cantidad_ofertas_laborales = '';\n    let cantidad_ofertas_laborales_modal = $('#cantidad_ofertas_laborales_modal').val();\n    if (cantidad_ofertas_laborales_modal != '') {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${cantidad_ofertas_laborales_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_ofertas_laborales != null) {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${plan_seleccionado.cantidad_ofertas_laborales}</div>`;\n    }\n    let cantidad_pruebas = '';\n    let cantidad_pruebas_modal = $('#cantidad_pruebas_modal').val();\n    if (cantidad_pruebas_modal != '') {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${cantidad_pruebas_modal}</div>`;\n        $('.cantidad-pruebas').text(cantidad_pruebas_modal);\n    } else if (plan_seleccionado.cantidad_pruebas != null) {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${plan_seleccionado.cantidad_pruebas}</div>`;\n        $('.cantidad-pruebas').text(plan_seleccionado.cantidad_pruebas);\n    }\n    let unidades = '';\n    let unidades_modal = $('#unidades_modal').val();\n    if (unidades_modal != '') {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${unidades_modal}</div>`;\n    } else if (plan_seleccionado.unidades != null) {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${plan_seleccionado.unidades}</div>`;\n    }\n    let vigencia = '';\n    let vigencia_modal = $('#vigencia_modal').val();\n    if (plan_seleccionado.vigencia == 90 || vigencia_modal == '90') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n    } else if (plan_seleccionado.vigencia == 180 || vigencia_modal == '180') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n    }  else if (plan_seleccionado.vigencia == 365 || vigencia_modal == '365') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n    } else if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n    } else if (vigencia_modal != '') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${vigencia_modal} días</div>`;\n    } else {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${plan_seleccionado.vigencia} días</div>`;\n    }\n    let abrir_modal_elegir_plan = '';\n    let icono_editar = `\n        <div class=\"col-auto w-90px\">\n            <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalModificar(event);\" title=\"Modificar plan\">\n                <i class=\"bi bi-wrench\"></i>\n            </button>\n        </div>\n    `;\n    if (opcion == 'asignar') {\n        abrir_modal_elegir_plan = `onclick=\"modalElegirPlan();\"`;\n        icono_editar = '';\n    }\n    $('#contenedor-plan').empty();\n    $('#contenedor-plan').append(`\n        <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n        <div class=\"card rounded rounded-3\">\n            <div class=\"row align-items-center m-0 w-100 px-3 py-5 text-headline-6 pointer\" ${abrir_modal_elegir_plan}>\n                <div class=\"col\">${plan_seleccionado.nombre !== null ? plan_seleccionado.nombre : ''} <span id=\"plan-modificado\"></span></div>\n                ${cantidad_ofertas_laborales}\n                ${unidades}\n                ${cantidad_usuarios}\n                ${cantidad_pruebas}\n                ${vigencia}\n                ${icono_editar}\n            </div>\n        </div>\n    `);\n\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n    // Solo agregar el botón de elegir plan de créditos si no hay uno seleccionado y se requiere\n    if (tiene_creditos && plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n        let seccion_creditos = `\n            <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                            Elegir Plan de Créditos IA\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;\n        $('#contenedor-creditos').append(seccion_creditos);\n    }\n\n    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\n/**\n * Buscar las funcionalidades por tipo de prueba.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidades(tipo_prueba_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/funcionalidades-listado`,\n        data : {\n            tipo_prueba_id: tipo_prueba_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let beneficios = respuesta.data;\n            const adicionales = beneficios\n                .filter(item => item.predeterminado === 0)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            const predefinidos = beneficios\n                .filter(item => item.predeterminado === 1)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            funcionalidades_predefinidos = predefinidos;\n\n            // Verificar si el multiselect está inicializado antes de destruir\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect('destroy');\n            }\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect('destroy');\n            }\n\n            adicionales.forEach((item) => {\n                $('#adicionales_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            predefinidos.forEach((item) => {\n                $('#predefinidos_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            inizializarMultiselect();\n            if (opcion == 'facturar' || opcion == 'editar') {\n                buscarfuncionalidadesPlanEmpresa($('#id').val());\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Buscar las funcionalidades del plan de la empresa.\n *\n * @param {number} empresa_plan_id ID del plan de empresa.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidadesPlanEmpresa(empresa_plan_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-planes-funcionalidades-listado`,\n        data : {\n            empresa_plan_id: empresa_plan_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let funcionalidades = respuesta.data.map(item => item.funcionalidad_id);\n            $('#adicionales_modal').val(funcionalidades);\n\n            // Verificar si el multiselect está inicializado antes de refrescar\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect(\"refresh\");\n            }\n\n            $('#predefinidos_modal').val(funcionalidades);\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect(\"refresh\");\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Validar que al menos un tipo de plan esté seleccionado\n    if (!tiene_seleccion && !tiene_creditos) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos un tipo de plan.');\n        return valido;\n    }\n\n    // Validar plan de selección solo si está seleccionado el tipo 1\n    if (tiene_seleccion) {\n        if (!$('#plan_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de selección.');\n            return valido;\n        }\n\n        $('#vigencia').val($('#vigencia_modal').val());\n        if ($('#unidades_modal').val() == 'Ilimitadas') {\n            $('#unidades').val('');\n        } else {\n            $('#unidades').val($('#unidades_modal').val());\n        }\n        if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n            $('#cantidad_ofertas_laborales').val('');\n        } else {\n            $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n        }\n        $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n        $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            let adicionales = $('#adicionales_modal').val() || [];\n            let predefinidos = $('#predefinidos_modal').val() || [];\n            let funcionalidades = adicionales.concat(predefinidos);\n            $('#funcionalidades').val(JSON.stringify(funcionalidades));\n            if (funcionalidades.length == 0) {\n                valido = false;\n                mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n                return valido;\n            }\n        } else {\n            let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n            $('#funcionalidades').val(JSON.stringify(ids));\n        }\n\n        var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n            return this.value;\n        }).get();\n        $('#pruebas').val('');\n        let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n        if (maximo_pruebas == '') {\n            maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n        }\n        if (pruebas_seleccionadas.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una prueba.');\n            return valido;\n        } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n            return valido;\n        }\n        if (valido) {\n            $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n        }\n    }\n\n    // Validar plan de créditos solo si está seleccionado el tipo 2\n    if (tiene_creditos) {\n        if (!$('#plan_credito_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de créditos IA.');\n            return valido;\n        }\n    }\n\n    return valido;\n}\n\n\n/**\n * Función para validar que no se exceda al seleccionar limite de pruebas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction ValidarPruebas() {\n    let cantidad_seleccionadas = $('.pruebas:checked').length;\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (cantidad_seleccionadas > maximo_pruebas) {\n        $('#alerta-pruebas').removeClass('d-none');\n    } else {\n        $('#alerta-pruebas').addClass('d-none');\n    }\n}\n\n/**\n * Abrir el modal con los campos para modificar plan.\n *\n * @param {Event} evento Evento desencadenado.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalModificar(evento) {\n    evento.stopPropagation();\n    if (modificado == false) {\n        $('#nombre-plan-modal').text(plan_seleccionado.nombre);\n        $('#cantidad_pruebas_modal').empty();\n        $('#cantidad_pruebas_modal').append(`\n            <option value=\"\">Seleccione</option>\n        `);\n        for (let j = 1; j <= pruebas.length; j++) {\n            $('#cantidad_pruebas_modal').append(`\n                <option value=\"${j}\">${j} Pruebas</option>\n            `);\n        }\n        $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n        if ([90, 180, 365].includes(plan_seleccionado.vigencia)) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val(plan_seleccionado.vigencia).trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else if (plan_seleccionado.vigencia != null && plan_seleccionado.vigencia != 0) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val('personalizado').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else {\n            $('#tiempo_modal').prop('disabled', true);\n            $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val('');\n        }\n        if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n            $('#unidades_modal').val(plan_seleccionado.unidades);\n            $('#unidades_modal').prop('disabled', false);\n            if (opcion == 'asignar') {\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa_plan.cantidad_ofertas_laborales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', false);\n        } else {\n            $('#unidades_modal').val(empresa.procesos_estimados_mensuales);\n            $('#unidades_modal').prop('disabled', true);\n            if (opcion == 'facturar' || opcion == 'editar') {\n                $('#unidades_modal').val(plan_seleccionado.unidades);\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa.pruebas_estimadas_mensuales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', true);\n        }\n        $('#cantidad_usuarios_modal').val(plan_seleccionado.cantidad_usuarios);\n        if (opcion == 'facturar' || opcion == 'editar') {\n            $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n            buscarfuncionalidadesPlanEmpresa($('#id').val());\n        }\n        $('#boton-guardar-modificaciones').prop('disabled', true);\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('show');\n    }\n}\n\n/**\n * Función que habilita el boton de guardar un plan modificado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction habilitarBotonGuardar() {\n    $('#boton-guardar-modificaciones').prop('disabled', false);\n}\n\n/**\n * Función que controla los campos de vigencia en el modal de editar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTiempo(vigencia) {\n    $('.texto-label-tiempo').text('máximas permitidas');\n    $('#input-container-tiempo').removeClass('d-none');\n    $('#input-container-tiempo').addClass('col-md-6');\n    if (vigencia == 'personalizado') {\n        $('#input-container-vigencia').removeClass('d-none');\n        $('#vigencia_modal').val('');\n    } else if ((vigencia == '' || vigencia == null || vigencia == 0) && plan_seleccionado != null && (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0)) {\n        $('.texto-label-tiempo').text('');\n        $('#input-container-tiempo').addClass('d-none');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val('');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    } else if (['90', '180', '365'].includes(vigencia)) {\n        $('#input-container-tiempo').removeClass('col-md-6');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val(vigencia);\n    } else {\n        $('#vigencia_modal').val(vigencia);\n        $('#input-container-vigencia').addClass('d-none');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    }\n}\n\n/**\n * Abrir el modal de confirmación.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalEstasSeguro() {\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('hide');\n        $('#modal-estas-seguro').modal('show');\n    }\n}\n\n/**\n * Cancelar la edición de un plan.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction cancelarEdicion() {\n    modificado = false;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    limpiarAdicional();\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Confirmar los datos editados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction confirmarEdicion() {\n    modificado = true;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    $('#plan-modificado').text('(modificado)');\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Limpiar los campos del modal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction limpiarAdicional() {\n    $('#cantidad_pruebas_modal').val('').trigger('change').trigger('select2:select');\n    $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n    $('#unidades_modal').val('');\n    $('#cantidad_ofertas_laborales_modal').val('');\n    $('#cantidad_usuarios_modal').val('');\n\n    // Verificar si el multiselect está inicializado antes de llamar uncheckAll\n    if ($('#adicionales_modal').data('multiselect')) {\n        $('#adicionales_modal').multiselect(\"uncheckAll\");\n    }\n\n    if ($('#predefinidos_modal').data('multiselect')) {\n        $('#predefinidos_modal').multiselect(\"uncheckAll\");\n    }\n}\n\n/**\n * Función para ejecutar acciones luego de guardar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction postSuccess(respuesta) {\n    limpiarFormulario(respuesta.formulario);\n    if (opcion == 'asignar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se asignó con éxito a la empresa`,\n        }));\n    } else if (opcion == 'facturar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se facturó con éxito`,\n        }));\n    } else if (opcion == 'editar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se actualizó con éxito`,\n        }));\n    }\n    window.location.href='/empresas-gestionar/' + empresa.id;\n}\n","structuredPatch":[{"oldStart":7,"oldLines":6,"newStart":7,"newLines":31,"lines":[" plan_creditos_seleccionado = null;"," "," /**","+ * Actualizar el precio total sumando el plan de selección y el plan de créditos IA.","+ *","+ * @returns {void}","+ * @author Andres Gonzalez","+ */","+function actualizarPrecioTotal() {","+    let precio_total = 0;","+","+    // Sumar precio del plan de selección si está seleccionado","+    if (plan_seleccionado && plan_seleccionado.precio) {","+        precio_total += parseFloat(plan_seleccionado.precio) || 0;","+    }","+","+    // Sumar precio del plan de créditos IA si está seleccionado","+    if (plan_creditos_seleccionado && plan_creditos_seleccionado.precio) {","+        precio_total += parseFloat(plan_creditos_seleccionado.precio) || 0;","+    }","+","+    // Establecer el precio total en el campo","+    if (precio_total > 0) {","+        $('#precio').val(precio_total);","+    }","+}","+","+/**","  * Establecer el tipo de prueba en el selector del formulario.","  *","  * @param {number} tipo_prueba_id ID del tipo de prueba."]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"e5224817-84ac-43f8-9f58-9d4e8dda152c"}
{"parentUuid":"fb0f0dc4-7685-42fc-9ee5-d534f1c718f1","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_013zfZx7WhwHrgF1ir2CLQZ5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TBRsyqhDKReiDH8dxD1VcX","name":"TodoWrite","input":{"todos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"completed","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"in_progress","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"pending","activeForm":"Modificando mostrarPlanSeleccionado()"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1125,"cache_read_input_tokens":84851,"cache_creation":{"ephemeral_5m_input_tokens":1125,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXK8otPSJi8iaM1T1bhpj","type":"assistant","uuid":"9ad80f94-da69-489a-bbac-82f237d5b53e","timestamp":"2026-01-20T18:52:53.964Z"}
{"parentUuid":"9ad80f94-da69-489a-bbac-82f237d5b53e","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TBRsyqhDKReiDH8dxD1VcX","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"e10900d6-a2af-4104-9657-94de0f7c4704","timestamp":"2026-01-20T18:52:54.161Z","toolUseResult":{"oldTodos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"in_progress","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"pending","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"pending","activeForm":"Modificando mostrarPlanSeleccionado()"}],"newTodos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"completed","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"in_progress","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"pending","activeForm":"Modificando mostrarPlanSeleccionado()"}]},"sourceToolAssistantUUID":"9ad80f94-da69-489a-bbac-82f237d5b53e"}
{"parentUuid":"e10900d6-a2af-4104-9657-94de0f7c4704","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_018AzqX7B1yNkv8VGARyZc7R","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora modifico la función `elegirPlanCreditos` para que llame a `actualizarPrecioTotal()`:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":85976,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK8pFqGtrw7S3wwEH2wr","type":"assistant","uuid":"e747b74e-fe86-4596-8509-b8dcec630478","timestamp":"2026-01-20T18:52:57.400Z"}
{"parentUuid":"e747b74e-fe86-4596-8509-b8dcec630478","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_018AzqX7B1yNkv8VGARyZc7R","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YAsR5cGfFNYEe4p6KMVR8G","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","offset":395,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":85976,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK8pFqGtrw7S3wwEH2wr","type":"assistant","uuid":"ace8aa81-8665-4f71-a8aa-77118f128cae","timestamp":"2026-01-20T18:52:58.105Z"}
{"parentUuid":"ace8aa81-8665-4f71-a8aa-77118f128cae","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YAsR5cGfFNYEe4p6KMVR8G","type":"tool_result","content":"   395→ * @param {number} indice Índice del plan en el array.\n   396→ * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n   397→ * @returns {void}\n   398→ * @author Jair Carvajal\n   399→ */\n   400→function elegirPlanCreditos(indice, orden_mayor = false) {\n   401→    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n   402→    let planes_ordenados = [...planes_creditos];\n   403→    if (orden_mayor) {\n   404→        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n   405→    } else {\n   406→        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n   407→    }\n   408→\n   409→    plan_creditos_seleccionado = planes_ordenados[indice];\n   410→\n   411→    // Establecer los valores en los campos hidden\n   412→    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n   413→    $('#creditos').val(plan_creditos_seleccionado.creditos);\n   414→\n   415→    mostrarPlanCreditosSeleccionado();\n   416→\n   417→    if (typeof $.fn.modal !== 'undefined') {\n   418→        $('#modal-planes-creditos').modal('hide');\n   419→    }\n   420→}\n   421→\n   422→/**\n   423→ * Mostrar el plan de créditos seleccionado en el contenedor.\n   424→ *\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"9efd7036-c1f4-45f5-bdb4-d7c2d31189d2","timestamp":"2026-01-20T18:53:00.841Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","content":" * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}\n\n/**\n * Mostrar el plan de créditos seleccionado en el contenedor.\n *","numLines":30,"startLine":395,"totalLines":1133}},"sourceToolAssistantUUID":"ace8aa81-8665-4f71-a8aa-77118f128cae"}
{"parentUuid":"9efd7036-c1f4-45f5-bdb4-d7c2d31189d2","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XhKFYCm4XwmTZXkCwJbjkW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014r9VatHW7kLAydnvJpqV3j","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","old_string":"/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}","new_string":"/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n * @author Andres Gonzalez\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    // Actualizar el precio total (suma plan selección + plan créditos)\n    actualizarPrecioTotal();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":663,"cache_read_input_tokens":86240,"cache_creation":{"ephemeral_5m_input_tokens":663,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CXK8pk8sXgxHrLfecFyJD","type":"assistant","uuid":"5f2f6b2f-605b-430f-98ab-27d52e1aed8d","timestamp":"2026-01-20T18:53:09.068Z"}
{"parentUuid":"5f2f6b2f-605b-430f-98ab-27d52e1aed8d","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014r9VatHW7kLAydnvJpqV3j","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   388→        mostrarPlanesCreditos();\n   389→    });\n   390→}\n   391→\n   392→/**\n   393→ * Elegir un plan de créditos IA.\n   394→ *\n   395→ * @param {number} indice Índice del plan en el array.\n   396→ * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n   397→ * @returns {void}\n   398→ * @author Jair Carvajal\n   399→ * @author Andres Gonzalez\n   400→ */\n   401→function elegirPlanCreditos(indice, orden_mayor = false) {\n   402→    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n   403→    let planes_ordenados = [...planes_creditos];\n   404→    if (orden_mayor) {\n   405→        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n   406→    } else {\n   407→        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n   408→    }\n   409→\n   410→    plan_creditos_seleccionado = planes_ordenados[indice];\n   411→\n   412→    // Establecer los valores en los campos hidden\n   413→    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n   414→    $('#creditos').val(plan_creditos_seleccionado.creditos);\n   415→\n   416→    mostrarPlanCreditosSeleccionado();\n   417→\n   418→    // Actualizar el precio total (suma plan selección + plan créditos)\n   419→    actualizarPrecioTotal();\n   420→\n   421→    if (typeof $.fn.modal !== 'undefined') {\n   422→        $('#modal-planes-creditos').modal('hide');\n   423→    }\n   424→}\n   425→\n   426→/**\n   427→ * Mostrar el plan de créditos seleccionado en el contenedor.\n   428→ *"}]},"uuid":"ca65151a-b036-46d3-9c79-6fb4f522e527","timestamp":"2026-01-20T18:53:44.732Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","oldString":"/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}","newString":"/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n * @author Andres Gonzalez\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    // Actualizar el precio total (suma plan selección + plan créditos)\n    actualizarPrecioTotal();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}","originalFile":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Actualizar el precio total sumando el plan de selección y el plan de créditos IA.\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction actualizarPrecioTotal() {\n    let precio_total = 0;\n\n    // Sumar precio del plan de selección si está seleccionado\n    if (plan_seleccionado && plan_seleccionado.precio) {\n        precio_total += parseFloat(plan_seleccionado.precio) || 0;\n    }\n\n    // Sumar precio del plan de créditos IA si está seleccionado\n    if (plan_creditos_seleccionado && plan_creditos_seleccionado.precio) {\n        precio_total += parseFloat(plan_creditos_seleccionado.precio) || 0;\n    }\n\n    // Establecer el precio total en el campo\n    if (precio_total > 0) {\n        $('#precio').val(precio_total);\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPrueba(tipo_prueba_id) {\n    $('#contenedor-plan').empty();\n    $('#seccion-pruebas').addClass('d-none');\n    $('#plan_id').val('');\n    pruebas = [];\n\n    // Convertir tipo_prueba_id a array si no lo es\n    let tipos_prueba = Array.isArray(tipo_prueba_id) ? tipo_prueba_id : [tipo_prueba_id];\n\n    // Crear los botones según los tipos de prueba seleccionados\n    let botones_html = '<div class=\"card-body text-center\">';\n\n    tipos_prueba.forEach(function(tipo_id) {\n        let texto_boton = 'Elegir plan';\n        let clase_boton = 'btn-outline-primary';\n\n        if (tipo_id == 1) {\n            texto_boton = 'Elegir Plan de Selección';\n            clase_boton = 'btn-outline-primary';\n        } else if (tipo_id == 2) {\n            texto_boton = 'Elegir Plan de Créditos IA';\n            clase_boton = 'btn-outline-info';\n        }\n\n        botones_html += `\n            <button type=\"button\" id=\"elegir-plan-${tipo_id}\" class=\"btn ${clase_boton} mx-1 my-1\" disabled onclick=\"modalElegirPlan(${tipo_id});\">\n                ${texto_boton}\n            </button>\n        `;\n    });\n\n    botones_html += '</div>';\n    $('#contenedor-plan').append(botones_html);\n\n    $('#tipo_prueba_id').val(tipo_prueba_id).trigger('select2');\n\n    if (tipo_prueba_id && (Array.isArray(tipo_prueba_id) ? tipo_prueba_id.length > 0 : tipo_prueba_id)) {\n        // Habilitar todos los botones creados\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', false);\n        });\n\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipo_prueba_id,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n    } else {\n        // Deshabilitar todos los botones si no hay tipo de prueba\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', true);\n        });\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n * @author Andres Gonzalez\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        limpiarAdicional();\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan y campos relacionados\n        $('#contenedor-plan').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        pruebas = [];\n        limpiarAdicional();\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    // Solo cargar pruebas si hay plan de selección\n    if (tiene_seleccion) {\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipos_prueba,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error al cargar las pruebas');\n        });\n    }\n}\n\n/**\n * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Jair Carvajal\n */\nfunction modalElegirPlan(tipo_especifico = null) {\n    let tipo_prueba_para_consulta = tipo_especifico !== null ? tipo_especifico : $('#tipo_prueba_id').val();\n\n    // Si es tipo 2 (Créditos IA), cargar planes de créditos\n    if (tipo_prueba_para_consulta == 2 || tipo_prueba_para_consulta == '2') {\n        $.ajax({\n            type: 'GET',\n            url: '/api/planes-creditos',\n            data: {\n                activo: true\n            }\n        }).then((respuesta) => {\n            planes_creditos = respuesta.data.planes;            \n            mostrarPlanesCreditos();\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n        return;\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/planes-listado`,\n        data: {\n            tipo_prueba_id: tipo_prueba_para_consulta\n        }\n    }).then((respuesta) => {\n        planes = respuesta.data;\n        mostrarPlanes(tipo_especifico);\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error');\n    });\n}\n\n/**\n * Mostrar los planes de créditos en el modal.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanesCreditos() {\n    let filtro_orden = $('#filtro-plan-credito').val();\n    let buscar = $('#buscador-plan-credito').val() || '';\n\n    // Ordenar planes según el filtro\n    let planes_ordenados = [...planes_creditos];\n    if (filtro_orden === 'Mayor') {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else if (filtro_orden === 'Menor') {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n    if (buscar !== '') {\n        planes_ordenados = planes_ordenados.filter(plan =>\n            plan.nombre.toLowerCase().includes(buscar.toLowerCase())\n        );\n    }\n\n    $('#contenedor-planes-creditos').empty();\n\n    if (planes_ordenados.length === 0) {\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"text-center py-5\">\n                <p class=\"text-muted\">No se encontraron planes</p>\n            </div>\n        `);\n    }\n\n    for (let i = 0; i < planes_ordenados.length; i++) {\n        let plan = planes_ordenados[i];\n        let creditos_disponibles = plan.creditos_disponibles || plan.creditos || 0;\n        let creditos_promedio = plan.creditos_promedio_accion || 0;\n        let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n            ? Math.floor(creditos_disponibles / creditos_promedio)\n            : 0;\n\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"card rounded rounded-3 border-hover pointer mb-3\" onclick=\"elegirPlanCreditos(${i}, ${filtro_orden === 'Mayor' ? 'true' : 'false'});\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6 text-gray-10\">${plan.nombre}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        `);\n    }\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('show');\n    }\n\n    $('#buscador-plan-credito').off('input').on('input', function() {\n        mostrarPlanesCreditos();\n    });\n}\n\n/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}\n\n/**\n * Mostrar el plan de créditos seleccionado en el contenedor.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanCreditosSeleccionado() {\n    if (!plan_creditos_seleccionado || !plan_creditos_seleccionado.creditos) {\n        mostrarToast('danger', 'Ocurrió un error'+plan_creditos_seleccionado);\n        return;\n    }\n\n    let creditos_disponibles = plan_creditos_seleccionado.creditos_disponibles || plan_creditos_seleccionado.creditos || 0;\n    let creditos_promedio = plan_creditos_seleccionado.creditos_promedio_accion || 0;\n    let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n        ? Math.floor(creditos_disponibles / creditos_promedio)\n        : 0;\n\n    let seccion_creditos = `\n        <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n            <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n            <div class=\"card rounded rounded-3\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4 pointer\" onclick=\"modalElegirPlan(2);\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6\">${plan_creditos_seleccionado.nombre || 'Plan de Créditos'}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan_creditos_seleccionado.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    // Remover el contenedor anterior si existe\n    $('#contenedor-plan-creditos').remove();\n\n    // Agregar después del contenedor-plan o dentro de contenedor-creditos\n    if ($('#contenedor-creditos').length) {\n        $('#contenedor-creditos').html(seccion_creditos);\n    } else {\n        $('#contenedor-plan').after(seccion_creditos);\n    }\n}\n\n/**\n * Mostrar en el modal los planes obtenidos en el listado.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction mostrarPlanes(tipo_especifico = null) {\n    let buscar = $('#buscador-plan').val();\n    let filtro_plan = $('#filtro-plan').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        table.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    for (let i = 0; i < planes.length; i++) {\n        if (\n            (filtro_plan == 'Todos') ||\n            (filtro_plan == 'Ofertas' && planes[i].cantidad_ofertas_laborales != null) ||\n            (filtro_plan == 'Unidades' && planes[i].unidades != null) ||\n            (filtro_plan == 'Tiempo' && planes[i].vigencia != null)\n        ) {\n            let cantidad_usuarios = '';\n            if (planes[i].cantidad_usuarios != null) {\n                cantidad_usuarios = `<div class=\"col-auto w-90px\"><i class=\"bi bi-person\"></i> ${planes[i].cantidad_usuarios}</div>`;\n            }\n            let cantidad_ofertas_laborales = '';\n            if (planes[i].cantidad_ofertas_laborales != null) {\n                cantidad_ofertas_laborales = `<div class=\"col-auto w-90px\"><i class=\"bi bi-briefcase\"></i> ${planes[i].cantidad_ofertas_laborales}</div>`;\n            }\n            let cantidad_pruebas = '';\n            if (planes[i].cantidad_pruebas != null) {\n                cantidad_pruebas = `<div class=\"col-auto w-90px\"><i class=\"bi bi-clipboard2-check\"></i> ${planes[i].cantidad_pruebas}</div>`;\n            }\n            let unidades = '';\n            if (planes[i].unidades != null) {\n                unidades = `<div class=\"col-auto w-90px\"><i class=\"bi bi-box\"></i> ${planes[i].unidades}</div>`;\n            }\n            let vigencia = '';\n            if (planes[i].vigencia == 90) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n            } else if (planes[i].vigencia == 180) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n            }  else if (planes[i].vigencia == 365) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n            } else if (planes[i].vigencia == null || planes[i].vigencia == 0) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n            } else {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${planes[i].vigencia} días</div>`;\n            }\n            $('#tbody-planes').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-2 pointer border-hover\" onclick=\"elegirPlan(${i});\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6\">\n                                <div class=\"col\">${planes[i].nombre !== null ? planes[i].nombre : ''}</div>\n                                ${cantidad_ofertas_laborales}\n                                ${unidades}\n                                ${cantidad_usuarios}\n                                ${cantidad_pruebas}\n                                ${vigencia}\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('show');\n    }\n\n    table = $('#tabla-planes').DataTable({\n        \"paging\": false,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": false\n    });\n    let buscador = $('#tabla-planes_wrapper input');\n    $(buscador).addClass('rounded-2 text-body-2');\n    $(buscador).prop('placeholder', 'Buscar');\n    $(buscador).prop('id', 'buscador-plan');\n    $('#input-busqueda').append(buscador);\n    $(buscador).val(buscar).trigger('input');\n}\n\n/**\n * Elegir un plan del listado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction elegirPlan(i) {\n    plan_seleccionado = planes[i];\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Mostrar el plan seleccionado en el contenedor y en las opciones del modificar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction mostrarPlanSeleccionado() {\n    let cantidad_usuarios = '';\n    let cantidad_usuarios_modal = $('#cantidad_usuarios_modal').val();\n    if (cantidad_usuarios_modal != '') {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${cantidad_usuarios_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_usuarios != null) {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${plan_seleccionado.cantidad_usuarios}</div>`;\n    }\n    let cantidad_ofertas_laborales = '';\n    let cantidad_ofertas_laborales_modal = $('#cantidad_ofertas_laborales_modal').val();\n    if (cantidad_ofertas_laborales_modal != '') {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${cantidad_ofertas_laborales_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_ofertas_laborales != null) {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${plan_seleccionado.cantidad_ofertas_laborales}</div>`;\n    }\n    let cantidad_pruebas = '';\n    let cantidad_pruebas_modal = $('#cantidad_pruebas_modal').val();\n    if (cantidad_pruebas_modal != '') {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${cantidad_pruebas_modal}</div>`;\n        $('.cantidad-pruebas').text(cantidad_pruebas_modal);\n    } else if (plan_seleccionado.cantidad_pruebas != null) {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${plan_seleccionado.cantidad_pruebas}</div>`;\n        $('.cantidad-pruebas').text(plan_seleccionado.cantidad_pruebas);\n    }\n    let unidades = '';\n    let unidades_modal = $('#unidades_modal').val();\n    if (unidades_modal != '') {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${unidades_modal}</div>`;\n    } else if (plan_seleccionado.unidades != null) {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${plan_seleccionado.unidades}</div>`;\n    }\n    let vigencia = '';\n    let vigencia_modal = $('#vigencia_modal').val();\n    if (plan_seleccionado.vigencia == 90 || vigencia_modal == '90') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n    } else if (plan_seleccionado.vigencia == 180 || vigencia_modal == '180') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n    }  else if (plan_seleccionado.vigencia == 365 || vigencia_modal == '365') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n    } else if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n    } else if (vigencia_modal != '') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${vigencia_modal} días</div>`;\n    } else {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${plan_seleccionado.vigencia} días</div>`;\n    }\n    let abrir_modal_elegir_plan = '';\n    let icono_editar = `\n        <div class=\"col-auto w-90px\">\n            <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalModificar(event);\" title=\"Modificar plan\">\n                <i class=\"bi bi-wrench\"></i>\n            </button>\n        </div>\n    `;\n    if (opcion == 'asignar') {\n        abrir_modal_elegir_plan = `onclick=\"modalElegirPlan();\"`;\n        icono_editar = '';\n    }\n    $('#contenedor-plan').empty();\n    $('#contenedor-plan').append(`\n        <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n        <div class=\"card rounded rounded-3\">\n            <div class=\"row align-items-center m-0 w-100 px-3 py-5 text-headline-6 pointer\" ${abrir_modal_elegir_plan}>\n                <div class=\"col\">${plan_seleccionado.nombre !== null ? plan_seleccionado.nombre : ''} <span id=\"plan-modificado\"></span></div>\n                ${cantidad_ofertas_laborales}\n                ${unidades}\n                ${cantidad_usuarios}\n                ${cantidad_pruebas}\n                ${vigencia}\n                ${icono_editar}\n            </div>\n        </div>\n    `);\n\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n    // Solo agregar el botón de elegir plan de créditos si no hay uno seleccionado y se requiere\n    if (tiene_creditos && plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n        let seccion_creditos = `\n            <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                            Elegir Plan de Créditos IA\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;\n        $('#contenedor-creditos').append(seccion_creditos);\n    }\n\n    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\n/**\n * Buscar las funcionalidades por tipo de prueba.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidades(tipo_prueba_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/funcionalidades-listado`,\n        data : {\n            tipo_prueba_id: tipo_prueba_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let beneficios = respuesta.data;\n            const adicionales = beneficios\n                .filter(item => item.predeterminado === 0)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            const predefinidos = beneficios\n                .filter(item => item.predeterminado === 1)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            funcionalidades_predefinidos = predefinidos;\n\n            // Verificar si el multiselect está inicializado antes de destruir\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect('destroy');\n            }\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect('destroy');\n            }\n\n            adicionales.forEach((item) => {\n                $('#adicionales_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            predefinidos.forEach((item) => {\n                $('#predefinidos_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            inizializarMultiselect();\n            if (opcion == 'facturar' || opcion == 'editar') {\n                buscarfuncionalidadesPlanEmpresa($('#id').val());\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Buscar las funcionalidades del plan de la empresa.\n *\n * @param {number} empresa_plan_id ID del plan de empresa.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidadesPlanEmpresa(empresa_plan_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-planes-funcionalidades-listado`,\n        data : {\n            empresa_plan_id: empresa_plan_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let funcionalidades = respuesta.data.map(item => item.funcionalidad_id);\n            $('#adicionales_modal').val(funcionalidades);\n\n            // Verificar si el multiselect está inicializado antes de refrescar\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect(\"refresh\");\n            }\n\n            $('#predefinidos_modal').val(funcionalidades);\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect(\"refresh\");\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Validar que al menos un tipo de plan esté seleccionado\n    if (!tiene_seleccion && !tiene_creditos) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos un tipo de plan.');\n        return valido;\n    }\n\n    // Validar plan de selección solo si está seleccionado el tipo 1\n    if (tiene_seleccion) {\n        if (!$('#plan_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de selección.');\n            return valido;\n        }\n\n        $('#vigencia').val($('#vigencia_modal').val());\n        if ($('#unidades_modal').val() == 'Ilimitadas') {\n            $('#unidades').val('');\n        } else {\n            $('#unidades').val($('#unidades_modal').val());\n        }\n        if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n            $('#cantidad_ofertas_laborales').val('');\n        } else {\n            $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n        }\n        $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n        $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            let adicionales = $('#adicionales_modal').val() || [];\n            let predefinidos = $('#predefinidos_modal').val() || [];\n            let funcionalidades = adicionales.concat(predefinidos);\n            $('#funcionalidades').val(JSON.stringify(funcionalidades));\n            if (funcionalidades.length == 0) {\n                valido = false;\n                mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n                return valido;\n            }\n        } else {\n            let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n            $('#funcionalidades').val(JSON.stringify(ids));\n        }\n\n        var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n            return this.value;\n        }).get();\n        $('#pruebas').val('');\n        let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n        if (maximo_pruebas == '') {\n            maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n        }\n        if (pruebas_seleccionadas.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una prueba.');\n            return valido;\n        } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n            return valido;\n        }\n        if (valido) {\n            $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n        }\n    }\n\n    // Validar plan de créditos solo si está seleccionado el tipo 2\n    if (tiene_creditos) {\n        if (!$('#plan_credito_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de créditos IA.');\n            return valido;\n        }\n    }\n\n    return valido;\n}\n\n\n/**\n * Función para validar que no se exceda al seleccionar limite de pruebas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction ValidarPruebas() {\n    let cantidad_seleccionadas = $('.pruebas:checked').length;\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (cantidad_seleccionadas > maximo_pruebas) {\n        $('#alerta-pruebas').removeClass('d-none');\n    } else {\n        $('#alerta-pruebas').addClass('d-none');\n    }\n}\n\n/**\n * Abrir el modal con los campos para modificar plan.\n *\n * @param {Event} evento Evento desencadenado.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalModificar(evento) {\n    evento.stopPropagation();\n    if (modificado == false) {\n        $('#nombre-plan-modal').text(plan_seleccionado.nombre);\n        $('#cantidad_pruebas_modal').empty();\n        $('#cantidad_pruebas_modal').append(`\n            <option value=\"\">Seleccione</option>\n        `);\n        for (let j = 1; j <= pruebas.length; j++) {\n            $('#cantidad_pruebas_modal').append(`\n                <option value=\"${j}\">${j} Pruebas</option>\n            `);\n        }\n        $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n        if ([90, 180, 365].includes(plan_seleccionado.vigencia)) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val(plan_seleccionado.vigencia).trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else if (plan_seleccionado.vigencia != null && plan_seleccionado.vigencia != 0) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val('personalizado').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else {\n            $('#tiempo_modal').prop('disabled', true);\n            $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val('');\n        }\n        if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n            $('#unidades_modal').val(plan_seleccionado.unidades);\n            $('#unidades_modal').prop('disabled', false);\n            if (opcion == 'asignar') {\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa_plan.cantidad_ofertas_laborales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', false);\n        } else {\n            $('#unidades_modal').val(empresa.procesos_estimados_mensuales);\n            $('#unidades_modal').prop('disabled', true);\n            if (opcion == 'facturar' || opcion == 'editar') {\n                $('#unidades_modal').val(plan_seleccionado.unidades);\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa.pruebas_estimadas_mensuales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', true);\n        }\n        $('#cantidad_usuarios_modal').val(plan_seleccionado.cantidad_usuarios);\n        if (opcion == 'facturar' || opcion == 'editar') {\n            $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n            buscarfuncionalidadesPlanEmpresa($('#id').val());\n        }\n        $('#boton-guardar-modificaciones').prop('disabled', true);\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('show');\n    }\n}\n\n/**\n * Función que habilita el boton de guardar un plan modificado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction habilitarBotonGuardar() {\n    $('#boton-guardar-modificaciones').prop('disabled', false);\n}\n\n/**\n * Función que controla los campos de vigencia en el modal de editar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTiempo(vigencia) {\n    $('.texto-label-tiempo').text('máximas permitidas');\n    $('#input-container-tiempo').removeClass('d-none');\n    $('#input-container-tiempo').addClass('col-md-6');\n    if (vigencia == 'personalizado') {\n        $('#input-container-vigencia').removeClass('d-none');\n        $('#vigencia_modal').val('');\n    } else if ((vigencia == '' || vigencia == null || vigencia == 0) && plan_seleccionado != null && (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0)) {\n        $('.texto-label-tiempo').text('');\n        $('#input-container-tiempo').addClass('d-none');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val('');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    } else if (['90', '180', '365'].includes(vigencia)) {\n        $('#input-container-tiempo').removeClass('col-md-6');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val(vigencia);\n    } else {\n        $('#vigencia_modal').val(vigencia);\n        $('#input-container-vigencia').addClass('d-none');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    }\n}\n\n/**\n * Abrir el modal de confirmación.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalEstasSeguro() {\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('hide');\n        $('#modal-estas-seguro').modal('show');\n    }\n}\n\n/**\n * Cancelar la edición de un plan.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction cancelarEdicion() {\n    modificado = false;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    limpiarAdicional();\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Confirmar los datos editados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction confirmarEdicion() {\n    modificado = true;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    $('#plan-modificado').text('(modificado)');\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Limpiar los campos del modal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction limpiarAdicional() {\n    $('#cantidad_pruebas_modal').val('').trigger('change').trigger('select2:select');\n    $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n    $('#unidades_modal').val('');\n    $('#cantidad_ofertas_laborales_modal').val('');\n    $('#cantidad_usuarios_modal').val('');\n\n    // Verificar si el multiselect está inicializado antes de llamar uncheckAll\n    if ($('#adicionales_modal').data('multiselect')) {\n        $('#adicionales_modal').multiselect(\"uncheckAll\");\n    }\n\n    if ($('#predefinidos_modal').data('multiselect')) {\n        $('#predefinidos_modal').multiselect(\"uncheckAll\");\n    }\n}\n\n/**\n * Función para ejecutar acciones luego de guardar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction postSuccess(respuesta) {\n    limpiarFormulario(respuesta.formulario);\n    if (opcion == 'asignar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se asignó con éxito a la empresa`,\n        }));\n    } else if (opcion == 'facturar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se facturó con éxito`,\n        }));\n    } else if (opcion == 'editar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se actualizó con éxito`,\n        }));\n    }\n    window.location.href='/empresas-gestionar/' + empresa.id;\n}\n","structuredPatch":[{"oldStart":396,"oldLines":6,"newStart":396,"newLines":7,"lines":["  * @param {boolean} orden_mayor Si está ordenado de mayor a menor.","  * @returns {void}","  * @author Jair Carvajal","+ * @author Andres Gonzalez","  */"," function elegirPlanCreditos(indice, orden_mayor = false) {","     // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos"]},{"oldStart":414,"oldLines":6,"newStart":415,"newLines":9,"lines":[" ","     mostrarPlanCreditosSeleccionado();"," ","+    // Actualizar el precio total (suma plan selección + plan créditos)","+    actualizarPrecioTotal();","+","     if (typeof $.fn.modal !== 'undefined') {","         $('#modal-planes-creditos').modal('hide');","     }"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"5f2f6b2f-605b-430f-98ab-27d52e1aed8d"}
{"parentUuid":"ca65151a-b036-46d3-9c79-6fb4f522e527","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RLT19AXsPiMd33mGEdGVFw","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Pu8ow8VqXdvNtgXgbvwtJw","name":"TodoWrite","input":{"todos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"completed","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"completed","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"in_progress","activeForm":"Modificando mostrarPlanSeleccionado()"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1428,"cache_read_input_tokens":86903,"cache_creation":{"ephemeral_5m_input_tokens":1428,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CXK8t9n1GqonQBUuSqzCZ","type":"assistant","uuid":"0ed13f89-dda9-4e00-bb12-52a339d8a163","timestamp":"2026-01-20T18:53:51.737Z"}
{"parentUuid":"0ed13f89-dda9-4e00-bb12-52a339d8a163","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Pu8ow8VqXdvNtgXgbvwtJw","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"ce34f164-04d7-431d-9e03-f981bc4857df","timestamp":"2026-01-20T18:53:51.887Z","toolUseResult":{"oldTodos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"completed","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"in_progress","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"pending","activeForm":"Modificando mostrarPlanSeleccionado()"}],"newTodos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"completed","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"completed","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"in_progress","activeForm":"Modificando mostrarPlanSeleccionado()"}]},"sourceToolAssistantUUID":"0ed13f89-dda9-4e00-bb12-52a339d8a163"}
{"parentUuid":"ce34f164-04d7-431d-9e03-f981bc4857df","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CSps5juVRYrksDDGr5D2Lo","type":"message","role":"assistant","content":[{"type":"text","text":"Ahora modifico `mostrarPlanSeleccionado` para que use la función `actualizarPrecioTotal()` en lugar de establecer el precio directamente:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":88331,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK8tWo4F6WT3QFJfqfEg","type":"assistant","uuid":"48a7b10d-3772-4f4d-94b8-04c4c1b4b28c","timestamp":"2026-01-20T18:53:55.694Z"}
{"parentUuid":"48a7b10d-3772-4f4d-94b8-04c4c1b4b28c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CSps5juVRYrksDDGr5D2Lo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Fre1iMvMUD9yGZjoF63wGt","name":"Read","input":{"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","offset":675,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":264,"cache_read_input_tokens":88331,"cache_creation":{"ephemeral_5m_input_tokens":264,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CXK8tWo4F6WT3QFJfqfEg","type":"assistant","uuid":"b63b2db3-c3bd-4f34-a18e-12682c6e78f7","timestamp":"2026-01-20T18:53:57.505Z"}
{"parentUuid":"b63b2db3-c3bd-4f34-a18e-12682c6e78f7","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Fre1iMvMUD9yGZjoF63wGt","type":"tool_result","content":"   675→                </div>\n   676→            </div>\n   677→        `;\n   678→        $('#contenedor-creditos').append(seccion_creditos);\n   679→    }\n   680→\n   681→    $('#plan_id').val(plan_seleccionado.id);\n   682→    $('#seccion-pruebas').removeClass('d-none');\n   683→\n   684→    // Establecer el precio por defecto en el formulario principal\n   685→    $('#precio').val(plan_seleccionado.precio);\n   686→\n   687→    // Verificar si Bootstrap modal está disponible antes de usar\n   688→    if (typeof $.fn.modal !== 'undefined') {\n   689→        $('#modal-planes').modal('hide');\n   690→    }\n   691→\n   692→    ValidarPruebas();\n   693→    $('#boton-guardar-modificaciones').prop('disabled', true);\n   694→}\n   695→\n   696→/**\n   697→ * Abrir la factura del plan en una nueva pestaña del navegador.\n   698→ *\n   699→ * @param {number} factura_id Id de la factura.\n   700→ * @returns {void}\n   701→ * @author Andres Morales\n   702→ */\n   703→async function abrirFacturaPlan(factura_id) {\n   704→    if (!factura_id) {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"85bd5d84-6d79-4aee-9c8d-51c7c867116c","timestamp":"2026-01-20T18:54:00.262Z","toolUseResult":{"type":"text","file":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","content":"                </div>\n            </div>\n        `;\n        $('#contenedor-creditos').append(seccion_creditos);\n    }\n\n    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {","numLines":30,"startLine":675,"totalLines":1137}},"sourceToolAssistantUUID":"b63b2db3-c3bd-4f34-a18e-12682c6e78f7"}
{"parentUuid":"85bd5d84-6d79-4aee-9c8d-51c7c867116c","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VnMUkLqyQV7HKB58Puu63X","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01E3Wovx5N6DY55fhpqw23hu","name":"Edit","input":{"replace_all":false,"file_path":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","old_string":"    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}","new_string":"    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Actualizar el precio total (suma plan selección + plan créditos)\n    actualizarPrecioTotal();\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":608,"cache_read_input_tokens":88595,"cache_creation":{"ephemeral_5m_input_tokens":608,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CXK8u8LDnrKJqKD94crMb","type":"assistant","uuid":"74b9b840-7a23-47e2-aff9-70319f34c454","timestamp":"2026-01-20T18:54:05.781Z"}
{"parentUuid":"74b9b840-7a23-47e2-aff9-70319f34c454","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E3Wovx5N6DY55fhpqw23hu","type":"tool_result","content":"The file c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   677→        `;\n   678→        $('#contenedor-creditos').append(seccion_creditos);\n   679→    }\n   680→\n   681→    $('#plan_id').val(plan_seleccionado.id);\n   682→    $('#seccion-pruebas').removeClass('d-none');\n   683→\n   684→    // Actualizar el precio total (suma plan selección + plan créditos)\n   685→    actualizarPrecioTotal();\n   686→\n   687→    // Verificar si Bootstrap modal está disponible antes de usar\n   688→    if (typeof $.fn.modal !== 'undefined') {\n   689→        $('#modal-planes').modal('hide');\n   690→    }\n   691→\n   692→    ValidarPruebas();\n   693→    $('#boton-guardar-modificaciones').prop('disabled', true);\n   694→}\n   695→\n   696→/**\n   697→ * Abrir la factura del plan en una nueva pestaña del navegador.\n   698→ *"}]},"uuid":"9e2ce411-300b-4d29-8b40-00924f3aaaad","timestamp":"2026-01-20T18:54:50.754Z","toolUseResult":{"filePath":"c:\\laragon\\www\\psicoalianza-2\\public\\js\\empresas\\asignar-plan.js","oldString":"    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}","newString":"    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Actualizar el precio total (suma plan selección + plan créditos)\n    actualizarPrecioTotal();\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}","originalFile":"table = null;\nplanes = [];\nplanes_creditos = [];\npruebas = [];\nmodificado = false;\nfuncionalidades_predefinidos = [];\nplan_creditos_seleccionado = null;\n\n/**\n * Actualizar el precio total sumando el plan de selección y el plan de créditos IA.\n *\n * @returns {void}\n * @author Andres Gonzalez\n */\nfunction actualizarPrecioTotal() {\n    let precio_total = 0;\n\n    // Sumar precio del plan de selección si está seleccionado\n    if (plan_seleccionado && plan_seleccionado.precio) {\n        precio_total += parseFloat(plan_seleccionado.precio) || 0;\n    }\n\n    // Sumar precio del plan de créditos IA si está seleccionado\n    if (plan_creditos_seleccionado && plan_creditos_seleccionado.precio) {\n        precio_total += parseFloat(plan_creditos_seleccionado.precio) || 0;\n    }\n\n    // Establecer el precio total en el campo\n    if (precio_total > 0) {\n        $('#precio').val(precio_total);\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Andres Morales\n * @author Jair Carvajal\n */\nfunction seleccionarTipoPrueba(tipo_prueba_id) {\n    $('#contenedor-plan').empty();\n    $('#seccion-pruebas').addClass('d-none');\n    $('#plan_id').val('');\n    pruebas = [];\n\n    // Convertir tipo_prueba_id a array si no lo es\n    let tipos_prueba = Array.isArray(tipo_prueba_id) ? tipo_prueba_id : [tipo_prueba_id];\n\n    // Crear los botones según los tipos de prueba seleccionados\n    let botones_html = '<div class=\"card-body text-center\">';\n\n    tipos_prueba.forEach(function(tipo_id) {\n        let texto_boton = 'Elegir plan';\n        let clase_boton = 'btn-outline-primary';\n\n        if (tipo_id == 1) {\n            texto_boton = 'Elegir Plan de Selección';\n            clase_boton = 'btn-outline-primary';\n        } else if (tipo_id == 2) {\n            texto_boton = 'Elegir Plan de Créditos IA';\n            clase_boton = 'btn-outline-info';\n        }\n\n        botones_html += `\n            <button type=\"button\" id=\"elegir-plan-${tipo_id}\" class=\"btn ${clase_boton} mx-1 my-1\" disabled onclick=\"modalElegirPlan(${tipo_id});\">\n                ${texto_boton}\n            </button>\n        `;\n    });\n\n    botones_html += '</div>';\n    $('#contenedor-plan').append(botones_html);\n\n    $('#tipo_prueba_id').val(tipo_prueba_id).trigger('select2');\n\n    if (tipo_prueba_id && (Array.isArray(tipo_prueba_id) ? tipo_prueba_id.length > 0 : tipo_prueba_id)) {\n        // Habilitar todos los botones creados\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', false);\n        });\n\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipo_prueba_id,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n    } else {\n        // Deshabilitar todos los botones si no hay tipo de prueba\n        tipos_prueba.forEach(function(tipo_id) {\n            $(`#elegir-plan-${tipo_id}`).prop('disabled', true);\n        });\n    }\n}\n\n/**\n * Establecer el tipo de prueba en el selector del formulario.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author Jair Carvajal\n * @author Andres Gonzalez\n */\nfunction seleccionarTipoPruebaMultiple() {\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n\n    tipos_prueba = tipos_prueba.filter(function(tipo_id) {\n        return tipo_id !== null && tipo_id !== '' && tipo_id !== undefined;\n    });\n\n    if (tipos_prueba.length === 0) {\n        // Si no hay tipos seleccionados, limpiar todo\n        $('#contenedor-plan').empty();\n        $('#contenedor-creditos').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        $('#plan_id').val('');\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        plan_seleccionado = null;\n        plan_creditos_seleccionado = null;\n        pruebas = [];\n        limpiarAdicional();\n        return;\n    }\n\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Manejo del plan de selección\n    if (tiene_seleccion) {\n        // Si hay un plan seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_seleccionado === null && $('#contenedor-plan').children().length === 0) {\n            let seccion_seleccion = `\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-1\" class=\"btn btn-outline-primary mx-1 my-1\" onclick=\"modalElegirPlan(1);\">\n                            Elegir Plan de Selección\n                        </button>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-plan').html(seccion_seleccion);\n        }\n    } else {\n        // Si se deseleccionó el tipo de selección, limpiar el plan y campos relacionados\n        $('#contenedor-plan').empty();\n        $('#seccion-pruebas').addClass('d-none');\n        $('#contenedor-pruebas').empty();\n        plan_seleccionado = null;\n        $('#plan_id').val('');\n        $('#pruebas').val('');\n        $('#vigencia').val('');\n        $('#unidades').val('');\n        $('#cantidad_ofertas_laborales').val('');\n        $('#cantidad_usuarios').val('');\n        $('#cantidad_pruebas').val('');\n        $('#funcionalidades').val('');\n        pruebas = [];\n        limpiarAdicional();\n    }\n\n    // Manejo del plan de créditos\n    if (tiene_creditos) {\n        // Si hay un plan de créditos seleccionado, mantenerlo; si no, mostrar el botón\n        if (plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n            let seccion_creditos = `\n                <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                    <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                    <div class=\"card rounded rounded-3\">\n                        <div class=\"card-body text-center\">\n                            <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                                Elegir Plan de Créditos IA\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            `;\n            $('#contenedor-creditos').html(seccion_creditos);\n        }\n    } else {\n        // Si se deseleccionó el tipo de créditos, limpiar el plan de créditos\n        $('#contenedor-creditos').empty();\n        $('#contenedor-plan-creditos').remove();\n        plan_creditos_seleccionado = null;\n        $('#plan_credito_id').val('');\n        $('#creditos').val('');\n    }\n\n    // Solo cargar pruebas si hay plan de selección\n    if (tiene_seleccion) {\n        $.ajax({\n            type: 'GET',\n            url : `/pruebas-listado`,\n            data: {\n                tipo_prueba_id: tipos_prueba,\n                activo: 1\n            }\n        }).then((respuesta) => {\n            limpiarAdicional();\n            $('#contenedor-pruebas').empty();\n            pruebas = respuesta.data;\n            for (let i = 0; i < pruebas.length; i++) {\n                $('#contenedor-pruebas').append(`\n                    <div class=\"col-12 col-md-6\">\n                        <div class=\"d-flex align-items-center\">\n                            <div class=\"check-container my-1 me-1\">\n                                <input type=\"checkbox\" id=\"prueba-${pruebas[i].id}\" name=\"prueba-${pruebas[i].id}\" value=\"${pruebas[i].id}\" class=\"form-check-input input-dinamico pruebas\" onchange=\"ValidarPruebas();\">\n                            </div>\n                            <label class=\"text-label-1\" for=\"prueba-${pruebas[i].id}\">${pruebas[i].nombre}</label>\n                        </div>\n                    </div>\n                `);\n            }\n\n            if (opcion == 'facturar' || opcion == 'editar') {\n                for (let i = 0; i < pruebas_empresa_plan.length; i++) {\n                    $(`#prueba-${pruebas_empresa_plan[i].id}`).prop('checked', true);\n                }\n                $('#seccion-pruebas').removeClass('d-none');\n                mostrarPlanSeleccionado();\n            }\n\n            if (opcion == 'editar') {\n                $('#tipo_prueba_id').prop('disabled', true);\n            }\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error al cargar las pruebas');\n        });\n    }\n}\n\n/**\n * Obtener el listado de planes según el tipo_prueba_id seleccionado anteriormente.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Jair Carvajal\n */\nfunction modalElegirPlan(tipo_especifico = null) {\n    let tipo_prueba_para_consulta = tipo_especifico !== null ? tipo_especifico : $('#tipo_prueba_id').val();\n\n    // Si es tipo 2 (Créditos IA), cargar planes de créditos\n    if (tipo_prueba_para_consulta == 2 || tipo_prueba_para_consulta == '2') {\n        $.ajax({\n            type: 'GET',\n            url: '/api/planes-creditos',\n            data: {\n                activo: true\n            }\n        }).then((respuesta) => {\n            planes_creditos = respuesta.data.planes;            \n            mostrarPlanesCreditos();\n        }).catch((error) => {\n            mostrarToast('danger', 'Ocurrió un error');\n        });\n        return;\n    }\n\n    $.ajax({\n        type: 'GET',\n        url : `/planes-listado`,\n        data: {\n            tipo_prueba_id: tipo_prueba_para_consulta\n        }\n    }).then((respuesta) => {\n        planes = respuesta.data;\n        mostrarPlanes(tipo_especifico);\n    }).catch((error) => {\n        mostrarToast('danger', 'Ocurrió un error');\n    });\n}\n\n/**\n * Mostrar los planes de créditos en el modal.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanesCreditos() {\n    let filtro_orden = $('#filtro-plan-credito').val();\n    let buscar = $('#buscador-plan-credito').val() || '';\n\n    // Ordenar planes según el filtro\n    let planes_ordenados = [...planes_creditos];\n    if (filtro_orden === 'Mayor') {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else if (filtro_orden === 'Menor') {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n    if (buscar !== '') {\n        planes_ordenados = planes_ordenados.filter(plan =>\n            plan.nombre.toLowerCase().includes(buscar.toLowerCase())\n        );\n    }\n\n    $('#contenedor-planes-creditos').empty();\n\n    if (planes_ordenados.length === 0) {\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"text-center py-5\">\n                <p class=\"text-muted\">No se encontraron planes</p>\n            </div>\n        `);\n    }\n\n    for (let i = 0; i < planes_ordenados.length; i++) {\n        let plan = planes_ordenados[i];\n        let creditos_disponibles = plan.creditos_disponibles || plan.creditos || 0;\n        let creditos_promedio = plan.creditos_promedio_accion || 0;\n        let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n            ? Math.floor(creditos_disponibles / creditos_promedio)\n            : 0;\n\n        $('#contenedor-planes-creditos').append(`\n            <div class=\"card rounded rounded-3 border-hover pointer mb-3\" onclick=\"elegirPlanCreditos(${i}, ${filtro_orden === 'Mayor' ? 'true' : 'false'});\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6 text-gray-10\">${plan.nombre}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        `);\n    }\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('show');\n    }\n\n    $('#buscador-plan-credito').off('input').on('input', function() {\n        mostrarPlanesCreditos();\n    });\n}\n\n/**\n * Elegir un plan de créditos IA.\n *\n * @param {number} indice Índice del plan en el array.\n * @param {boolean} orden_mayor Si está ordenado de mayor a menor.\n * @returns {void}\n * @author Jair Carvajal\n * @author Andres Gonzalez\n */\nfunction elegirPlanCreditos(indice, orden_mayor = false) {\n    // Aplicar el mismo ordenamiento que en mostrarPlanesCreditos\n    let planes_ordenados = [...planes_creditos];\n    if (orden_mayor) {\n        planes_ordenados.sort((a, b) => b.creditos - a.creditos);\n    } else {\n        planes_ordenados.sort((a, b) => a.creditos - b.creditos);\n    }\n\n    plan_creditos_seleccionado = planes_ordenados[indice];\n\n    // Establecer los valores en los campos hidden\n    $('#plan_credito_id').val(plan_creditos_seleccionado.id);\n    $('#creditos').val(plan_creditos_seleccionado.creditos);\n\n    mostrarPlanCreditosSeleccionado();\n\n    // Actualizar el precio total (suma plan selección + plan créditos)\n    actualizarPrecioTotal();\n\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes-creditos').modal('hide');\n    }\n}\n\n/**\n * Mostrar el plan de créditos seleccionado en el contenedor.\n *\n * @returns {void}\n * @author Jair Carvajal\n */\nfunction mostrarPlanCreditosSeleccionado() {\n    if (!plan_creditos_seleccionado || !plan_creditos_seleccionado.creditos) {\n        mostrarToast('danger', 'Ocurrió un error'+plan_creditos_seleccionado);\n        return;\n    }\n\n    let creditos_disponibles = plan_creditos_seleccionado.creditos_disponibles || plan_creditos_seleccionado.creditos || 0;\n    let creditos_promedio = plan_creditos_seleccionado.creditos_promedio_accion || 0;\n    let acciones_estimadas = creditos_disponibles > 0 && creditos_promedio > 0\n        ? Math.floor(creditos_disponibles / creditos_promedio)\n        : 0;\n\n    let seccion_creditos = `\n        <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n            <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n            <div class=\"card rounded rounded-3\">\n                <div class=\"row align-items-center m-0 w-100 px-3 py-4 pointer\" onclick=\"modalElegirPlan(2);\">\n                    <div class=\"col\">\n                        <div class=\"text-headline-6\">${plan_creditos_seleccionado.nombre || 'Plan de Créditos'}</div>\n                    </div>\n                    <div class=\"col-auto\">\n                        ${crearTag({\n                            texto: 'Créditos disponibles: ' + plan_creditos_seleccionado.creditos.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                    <div class=\"col-auto text-primary fw-bold\">\n                        ${crearTag({\n                            texto: 'Acciones estimadas: ' + acciones_estimadas.toLocaleString('es-CO'),\n                            class: 'tag-tonal-yellow',\n                        })}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `;\n\n    // Remover el contenedor anterior si existe\n    $('#contenedor-plan-creditos').remove();\n\n    // Agregar después del contenedor-plan o dentro de contenedor-creditos\n    if ($('#contenedor-creditos').length) {\n        $('#contenedor-creditos').html(seccion_creditos);\n    } else {\n        $('#contenedor-plan').after(seccion_creditos);\n    }\n}\n\n/**\n * Mostrar en el modal los planes obtenidos en el listado.\n *\n * @param {number|null} tipo_especifico ID del tipo de prueba específico (opcional).\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n * @author Jair Carvajal\n */\nfunction mostrarPlanes(tipo_especifico = null) {\n    let buscar = $('#buscador-plan').val();\n    let filtro_plan = $('#filtro-plan').val();\n    if ($.fn.DataTable.isDataTable('#tabla-planes')) {\n        table.destroy();\n    }\n    $('#buscador-plan').remove();\n    $('#tbody-planes').empty();\n    for (let i = 0; i < planes.length; i++) {\n        if (\n            (filtro_plan == 'Todos') ||\n            (filtro_plan == 'Ofertas' && planes[i].cantidad_ofertas_laborales != null) ||\n            (filtro_plan == 'Unidades' && planes[i].unidades != null) ||\n            (filtro_plan == 'Tiempo' && planes[i].vigencia != null)\n        ) {\n            let cantidad_usuarios = '';\n            if (planes[i].cantidad_usuarios != null) {\n                cantidad_usuarios = `<div class=\"col-auto w-90px\"><i class=\"bi bi-person\"></i> ${planes[i].cantidad_usuarios}</div>`;\n            }\n            let cantidad_ofertas_laborales = '';\n            if (planes[i].cantidad_ofertas_laborales != null) {\n                cantidad_ofertas_laborales = `<div class=\"col-auto w-90px\"><i class=\"bi bi-briefcase\"></i> ${planes[i].cantidad_ofertas_laborales}</div>`;\n            }\n            let cantidad_pruebas = '';\n            if (planes[i].cantidad_pruebas != null) {\n                cantidad_pruebas = `<div class=\"col-auto w-90px\"><i class=\"bi bi-clipboard2-check\"></i> ${planes[i].cantidad_pruebas}</div>`;\n            }\n            let unidades = '';\n            if (planes[i].unidades != null) {\n                unidades = `<div class=\"col-auto w-90px\"><i class=\"bi bi-box\"></i> ${planes[i].unidades}</div>`;\n            }\n            let vigencia = '';\n            if (planes[i].vigencia == 90) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n            } else if (planes[i].vigencia == 180) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n            }  else if (planes[i].vigencia == 365) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n            } else if (planes[i].vigencia == null || planes[i].vigencia == 0) {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n            } else {\n                vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${planes[i].vigencia} días</div>`;\n            }\n            $('#tbody-planes').append(`\n                <tr>\n                    <td style=\"border-bottom: 0px!important;\">\n                        <div class=\"border border-1 rounded rounded-2 pointer border-hover\" onclick=\"elegirPlan(${i});\">\n                            <div class=\"row m-0 w-100 px-3 py-5 text-headline-6\">\n                                <div class=\"col\">${planes[i].nombre !== null ? planes[i].nombre : ''}</div>\n                                ${cantidad_ofertas_laborales}\n                                ${unidades}\n                                ${cantidad_usuarios}\n                                ${cantidad_pruebas}\n                                ${vigencia}\n                            </div>\n                        </div>\n                    </td>\n                </tr>\n            `);\n        }\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('show');\n    }\n\n    table = $('#tabla-planes').DataTable({\n        \"paging\": false,\n        \"searching\": true,\n        \"ordering\": false,\n        \"info\": false\n    });\n    let buscador = $('#tabla-planes_wrapper input');\n    $(buscador).addClass('rounded-2 text-body-2');\n    $(buscador).prop('placeholder', 'Buscar');\n    $(buscador).prop('id', 'buscador-plan');\n    $('#input-busqueda').append(buscador);\n    $(buscador).val(buscar).trigger('input');\n}\n\n/**\n * Elegir un plan del listado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction elegirPlan(i) {\n    plan_seleccionado = planes[i];\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Mostrar el plan seleccionado en el contenedor y en las opciones del modificar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction mostrarPlanSeleccionado() {\n    let cantidad_usuarios = '';\n    let cantidad_usuarios_modal = $('#cantidad_usuarios_modal').val();\n    if (cantidad_usuarios_modal != '') {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${cantidad_usuarios_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_usuarios != null) {\n        cantidad_usuarios = `<div class=\"col-auto\"><i class=\"bi bi-person\"></i> ${plan_seleccionado.cantidad_usuarios}</div>`;\n    }\n    let cantidad_ofertas_laborales = '';\n    let cantidad_ofertas_laborales_modal = $('#cantidad_ofertas_laborales_modal').val();\n    if (cantidad_ofertas_laborales_modal != '') {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${cantidad_ofertas_laborales_modal}</div>`;\n    } else if (plan_seleccionado.cantidad_ofertas_laborales != null) {\n        cantidad_ofertas_laborales = `<div class=\"col-auto\"><i class=\"bi bi-briefcase\"></i> ${plan_seleccionado.cantidad_ofertas_laborales}</div>`;\n    }\n    let cantidad_pruebas = '';\n    let cantidad_pruebas_modal = $('#cantidad_pruebas_modal').val();\n    if (cantidad_pruebas_modal != '') {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${cantidad_pruebas_modal}</div>`;\n        $('.cantidad-pruebas').text(cantidad_pruebas_modal);\n    } else if (plan_seleccionado.cantidad_pruebas != null) {\n        cantidad_pruebas = `<div class=\"col-auto\"><i class=\"bi bi-clipboard2-check\"></i> ${plan_seleccionado.cantidad_pruebas}</div>`;\n        $('.cantidad-pruebas').text(plan_seleccionado.cantidad_pruebas);\n    }\n    let unidades = '';\n    let unidades_modal = $('#unidades_modal').val();\n    if (unidades_modal != '') {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${unidades_modal}</div>`;\n    } else if (plan_seleccionado.unidades != null) {\n        unidades = `<div class=\"col-auto\"><i class=\"bi bi-box\"></i> ${plan_seleccionado.unidades}</div>`;\n    }\n    let vigencia = '';\n    let vigencia_modal = $('#vigencia_modal').val();\n    if (plan_seleccionado.vigencia == 90 || vigencia_modal == '90') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 3 Meses</div>`;\n    } else if (plan_seleccionado.vigencia == 180 || vigencia_modal == '180') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 6 Meses</div>`;\n    }  else if (plan_seleccionado.vigencia == 365 || vigencia_modal == '365') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> 1 Año</div>`;\n    } else if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> Ilimitado</div>`;\n    } else if (vigencia_modal != '') {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${vigencia_modal} días</div>`;\n    } else {\n        vigencia = `<div class=\"col-auto w-120px\"><i class=\"bi bi-clock\"></i> ${plan_seleccionado.vigencia} días</div>`;\n    }\n    let abrir_modal_elegir_plan = '';\n    let icono_editar = `\n        <div class=\"col-auto w-90px\">\n            <button type=\"button\" class=\"btn btn-text-primary text-white btn-circle\" onclick=\"abrirModalModificar(event);\" title=\"Modificar plan\">\n                <i class=\"bi bi-wrench\"></i>\n            </button>\n        </div>\n    `;\n    if (opcion == 'asignar') {\n        abrir_modal_elegir_plan = `onclick=\"modalElegirPlan();\"`;\n        icono_editar = '';\n    }\n    $('#contenedor-plan').empty();\n    $('#contenedor-plan').append(`\n        <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Selección</p>\n        <div class=\"card rounded rounded-3\">\n            <div class=\"row align-items-center m-0 w-100 px-3 py-5 text-headline-6 pointer\" ${abrir_modal_elegir_plan}>\n                <div class=\"col\">${plan_seleccionado.nombre !== null ? plan_seleccionado.nombre : ''} <span id=\"plan-modificado\"></span></div>\n                ${cantidad_ofertas_laborales}\n                ${unidades}\n                ${cantidad_usuarios}\n                ${cantidad_pruebas}\n                ${vigencia}\n                ${icono_editar}\n            </div>\n        </div>\n    `);\n\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n    // Solo agregar el botón de elegir plan de créditos si no hay uno seleccionado y se requiere\n    if (tiene_creditos && plan_creditos_seleccionado === null && $('#contenedor-plan-creditos').length === 0) {\n        let seccion_creditos = `\n            <div class=\"mt-3\" id=\"contenedor-plan-creditos\">\n                <p class=\"text-headline-4 text-gray-10 mb-2\">Plan de Créditos IA</p>\n                <div class=\"card rounded rounded-3\">\n                    <div class=\"card-body text-center\">\n                        <button type=\"button\" id=\"elegir-plan-2\" class=\"btn btn-outline-info mx-1 my-1\" onclick=\"modalElegirPlan(2);\">\n                            Elegir Plan de Créditos IA\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;\n        $('#contenedor-creditos').append(seccion_creditos);\n    }\n\n    $('#plan_id').val(plan_seleccionado.id);\n    $('#seccion-pruebas').removeClass('d-none');\n\n    // Establecer el precio por defecto en el formulario principal\n    $('#precio').val(plan_seleccionado.precio);\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-planes').modal('hide');\n    }\n\n    ValidarPruebas();\n    $('#boton-guardar-modificaciones').prop('disabled', true);\n}\n\n/**\n * Abrir la factura del plan en una nueva pestaña del navegador.\n *\n * @param {number} factura_id Id de la factura.\n * @returns {void}\n * @author Andres Morales\n */\nasync function abrirFacturaPlan(factura_id) {\n    if (!factura_id) {\n        mostrarToast('danger', 'No se encontró la factura');\n        return;\n    }\n\n    try {\n        const respuesta = await $.ajax({\n            type: 'GET',\n            url: `/archivos-abrir/${factura_id}`,\n            xhrFields: { responseType: 'blob' }\n        });\n\n        const blobUrl = window.URL.createObjectURL(respuesta);\n        window.open(blobUrl, '_blank');\n    } catch (error) {\n        mostrarToast('danger', 'Ocurrió un error al intentar abrir la factura');\n    }\n}\n\n/**\n * Buscar las funcionalidades por tipo de prueba.\n *\n * @param {number} tipo_prueba_id ID del tipo de prueba.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidades(tipo_prueba_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/funcionalidades-listado`,\n        data : {\n            tipo_prueba_id: tipo_prueba_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let beneficios = respuesta.data;\n            const adicionales = beneficios\n                .filter(item => item.predeterminado === 0)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            const predefinidos = beneficios\n                .filter(item => item.predeterminado === 1)\n                .map(({ id, nombre, predeterminado }) => ({ id, nombre, predeterminado }))\n                .sort((a, b) => b.id - a.id);\n            funcionalidades_predefinidos = predefinidos;\n\n            // Verificar si el multiselect está inicializado antes de destruir\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect('destroy');\n            }\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect('destroy');\n            }\n\n            adicionales.forEach((item) => {\n                $('#adicionales_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            predefinidos.forEach((item) => {\n                $('#predefinidos_modal').append(`<option value=\"${item.id}\">${item.nombre}</option>`);\n            });\n            inizializarMultiselect();\n            if (opcion == 'facturar' || opcion == 'editar') {\n                buscarfuncionalidadesPlanEmpresa($('#id').val());\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Buscar las funcionalidades del plan de la empresa.\n *\n * @param {number} empresa_plan_id ID del plan de empresa.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction buscarfuncionalidadesPlanEmpresa(empresa_plan_id) {\n    $.ajax({\n        type : 'GET',\n        url : `/empresas-planes-funcionalidades-listado`,\n        data : {\n            empresa_plan_id: empresa_plan_id,\n            incluir_tipo_prueba_null: true\n        },\n        success: function(respuesta) {\n            let funcionalidades = respuesta.data.map(item => item.funcionalidad_id);\n            $('#adicionales_modal').val(funcionalidades);\n\n            // Verificar si el multiselect está inicializado antes de refrescar\n            if ($('#adicionales_modal').data('multiselect')) {\n                $('#adicionales_modal').multiselect(\"refresh\");\n            }\n\n            $('#predefinidos_modal').val(funcionalidades);\n\n            if ($('#predefinidos_modal').data('multiselect')) {\n                $('#predefinidos_modal').multiselect(\"refresh\");\n            }\n        },\n        error: function(error) {\n            mostrarToast('danger', 'Ocurrió un error');\n        }\n    });\n}\n\n/**\n * Función para agregar validaciones adicionales y data adicional en el envío del form.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Andres Gonzalez\n */\nfunction validacionAdicional() {\n    let valido = true;\n    let tipos_prueba = $('#tipo_prueba_id').val() || [];\n    let tiene_seleccion = tipos_prueba.includes('1') || tipos_prueba.includes(1);\n    let tiene_creditos = tipos_prueba.includes('2') || tipos_prueba.includes(2);\n\n    // Validar que al menos un tipo de plan esté seleccionado\n    if (!tiene_seleccion && !tiene_creditos) {\n        valido = false;\n        mostrarToast('danger', 'Seleccione al menos un tipo de plan.');\n        return valido;\n    }\n\n    // Validar plan de selección solo si está seleccionado el tipo 1\n    if (tiene_seleccion) {\n        if (!$('#plan_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de selección.');\n            return valido;\n        }\n\n        $('#vigencia').val($('#vigencia_modal').val());\n        if ($('#unidades_modal').val() == 'Ilimitadas') {\n            $('#unidades').val('');\n        } else {\n            $('#unidades').val($('#unidades_modal').val());\n        }\n        if ($('#cantidad_ofertas_laborales_modal').val() == 'Ilimitadas') {\n            $('#cantidad_ofertas_laborales').val('');\n        } else {\n            $('#cantidad_ofertas_laborales').val($('#cantidad_ofertas_laborales_modal').val());\n        }\n        $('#cantidad_usuarios').val($('#cantidad_usuarios_modal').val());\n        $('#cantidad_pruebas').val($('#cantidad_pruebas_modal').val());\n\n        if (opcion == 'facturar' || opcion == 'editar') {\n            let adicionales = $('#adicionales_modal').val() || [];\n            let predefinidos = $('#predefinidos_modal').val() || [];\n            let funcionalidades = adicionales.concat(predefinidos);\n            $('#funcionalidades').val(JSON.stringify(funcionalidades));\n            if (funcionalidades.length == 0) {\n                valido = false;\n                mostrarToast('danger', 'Seleccione al menos una funcionalidad.');\n                return valido;\n            }\n        } else {\n            let ids = plan_seleccionado.funcionalidades.map(objeto => objeto.id);\n            $('#funcionalidades').val(JSON.stringify(ids));\n        }\n\n        var pruebas_seleccionadas = $('.pruebas:checked').map(function() {\n            return this.value;\n        }).get();\n        $('#pruebas').val('');\n        let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n        if (maximo_pruebas == '') {\n            maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n        }\n        if (pruebas_seleccionadas.length == 0) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione al menos una prueba.');\n            return valido;\n        } else if (pruebas_seleccionadas.length > maximo_pruebas) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione máximo ' + maximo_pruebas + ' pruebas.');\n            return valido;\n        }\n        if (valido) {\n            $('#pruebas').val(JSON.stringify(pruebas_seleccionadas));\n        }\n    }\n\n    // Validar plan de créditos solo si está seleccionado el tipo 2\n    if (tiene_creditos) {\n        if (!$('#plan_credito_id').val()) {\n            valido = false;\n            mostrarToast('danger', 'Seleccione un plan de créditos IA.');\n            return valido;\n        }\n    }\n\n    return valido;\n}\n\n\n/**\n * Función para validar que no se exceda al seleccionar limite de pruebas.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction ValidarPruebas() {\n    let cantidad_seleccionadas = $('.pruebas:checked').length;\n    let maximo_pruebas = $('#cantidad_pruebas_modal').val();\n    if (maximo_pruebas == '') {\n        maximo_pruebas = plan_seleccionado.cantidad_pruebas;\n    }\n    if (cantidad_seleccionadas > maximo_pruebas) {\n        $('#alerta-pruebas').removeClass('d-none');\n    } else {\n        $('#alerta-pruebas').addClass('d-none');\n    }\n}\n\n/**\n * Abrir el modal con los campos para modificar plan.\n *\n * @param {Event} evento Evento desencadenado.\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalModificar(evento) {\n    evento.stopPropagation();\n    if (modificado == false) {\n        $('#nombre-plan-modal').text(plan_seleccionado.nombre);\n        $('#cantidad_pruebas_modal').empty();\n        $('#cantidad_pruebas_modal').append(`\n            <option value=\"\">Seleccione</option>\n        `);\n        for (let j = 1; j <= pruebas.length; j++) {\n            $('#cantidad_pruebas_modal').append(`\n                <option value=\"${j}\">${j} Pruebas</option>\n            `);\n        }\n        $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n        if ([90, 180, 365].includes(plan_seleccionado.vigencia)) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val(plan_seleccionado.vigencia).trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else if (plan_seleccionado.vigencia != null && plan_seleccionado.vigencia != 0) {\n            $('#tiempo_modal').prop('disabled', false);\n            $('#tiempo_modal').val('personalizado').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val(plan_seleccionado.vigencia);\n        } else {\n            $('#tiempo_modal').prop('disabled', true);\n            $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n            $('#vigencia_modal').val('');\n        }\n        if (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0) {\n            $('#unidades_modal').val(plan_seleccionado.unidades);\n            $('#unidades_modal').prop('disabled', false);\n            if (opcion == 'asignar') {\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa_plan.cantidad_ofertas_laborales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', false);\n        } else {\n            $('#unidades_modal').val(empresa.procesos_estimados_mensuales);\n            $('#unidades_modal').prop('disabled', true);\n            if (opcion == 'facturar' || opcion == 'editar') {\n                $('#unidades_modal').val(plan_seleccionado.unidades);\n                $('#cantidad_ofertas_laborales_modal').val(plan_seleccionado.cantidad_ofertas_laborales);\n            } else {\n                $('#cantidad_ofertas_laborales_modal').val(empresa.pruebas_estimadas_mensuales);\n            }\n            $('#cantidad_ofertas_laborales_modal').prop('disabled', true);\n        }\n        $('#cantidad_usuarios_modal').val(plan_seleccionado.cantidad_usuarios);\n        if (opcion == 'facturar' || opcion == 'editar') {\n            $('#cantidad_pruebas_modal').val(plan_seleccionado.cantidad_pruebas).trigger('change').trigger('select2:select');\n            buscarfuncionalidadesPlanEmpresa($('#id').val());\n        }\n        $('#boton-guardar-modificaciones').prop('disabled', true);\n    }\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('show');\n    }\n}\n\n/**\n * Función que habilita el boton de guardar un plan modificado.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction habilitarBotonGuardar() {\n    $('#boton-guardar-modificaciones').prop('disabled', false);\n}\n\n/**\n * Función que controla los campos de vigencia en el modal de editar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction seleccionarTiempo(vigencia) {\n    $('.texto-label-tiempo').text('máximas permitidas');\n    $('#input-container-tiempo').removeClass('d-none');\n    $('#input-container-tiempo').addClass('col-md-6');\n    if (vigencia == 'personalizado') {\n        $('#input-container-vigencia').removeClass('d-none');\n        $('#vigencia_modal').val('');\n    } else if ((vigencia == '' || vigencia == null || vigencia == 0) && plan_seleccionado != null && (plan_seleccionado.vigencia == null || plan_seleccionado.vigencia == 0)) {\n        $('.texto-label-tiempo').text('');\n        $('#input-container-tiempo').addClass('d-none');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val('');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    } else if (['90', '180', '365'].includes(vigencia)) {\n        $('#input-container-tiempo').removeClass('col-md-6');\n        $('#input-container-vigencia').addClass('d-none');\n        $('#vigencia_modal').val(vigencia);\n    } else {\n        $('#vigencia_modal').val(vigencia);\n        $('#input-container-vigencia').addClass('d-none');\n        $('#input-container-tiempo').removeClass('col-md-6');\n    }\n}\n\n/**\n * Abrir el modal de confirmación.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction abrirModalEstasSeguro() {\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-modificar-planes').modal('hide');\n        $('#modal-estas-seguro').modal('show');\n    }\n}\n\n/**\n * Cancelar la edición de un plan.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction cancelarEdicion() {\n    modificado = false;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    limpiarAdicional();\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Confirmar los datos editados.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction confirmarEdicion() {\n    modificado = true;\n\n    // Verificar si Bootstrap modal está disponible antes de usar\n    if (typeof $.fn.modal !== 'undefined') {\n        $('#modal-estas-seguro').modal('hide');\n    }\n\n    $('#plan-modificado').text('(modificado)');\n    mostrarPlanSeleccionado();\n}\n\n/**\n * Limpiar los campos del modal.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n * @author Daniel Beltrán\n */\nfunction limpiarAdicional() {\n    $('#cantidad_pruebas_modal').val('').trigger('change').trigger('select2:select');\n    $('#tiempo_modal').val('').trigger('change').trigger('select2:select');\n    $('#unidades_modal').val('');\n    $('#cantidad_ofertas_laborales_modal').val('');\n    $('#cantidad_usuarios_modal').val('');\n\n    // Verificar si el multiselect está inicializado antes de llamar uncheckAll\n    if ($('#adicionales_modal').data('multiselect')) {\n        $('#adicionales_modal').multiselect(\"uncheckAll\");\n    }\n\n    if ($('#predefinidos_modal').data('multiselect')) {\n        $('#predefinidos_modal').multiselect(\"uncheckAll\");\n    }\n}\n\n/**\n * Función para ejecutar acciones luego de guardar.\n *\n * @returns {void}\n * @author José Manuel Jiménez\n */\nfunction postSuccess(respuesta) {\n    limpiarFormulario(respuesta.formulario);\n    if (opcion == 'asignar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se asignó con éxito a la empresa`,\n        }));\n    } else if (opcion == 'facturar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se facturó con éxito`,\n        }));\n    } else if (opcion == 'editar') {\n        localStorage.setItem('notificacionToast', JSON.stringify({\n            tipo_alerta: 'success',\n            texto_1: `El plan se actualizó con éxito`,\n        }));\n    }\n    window.location.href='/empresas-gestionar/' + empresa.id;\n}\n","structuredPatch":[{"oldStart":681,"oldLines":8,"newStart":681,"newLines":8,"lines":["     $('#plan_id').val(plan_seleccionado.id);","     $('#seccion-pruebas').removeClass('d-none');"," ","-    // Establecer el precio por defecto en el formulario principal","-    $('#precio').val(plan_seleccionado.precio);","+    // Actualizar el precio total (suma plan selección + plan créditos)","+    actualizarPrecioTotal();"," ","     // Verificar si Bootstrap modal está disponible antes de usar","     if (typeof $.fn.modal !== 'undefined') {"]}],"userModified":false,"replaceAll":false},"sourceToolAssistantUUID":"74b9b840-7a23-47e2-aff9-70319f34c454"}
{"parentUuid":"9e2ce411-300b-4d29-8b40-00924f3aaaad","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01N4snUA31Z8e4ErCDgQea58","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015LxyZvSDc73DoKBVohQ9bz","name":"TodoWrite","input":{"todos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"completed","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"completed","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"completed","activeForm":"Modificando mostrarPlanSeleccionado()"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":732,"cache_read_input_tokens":89203,"cache_creation":{"ephemeral_5m_input_tokens":732,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CXK8y2ScnZGRVgdyMxDrQ","type":"assistant","uuid":"f47259ff-12d7-4b1b-9c11-d293d58004dd","timestamp":"2026-01-20T18:54:57.315Z"}
{"parentUuid":"f47259ff-12d7-4b1b-9c11-d293d58004dd","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015LxyZvSDc73DoKBVohQ9bz","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"61a85331-b148-4b02-9319-9e71a5a5a4d9","timestamp":"2026-01-20T18:54:57.452Z","toolUseResult":{"oldTodos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"completed","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"completed","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"in_progress","activeForm":"Modificando mostrarPlanSeleccionado()"}],"newTodos":[{"content":"Crear función para calcular precio total (plan selección + plan créditos)","status":"completed","activeForm":"Creando función actualizarPrecioTotal()"},{"content":"Modificar elegirPlanCreditos para actualizar el precio","status":"completed","activeForm":"Modificando elegirPlanCreditos()"},{"content":"Modificar mostrarPlanSeleccionado para usar la nueva función","status":"completed","activeForm":"Modificando mostrarPlanSeleccionado()"}]},"sourceToolAssistantUUID":"f47259ff-12d7-4b1b-9c11-d293d58004dd"}
{"parentUuid":"61a85331-b148-4b02-9319-9e71a5a5a4d9","isSidechain":false,"userType":"external","cwd":"c:\\laragon\\www\\psicoalianza-2","sessionId":"a351f1a5-759b-4e6e-8c18-ab32451cb565","version":"2.1.11","gitBranch":"D26-260","slug":"wild-foraging-dewdrop","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PHUAUJj1Cg7h3428qwptgc","type":"message","role":"assistant","content":[{"type":"text","text":"Listo. He implementado los cambios:\n\n## Resumen de cambios\n\n### 1. Nueva función `actualizarPrecioTotal()` - [líneas 15-32](public/js/empresas/asignar-plan.js#L15-L32)\n```javascript\nfunction actualizarPrecioTotal() {\n    let precio_total = 0;\n\n    // Sumar precio del plan de selección si está seleccionado\n    if (plan_seleccionado && plan_seleccionado.precio) {\n        precio_total += parseFloat(plan_seleccionado.precio) || 0;\n    }\n\n    // Sumar precio del plan de créditos IA si está seleccionado\n    if (plan_creditos_seleccionado && plan_creditos_seleccionado.precio) {\n        precio_total += parseFloat(plan_creditos_seleccionado.precio) || 0;\n    }\n\n    // Establecer el precio total en el campo\n    if (precio_total > 0) {\n        $('#precio').val(precio_total);\n    }\n}\n```\n\n### 2. Modificación en `elegirPlanCreditos()` - [línea 418-419](public/js/empresas/asignar-plan.js#L418-L419)\n- Se agregó la llamada a `actualizarPrecioTotal()` después de seleccionar un plan de créditos\n\n### 3. Modificación en `mostrarPlanSeleccionado()` - [línea 684-685](public/js/empresas/asignar-plan.js#L684-L685)\n- Se reemplazó `$('#precio').val(plan_seleccionado.precio)` por `actualizarPrecioTotal()`\n\n## Comportamiento:\n- **Solo plan de selección**: Muestra el precio del plan de selección\n- **Solo plan de créditos IA**: Muestra el precio del plan de créditos IA\n- **Ambos planes**: Suma los precios de ambos planes\n\n**Nota**: Para que funcione correctamente, el plan de créditos IA debe tener un campo `precio` en su objeto. Si no lo tiene, verifica que el API `/api/planes-creditos` devuelva ese campo."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":262,"cache_read_input_tokens":89935,"cache_creation":{"ephemeral_5m_input_tokens":262,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CXK8yLseA81f3dh9SiVED","type":"assistant","uuid":"caa8c8ef-2b6a-44df-9916-f6e401e85d11","timestamp":"2026-01-20T18:55:06.858Z"}
